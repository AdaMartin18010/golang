# å¤šç¯å¢ƒéƒ¨ç½²

> **ç®€ä»‹**: äº‘åŸç”Ÿåº”ç”¨å¤šç¯å¢ƒéƒ¨ç½²ç­–ç•¥ï¼Œæ¶µç›–å¼€å‘ã€æµ‹è¯•ã€é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒçš„é…ç½®ç®¡ç†ä¸éƒ¨ç½²æµç¨‹
> **ç‰ˆæœ¬**: Go 1.23+ / Kubernetes 1.28+  
> **éš¾åº¦**: â­â­â­â­  
> **æ ‡ç­¾**: #å¤šç¯å¢ƒéƒ¨ç½² #é…ç½®ç®¡ç† #Kustomize #ç¯å¢ƒéš”ç¦»

<!-- TOC START -->
- [å¤šç¯å¢ƒéƒ¨ç½²](#å¤šç¯å¢ƒéƒ¨ç½²)
  - [9.1 ğŸ“š å¤šç¯å¢ƒæ¶æ„](#91--å¤šç¯å¢ƒæ¶æ„)
  - [9.2 ğŸ¯ é…ç½®ç®¡ç†](#92--é…ç½®ç®¡ç†)
    - [Kustomizeå¤šç¯å¢ƒ](#kustomizeå¤šç¯å¢ƒ)
    - [Helm Valueså¤šç¯å¢ƒ](#helm-valueså¤šç¯å¢ƒ)
    - [ConfigMapä¸Secretåˆ†ç¦»](#configmapä¸secretåˆ†ç¦»)
  - [9.3 ğŸš€ éƒ¨ç½²ç­–ç•¥](#93--éƒ¨ç½²ç­–ç•¥)
    - [ç¯å¢ƒæ™‹å‡Pipeline](#ç¯å¢ƒæ™‹å‡pipeline)
    - [ArgoCDå¤šç¯å¢ƒ](#argocdå¤šç¯å¢ƒ)
  - [9.4 ğŸ” ç¯å¢ƒéš”ç¦»](#94--ç¯å¢ƒéš”ç¦»)
    - [å‘½åç©ºé—´éš”ç¦»](#å‘½åç©ºé—´éš”ç¦»)
    - [NetworkPolicyéš”ç¦»](#networkpolicyéš”ç¦»)
  - [9.5 ğŸ“Š ç›‘æ§ä¸è§‚æµ‹](#95--ç›‘æ§ä¸è§‚æµ‹)
    - [ç¯å¢ƒæ ‡ç­¾](#ç¯å¢ƒæ ‡ç­¾)
    - [Grafanaå¤šç¯å¢ƒDashboard](#grafanaå¤šç¯å¢ƒdashboard)
  - [9.6 ğŸ”„ ç¯å¢ƒæ™‹å‡](#96--ç¯å¢ƒæ™‹å‡)
    - [è‡ªåŠ¨æ™‹å‡](#è‡ªåŠ¨æ™‹å‡)
    - [é‡‘ä¸é›€æ™‹å‡](#é‡‘ä¸é›€æ™‹å‡)
  - [9.7 ğŸ’° æˆæœ¬ä¼˜åŒ–](#97--æˆæœ¬ä¼˜åŒ–)
    - [ç¯å¢ƒèµ„æºå·®å¼‚åŒ–](#ç¯å¢ƒèµ„æºå·®å¼‚åŒ–)
    - [è‡ªåŠ¨ç¼©å®¹ç­–ç•¥](#è‡ªåŠ¨ç¼©å®¹ç­–ç•¥)
  - [9.8 ğŸ¯ æœ€ä½³å®è·µ](#98--æœ€ä½³å®è·µ)
  - [9.9 âš ï¸ å¸¸è§é—®é¢˜](#99-ï¸-å¸¸è§é—®é¢˜)
    - [Q1: å¦‚ä½•å¿«é€Ÿåˆ›å»ºæµ‹è¯•ç¯å¢ƒï¼Ÿ](#q1-å¦‚ä½•å¿«é€Ÿåˆ›å»ºæµ‹è¯•ç¯å¢ƒ)
    - [Q2: ç”Ÿäº§ç¯å¢ƒé…ç½®å¦‚ä½•ä¿å¯†ï¼Ÿ](#q2-ç”Ÿäº§ç¯å¢ƒé…ç½®å¦‚ä½•ä¿å¯†)
    - [Q3: å¦‚ä½•å¤„ç†æ•°æ®åº“Schemaå˜æ›´ï¼Ÿ](#q3-å¦‚ä½•å¤„ç†æ•°æ®åº“schemaå˜æ›´)
  - [9.10 ğŸ“š æ‰©å±•é˜…è¯»](#910--æ‰©å±•é˜…è¯»)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
<!-- TOC END -->

## 9.1 ğŸ“š å¤šç¯å¢ƒæ¶æ„

**å…¸å‹ç¯å¢ƒ**:

- **å¼€å‘ç¯å¢ƒ(Dev)**: å¼€å‘äººå‘˜æ—¥å¸¸å¼€å‘æµ‹è¯•
- **æµ‹è¯•ç¯å¢ƒ(Test/QA)**: QAå›¢é˜ŸåŠŸèƒ½æµ‹è¯•
- **é¢„å‘å¸ƒç¯å¢ƒ(Staging)**: ç”Ÿäº§å‰æœ€åéªŒè¯
- **ç”Ÿäº§ç¯å¢ƒ(Production)**: çœŸå®ç”¨æˆ·è®¿é—®

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CI/CD Pipeline                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“          â†“          â†“          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
   â”‚ Dev  â”‚â†’ â”‚ Test â”‚â†’ â”‚ Staging â”‚â†’ â”‚ Prod â”‚
   â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
     è‡ªåŠ¨      è‡ªåŠ¨       æ‰‹åŠ¨å®¡æ‰¹     æ‰‹åŠ¨å®¡æ‰¹
```

## 9.2 ğŸ¯ é…ç½®ç®¡ç†

### Kustomizeå¤šç¯å¢ƒ

**ç›®å½•ç»“æ„**:

```text
kustomize/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â””â”€â”€ kustomization.yaml
â””â”€â”€ overlays/
    â”œâ”€â”€ dev/
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â”œâ”€â”€ replica-patch.yaml
    â”‚   â””â”€â”€ resource-patch.yaml
    â”œâ”€â”€ test/
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â””â”€â”€ patches.yaml
    â”œâ”€â”€ staging/
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â””â”€â”€ patches.yaml
    â””â”€â”€ production/
        â”œâ”€â”€ kustomization.yaml
        â”œâ”€â”€ replica-patch.yaml
        â””â”€â”€ hpa.yaml
```

**base/kustomization.yaml**:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- deployment.yaml
- service.yaml
- configmap.yaml

commonLabels:
  app: user-service
  managed-by: kustomize
```

**overlays/production/kustomization.yaml**:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
- ../../base

namespace: production

replicas:
- name: user-service
  count: 5

images:
- name: user-service
  newTag: v1.2.3

patchesStrategicMerge:
- replica-patch.yaml

resources:
- hpa.yaml

configMapGenerator:
- name: app-config
  behavior: merge
  literals:
  - LOG_LEVEL=info
  - ENV=production
```

### Helm Valueså¤šç¯å¢ƒ

**values-dev.yaml**:

```yaml
replicaCount: 1
image:
  tag: latest
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 256Mi
ingress:
  enabled: true
  host: dev.example.com
autoscaling:
  enabled: false
```

**values-production.yaml**:

```yaml
replicaCount: 5
image:
  tag: v1.2.3
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi
ingress:
  enabled: true
  host: api.example.com
  tls:
    enabled: true
autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
```

### ConfigMapä¸Secretåˆ†ç¦»

```yaml
# dev-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: dev
type: Opaque
stringData:
  DB_PASSWORD: "dev_password"
  API_KEY: "dev_api_key"

---
# production-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: production
type: Opaque
stringData:
  DB_PASSWORD: "${PROD_DB_PASSWORD}"  # ä»å¤–éƒ¨æ³¨å…¥
  API_KEY: "${PROD_API_KEY}"
```

## 9.3 ğŸš€ éƒ¨ç½²ç­–ç•¥

### ç¯å¢ƒæ™‹å‡Pipeline

```yaml
# GitHub Actions
name: Multi-Environment Deployment

on:
  push:
    branches: [main]

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Dev
      run: |
        kubectl apply -k kustomize/overlays/dev
  
  deploy-test:
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: test
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Test
      run: |
        kubectl apply -k kustomize/overlays/test
  
  deploy-staging:
    runs-on: ubuntu-latest
    needs: deploy-test
    environment: staging
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Staging
      run: |
        kubectl apply -k kustomize/overlays/staging
  
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://api.example.com
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Production
      run: |
        kubectl apply -k kustomize/overlays/production
```

### ArgoCDå¤šç¯å¢ƒ

```yaml
# ApplicationSet
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: user-service
spec:
  generators:
  - list:
      elements:
      - env: dev
        namespace: dev
        cluster: dev-cluster
        revision: develop
      - env: test
        namespace: test
        cluster: test-cluster
        revision: develop
      - env: staging
        namespace: staging
        cluster: staging-cluster
        revision: main
      - env: production
        namespace: production
        cluster: production-cluster
        revision: release
  template:
    metadata:
      name: 'user-service-{{env}}'
    spec:
      project: default
      source:
        repoURL: https://github.com/myorg/k8s-manifests.git
        targetRevision: '{{revision}}'
        path: 'kustomize/overlays/{{env}}'
      destination:
        server: '{{cluster}}'
        namespace: '{{namespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
```

## 9.4 ğŸ” ç¯å¢ƒéš”ç¦»

### å‘½åç©ºé—´éš”ç¦»

```yaml
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    environment: production
    team: backend

---
# ResourceQuota
apiVersion: v1
kind: ResourceQuota
metadata:
  name: production-quota
  namespace: production
spec:
  hard:
    requests.cpu: "100"
    requests.memory: 200Gi
    limits.cpu: "200"
    limits.memory: 400Gi
    pods: "100"

---
# LimitRange
apiVersion: v1
kind: LimitRange
metadata:
  name: production-limits
  namespace: production
spec:
  limits:
  - max:
      cpu: "4"
      memory: 8Gi
    min:
      cpu: 100m
      memory: 128Mi
    default:
      cpu: 500m
      memory: 512Mi
    defaultRequest:
      cpu: 200m
      memory: 256Mi
    type: Container
```

### NetworkPolicyéš”ç¦»

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: env-isolation
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          environment: production
  - to:  # å…è®¸è®¿é—®DNS
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
```

## 9.5 ğŸ“Š ç›‘æ§ä¸è§‚æµ‹

### ç¯å¢ƒæ ‡ç­¾

```go
import "github.com/prometheus/client_golang/prometheus"

var (
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total HTTP requests",
        },
        []string{"environment", "method", "endpoint", "status"},
    )
)

func init() {
    prometheus.MustRegister(httpRequestsTotal)
}

func MetricsMiddleware(env string) gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Next()
        httpRequestsTotal.WithLabelValues(
            env,
            c.Request.Method,
            c.FullPath(),
            strconv.Itoa(c.Writer.Status()),
        ).Inc()
    }
}
```

### Grafanaå¤šç¯å¢ƒDashboard

```json
{
  "dashboard": {
    "title": "Multi-Environment Overview",
    "panels": [
      {
        "title": "Requests by Environment",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total[5m])) by (environment)"
          }
        ]
      }
    ],
    "templating": {
      "list": [
        {
          "name": "environment",
          "type": "query",
          "query": "label_values(http_requests_total, environment)"
        }
      ]
    }
  }
}
```

## 9.6 ğŸ”„ ç¯å¢ƒæ™‹å‡

### è‡ªåŠ¨æ™‹å‡

```yaml
# è‡ªåŠ¨æ™‹å‡åˆ°test
deploy:test:
  stage: deploy
  environment: test
  script:
    - kubectl apply -k overlays/test
  only:
    - develop

# æ‰‹åŠ¨æ™‹å‡åˆ°production
deploy:production:
  stage: deploy
  environment: production
  script:
    - kubectl apply -k overlays/production
  when: manual
  only:
    - main
```

### é‡‘ä¸é›€æ™‹å‡

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: user-service
spec:
  strategy:
    canary:
      steps:
      - setWeight: 10
      - pause: {duration: 5m}
      - setWeight: 25
      - pause: {duration: 10m}
      - setWeight: 50
      - pause: {duration: 15m}
      - setWeight: 75
      - pause: {duration: 20m}
```

## 9.7 ğŸ’° æˆæœ¬ä¼˜åŒ–

### ç¯å¢ƒèµ„æºå·®å¼‚åŒ–

| ç¯å¢ƒ | èŠ‚ç‚¹ç±»å‹ | å‰¯æœ¬æ•° | èµ„æºé…é¢ | æˆæœ¬å æ¯” |
|------|----------|--------|----------|---------|
| Dev | t3.small | 1 | æœ€å° | 5% |
| Test | t3.medium | 2 | å° | 10% |
| Staging | t3.large | 3 | ä¸­ç­‰ | 20% |
| Production | c5.2xlarge | 5-20 | å¤§ | 65% |

### è‡ªåŠ¨ç¼©å®¹ç­–ç•¥

```yaml
# Devç¯å¢ƒå¤œé—´è‡ªåŠ¨ç¼©å®¹
apiVersion: batch/v1
kind: CronJob
metadata:
  name: scale-down-dev
spec:
  schedule: "0 22 * * *"  # æ¯æ™š10ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: kubectl
            image: bitnami/kubectl:latest
            command:
            - kubectl
            - scale
            - deployment/user-service
            - --replicas=0
            - -n
            - dev
          restartPolicy: OnFailure
```

## 9.8 ğŸ¯ æœ€ä½³å®è·µ

1. **é…ç½®å¤–éƒ¨åŒ–**: ä½¿ç”¨ConfigMap/Secretç®¡ç†é…ç½®
2. **ç¯å¢ƒä¸€è‡´æ€§**: ä¿æŒç¯å¢ƒé…ç½®å°½é‡ä¸€è‡´
3. **æ¸è¿›å¼éƒ¨ç½²**: Devâ†’Testâ†’Stagingâ†’Production
4. **è‡ªåŠ¨åŒ–æµ‹è¯•**: æ¯ä¸ªç¯å¢ƒéƒ½æœ‰å¯¹åº”æµ‹è¯•
5. **ç¯å¢ƒéš”ç¦»**: ä½¿ç”¨Namespaceå’ŒNetworkPolicy
6. **ç›‘æ§å·®å¼‚åŒ–**: æ ¹æ®ç¯å¢ƒé‡è¦æ€§é…ç½®ç›‘æ§
7. **æˆæœ¬ä¼˜åŒ–**: éç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¾ƒå°èµ„æº
8. **æ–‡æ¡£åŒ–**: ç»´æŠ¤ç¯å¢ƒé…ç½®æ–‡æ¡£
9. **å®šæœŸæ¸…ç†**: æ¸…ç†ä¸å†ä½¿ç”¨çš„æµ‹è¯•ç¯å¢ƒ
10. **æ¼”ç»ƒå›æ»š**: å®šæœŸè¿›è¡Œå›æ»šæ¼”ç»ƒ

## 9.9 âš ï¸ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¿«é€Ÿåˆ›å»ºæµ‹è¯•ç¯å¢ƒï¼Ÿ

**A**: ä½¿ç”¨Namespace Template:

```bash
kubectl create namespace test-feature-123
kubectl apply -k overlays/dev -n test-feature-123
```

### Q2: ç”Ÿäº§ç¯å¢ƒé…ç½®å¦‚ä½•ä¿å¯†ï¼Ÿ

**A**:

- ä½¿ç”¨Sealed Secrets
- å¤–éƒ¨Secretç®¡ç†ï¼ˆVaultï¼‰
- GitLab CI/CDå˜é‡
- ä¸è¦æäº¤æ˜æ–‡åˆ°Git

### Q3: å¦‚ä½•å¤„ç†æ•°æ®åº“Schemaå˜æ›´ï¼Ÿ

**A**:

- ä½¿ç”¨æ•°æ®åº“è¿ç§»å·¥å…·ï¼ˆFlywayã€Liquibaseï¼‰
- å…ˆåœ¨ä½ç¯å¢ƒéªŒè¯
- åˆ¶å®šå›æ»šè®¡åˆ’
- è€ƒè™‘å‘åå…¼å®¹

## 9.10 ğŸ“š æ‰©å±•é˜…è¯»

### å®˜æ–¹æ–‡æ¡£

- [Kustomizeæ–‡æ¡£](https://kustomize.io/)
- [Helm Valuesæ–‡æ¡£](https://helm.sh/docs/chart_template_guide/values_files/)
- [ArgoCD ApplicationSets](https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/)

### ç›¸å…³æ–‡æ¡£

- [06-GitOpséƒ¨ç½².md](./06-GitOpséƒ¨ç½².md)
- [07-GitHub-Actions.md](./07-GitHub-Actions.md)
- [08-GitLab-CI.md](./08-GitLab-CI.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Go Documentation Team  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ20æ—¥  
**æ–‡æ¡£çŠ¶æ€**: å®Œæˆ  
**é€‚ç”¨ç‰ˆæœ¬**: Kubernetes 1.27+, Kustomize 5+, Helm 3+
