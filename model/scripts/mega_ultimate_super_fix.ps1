# 巨型终极超级修正PowerShell脚本
# 处理所有剩余的TOC和序号格式问题

Write-Host "🚀 开始巨型终极超级修正..." -ForegroundColor Green

# 定义所有需要修正的模式
$megaUltimateSuperPatterns = @{
    # 修正所有常见的序号错误
    "- \[1 1 1 1 1 1 1 ([^\]]+)\]" = "- [1. $1]"
    "- \[9 9 9 9 9 9 9 ([^\]]+)\]" = "- [2. $1]"
    "- \[13 13 13 13 13 13 13 ([^\]]+)\]" = "- [3. $1]"
    "- \[14 14 14 14 14 14 14 ([^\]]+)\]" = "- [4. $1]"
    "- \[15 15 15 15 15 15 15 ([^\]]+)\]" = "- [5. $1]"
    
    # 修正标题中的序号错误
    "^# 1 1 1 1 1 1 1 " = "# 1. "
    "^## 9 9 9 9 9 9 9 " = "## 2. "
    "^## 13 13 13 13 13 13 13 " = "## 3. "
    "^## 14 14 14 14 14 14 14 " = "## 4. "
    "^## 15 15 15 15 15 15 15 " = "## 5. "
    
    # 修正TOC链接格式错误
    "- \[1\.2\.1 ([^\]]+)\]" = "- [2.1 $1]"
    "- \[1\.2\.2 ([^\]]+)\]" = "- [2.2 $1]"
    "- \[1\.2\.3 ([^\]]+)\]" = "- [2.3 $1]"
    "- \[1\.2\.4 ([^\]]+)\]" = "- [2.4 $1]"
    "- \[1\.2\.5 ([^\]]+)\]" = "- [2.5 $1]"
    "- \[1\.2\.6 ([^\]]+)\]" = "- [2.6 $1]"
    "- \[1\.2\.7 ([^\]]+)\]" = "- [2.7 $1]"
    "- \[1\.2\.8 ([^\]]+)\]" = "- [2.8 $1]"
    "- \[1\.2\.9 ([^\]]+)\]" = "- [2.9 $1]"
    "- \[1\.2\.10 ([^\]]+)\]" = "- [2.10 $1]"
    "- \[1\.2\.11 ([^\]]+)\]" = "- [2.11 $1]"
    "- \[1\.2\.12 ([^\]]+)\]" = "- [2.12 $1]"
    "- \[1\.2\.13 ([^\]]+)\]" = "- [2.13 $1]"
    "- \[1\.2\.14 ([^\]]+)\]" = "- [2.14 $1]"
    "- \[1\.2\.15 ([^\]]+)\]" = "- [2.15 $1]"
    
    # 修正13.x.x格式错误
    "- \[13\.1 ([^\]]+)\]" = "- [3.1 $1]"
    "- \[13\.2 ([^\]]+)\]" = "- [3.2 $1]"
    "- \[13\.3 ([^\]]+)\]" = "- [3.3 $1]"
    "- \[13\.4 ([^\]]+)\]" = "- [3.4 $1]"
    "- \[13\.5 ([^\]]+)\]" = "- [3.5 $1]"
    "- \[13\.6 ([^\]]+)\]" = "- [3.6 $1]"
    "- \[13\.7 ([^\]]+)\]" = "- [3.7 $1]"
    "- \[13\.8 ([^\]]+)\]" = "- [3.8 $1]"
    "- \[13\.9 ([^\]]+)\]" = "- [3.9 $1]"
    "- \[13\.10 ([^\]]+)\]" = "- [3.10 $1]"
    
    # 修正13.x.x.x格式错误
    "- \[13\.1\.1 ([^\]]+)\]" = "- [3.1.1 $1]"
    "- \[13\.1\.2 ([^\]]+)\]" = "- [3.1.2 $1]"
    "- \[13\.2\.1 ([^\]]+)\]" = "- [3.2.1 $1]"
    "- \[13\.2\.2 ([^\]]+)\]" = "- [3.2.2 $1]"
    "- \[13\.3\.1 ([^\]]+)\]" = "- [3.3.1 $1]"
    "- \[13\.3\.2 ([^\]]+)\]" = "- [3.3.2 $1]"
    "- \[13\.4\.1 ([^\]]+)\]" = "- [3.4.1 $1]"
    "- \[13\.4\.2 ([^\]]+)\]" = "- [3.4.2 $1]"
    "- \[13\.5\.1 ([^\]]+)\]" = "- [3.5.1 $1]"
    "- \[13\.5\.2 ([^\]]+)\]" = "- [3.5.2 $1]"
    "- \[13\.6\.1 ([^\]]+)\]" = "- [3.6.1 $1]"
    "- \[13\.6\.2 ([^\]]+)\]" = "- [3.6.2 $1]"
    "- \[13\.7\.1 ([^\]]+)\]" = "- [3.7.1 $1]"
    "- \[13\.7\.2 ([^\]]+)\]" = "- [3.7.2 $1]"
    "- \[13\.8\.1 ([^\]]+)\]" = "- [3.8.1 $1]"
    "- \[13\.8\.2 ([^\]]+)\]" = "- [3.8.2 $1]"
    "- \[13\.9\.1 ([^\]]+)\]" = "- [3.9.1 $1]"
    "- \[13\.9\.2 ([^\]]+)\]" = "- [3.9.2 $1]"
    "- \[13\.10\.1 ([^\]]+)\]" = "- [3.10.1 $1]"
    "- \[13\.10\.2 ([^\]]+)\]" = "- [3.10.2 $1]"
    
    # 修正14.x.x格式错误
    "- \[14\.1 ([^\]]+)\]" = "- [4.1 $1]"
    "- \[14\.2 ([^\]]+)\]" = "- [4.2 $1]"
    "- \[14\.3 ([^\]]+)\]" = "- [4.3 $1]"
    "- \[14\.4 ([^\]]+)\]" = "- [4.4 $1]"
    "- \[14\.5 ([^\]]+)\]" = "- [4.5 $1]"
    "- \[14\.6 ([^\]]+)\]" = "- [4.6 $1]"
    "- \[14\.7 ([^\]]+)\]" = "- [4.7 $1]"
    "- \[14\.8 ([^\]]+)\]" = "- [4.8 $1]"
    "- \[14\.9 ([^\]]+)\]" = "- [4.9 $1]"
    "- \[14\.10 ([^\]]+)\]" = "- [4.10 $1]"
    
    # 修正14.x.x.x格式错误
    "- \[14\.1\.1 ([^\]]+)\]" = "- [4.1.1 $1]"
    "- \[14\.1\.2 ([^\]]+)\]" = "- [4.1.2 $1]"
    "- \[14\.2\.1 ([^\]]+)\]" = "- [4.2.1 $1]"
    "- \[14\.2\.2 ([^\]]+)\]" = "- [4.2.2 $1]"
    "- \[14\.3\.1 ([^\]]+)\]" = "- [4.3.1 $1]"
    "- \[14\.3\.2 ([^\]]+)\]" = "- [4.3.2 $1]"
    "- \[14\.4\.1 ([^\]]+)\]" = "- [4.4.1 $1]"
    "- \[14\.4\.2 ([^\]]+)\]" = "- [4.4.2 $1]"
    "- \[14\.5\.1 ([^\]]+)\]" = "- [4.5.1 $1]"
    "- \[14\.5\.2 ([^\]]+)\]" = "- [4.5.2 $1]"
    "- \[14\.6\.1 ([^\]]+)\]" = "- [4.6.1 $1]"
    "- \[14\.6\.2 ([^\]]+)\]" = "- [4.6.2 $1]"
    "- \[14\.7\.1 ([^\]]+)\]" = "- [4.7.1 $1]"
    "- \[14\.7\.2 ([^\]]+)\]" = "- [4.7.2 $1]"
    "- \[14\.8\.1 ([^\]]+)\]" = "- [4.8.1 $1]"
    "- \[14\.8\.2 ([^\]]+)\]" = "- [4.8.2 $1]"
    "- \[14\.9\.1 ([^\]]+)\]" = "- [4.9.1 $1]"
    "- \[14\.9\.2 ([^\]]+)\]" = "- [4.9.2 $1]"
    "- \[14\.10\.1 ([^\]]+)\]" = "- [4.10.1 $1]"
    "- \[14\.10\.2 ([^\]]+)\]" = "- [4.10.2 $1]"
    
    # 修正其他常见的格式错误
    "- \[1\.3 ([^\]]+)\]" = "- [3. $1]"
    "- \[1\.4 ([^\]]+)\]" = "- [4. $1]"
    "- \[1\.5 ([^\]]+)\]" = "- [5. $1]"
    "- \[1\.6 ([^\]]+)\]" = "- [6. $1]"
    "- \[1\.7 ([^\]]+)\]" = "- [7. $1]"
    "- \[1\.8 ([^\]]+)\]" = "- [8. $1]"
    "- \[1\.9 ([^\]]+)\]" = "- [9. $1]"
    "- \[1\.10 ([^\]]+)\]" = "- [10. $1]"
    
    # 修正1.3.x格式错误
    "- \[1\.3\.1 ([^\]]+)\]" = "- [3.1 $1]"
    "- \[1\.3\.2 ([^\]]+)\]" = "- [3.2 $1]"
    "- \[1\.3\.3 ([^\]]+)\]" = "- [3.3 $1]"
    "- \[1\.3\.4 ([^\]]+)\]" = "- [3.4 $1]"
    "- \[1\.3\.5 ([^\]]+)\]" = "- [3.5 $1]"
    
    # 修正1.4.x格式错误
    "- \[1\.4\.1 ([^\]]+)\]" = "- [4.1 $1]"
    "- \[1\.4\.2 ([^\]]+)\]" = "- [4.2 $1]"
    "- \[1\.4\.3 ([^\]]+)\]" = "- [4.3 $1]"
    "- \[1\.4\.4 ([^\]]+)\]" = "- [4.4 $1]"
    "- \[1\.4\.5 ([^\]]+)\]" = "- [4.5 $1]"
    
    # 修正1.5.x格式错误
    "- \[1\.5\.1 ([^\]]+)\]" = "- [5.1 $1]"
    "- \[1\.5\.2 ([^\]]+)\]" = "- [5.2 $1]"
    "- \[1\.5\.3 ([^\]]+)\]" = "- [5.3 $1]"
    "- \[1\.5\.4 ([^\]]+)\]" = "- [5.4 $1]"
    "- \[1\.5\.5 ([^\]]+)\]" = "- [5.5 $1]"
    
    # 修正1.6.x格式错误
    "- \[1\.6\.1 ([^\]]+)\]" = "- [6.1 $1]"
    "- \[1\.6\.2 ([^\]]+)\]" = "- [6.2 $1]"
    "- \[1\.6\.3 ([^\]]+)\]" = "- [6.3 $1]"
    "- \[1\.6\.4 ([^\]]+)\]" = "- [6.4 $1]"
    "- \[1\.6\.5 ([^\]]+)\]" = "- [6.5 $1]"
    
    # 修正1.7.x格式错误
    "- \[1\.7\.1 ([^\]]+)\]" = "- [7.1 $1]"
    "- \[1\.7\.2 ([^\]]+)\]" = "- [7.2 $1]"
    "- \[1\.7\.3 ([^\]]+)\]" = "- [7.3 $1]"
    "- \[1\.7\.4 ([^\]]+)\]" = "- [7.4 $1]"
    "- \[1\.7\.5 ([^\]]+)\]" = "- [7.5 $1]"
    
    # 修正1.8.x格式错误
    "- \[1\.8\.1 ([^\]]+)\]" = "- [8.1 $1]"
    "- \[1\.8\.2 ([^\]]+)\]" = "- [8.2 $1]"
    "- \[1\.8\.3 ([^\]]+)\]" = "- [8.3 $1]"
    "- \[1\.8\.4 ([^\]]+)\]" = "- [8.4 $1]"
    "- \[1\.8\.5 ([^\]]+)\]" = "- [8.5 $1]"
    
    # 修正1.9.x格式错误
    "- \[1\.9\.1 ([^\]]+)\]" = "- [9.1 $1]"
    "- \[1\.9\.2 ([^\]]+)\]" = "- [9.2 $1]"
    "- \[1\.9\.3 ([^\]]+)\]" = "- [9.3 $1]"
    "- \[1\.9\.4 ([^\]]+)\]" = "- [9.4 $1]"
    "- \[1\.9\.5 ([^\]]+)\]" = "- [9.5 $1]"
    
    # 修正1.10.x格式错误
    "- \[1\.10\.1 ([^\]]+)\]" = "- [10.1 $1]"
    "- \[1\.10\.2 ([^\]]+)\]" = "- [10.2 $1]"
    "- \[1\.10\.3 ([^\]]+)\]" = "- [10.3 $1]"
    "- \[1\.10\.4 ([^\]]+)\]" = "- [10.4 $1]"
    "- \[1\.10\.5 ([^\]]+)\]" = "- [10.5 $1]"
    
    # 修正其他特殊格式错误
    "- \[1\.1\.1 ([^\]]+)\]" = "- [1.1 $1]"
    "- \[1\.1\.2 ([^\]]+)\]" = "- [1.2 $1]"
    "- \[1\.1\.3 ([^\]]+)\]" = "- [1.3 $1]"
    "- \[1\.1\.4 ([^\]]+)\]" = "- [1.4 $1]"
    "- \[1\.1\.5 ([^\]]+)\]" = "- [1.5 $1]"
    
    # 修正2.x.x格式错误
    "- \[2\.1\.1 ([^\]]+)\]" = "- [2.1 $1]"
    "- \[2\.1\.2 ([^\]]+)\]" = "- [2.2 $1]"
    "- \[2\.1\.3 ([^\]]+)\]" = "- [2.3 $1]"
    "- \[2\.1\.4 ([^\]]+)\]" = "- [2.4 $1]"
    "- \[2\.1\.5 ([^\]]+)\]" = "- [2.5 $1]"
    
    # 修正3.x.x格式错误
    "- \[3\.1\.1 ([^\]]+)\]" = "- [3.1 $1]"
    "- \[3\.1\.2 ([^\]]+)\]" = "- [3.2 $1]"
    "- \[3\.1\.3 ([^\]]+)\]" = "- [3.3 $1]"
    "- \[3\.1\.4 ([^\]]+)\]" = "- [3.4 $1]"
    "- \[3\.1\.5 ([^\]]+)\]" = "- [3.5 $1]"
    
    # 修正4.x.x格式错误
    "- \[4\.1\.1 ([^\]]+)\]" = "- [4.1 $1]"
    "- \[4\.1\.2 ([^\]]+)\]" = "- [4.2 $1]"
    "- \[4\.1\.3 ([^\]]+)\]" = "- [4.3 $1]"
    "- \[4\.1\.4 ([^\]]+)\]" = "- [4.4 $1]"
    "- \[4\.1\.5 ([^\]]+)\]" = "- [4.5 $1]"
    
    # 修正5.x.x格式错误
    "- \[5\.1\.1 ([^\]]+)\]" = "- [5.1 $1]"
    "- \[5\.1\.2 ([^\]]+)\]" = "- [5.2 $1]"
    "- \[5\.1\.3 ([^\]]+)\]" = "- [5.3 $1]"
    "- \[5\.1\.4 ([^\]]+)\]" = "- [5.4 $1]"
    "- \[5\.1\.5 ([^\]]+)\]" = "- [5.5 $1]"
}

# 获取所有markdown文件
$markdownFiles = Get-ChildItem -Path "." -Recurse -Filter "*.md" -File

$totalFiles = 0
$fixedFiles = 0
$skippedFiles = 0
$errorFiles = 0

foreach ($file in $markdownFiles) {
    $totalFiles++
    Write-Host "📝 处理文件: $($file.FullName)" -ForegroundColor Yellow
    
    try {
        # 读取文件内容
        $content = Get-Content -Path $file.FullName -Raw -Encoding UTF8
        $originalContent = $content
        
        # 检查是否包含TOC
        if ($content -match "<!-- TOC START -->" -and $content -match "<!-- TOC END -->") {
            Write-Host "  🔍 发现TOC，开始检查链接..." -ForegroundColor Cyan
            
            # 应用巨型终极超级修正模式
            $hasChanges = $false
            foreach ($pattern in $megaUltimateSuperPatterns.Keys) {
                $replacement = $megaUltimateSuperPatterns[$pattern]
                $newContent = $content -replace $pattern, $replacement
                if ($newContent -ne $content) {
                    $content = $newContent
                    $hasChanges = $true
                    Write-Host "    🔧 修正模式: $pattern" -ForegroundColor Magenta
                }
            }
            
            if ($hasChanges) {
                # 写回修正后的内容
                Set-Content -Path $file.FullName -Value $content -Encoding UTF8
                Write-Host "  ✅ TOC链接修正完成" -ForegroundColor Green
                $fixedFiles++
            } else {
                Write-Host "  ✅ TOC链接格式正确" -ForegroundColor Blue
                $skippedFiles++
            }
        } else {
            Write-Host "  ⚪ 无TOC，跳过" -ForegroundColor Gray
            $skippedFiles++
        }
    } catch {
        Write-Host "  ❌ 处理文件时出错: $($_.Exception.Message)" -ForegroundColor Red
        $errorFiles++
    }
    
    Write-Host ""
}

Write-Host "📊 巨型终极超级修正完成统计:" -ForegroundColor Cyan
Write-Host "  总文件数: $totalFiles" -ForegroundColor White
Write-Host "  修正文件数: $fixedFiles" -ForegroundColor Green
Write-Host "  跳过文件数: $skippedFiles" -ForegroundColor Blue
Write-Host "  错误文件数: $errorFiles" -ForegroundColor Red
Write-Host ""

# 检查是否还有TOC链接错误
Write-Host "🔍 检查剩余TOC链接错误..." -ForegroundColor Cyan
$remainingErrorFiles = Get-ChildItem -Path "." -Recurse -Filter "*.md" -File | Where-Object {
    try {
        $content = Get-Content -Path $_.FullName -Raw -Encoding UTF8
        $content -match "<!-- TOC START -->" -and $content -match "<!-- TOC END -->" -and 
        ($content -match "1\.2\.\d+|13\.\d+|14\.\d+|1 1 1 1 1 1 1|9 9 9 9 9 9 9|13 13 13 13 13 13 13|14 14 14 14 14 14 14|15 15 15 15 15 15 15")
    } catch {
        $false
    }
}

if ($remainingErrorFiles.Count -gt 0) {
    Write-Host "⚠️  仍有 $($remainingErrorFiles.Count) 个文件的TOC存在链接错误:" -ForegroundColor Yellow
    $remainingErrorFiles | ForEach-Object { Write-Host "  $($_.FullName)" -ForegroundColor Red }
} else {
    Write-Host "🎉 所有TOC链接修正完成！" -ForegroundColor Green
}

Write-Host ""
Write-Host "✨ 巨型终极超级修正脚本执行完成" -ForegroundColor Green
