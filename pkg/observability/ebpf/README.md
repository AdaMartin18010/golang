# eBPF å¯è§‚æµ‹æ€§å®ç°

**ç‰ˆæœ¬**: v2.0
**æ›´æ–°æ—¥æœŸ**: 2025-12-03
**ä½¿ç”¨åº“**: github.com/cilium/ebpf (æœ€æˆç†Ÿçš„Go eBPFåº“)

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¨¡å—ä½¿ç”¨ **Cilium eBPF** åº“å®ç°ç³»ç»Ÿçº§å¯è§‚æµ‹æ€§ï¼Œæä¾›ï¼š

1. **ç³»ç»Ÿè°ƒç”¨è¿½è¸ª** - è¿½è¸ªåº”ç”¨çš„ç³»ç»Ÿè°ƒç”¨
2. **ç½‘ç»œç›‘æ§** - ç›‘æ§ç½‘ç»œåŒ…å’Œè¿æ¥
3. **æ€§èƒ½åˆ†æ** - CPUã€å†…å­˜ã€I/Oæ€§èƒ½
4. **å®‰å…¨ç›‘æ§** - æ£€æµ‹å¼‚å¸¸è¡Œä¸º

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚ç»“æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OpenTelemetry Metrics/Traces     â”‚  â† è¾“å‡ºå±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   eBPF Collector (Go)              â”‚  â† æ•°æ®å¤„ç†å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   eBPF Maps (Kernel)               â”‚  â† æ•°æ®ç¼“å†²å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   eBPF Programs (C)                â”‚  â† æ•°æ®é‡‡é›†å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Kernel Events                     â”‚  â† äº‹ä»¶æº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```text
Kernel Event â†’ eBPF Program â†’ eBPF Map â†’ Go Collector â†’ OTLP â†’ Backend
```

---

## ğŸš€ å®ç°è®¡åˆ’

### Phase 1: ç³»ç»Ÿè°ƒç”¨è¿½è¸ªï¼ˆå½“å‰ï¼‰

**æ–‡ä»¶ç»“æ„**:
```
pkg/observability/ebpf/
â”œâ”€â”€ collector.go           # ä¸»æ”¶é›†å™¨ï¼ˆå·²æœ‰æ¡†æ¶ï¼‰
â”œâ”€â”€ syscall_tracer.go      # ç³»ç»Ÿè°ƒç”¨è¿½è¸ªå™¨ï¼ˆå¾…å®ç°ï¼‰
â”œâ”€â”€ programs/
â”‚   â”œâ”€â”€ syscall.bpf.c     # eBPF Cç¨‹åºï¼ˆå¾…å®ç°ï¼‰
â”‚   â””â”€â”€ syscall.go        # Goç»‘å®šï¼ˆbpf2goç”Ÿæˆï¼‰
â””â”€â”€ README.md             # æœ¬æ–‡æ¡£
```

**å®ç°æ­¥éª¤**:
1. âœ… æ·»åŠ  Cilium eBPF ä¾èµ–
2. â³ ç¼–å†™ eBPF C ç¨‹åºè¿½è¸ªç³»ç»Ÿè°ƒç”¨
3. â³ ä½¿ç”¨ bpf2go ç”Ÿæˆ Go ç»‘å®š
4. â³ å®ç° Go æ”¶é›†å™¨è¯»å– eBPF map
5. â³ é›†æˆåˆ° OpenTelemetry

### Phase 2: ç½‘ç»œç›‘æ§ï¼ˆä¸‹ä¸€æ­¥ï¼‰

**åŠŸèƒ½**:
- TCP è¿æ¥ç›‘æ§
- ç½‘ç»œåŒ…ç»Ÿè®¡
- å»¶è¿Ÿæµ‹é‡

### Phase 3: æ€§èƒ½åˆ†æï¼ˆæœªæ¥ï¼‰

**åŠŸèƒ½**:
- CPU ç«ç„°å›¾
- å†…å­˜åˆ†é…è¿½è¸ª
- I/O æ€§èƒ½åˆ†æ

---

## ğŸ“š æŠ€æœ¯é€‰å‹

### Cilium eBPF vs å…¶ä»–æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | è¯„åˆ† |
|------|------|------|------|
| **Cilium eBPF** | çº¯Goã€ç±»å‹å®‰å…¨ã€æ´»è·ƒç»´æŠ¤ | éœ€è¦ç¼–å†™Cç¨‹åº | â­â­â­â­â­ |
| libbpfgo | åŠŸèƒ½å®Œæ•´ | CGOä¾èµ–ã€å¤æ‚ | â­â­â­â­ |
| gobpf | ç®€å• | ä¸ç»´æŠ¤ã€è¿‡æ—¶ | â­â­ |

**é€‰æ‹© Cilium eBPF çš„åŸå› **:
1. âœ… Kubernetes ç½‘ç»œæ ¸å¿ƒé¡¹ç›®ï¼Œæˆç†Ÿç¨³å®š
2. âœ… çº¯ Go å®ç°ï¼Œæ—  CGO ä¾èµ–
3. âœ… ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
4. âœ… æ´»è·ƒç»´æŠ¤ï¼Œç¤¾åŒºæ”¯æŒå¥½
5. âœ… å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹

---

## ğŸ”§ å¼€å‘ç¯å¢ƒè¦æ±‚

### Linux å†…æ ¸è¦æ±‚

- **æœ€ä½ç‰ˆæœ¬**: Linux 4.18+
- **æ¨èç‰ˆæœ¬**: Linux 5.10+ (LTS)
- **æœ€ä½³ç‰ˆæœ¬**: Linux 6.1+ (æœ€æ–°ç‰¹æ€§)

### å¼€å‘å·¥å…·

```bash
# å®‰è£… LLVM/Clang (ç¼–è¯‘ eBPF ç¨‹åº)
sudo apt-get install clang llvm

# å®‰è£… bpf2go (ç”Ÿæˆ Go ç»‘å®š)
go install github.com/cilium/ebpf/cmd/bpf2go@latest

# å®‰è£…å†…æ ¸å¤´æ–‡ä»¶
sudo apt-get install linux-headers-$(uname -r)
```

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```go
package main

import (
    "context"
    "log"

    "github.com/yourusername/golang/pkg/observability/ebpf"
    "go.opentelemetry.io/otel"
)

func main() {
    // åˆ›å»º OTLP tracer å’Œ meter
    tracer := otel.Tracer("ebpf-collector")
    meter := otel.Meter("ebpf-collector")

    // åˆ›å»º eBPF æ”¶é›†å™¨
    collector, err := ebpf.NewCollector(ebpf.Config{
        Tracer:                 tracer,
        Meter:                  meter,
        Enabled:                true,
        EnableSyscallTracking:  true,
        EnableNetworkMonitoring: true,
    })
    if err != nil {
        log.Fatal(err)
    }

    // å¯åŠ¨æ”¶é›†
    if err := collector.Start(); err != nil {
        log.Fatal(err)
    }
    defer collector.Stop()

    // åº”ç”¨è¿è¡Œ...
    select {}
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

### ç«‹å³ä»»åŠ¡

1. **å®ç°ç³»ç»Ÿè°ƒç”¨è¿½è¸ªå™¨**
   - ç¼–å†™ `syscall.bpf.c`
   - å®ç° `syscall_tracer.go`
   - é›†æˆåˆ° collector

2. **æ·»åŠ æµ‹è¯•**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•ï¼ˆéœ€è¦ Linux ç¯å¢ƒï¼‰

3. **å®Œå–„æ–‡æ¡£**
   - ä½¿ç”¨æŒ‡å—
   - æ•…éšœæ’æŸ¥
   - æ€§èƒ½è°ƒä¼˜

---

## ğŸ“š å‚è€ƒèµ„æº

- [Cilium eBPF å®˜æ–¹æ–‡æ¡£](https://ebpf-go.dev/)
- [eBPF å…¥é—¨æ•™ç¨‹](https://ebpf.io/what-is-ebpf/)
- [BPF CO-RE](https://nakryiko.com/posts/bpf-portability-and-co-re/)

---

**çŠ¶æ€**: ğŸ”„ é‡æ„ä¸­
**ç›®æ ‡**: ä½¿ç”¨ Cilium eBPF å®ç°çœŸæ­£çš„ç³»ç»Ÿçº§ç›‘æ§
