# 1. ğŸ“š ç¬¬ä¸‰æ–¹æŠ€æœ¯æ ˆæ·±åº¦è§£æ

> **ç®€ä»‹**: æœ¬æ–‡æ¡£å…¨é¢æ¢³ç†å’Œè®ºè¯é¡¹ç›®ä¸­ä½¿ç”¨çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹æŠ€æœ¯æ ˆï¼ŒåŒ…æ‹¬æ ¸å¿ƒç‰¹æ€§ã€é€‰å‹ç†ç”±ã€é›†æˆæ–¹å¼å’Œæœ€ä½³å®è·µã€‚

**ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2025-11-11
**é€‚ç”¨äº**: Go 1.25.3

---

## ğŸ“‹ ç›®å½•

- [1. ğŸ“š ç¬¬ä¸‰æ–¹æŠ€æœ¯æ ˆæ·±åº¦è§£æ](#1--ç¬¬ä¸‰æ–¹æŠ€æœ¯æ ˆæ·±åº¦è§£æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ğŸ¯ æŠ€æœ¯æ ˆæ¦‚è§ˆ](#1--æŠ€æœ¯æ ˆæ¦‚è§ˆ)
    - [1.1 æŠ€æœ¯æ ˆåˆ†å±‚](#11-æŠ€æœ¯æ ˆåˆ†å±‚)
    - [1.2 æŠ€æœ¯é€‰å‹åŸåˆ™](#12-æŠ€æœ¯é€‰å‹åŸåˆ™)
  - [2. ğŸŒ Web æ¡†æ¶å±‚](#2--web-æ¡†æ¶å±‚)
    - [2.1 Chi Router](#21-chi-router)
      - [2.1.1 æ ¸å¿ƒç‰¹æ€§](#211-æ ¸å¿ƒç‰¹æ€§)
      - [2.1.2 é€‰å‹è®ºè¯](#212-é€‰å‹è®ºè¯)
      - [2.1.3 å®é™…åº”ç”¨](#213-å®é™…åº”ç”¨)
        - [2.1.3.1 åŸºç¡€è·¯ç”±é…ç½®](#2131-åŸºç¡€è·¯ç”±é…ç½®)
        - [2.1.3.2 ä¸­é—´ä»¶è¯¦ç»†ä½¿ç”¨](#2132-ä¸­é—´ä»¶è¯¦ç»†ä½¿ç”¨)
        - [2.1.3.3 è·¯ç”±å‚æ•°ç»‘å®šå’ŒéªŒè¯](#2133-è·¯ç”±å‚æ•°ç»‘å®šå’ŒéªŒè¯)
        - [2.1.3.4 è¯·æ±‚ä¸Šä¸‹æ–‡ä¼ é€’](#2134-è¯·æ±‚ä¸Šä¸‹æ–‡ä¼ é€’)
        - [2.1.3.5 æ–‡ä»¶ä¸Šä¼ å¤„ç†](#2135-æ–‡ä»¶ä¸Šä¼ å¤„ç†)
        - [2.1.3.6 WebSocket é›†æˆ](#2136-websocket-é›†æˆ)
      - [2.1.4 æœ€ä½³å®è·µ](#214-æœ€ä½³å®è·µ)
        - [2.1.4.1 ä¸­é—´ä»¶ä½¿ç”¨æœ€ä½³å®è·µ](#2141-ä¸­é—´ä»¶ä½¿ç”¨æœ€ä½³å®è·µ)
        - [2.1.4.2 è·¯ç”±åˆ†ç»„æœ€ä½³å®è·µ](#2142-è·¯ç”±åˆ†ç»„æœ€ä½³å®è·µ)
        - [2.1.4.3 å‚æ•°éªŒè¯æœ€ä½³å®è·µ](#2143-å‚æ•°éªŒè¯æœ€ä½³å®è·µ)
        - [2.1.4.4 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ](#2144-é”™è¯¯å¤„ç†æœ€ä½³å®è·µ)
        - [2.1.4.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#2145-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)
  - [3. ğŸ—„ï¸ æ•°æ®è®¿é—®å±‚](#3-ï¸-æ•°æ®è®¿é—®å±‚)
    - [3.1 Ent ORM](#31-ent-orm)
      - [3.1.1 æ ¸å¿ƒç‰¹æ€§](#311-æ ¸å¿ƒç‰¹æ€§)
      - [3.1.2 é€‰å‹è®ºè¯](#312-é€‰å‹è®ºè¯)
      - [3.1.3 å®é™…åº”ç”¨](#313-å®é™…åº”ç”¨)
        - [3.1.3.1 Schema å®šä¹‰](#3131-schema-å®šä¹‰)
        - [3.1.3.2 å¤æ‚æŸ¥è¯¢ç¤ºä¾‹](#3132-å¤æ‚æŸ¥è¯¢ç¤ºä¾‹)
        - [3.1.3.3 äº‹åŠ¡å¤„ç†](#3133-äº‹åŠ¡å¤„ç†)
        - [3.1.3.4 æ‰¹é‡æ“ä½œ](#3134-æ‰¹é‡æ“ä½œ)
        - [3.1.3.5 è¿ç§»ç®¡ç†](#3135-è¿ç§»ç®¡ç†)
        - [3.1.3.6 æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#3136-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
      - [3.1.4 æœ€ä½³å®è·µ](#314-æœ€ä½³å®è·µ)
        - [3.1.4.1 Schema è®¾è®¡æœ€ä½³å®è·µ](#3141-schema-è®¾è®¡æœ€ä½³å®è·µ)
        - [3.1.4.2 æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ](#3142-æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ)
        - [3.1.4.3 äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ](#3143-äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ)
        - [3.1.4.4 è¿ç§»ç®¡ç†æœ€ä½³å®è·µ](#3144-è¿ç§»ç®¡ç†æœ€ä½³å®è·µ)
        - [3.1.4.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#3145-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)
    - [3.2 PostgreSQL (pgx)](#32-postgresql-pgx)
      - [3.2.1 æ ¸å¿ƒç‰¹æ€§](#321-æ ¸å¿ƒç‰¹æ€§)
      - [3.2.2 é€‰å‹è®ºè¯](#322-é€‰å‹è®ºè¯)
      - [3.2.3 å®é™…åº”ç”¨](#323-å®é™…åº”ç”¨)
        - [3.2.3.1 è¿æ¥æ± é…ç½®](#3231-è¿æ¥æ± é…ç½®)
        - [3.2.3.2 æŸ¥è¯¢æ‰§è¡Œ](#3232-æŸ¥è¯¢æ‰§è¡Œ)
        - [3.2.3.3 äº‹åŠ¡å¤„ç†](#3233-äº‹åŠ¡å¤„ç†)
        - [3.2.3.4 JSON/JSONB æ“ä½œ](#3234-jsonjsonb-æ“ä½œ)
        - [3.2.3.5 æ•°ç»„ç±»å‹æ“ä½œ](#3235-æ•°ç»„ç±»å‹æ“ä½œ)
        - [3.2.3.6 é¢„ç¼–è¯‘è¯­å¥](#3236-é¢„ç¼–è¯‘è¯­å¥)
      - [3.2.4 æœ€ä½³å®è·µ](#324-æœ€ä½³å®è·µ)
        - [3.2.4.1 è¿æ¥æ± é…ç½®æœ€ä½³å®è·µ](#3241-è¿æ¥æ± é…ç½®æœ€ä½³å®è·µ)
        - [3.2.4.2 äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ](#3242-äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ)
        - [3.2.4.3 æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ](#3243-æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ)
        - [3.2.4.4 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ](#3244-é”™è¯¯å¤„ç†æœ€ä½³å®è·µ)
        - [3.2.4.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#3245-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)
  - [4. ğŸ”„ å·¥ä½œæµå±‚](#4--å·¥ä½œæµå±‚)
    - [4.1 Temporal](#41-temporal)
      - [4.1.1 æ ¸å¿ƒç‰¹æ€§](#411-æ ¸å¿ƒç‰¹æ€§)
      - [4.1.2 é€‰å‹è®ºè¯](#412-é€‰å‹è®ºè¯)
      - [4.1.3 å®é™…åº”ç”¨](#413-å®é™…åº”ç”¨)
        - [4.1.3.1 å·¥ä½œæµå®šä¹‰](#4131-å·¥ä½œæµå®šä¹‰)
        - [4.1.3.2 æ´»åŠ¨å®šä¹‰](#4132-æ´»åŠ¨å®šä¹‰)
        - [4.1.3.3 Worker é…ç½®](#4133-worker-é…ç½®)
        - [4.1.3.4 Client ä½¿ç”¨](#4134-client-ä½¿ç”¨)
        - [4.1.3.5 ä¿¡å·å’ŒæŸ¥è¯¢ä½¿ç”¨](#4135-ä¿¡å·å’ŒæŸ¥è¯¢ä½¿ç”¨)
        - [4.1.3.6 é”™è¯¯å¤„ç†ç¤ºä¾‹](#4136-é”™è¯¯å¤„ç†ç¤ºä¾‹)
      - [4.1.4 æœ€ä½³å®è·µ](#414-æœ€ä½³å®è·µ)
        - [4.1.4.1 å·¥ä½œæµè®¾è®¡æœ€ä½³å®è·µ](#4141-å·¥ä½œæµè®¾è®¡æœ€ä½³å®è·µ)
        - [4.1.4.2 æ´»åŠ¨è®¾è®¡æœ€ä½³å®è·µ](#4142-æ´»åŠ¨è®¾è®¡æœ€ä½³å®è·µ)
        - [4.1.4.3 Worker é…ç½®æœ€ä½³å®è·µ](#4143-worker-é…ç½®æœ€ä½³å®è·µ)
  - [5. ğŸ“Š å¯è§‚æµ‹æ€§å±‚](#5--å¯è§‚æµ‹æ€§å±‚)
    - [5.1 OpenTelemetry](#51-opentelemetry)
      - [5.1.1 æ ¸å¿ƒç‰¹æ€§](#511-æ ¸å¿ƒç‰¹æ€§)
      - [5.1.2 é€‰å‹è®ºè¯](#512-é€‰å‹è®ºè¯)
      - [5.1.3 å®é™…åº”ç”¨](#513-å®é™…åº”ç”¨)
        - [5.1.3.1 è¿½è¸ªé›†æˆ](#5131-è¿½è¸ªé›†æˆ)
        - [5.1.3.2 æŒ‡æ ‡æ”¶é›†](#5132-æŒ‡æ ‡æ”¶é›†)
        - [5.1.3.3 æ—¥å¿—é›†æˆ](#5133-æ—¥å¿—é›†æˆ)
        - [5.1.3.4 ä¸Šä¸‹æ–‡ä¼ æ’­](#5134-ä¸Šä¸‹æ–‡ä¼ æ’­)
        - [5.1.3.5 é‡‡æ ·ç­–ç•¥é…ç½®](#5135-é‡‡æ ·ç­–ç•¥é…ç½®)
        - [5.1.3.6 èµ„æºå±æ€§é…ç½®](#5136-èµ„æºå±æ€§é…ç½®)
      - [5.1.4 æœ€ä½³å®è·µ](#514-æœ€ä½³å®è·µ)
        - [5.1.4.1 è¿½è¸ªæœ€ä½³å®è·µ](#5141-è¿½è¸ªæœ€ä½³å®è·µ)
        - [5.1.4.2 æŒ‡æ ‡æœ€ä½³å®è·µ](#5142-æŒ‡æ ‡æœ€ä½³å®è·µ)
        - [5.1.4.3 æ—¥å¿—æœ€ä½³å®è·µ](#5143-æ—¥å¿—æœ€ä½³å®è·µ)
    - [5.2 Prometheus](#52-prometheus)
      - [5.2.1 æ ¸å¿ƒç‰¹æ€§](#521-æ ¸å¿ƒç‰¹æ€§)
      - [5.2.2 é€‰å‹è®ºè¯](#522-é€‰å‹è®ºè¯)
      - [5.2.3 å®é™…åº”ç”¨](#523-å®é™…åº”ç”¨)
        - [5.2.3.1 æŒ‡æ ‡å®šä¹‰å’Œæš´éœ²](#5231-æŒ‡æ ‡å®šä¹‰å’Œæš´éœ²)
        - [5.2.3.2 åœ¨ä»£ç ä¸­ä½¿ç”¨æŒ‡æ ‡](#5232-åœ¨ä»£ç ä¸­ä½¿ç”¨æŒ‡æ ‡)
        - [5.2.3.3 å‘Šè­¦è§„åˆ™é…ç½®](#5233-å‘Šè­¦è§„åˆ™é…ç½®)
        - [5.2.3.4 æœåŠ¡å‘ç°é…ç½®](#5234-æœåŠ¡å‘ç°é…ç½®)
      - [5.2.4 æœ€ä½³å®è·µ](#524-æœ€ä½³å®è·µ)
        - [5.2.4.1 æŒ‡æ ‡è®¾è®¡æœ€ä½³å®è·µ](#5241-æŒ‡æ ‡è®¾è®¡æœ€ä½³å®è·µ)
        - [5.2.4.2 å‘Šè­¦è§„åˆ™æœ€ä½³å®è·µ](#5242-å‘Šè­¦è§„åˆ™æœ€ä½³å®è·µ)
    - [5.3 Grafana](#53-grafana)
      - [5.3.1 æ ¸å¿ƒç‰¹æ€§](#531-æ ¸å¿ƒç‰¹æ€§)
      - [5.3.2 é€‰å‹è®ºè¯](#532-é€‰å‹è®ºè¯)
      - [5.3.3 å®é™…åº”ç”¨](#533-å®é™…åº”ç”¨)
        - [5.3.3.1 æ•°æ®æºé…ç½®](#5331-æ•°æ®æºé…ç½®)
        - [5.3.3.2 ä»ªè¡¨æ¿åˆ›å»º](#5332-ä»ªè¡¨æ¿åˆ›å»º)
        - [5.3.3.3 æŸ¥è¯¢ç¼–å†™](#5333-æŸ¥è¯¢ç¼–å†™)
        - [5.3.3.4 å‘Šè­¦é…ç½®](#5334-å‘Šè­¦é…ç½®)
      - [5.3.4 æœ€ä½³å®è·µ](#534-æœ€ä½³å®è·µ)
        - [5.3.4.1 ä»ªè¡¨æ¿è®¾è®¡æœ€ä½³å®è·µ](#5341-ä»ªè¡¨æ¿è®¾è®¡æœ€ä½³å®è·µ)
    - [5.4 Jaeger](#54-jaeger)
      - [5.4.1 æ ¸å¿ƒç‰¹æ€§](#541-æ ¸å¿ƒç‰¹æ€§)
      - [5.4.2 é€‰å‹è®ºè¯](#542-é€‰å‹è®ºè¯)
      - [5.4.3 å®é™…åº”ç”¨](#543-å®é™…åº”ç”¨)
        - [5.4.3.1 é…ç½® OpenTelemetry å¯¼å‡ºåˆ° Jaeger](#5431-é…ç½®-opentelemetry-å¯¼å‡ºåˆ°-jaeger)
        - [5.4.3.2 åœ¨ Jaeger UI ä¸­æŸ¥çœ‹è¿½è¸ª](#5432-åœ¨-jaeger-ui-ä¸­æŸ¥çœ‹è¿½è¸ª)
        - [5.4.3.3 æŸ¥è¯¢è¿½è¸ªæ•°æ®](#5433-æŸ¥è¯¢è¿½è¸ªæ•°æ®)
      - [5.4.4 æœ€ä½³å®è·µ](#544-æœ€ä½³å®è·µ)
        - [5.4.4.1 è¿½è¸ªè®¾è®¡æœ€ä½³å®è·µ](#5441-è¿½è¸ªè®¾è®¡æœ€ä½³å®è·µ)
  - [6. ğŸ’¬ æ¶ˆæ¯é˜Ÿåˆ—å±‚](#6--æ¶ˆæ¯é˜Ÿåˆ—å±‚)
    - [6.1 Kafka (Sarama)](#61-kafka-sarama)
      - [6.1.1 æ ¸å¿ƒç‰¹æ€§](#611-æ ¸å¿ƒç‰¹æ€§)
      - [6.1.2 é€‰å‹è®ºè¯](#612-é€‰å‹è®ºè¯)
      - [6.1.3 å®é™…åº”ç”¨](#613-å®é™…åº”ç”¨)
        - [6.1.3.1 ç”Ÿäº§è€…ç¤ºä¾‹](#6131-ç”Ÿäº§è€…ç¤ºä¾‹)
        - [6.1.3.2 æ¶ˆè´¹è€…ç¤ºä¾‹](#6132-æ¶ˆè´¹è€…ç¤ºä¾‹)
        - [6.1.3.3 åˆ†åŒºç­–ç•¥](#6133-åˆ†åŒºç­–ç•¥)
      - [6.1.4 æœ€ä½³å®è·µ](#614-æœ€ä½³å®è·µ)
        - [6.1.4.1 ç”Ÿäº§è€…æœ€ä½³å®è·µ](#6141-ç”Ÿäº§è€…æœ€ä½³å®è·µ)
        - [6.1.4.2 æ¶ˆè´¹è€…æœ€ä½³å®è·µ](#6142-æ¶ˆè´¹è€…æœ€ä½³å®è·µ)
    - [6.2 MQTT](#62-mqtt)
      - [6.2.1 æ ¸å¿ƒç‰¹æ€§](#621-æ ¸å¿ƒç‰¹æ€§)
      - [6.2.2 é€‰å‹è®ºè¯](#622-é€‰å‹è®ºè¯)
      - [6.2.3 å®é™…åº”ç”¨](#623-å®é™…åº”ç”¨)
        - [6.2.3.1 å®¢æˆ·ç«¯è¿æ¥](#6231-å®¢æˆ·ç«¯è¿æ¥)
        - [6.2.3.2 å‘å¸ƒæ¶ˆæ¯](#6232-å‘å¸ƒæ¶ˆæ¯)
        - [6.2.3.3 è®¢é˜…ä¸»é¢˜](#6233-è®¢é˜…ä¸»é¢˜)
        - [6.2.3.4 QoS çº§åˆ«ä½¿ç”¨](#6234-qos-çº§åˆ«ä½¿ç”¨)
      - [6.2.4 æœ€ä½³å®è·µ](#624-æœ€ä½³å®è·µ)
        - [6.2.4.1 ä¸»é¢˜è®¾è®¡æœ€ä½³å®è·µ](#6241-ä¸»é¢˜è®¾è®¡æœ€ä½³å®è·µ)
        - [6.2.4.2 QoS é€‰æ‹©æœ€ä½³å®è·µ](#6242-qos-é€‰æ‹©æœ€ä½³å®è·µ)
  - [7. âš™ï¸ é…ç½®å’Œå·¥å…·å±‚](#7-ï¸-é…ç½®å’Œå·¥å…·å±‚)
    - [7.1 Viper](#71-viper)
      - [7.1.1 æ ¸å¿ƒç‰¹æ€§](#711-æ ¸å¿ƒç‰¹æ€§)
      - [7.1.2 é€‰å‹è®ºè¯](#712-é€‰å‹è®ºè¯)
      - [7.1.3 å®é™…åº”ç”¨](#713-å®é™…åº”ç”¨)
        - [7.1.3.1 é…ç½®æ–‡ä»¶åŠ è½½](#7131-é…ç½®æ–‡ä»¶åŠ è½½)
        - [7.1.3.2 ç¯å¢ƒå˜é‡ä½¿ç”¨](#7132-ç¯å¢ƒå˜é‡ä½¿ç”¨)
        - [7.1.3.3 é…ç½®çƒ­é‡è½½](#7133-é…ç½®çƒ­é‡è½½)
        - [7.1.3.4 è¿œç¨‹é…ç½®](#7134-è¿œç¨‹é…ç½®)
      - [7.1.4 æœ€ä½³å®è·µ](#714-æœ€ä½³å®è·µ)
        - [7.1.4.1 é…ç½®ç»“æ„è®¾è®¡æœ€ä½³å®è·µ](#7141-é…ç½®ç»“æ„è®¾è®¡æœ€ä½³å®è·µ)
    - [7.2 Slog](#72-slog)
      - [7.2.1 æ ¸å¿ƒç‰¹æ€§](#721-æ ¸å¿ƒç‰¹æ€§)
      - [7.2.2 é€‰å‹è®ºè¯](#722-é€‰å‹è®ºè¯)
      - [7.2.3 å®é™…åº”ç”¨](#723-å®é™…åº”ç”¨)
        - [7.2.3.1 åŸºç¡€æ—¥å¿—ä½¿ç”¨](#7231-åŸºç¡€æ—¥å¿—ä½¿ç”¨)
        - [7.2.3.2 ç»“æ„åŒ–æ—¥å¿—](#7232-ç»“æ„åŒ–æ—¥å¿—)
        - [7.2.3.3 æ—¥å¿—ä¸Šä¸‹æ–‡](#7233-æ—¥å¿—ä¸Šä¸‹æ–‡)
        - [7.2.3.4 è‡ªå®šä¹‰ Handler](#7234-è‡ªå®šä¹‰-handler)
      - [7.2.4 æœ€ä½³å®è·µ](#724-æœ€ä½³å®è·µ)
        - [7.2.4.1 æ—¥å¿—çº§åˆ«é€‰æ‹©æœ€ä½³å®è·µ](#7241-æ—¥å¿—çº§åˆ«é€‰æ‹©æœ€ä½³å®è·µ)
    - [7.3 Wire](#73-wire)
      - [7.3.1 æ ¸å¿ƒç‰¹æ€§](#731-æ ¸å¿ƒç‰¹æ€§)
      - [7.3.2 é€‰å‹è®ºè¯](#732-é€‰å‹è®ºè¯)
      - [7.3.3 å®é™…åº”ç”¨](#733-å®é™…åº”ç”¨)
        - [7.3.3.1 Provider å‡½æ•°ç¼–å†™](#7331-provider-å‡½æ•°ç¼–å†™)
        - [7.3.3.2 ä»£ç ç”Ÿæˆ](#7332-ä»£ç ç”Ÿæˆ)
        - [7.3.3.3 ä½¿ç”¨ç”Ÿæˆçš„ä»£ç ](#7333-ä½¿ç”¨ç”Ÿæˆçš„ä»£ç )
      - [7.3.4 æœ€ä½³å®è·µ](#734-æœ€ä½³å®è·µ)
        - [7.3.4.1 Provider è®¾è®¡æœ€ä½³å®è·µ](#7341-provider-è®¾è®¡æœ€ä½³å®è·µ)
  - [8. ğŸ”Œ API åè®®å±‚](#8--api-åè®®å±‚)
    - [8.1 gRPC](#81-grpc)
      - [8.1.1 æ ¸å¿ƒç‰¹æ€§](#811-æ ¸å¿ƒç‰¹æ€§)
      - [8.1.2 é€‰å‹è®ºè¯](#812-é€‰å‹è®ºè¯)
      - [8.1.3 å®é™…åº”ç”¨](#813-å®é™…åº”ç”¨)
        - [8.1.3.1 Protocol Buffers å®šä¹‰](#8131-protocol-buffers-å®šä¹‰)
        - [8.1.3.2 æœåŠ¡å®ç°](#8132-æœåŠ¡å®ç°)
        - [8.1.3.3 æœåŠ¡å™¨å¯åŠ¨](#8133-æœåŠ¡å™¨å¯åŠ¨)
        - [8.1.3.4 å®¢æˆ·ç«¯è°ƒç”¨](#8134-å®¢æˆ·ç«¯è°ƒç”¨)
        - [8.1.3.5 æµå¼ RPC](#8135-æµå¼-rpc)
      - [8.1.4 æœ€ä½³å®è·µ](#814-æœ€ä½³å®è·µ)
        - [8.1.4.1 æœåŠ¡è®¾è®¡æœ€ä½³å®è·µ](#8141-æœåŠ¡è®¾è®¡æœ€ä½³å®è·µ)
    - [8.2 GraphQL](#82-graphql)
      - [8.2.1 æ ¸å¿ƒç‰¹æ€§](#821-æ ¸å¿ƒç‰¹æ€§)
      - [8.2.2 é€‰å‹è®ºè¯](#822-é€‰å‹è®ºè¯)
      - [8.2.3 å®é™…åº”ç”¨](#823-å®é™…åº”ç”¨)
        - [8.2.3.1 Schema å®šä¹‰](#8231-schema-å®šä¹‰)
        - [8.2.3.2 æŸ¥è¯¢è§£æå™¨](#8232-æŸ¥è¯¢è§£æå™¨)
        - [8.2.3.3 å˜æ›´è§£æå™¨](#8233-å˜æ›´è§£æå™¨)
        - [8.2.3.4 æ•°æ®åŠ è½½å™¨](#8234-æ•°æ®åŠ è½½å™¨)
      - [8.2.4 æœ€ä½³å®è·µ](#824-æœ€ä½³å®è·µ)
        - [8.2.4.1 Schema è®¾è®¡æœ€ä½³å®è·µ](#8241-schema-è®¾è®¡æœ€ä½³å®è·µ)
  - [9. ğŸ”— æŠ€æœ¯æ ˆé›†æˆ](#9--æŠ€æœ¯æ ˆé›†æˆ)
    - [9.1 é›†æˆæ¶æ„](#91-é›†æˆæ¶æ„)
    - [9.2 é›†æˆæœ€ä½³å®è·µ](#92-é›†æˆæœ€ä½³å®è·µ)
      - [9.2.1 ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ](#921-ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ)
      - [9.2.2 é…ç½®ç®¡ç†æœ€ä½³å®è·µ](#922-é…ç½®ç®¡ç†æœ€ä½³å®è·µ)
      - [9.2.3 æ—¥å¿—æœ€ä½³å®è·µ](#923-æ—¥å¿—æœ€ä½³å®è·µ)
      - [9.2.4 å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ](#924-å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ)
  - [10. ğŸ¯ æŠ€æœ¯æ ˆé€‰å‹å†³ç­–æ ‘](#10--æŠ€æœ¯æ ˆé€‰å‹å†³ç­–æ ‘)
    - [10.1 å¯è§‚æµ‹æ€§æŠ€æœ¯æ ˆé€‰å‹å†³ç­–æ ‘](#101-å¯è§‚æµ‹æ€§æŠ€æœ¯æ ˆé€‰å‹å†³ç­–æ ‘)
    - [10.2 æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹å†³ç­–æ ‘](#102-æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹å†³ç­–æ ‘)
    - [10.3 é…ç½®ç®¡ç†é€‰å‹å†³ç­–æ ‘](#103-é…ç½®ç®¡ç†é€‰å‹å†³ç­–æ ‘)
    - [10.4 æ—¥å¿—åº“é€‰å‹å†³ç­–æ ‘](#104-æ—¥å¿—åº“é€‰å‹å†³ç­–æ ‘)
    - [10.5 API åè®®é€‰å‹å†³ç­–æ ‘](#105-api-åè®®é€‰å‹å†³ç­–æ ‘)
  - [ğŸ“š æ‰©å±•é˜…è¯»](#-æ‰©å±•é˜…è¯»)
    - [æ¶æ„ç›¸å…³](#æ¶æ„ç›¸å…³)
    - [æŠ€æœ¯æ–‡æ¡£](#æŠ€æœ¯æ–‡æ¡£)

---

## 1. ğŸ¯ æŠ€æœ¯æ ˆæ¦‚è§ˆ

### 1.1 æŠ€æœ¯æ ˆåˆ†å±‚

```mermaid
mindmap
  root((Go æŠ€æœ¯æ ˆ))
    Webæ¡†æ¶å±‚
      Chi Router
        âœ… æ ‡å‡†åº“å…¼å®¹
        âœ… è½»é‡çº§
        âœ… é«˜æ€§èƒ½
        âœ… ä¸­é—´ä»¶ç”Ÿæ€
    æ•°æ®è®¿é—®å±‚
      Ent ORM
        âœ… ç±»å‹å®‰å…¨
        âœ… ä»£ç ç”Ÿæˆ
        âœ… Schema å®šä¹‰
      PostgreSQL pgx
        âœ… é«˜æ€§èƒ½
        âœ… åŠŸèƒ½å®Œæ•´
        âœ… JSON æ”¯æŒ
    å·¥ä½œæµå±‚
      Temporal
        âœ… Go SDK å®˜æ–¹
        âœ… æŒä¹…åŒ–
        âœ… å¯è§‚æµ‹æ€§
    å¯è§‚æµ‹æ€§å±‚
      OpenTelemetry
        âœ… è¡Œä¸šæ ‡å‡†
        âœ… ä¸‰æ”¯æŸ±æ”¯æŒ
        âœ… ç”Ÿæ€ä¸°å¯Œ
      Prometheus
        âœ… ç›‘æ§æ ‡å‡†
        âœ… é«˜æ€§èƒ½
        âœ… ç”Ÿæ€ä¸°å¯Œ
      Grafana
        âœ… å¯è§†åŒ–å¼ºå¤§
        âœ… æ•°æ®æºä¸°å¯Œ
        âœ… ç¤¾åŒºæ´»è·ƒ
      Jaeger
        âœ… OTLP é›†æˆ
        âœ… å¯è§†åŒ–å®Œå–„
        âœ… å¼€æºå…è´¹
    æ¶ˆæ¯é˜Ÿåˆ—å±‚
      Kafka
        âœ… é«˜ååé‡
        âœ… æŒä¹…åŒ–
        âœ… åˆ†åŒºæ”¯æŒ
      MQTT
        âœ… IoT é€‚é…
        âœ… è½»é‡çº§
        âœ… QoS æ”¯æŒ
    é…ç½®å·¥å…·å±‚
      Viper
        âœ… åŠŸèƒ½å®Œæ•´
        âœ… å¤šæ ¼å¼æ”¯æŒ
        âœ… æ˜“ç”¨æ€§
      Slog
        âœ… æ ‡å‡†åº“
        âœ… ç»“æ„åŒ–æ—¥å¿—
        âœ… æ€§èƒ½ä¼˜ç§€
      Wire
        âœ… ç¼–è¯‘æ—¶æ£€æŸ¥
        âœ… é›¶åå°„
        âœ… ç±»å‹å®‰å…¨
    APIåè®®å±‚
      gRPC
        âœ… é«˜æ€§èƒ½
        âœ… ç±»å‹å®‰å…¨
        âœ… æµå¼å¤„ç†
      GraphQL
        âœ… æŸ¥è¯¢çµæ´»
        âœ… ç±»å‹ç³»ç»Ÿ
        âœ… å®¢æˆ·ç«¯æ§åˆ¶
```

### 1.2 æŠ€æœ¯é€‰å‹åŸåˆ™

**é€‰å‹æ ‡å‡†**:

1. **æˆç†Ÿåº¦**: æŠ€æœ¯å¿…é¡»æˆç†Ÿç¨³å®šï¼Œæœ‰è‰¯å¥½çš„ç¤¾åŒºæ”¯æŒ
2. **Go æ”¯æŒ**: å¿…é¡»æœ‰è‰¯å¥½çš„ Go è¯­è¨€æ”¯æŒ
3. **æ€§èƒ½**: æ€§èƒ½æ»¡è¶³é¡¹ç›®éœ€æ±‚
4. **å¯ç»´æŠ¤æ€§**: ä»£ç æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
5. **ç”Ÿæ€ç³»ç»Ÿ**: æœ‰ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿå’Œå·¥å…·æ”¯æŒ

---

## 2. ğŸŒ Web æ¡†æ¶å±‚

### 2.1 Chi Router

#### 2.1.1 æ ¸å¿ƒç‰¹æ€§

**Chi æ˜¯ä»€ä¹ˆï¼Ÿ**

Chi æ˜¯ä¸€ä¸ªè½»é‡çº§ã€å¯ç»„åˆçš„ Go HTTP è·¯ç”±å™¨ï¼Œä¸“æ³¨äºæä¾›ç®€æ´ã€é«˜æ€§èƒ½çš„è·¯ç”±åŠŸèƒ½ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **è½»é‡çº§**: ä»£ç é‡å°ï¼Œä¾èµ–å°‘
- âœ… **æ ‡å‡†åº“å…¼å®¹**: å®Œå…¨åŸºäº `net/http`ï¼Œå…¼å®¹æ‰€æœ‰æ ‡å‡†åº“ä¸­é—´ä»¶
- âœ… **é«˜æ€§èƒ½**: è·¯ç”±åŒ¹é…é€Ÿåº¦å¿«
- âœ… **ä¸­é—´ä»¶æ”¯æŒ**: ä¸°å¯Œçš„ä¸­é—´ä»¶ç”Ÿæ€
- âœ… **è·¯ç”±ç»„**: æ”¯æŒè·¯ç”±åˆ†ç»„å’ŒåµŒå¥—

#### 2.1.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Chiï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Chi | Gin | Echo | è¯´æ˜ |
|---------|------|-----|-----|------|------|
| **æ ‡å‡†åº“å…¼å®¹** | 30% | 10 | 3 | 3 | Chi å®Œå…¨åŸºäºæ ‡å‡†åº“ |
| **å­¦ä¹ æˆæœ¬** | 25% | 10 | 7 | 7 | Chi API ä¸æ ‡å‡†åº“ä¸€è‡´ |
| **æ€§èƒ½** | 20% | 8 | 10 | 9 | æ€§èƒ½è¶³å¤Ÿï¼Œä¸æ˜¯ç“¶é¢ˆ |
| **åŠŸèƒ½ä¸°å¯Œåº¦** | 15% | 7 | 10 | 10 | åŠŸèƒ½è¶³å¤Ÿ |
| **ç»´æŠ¤æˆæœ¬** | 10% | 10 | 7 | 7 | ä»£ç é‡å°ï¼Œæ˜“ç»´æŠ¤ |
| **åŠ æƒæ€»åˆ†** | - | **8.85** | 7.15 | 7.20 | Chi å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **æ ‡å‡†åº“å…¼å®¹æ€§ï¼ˆæƒé‡ 30%ï¼‰**:
   - Chi å®Œå…¨åŸºäº `net/http`ï¼Œå¯ä»¥ä½¿ç”¨æ‰€æœ‰æ ‡å‡†åº“åŠŸèƒ½
   - ä¸­é—´ä»¶ç”Ÿæ€ä¸°å¯Œï¼Œå…¼å®¹æ‰€æœ‰ `net/http` ä¸­é—´ä»¶
   - è¿ç§»æˆæœ¬æä½ï¼Œä»æ ‡å‡†åº“è¿ç§»å‡ ä¹æ— ç¼

2. **å­¦ä¹ æˆæœ¬ä½ï¼ˆæƒé‡ 25%ï¼‰**:
   - å›¢é˜Ÿæˆå‘˜éƒ½ç†Ÿæ‚‰æ ‡å‡†åº“ï¼Œæ— éœ€é¢å¤–åŸ¹è®­
   - API ä¸æ ‡å‡†åº“ä¸€è‡´ï¼Œé™ä½å­¦ä¹ æ›²çº¿
   - æ–‡æ¡£ç®€æ´æ¸…æ™°ï¼Œæ˜“äºç†è§£

3. **ç»´æŠ¤æˆæœ¬ä½ï¼ˆæƒé‡ 10%ï¼‰**:
   - ä»£ç é‡å°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
   - ä¾èµ–å°‘ï¼Œå‡å°‘å®‰å…¨é£é™©
   - æ›´æ–°é¢‘ç‡ä½ï¼Œç¨³å®šæ€§å¥½

#### 2.1.3 å®é™…åº”ç”¨

##### 2.1.3.1 åŸºç¡€è·¯ç”±é…ç½®

**å®Œæ•´è·¯ç”±é…ç½®ç¤ºä¾‹**:

```go
// internal/interfaces/http/chi/router.go
package chi

import (
    "github.com/go-chi/chi/v5"
    "github.com/go-chi/chi/v5/middleware"
)

func NewRouter() *chi.Mux {
    r := chi.NewRouter()

    // å…¨å±€ä¸­é—´ä»¶ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰
    r.Use(middleware.RequestID)      // ä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€ ID
    r.Use(middleware.RealIP)         // è·å–çœŸå® IP åœ°å€
    r.Use(middleware.Logger)         // è¯·æ±‚æ—¥å¿—
    r.Use(middleware.Recoverer)      // Panic æ¢å¤
    r.Use(middleware.Compress(5))    // å“åº”å‹ç¼©
    r.Use(middleware.Timeout(60 * time.Second)) // è¯·æ±‚è¶…æ—¶

    // API è·¯ç”±
    r.Route("/api/v1", func(r chi.Router) {
        r.Mount("/users", userRoutes())
        r.Mount("/workflows", workflowRoutes())
        r.Mount("/health", healthRoutes())
    })

    // é™æ€æ–‡ä»¶æœåŠ¡
    r.Mount("/static", http.StripPrefix("/static", http.FileServer(http.Dir("./static"))))

    return r
}
```

##### 2.1.3.2 ä¸­é—´ä»¶è¯¦ç»†ä½¿ç”¨

**è®¤è¯ä¸­é—´ä»¶**:

```go
// è®¤è¯ä¸­é—´ä»¶
func AuthMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // ä» Header è·å– Token
        token := r.Header.Get("Authorization")
        if token == "" {
            http.Error(w, "Unauthorized", http.StatusUnauthorized)
            return
        }

        // éªŒè¯ Token
        claims, err := validateJWT(token)
        if err != nil {
            http.Error(w, "Unauthorized", http.StatusUnauthorized)
            return
        }

        // å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
        ctx := context.WithValue(r.Context(), "userID", claims.UserID)
        ctx = context.WithValue(ctx, "userRole", claims.Role)

        next.ServeHTTP(w, r.WithContext(ctx))
    })
}

// æƒé™æ£€æŸ¥ä¸­é—´ä»¶
func RequirePermission(permission string) func(http.Handler) http.Handler {
    return func(next http.Handler) http.Handler {
        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
            userRole := r.Context().Value("userRole").(string)

            if !hasPermission(userRole, permission) {
                http.Error(w, "Forbidden", http.StatusForbidden)
                return
            }

            next.ServeHTTP(w, r)
        })
    }
}
```

**é™æµä¸­é—´ä»¶**:

```go
import "golang.org/x/time/rate"

// é™æµä¸­é—´ä»¶
func RateLimitMiddleware(limiter *rate.Limiter) func(http.Handler) http.Handler {
    return func(next http.Handler) http.Handler {
        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
            if !limiter.Allow() {
                http.Error(w, "Too Many Requests", http.StatusTooManyRequests)
                return
            }
            next.ServeHTTP(w, r)
        })
    }
}

// ä½¿ç”¨é™æµ
func NewRouter() *chi.Mux {
    r := chi.NewRouter()

    // åˆ›å»ºé™æµå™¨ï¼šæ¯ç§’ 100 ä¸ªè¯·æ±‚
    limiter := rate.NewLimiter(100, 100)
    r.Use(RateLimitMiddleware(limiter))

    return r
}
```

**CORS ä¸­é—´ä»¶**:

```go
// CORS ä¸­é—´ä»¶
func CORSMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Access-Control-Allow-Origin", "*")
        w.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
        w.Header().Set("Access-Control-Allow-Headers", "Content-Type, Authorization")

        if r.Method == "OPTIONS" {
            w.WriteHeader(http.StatusOK)
            return
        }

        next.ServeHTTP(w, r)
    })
}
```

##### 2.1.3.3 è·¯ç”±å‚æ•°ç»‘å®šå’ŒéªŒè¯

**URL å‚æ•°è·å–**:

```go
// è·å– URL å‚æ•°
func (h *UserHandler) GetUser(w http.ResponseWriter, r *http.Request) {
    userID := chi.URLParam(r, "id")

    // éªŒè¯ UUID æ ¼å¼
    if _, err := uuid.Parse(userID); err != nil {
        Error(w, http.StatusBadRequest, errors.NewInvalidInputError("Invalid user ID"))
        return
    }

    user, err := h.service.GetUser(r.Context(), userID)
    if err != nil {
        Error(w, http.StatusInternalServerError, err)
        return
    }

    Success(w, http.StatusOK, user)
}

// è·å–æŸ¥è¯¢å‚æ•°
func (h *UserHandler) ListUsers(w http.ResponseWriter, r *http.Request) {
    // è·å–æŸ¥è¯¢å‚æ•°
    page := r.URL.Query().Get("page")
    pageSize := r.URL.Query().Get("page_size")

    // è§£æå’ŒéªŒè¯
    pageNum, _ := strconv.Atoi(page)
    if pageNum < 1 {
        pageNum = 1
    }

    size, _ := strconv.Atoi(pageSize)
    if size < 1 || size > 100 {
        size = 20
    }

    users, err := h.service.ListUsers(r.Context(), pageNum, size)
    if err != nil {
        Error(w, http.StatusInternalServerError, err)
        return
    }

    Success(w, http.StatusOK, users)
}
```

**è¯·æ±‚ä½“ç»‘å®š**:

```go
// è¯·æ±‚ä½“ç»‘å®šå’ŒéªŒè¯
type CreateUserRequest struct {
    Email    string `json:"email" validate:"required,email"`
    Name     string `json:"name" validate:"required,min=2,max=50"`
    Password string `json:"password" validate:"required,min=8"`
}

func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    var req CreateUserRequest

    // ç»‘å®šè¯·æ±‚ä½“
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        Error(w, http.StatusBadRequest, errors.NewInvalidInputError("Invalid JSON"))
        return
    }

    // éªŒè¯è¯·æ±‚å‚æ•°
    validate := validator.New()
    if err := validate.Struct(req); err != nil {
        Error(w, http.StatusBadRequest, errors.NewValidationError(err.Error()))
        return
    }

    user, err := h.service.CreateUser(r.Context(), req)
    if err != nil {
        Error(w, http.StatusInternalServerError, err)
        return
    }

    Success(w, http.StatusCreated, user)
}
```

##### 2.1.3.4 è¯·æ±‚ä¸Šä¸‹æ–‡ä¼ é€’

**ä¸Šä¸‹æ–‡ä¼ é€’ç¤ºä¾‹**:

```go
// åœ¨ä¸­é—´ä»¶ä¸­è®¾ç½®ä¸Šä¸‹æ–‡å€¼
func RequestContextMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // è·å–è¯·æ±‚ ID
        requestID := middleware.GetReqID(r.Context())

        // åˆ›å»ºæ–°çš„ä¸Šä¸‹æ–‡ï¼Œæ·»åŠ è¯·æ±‚ä¿¡æ¯
        ctx := r.Context()
        ctx = context.WithValue(ctx, "requestID", requestID)
        ctx = context.WithValue(ctx, "startTime", time.Now())
        ctx = context.WithValue(ctx, "clientIP", r.RemoteAddr)

        next.ServeHTTP(w, r.WithContext(ctx))
    })
}

// åœ¨ Handler ä¸­ä½¿ç”¨ä¸Šä¸‹æ–‡
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    // ä»ä¸Šä¸‹æ–‡è·å–è¯·æ±‚ ID
    requestID := r.Context().Value("requestID").(string)

    // åœ¨æ—¥å¿—ä¸­ä½¿ç”¨è¯·æ±‚ ID
    logger.Info("Creating user",
        "requestID", requestID,
        "path", r.URL.Path,
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(r.Context(), req)
    // ...
}
```

##### 2.1.3.5 æ–‡ä»¶ä¸Šä¼ å¤„ç†

**æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹**:

```go
// æ–‡ä»¶ä¸Šä¼  Handler
func (h *FileHandler) UploadFile(w http.ResponseWriter, r *http.Request) {
    // é™åˆ¶ä¸Šä¼ æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
    r.ParseMultipartForm(10 << 20)

    // è·å–ä¸Šä¼ çš„æ–‡ä»¶
    file, handler, err := r.FormFile("file")
    if err != nil {
        Error(w, http.StatusBadRequest, errors.NewInvalidInputError("No file uploaded"))
        return
    }
    defer file.Close()

    // éªŒè¯æ–‡ä»¶ç±»å‹
    if !isValidFileType(handler.Filename) {
        Error(w, http.StatusBadRequest, errors.NewInvalidInputError("Invalid file type"))
        return
    }

    // ä¿å­˜æ–‡ä»¶
    filePath := fmt.Sprintf("./uploads/%s", handler.Filename)
    dst, err := os.Create(filePath)
    if err != nil {
        Error(w, http.StatusInternalServerError, errors.NewInternalError("Failed to save file"))
        return
    }
    defer dst.Close()

    if _, err := io.Copy(dst, file); err != nil {
        Error(w, http.StatusInternalServerError, errors.NewInternalError("Failed to save file"))
        return
    }

    Success(w, http.StatusOK, map[string]string{
        "filename": handler.Filename,
        "size":     fmt.Sprintf("%d", handler.Size),
    })
}
```

##### 2.1.3.6 WebSocket é›†æˆ

**WebSocket é›†æˆç¤ºä¾‹**:

```go
import "github.com/gorilla/websocket"

var upgrader = websocket.Upgrader{
    CheckOrigin: func(r *http.Request) bool {
        return true // ç”Ÿäº§ç¯å¢ƒéœ€è¦éªŒè¯ Origin
    },
}

// WebSocket Handler
func (h *WebSocketHandler) HandleWebSocket(w http.ResponseWriter, r *http.Request) {
    // å‡çº§åˆ° WebSocket è¿æ¥
    conn, err := upgrader.Upgrade(w, r, nil)
    if err != nil {
        logger.Error("WebSocket upgrade failed", "error", err)
        return
    }
    defer conn.Close()

    // å¤„ç† WebSocket æ¶ˆæ¯
    for {
        messageType, message, err := conn.ReadMessage()
        if err != nil {
            logger.Error("WebSocket read error", "error", err)
            break
        }

        // å¤„ç†æ¶ˆæ¯
        response := h.processMessage(message)

        // å‘é€å“åº”
        if err := conn.WriteMessage(messageType, response); err != nil {
            logger.Error("WebSocket write error", "error", err)
            break
        }
    }
}

// è·¯ç”±é…ç½®
func websocketRoutes() chi.Router {
    r := chi.NewRouter()
    handler := NewWebSocketHandler()

    r.Get("/ws", handler.HandleWebSocket)

    return r
}
```

#### 2.1.4 æœ€ä½³å®è·µ

##### 2.1.4.1 ä¸­é—´ä»¶ä½¿ç”¨æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦ä¸­é—´ä»¶ï¼Ÿ**

ä¸­é—´ä»¶æ˜¯å¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆCross-Cutting Concernsï¼‰çš„æœ€ä½³æ–¹å¼ï¼Œå¯ä»¥ç»Ÿä¸€å¤„ç†æ—¥å¿—ã€è®¤è¯ã€è¿½è¸ªã€é™æµç­‰é€šç”¨é€»è¾‘ï¼Œé¿å…åœ¨æ¯ä¸ª Handler ä¸­é‡å¤ç¼–å†™ç›¸åŒä»£ç ã€‚

**ä¸­é—´ä»¶è®¾è®¡åŸåˆ™**:

1. **å•ä¸€èŒè´£**: æ¯ä¸ªä¸­é—´ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **å¯ç»„åˆæ€§**: ä¸­é—´ä»¶å¯ä»¥ç»„åˆä½¿ç”¨
3. **å¯æµ‹è¯•æ€§**: ä¸­é—´ä»¶å¯ä»¥ç‹¬ç«‹æµ‹è¯•
4. **æ€§èƒ½è€ƒè™‘**: é¿å…åœ¨ä¸­é—´ä»¶ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// è®¤è¯ä¸­é—´ä»¶
func AuthMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        token := r.Header.Get("Authorization")
        if token == "" {
            http.Error(w, "Unauthorized", http.StatusUnauthorized)
            return
        }

        // éªŒè¯ token
        userID, err := validateToken(token)
        if err != nil {
            http.Error(w, "Unauthorized", http.StatusUnauthorized)
            return
        }

        // å°† userID æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
        ctx := context.WithValue(r.Context(), "userID", userID)
        next.ServeHTTP(w, r.WithContext(ctx))
    })
}

// æ—¥å¿—ä¸­é—´ä»¶
func LoggingMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        start := time.Now()

        // åŒ…è£… ResponseWriter ä»¥æ•è·çŠ¶æ€ç 
        ww := &responseWriter{ResponseWriter: w, statusCode: http.StatusOK}

        next.ServeHTTP(ww, r)

        duration := time.Since(start)
        logger.Info("HTTP request",
            "method", r.Method,
            "path", r.URL.Path,
            "status", ww.statusCode,
            "duration", duration,
        )
    })
}

// è¿½è¸ªä¸­é—´ä»¶
func TracingMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        ctx, span := tracer.Start(r.Context(), r.URL.Path)
        defer span.End()

        span.SetAttributes(
            attribute.String("http.method", r.Method),
            attribute.String("http.path", r.URL.Path),
        )

        next.ServeHTTP(w, r.WithContext(ctx))
    })
}

// ä½¿ç”¨ä¸­é—´ä»¶
func NewRouter() *chi.Mux {
    r := chi.NewRouter()

    // å…¨å±€ä¸­é—´ä»¶ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰
    r.Use(middleware.RequestID)
    r.Use(middleware.RealIP)
    r.Use(LoggingMiddleware)
    r.Use(TracingMiddleware)
    r.Use(middleware.Recoverer)

    // è·¯ç”±
    r.Route("/api/v1", func(r chi.Router) {
        // å…¬å…±è·¯ç”±
        r.Post("/login", loginHandler)

        // éœ€è¦è®¤è¯çš„è·¯ç”±
        r.Group(func(r chi.Router) {
            r.Use(AuthMiddleware)
            r.Mount("/users", userRoutes())
        })
    })

    return r
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ä¸­é—´ä»¶é¡ºåº**: æŒ‰ç…§æ‰§è¡Œé¡ºåºæ’åˆ—ä¸­é—´ä»¶ï¼Œä¾‹å¦‚ RequestID â†’ Logging â†’ Tracing â†’ Auth â†’ Handler
2. **é”™è¯¯å¤„ç†**: åœ¨ä¸­é—´ä»¶ä¸­æ­£ç¡®å¤„ç†é”™è¯¯ï¼Œé¿å…é”™è¯¯ä¼ æ’­åˆ° Handler
3. **ä¸Šä¸‹æ–‡ä¼ é€’**: ä½¿ç”¨ context ä¼ é€’ä¸­é—´ä»¶å¤„ç†çš„æ•°æ®ï¼ˆå¦‚ userIDã€requestIDï¼‰
4. **æ€§èƒ½ä¼˜åŒ–**: é¿å…åœ¨ä¸­é—´ä»¶ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œï¼Œå¦‚æ•°æ®åº“æŸ¥è¯¢

##### 2.1.4.2 è·¯ç”±åˆ†ç»„æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è·¯ç”±åˆ†ç»„ï¼Ÿ**

è·¯ç”±åˆ†ç»„å¯ä»¥æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ï¼Œå°†ç›¸å…³çš„è·¯ç”±ç»„ç»‡åœ¨ä¸€èµ·ï¼Œä¾¿äºç®¡ç†å’Œæµ‹è¯•ã€‚

**è·¯ç”±åˆ†ç»„è®¾è®¡åŸåˆ™**:

1. **æŒ‰åŠŸèƒ½åˆ†ç»„**: å°†ç›¸åŒåŠŸèƒ½çš„è·¯ç”±ç»„ç»‡åœ¨ä¸€èµ·
2. **æŒ‰æƒé™åˆ†ç»„**: å°†éœ€è¦ç›¸åŒæƒé™çš„è·¯ç”±ç»„ç»‡åœ¨ä¸€èµ·
3. **æŒ‰ç‰ˆæœ¬åˆ†ç»„**: å°†ä¸åŒç‰ˆæœ¬çš„ API åˆ†ç»„ç®¡ç†
4. **åµŒå¥—åˆ†ç»„**: æ”¯æŒå¤šçº§åµŒå¥—ï¼Œæé«˜çµæ´»æ€§

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// ç”¨æˆ·è·¯ç”±ç»„
func userRoutes() chi.Router {
    r := chi.NewRouter()
    handler := handlers.NewUserHandler(userService)

    // ç”¨æˆ·åˆ—è¡¨å’Œåˆ›å»ºï¼ˆéœ€è¦è®¤è¯ï¼‰
    r.Group(func(r chi.Router) {
        r.Use(AuthMiddleware)
        r.Get("/", handler.ListUsers)
        r.Post("/", handler.CreateUser)
    })

    // ç”¨æˆ·è¯¦æƒ…ã€æ›´æ–°ã€åˆ é™¤ï¼ˆéœ€è¦è®¤è¯å’Œæƒé™æ£€æŸ¥ï¼‰
    r.Group(func(r chi.Router) {
        r.Use(AuthMiddleware)
        r.Use(RequirePermission("user:write"))
        r.Get("/{id}", handler.GetUser)
        r.Put("/{id}", handler.UpdateUser)
        r.Delete("/{id}", handler.DeleteUser)
    })

    return r
}

// å·¥ä½œæµè·¯ç”±ç»„
func workflowRoutes() chi.Router {
    r := chi.NewRouter()
    handler := handlers.NewWorkflowHandler(workflowService)

    r.Use(AuthMiddleware)
    r.Use(RequirePermission("workflow:manage"))

    r.Post("/", handler.StartWorkflow)
    r.Get("/{id}", handler.GetWorkflow)
    r.Post("/{id}/signal", handler.SignalWorkflow)
    r.Get("/{id}/query", handler.QueryWorkflow)

    return r
}

// ç‰ˆæœ¬åŒ–è·¯ç”±
func apiRoutes() chi.Router {
    r := chi.NewRouter()

    // v1 API
    r.Route("/v1", func(r chi.Router) {
        r.Mount("/users", userRoutes())
        r.Mount("/workflows", workflowRoutes())
    })

    // v2 APIï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰
    r.Route("/v2", func(r chi.Router) {
        // v2 è·¯ç”±
    })

    return r
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **åŠŸèƒ½å†…èš**: å°†ç›¸å…³åŠŸèƒ½çš„è·¯ç”±ç»„ç»‡åœ¨ä¸€èµ·
2. **æƒé™æ§åˆ¶**: åœ¨è·¯ç”±ç»„çº§åˆ«åº”ç”¨æƒé™ä¸­é—´ä»¶
3. **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨è·¯ç”±åˆ†ç»„ç®¡ç† API ç‰ˆæœ¬
4. **ä»£ç å¤ç”¨**: æå–å…¬å…±è·¯ç”±é€»è¾‘ï¼Œé¿å…é‡å¤

##### 2.1.4.3 å‚æ•°éªŒè¯æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦å‚æ•°éªŒè¯ï¼Ÿ**

å‚æ•°éªŒè¯æ˜¯ä¿è¯ API å®‰å…¨æ€§å’Œå¯é æ€§çš„é‡è¦æ‰‹æ®µï¼Œå¯ä»¥é˜²æ­¢æ— æ•ˆæ•°æ®è¿›å…¥ä¸šåŠ¡é€»è¾‘å±‚ï¼Œå‡å°‘é”™è¯¯å¤„ç†æˆæœ¬ã€‚

**å‚æ•°éªŒè¯è®¾è®¡åŸåˆ™**:

1. **æ—©æœŸéªŒè¯**: åœ¨ Handler å±‚è¿›è¡Œå‚æ•°éªŒè¯ï¼Œé¿å…æ— æ•ˆæ•°æ®è¿›å…¥ä¸šåŠ¡å±‚
2. **ç»Ÿä¸€éªŒè¯**: ä½¿ç”¨ç»Ÿä¸€çš„éªŒè¯åº“å’ŒéªŒè¯è§„åˆ™
3. **æ¸…æ™°é”™è¯¯**: è¿”å›æ¸…æ™°çš„éªŒè¯é”™è¯¯ä¿¡æ¯
4. **ç±»å‹å®‰å…¨**: ä½¿ç”¨ç±»å‹å®‰å…¨çš„éªŒè¯æ–¹å¼

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// ä½¿ç”¨ validator åº“è¿›è¡Œå‚æ•°éªŒè¯
import "github.com/go-playground/validator/v10"

type CreateUserRequest struct {
    Email    string `json:"email" validate:"required,email"`
    Name     string `json:"name" validate:"required,min=2,max=50"`
    Password string `json:"password" validate:"required,min=8"`
}

func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    var req CreateUserRequest
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        Error(w, http.StatusBadRequest, errors.NewInvalidInputError("Invalid JSON"))
        return
    }

    // å‚æ•°éªŒè¯
    validate := validator.New()
    if err := validate.Struct(req); err != nil {
        var validationErrors []string
        for _, err := range err.(validator.ValidationErrors) {
            validationErrors = append(validationErrors, getValidationErrorMessage(err))
        }
        Error(w, http.StatusBadRequest, errors.NewValidationError(validationErrors))
        return
    }

    // è°ƒç”¨ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(r.Context(), req)
    if err != nil {
        Error(w, http.StatusInternalServerError, err)
        return
    }

    Success(w, http.StatusCreated, user)
}

// è·¯ç”±å‚æ•°éªŒè¯
func (h *UserHandler) GetUser(w http.ResponseWriter, r *http.Request) {
    userID := chi.URLParam(r, "id")

    // éªŒè¯ UUID æ ¼å¼
    if _, err := uuid.Parse(userID); err != nil {
        Error(w, http.StatusBadRequest, errors.NewInvalidInputError("Invalid user ID format"))
        return
    }

    user, err := h.service.GetUser(r.Context(), userID)
    if err != nil {
        if errors.Is(err, errors.ErrNotFound) {
            Error(w, http.StatusNotFound, err)
        } else {
            Error(w, http.StatusInternalServerError, err)
        }
        return
    }

    Success(w, http.StatusOK, user)
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ä½¿ç”¨éªŒè¯åº“**: ä½¿ç”¨æˆç†Ÿçš„éªŒè¯åº“ï¼ˆå¦‚ validatorï¼‰ï¼Œé¿å…æ‰‹å†™éªŒè¯é€»è¾‘
2. **éªŒè¯è§„åˆ™**: åœ¨ç»“æ„ä½“æ ‡ç­¾ä¸­å®šä¹‰éªŒè¯è§„åˆ™ï¼Œæ¸…æ™°ç›´è§‚
3. **é”™è¯¯ä¿¡æ¯**: è¿”å›æ¸…æ™°çš„éªŒè¯é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©å®¢æˆ·ç«¯ç†è§£é—®é¢˜
4. **ç±»å‹è½¬æ¢**: åœ¨éªŒè¯åè¿›è¡Œç±»å‹è½¬æ¢ï¼Œç¡®ä¿ç±»å‹å®‰å…¨

##### 2.1.4.4 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼Ÿ**

ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å¯ä»¥æé«˜ API çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œä¾¿äºå®¢æˆ·ç«¯å¤„ç†å’Œé”™è¯¯ç›‘æ§ã€‚

**é”™è¯¯å¤„ç†è®¾è®¡åŸåˆ™**:

1. **ç»Ÿä¸€æ ¼å¼**: æ‰€æœ‰é”™è¯¯ä½¿ç”¨ç»Ÿä¸€çš„å“åº”æ ¼å¼
2. **é”™è¯¯åˆ†ç±»**: åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯ï¼ˆä¸šåŠ¡é”™è¯¯ã€ç³»ç»Ÿé”™è¯¯ã€éªŒè¯é”™è¯¯ï¼‰
3. **é”™è¯¯ç **: ä½¿ç”¨é”™è¯¯ç æ ‡è¯†é”™è¯¯ç±»å‹
4. **é”™è¯¯æ—¥å¿—**: è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
type ErrorResponse struct {
    Code    string `json:"code"`
    Message string `json:"message"`
    Details interface{} `json:"details,omitempty"`
}

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
func ErrorHandlingMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        defer func() {
            if err := recover(); err != nil {
                logger.Error("Panic recovered",
                    "error", err,
                    "path", r.URL.Path,
                    "method", r.Method,
                )
                Error(w, http.StatusInternalServerError, errors.NewInternalError("Internal server error"))
            }
        }()

        next.ServeHTTP(w, r)
    })
}

// Handler ä¸­çš„é”™è¯¯å¤„ç†
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    var req CreateUserRequest
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        Error(w, http.StatusBadRequest, errors.NewInvalidInputError("Invalid request body"))
        return
    }

    user, err := h.service.CreateUser(r.Context(), req)
    if err != nil {
        // æ ¹æ®é”™è¯¯ç±»å‹è¿”å›ä¸åŒçš„çŠ¶æ€ç 
        switch {
        case errors.Is(err, errors.ErrValidation):
            Error(w, http.StatusBadRequest, err)
        case errors.Is(err, errors.ErrConflict):
            Error(w, http.StatusConflict, err)
        case errors.Is(err, errors.ErrNotFound):
            Error(w, http.StatusNotFound, err)
        default:
            logger.Error("Unexpected error",
                "error", err,
                "path", r.URL.Path,
            )
            Error(w, http.StatusInternalServerError, errors.NewInternalError("Internal server error"))
        }
        return
    }

    Success(w, http.StatusCreated, user)
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **é”™è¯¯åˆ†ç±»**: åŒºåˆ†ä¸šåŠ¡é”™è¯¯å’Œç³»ç»Ÿé”™è¯¯ï¼Œè¿”å›ä¸åŒçš„ HTTP çŠ¶æ€ç 
2. **é”™è¯¯ç **: ä½¿ç”¨é”™è¯¯ç æ ‡è¯†é”™è¯¯ç±»å‹ï¼Œä¾¿äºå®¢æˆ·ç«¯å¤„ç†
3. **é”™è¯¯æ—¥å¿—**: è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼ŒåŒ…æ‹¬è¯·æ±‚ä¿¡æ¯ã€é”™è¯¯å †æ ˆç­‰
4. **é”™è¯¯æ¢å¤**: ä½¿ç”¨ recover æ•è· panicï¼Œé¿å…æœåŠ¡å´©æºƒ

##### 2.1.4.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**:

1. **è¿æ¥æ± **: ä½¿ç”¨ HTTP è¿æ¥æ± ï¼Œå¤ç”¨è¿æ¥
2. **å“åº”å‹ç¼©**: å¯ç”¨å“åº”å‹ç¼©ï¼Œå‡å°‘ä¼ è¾“æ•°æ®é‡
3. **ç¼“å­˜**: å¯¹é™æ€èµ„æºå’Œé¢‘ç¹è®¿é—®çš„æ•°æ®è¿›è¡Œç¼“å­˜
4. **å¼‚æ­¥å¤„ç†**: å¯¹è€—æ—¶æ“ä½œä½¿ç”¨å¼‚æ­¥å¤„ç†

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// å¯ç”¨å“åº”å‹ç¼©
import "github.com/go-chi/chi/v5/middleware"

func NewRouter() *chi.Mux {
    r := chi.NewRouter()

    // å‹ç¼©ä¸­é—´ä»¶
    r.Use(middleware.Compress(5))

    // å…¶ä»–ä¸­é—´ä»¶å’Œè·¯ç”±
    return r
}

// é™æ€èµ„æºç¼“å­˜
func staticFileHandler() http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // è®¾ç½®ç¼“å­˜å¤´
        w.Header().Set("Cache-Control", "public, max-age=3600")
        http.ServeFile(w, r, r.URL.Path)
    })
}

// å¼‚æ­¥å¤„ç†
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    // å¿«é€Ÿè¿”å›
    Success(w, http.StatusAccepted, map[string]string{
        "message": "User creation in progress",
    })

    // å¼‚æ­¥å¤„ç†
    go func() {
        // æ‰§è¡Œè€—æ—¶æ“ä½œ
        h.service.CreateUserAsync(r.Context(), req)
    }()
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **è¿æ¥å¤ç”¨**: ä½¿ç”¨ HTTP è¿æ¥æ± ï¼Œå‡å°‘è¿æ¥å»ºç«‹å¼€é”€
2. **å“åº”å‹ç¼©**: å¯ç”¨ gzip å‹ç¼©ï¼Œå‡å°‘ä¼ è¾“æ•°æ®é‡
3. **ç¼“å­˜ç­–ç•¥**: åˆç†ä½¿ç”¨ç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—å’Œæ•°æ®åº“æŸ¥è¯¢
4. **å¼‚æ­¥å¤„ç†**: å¯¹è€—æ—¶æ“ä½œä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼Œæé«˜å“åº”é€Ÿåº¦

---

## 3. ğŸ—„ï¸ æ•°æ®è®¿é—®å±‚

### 3.1 Ent ORM

#### 3.1.1 æ ¸å¿ƒç‰¹æ€§

**Ent æ˜¯ä»€ä¹ˆï¼Ÿ**

Ent æ˜¯ Facebook å¼€æºçš„ Go è¯­è¨€å®ä½“æ¡†æ¶ï¼ˆORMï¼‰ï¼Œé€šè¿‡ä»£ç ç”Ÿæˆæä¾›ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
- âœ… **ä»£ç ç”Ÿæˆ**: ä» Schema å®šä¹‰ç”Ÿæˆç±»å‹å®‰å…¨çš„ä»£ç 
- âœ… **Schema å³ä»£ç **: Schema å®šä¹‰åœ¨ä»£ç ä¸­ï¼Œç‰ˆæœ¬å¯æ§
- âœ… **è¿ç§»æ”¯æŒ**: è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… **æŸ¥è¯¢æ„å»º**: é“¾å¼ APIï¼Œç±»å‹å®‰å…¨çš„æŸ¥è¯¢æ„å»º

#### 3.1.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Entï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Ent | GORM | SQLBoiler | è¯´æ˜ |
|---------|------|-----|------|-----------|------|
| **ç±»å‹å®‰å…¨** | 30% | 10 | 5 | 9 | Ent ç¼–è¯‘æ—¶æ£€æŸ¥ |
| **å¼€å‘ä½“éªŒ** | 25% | 9 | 10 | 7 | Ent Schema å®šä¹‰æ¸…æ™° |
| **æ€§èƒ½** | 20% | 9 | 7 | 10 | Ent æ€§èƒ½ä¼˜ç§€ |
| **å­¦ä¹ æ›²çº¿** | 15% | 7 | 9 | 6 | Ent æ¦‚å¿µè¾ƒæ–° |
| **ç¤¾åŒºæ”¯æŒ** | 10% | 8 | 10 | 7 | Ent ç¤¾åŒºæ´»è·ƒ |
| **åŠ æƒæ€»åˆ†** | - | **8.80** | 7.90 | 8.15 | Ent å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **ç±»å‹å®‰å…¨ï¼ˆæƒé‡ 30%ï¼‰**:
   - ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
   - ä»£ç ç”Ÿæˆç¡®ä¿ç±»å‹ä¸€è‡´æ€§
   - IDE æ”¯æŒå¥½ï¼Œè‡ªåŠ¨è¡¥å…¨å®Œå–„

2. **å¼€å‘ä½“éªŒï¼ˆæƒé‡ 25%ï¼‰**:
   - Schema å®šä¹‰æ¸…æ™°ï¼Œæ˜“äºç†è§£
   - ä»£ç ç”Ÿæˆè‡ªåŠ¨åŒ–ï¼Œå‡å°‘æ‰‹å†™ä»£ç 
   - è¿ç§»è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ

#### 3.1.3 å®é™…åº”ç”¨

##### 3.1.3.1 Schema å®šä¹‰

**åŸºç¡€ Schema å®šä¹‰**:

```go
// internal/infrastructure/database/ent/schema/user.go
package schema

import (
    "entgo.io/ent"
    "entgo.io/ent/schema/field"
    "entgo.io/ent/schema/index"
    "entgo.io/ent/schema/edge"
    "time"
)

type User struct {
    ent.Schema
}

func (User) Fields() []ent.Field {
    return []ent.Field{
        field.String("id").Unique().Immutable(),
        field.String("email").Unique().NotEmpty(),
        field.String("name").NotEmpty().MaxLen(100),
        field.String("password_hash").Sensitive(),
        field.Enum("status").Values("active", "inactive", "suspended").Default("active"),
        field.Time("created_at").Default(time.Now).Immutable(),
        field.Time("updated_at").Default(time.Now).UpdateDefault(time.Now),
    }
}

func (User) Indexes() []ent.Index {
    return []ent.Index{
        index.Fields("email"),
        index.Fields("status"),
        index.Fields("created_at"),
    }
}

func (User) Edges() []ent.Edge {
    return []ent.Edge{
        edge.To("orders", Order.Type),
        edge.To("profile", UserProfile.Type).Unique(),
    }
}
```

**å…³è”å…³ç³»å®šä¹‰**:

```go
// Order Schema
type Order struct {
    ent.Schema
}

func (Order) Fields() []ent.Field {
    return []ent.Field{
        field.String("id").Unique(),
        field.String("user_id"),
        field.Enum("status").Values("pending", "processing", "completed", "cancelled"),
        field.Float("total_amount"),
        field.Time("created_at").Default(time.Now),
    }
}

func (Order) Edges() []ent.Edge {
    return []ent.Edge{
        edge.From("user", User.Type).
            Ref("orders").
            Field("user_id").
            Unique().
            Required(),
        edge.To("items", OrderItem.Type),
    }
}
```

##### 3.1.3.2 å¤æ‚æŸ¥è¯¢ç¤ºä¾‹

**å…³è”æŸ¥è¯¢**:

```go
// æŸ¥è¯¢ç”¨æˆ·åŠå…¶è®¢å•
user, err := client.User.
    Query().
    Where(user.ID(userID)).
    WithOrders(func(q *ent.OrderQuery) {
        q.Where(order.StatusEQ("completed"))
        q.Order(ent.Desc(order.FieldCreatedAt))
        q.Limit(10)
    }).
    WithProfile().
    Only(ctx)

// æŸ¥è¯¢è®¢å•åŠå…¶ç”¨æˆ·å’Œè®¢å•é¡¹
order, err := client.Order.
    Query().
    Where(order.ID(orderID)).
    WithUser().
    WithItems(func(q *ent.OrderItemQuery) {
        q.WithProduct()
    }).
    Only(ctx)
```

**æ¡ä»¶æŸ¥è¯¢**:

```go
// å¤æ‚æ¡ä»¶æŸ¥è¯¢
users, err := client.User.
    Query().
    Where(
        user.And(
            user.StatusEQ("active"),
            user.CreatedAtGTE(time.Now().AddDate(0, -1, 0)),
            user.Or(
                user.EmailContains("@example.com"),
                user.NameHasPrefix("John"),
            ),
        ),
    ).
    Order(ent.Desc(user.FieldCreatedAt)).
    Limit(20).
    Offset(0).
    All(ctx)
```

**èšåˆæŸ¥è¯¢**:

```go
// èšåˆæŸ¥è¯¢
count, err := client.User.
    Query().
    Where(user.StatusEQ("active")).
    Count(ctx)

// åˆ†ç»„èšåˆ
var results []struct {
    Status string
    Count  int
}
err := client.User.
    Query().
    GroupBy(user.FieldStatus).
    Aggregate(ent.Count()).
    Scan(ctx, &results)
```

##### 3.1.3.3 äº‹åŠ¡å¤„ç†

**åŸºç¡€äº‹åŠ¡**:

```go
// ä½¿ç”¨äº‹åŠ¡
err := client.WithTx(ctx, func(tx *ent.Tx) error {
    // åˆ›å»ºç”¨æˆ·
    user, err := tx.User.
        Create().
        SetEmail("user@example.com").
        SetName("User Name").
        Save(ctx)
    if err != nil {
        return err
    }

    // åˆ›å»ºç”¨æˆ·é…ç½®
    _, err = tx.UserProfile.
        Create().
        SetUserID(user.ID).
        SetBio("User bio").
        Save(ctx)
    if err != nil {
        return err // è‡ªåŠ¨å›æ»š
    }

    return nil // è‡ªåŠ¨æäº¤
})
```

**åµŒå¥—äº‹åŠ¡ï¼ˆä¿å­˜ç‚¹ï¼‰**:

```go
// ä½¿ç”¨ä¿å­˜ç‚¹å®ç°åµŒå¥—äº‹åŠ¡
err := client.WithTx(ctx, func(tx *ent.Tx) error {
    user, err := tx.User.Create().SetEmail("user@example.com").Save(ctx)
    if err != nil {
        return err
    }

    // åµŒå¥—äº‹åŠ¡ï¼ˆä¿å­˜ç‚¹ï¼‰
    return tx.WithTx(ctx, func(tx2 *ent.Tx) error {
        _, err := tx2.Order.Create().SetUserID(user.ID).Save(ctx)
        if err != nil {
            return err // å›æ»šåˆ°ä¿å­˜ç‚¹
        }
        return nil
    })
})
```

##### 3.1.3.4 æ‰¹é‡æ“ä½œ

**æ‰¹é‡åˆ›å»º**:

```go
// æ‰¹é‡åˆ›å»ºç”¨æˆ·
users := []*ent.UserCreate{
    client.User.Create().SetEmail("user1@example.com").SetName("User 1"),
    client.User.Create().SetEmail("user2@example.com").SetName("User 2"),
    client.User.Create().SetEmail("user3@example.com").SetName("User 3"),
}

createdUsers, err := client.User.CreateBulk(users...).Save(ctx)
```

**æ‰¹é‡æ›´æ–°**:

```go
// æ‰¹é‡æ›´æ–°ç”¨æˆ·çŠ¶æ€
affected, err := client.User.
    Update().
    Where(user.StatusEQ("inactive")).
    SetStatus("active").
    SetUpdatedAt(time.Now()).
    Save(ctx)
```

**æ‰¹é‡åˆ é™¤**:

```go
// æ‰¹é‡åˆ é™¤è¿‡æœŸç”¨æˆ·
deleted, err := client.User.
    Delete().
    Where(
        user.And(
            user.StatusEQ("inactive"),
            user.UpdatedAtLT(time.Now().AddDate(-1, 0, 0)),
        ),
    ).
    Exec(ctx)
```

##### 3.1.3.5 è¿ç§»ç®¡ç†

**ç”Ÿæˆè¿ç§»**:

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
go run -mod=mod entgo.io/ent/cmd/ent migrate generate ./internal/infrastructure/database/ent/schema

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
go run -mod=mod entgo.io/ent/cmd/ent migrate status

# åº”ç”¨è¿ç§»
go run -mod=mod entgo.io/ent/cmd/ent migrate apply
```

**è¿ç§»é…ç½®**:

```go
// åœ¨ä»£ç ä¸­è¿è¡Œè¿ç§»
if err := client.Schema.Create(ctx); err != nil {
    log.Fatalf("Failed creating schema resources: %v", err)
}

// æˆ–è€…ä½¿ç”¨è¿ç§»å·¥å…·
if err := migrate.NewMigrator(client).Up(ctx); err != nil {
    log.Fatalf("Failed running migrations: %v", err)
}
```

##### 3.1.3.6 æ€§èƒ½ä¼˜åŒ–æŠ€å·§

**é¢„åŠ è½½å…³è”æ•°æ®**:

```go
// ä½¿ç”¨ With é¢„åŠ è½½ï¼Œé¿å… N+1 æŸ¥è¯¢
users, err := client.User.
    Query().
    WithOrders(func(q *ent.OrderQuery) {
        q.WithItems()
    }).
    All(ctx)
```

**ä½¿ç”¨ Select é€‰æ‹©å­—æ®µ**:

```go
// åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
var users []struct {
    ID    string
    Email string
    Name  string
}
err := client.User.
    Query().
    Select(user.FieldID, user.FieldEmail, user.FieldName).
    Scan(ctx, &users)
```

**ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢**:

```go
// ç¡®ä¿æŸ¥è¯¢å­—æ®µæœ‰ç´¢å¼•
users, err := client.User.
    Query().
    Where(user.EmailEQ("user@example.com")). // email å­—æ®µæœ‰ç´¢å¼•
    Only(ctx)
```

#### 3.1.4 æœ€ä½³å®è·µ

##### 3.1.4.1 Schema è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„ Schema è®¾è®¡ï¼Ÿ**

Schema è®¾è®¡æ˜¯æ•°æ®æ¨¡å‹çš„åŸºç¡€ï¼Œè‰¯å¥½çš„ Schema è®¾è®¡å¯ä»¥æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€æŸ¥è¯¢æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ã€‚

**Schema è®¾è®¡åŸåˆ™**:

1. **å­—æ®µç±»å‹é€‰æ‹©**: ä½¿ç”¨åˆé€‚çš„å­—æ®µç±»å‹ï¼Œé¿å…è¿‡åº¦ä½¿ç”¨ String
2. **çº¦æŸå®šä¹‰**: ä½¿ç”¨å­—æ®µçº¦æŸï¼ˆUniqueã€Requiredã€Defaultï¼‰ä¿è¯æ•°æ®å®Œæ•´æ€§
3. **ç´¢å¼•è®¾è®¡**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
4. **å…³è”å…³ç³»**: æ˜ç¡®å®šä¹‰å®ä½“ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œä½¿ç”¨ Edge è¡¨è¾¾

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// è‰¯å¥½çš„ Schema è®¾è®¡
type User struct {
    ent.Schema
}

func (User) Fields() []ent.Field {
    return []ent.Field{
        // ä½¿ç”¨ UUID ä½œä¸ºä¸»é”®
        field.String("id").
            DefaultFunc(func() string {
                return uuid.New().String()
            }).
            Unique().
            Immutable(),

        // é‚®ç®±å­—æ®µï¼šå”¯ä¸€ã€éç©ºã€éªŒè¯æ ¼å¼
        field.String("email").
            Unique().
            NotEmpty().
            Match(regexp.MustCompile(`^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$`)),

        // çŠ¶æ€å­—æ®µï¼šä½¿ç”¨æšä¸¾ï¼Œè®¾ç½®é»˜è®¤å€¼
        field.Enum("status").
            Values("active", "inactive", "suspended").
            Default("active"),

        // æ—¶é—´å­—æ®µï¼šè‡ªåŠ¨è®¾ç½®é»˜è®¤å€¼å’Œæ›´æ–°å€¼
        field.Time("created_at").
            Default(time.Now).
            Immutable(),
        field.Time("updated_at").
            Default(time.Now).
            UpdateDefault(time.Now),
    }
}

func (User) Indexes() []ent.Index {
    return []ent.Index{
        // å•å­—æ®µç´¢å¼•
        index.Fields("email"),
        index.Fields("status"),

        // å¤åˆç´¢å¼•
        index.Fields("status", "created_at"),
    }
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ä½¿ç”¨åˆé€‚çš„å­—æ®µç±»å‹**: é¿å…æ‰€æœ‰å­—æ®µéƒ½ä½¿ç”¨ Stringï¼Œä½¿ç”¨ Enumã€Intã€Time ç­‰ç±»å‹
2. **è®¾ç½®å­—æ®µçº¦æŸ**: ä½¿ç”¨ Uniqueã€Requiredã€Default ç­‰çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
3. **è®¾è®¡ç´¢å¼•**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•ï¼Œä½†ä¸è¦è¿‡åº¦ç´¢å¼•
4. **ä½¿ç”¨ Edge è¡¨è¾¾å…³è”**: ä½¿ç”¨ Edge æ˜ç¡®å®šä¹‰å®ä½“ä¹‹é—´çš„å…³è”å…³ç³»

##### 3.1.4.2 æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦æŸ¥è¯¢ä¼˜åŒ–ï¼Ÿ**

æŸ¥è¯¢ä¼˜åŒ–å¯ä»¥æé«˜åº”ç”¨æ€§èƒ½ï¼Œå‡å°‘æ•°æ®åº“è´Ÿè½½ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

**æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**:

1. **ä½¿ç”¨é¢„åŠ è½½**: ä½¿ç”¨ With é¢„åŠ è½½å…³è”æ•°æ®ï¼Œé¿å… N+1 æŸ¥è¯¢
2. **é€‰æ‹©å­—æ®µ**: ä½¿ç”¨ Select åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
3. **ä½¿ç”¨ç´¢å¼•**: ç¡®ä¿æŸ¥è¯¢å­—æ®µæœ‰ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦
4. **åˆ†é¡µæŸ¥è¯¢**: ä½¿ç”¨ Limit å’Œ Offset å®ç°åˆ†é¡µï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// ä¼˜åŒ–å‰ï¼šN+1 æŸ¥è¯¢é—®é¢˜
users, _ := client.User.Query().All(ctx)
for _, user := range users {
    orders, _ := client.Order.Query().Where(order.UserIDEQ(user.ID)).All(ctx)
    // å¤„ç†è®¢å•
}

// ä¼˜åŒ–åï¼šä½¿ç”¨é¢„åŠ è½½
users, _ := client.User.
    Query().
    WithOrders(func(q *ent.OrderQuery) {
        q.WithItems() // é¢„åŠ è½½è®¢å•é¡¹
    }).
    All(ctx)

// åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
var users []struct {
    ID    string
    Email string
}
err := client.User.
    Query().
    Select(user.FieldID, user.FieldEmail).
    Scan(ctx, &users)

// åˆ†é¡µæŸ¥è¯¢
users, err := client.User.
    Query().
    Order(ent.Desc(user.FieldCreatedAt)).
    Limit(pageSize).
    Offset((page - 1) * pageSize).
    All(ctx)
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **é¿å… N+1 æŸ¥è¯¢**: ä½¿ç”¨ With é¢„åŠ è½½å…³è”æ•°æ®
2. **é€‰æ‹©å¿…è¦å­—æ®µ**: ä½¿ç”¨ Select åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
3. **ä½¿ç”¨ç´¢å¼•**: ç¡®ä¿æŸ¥è¯¢å­—æ®µæœ‰ç´¢å¼•
4. **åˆ†é¡µæŸ¥è¯¢**: ä½¿ç”¨ Limit å’Œ Offset å®ç°åˆ†é¡µ

##### 3.1.4.3 äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ç®¡ç†ï¼Ÿ**

äº‹åŠ¡ç®¡ç†å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œç¡®ä¿å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

**äº‹åŠ¡ç®¡ç†åŸåˆ™**:

1. **äº‹åŠ¡è¾¹ç•Œ**: æ˜ç¡®äº‹åŠ¡è¾¹ç•Œï¼Œé¿å…é•¿æ—¶é—´æŒæœ‰äº‹åŠ¡
2. **é”™è¯¯å¤„ç†**: æ­£ç¡®å¤„ç†äº‹åŠ¡ä¸­çš„é”™è¯¯ï¼Œç¡®ä¿å›æ»š
3. **åµŒå¥—äº‹åŠ¡**: ä½¿ç”¨ä¿å­˜ç‚¹å®ç°åµŒå¥—äº‹åŠ¡
4. **éš”ç¦»çº§åˆ«**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ
func CreateUserWithProfile(ctx context.Context, client *ent.Client, email, name string) error {
    return client.WithTx(ctx, func(tx *ent.Tx) error {
        // åˆ›å»ºç”¨æˆ·
        user, err := tx.User.
            Create().
            SetEmail(email).
            SetName(name).
            Save(ctx)
        if err != nil {
            return fmt.Errorf("failed to create user: %w", err)
        }

        // åˆ›å»ºç”¨æˆ·é…ç½®
        _, err = tx.UserProfile.
            Create().
            SetUserID(user.ID).
            SetBio("").
            Save(ctx)
        if err != nil {
            return fmt.Errorf("failed to create profile: %w", err)
        }

        return nil // è‡ªåŠ¨æäº¤
    })
}

// é”™è¯¯å¤„ç†å’Œå›æ»š
func TransferMoney(ctx context.Context, client *ent.Client, fromID, toID string, amount float64) error {
    return client.WithTx(ctx, func(tx *ent.Tx) error {
        // æ‰£æ¬¾
        fromAccount, err := tx.Account.Query().Where(account.IDEQ(fromID)).Only(ctx)
        if err != nil {
            return err
        }

        if fromAccount.Balance < amount {
            return errors.New("insufficient balance")
        }

        _, err = tx.Account.UpdateOneID(fromID).AddBalance(-amount).Save(ctx)
        if err != nil {
            return err
        }

        // åŠ æ¬¾
        _, err = tx.Account.UpdateOneID(toID).AddBalance(amount).Save(ctx)
        if err != nil {
            return err // è‡ªåŠ¨å›æ»š
        }

        return nil
    })
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **æ˜ç¡®äº‹åŠ¡è¾¹ç•Œ**: å°†ç›¸å…³æ“ä½œæ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
2. **é”™è¯¯å¤„ç†**: æ­£ç¡®å¤„ç†é”™è¯¯ï¼Œç¡®ä¿äº‹åŠ¡å›æ»š
3. **é¿å…é•¿æ—¶é—´äº‹åŠ¡**: ä¸è¦åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
4. **ä½¿ç”¨ä¿å­˜ç‚¹**: ä½¿ç”¨ä¿å­˜ç‚¹å®ç°åµŒå¥—äº‹åŠ¡

##### 3.1.4.4 è¿ç§»ç®¡ç†æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è¿ç§»ç®¡ç†ï¼Ÿ**

è¿ç§»ç®¡ç†å¯ä»¥ç‰ˆæœ¬åŒ–æ•°æ®åº“ç»“æ„å˜æ›´ï¼Œç¡®ä¿å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„ä¸€è‡´æ€§ã€‚

**è¿ç§»ç®¡ç†åŸåˆ™**:

1. **ç‰ˆæœ¬æ§åˆ¶**: æ‰€æœ‰è¿ç§»æ–‡ä»¶çº³å…¥ç‰ˆæœ¬æ§åˆ¶
2. **å¯å›æ»š**: è¿ç§»åº”è¯¥æ˜¯å¯å›æ»šçš„
3. **æµ‹è¯•éªŒè¯**: åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»
4. **å¤‡ä»½æ•°æ®**: åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»å‰å¤‡ä»½æ•°æ®

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// è¿ç§»ç®¡ç†æœ€ä½³å®è·µ
func RunMigrations(ctx context.Context, client *ent.Client) error {
    // æ£€æŸ¥è¿ç§»çŠ¶æ€
    if err := client.Schema.WriteTo(ctx, os.Stdout); err != nil {
        return fmt.Errorf("failed to write schema: %w", err)
    }

    // åº”ç”¨è¿ç§»
    if err := client.Schema.Create(ctx); err != nil {
        return fmt.Errorf("failed creating schema resources: %w", err)
    }

    return nil
}

// è¿ç§»è„šæœ¬
//go:generate go run -mod=mod entgo.io/ent/cmd/ent generate ./schema
//go:generate go run -mod=mod entgo.io/ent/cmd/ent migrate generate ./schema
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ç‰ˆæœ¬æ§åˆ¶**: æ‰€æœ‰è¿ç§»æ–‡ä»¶çº³å…¥ç‰ˆæœ¬æ§åˆ¶
2. **å¯å›æ»š**: è®¾è®¡å¯å›æ»šçš„è¿ç§»
3. **æµ‹è¯•éªŒè¯**: åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»
4. **å¤‡ä»½æ•°æ®**: ç”Ÿäº§ç¯å¢ƒè¿ç§»å‰å¤‡ä»½æ•°æ®

##### 3.1.4.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**:

1. **ä½¿ç”¨é¢„åŠ è½½**: é¿å… N+1 æŸ¥è¯¢
2. **é€‰æ‹©å­—æ®µ**: åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
3. **ä½¿ç”¨ç´¢å¼•**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
4. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“å¾€è¿”

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æ‰¹é‡æ“ä½œä¼˜åŒ–
func CreateUsersBatch(ctx context.Context, client *ent.Client, users []UserData) error {
    builders := make([]*ent.UserCreate, len(users))
    for i, u := range users {
        builders[i] = client.User.Create().
            SetEmail(u.Email).
            SetName(u.Name)
    }

    _, err := client.User.CreateBulk(builders...).Save(ctx)
    return err
}

// ä½¿ç”¨è¿æ¥æ± 
func NewClient(dsn string) (*ent.Client, error) {
    db, err := sql.Open("postgres", dsn)
    if err != nil {
        return nil, err
    }

    // é…ç½®è¿æ¥æ± 
    db.SetMaxOpenConns(25)
    db.SetMaxIdleConns(5)
    db.SetConnMaxLifetime(time.Hour)

    return ent.NewClient(ent.Driver(driver.NewDriver(db))), nil
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“å¾€è¿”
2. **è¿æ¥æ± é…ç½®**: åˆç†é…ç½®è¿æ¥æ± å‚æ•°
3. **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨é¢„åŠ è½½ã€é€‰æ‹©å­—æ®µã€ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
4. **ç›‘æ§æ€§èƒ½**: ç›‘æ§æŸ¥è¯¢æ€§èƒ½ï¼Œè¯†åˆ«æ…¢æŸ¥è¯¢

---

### 3.2 PostgreSQL (pgx)

#### 3.2.1 æ ¸å¿ƒç‰¹æ€§

**pgx æ˜¯ä»€ä¹ˆï¼Ÿ**

pgx æ˜¯ Go è¯­è¨€çš„ PostgreSQL é©±åŠ¨ï¼Œæä¾›é«˜æ€§èƒ½çš„æ•°æ®åº“è®¿é—®ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **é«˜æ€§èƒ½**: åŸç”Ÿåè®®ï¼Œæ€§èƒ½ä¼˜ç§€
- âœ… **è¿æ¥æ± **: å†…ç½®è¿æ¥æ± æ”¯æŒ
- âœ… **äº‹åŠ¡æ”¯æŒ**: å®Œæ•´çš„äº‹åŠ¡æ”¯æŒ
- âœ… **ç±»å‹æ”¯æŒ**: æ”¯æŒ PostgreSQL æ‰€æœ‰æ•°æ®ç±»å‹
- âœ… **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ’å…¥å’Œæ›´æ–°

#### 3.2.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© pgxï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | pgx | lib/pq | GORM | database/sql | è¯´æ˜ |
|---------|------|-----|--------|------|--------------|------|
| **æ€§èƒ½** | 30% | 10 | 7 | 6 | 7 | pgx åŸç”Ÿåè®®ï¼Œæ€§èƒ½æœ€ä¼˜ |
| **åŠŸèƒ½å®Œæ•´æ€§** | 25% | 10 | 8 | 9 | 6 | pgx æ”¯æŒ PostgreSQL æ‰€æœ‰ç‰¹æ€§ |
| **ç±»å‹å®‰å…¨** | 20% | 9 | 7 | 8 | 6 | pgx ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥ |
| **æ˜“ç”¨æ€§** | 15% | 8 | 8 | 10 | 7 | pgx API ç®€æ´æ˜“ç”¨ |
| **ç¤¾åŒºæ”¯æŒ** | 10% | 9 | 8 | 10 | 10 | pgx ç¤¾åŒºæ´»è·ƒ |
| **åŠ æƒæ€»åˆ†** | - | **9.30** | 7.60 | 8.20 | 6.90 | pgx å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **æ€§èƒ½ï¼ˆæƒé‡ 30%ï¼‰**:
   - ä½¿ç”¨ PostgreSQL åŸç”Ÿåè®®ï¼Œæ€§èƒ½æœ€ä¼˜
   - é›¶æ‹·è´ï¼Œå‡å°‘å†…å­˜åˆ†é…
   - æ”¯æŒæ‰¹é‡æ“ä½œï¼Œæé«˜æ•ˆç‡

2. **åŠŸèƒ½å®Œæ•´æ€§ï¼ˆæƒé‡ 25%ï¼‰**:
   - æ”¯æŒ PostgreSQL æ‰€æœ‰ç‰¹æ€§ï¼ˆJSON, æ•°ç»„, è‡ªå®šä¹‰ç±»å‹ç­‰ï¼‰
   - æ”¯æŒ COPY åè®®ï¼Œé€‚åˆå¤§æ•°æ®å¯¼å…¥
   - æ”¯æŒé€šçŸ¥å’Œç›‘å¬åŠŸèƒ½

3. **ç±»å‹å®‰å…¨ï¼ˆæƒé‡ 20%ï¼‰**:
   - ç±»å‹å®‰å…¨çš„ APIï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
   - æ”¯æŒ PostgreSQL åŸç”Ÿç±»å‹
   - å‡å°‘è¿è¡Œæ—¶é”™è¯¯

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–é©±åŠ¨ï¼Ÿ**

1. **lib/pq**:
   - âœ… æˆç†Ÿç¨³å®šï¼Œä½¿ç”¨å¹¿æ³›
   - âŒ æ€§èƒ½ä¸å¦‚ pgx
   - âŒ åŠŸèƒ½ä¸å¦‚ pgx å®Œæ•´
   - âŒ ç»´æŠ¤çŠ¶æ€ä¸ç¡®å®š

2. **GORM**:
   - âœ… ORM åŠŸèƒ½ä¸°å¯Œï¼Œæ˜“ç”¨æ€§å¥½
   - âŒ æ€§èƒ½ä¸å¦‚ pgx
   - âŒ æŠ½è±¡å±‚å¢åŠ å¤æ‚åº¦
   - âŒ ä¸é€‚åˆé«˜æ€§èƒ½åœºæ™¯

3. **database/sql**:
   - âœ… æ ‡å‡†åº“ï¼Œé€šç”¨æ€§å¥½
   - âŒ æ€§èƒ½ä¸å¦‚ pgx
   - âŒ åŠŸèƒ½ä¸å¦‚ pgx å®Œæ•´
   - âŒ ä¸æ”¯æŒ PostgreSQL ç‰¹æœ‰ç‰¹æ€§

#### 3.2.3 å®é™…åº”ç”¨

##### 3.2.3.1 è¿æ¥æ± é…ç½®

**å®Œæ•´è¿æ¥æ± é…ç½®**:

```go
// é…ç½®è¿æ¥æ± 
config, err := pgxpool.ParseConfig("postgres://user:password@localhost/dbname")
if err != nil {
    return nil, err
}

// è¿æ¥æ± é…ç½®
config.MaxConns = 25                    // æœ€å¤§è¿æ¥æ•°
config.MinConns = 5                     // æœ€å°è¿æ¥æ•°
config.MaxConnLifetime = time.Hour      // è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
config.MaxConnIdleTime = time.Minute * 30 // è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´
config.HealthCheckPeriod = time.Minute  // å¥åº·æ£€æŸ¥å‘¨æœŸ

// è¿æ¥è¶…æ—¶é…ç½®
config.ConnConfig.ConnectTimeout = 5 * time.Second
config.ConnConfig.CommandTimeout = 30 * time.Second

// åˆ›å»ºè¿æ¥æ± 
pool, err := pgxpool.NewWithConfig(ctx, config)
if err != nil {
    return nil, err
}

// éªŒè¯è¿æ¥
if err := pool.Ping(ctx); err != nil {
    return nil, err
}

return pool, nil
```

##### 3.2.3.2 æŸ¥è¯¢æ‰§è¡Œ

**ç®€å•æŸ¥è¯¢**:

```go
// ç®€å•æŸ¥è¯¢
var user User
err := pool.QueryRow(ctx, "SELECT id, email, name FROM users WHERE id = $1", userID).
    Scan(&user.ID, &user.Email, &user.Name)
if err != nil {
    return nil, err
}
```

**å‚æ•°åŒ–æŸ¥è¯¢**:

```go
// å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆé˜²æ­¢ SQL æ³¨å…¥ï¼‰
rows, err := pool.Query(ctx,
    "SELECT id, email, name FROM users WHERE status = $1 AND created_at > $2",
    "active",
    time.Now().AddDate(0, -1, 0),
)
if err != nil {
    return nil, err
}
defer rows.Close()

var users []User
for rows.Next() {
    var user User
    if err := rows.Scan(&user.ID, &user.Email, &user.Name); err != nil {
        return nil, err
    }
    users = append(users, user)
}
```

**æ‰¹é‡æŸ¥è¯¢**:

```go
// æ‰¹é‡æŸ¥è¯¢
batch := &pgx.Batch{}
batch.Queue("SELECT id, email FROM users WHERE id = $1", userID1)
batch.Queue("SELECT id, email FROM users WHERE id = $1", userID2)
batch.Queue("SELECT id, email FROM users WHERE id = $1", userID3)

results := pool.SendBatch(ctx, batch)
defer results.Close()

// è·å–ç»“æœ
for i := 0; i < 3; i++ {
    rows, err := results.Query()
    if err != nil {
        return nil, err
    }
    // å¤„ç†ç»“æœ
    rows.Close()
}
```

##### 3.2.3.3 äº‹åŠ¡å¤„ç†

**åŸºç¡€äº‹åŠ¡**:

```go
// ä½¿ç”¨äº‹åŠ¡
tx, err := pool.Begin(ctx)
if err != nil {
    return err
}
defer tx.Rollback(ctx)

// æ‰§è¡Œæ“ä½œ
_, err = tx.Exec(ctx, "UPDATE accounts SET balance = balance - $1 WHERE id = $2", amount, fromID)
if err != nil {
    return err
}

_, err = tx.Exec(ctx, "UPDATE accounts SET balance = balance + $1 WHERE id = $2", amount, toID)
if err != nil {
    return err
}

// æäº¤äº‹åŠ¡
if err := tx.Commit(ctx); err != nil {
    return err
}

return nil
```

**ä¿å­˜ç‚¹ï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰**:

```go
// ä½¿ç”¨ä¿å­˜ç‚¹å®ç°åµŒå¥—äº‹åŠ¡
tx, _ := pool.Begin(ctx)
defer tx.Rollback(ctx)

// åˆ›å»ºä¿å­˜ç‚¹
_, err := tx.Exec(ctx, "SAVEPOINT sp1")
if err != nil {
    return err
}

// æ‰§è¡Œæ“ä½œ
_, err = tx.Exec(ctx, "INSERT INTO users (email, name) VALUES ($1, $2)", email, name)
if err != nil {
    // å›æ»šåˆ°ä¿å­˜ç‚¹
    tx.Exec(ctx, "ROLLBACK TO SAVEPOINT sp1")
    return err
}

// é‡Šæ”¾ä¿å­˜ç‚¹
tx.Exec(ctx, "RELEASE SAVEPOINT sp1")

// æäº¤äº‹åŠ¡
tx.Commit(ctx)
```

##### 3.2.3.4 JSON/JSONB æ“ä½œ

**JSON ç±»å‹æ“ä½œ**:

```go
// æ’å…¥ JSON æ•°æ®
type UserMetadata struct {
    Age     int    `json:"age"`
    City    string `json:"city"`
    Country string `json:"country"`
}

metadata := UserMetadata{
    Age:     30,
    City:    "Beijing",
    Country: "China",
}

jsonData, _ := json.Marshal(metadata)
_, err := pool.Exec(ctx,
    "INSERT INTO users (id, email, metadata) VALUES ($1, $2, $3)",
    userID,
    email,
    jsonData,
)

// æŸ¥è¯¢ JSON æ•°æ®
var metadataJSON []byte
err := pool.QueryRow(ctx,
    "SELECT metadata FROM users WHERE id = $1",
    userID,
).Scan(&metadataJSON)

var metadata UserMetadata
json.Unmarshal(metadataJSON, &metadata)

// JSON æŸ¥è¯¢
var users []User
rows, err := pool.Query(ctx,
    "SELECT id, email FROM users WHERE metadata->>'city' = $1",
    "Beijing",
)
```

##### 3.2.3.5 æ•°ç»„ç±»å‹æ“ä½œ

**æ•°ç»„ç±»å‹æ“ä½œ**:

```go
// æ’å…¥æ•°ç»„
tags := []string{"golang", "backend", "api"}
_, err := pool.Exec(ctx,
    "INSERT INTO posts (id, title, tags) VALUES ($1, $2, $3)",
    postID,
    "Post Title",
    tags,
)

// æŸ¥è¯¢æ•°ç»„
var tags []string
err := pool.QueryRow(ctx,
    "SELECT tags FROM posts WHERE id = $1",
    postID,
).Scan(&tags)

// æ•°ç»„æŸ¥è¯¢
rows, err := pool.Query(ctx,
    "SELECT id, title FROM posts WHERE $1 = ANY(tags)",
    "golang",
)
```

##### 3.2.3.6 é¢„ç¼–è¯‘è¯­å¥

**é¢„ç¼–è¯‘è¯­å¥ä½¿ç”¨**:

```go
// å‡†å¤‡é¢„ç¼–è¯‘è¯­å¥
stmt, err := pool.Prepare(ctx, "get_user", "SELECT id, email, name FROM users WHERE id = $1")
if err != nil {
    return nil, err
}

// æ‰§è¡Œé¢„ç¼–è¯‘è¯­å¥
var user User
err = pool.QueryRow(ctx, "get_user", userID).
    Scan(&user.ID, &user.Email, &user.Name)

// æ‰¹é‡æ‰§è¡Œé¢„ç¼–è¯‘è¯­å¥
stmt, _ = pool.Prepare(ctx, "update_user", "UPDATE users SET name = $1 WHERE id = $2")
for _, u := range users {
    pool.Exec(ctx, "update_user", u.Name, u.ID)
}
```

#### 3.2.4 æœ€ä½³å®è·µ

##### 3.2.4.1 è¿æ¥æ± é…ç½®æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦åˆç†é…ç½®è¿æ¥æ± ï¼Ÿ**

è¿æ¥æ± é…ç½®ç›´æ¥å½±å“åº”ç”¨æ€§èƒ½å’Œæ•°æ®åº“è´Ÿè½½ã€‚åˆç†çš„è¿æ¥æ± é…ç½®å¯ä»¥æé«˜æ€§èƒ½ï¼Œé¿å…è¿æ¥è€—å°½ã€‚

**è¿æ¥æ± é…ç½®åŸåˆ™**:

1. **æœ€å¤§è¿æ¥æ•°**: æ ¹æ®åº”ç”¨å¹¶å‘é‡å’Œæ•°æ®åº“æœ€å¤§è¿æ¥æ•°è®¾ç½®
2. **æœ€å°è¿æ¥æ•°**: ä¿æŒä¸€å®šæ•°é‡çš„å¸¸é©»è¿æ¥ï¼Œå‡å°‘è¿æ¥å»ºç«‹å¼€é”€
3. **è¿æ¥ç”Ÿå­˜æ—¶é—´**: è®¾ç½®åˆç†çš„è¿æ¥ç”Ÿå­˜æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´å ç”¨è¿æ¥
4. **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€ï¼ŒåŠæ—¶æ¸…ç†æ— æ•ˆè¿æ¥

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// è¿æ¥æ± é…ç½®æœ€ä½³å®è·µ
func NewConnectionPool(dsn string) (*pgxpool.Pool, error) {
    config, err := pgxpool.ParseConfig(dsn)
    if err != nil {
        return nil, err
    }

    // æ ¹æ®åº”ç”¨è´Ÿè½½é…ç½®è¿æ¥æ± 
    // æœ€å¤§è¿æ¥æ•° = (åº”ç”¨å®ä¾‹æ•° * æ¯ä¸ªå®ä¾‹çš„å¹¶å‘è¯·æ±‚æ•°) / æ•°æ®åº“æœ€å¤§è¿æ¥æ•°
    config.MaxConns = 25

    // æœ€å°è¿æ¥æ•°ï¼šä¿æŒ 20% çš„å¸¸é©»è¿æ¥
    config.MinConns = 5

    // è¿æ¥ç”Ÿå­˜æ—¶é—´ï¼š1 å°æ—¶ï¼Œé¿å…é•¿æ—¶é—´å ç”¨è¿æ¥
    config.MaxConnLifetime = time.Hour

    // è¿æ¥ç©ºé—²æ—¶é—´ï¼š30 åˆ†é’Ÿï¼ŒåŠæ—¶é‡Šæ”¾ç©ºé—²è¿æ¥
    config.MaxConnIdleTime = time.Minute * 30

    // å¥åº·æ£€æŸ¥ï¼šæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    config.HealthCheckPeriod = time.Minute

    // è¿æ¥è¶…æ—¶ï¼š5 ç§’
    config.ConnConfig.ConnectTimeout = 5 * time.Second

    // å‘½ä»¤è¶…æ—¶ï¼š30 ç§’
    config.ConnConfig.CommandTimeout = 30 * time.Second

    pool, err := pgxpool.NewWithConfig(context.Background(), config)
    if err != nil {
        return nil, err
    }

    // éªŒè¯è¿æ¥
    if err := pool.Ping(context.Background()); err != nil {
        return nil, err
    }

    return pool, nil
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **åˆç†è®¾ç½®æœ€å¤§è¿æ¥æ•°**: æ ¹æ®åº”ç”¨è´Ÿè½½å’Œæ•°æ®åº“å®¹é‡è®¾ç½®
2. **ä¿æŒæœ€å°è¿æ¥æ•°**: å‡å°‘è¿æ¥å»ºç«‹å¼€é”€
3. **è®¾ç½®è¿æ¥ç”Ÿå­˜æ—¶é—´**: é¿å…é•¿æ—¶é—´å ç”¨è¿æ¥
4. **å®šæœŸå¥åº·æ£€æŸ¥**: åŠæ—¶æ¸…ç†æ— æ•ˆè¿æ¥

##### 3.2.4.2 äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦åˆç†çš„äº‹åŠ¡ç®¡ç†ï¼Ÿ**

åˆç†çš„äº‹åŠ¡ç®¡ç†å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…é•¿æ—¶é—´æŒæœ‰è¿æ¥ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚

**äº‹åŠ¡ç®¡ç†åŸåˆ™**:

1. **äº‹åŠ¡è¾¹ç•Œ**: æ˜ç¡®äº‹åŠ¡è¾¹ç•Œï¼Œé¿å…é•¿æ—¶é—´äº‹åŠ¡
2. **é”™è¯¯å¤„ç†**: æ­£ç¡®å¤„ç†äº‹åŠ¡é”™è¯¯ï¼Œç¡®ä¿å›æ»š
3. **éš”ç¦»çº§åˆ«**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«
4. **ä¿å­˜ç‚¹**: ä½¿ç”¨ä¿å­˜ç‚¹å®ç°åµŒå¥—äº‹åŠ¡

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ
func TransferMoney(ctx context.Context, pool *pgxpool.Pool, fromID, toID string, amount float64) error {
    // å¼€å§‹äº‹åŠ¡
    tx, err := pool.Begin(ctx)
    if err != nil {
        return fmt.Errorf("failed to begin transaction: %w", err)
    }

    // ç¡®ä¿å›æ»š
    defer func() {
        if err != nil {
            tx.Rollback(ctx)
        }
    }()

    // æ£€æŸ¥ä½™é¢
    var balance float64
    err = tx.QueryRow(ctx, "SELECT balance FROM accounts WHERE id = $1 FOR UPDATE", fromID).
        Scan(&balance)
    if err != nil {
        return fmt.Errorf("failed to get balance: %w", err)
    }

    if balance < amount {
        return errors.New("insufficient balance")
    }

    // æ‰£æ¬¾
    _, err = tx.Exec(ctx, "UPDATE accounts SET balance = balance - $1 WHERE id = $2", amount, fromID)
    if err != nil {
        return fmt.Errorf("failed to deduct: %w", err)
    }

    // åŠ æ¬¾
    _, err = tx.Exec(ctx, "UPDATE accounts SET balance = balance + $1 WHERE id = $2", amount, toID)
    if err != nil {
        return fmt.Errorf("failed to add: %w", err)
    }

    // æäº¤äº‹åŠ¡
    if err := tx.Commit(ctx); err != nil {
        return fmt.Errorf("failed to commit: %w", err)
    }

    return nil
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **æ˜ç¡®äº‹åŠ¡è¾¹ç•Œ**: å°†ç›¸å…³æ“ä½œæ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
2. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ defer ç¡®ä¿äº‹åŠ¡å›æ»š
3. **ä½¿ç”¨ FOR UPDATE**: ä½¿ç”¨è¡Œé”é¿å…å¹¶å‘é—®é¢˜
4. **é¿å…é•¿æ—¶é—´äº‹åŠ¡**: ä¸è¦åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ

##### 3.2.4.3 æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦æŸ¥è¯¢ä¼˜åŒ–ï¼Ÿ**

æŸ¥è¯¢ä¼˜åŒ–å¯ä»¥æé«˜åº”ç”¨æ€§èƒ½ï¼Œå‡å°‘æ•°æ®åº“è´Ÿè½½ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

**æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**:

1. **ä½¿ç”¨ç´¢å¼•**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
2. **é¢„ç¼–è¯‘è¯­å¥**: ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥æé«˜æ€§èƒ½
3. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“å¾€è¿”
4. **æŸ¥è¯¢è®¡åˆ’**: ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è¯¢è®¡åˆ’

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ
// 1. ä½¿ç”¨ç´¢å¼•
// ç¡®ä¿æŸ¥è¯¢å­—æ®µæœ‰ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status_created ON users(status, created_at);

// 2. ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
stmt, _ := pool.Prepare(ctx, "get_user", "SELECT id, email FROM users WHERE id = $1")
defer stmt.Close()

// 3. æ‰¹é‡æ“ä½œ
batch := &pgx.Batch{}
for _, userID := range userIDs {
    batch.Queue("SELECT id, email FROM users WHERE id = $1", userID)
}
results := pool.SendBatch(ctx, batch)
defer results.Close()

// 4. ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è¯¢
rows, _ := pool.Query(ctx, "EXPLAIN ANALYZE SELECT * FROM users WHERE email = $1", email)
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ä½¿ç”¨ç´¢å¼•**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
2. **é¢„ç¼–è¯‘è¯­å¥**: ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥æé«˜æ€§èƒ½
3. **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“å¾€è¿”
4. **åˆ†ææŸ¥è¯¢è®¡åˆ’**: ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è¯¢æ€§èƒ½

##### 3.2.4.4 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦é”™è¯¯å¤„ç†ï¼Ÿ**

æ­£ç¡®çš„é”™è¯¯å¤„ç†å¯ä»¥æé«˜åº”ç”¨çš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥ã€‚

**é”™è¯¯å¤„ç†åŸåˆ™**:

1. **é”™è¯¯åˆ†ç±»**: åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯ï¼ˆè¿æ¥é”™è¯¯ã€æŸ¥è¯¢é”™è¯¯ã€äº‹åŠ¡é”™è¯¯ï¼‰
2. **é”™è¯¯æ—¥å¿—**: è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼ŒåŒ…æ‹¬ SQL è¯­å¥å’Œå‚æ•°
3. **é”™è¯¯æ¢å¤**: å®ç°é”™è¯¯æ¢å¤æœºåˆ¶ï¼Œå¦‚é‡è¯•ã€é™çº§
4. **é”™è¯¯ä¼ æ’­**: æ­£ç¡®ä¼ æ’­é”™è¯¯ï¼Œä¸è¦ä¸¢å¤±é”™è¯¯ä¿¡æ¯

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
func QueryUser(ctx context.Context, pool *pgxpool.Pool, userID string) (*User, error) {
    var user User
    err := pool.QueryRow(ctx, "SELECT id, email, name FROM users WHERE id = $1", userID).
        Scan(&user.ID, &user.Email, &user.Name)

    if err != nil {
        // é”™è¯¯åˆ†ç±»å¤„ç†
        if errors.Is(err, pgx.ErrNoRows) {
            return nil, errors.NewNotFoundError("user not found")
        }

        // è¿æ¥é”™è¯¯
        if pgconn.Timeout(err) {
            logger.Error("Database timeout",
                "userID", userID,
                "error", err,
            )
            return nil, errors.NewTimeoutError("database timeout")
        }

        // å…¶ä»–é”™è¯¯
        logger.Error("Database query error",
            "userID", userID,
            "error", err,
            "sql", "SELECT id, email, name FROM users WHERE id = $1",
        )
        return nil, fmt.Errorf("failed to query user: %w", err)
    }

    return &user, nil
}

// é”™è¯¯é‡è¯•
func QueryUserWithRetry(ctx context.Context, pool *pgxpool.Pool, userID string) (*User, error) {
    var user *User
    var err error

    for i := 0; i < 3; i++ {
        user, err = QueryUser(ctx, pool, userID)
        if err == nil {
            return user, nil
        }

        // åªé‡è¯•è¿æ¥é”™è¯¯
        if !pgconn.Timeout(err) {
            return nil, err
        }

        time.Sleep(time.Second * time.Duration(i+1))
    }

    return nil, err
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **é”™è¯¯åˆ†ç±»**: åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯ï¼Œè¿”å›é€‚å½“çš„é”™è¯¯ç±»å‹
2. **é”™è¯¯æ—¥å¿—**: è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼ŒåŒ…æ‹¬ SQL å’Œå‚æ•°
3. **é”™è¯¯é‡è¯•**: å¯¹å¯é‡è¯•çš„é”™è¯¯å®ç°é‡è¯•æœºåˆ¶
4. **é”™è¯¯ä¼ æ’­**: æ­£ç¡®ä¼ æ’­é”™è¯¯ï¼Œä¸è¦ä¸¢å¤±é”™è¯¯ä¿¡æ¯

##### 3.2.4.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**:

1. **è¿æ¥æ± ä¼˜åŒ–**: åˆç†é…ç½®è¿æ¥æ± å‚æ•°
2. **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨ç´¢å¼•ã€é¢„ç¼–è¯‘è¯­å¥ã€æ‰¹é‡æ“ä½œ
3. **è¿æ¥å¤ç”¨**: å¤ç”¨è¿æ¥ï¼Œå‡å°‘è¿æ¥å»ºç«‹å¼€é”€
4. **ç›‘æ§æ€§èƒ½**: ç›‘æ§æŸ¥è¯¢æ€§èƒ½ï¼Œè¯†åˆ«æ…¢æŸ¥è¯¢

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ
// 1. è¿æ¥æ± ä¼˜åŒ–
config.MaxConns = 25
config.MinConns = 5
config.MaxConnLifetime = time.Hour

// 2. ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
stmt, _ := pool.Prepare(ctx, "get_user", "SELECT id, email FROM users WHERE id = $1")

// 3. æ‰¹é‡æ“ä½œ
batch := &pgx.Batch{}
for _, userID := range userIDs {
    batch.Queue("SELECT id, email FROM users WHERE id = $1", userID)
}
results := pool.SendBatch(ctx, batch)

// 4. ç›‘æ§æ…¢æŸ¥è¯¢
func QueryWithMonitoring(ctx context.Context, pool *pgxpool.Pool, sql string, args ...interface{}) (pgx.Rows, error) {
    start := time.Now()
    rows, err := pool.Query(ctx, sql, args...)
    duration := time.Since(start)

    if duration > time.Second {
        logger.Warn("Slow query detected",
            "sql", sql,
            "duration", duration,
        )
    }

    return rows, err
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **è¿æ¥æ± ä¼˜åŒ–**: åˆç†é…ç½®è¿æ¥æ± å‚æ•°
2. **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨ç´¢å¼•ã€é¢„ç¼–è¯‘è¯­å¥ã€æ‰¹é‡æ“ä½œ
3. **ç›‘æ§æ€§èƒ½**: ç›‘æ§æŸ¥è¯¢æ€§èƒ½ï¼Œè¯†åˆ«æ…¢æŸ¥è¯¢
4. **å®šæœŸä¼˜åŒ–**: å®šæœŸåˆ†ææŸ¥è¯¢æ€§èƒ½ï¼Œä¼˜åŒ–æ…¢æŸ¥è¯¢

---

## 4. ğŸ”„ å·¥ä½œæµå±‚

### 4.1 Temporal

#### 4.1.1 æ ¸å¿ƒç‰¹æ€§

**Temporal æ˜¯ä»€ä¹ˆï¼Ÿ**

Temporal æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å·¥ä½œæµç¼–æ’å¼•æ“ï¼Œæä¾›å¯é çš„ä¸šåŠ¡æµç¨‹ç®¡ç†ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **å¯é æ€§**: è‡ªåŠ¨æŒä¹…åŒ–çŠ¶æ€ï¼Œæ”¯æŒæ•…éšœæ¢å¤
- âœ… **å¯è§‚æµ‹æ€§**: å†…ç½® UI å’Œç›‘æ§
- âœ… **Go æ”¯æŒ**: å®˜æ–¹ Go SDKï¼ŒåŠŸèƒ½å®Œæ•´
- âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•

#### 4.1.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Temporalï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Temporal | Airflow | Conductor | Cadence | è¯´æ˜ |
|---------|------|----------|---------|-----------|---------|------|
| **Go æ”¯æŒ** | 40% | 10 | 0 | 0 | 5 | Temporal å®˜æ–¹ Go SDK |
| **åŠŸèƒ½å®Œæ•´æ€§** | 25% | 10 | 8 | 7 | 8 | Temporal åŠŸèƒ½å®Œå–„ |
| **å¯è§‚æµ‹æ€§** | 20% | 10 | 7 | 5 | 6 | Temporal UI åŠŸèƒ½å¼ºå¤§ |
| **å­¦ä¹ æ›²çº¿** | 10% | 7 | 8 | 7 | 7 | Temporal å­¦ä¹ æ›²çº¿é€‚ä¸­ |
| **ç¤¾åŒºæ”¯æŒ** | 5% | 8 | 10 | 5 | 6 | Temporal ç¤¾åŒºæ´»è·ƒ |
| **åŠ æƒæ€»åˆ†** | - | **9.25** | 5.40 | 4.85 | 6.50 | Temporal å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **Go æ”¯æŒï¼ˆæƒé‡ 40%ï¼‰**:
   - å®˜æ–¹ Go SDKï¼ŒåŠŸèƒ½å®Œæ•´
   - æ–‡æ¡£å®Œå–„ï¼Œç¤ºä¾‹ä¸°å¯Œ
   - ç¤¾åŒºæ”¯æŒå¥½
   - **è¿™æ˜¯é€‰æ‹© Temporal çš„æœ€é‡è¦åŸå› **

2. **åŠŸèƒ½å®Œæ•´æ€§ï¼ˆæƒé‡ 25%ï¼‰**:
   - æŒä¹…åŒ–ã€å¯æ¢å¤ã€å¯æŸ¥è¯¢åŠŸèƒ½å®Œå–„
   - ä¿¡å·å’Œç‰ˆæœ¬æ§åˆ¶æ”¯æŒå¥½
   - UI åŠŸèƒ½å®Œå–„

3. **å¯è§‚æµ‹æ€§ï¼ˆæƒé‡ 20%ï¼‰**:
   - å†…ç½® UIï¼ŒåŠŸèƒ½å®Œå–„
   - æ”¯æŒ OpenTelemetry
   - è¿½è¸ªå’Œç›‘æ§é›†æˆå¥½

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–å·¥ä½œæµå¼•æ“ï¼Ÿ**

1. **Airflow**:
   - âœ… UI åŠŸèƒ½ä¸°å¯Œï¼Œç¤¾åŒºæ´»è·ƒ
   - âŒ æ— å®˜æ–¹ Go SDK
   - âŒ ä¸»è¦é¢å‘ Python
   - âŒ ä¸é€‚åˆå®æ—¶å·¥ä½œæµ

2. **Conductor**:
   - âœ… åŠŸèƒ½å¼ºå¤§ï¼ŒNetflix å¼€æº
   - âŒ æ— å®˜æ–¹ Go SDK
   - âŒ å¯è§‚æµ‹æ€§æ”¯æŒæœ‰é™
   - âŒ ç¤¾åŒºè¾ƒå°

3. **Cadence**:
   - âš ï¸ åªæœ‰ç¤¾åŒº Go SDKï¼ŒåŠŸèƒ½æœ‰é™
   - âš ï¸ å¯è§‚æµ‹æ€§æ”¯æŒæœ‰é™
   - âš ï¸ æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒæœ‰é™

**è¯¦ç»†è®ºè¯è¯·å‚è€ƒ**: [å·¥ä½œæµæ¶æ„è®¾è®¡](./workflow.md#11-ä¸ºä»€ä¹ˆé€‰æ‹©-temporal)

#### 4.1.3 å®é™…åº”ç”¨

##### 4.1.3.1 å·¥ä½œæµå®šä¹‰

**åŸºç¡€å·¥ä½œæµå®šä¹‰**:

```go
// internal/application/workflow/user_workflow.go
package workflow

import (
    "fmt"
    "time"

    "go.temporal.io/sdk/workflow"
    "go.temporal.io/sdk/temporal"
)

// UserWorkflowInput å·¥ä½œæµè¾“å…¥
type UserWorkflowInput struct {
    UserID  string
    Email   string
    Name    string
    Action  string // "create", "update", "delete"
}

// UserWorkflowOutput å·¥ä½œæµè¾“å‡º
type UserWorkflowOutput struct {
    UserID    string
    Success   bool
    Message   string
    Timestamp time.Time
}

// UserWorkflow ç”¨æˆ·å·¥ä½œæµ
func UserWorkflow(ctx workflow.Context, input UserWorkflowInput) (UserWorkflowOutput, error) {
    // é…ç½®æ´»åŠ¨é€‰é¡¹
    ao := workflow.ActivityOptions{
        StartToCloseTimeout: 30 * time.Second,
        RetryPolicy: &temporal.RetryPolicy{
            InitialInterval:    time.Second,
            BackoffCoefficient: 2.0,
            MaximumInterval:    time.Minute,
            MaximumAttempts:    3,
        },
    }
    ctx = workflow.WithActivityOptions(ctx, ao)

    var result UserWorkflowOutput
    var err error

    switch input.Action {
    case "create":
        result, err = createUserWorkflow(ctx, input)
    case "update":
        result, err = updateUserWorkflow(ctx, input)
    case "delete":
        result, err = deleteUserWorkflow(ctx, input)
    default:
        return UserWorkflowOutput{
            Success: false,
            Message: "unknown action",
        }, fmt.Errorf("unknown action: %s", input.Action)
    }

    return result, err
}
```

##### 4.1.3.2 æ´»åŠ¨å®šä¹‰

**æ´»åŠ¨å®šä¹‰ç¤ºä¾‹**:

```go
// internal/application/workflow/user_activities.go
package workflow

import (
    "context"
    "fmt"

    appuser "github.com/yourusername/golang/internal/application/user"
)

// ValidateUserActivity éªŒè¯ç”¨æˆ·æ´»åŠ¨
func ValidateUserActivity(ctx context.Context, email, name string) (string, error) {
    // éªŒè¯é‚®ç®±æ ¼å¼
    if !isValidEmail(email) {
        return "", fmt.Errorf("invalid email: %s", email)
    }

    // éªŒè¯å§“å
    if len(name) < 2 || len(name) > 50 {
        return "", fmt.Errorf("invalid name: %s", name)
    }

    return "validation passed", nil
}

// CreateUserActivity åˆ›å»ºç”¨æˆ·æ´»åŠ¨
func CreateUserActivity(ctx context.Context, email, name string) (string, error) {
    userService, ok := GetUserServiceFromContext(ctx)
    if !ok {
        return "", fmt.Errorf("user service not found in context")
    }

    user, err := userService.CreateUser(ctx, appuser.CreateUserRequest{
        Email: email,
        Name:  name,
    })
    if err != nil {
        return "", fmt.Errorf("failed to create user: %w", err)
    }

    return user.ID, nil
}

// SendNotificationActivity å‘é€é€šçŸ¥æ´»åŠ¨
func SendNotificationActivity(ctx context.Context, userID, eventType string) error {
    // å‘é€é€šçŸ¥é€»è¾‘
    fmt.Printf("Sending notification: userID=%s, eventType=%s\n", userID, eventType)
    return nil
}
```

##### 4.1.3.3 Worker é…ç½®

**Worker é…ç½®ç¤ºä¾‹**:

```go
// cmd/temporal-worker/main.go
package main

import (
    "context"
    "log"

    "go.temporal.io/sdk/client"
    "go.temporal.io/sdk/worker"

    appworkflow "github.com/yourusername/golang/internal/application/workflow"
    "github.com/yourusername/golang/internal/config"
    temporalclient "github.com/yourusername/golang/internal/infrastructure/workflow/temporal"
)

func main() {
    // åŠ è½½é…ç½®
    cfg, err := config.LoadConfig()
    if err != nil {
        log.Fatalf("Failed to load config: %v", err)
    }

    // åˆ›å»º Temporal å®¢æˆ·ç«¯
    temporalClient, err := temporalclient.NewClient(cfg.Workflow.Temporal.Address)
    if err != nil {
        log.Fatalf("Failed to create temporal client: %v", err)
    }
    defer temporalClient.Close()

    // åˆ›å»º Worker
    w := worker.New(temporalClient.Client(), cfg.Workflow.Temporal.TaskQueue, worker.Options{})

    // æ³¨å†Œå·¥ä½œæµ
    w.RegisterWorkflow(appworkflow.UserWorkflow)

    // æ³¨å†Œæ´»åŠ¨
    w.RegisterActivity(appworkflow.ValidateUserActivity)
    w.RegisterActivity(appworkflow.CreateUserActivity)
    w.RegisterActivity(appworkflow.SendNotificationActivity)

    // å¯åŠ¨ Worker
    if err := w.Run(worker.InterruptCh()); err != nil {
        log.Fatalf("Worker failed: %v", err)
    }
}
```

##### 4.1.3.4 Client ä½¿ç”¨

**Client ä½¿ç”¨ç¤ºä¾‹**:

```go
// å¯åŠ¨å·¥ä½œæµ
func StartUserWorkflow(ctx context.Context, client client.Client, input appworkflow.UserWorkflowInput) (client.WorkflowRun, error) {
    options := client.StartWorkflowOptions{
        ID:        fmt.Sprintf("user-workflow-%s-%s", input.Action, input.UserID),
        TaskQueue: "user-task-queue",
    }

    workflowRun, err := client.ExecuteWorkflow(ctx, options, appworkflow.UserWorkflow, input)
    if err != nil {
        return nil, fmt.Errorf("failed to start workflow: %w", err)
    }

    return workflowRun, nil
}

// è·å–å·¥ä½œæµç»“æœ
func GetWorkflowResult(ctx context.Context, client client.Client, workflowID, runID string) (appworkflow.UserWorkflowOutput, error) {
    var result appworkflow.UserWorkflowOutput

    workflowRun := client.GetWorkflow(ctx, workflowID, runID)
    err := workflowRun.Get(ctx, &result)
    if err != nil {
        return result, fmt.Errorf("failed to get workflow result: %w", err)
    }

    return result, nil
}

// å‘é€ä¿¡å·
func SignalWorkflow(ctx context.Context, client client.Client, workflowID, runID, signalName string, arg interface{}) error {
    return client.SignalWorkflow(ctx, workflowID, runID, signalName, arg)
}

// æŸ¥è¯¢å·¥ä½œæµ
func QueryWorkflow(ctx context.Context, client client.Client, workflowID, runID, queryType string, args ...interface{}) (interface{}, error) {
    return client.QueryWorkflow(ctx, workflowID, runID, queryType, args...)
}
```

##### 4.1.3.5 ä¿¡å·å’ŒæŸ¥è¯¢ä½¿ç”¨

**ä¿¡å·ä½¿ç”¨ç¤ºä¾‹**:

```go
// åœ¨å·¥ä½œæµä¸­æ¥æ”¶ä¿¡å·
func OrderApprovalWorkflow(ctx workflow.Context, orderID string) error {
    // åˆ›å»ºä¿¡å·é€šé“
    signalChan := workflow.GetSignalChannel(ctx, "approve-signal")

    // ç­‰å¾…ä¿¡å·
    var approvalResult bool
    signalChan.Receive(ctx, &approvalResult)

    if approvalResult {
        // å¤„ç†æ‰¹å‡†é€»è¾‘
        return workflow.ExecuteActivity(ctx, ProcessOrderActivity, orderID).Get(ctx, nil)
    } else {
        // å¤„ç†æ‹’ç»é€»è¾‘
        return workflow.ExecuteActivity(ctx, CancelOrderActivity, orderID).Get(ctx, nil)
    }
}

// ä»å®¢æˆ·ç«¯å‘é€ä¿¡å·
func SendApprovalSignal(ctx context.Context, client client.Client, workflowID, runID string, approved bool) error {
    return client.SignalWorkflow(ctx, workflowID, runID, "approve-signal", approved)
}
```

**æŸ¥è¯¢ä½¿ç”¨ç¤ºä¾‹**:

```go
// åœ¨å·¥ä½œæµä¸­è®¾ç½®æŸ¥è¯¢å¤„ç†å™¨
func OrderStatusWorkflow(ctx workflow.Context, orderID string) (string, error) {
    currentStatus := "PENDING"

    // è®¾ç½®æŸ¥è¯¢å¤„ç†å™¨
    err := workflow.SetQueryHandler(ctx, "get-status", func() (string, error) {
        return currentStatus, nil
    })
    if err != nil {
        return "", err
    }

    // æ›´æ–°çŠ¶æ€
    currentStatus = "PROCESSING"
    workflow.Sleep(ctx, 10*time.Second)

    currentStatus = "COMPLETED"
    return currentStatus, nil
}

// ä»å®¢æˆ·ç«¯æŸ¥è¯¢å·¥ä½œæµçŠ¶æ€
func GetOrderStatus(ctx context.Context, client client.Client, workflowID, runID string) (string, error) {
    var status string
    err := client.QueryWorkflow(ctx, workflowID, runID, "get-status").Get(ctx, &status)
    return status, err
}
```

##### 4.1.3.6 é”™è¯¯å¤„ç†ç¤ºä¾‹

**é”™è¯¯å¤„ç†ç¤ºä¾‹**:

```go
// å·¥ä½œæµä¸­çš„é”™è¯¯å¤„ç†
func UserWorkflowWithErrorHandling(ctx workflow.Context, input UserWorkflowInput) (UserWorkflowOutput, error) {
    ao := workflow.ActivityOptions{
        StartToCloseTimeout: 30 * time.Second,
        RetryPolicy: &temporal.RetryPolicy{
            InitialInterval:    time.Second,
            BackoffCoefficient: 2.0,
            MaximumInterval:    time.Minute,
            MaximumAttempts:    3,
            NonRetryableErrorTypes: []string{"ValidationError", "NotFoundError"},
        },
    }
    ctx = workflow.WithActivityOptions(ctx, ao)

    // æ‰§è¡Œæ´»åŠ¨
    err := workflow.ExecuteActivity(ctx, CreateUserActivity, input.Email, input.Name).Get(ctx, nil)
    if err != nil {
        // æ£€æŸ¥é”™è¯¯ç±»å‹
        var activityErr *temporal.ActivityError
        if errors.As(err, &activityErr) {
            // å¤„ç†æ´»åŠ¨é”™è¯¯
            workflow.GetLogger(ctx).Error("Activity failed", "error", activityErr)
            return UserWorkflowOutput{Success: false}, err
        }

        // å¤„ç†å…¶ä»–é”™è¯¯
        return UserWorkflowOutput{Success: false}, err
    }

    return UserWorkflowOutput{Success: true}, nil
}
```

#### 4.1.4 æœ€ä½³å®è·µ

##### 4.1.4.1 å·¥ä½œæµè®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„å·¥ä½œæµè®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„å·¥ä½œæµè®¾è®¡å¯ä»¥æé«˜å·¥ä½œæµçš„å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œæ€§èƒ½ã€‚

**å·¥ä½œæµè®¾è®¡åŸåˆ™**:

1. **ç¡®å®šæ€§**: å·¥ä½œæµä»£ç å¿…é¡»æ˜¯ç¡®å®šæ€§çš„ï¼Œä¸èƒ½ä½¿ç”¨éšæœºæ•°ã€æ—¶é—´ç­‰éç¡®å®šæ€§å‡½æ•°
2. **ç»†ç²’åº¦æ´»åŠ¨**: å°†å¤æ‚é€»è¾‘æ‹†åˆ†ä¸ºå¤šä¸ªç»†ç²’åº¦æ´»åŠ¨
3. **é”™è¯¯å¤„ç†**: åˆç†é…ç½®é‡è¯•ç­–ç•¥ï¼Œå¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
4. **è¶…æ—¶è®¾ç½®**: ä¸ºæ´»åŠ¨è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// è‰¯å¥½çš„å·¥ä½œæµè®¾è®¡
func UserRegistrationWorkflow(ctx workflow.Context, input UserRegistrationInput) (UserRegistrationOutput, error) {
    // é…ç½®æ´»åŠ¨é€‰é¡¹
    ao := workflow.ActivityOptions{
        StartToCloseTimeout: 30 * time.Second,
        RetryPolicy: &temporal.RetryPolicy{
            InitialInterval:    time.Second,
            BackoffCoefficient: 2.0,
            MaximumInterval:    time.Minute,
            MaximumAttempts:    3,
        },
    }
    ctx = workflow.WithActivityOptions(ctx, ao)

    // 1. éªŒè¯ç”¨æˆ·ä¿¡æ¯
    var validationResult string
    err := workflow.ExecuteActivity(ctx, ValidateUserActivity, input.Email, input.Name).Get(ctx, &validationResult)
    if err != nil {
        return UserRegistrationOutput{Success: false}, err
    }

    // 2. åˆ›å»ºç”¨æˆ·
    var userID string
    err = workflow.ExecuteActivity(ctx, CreateUserActivity, input.Email, input.Name).Get(ctx, &userID)
    if err != nil {
        return UserRegistrationOutput{Success: false}, err
    }

    // 3. å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
    workflow.ExecuteActivity(ctx, SendWelcomeEmailActivity, userID, input.Email).Get(ctx, nil)

    return UserRegistrationOutput{
        Success: true,
        UserID:  userID,
    }, nil
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ç¡®å®šæ€§**: ä½¿ç”¨ `workflow.Now()` è€Œä¸æ˜¯ `time.Now()`ï¼Œä½¿ç”¨ `workflow.GetRandomSequence()` è€Œä¸æ˜¯ `rand.Int()`
2. **ç»†ç²’åº¦æ´»åŠ¨**: å°†å¤æ‚é€»è¾‘æ‹†åˆ†ä¸ºå¤šä¸ªæ´»åŠ¨ï¼Œæ¯ä¸ªæ´»åŠ¨èŒè´£å•ä¸€
3. **é”™è¯¯å¤„ç†**: åˆç†é…ç½®é‡è¯•ç­–ç•¥ï¼ŒåŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯
4. **è¶…æ—¶è®¾ç½®**: ä¸ºæ´»åŠ¨è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡

##### 4.1.4.2 æ´»åŠ¨è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„æ´»åŠ¨è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„æ´»åŠ¨è®¾è®¡å¯ä»¥æé«˜æ´»åŠ¨çš„å¯é‡ç”¨æ€§ã€å¯æµ‹è¯•æ€§å’Œæ€§èƒ½ã€‚

**æ´»åŠ¨è®¾è®¡åŸåˆ™**:

1. **å¹‚ç­‰æ€§**: æ´»åŠ¨åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ
2. **å•ä¸€èŒè´£**: æ¯ä¸ªæ´»åŠ¨åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
3. **é”™è¯¯å¤„ç†**: è¿”å›æ˜ç¡®çš„é”™è¯¯ç±»å‹
4. **è¶…æ—¶å¤„ç†**: åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// è‰¯å¥½çš„æ´»åŠ¨è®¾è®¡
func CreateUserActivity(ctx context.Context, email, name string) (string, error) {
    // è·å–æœåŠ¡
    userService, ok := GetUserServiceFromContext(ctx)
    if !ok {
        return "", fmt.Errorf("user service not found")
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¹‚ç­‰æ€§ï¼‰
    existingUser, err := userService.GetUserByEmail(ctx, email)
    if err == nil && existingUser != nil {
        // ç”¨æˆ·å·²å­˜åœ¨ï¼Œè¿”å›ç°æœ‰ç”¨æˆ· IDï¼ˆå¹‚ç­‰æ€§ï¼‰
        return existingUser.ID, nil
    }

    // åˆ›å»ºç”¨æˆ·
    user, err := userService.CreateUser(ctx, appuser.CreateUserRequest{
        Email: email,
        Name:  name,
    })
    if err != nil {
        return "", fmt.Errorf("failed to create user: %w", err)
    }

    return user.ID, nil
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **å¹‚ç­‰æ€§**: æ´»åŠ¨åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ
2. **å•ä¸€èŒè´£**: æ¯ä¸ªæ´»åŠ¨åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
3. **é”™è¯¯å¤„ç†**: è¿”å›æ˜ç¡®çš„é”™è¯¯ç±»å‹ï¼Œä¾¿äºå·¥ä½œæµå¤„ç†
4. **è¶…æ—¶å¤„ç†**: åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡

##### 4.1.4.3 Worker é…ç½®æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦åˆç†çš„ Worker é…ç½®ï¼Ÿ**

åˆç†çš„ Worker é…ç½®å¯ä»¥æé«˜ Worker çš„æ€§èƒ½å’Œå¯é æ€§ã€‚

**Worker é…ç½®åŸåˆ™**:

1. **Task Queue åˆ’åˆ†**: æ ¹æ®ä¸šåŠ¡ç‰¹æ€§åˆ’åˆ† Task Queue
2. **Worker æ•°é‡**: æ ¹æ®è´Ÿè½½é…ç½® Worker æ•°é‡
3. **æ´»åŠ¨æ³¨å†Œ**: åªæ³¨å†Œéœ€è¦çš„æ´»åŠ¨
4. **é”™è¯¯å¤„ç†**: é…ç½® Worker çº§åˆ«çš„é”™è¯¯å¤„ç†

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// Worker é…ç½®æœ€ä½³å®è·µ
func NewWorker(client client.Client, taskQueue string) worker.Worker {
    w := worker.New(client, taskQueue, worker.Options{
        MaxConcurrentActivityExecutionSize: 100,  // æœ€å¤§å¹¶å‘æ´»åŠ¨æ•°
        MaxConcurrentWorkflowTaskSize:      10,   // æœ€å¤§å¹¶å‘å·¥ä½œæµä»»åŠ¡æ•°
        MaxConcurrentLocalActivitySize:     100,  // æœ€å¤§å¹¶å‘æœ¬åœ°æ´»åŠ¨æ•°
    })

    // æ³¨å†Œå·¥ä½œæµ
    w.RegisterWorkflow(appworkflow.UserWorkflow)
    w.RegisterWorkflow(appworkflow.OrderWorkflow)

    // æ³¨å†Œæ´»åŠ¨
    w.RegisterActivity(appworkflow.ValidateUserActivity)
    w.RegisterActivity(appworkflow.CreateUserActivity)
    w.RegisterActivity(appworkflow.SendNotificationActivity)

    return w
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **Task Queue åˆ’åˆ†**: æ ¹æ®ä¸šåŠ¡ç‰¹æ€§åˆ’åˆ† Task Queueï¼Œå®ç°ä»»åŠ¡éš”ç¦»
2. **Worker æ•°é‡**: æ ¹æ®è´Ÿè½½é…ç½® Worker æ•°é‡ï¼Œå®ç°è´Ÿè½½å‡è¡¡
3. **æ´»åŠ¨æ³¨å†Œ**: åªæ³¨å†Œéœ€è¦çš„æ´»åŠ¨ï¼Œå‡å°‘å†…å­˜å ç”¨
4. **å¹¶å‘é…ç½®**: åˆç†é…ç½®å¹¶å‘å‚æ•°ï¼Œé¿å…èµ„æºè€—å°½

**è¯¦ç»†å®ç°è¯·å‚è€ƒ**: [å·¥ä½œæµæ¶æ„è®¾è®¡](./workflow.md)

---

## 5. ğŸ“Š å¯è§‚æµ‹æ€§å±‚

### 5.1 OpenTelemetry

#### 5.1.1 æ ¸å¿ƒç‰¹æ€§

**OpenTelemetry æ˜¯ä»€ä¹ˆï¼Ÿ**

OpenTelemetry æ˜¯ä¸€ä¸ªå‚å•†ä¸­ç«‹çš„å¼€æºå¯è§‚æµ‹æ€§æ¡†æ¶ï¼Œæä¾›ç»Ÿä¸€çš„ APIã€SDK å’Œæ•°æ®æ ¼å¼ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **ç»Ÿä¸€æ ‡å‡†**: ç»Ÿä¸€çš„ API å’Œæ•°æ®æ ¼å¼
- âœ… **è·¨è¯­è¨€**: æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€
- âœ… **å¯æ’æ‹”**: æ”¯æŒå¤šç§åç«¯ï¼ˆJaeger, Prometheus ç­‰ï¼‰
- âœ… **è¿½è¸ªã€æŒ‡æ ‡ã€æ—¥å¿—**: æ”¯æŒä¸‰ç§å¯è§‚æµ‹æ€§æ•°æ®

#### 5.1.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© OpenTelemetryï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | OpenTelemetry | Prometheus | Jaeger | Zipkin | è¯´æ˜ |
|---------|------|---------------|------------|--------|--------|------|
| **åŠŸèƒ½å®Œæ•´æ€§** | 30% | 10 | 5 | 5 | 5 | OpenTelemetry æ”¯æŒä¸‰æ”¯æŸ± |
| **æ ‡å‡†å…¼å®¹** | 25% | 10 | 6 | 7 | 7 | OpenTelemetry æ˜¯è¡Œä¸šæ ‡å‡† |
| **åç«¯é€‰æ‹©** | 20% | 10 | 7 | 6 | 6 | OpenTelemetry åç«¯çµæ´» |
| **é›†æˆå¤æ‚åº¦** | 15% | 8 | 8 | 7 | 7 | OpenTelemetry é›†æˆç®€å• |
| **ç¤¾åŒºæ”¯æŒ** | 10% | 9 | 10 | 8 | 7 | OpenTelemetry ç¤¾åŒºæ´»è·ƒ |
| **åŠ æƒæ€»åˆ†** | - | **9.35** | 6.80 | 6.50 | 6.30 | OpenTelemetry å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **åŠŸèƒ½å®Œæ•´æ€§ï¼ˆæƒé‡ 30%ï¼‰**:
   - æ”¯æŒè¿½è¸ªã€æŒ‡æ ‡ã€æ—¥å¿—ä¸‰å¤§æ”¯æŸ±
   - ç»Ÿä¸€çš„å¯è§‚æµ‹æ€§è§£å†³æ–¹æ¡ˆ
   - é¿å…å¤šå¥—ç³»ç»Ÿé›†æˆ

2. **æ ‡å‡†å…¼å®¹ï¼ˆæƒé‡ 25%ï¼‰**:
   - è¡Œä¸šæ ‡å‡†ï¼Œç»Ÿä¸€æ¥å£
   - å¯ä»¥è½»æ¾åˆ‡æ¢åç«¯
   - æœªæ¥å…¼å®¹æ€§å¥½

3. **åç«¯é€‰æ‹©ï¼ˆæƒé‡ 20%ï¼‰**:
   - å¯ä»¥å¯¼å‡ºåˆ°å¤šç§åç«¯ï¼ˆPrometheus, Jaeger, Zipkin ç­‰ï¼‰
   - ä¸é”å®šç‰¹å®šå‚å•†
   - çµæ´»çš„åç«¯é€‰æ‹©

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–å¯è§‚æµ‹æ€§æ–¹æ¡ˆï¼Ÿ**

1. **Prometheus**:
   - âœ… ç›‘æ§æ ‡å‡†ï¼ŒåŠŸèƒ½å¼ºå¤§
   - âŒ åªæ”¯æŒæŒ‡æ ‡ï¼Œä¸æ”¯æŒè¿½è¸ªå’Œæ—¥å¿—
   - âŒ éœ€è¦ä¸å…¶ä»–å·¥å…·é›†æˆ

2. **Jaeger**:
   - âœ… åˆ†å¸ƒå¼è¿½è¸ªåŠŸèƒ½å¼ºå¤§
   - âŒ åªæ”¯æŒè¿½è¸ªï¼Œä¸æ”¯æŒæŒ‡æ ‡å’Œæ—¥å¿—
   - âŒ éœ€è¦ä¸å…¶ä»–å·¥å…·é›†æˆ

3. **Zipkin**:
   - âœ… è½»é‡çº§ï¼Œæ˜“äºéƒ¨ç½²
   - âŒ åªæ”¯æŒè¿½è¸ªï¼ŒåŠŸèƒ½æœ‰é™
   - âŒ ä¸ OpenTelemetry é›†æˆä¸å¦‚ Jaeger

**è¯¦ç»†è®ºè¯è¯·å‚è€ƒ**: [æŠ€æœ¯å¯¹æ¯”çŸ©é˜µ](./00-å¯¹æ¯”çŸ©é˜µ.md#44-é€‰å‹å†³ç­–è®ºè¯)

#### 5.1.3 å®é™…åº”ç”¨

##### 5.1.3.1 è¿½è¸ªé›†æˆ

**åˆå§‹åŒ–è¿½è¸ª**:

```go
// internal/infrastructure/observability/tracing.go
package observability

import (
    "context"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/resource"
    "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.4.0"
)

func InitTracing(ctx context.Context, endpoint string) (*trace.TracerProvider, error) {
    // åˆ›å»ºèµ„æº
    res, err := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceNameKey.String("golang-service"),
            semconv.ServiceVersionKey.String("1.0.0"),
        ),
    )
    if err != nil {
        return nil, err
    }

    // åˆ›å»ºå¯¼å‡ºå™¨
    exporter, err := otlptracegrpc.New(ctx,
        otlptracegrpc.WithEndpoint(endpoint),
        otlptracegrpc.WithInsecure(),
    )
    if err != nil {
        return nil, err
    }

    // åˆ›å»º TracerProvider
    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
        trace.WithResource(res),
        trace.WithSampler(trace.AlwaysSample()),
    )

    // è®¾ç½®ä¸ºå…¨å±€ TracerProvider
    otel.SetTracerProvider(tp)

    return tp, nil
}
```

**åœ¨ä»£ç ä¸­ä½¿ç”¨è¿½è¸ª**:

```go
// åœ¨ HTTP Handler ä¸­ä½¿ç”¨
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    ctx, span := tracer.Start(r.Context(), "user.create")
    defer span.End()

    span.SetAttributes(
        attribute.String("user.email", req.Email),
        attribute.String("user.name", req.Name),
    )

    user, err := h.service.CreateUser(ctx, req)
    if err != nil {
        span.RecordError(err)
        span.SetStatus(codes.Error, err.Error())
        Error(w, http.StatusInternalServerError, err)
        return
    }

    span.SetAttributes(attribute.String("user.id", user.ID))
    Success(w, http.StatusCreated, user)
}

// åœ¨æ•°æ®åº“æ“ä½œä¸­ä½¿ç”¨
func (r *UserRepository) Create(ctx context.Context, user *User) error {
    ctx, span := tracer.Start(ctx, "db.user.create")
    defer span.End()

    span.SetAttributes(
        attribute.String("db.system", "postgresql"),
        attribute.String("db.operation", "create"),
    )

    // æ‰§è¡Œæ•°æ®åº“æ“ä½œ
    err := r.client.User.Create().
        SetEmail(user.Email).
        SetName(user.Name).
        Exec(ctx)

    if err != nil {
        span.RecordError(err)
        span.SetStatus(codes.Error, err.Error())
        return err
    }

    return nil
}
```

##### 5.1.3.2 æŒ‡æ ‡æ”¶é›†

**åˆå§‹åŒ–æŒ‡æ ‡**:

```go
// internal/infrastructure/observability/metrics.go
package observability

import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetricgrpc"
    "go.opentelemetry.io/otel/sdk/metric"
    "go.opentelemetry.io/otel/sdk/resource"
)

func InitMetrics(ctx context.Context, endpoint string) (*metric.MeterProvider, error) {
    // åˆ›å»ºèµ„æº
    res, err := resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceNameKey.String("golang-service"),
        ),
    )
    if err != nil {
        return nil, err
    }

    // åˆ›å»ºå¯¼å‡ºå™¨
    exporter, err := otlpmetricgrpc.New(ctx,
        otlpmetricgrpc.WithEndpoint(endpoint),
        otlpmetricgrpc.WithInsecure(),
    )
    if err != nil {
        return nil, err
    }

    // åˆ›å»º MeterProvider
    mp := metric.NewMeterProvider(
        metric.WithReader(metric.NewPeriodicReader(exporter)),
        metric.WithResource(res),
    )

    // è®¾ç½®ä¸ºå…¨å±€ MeterProvider
    otel.SetMeterProvider(mp)

    return mp, nil
}
```

**ä½¿ç”¨æŒ‡æ ‡**:

```go
// å®šä¹‰æŒ‡æ ‡
var (
    requestCounter metric.Int64Counter
    requestDuration metric.Float64Histogram
)

func init() {
    meter := otel.Meter("golang-service")

    requestCounter, _ = meter.Int64Counter(
        "http_requests_total",
        metric.WithDescription("Total number of HTTP requests"),
    )

    requestDuration, _ = meter.Float64Histogram(
        "http_request_duration_seconds",
        metric.WithDescription("HTTP request duration in seconds"),
    )
}

// åœ¨ Handler ä¸­ä½¿ç”¨æŒ‡æ ‡
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    start := time.Now()

    // å¢åŠ è®¡æ•°å™¨
    requestCounter.Add(r.Context(), 1,
        attribute.String("method", r.Method),
        attribute.String("path", r.URL.Path),
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(r.Context(), req)

    // è®°å½•æŒç»­æ—¶é—´
    duration := time.Since(start).Seconds()
    requestDuration.Record(r.Context(), duration,
        attribute.String("method", r.Method),
        attribute.String("path", r.URL.Path),
        attribute.String("status", getStatus(err)),
    )

    // å¤„ç†å“åº”
    if err != nil {
        Error(w, http.StatusInternalServerError, err)
        return
    }
    Success(w, http.StatusCreated, user)
}
```

##### 5.1.3.3 æ—¥å¿—é›†æˆ

**ç»“æ„åŒ–æ—¥å¿—é›†æˆ**:

```go
// internal/infrastructure/observability/logging.go
package observability

import (
    "go.opentelemetry.io/otel/attribute"
    "go.opentelemetry.io/otel/trace"
    "log/slog"
)

// LogHandler é›†æˆ OpenTelemetry çš„æ—¥å¿—å¤„ç†å™¨
type LogHandler struct {
    handler slog.Handler
}

func NewLogHandler(handler slog.Handler) *LogHandler {
    return &LogHandler{handler: handler}
}

func (h *LogHandler) Handle(ctx context.Context, r slog.Record) error {
    // ä»ä¸Šä¸‹æ–‡è·å–è¿½è¸ªä¿¡æ¯
    span := trace.SpanFromContext(ctx)
    if span.IsRecording() {
        spanCtx := span.SpanContext()
        if spanCtx.IsValid() {
            r.AddAttrs(
                slog.String("trace_id", spanCtx.TraceID().String()),
                slog.String("span_id", spanCtx.SpanID().String()),
            )
        }
    }

    return h.handler.Handle(ctx, r)
}

// ä½¿ç”¨ç¤ºä¾‹
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    logger := slog.Default().With(
        "method", r.Method,
        "path", r.URL.Path,
    )

    logger.InfoContext(r.Context(), "Creating user",
        "email", req.Email,
        "name", req.Name,
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(r.Context(), req)

    if err != nil {
        logger.ErrorContext(r.Context(), "Failed to create user",
            "error", err,
        )
        Error(w, http.StatusInternalServerError, err)
        return
    }

    logger.InfoContext(r.Context(), "User created successfully",
        "user_id", user.ID,
    )
    Success(w, http.StatusCreated, user)
}
```

##### 5.1.3.4 ä¸Šä¸‹æ–‡ä¼ æ’­

**ä¸Šä¸‹æ–‡ä¼ æ’­ç¤ºä¾‹**:

```go
// åœ¨ HTTP è¯·æ±‚ä¸­ä¼ æ’­ä¸Šä¸‹æ–‡
func TracingMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // ä» HTTP Header æå–è¿½è¸ªä¿¡æ¯
        ctx := otel.GetTextMapPropagator().Extract(r.Context(), propagation.HeaderCarrier(r.Header))

        // åˆ›å»ºæ–°çš„ Span
        ctx, span := tracer.Start(ctx, r.URL.Path)
        defer span.End()

        // å°†ä¸Šä¸‹æ–‡ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Handler
        next.ServeHTTP(w, r.WithContext(ctx))
    })
}

// åœ¨ gRPC ä¸­ä¼ æ’­ä¸Šä¸‹æ–‡
func UnaryServerInterceptor(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {
    // ä» gRPC Metadata æå–è¿½è¸ªä¿¡æ¯
    md, _ := metadata.FromIncomingContext(ctx)
    ctx = otel.GetTextMapPropagator().Extract(ctx, propagation.NewGRPCFieldsCarrier(md))

    // åˆ›å»ºæ–°çš„ Span
    ctx, span := tracer.Start(ctx, info.FullMethod)
    defer span.End()

    // è°ƒç”¨å¤„ç†å‡½æ•°
    resp, err := handler(ctx, req)

    if err != nil {
        span.RecordError(err)
        span.SetStatus(codes.Error, err.Error())
    }

    return resp, err
}
```

##### 5.1.3.5 é‡‡æ ·ç­–ç•¥é…ç½®

**é‡‡æ ·ç­–ç•¥é…ç½®**:

```go
// é…ç½®é‡‡æ ·ç­–ç•¥
func NewTracerProviderWithSampling(ctx context.Context, endpoint string, sampleRate float64) (*trace.TracerProvider, error) {
    // åˆ›å»ºé‡‡æ ·å™¨
    sampler := trace.TraceIDRatioBased(sampleRate)

    // æˆ–è€…ä½¿ç”¨çˆ¶é‡‡æ ·å™¨
    sampler = trace.ParentBased(sampler)

    // åˆ›å»º TracerProvider
    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
        trace.WithResource(res),
        trace.WithSampler(sampler),
    )

    return tp, nil
}

// ä½¿ç”¨ç¤ºä¾‹
// ç”Ÿäº§ç¯å¢ƒï¼šé‡‡æ ·ç‡ 10%
tp, _ := NewTracerProviderWithSampling(ctx, endpoint, 0.1)

// å¼€å‘ç¯å¢ƒï¼šé‡‡æ ·ç‡ 100%
tp, _ := NewTracerProviderWithSampling(ctx, endpoint, 1.0)
```

##### 5.1.3.6 èµ„æºå±æ€§é…ç½®

**èµ„æºå±æ€§é…ç½®**:

```go
// é…ç½®èµ„æºå±æ€§
func NewResource(ctx context.Context) (*resource.Resource, error) {
    return resource.New(ctx,
        resource.WithAttributes(
            semconv.ServiceNameKey.String("golang-service"),
            semconv.ServiceVersionKey.String("1.0.0"),
            semconv.ServiceNamespaceKey.String("production"),
            attribute.String("environment", "production"),
            attribute.String("deployment.environment", "production"),
        ),
        resource.WithProcessRuntimeDescription(),
        resource.WithProcessRuntimeName(),
        resource.WithProcessRuntimeVersion(),
    )
}
```

#### 5.1.4 æœ€ä½³å®è·µ

##### 5.1.4.1 è¿½è¸ªæœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è¿½è¸ªï¼Ÿ**

è¿½è¸ªå¯ä»¥å¸®åŠ©ç†è§£è¯·æ±‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å®Œæ•´è°ƒç”¨é“¾ï¼Œè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œæ•…éšœç‚¹ã€‚

**è¿½è¸ªæœ€ä½³å®è·µ**:

1. **Span å‘½å**: ä½¿ç”¨æ¸…æ™°çš„ Span åç§°ï¼Œå¦‚ "user.create"ã€"db.query"
2. **å±æ€§è®¾ç½®**: è®¾ç½®æœ‰æ„ä¹‰çš„å±æ€§ï¼Œå¦‚ç”¨æˆ· IDã€è¯·æ±‚å‚æ•°
3. **é”™è¯¯è®°å½•**: ä½¿ç”¨ `span.RecordError()` è®°å½•é”™è¯¯
4. **é‡‡æ ·ç­–ç•¥**: æ ¹æ®ç¯å¢ƒé…ç½®åˆé€‚çš„é‡‡æ ·ç‡

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// è¿½è¸ªæœ€ä½³å®è·µ
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    ctx, span := tracer.Start(r.Context(), "user.create")
    defer span.End()

    // è®¾ç½®å±æ€§
    span.SetAttributes(
        attribute.String("user.email", req.Email),
        attribute.String("user.name", req.Name),
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(ctx, req)

    if err != nil {
        // è®°å½•é”™è¯¯
        span.RecordError(err)
        span.SetStatus(codes.Error, err.Error())
        Error(w, http.StatusInternalServerError, err)
        return
    }

    // è®¾ç½®æˆåŠŸå±æ€§
    span.SetAttributes(attribute.String("user.id", user.ID))
    span.SetStatus(codes.Ok, "User created successfully")
    Success(w, http.StatusCreated, user)
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **Span å‘½å**: ä½¿ç”¨æ¸…æ™°çš„ã€æœ‰æ„ä¹‰çš„ Span åç§°
2. **å±æ€§è®¾ç½®**: è®¾ç½®æœ‰åŠ©äºè°ƒè¯•å’Œç›‘æ§çš„å±æ€§
3. **é”™è¯¯è®°å½•**: ä½¿ç”¨ `span.RecordError()` è®°å½•é”™è¯¯
4. **é‡‡æ ·ç­–ç•¥**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¾ƒä½çš„é‡‡æ ·ç‡ï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨ 100% é‡‡æ ·

##### 5.1.4.2 æŒ‡æ ‡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦æŒ‡æ ‡ï¼Ÿ**

æŒ‡æ ‡å¯ä»¥å¸®åŠ©ç›‘æ§ç³»ç»Ÿæ€§èƒ½ã€è¯†åˆ«è¶‹åŠ¿å’Œå¼‚å¸¸ã€‚

**æŒ‡æ ‡æœ€ä½³å®è·µ**:

1. **æŒ‡æ ‡å‘½å**: ä½¿ç”¨æ ‡å‡†çš„æŒ‡æ ‡å‘½åè§„èŒƒ
2. **æ ‡ç­¾é€‰æ‹©**: é€‰æ‹©æœ‰æ„ä¹‰çš„æ ‡ç­¾ï¼Œé¿å…é«˜åŸºæ•°æ ‡ç­¾
3. **æŒ‡æ ‡ç±»å‹**: æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æŒ‡æ ‡ç±»å‹ï¼ˆCounterã€Gaugeã€Histogramï¼‰
4. **èšåˆç­–ç•¥**: åˆç†è®¾ç½®èšåˆç­–ç•¥

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æŒ‡æ ‡æœ€ä½³å®è·µ
var (
    httpRequestsTotal = metric.Int64Counter(
        "http_requests_total",
        metric.WithDescription("Total number of HTTP requests"),
    )

    httpRequestDuration = metric.Float64Histogram(
        "http_request_duration_seconds",
        metric.WithDescription("HTTP request duration in seconds"),
        metric.WithUnit("s"),
    )
)

func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    start := time.Now()

    // å¢åŠ è®¡æ•°å™¨
    httpRequestsTotal.Add(r.Context(), 1,
        attribute.String("method", r.Method),
        attribute.String("path", r.URL.Path),
        attribute.String("status", "pending"),
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(r.Context(), req)

    // è®°å½•æŒç»­æ—¶é—´
    duration := time.Since(start).Seconds()
    status := "success"
    if err != nil {
        status = "error"
    }

    httpRequestDuration.Record(r.Context(), duration,
        attribute.String("method", r.Method),
        attribute.String("path", r.URL.Path),
        attribute.String("status", status),
    )

    // å¤„ç†å“åº”
    if err != nil {
        Error(w, http.StatusInternalServerError, err)
        return
    }
    Success(w, http.StatusCreated, user)
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **æŒ‡æ ‡å‘½å**: ä½¿ç”¨æ ‡å‡†çš„æŒ‡æ ‡å‘½åè§„èŒƒï¼ˆå¦‚ Prometheus è§„èŒƒï¼‰
2. **æ ‡ç­¾é€‰æ‹©**: é€‰æ‹©æœ‰æ„ä¹‰çš„æ ‡ç­¾ï¼Œé¿å…é«˜åŸºæ•°æ ‡ç­¾ï¼ˆå¦‚ç”¨æˆ· IDï¼‰
3. **æŒ‡æ ‡ç±»å‹**: æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æŒ‡æ ‡ç±»å‹
4. **å•ä½è®¾ç½®**: ä¸ºæŒ‡æ ‡è®¾ç½®åˆé€‚çš„å•ä½

##### 5.1.4.3 æ—¥å¿—æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦ç»“æ„åŒ–æ—¥å¿—ï¼Ÿ**

ç»“æ„åŒ–æ—¥å¿—å¯ä»¥æé«˜æ—¥å¿—çš„å¯è¯»æ€§å’Œå¯æŸ¥è¯¢æ€§ï¼Œä¾¿äºæ—¥å¿—åˆ†æå’Œé—®é¢˜æ’æŸ¥ã€‚

**æ—¥å¿—æœ€ä½³å®è·µ**:

1. **ç»“æ„åŒ–æ—¥å¿—**: ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆJSONï¼‰
2. **æ—¥å¿—çº§åˆ«**: åˆç†ä½¿ç”¨æ—¥å¿—çº§åˆ«ï¼ˆDEBUGã€INFOã€WARNã€ERRORï¼‰
3. **ä¸Šä¸‹æ–‡ä¿¡æ¯**: åœ¨æ—¥å¿—ä¸­åŒ…å«è¿½è¸ªä¿¡æ¯ï¼ˆTraceIDã€SpanIDï¼‰
4. **æ•æ„Ÿä¿¡æ¯**: é¿å…åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æ—¥å¿—æœ€ä½³å®è·µ
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    logger := slog.Default().With(
        "method", r.Method,
        "path", r.URL.Path,
        "request_id", middleware.GetReqID(r.Context()),
    )

    // ä»ä¸Šä¸‹æ–‡è·å–è¿½è¸ªä¿¡æ¯
    span := trace.SpanFromContext(r.Context())
    if span.SpanContext().IsValid() {
        logger = logger.With(
            "trace_id", span.SpanContext().TraceID().String(),
            "span_id", span.SpanContext().SpanID().String(),
        )
    }

    logger.InfoContext(r.Context(), "Creating user",
        "email", req.Email,
        "name", req.Name,
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(r.Context(), req)

    if err != nil {
        logger.ErrorContext(r.Context(), "Failed to create user",
            "error", err.Error(),
        )
        Error(w, http.StatusInternalServerError, err)
        return
    }

    logger.InfoContext(r.Context(), "User created successfully",
        "user_id", user.ID,
    )
    Success(w, http.StatusCreated, user)
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ç»“æ„åŒ–æ—¥å¿—**: ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼Œä¾¿äºæ—¥å¿—åˆ†æ
2. **æ—¥å¿—çº§åˆ«**: åˆç†ä½¿ç”¨æ—¥å¿—çº§åˆ«ï¼Œé¿å…è¿‡åº¦æ—¥å¿—
3. **ä¸Šä¸‹æ–‡ä¿¡æ¯**: åœ¨æ—¥å¿—ä¸­åŒ…å«è¿½è¸ªä¿¡æ¯ï¼Œä¾¿äºå…³è”
4. **æ•æ„Ÿä¿¡æ¯**: é¿å…åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€Tokenï¼‰

---

### 5.2 Prometheus

#### 5.2.1 æ ¸å¿ƒç‰¹æ€§

**Prometheus æ˜¯ä»€ä¹ˆï¼Ÿ**

Prometheus æ˜¯ä¸€ä¸ªå¼€æºçš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **æŒ‡æ ‡æ”¶é›†**: æ‹‰å–æ¨¡å‹æ”¶é›†æŒ‡æ ‡
- âœ… **æŸ¥è¯¢è¯­è¨€**: PromQL æŸ¥è¯¢è¯­è¨€
- âœ… **å‘Šè­¦**: æ”¯æŒå‘Šè­¦è§„åˆ™
- âœ… **å¯è§†åŒ–**: æ”¯æŒ Grafana é›†æˆ

#### 5.2.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Prometheusï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Prometheus | InfluxDB | Graphite | Datadog | è¯´æ˜ |
|---------|------|-----------|----------|----------|---------|------|
| **æ ‡å‡†å…¼å®¹** | 30% | 10 | 7 | 6 | 8 | Prometheus æ˜¯äº‹å®æ ‡å‡† |
| **æ€§èƒ½** | 25% | 9 | 10 | 7 | 8 | Prometheus æ€§èƒ½ä¼˜ç§€ |
| **ç”Ÿæ€é›†æˆ** | 20% | 10 | 7 | 6 | 9 | Prometheus ç”Ÿæ€æœ€ä¸°å¯Œ |
| **å­¦ä¹ æˆæœ¬** | 15% | 8 | 7 | 8 | 6 | Prometheus å­¦ä¹ æ›²çº¿é€‚ä¸­ |
| **æˆæœ¬** | 10% | 10 | 8 | 9 | 3 | Prometheus å¼€æºå…è´¹ |
| **åŠ æƒæ€»åˆ†** | - | **9.30** | 7.90 | 7.05 | 7.20 | Prometheus å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **æ ‡å‡†å…¼å®¹æ€§ï¼ˆæƒé‡ 30%ï¼‰**:
   - Prometheus æ˜¯äº‹å®ä¸Šçš„ç›‘æ§æ ‡å‡†ï¼ŒPromQL è¢«å¹¿æ³›é‡‡ç”¨
   - ä¸ OpenTelemetry é›†æˆè‰¯å¥½ï¼Œæ”¯æŒ OTLP åè®®
   - ä¸ Grafana é›†æˆå®Œç¾ï¼Œç”Ÿæ€æˆç†Ÿ

2. **ç”Ÿæ€é›†æˆï¼ˆæƒé‡ 20%ï¼‰**:
   - ä¸°å¯Œçš„ Exporter ç”Ÿæ€ï¼Œæ”¯æŒå„ç§ç³»ç»Ÿç›‘æ§
   - ä¸ Kubernetes é›†æˆè‰¯å¥½ï¼Œæ˜¯äº‘åŸç”Ÿç›‘æ§æ ‡å‡†
   - ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£å®Œå–„

3. **æˆæœ¬ï¼ˆæƒé‡ 10%ï¼‰**:
   - å®Œå…¨å¼€æºå…è´¹ï¼Œæ— æˆæƒæˆæœ¬
   - è‡ªæ‰˜ç®¡ï¼Œæ•°æ®å¯æ§
   - é€‚åˆä¸­å°å‹é¡¹ç›®

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–ç›‘æ§ç³»ç»Ÿï¼Ÿ**

1. **InfluxDB**:
   - âœ… æ—¶åºæ•°æ®åº“æ€§èƒ½ä¼˜ç§€
   - âŒ ç›‘æ§ç”Ÿæ€ä¸å¦‚ Prometheus ä¸°å¯Œ
   - âŒ å­¦ä¹ æˆæœ¬è¾ƒé«˜
   - âŒ ä¸ OpenTelemetry é›†æˆä¸å¦‚ Prometheus

2. **Graphite**:
   - âœ… ç®€å•æ˜“ç”¨
   - âŒ åŠŸèƒ½ç›¸å¯¹ç®€å•
   - âŒ ç”Ÿæ€ä¸å¦‚ Prometheus ä¸°å¯Œ
   - âŒ æ€§èƒ½ä¸å¦‚ Prometheus

3. **Datadog**:
   - âœ… åŠŸèƒ½å®Œå–„ï¼ŒSaaS æœåŠ¡
   - âŒ æˆæœ¬é«˜ï¼Œä¸é€‚åˆä¸­å°å‹é¡¹ç›®
   - âŒ æ•°æ®å­˜å‚¨åœ¨ç¬¬ä¸‰æ–¹ï¼Œéšç§æ€§å·®
   - âŒ ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œå¯ç”¨æ€§å—é™äºæœåŠ¡å•†

#### 5.2.3 å®é™…åº”ç”¨

##### 5.2.3.1 æŒ‡æ ‡å®šä¹‰å’Œæš´éœ²

**å®šä¹‰æŒ‡æ ‡**:

```go
// internal/infrastructure/observability/prometheus.go
package observability

import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    // HTTP è¯·æ±‚è®¡æ•°å™¨
    httpRequestsTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "path", "status"},
    )

    // HTTP è¯·æ±‚æŒç»­æ—¶é—´ç›´æ–¹å›¾
    httpRequestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request duration in seconds",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "path", "status"},
    )

    // æ´»è·ƒè¿æ¥æ•°
    activeConnections = promauto.NewGauge(
        prometheus.GaugeOpts{
            Name: "active_connections",
            Help: "Number of active connections",
        },
    )
)
```

**æš´éœ²æŒ‡æ ‡ç«¯ç‚¹**:

```go
// æš´éœ² Prometheus æŒ‡æ ‡
import (
    "net/http"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

func NewRouter() *chi.Mux {
    r := chi.NewRouter()

    // Prometheus æŒ‡æ ‡ç«¯ç‚¹
    r.Handle("/metrics", promhttp.Handler())

    // å…¶ä»–è·¯ç”±
    r.Route("/api/v1", func(r chi.Router) {
        r.Mount("/users", userRoutes())
    })

    return r
}
```

##### 5.2.3.2 åœ¨ä»£ç ä¸­ä½¿ç”¨æŒ‡æ ‡

**åœ¨ Handler ä¸­ä½¿ç”¨æŒ‡æ ‡**:

```go
// åœ¨ Handler ä¸­ä½¿ç”¨æŒ‡æ ‡
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    start := time.Now()

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(r.Context(), req)

    // è®°å½•æŒ‡æ ‡
    duration := time.Since(start).Seconds()
    status := "success"
    if err != nil {
        status = "error"
    }

    httpRequestsTotal.WithLabelValues(r.Method, r.URL.Path, status).Inc()
    httpRequestDuration.WithLabelValues(r.Method, r.URL.Path, status).Observe(duration)

    // å¤„ç†å“åº”
    if err != nil {
        Error(w, http.StatusInternalServerError, err)
        return
    }
    Success(w, http.StatusCreated, user)
}
```

##### 5.2.3.3 å‘Šè­¦è§„åˆ™é…ç½®

**å‘Šè­¦è§„åˆ™é…ç½®**:

```yaml
# configs/prometheus/alerts.yml
groups:
  - name: http_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status="error"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"

      - alert: HighLatency
        expr: histogram_quantile(0.95, http_request_duration_seconds) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          description: "95th percentile latency is {{ $value }} seconds"
```

##### 5.2.3.4 æœåŠ¡å‘ç°é…ç½®

**æœåŠ¡å‘ç°é…ç½®**:

```yaml
# configs/prometheus/prometheus.yml
scrape_configs:
  - job_name: 'golang-service'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'
    scrape_interval: 15s
    scrape_timeout: 10s
```

#### 5.2.4 æœ€ä½³å®è·µ

##### 5.2.4.1 æŒ‡æ ‡è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„æŒ‡æ ‡è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„æŒ‡æ ‡è®¾è®¡å¯ä»¥æé«˜ç›‘æ§çš„æœ‰æ•ˆæ€§ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

**æŒ‡æ ‡è®¾è®¡åŸåˆ™**:

1. **æŒ‡æ ‡å‘½å**: ä½¿ç”¨æ¸…æ™°çš„ã€æœ‰æ„ä¹‰çš„æŒ‡æ ‡åç§°
2. **æ ‡ç­¾é€‰æ‹©**: é€‰æ‹©æœ‰æ„ä¹‰çš„æ ‡ç­¾ï¼Œé¿å…é«˜åŸºæ•°æ ‡ç­¾
3. **æŒ‡æ ‡ç±»å‹**: æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æŒ‡æ ‡ç±»å‹ï¼ˆCounterã€Gaugeã€Histogramï¼‰
4. **å•ä½ç»Ÿä¸€**: ä½¿ç”¨ç»Ÿä¸€çš„å•ä½

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æŒ‡æ ‡è®¾è®¡æœ€ä½³å®è·µ
var (
    // Counter: ç´¯è®¡å€¼ï¼Œåªå¢ä¸å‡
    httpRequestsTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "path", "status"}, // ä½åŸºæ•°æ ‡ç­¾
    )

    // Gauge: å½“å‰å€¼ï¼Œå¯å¢å¯å‡
    activeConnections = promauto.NewGauge(
        prometheus.GaugeOpts{
            Name: "active_connections",
            Help: "Number of active connections",
        },
    )

    // Histogram: åˆ†å¸ƒå€¼
    httpRequestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request duration in seconds",
            Buckets: []float64{0.1, 0.5, 1, 2, 5, 10}, // è‡ªå®šä¹‰æ¡¶
        },
        []string{"method", "path"},
    )
)
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **æŒ‡æ ‡å‘½å**: ä½¿ç”¨æ ‡å‡†çš„å‘½åè§„èŒƒï¼ˆå¦‚ `http_requests_total`ï¼‰
2. **æ ‡ç­¾é€‰æ‹©**: é¿å…é«˜åŸºæ•°æ ‡ç­¾ï¼ˆå¦‚ç”¨æˆ· IDï¼‰ï¼Œä½¿ç”¨ä½åŸºæ•°æ ‡ç­¾ï¼ˆå¦‚çŠ¶æ€ç ï¼‰
3. **æŒ‡æ ‡ç±»å‹**: æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æŒ‡æ ‡ç±»å‹
4. **å•ä½ç»Ÿä¸€**: ä½¿ç”¨ç»Ÿä¸€çš„å•ä½ï¼ˆå¦‚ç§’ã€å­—èŠ‚ï¼‰

##### 5.2.4.2 å‘Šè­¦è§„åˆ™æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦å‘Šè­¦è§„åˆ™ï¼Ÿ**

å‘Šè­¦è§„åˆ™å¯ä»¥å¸®åŠ©åŠæ—¶å‘ç°ç³»ç»Ÿé—®é¢˜ï¼Œå‡å°‘æ•…éšœå½±å“ã€‚

**å‘Šè­¦è§„åˆ™è®¾è®¡åŸåˆ™**:

1. **å‘Šè­¦é˜ˆå€¼**: è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
2. **å‘Šè­¦æŒç»­æ—¶é—´**: è®¾ç½®åˆç†çš„å‘Šè­¦æŒç»­æ—¶é—´ï¼Œé¿å…è¯¯æŠ¥
3. **å‘Šè­¦çº§åˆ«**: åŒºåˆ†ä¸åŒçº§åˆ«çš„å‘Šè­¦ï¼ˆcriticalã€warningï¼‰
4. **å‘Šè­¦ä¿¡æ¯**: æä¾›æ¸…æ™°çš„å‘Šè­¦ä¿¡æ¯

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```yaml
# å‘Šè­¦è§„åˆ™æœ€ä½³å®è·µ
groups:
  - name: service_alerts
    rules:
      # é”™è¯¯ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: rate(http_requests_total{status="error"}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}"

      # å»¶è¿Ÿå‘Šè­¦
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          description: "95th percentile latency is {{ $value }} seconds"
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **å‘Šè­¦é˜ˆå€¼**: æ ¹æ®å†å²æ•°æ®è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
2. **å‘Šè­¦æŒç»­æ—¶é—´**: è®¾ç½®åˆç†çš„æŒç»­æ—¶é—´ï¼Œé¿å…ç¬æ—¶æ³¢åŠ¨è§¦å‘å‘Šè­¦
3. **å‘Šè­¦çº§åˆ«**: åŒºåˆ†ä¸åŒçº§åˆ«çš„å‘Šè­¦ï¼Œä¼˜å…ˆå¤„ç† critical å‘Šè­¦
4. **å‘Šè­¦ä¿¡æ¯**: æä¾›æ¸…æ™°çš„å‘Šè­¦ä¿¡æ¯ï¼Œä¾¿äºå¿«é€Ÿå®šä½é—®é¢˜

---

### 5.3 Grafana

#### 5.3.1 æ ¸å¿ƒç‰¹æ€§

**Grafana æ˜¯ä»€ä¹ˆï¼Ÿ**

Grafana æ˜¯ä¸€ä¸ªå¼€æºçš„å¯è§†åŒ–å¹³å°ï¼Œç”¨äºç›‘æ§å’Œæ•°æ®åˆ†æã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **å¯è§†åŒ–**: ä¸°å¯Œçš„å¯è§†åŒ–å›¾è¡¨
- âœ… **æ•°æ®æº**: æ”¯æŒå¤šç§æ•°æ®æº
- âœ… **ä»ªè¡¨æ¿**: çµæ´»çš„ä»ªè¡¨æ¿é…ç½®
- âœ… **å‘Šè­¦**: æ”¯æŒå‘Šè­¦é€šçŸ¥

#### 5.3.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Grafanaï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Grafana | Kibana | DataDog | New Relic | è¯´æ˜ |
|---------|------|---------|--------|---------|-----------|------|
| **å¯è§†åŒ–èƒ½åŠ›** | 30% | 10 | 8 | 9 | 9 | Grafana å¯è§†åŒ–æœ€å¼ºå¤§ |
| **æ•°æ®æºæ”¯æŒ** | 25% | 10 | 7 | 8 | 7 | Grafana æ”¯æŒæœ€å¤šæ•°æ®æº |
| **Prometheus é›†æˆ** | 20% | 10 | 6 | 8 | 7 | Grafana ä¸ Prometheus é›†æˆæœ€å¥½ |
| **ç¤¾åŒºç”Ÿæ€** | 15% | 10 | 8 | 6 | 6 | Grafana ç¤¾åŒºæœ€æ´»è·ƒ |
| **æˆæœ¬** | 10% | 10 | 9 | 3 | 3 | Grafana å¼€æºå…è´¹ |
| **åŠ æƒæ€»åˆ†** | - | **9.80** | 7.50 | 7.20 | 7.00 | Grafana å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **å¯è§†åŒ–èƒ½åŠ›ï¼ˆæƒé‡ 30%ï¼‰**:
   - ä¸°å¯Œçš„å›¾è¡¨ç±»å‹ï¼Œæ”¯æŒè‡ªå®šä¹‰é¢æ¿
   - çµæ´»çš„ä»ªè¡¨æ¿é…ç½®ï¼Œæ”¯æŒå˜é‡å’Œæ¨¡æ¿
   - å®æ—¶æ•°æ®åˆ·æ–°ï¼Œæ”¯æŒæµå¼æ•°æ®

2. **æ•°æ®æºæ”¯æŒï¼ˆæƒé‡ 25%ï¼‰**:
   - æ”¯æŒ 100+ æ•°æ®æºï¼ŒåŒ…æ‹¬ Prometheusã€InfluxDBã€MySQL ç­‰
   - ç»Ÿä¸€çš„æ•°æ®æºæ¥å£ï¼Œæ˜“äºæ‰©å±•
   - æ”¯æŒå¤šæ•°æ®æºè”åˆæŸ¥è¯¢

3. **Prometheus é›†æˆï¼ˆæƒé‡ 20%ï¼‰**:
   - åŸç”Ÿæ”¯æŒ Prometheusï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼˜ç§€
   - æ”¯æŒ PromQLï¼ŒæŸ¥è¯¢è¯­æ³•ä¸€è‡´
   - ä¸ Prometheus ç”Ÿæ€å®Œç¾é›†æˆ

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–å¯è§†åŒ–å·¥å…·ï¼Ÿ**

1. **Kibana**:
   - âœ… ä¸ Elasticsearch é›†æˆå¥½
   - âŒ ä¸»è¦é¢å‘æ—¥å¿—åˆ†æï¼Œç›‘æ§åŠŸèƒ½æœ‰é™
   - âŒ ä¸ Prometheus é›†æˆä¸å¦‚ Grafana
   - âŒ å¯è§†åŒ–èƒ½åŠ›ä¸å¦‚ Grafana

2. **DataDog**:
   - âœ… åŠŸèƒ½å®Œå–„ï¼ŒSaaS æœåŠ¡
   - âŒ æˆæœ¬é«˜ï¼Œä¸é€‚åˆä¸­å°å‹é¡¹ç›®
   - âŒ æ•°æ®å­˜å‚¨åœ¨ç¬¬ä¸‰æ–¹
   - âŒ ä¾èµ–å¤–éƒ¨æœåŠ¡

3. **New Relic**:
   - âœ… APM åŠŸèƒ½å¼ºå¤§
   - âŒ æˆæœ¬é«˜
   - âŒ æ•°æ®å­˜å‚¨åœ¨ç¬¬ä¸‰æ–¹
   - âŒ ä¸ Prometheus é›†æˆä¸å¦‚ Grafana

#### 5.3.3 å®é™…åº”ç”¨

##### 5.3.3.1 æ•°æ®æºé…ç½®

**Prometheus æ•°æ®æºé…ç½®**:

```json
{
  "name": "Prometheus",
  "type": "prometheus",
  "url": "http://prometheus:9090",
  "access": "proxy",
  "isDefault": true,
  "jsonData": {
    "timeInterval": "15s"
  }
}
```

##### 5.3.3.2 ä»ªè¡¨æ¿åˆ›å»º

**åˆ›å»ºä»ªè¡¨æ¿ç¤ºä¾‹**:

```json
{
  "dashboard": {
    "title": "Golang Service Dashboard",
    "panels": [
      {
        "title": "HTTP Requests",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{path}}"
          }
        ]
      },
      {
        "title": "Request Duration",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          }
        ]
      }
    ]
  }
}
```

##### 5.3.3.3 æŸ¥è¯¢ç¼–å†™

**PromQL æŸ¥è¯¢ç¤ºä¾‹**:

```promql
# è¯·æ±‚é€Ÿç‡
rate(http_requests_total[5m])

# é”™è¯¯ç‡
rate(http_requests_total{status="error"}[5m]) / rate(http_requests_total[5m])

# 95 åˆ†ä½å»¶è¿Ÿ
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# æ´»è·ƒè¿æ¥æ•°
active_connections
```

##### 5.3.3.4 å‘Šè­¦é…ç½®

**å‘Šè­¦é…ç½®ç¤ºä¾‹**:

```json
{
  "alert": {
    "name": "High Error Rate",
    "message": "Error rate is above threshold",
    "conditions": [
      {
        "evaluator": {
          "params": [0.05],
          "type": "gt"
        },
        "query": {
          "params": ["A", "5m", "now"]
        },
        "reducer": {
          "type": "avg"
        }
      }
    ],
    "notifications": [
      {
        "uid": "slack"
      }
    ]
  }
}
```

#### 5.3.4 æœ€ä½³å®è·µ

##### 5.3.4.1 ä»ªè¡¨æ¿è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„ä»ªè¡¨æ¿è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„ä»ªè¡¨æ¿è®¾è®¡å¯ä»¥æé«˜ç›‘æ§æ•ˆç‡ï¼Œä¾¿äºå¿«é€Ÿå‘ç°é—®é¢˜ã€‚

**ä»ªè¡¨æ¿è®¾è®¡åŸåˆ™**:

1. **ä¿¡æ¯å±‚æ¬¡**: æŒ‰ç…§é‡è¦æ€§ç»„ç»‡ä¿¡æ¯
2. **å¯è§†åŒ–ç±»å‹**: æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©åˆé€‚çš„å¯è§†åŒ–ç±»å‹
3. **æ—¶é—´èŒƒå›´**: è®¾ç½®åˆç†çš„æ—¶é—´èŒƒå›´
4. **å‘Šè­¦é›†æˆ**: é›†æˆå‘Šè­¦ä¿¡æ¯

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```json
{
  "dashboard": {
    "title": "Service Overview",
    "panels": [
      {
        "title": "Request Rate",
        "type": "graph",
        "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{path}}"
          }
        ]
      },
      {
        "title": "Error Rate",
        "type": "graph",
        "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "rate(http_requests_total{status=\"error\"}[5m]) / rate(http_requests_total[5m])",
            "legendFormat": "Error Rate"
          }
        ]
      }
    ]
  }
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ä¿¡æ¯å±‚æ¬¡**: å°†æœ€é‡è¦çš„æŒ‡æ ‡æ”¾åœ¨é¡¶éƒ¨
2. **å¯è§†åŒ–ç±»å‹**: æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©åˆé€‚çš„å¯è§†åŒ–ç±»å‹ï¼ˆæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾ç­‰ï¼‰
3. **æ—¶é—´èŒƒå›´**: è®¾ç½®åˆç†çš„æ—¶é—´èŒƒå›´ï¼Œä¾¿äºæŸ¥çœ‹è¶‹åŠ¿
4. **å‘Šè­¦é›†æˆ**: åœ¨ä»ªè¡¨æ¿ä¸Šæ˜¾ç¤ºå‘Šè­¦ä¿¡æ¯ï¼Œä¾¿äºå¿«é€Ÿå‘ç°é—®é¢˜

---

### 5.4 Jaeger

#### 5.4.1 æ ¸å¿ƒç‰¹æ€§

**Jaeger æ˜¯ä»€ä¹ˆï¼Ÿ**

Jaeger æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **åˆ†å¸ƒå¼è¿½è¸ª**: å®Œæ•´çš„åˆ†å¸ƒå¼è¿½è¸ªæ”¯æŒ
- âœ… **å¯è§†åŒ–**: ç›´è§‚çš„è¿½è¸ªå¯è§†åŒ–
- âœ… **æŸ¥è¯¢**: å¼ºå¤§çš„æŸ¥è¯¢åŠŸèƒ½
- âœ… **é›†æˆ**: ä¸ OpenTelemetry é›†æˆè‰¯å¥½

#### 5.4.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Jaegerï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Jaeger | Zipkin | Datadog APM | New Relic | è¯´æ˜ |
|---------|------|--------|--------|-------------|-----------|------|
| **OpenTelemetry é›†æˆ** | 35% | 10 | 9 | 8 | 7 | Jaeger ä¸ OTLP é›†æˆæœ€å¥½ |
| **å¯è§†åŒ–èƒ½åŠ›** | 25% | 10 | 8 | 9 | 9 | Jaeger UI åŠŸèƒ½å®Œå–„ |
| **æ€§èƒ½** | 20% | 9 | 8 | 8 | 8 | Jaeger æ€§èƒ½ä¼˜ç§€ |
| **æˆæœ¬** | 15% | 10 | 10 | 3 | 3 | Jaeger å¼€æºå…è´¹ |
| **ç¤¾åŒºç”Ÿæ€** | 5% | 9 | 8 | 7 | 7 | Jaeger ç¤¾åŒºæ´»è·ƒ |
| **åŠ æƒæ€»åˆ†** | - | **9.60** | 8.70 | 7.20 | 7.00 | Jaeger å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **OpenTelemetry é›†æˆï¼ˆæƒé‡ 35%ï¼‰**:
   - åŸç”Ÿæ”¯æŒ OTLP åè®®ï¼Œä¸ OpenTelemetry é›†æˆå®Œç¾
   - æ”¯æŒ gRPC å’Œ HTTP ä¸¤ç§ä¼ è¾“æ–¹å¼
   - ä¸ OpenTelemetry Collector é›†æˆè‰¯å¥½

2. **å¯è§†åŒ–èƒ½åŠ›ï¼ˆæƒé‡ 25%ï¼‰**:
   - ç›´è§‚çš„è¿½è¸ªå¯è§†åŒ–ï¼Œæ”¯æŒæ—¶é—´çº¿è§†å›¾
   - å¼ºå¤§çš„æŸ¥è¯¢åŠŸèƒ½ï¼Œæ”¯æŒå¤šç»´åº¦æŸ¥è¯¢
   - æ”¯æŒè¿½è¸ªå¯¹æ¯”å’Œæ€§èƒ½åˆ†æ

3. **æˆæœ¬ï¼ˆæƒé‡ 15%ï¼‰**:
   - å®Œå…¨å¼€æºå…è´¹ï¼Œæ— æˆæƒæˆæœ¬
   - è‡ªæ‰˜ç®¡ï¼Œæ•°æ®å¯æ§
   - é€‚åˆä¸­å°å‹é¡¹ç›®

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–è¿½è¸ªç³»ç»Ÿï¼Ÿ**

1. **Zipkin**:
   - âœ… è½»é‡çº§ï¼Œæ˜“äºéƒ¨ç½²
   - âŒ ä¸ OpenTelemetry é›†æˆä¸å¦‚ Jaeger
   - âŒ å¯è§†åŒ–èƒ½åŠ›ä¸å¦‚ Jaeger
   - âŒ æŸ¥è¯¢åŠŸèƒ½ä¸å¦‚ Jaeger å¼ºå¤§

2. **Datadog APM**:
   - âœ… åŠŸèƒ½å®Œå–„ï¼ŒSaaS æœåŠ¡
   - âŒ æˆæœ¬é«˜ï¼Œä¸é€‚åˆä¸­å°å‹é¡¹ç›®
   - âŒ æ•°æ®å­˜å‚¨åœ¨ç¬¬ä¸‰æ–¹
   - âŒ ä¸ OpenTelemetry é›†æˆä¸å¦‚ Jaeger

3. **New Relic**:
   - âœ… APM åŠŸèƒ½å¼ºå¤§
   - âŒ æˆæœ¬é«˜
   - âŒ æ•°æ®å­˜å‚¨åœ¨ç¬¬ä¸‰æ–¹
   - âŒ ä¸ OpenTelemetry é›†æˆä¸å¦‚ Jaeger

#### 5.4.3 å®é™…åº”ç”¨

##### 5.4.3.1 é…ç½® OpenTelemetry å¯¼å‡ºåˆ° Jaeger

**é…ç½®å¯¼å‡ºå™¨**:

```go
// é…ç½® Jaeger å¯¼å‡ºå™¨
import (
    "go.opentelemetry.io/otel/exporters/jaeger"
    "go.opentelemetry.io/otel/sdk/trace"
)

func InitJaegerTracing(ctx context.Context, endpoint string) (*trace.TracerProvider, error) {
    // åˆ›å»º Jaeger å¯¼å‡ºå™¨
    exporter, err := jaeger.New(jaeger.WithCollectorEndpoint(jaeger.WithEndpoint(endpoint)))
    if err != nil {
        return nil, err
    }

    // åˆ›å»º TracerProvider
    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
        trace.WithResource(resource.NewWithAttributes(
            semconv.SchemaURL,
            semconv.ServiceNameKey.String("golang-service"),
        )),
    )

    otel.SetTracerProvider(tp)
    return tp, nil
}
```

##### 5.4.3.2 åœ¨ Jaeger UI ä¸­æŸ¥çœ‹è¿½è¸ª

**æŸ¥çœ‹è¿½è¸ªæ­¥éª¤**:

1. è®¿é—® Jaeger UI: `http://localhost:16686`
2. é€‰æ‹©æœåŠ¡: é€‰æ‹© "golang-service"
3. æŸ¥çœ‹è¿½è¸ª: æŸ¥çœ‹è¯·æ±‚çš„å®Œæ•´è¿½è¸ªé“¾è·¯
4. åˆ†ææ€§èƒ½: åˆ†ææ¯ä¸ª Span çš„æ‰§è¡Œæ—¶é—´

##### 5.4.3.3 æŸ¥è¯¢è¿½è¸ªæ•°æ®

**æŸ¥è¯¢ç¤ºä¾‹**:

```go
// é€šè¿‡ Jaeger API æŸ¥è¯¢è¿½è¸ª
import "github.com/jaegertracing/jaeger-client-go"

func QueryTraces(ctx context.Context, serviceName string, startTime, endTime time.Time) ([]*jaeger.Trace, error) {
    // æŸ¥è¯¢è¿½è¸ªæ•°æ®
    // å®ç°æŸ¥è¯¢é€»è¾‘
    return traces, nil
}
```

#### 5.4.4 æœ€ä½³å®è·µ

##### 5.4.4.1 è¿½è¸ªè®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„è¿½è¸ªè®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„è¿½è¸ªè®¾è®¡å¯ä»¥æé«˜é—®é¢˜æ’æŸ¥æ•ˆç‡ï¼Œä¾¿äºæ€§èƒ½åˆ†æã€‚

**è¿½è¸ªè®¾è®¡åŸåˆ™**:

1. **Span å‘½å**: ä½¿ç”¨æ¸…æ™°çš„ Span åç§°
2. **å±æ€§è®¾ç½®**: è®¾ç½®æœ‰æ„ä¹‰çš„å±æ€§
3. **é‡‡æ ·ç­–ç•¥**: æ ¹æ®ç¯å¢ƒé…ç½®åˆé€‚çš„é‡‡æ ·ç‡
4. **é”™è¯¯è®°å½•**: è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// è¿½è¸ªè®¾è®¡æœ€ä½³å®è·µ
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    ctx, span := tracer.Start(r.Context(), "user.create")
    defer span.End()

    // è®¾ç½®å±æ€§
    span.SetAttributes(
        attribute.String("user.email", req.Email),
        attribute.String("user.name", req.Name),
        attribute.String("http.method", r.Method),
        attribute.String("http.path", r.URL.Path),
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(ctx, req)

    if err != nil {
        // è®°å½•é”™è¯¯
        span.RecordError(err)
        span.SetStatus(codes.Error, err.Error())
        Error(w, http.StatusInternalServerError, err)
        return
    }

    // è®¾ç½®æˆåŠŸå±æ€§
    span.SetAttributes(attribute.String("user.id", user.ID))
    span.SetStatus(codes.Ok, "User created successfully")
    Success(w, http.StatusCreated, user)
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **Span å‘½å**: ä½¿ç”¨æ¸…æ™°çš„ã€æœ‰æ„ä¹‰çš„ Span åç§°
2. **å±æ€§è®¾ç½®**: è®¾ç½®æœ‰åŠ©äºè°ƒè¯•å’Œç›‘æ§çš„å±æ€§
3. **é‡‡æ ·ç­–ç•¥**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¾ƒä½çš„é‡‡æ ·ç‡ï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨ 100% é‡‡æ ·
4. **é”™è¯¯è®°å½•**: ä½¿ç”¨ `span.RecordError()` è®°å½•é”™è¯¯ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

---

## 6. ğŸ’¬ æ¶ˆæ¯é˜Ÿåˆ—å±‚

### 6.1 Kafka (Sarama)

#### 6.1.1 æ ¸å¿ƒç‰¹æ€§

**Kafka æ˜¯ä»€ä¹ˆï¼Ÿ**

Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼Œç”¨äºæ„å»ºå®æ—¶æ•°æ®ç®¡é“å’Œæµå¼åº”ç”¨ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **é«˜ååé‡**: æ”¯æŒé«˜ååé‡çš„æ¶ˆæ¯å¤„ç†
- âœ… **æŒä¹…åŒ–**: æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨
- âœ… **åˆ†åŒº**: æ”¯æŒåˆ†åŒºå’Œå¹¶è¡Œå¤„ç†
- âœ… **é¡ºåºä¿è¯**: ä¿è¯åˆ†åŒºå†…æ¶ˆæ¯é¡ºåº

#### 6.1.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Kafkaï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Kafka | RabbitMQ | NATS | Redis Streams | è¯´æ˜ |
|---------|------|-------|----------|------|---------------|------|
| **ååé‡** | 30% | 10 | 6 | 9 | 8 | Kafka ååé‡æœ€é«˜ |
| **æŒä¹…åŒ–** | 25% | 10 | 9 | 6 | 7 | Kafka æŒä¹…åŒ–æœ€å¯é  |
| **åˆ†åŒºæ”¯æŒ** | 20% | 10 | 7 | 8 | 6 | Kafka åˆ†åŒºåŠŸèƒ½æœ€å®Œå–„ |
| **ç”Ÿæ€é›†æˆ** | 15% | 10 | 8 | 7 | 6 | Kafka ç”Ÿæ€æœ€ä¸°å¯Œ |
| **å­¦ä¹ æˆæœ¬** | 10% | 6 | 8 | 8 | 9 | Kafka å­¦ä¹ æ›²çº¿è¾ƒé™¡ |
| **åŠ æƒæ€»åˆ†** | - | **9.20** | 7.50 | 7.80 | 7.30 | Kafka å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **ååé‡ï¼ˆæƒé‡ 30%ï¼‰**:
   - é«˜ååé‡ï¼Œé€‚åˆå¤§æ•°æ®æµå¤„ç†åœºæ™¯
   - æ”¯æŒæ‰¹é‡å¤„ç†ï¼Œæé«˜æ•ˆç‡
   - åˆ†åŒºå¹¶è¡Œå¤„ç†ï¼Œæ€§èƒ½ä¼˜ç§€

2. **æŒä¹…åŒ–ï¼ˆæƒé‡ 25%ï¼‰**:
   - æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨ï¼Œä¿è¯å¯é æ€§
   - æ”¯æŒæ¶ˆæ¯é‡æ”¾ï¼Œé€‚åˆäº‹ä»¶æº¯æº
   - æ•°æ®ä¿ç•™ç­–ç•¥çµæ´»

3. **åˆ†åŒºæ”¯æŒï¼ˆæƒé‡ 20%ï¼‰**:
   - å®Œå–„çš„åˆ†åŒºæœºåˆ¶ï¼Œæ”¯æŒé¡ºåºä¿è¯
   - æ”¯æŒæ¶ˆè´¹è€…ç»„ï¼Œå®ç°è´Ÿè½½å‡è¡¡
   - æ”¯æŒåŠ¨æ€åˆ†åŒºæ‰©å±•

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ**

1. **RabbitMQ**:
   - âœ… åŠŸèƒ½ä¸°å¯Œï¼Œé€‚åˆä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—åœºæ™¯
   - âŒ ååé‡ä¸å¦‚ Kafka
   - âŒ ä¸é€‚åˆå¤§æ•°æ®æµå¤„ç†
   - âŒ åˆ†åŒºæ”¯æŒä¸å¦‚ Kafka

2. **NATS**:
   - âœ… æ€§èƒ½ä¼˜ç§€ï¼Œå»¶è¿Ÿä½
   - âŒ æŒä¹…åŒ–æ”¯æŒæœ‰é™
   - âŒ ä¸é€‚åˆå¤§æ•°æ®æµå¤„ç†
   - âŒ ç”Ÿæ€ä¸å¦‚ Kafka ä¸°å¯Œ

3. **Redis Streams**:
   - âœ… ç®€å•æ˜“ç”¨ï¼Œä¸ Redis é›†æˆå¥½
   - âŒ æŒä¹…åŒ–ä¸å¦‚ Kafka å¯é 
   - âŒ ä¸é€‚åˆå¤§æ•°æ®æµå¤„ç†
   - âŒ åŠŸèƒ½ä¸å¦‚ Kafka å®Œå–„

#### 6.1.3 å®é™…åº”ç”¨

##### 6.1.3.1 ç”Ÿäº§è€…ç¤ºä¾‹

**åŒæ­¥ç”Ÿäº§è€…**:

```go
// internal/infrastructure/messaging/kafka/producer.go
package kafka

import (
    "github.com/IBM/sarama"
)

type Producer struct {
    producer sarama.SyncProducer
}

func NewProducer(brokers []string) (*Producer, error) {
    config := sarama.NewConfig()
    config.Producer.Return.Successes = true
    config.Producer.RequiredAcks = sarama.WaitForAll

    producer, err := sarama.NewSyncProducer(brokers, config)
    if err != nil {
        return nil, err
    }

    return &Producer{producer: producer}, nil
}

func (p *Producer) SendMessage(topic string, key, value []byte) error {
    msg := &sarama.ProducerMessage{
        Topic: topic,
        Key:   sarama.ByteEncoder(key),
        Value: sarama.ByteEncoder(value),
    }

    _, _, err := p.producer.SendMessage(msg)
    return err
}
```

**å¼‚æ­¥ç”Ÿäº§è€…**:

```go
// å¼‚æ­¥ç”Ÿäº§è€…
func NewAsyncProducer(brokers []string) (*Producer, error) {
    config := sarama.NewConfig()
    config.Producer.Return.Successes = true
    config.Producer.Return.Errors = true

    producer, err := sarama.NewAsyncProducer(brokers, config)
    if err != nil {
        return nil, err
    }

    // å¤„ç†æˆåŠŸå’Œé”™è¯¯
    go func() {
        for {
            select {
            case success := <-producer.Successes():
                logger.Info("Message sent",
                    "topic", success.Topic,
                    "partition", success.Partition,
                    "offset", success.Offset,
                )
            case err := <-producer.Errors():
                logger.Error("Failed to send message", "error", err)
            }
        }
    }()

    return &Producer{producer: producer}, nil
}
```

##### 6.1.3.2 æ¶ˆè´¹è€…ç¤ºä¾‹

**å•ä¸ªæ¶ˆè´¹è€…**:

```go
// internal/infrastructure/messaging/kafka/consumer.go
package kafka

type Consumer struct {
    consumer sarama.Consumer
}

func NewConsumer(brokers []string) (*Consumer, error) {
    consumer, err := sarama.NewConsumer(brokers, nil)
    if err != nil {
        return nil, err
    }

    return &Consumer{consumer: consumer}, nil
}

func (c *Consumer) Consume(topic string, handler func(*sarama.ConsumerMessage)) error {
    partitionList, err := c.consumer.Partitions(topic)
    if err != nil {
        return err
    }

    for partition := range partitionList {
        pc, err := c.consumer.ConsumePartition(topic, int32(partition), sarama.OffsetNewest)
        if err != nil {
            return err
        }

        go func(pc sarama.PartitionConsumer) {
            defer pc.AsyncClose()
            for msg := range pc.Messages() {
                handler(msg)
            }
        }(pc)
    }

    return nil
}
```

**æ¶ˆè´¹è€…ç»„**:

```go
// æ¶ˆè´¹è€…ç»„
func NewConsumerGroup(brokers []string, groupID string) (*ConsumerGroup, error) {
    config := sarama.NewConfig()
    config.Consumer.Group.Rebalance.Strategy = sarama.NewBalanceStrategyRoundRobin()
    config.Consumer.Offsets.Initial = sarama.OffsetNewest

    consumerGroup, err := sarama.NewConsumerGroup(brokers, groupID, config)
    if err != nil {
        return nil, err
    }

    return &ConsumerGroup{consumerGroup: consumerGroup}, nil
}

func (cg *ConsumerGroup) Consume(ctx context.Context, topics []string, handler sarama.ConsumerGroupHandler) error {
    for {
        err := cg.consumerGroup.Consume(ctx, topics, handler)
        if err != nil {
            return err
        }
    }
}
```

##### 6.1.3.3 åˆ†åŒºç­–ç•¥

**åˆ†åŒºç­–ç•¥ç¤ºä¾‹**:

```go
// è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥
type CustomPartitioner struct{}

func (p *CustomPartitioner) Partition(message *sarama.ProducerMessage, numPartitions int32) (int32, error) {
    // æ ¹æ® key è¿›è¡Œåˆ†åŒº
    if message.Key != nil {
        hash := crc32.ChecksumIEEE(message.Key.(sarama.ByteEncoder))
        return int32(hash) % numPartitions, nil
    }

    // è½®è¯¢åˆ†åŒº
    return rand.Int31n(numPartitions), nil
}

// ä½¿ç”¨è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥
config.Producer.Partitioner = sarama.NewCustomPartitioner(&CustomPartitioner{})
```

#### 6.1.4 æœ€ä½³å®è·µ

##### 6.1.4.1 ç”Ÿäº§è€…æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„ç”Ÿäº§è€…è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„ç”Ÿäº§è€…è®¾è®¡å¯ä»¥æé«˜æ¶ˆæ¯å‘é€çš„å¯é æ€§å’Œæ€§èƒ½ã€‚

**ç”Ÿäº§è€…æœ€ä½³å®è·µ**:

1. **æ‰¹é‡å‘é€**: ä½¿ç”¨æ‰¹é‡å‘é€æé«˜ååé‡
2. **é”™è¯¯å¤„ç†**: æ­£ç¡®å¤„ç†å‘é€é”™è¯¯ï¼Œå®ç°é‡è¯•æœºåˆ¶
3. **åˆ†åŒºç­–ç•¥**: é€‰æ‹©åˆé€‚çš„åˆ†åŒºç­–ç•¥
4. **æ¶ˆæ¯åºåˆ—åŒ–**: ä½¿ç”¨é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹å¼

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// ç”Ÿäº§è€…æœ€ä½³å®è·µ
func (p *Producer) SendMessageWithRetry(topic string, key, value []byte, maxRetries int) error {
    msg := &sarama.ProducerMessage{
        Topic: topic,
        Key:   sarama.ByteEncoder(key),
        Value: sarama.ByteEncoder(value),
    }

    for i := 0; i < maxRetries; i++ {
        _, _, err := p.producer.SendMessage(msg)
        if err == nil {
            return nil
        }

        if i < maxRetries-1 {
            time.Sleep(time.Second * time.Duration(i+1))
        }
    }

    return fmt.Errorf("failed to send message after %d retries", maxRetries)
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **æ‰¹é‡å‘é€**: ä½¿ç”¨æ‰¹é‡å‘é€æé«˜ååé‡
2. **é”™è¯¯å¤„ç†**: å®ç°é‡è¯•æœºåˆ¶ï¼Œå¤„ç†å‘é€å¤±è´¥
3. **åˆ†åŒºç­–ç•¥**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„åˆ†åŒºç­–ç•¥
4. **æ¶ˆæ¯åºåˆ—åŒ–**: ä½¿ç”¨é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹å¼ï¼ˆå¦‚ Protocol Buffersï¼‰

##### 6.1.4.2 æ¶ˆè´¹è€…æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„æ¶ˆè´¹è€…è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„æ¶ˆè´¹è€…è®¾è®¡å¯ä»¥æé«˜æ¶ˆæ¯å¤„ç†çš„å¯é æ€§å’Œæ€§èƒ½ã€‚

**æ¶ˆè´¹è€…æœ€ä½³å®è·µ**:

1. **æ¶ˆè´¹è€…ç»„**: ä½¿ç”¨æ¶ˆè´¹è€…ç»„å®ç°è´Ÿè½½å‡è¡¡
2. **åç§»é‡ç®¡ç†**: æ­£ç¡®å¤„ç†åç§»é‡ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±
3. **é”™è¯¯å¤„ç†**: å®ç°é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
4. **æ‰¹é‡å¤„ç†**: ä½¿ç”¨æ‰¹é‡å¤„ç†æé«˜æ€§èƒ½

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æ¶ˆè´¹è€…æœ€ä½³å®è·µ
type MessageHandler struct{}

func (h *MessageHandler) Setup(sarama.ConsumerGroupSession) error {
    return nil
}

func (h *MessageHandler) Cleanup(sarama.ConsumerGroupSession) error {
    return nil
}

func (h *MessageHandler) ConsumeClaim(session sarama.ConsumerGroupSession, claim sarama.ConsumerGroupClaim) error {
    for {
        select {
        case message := <-claim.Messages():
            if message == nil {
                return nil
            }

            // å¤„ç†æ¶ˆæ¯
            if err := h.processMessage(message); err != nil {
                // è®°å½•é”™è¯¯ï¼Œä½†ä¸æäº¤åç§»é‡ï¼Œä»¥ä¾¿é‡è¯•
                logger.Error("Failed to process message",
                    "topic", message.Topic,
                    "partition", message.Partition,
                    "offset", message.Offset,
                    "error", err,
                )
                continue
            }

            // æäº¤åç§»é‡
            session.MarkMessage(message, "")
        case <-session.Context().Done():
            return nil
        }
    }
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **æ¶ˆè´¹è€…ç»„**: ä½¿ç”¨æ¶ˆè´¹è€…ç»„å®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™
2. **åç§»é‡ç®¡ç†**: æ­£ç¡®å¤„ç†åç§»é‡ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±
3. **é”™è¯¯å¤„ç†**: å®ç°é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
4. **æ‰¹é‡å¤„ç†**: ä½¿ç”¨æ‰¹é‡å¤„ç†æé«˜æ€§èƒ½

---

### 6.2 MQTT

#### 6.2.1 æ ¸å¿ƒç‰¹æ€§

**MQTT æ˜¯ä»€ä¹ˆï¼Ÿ**

MQTT æ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ¶ˆæ¯ä¼ è¾“åè®®ï¼Œé€‚ç”¨äº IoT åœºæ™¯ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **è½»é‡çº§**: åè®®ç®€å•ï¼Œå¼€é”€å°
- âœ… **QoS**: æ”¯æŒä¸‰ç§ QoS çº§åˆ«
- âœ… **ä¸»é¢˜**: åŸºäºä¸»é¢˜çš„å‘å¸ƒ/è®¢é˜…
- âœ… **ä½å¸¦å®½**: é€‚åˆä½å¸¦å®½åœºæ™¯

#### 6.2.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© MQTTï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | MQTT | CoAP | AMQP | HTTP | è¯´æ˜ |
|---------|------|------|------|------|------|------|
| **IoT é€‚é…** | 35% | 10 | 9 | 5 | 3 | MQTT æœ€é€‚åˆ IoT |
| **ä½å¸¦å®½** | 25% | 10 | 9 | 6 | 4 | MQTT åè®®å¼€é”€å° |
| **QoS æ”¯æŒ** | 20% | 10 | 7 | 9 | 5 | MQTT QoS å®Œå–„ |
| **æ˜“ç”¨æ€§** | 15% | 9 | 7 | 6 | 8 | MQTT ç®€å•æ˜“ç”¨ |
| **ç”Ÿæ€æ”¯æŒ** | 5% | 9 | 6 | 8 | 10 | MQTT ç”Ÿæ€è‰¯å¥½ |
| **åŠ æƒæ€»åˆ†** | - | **9.60** | 8.20 | 6.60 | 4.80 | MQTT å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **IoT é€‚é…ï¼ˆæƒé‡ 35%ï¼‰**:
   - ä¸“ä¸º IoT åœºæ™¯è®¾è®¡
   - æ”¯æŒå¤§é‡å¹¶å‘è¿æ¥
   - é€‚åˆèµ„æºå—é™è®¾å¤‡

2. **ä½å¸¦å®½ï¼ˆæƒé‡ 25%ï¼‰**:
   - åè®®å¼€é”€å°
   - é€‚åˆä½å¸¦å®½åœºæ™¯
   - æ”¯æŒå‹ç¼©

3. **QoS æ”¯æŒï¼ˆæƒé‡ 20%ï¼‰**:
   - ä¸‰ç§ QoS çº§åˆ«
   - ä¿è¯æ¶ˆæ¯å¯é æ€§
   - é€‚åˆä¸åŒåœºæ™¯éœ€æ±‚

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–åè®®ï¼Ÿ**

1. **CoAP**:
   - âœ… ä¸“ä¸º IoT è®¾è®¡
   - âŒ ç”Ÿæ€ä¸å¦‚ MQTT ä¸°å¯Œ
   - âŒ ä½¿ç”¨ä¸å¦‚ MQTT å¹¿æ³›

2. **AMQP**:
   - âœ… åŠŸèƒ½å¼ºå¤§
   - âŒ åè®®å¤æ‚ï¼Œå¼€é”€å¤§
   - âŒ ä¸é€‚åˆ IoT åœºæ™¯

3. **HTTP**:
   - âœ… æ ‡å‡†åè®®ï¼Œç”Ÿæ€ä¸°å¯Œ
   - âŒ åè®®å¼€é”€å¤§
   - âŒ ä¸é€‚åˆ IoT åœºæ™¯

#### 6.2.3 å®é™…åº”ç”¨

##### 6.2.3.1 å®¢æˆ·ç«¯è¿æ¥

**è¿æ¥ç¤ºä¾‹**:

```go
// internal/infrastructure/messaging/mqtt/client.go
package mqtt

import (
    "github.com/eclipse/paho.mqtt.golang"
)

type Client struct {
    client mqtt.Client
}

func NewClient(broker string, clientID string) (*Client, error) {
    opts := mqtt.NewClientOptions()
    opts.AddBroker(broker)
    opts.SetClientID(clientID)
    opts.SetCleanSession(true)
    opts.SetAutoReconnect(true)

    client := mqtt.NewClient(opts)
    if token := client.Connect(); token.Wait() && token.Error() != nil {
        return nil, token.Error()
    }

    return &Client{client: client}, nil
}
```

##### 6.2.3.2 å‘å¸ƒæ¶ˆæ¯

**å‘å¸ƒæ¶ˆæ¯ç¤ºä¾‹**:

```go
// å‘å¸ƒæ¶ˆæ¯
func (c *Client) Publish(topic string, qos byte, retained bool, payload []byte) error {
    token := c.client.Publish(topic, qos, retained, payload)
    token.Wait()
    return token.Error()
}

// ä½¿ç”¨ç¤ºä¾‹
client.Publish("sensors/temperature", 1, false, []byte("25.5"))
```

##### 6.2.3.3 è®¢é˜…ä¸»é¢˜

**è®¢é˜…ä¸»é¢˜ç¤ºä¾‹**:

```go
// è®¢é˜…ä¸»é¢˜
func (c *Client) Subscribe(topic string, qos byte, handler mqtt.MessageHandler) error {
    token := c.client.Subscribe(topic, qos, handler)
    token.Wait()
    return token.Error()
}

// ä½¿ç”¨ç¤ºä¾‹
client.Subscribe("sensors/+", 1, func(client mqtt.Client, msg mqtt.Message) {
    logger.Info("Received message",
        "topic", msg.Topic(),
        "payload", string(msg.Payload()),
    )
})
```

##### 6.2.3.4 QoS çº§åˆ«ä½¿ç”¨

**QoS çº§åˆ«è¯´æ˜**:

```go
// QoS 0: æœ€å¤šä¸€æ¬¡ï¼Œä¸ä¿è¯æ¶ˆæ¯åˆ°è¾¾
client.Publish("topic", 0, false, payload)

// QoS 1: è‡³å°‘ä¸€æ¬¡ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘åˆ°è¾¾ä¸€æ¬¡
client.Publish("topic", 1, false, payload)

// QoS 2: æ°å¥½ä¸€æ¬¡ï¼Œä¿è¯æ¶ˆæ¯æ°å¥½åˆ°è¾¾ä¸€æ¬¡
client.Publish("topic", 2, false, payload)
```

#### 6.2.4 æœ€ä½³å®è·µ

##### 6.2.4.1 ä¸»é¢˜è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„ä¸»é¢˜è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„ä¸»é¢˜è®¾è®¡å¯ä»¥æé«˜æ¶ˆæ¯è·¯ç”±çš„æ•ˆç‡å’Œå¯ç»´æŠ¤æ€§ã€‚

**ä¸»é¢˜è®¾è®¡åŸåˆ™**:

1. **å±‚æ¬¡ç»“æ„**: ä½¿ç”¨å±‚æ¬¡ç»“æ„ç»„ç»‡ä¸»é¢˜
2. **å‘½åè§„èŒƒ**: ä½¿ç”¨æ¸…æ™°çš„å‘½åè§„èŒƒ
3. **é€šé…ç¬¦ä½¿ç”¨**: åˆç†ä½¿ç”¨é€šé…ç¬¦
4. **ä¸»é¢˜é•¿åº¦**: æ§åˆ¶ä¸»é¢˜é•¿åº¦

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// ä¸»é¢˜è®¾è®¡æœ€ä½³å®è·µ
// å±‚æ¬¡ç»“æ„: {location}/{device_type}/{device_id}/{sensor_type}
// ç¤ºä¾‹: home/thermostat/living-room/temperature

// è®¢é˜…æ‰€æœ‰æ¸©åº¦ä¼ æ„Ÿå™¨
client.Subscribe("+/+/+/temperature", 1, handler)

// è®¢é˜…ç‰¹å®šè®¾å¤‡çš„æ‰€æœ‰ä¼ æ„Ÿå™¨
client.Subscribe("home/thermostat/living-room/+", 1, handler)
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **å±‚æ¬¡ç»“æ„**: ä½¿ç”¨å±‚æ¬¡ç»“æ„ç»„ç»‡ä¸»é¢˜ï¼Œä¾¿äºç®¡ç†å’Œè®¢é˜…
2. **å‘½åè§„èŒƒ**: ä½¿ç”¨æ¸…æ™°çš„å‘½åè§„èŒƒï¼Œä¾¿äºç†è§£
3. **é€šé…ç¬¦ä½¿ç”¨**: åˆç†ä½¿ç”¨é€šé…ç¬¦ï¼ˆ+ã€#ï¼‰ï¼Œæé«˜è®¢é˜…æ•ˆç‡
4. **ä¸»é¢˜é•¿åº¦**: æ§åˆ¶ä¸»é¢˜é•¿åº¦ï¼Œé¿å…è¿‡é•¿

##### 6.2.4.2 QoS é€‰æ‹©æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦åˆç†é€‰æ‹© QoSï¼Ÿ**

åˆç†é€‰æ‹© QoS å¯ä»¥å¹³è¡¡æ¶ˆæ¯å¯é æ€§å’Œæ€§èƒ½ã€‚

**QoS é€‰æ‹©åŸåˆ™**:

1. **QoS 0**: é€‚ç”¨äºä¸é‡è¦çš„æ•°æ®ï¼Œå¦‚ä¼ æ„Ÿå™¨æ•°æ®
2. **QoS 1**: é€‚ç”¨äºé‡è¦æ•°æ®ï¼Œå¦‚æ§åˆ¶å‘½ä»¤
3. **QoS 2**: é€‚ç”¨äºå…³é”®æ•°æ®ï¼Œå¦‚æ”¯ä»˜ä¿¡æ¯

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// QoS é€‰æ‹©æœ€ä½³å®è·µ
// ä¼ æ„Ÿå™¨æ•°æ®ï¼šQoS 0ï¼ˆä¸é‡è¦çš„æ•°æ®ï¼‰
client.Publish("sensors/temperature", 0, false, temperatureData)

// æ§åˆ¶å‘½ä»¤ï¼šQoS 1ï¼ˆé‡è¦çš„æ•°æ®ï¼‰
client.Publish("devices/thermostat/command", 1, false, commandData)

// å…³é”®æ•°æ®ï¼šQoS 2ï¼ˆå…³é”®çš„æ•°æ®ï¼‰
client.Publish("payment/transaction", 2, false, paymentData)
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **QoS 0**: é€‚ç”¨äºä¸é‡è¦çš„æ•°æ®ï¼Œæé«˜æ€§èƒ½
2. **QoS 1**: é€‚ç”¨äºé‡è¦æ•°æ®ï¼Œå¹³è¡¡å¯é æ€§å’Œæ€§èƒ½
3. **QoS 2**: é€‚ç”¨äºå…³é”®æ•°æ®ï¼Œä¿è¯å¯é æ€§

---

## 7. âš™ï¸ é…ç½®å’Œå·¥å…·å±‚

### 7.1 Viper

#### 7.1.1 æ ¸å¿ƒç‰¹æ€§

**Viper æ˜¯ä»€ä¹ˆï¼Ÿ**

Viper æ˜¯ä¸€ä¸ª Go è¯­è¨€çš„å®Œæ•´é…ç½®è§£å†³æ–¹æ¡ˆã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒ JSON, YAML, TOML ç­‰
- âœ… **ç¯å¢ƒå˜é‡**: æ”¯æŒç¯å¢ƒå˜é‡
- âœ… **çƒ­é‡è½½**: æ”¯æŒé…ç½®çƒ­é‡è½½
- âœ… **é»˜è®¤å€¼**: æ”¯æŒé»˜è®¤å€¼

#### 7.1.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Viperï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Viper | envconfig | koanf | configor | è¯´æ˜ |
|---------|------|-------|-----------|-------|----------|------|
| **åŠŸèƒ½å®Œæ•´æ€§** | 30% | 10 | 6 | 9 | 8 | Viper åŠŸèƒ½æœ€å®Œæ•´ |
| **å¤šæ ¼å¼æ”¯æŒ** | 25% | 10 | 5 | 9 | 8 | Viper æ”¯æŒæœ€å¤šæ ¼å¼ |
| **æ˜“ç”¨æ€§** | 20% | 9 | 8 | 7 | 9 | Viper API ç®€å•æ˜“ç”¨ |
| **ç”Ÿæ€é›†æˆ** | 15% | 9 | 7 | 8 | 7 | Viper ç”Ÿæ€æœ€ä¸°å¯Œ |
| **æ€§èƒ½** | 10% | 8 | 9 | 9 | 8 | Viper æ€§èƒ½è¶³å¤Ÿ |
| **åŠ æƒæ€»åˆ†** | - | **9.25** | 7.00 | 8.50 | 8.20 | Viper å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **åŠŸèƒ½å®Œæ•´æ€§ï¼ˆæƒé‡ 30%ï¼‰**:
   - æ”¯æŒå¤šç§é…ç½®æºï¼ˆæ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°ç­‰ï¼‰
   - æ”¯æŒé…ç½®çƒ­é‡è½½
   - æ”¯æŒé…ç½®ä¼˜å…ˆçº§å’Œè¦†ç›–

2. **å¤šæ ¼å¼æ”¯æŒï¼ˆæƒé‡ 25%ï¼‰**:
   - æ”¯æŒ JSONã€YAMLã€TOMLã€HCL ç­‰å¤šç§æ ¼å¼
   - æ”¯æŒè¿œç¨‹é…ç½®ï¼ˆetcdã€Consul ç­‰ï¼‰
   - æ ¼å¼è½¬æ¢è‡ªåŠ¨å¤„ç†

3. **æ˜“ç”¨æ€§ï¼ˆæƒé‡ 20%ï¼‰**:
   - API ç®€å•ç›´è§‚ï¼Œæ˜“äºä½¿ç”¨
   - æ”¯æŒé»˜è®¤å€¼å’Œç±»å‹è½¬æ¢
   - é”™è¯¯æç¤ºæ¸…æ™°

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–é…ç½®åº“ï¼Ÿ**

1. **envconfig**:
   - âœ… ç®€å•è½»é‡ï¼Œä¸“æ³¨äºç¯å¢ƒå˜é‡
   - âŒ åŠŸèƒ½æœ‰é™ï¼Œä¸æ”¯æŒæ–‡ä»¶é…ç½®
   - âŒ ä¸æ”¯æŒé…ç½®çƒ­é‡è½½
   - âŒ ç”Ÿæ€ä¸å¦‚ Viper ä¸°å¯Œ

2. **koanf**:
   - âœ… æ€§èƒ½ä¼˜ç§€ï¼ŒåŠŸèƒ½å®Œæ•´
   - âŒ ç¤¾åŒºä¸å¦‚ Viper æ´»è·ƒ
   - âŒ æ–‡æ¡£ä¸å¦‚ Viper å®Œå–„
   - âŒ å­¦ä¹ æˆæœ¬è¾ƒé«˜

3. **configor**:
   - âœ… ç®€å•æ˜“ç”¨ï¼Œæ”¯æŒå¤šç§æ ¼å¼
   - âŒ åŠŸèƒ½ä¸å¦‚ Viper å®Œæ•´
   - âŒ ä¸æ”¯æŒè¿œç¨‹é…ç½®
   - âŒ ç”Ÿæ€ä¸å¦‚ Viper ä¸°å¯Œ

#### 7.1.3 å®é™…åº”ç”¨

##### 7.1.3.1 é…ç½®æ–‡ä»¶åŠ è½½

**åŠ è½½é…ç½®æ–‡ä»¶**:

```go
// internal/config/config.go
package config

import (
    "github.com/spf13/viper"
)

func LoadConfig() (*Config, error) {
    viper.SetConfigName("config")
    viper.SetConfigType("yaml")
    viper.AddConfigPath("./configs")
    viper.AddConfigPath(".")

    // è®¾ç½®é»˜è®¤å€¼
    viper.SetDefault("server.port", 8080)
    viper.SetDefault("database.host", "localhost")

    // è¯»å–é…ç½®æ–‡ä»¶
    if err := viper.ReadInConfig(); err != nil {
        return nil, err
    }

    var cfg Config
    if err := viper.Unmarshal(&cfg); err != nil {
        return nil, err
    }

    return &cfg, nil
}
```

##### 7.1.3.2 ç¯å¢ƒå˜é‡ä½¿ç”¨

**ç¯å¢ƒå˜é‡é…ç½®**:

```go
// æ”¯æŒç¯å¢ƒå˜é‡
viper.AutomaticEnv()
viper.SetEnvPrefix("APP")
viper.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))

// ç¯å¢ƒå˜é‡ç¤ºä¾‹: APP_SERVER_PORT=8080
port := viper.GetInt("server.port")
```

##### 7.1.3.3 é…ç½®çƒ­é‡è½½

**é…ç½®çƒ­é‡è½½**:

```go
// ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–
viper.WatchConfig()
viper.OnConfigChange(func(e fsnotify.Event) {
    logger.Info("Config file changed", "file", e.Name)
    // é‡æ–°åŠ è½½é…ç½®
    reloadConfig()
})
```

##### 7.1.3.4 è¿œç¨‹é…ç½®

**è¿œç¨‹é…ç½®ç¤ºä¾‹**:

```go
// æ”¯æŒ etcd
viper.AddRemoteProvider("etcd", "http://127.0.0.1:4001", "/config/config.yaml")
viper.SetConfigType("yaml")
viper.ReadRemoteConfig()

// æ”¯æŒ Consul
viper.AddRemoteProvider("consul", "localhost:8500", "MY_CONSUL_KEY")
viper.SetConfigType("json")
viper.ReadRemoteConfig()
```

#### 7.1.4 æœ€ä½³å®è·µ

##### 7.1.4.1 é…ç½®ç»“æ„è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„é…ç½®ç»“æ„è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„é…ç½®ç»“æ„è®¾è®¡å¯ä»¥æé«˜é…ç½®çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚

**é…ç½®ç»“æ„è®¾è®¡åŸåˆ™**:

1. **å±‚æ¬¡ç»“æ„**: ä½¿ç”¨å±‚æ¬¡ç»“æ„ç»„ç»‡é…ç½®
2. **ç±»å‹å®‰å…¨**: ä½¿ç”¨ç»“æ„ä½“å®šä¹‰é…ç½®
3. **é»˜è®¤å€¼**: è®¾ç½®åˆç†çš„é»˜è®¤å€¼
4. **éªŒè¯**: éªŒè¯é…ç½®çš„æœ‰æ•ˆæ€§

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// é…ç½®ç»“æ„è®¾è®¡æœ€ä½³å®è·µ
type Config struct {
    Server   ServerConfig   `mapstructure:"server"`
    Database DatabaseConfig `mapstructure:"database"`
    Log      LogConfig      `mapstructure:"log"`
}

type ServerConfig struct {
    Host string `mapstructure:"host"`
    Port int    `mapstructure:"port"`
}

// åŠ è½½å’ŒéªŒè¯é…ç½®
func LoadConfig() (*Config, error) {
    viper.SetConfigName("config")
    viper.SetConfigType("yaml")
    viper.AddConfigPath("./configs")

    // è®¾ç½®é»˜è®¤å€¼
    viper.SetDefault("server.host", "0.0.0.0")
    viper.SetDefault("server.port", 8080)

    // è¯»å–é…ç½®æ–‡ä»¶
    if err := viper.ReadInConfig(); err != nil {
        return nil, err
    }

    // æ”¯æŒç¯å¢ƒå˜é‡
    viper.AutomaticEnv()

    var cfg Config
    if err := viper.Unmarshal(&cfg); err != nil {
        return nil, err
    }

    // éªŒè¯é…ç½®
    if err := cfg.Validate(); err != nil {
        return nil, err
    }

    return &cfg, nil
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **å±‚æ¬¡ç»“æ„**: ä½¿ç”¨å±‚æ¬¡ç»“æ„ç»„ç»‡é…ç½®ï¼Œä¾¿äºç®¡ç†
2. **ç±»å‹å®‰å…¨**: ä½¿ç”¨ç»“æ„ä½“å®šä¹‰é…ç½®ï¼Œä¿è¯ç±»å‹å®‰å…¨
3. **é»˜è®¤å€¼**: è®¾ç½®åˆç†çš„é»˜è®¤å€¼ï¼Œæé«˜æ˜“ç”¨æ€§
4. **éªŒè¯**: éªŒè¯é…ç½®çš„æœ‰æ•ˆæ€§ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯

---

### 7.2 Slog

#### 7.2.1 æ ¸å¿ƒç‰¹æ€§

**Slog æ˜¯ä»€ä¹ˆï¼Ÿ**

Slog æ˜¯ Go 1.21+ å¼•å…¥çš„æ ‡å‡†åº“ç»“æ„åŒ–æ—¥å¿—åŒ…ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **ç»“æ„åŒ–æ—¥å¿—**: æ”¯æŒç»“æ„åŒ–æ—¥å¿—
- âœ… **æ ‡å‡†åº“**: æ ‡å‡†åº“ï¼Œæ— éœ€ç¬¬ä¸‰æ–¹ä¾èµ–
- âœ… **Handler**: å¯å®šåˆ¶çš„ Handler
- âœ… **æ€§èƒ½**: æ€§èƒ½ä¼˜åŒ–

#### 7.2.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Slogï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Slog | Logrus | Zap | Zerolog | è¯´æ˜ |
|---------|------|------|--------|-----|---------|------|
| **æ ‡å‡†åº“** | 40% | 10 | 0 | 0 | 0 | Slog æ˜¯æ ‡å‡†åº“ |
| **ç»“æ„åŒ–æ—¥å¿—** | 25% | 10 | 9 | 10 | 10 | Slog æ”¯æŒç»“æ„åŒ– |
| **æ€§èƒ½** | 20% | 9 | 6 | 10 | 10 | Slog æ€§èƒ½ä¼˜ç§€ |
| **æ˜“ç”¨æ€§** | 10% | 9 | 10 | 7 | 8 | Slog API ç®€å• |
| **ç”Ÿæ€å…¼å®¹** | 5% | 8 | 9 | 8 | 7 | Slog å…¼å®¹æ€§å¥½ |
| **åŠ æƒæ€»åˆ†** | - | **9.50** | 5.85 | 6.90 | 6.80 | Slog å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **æ ‡å‡†åº“ï¼ˆæƒé‡ 40%ï¼‰**:
   - Go 1.21+ æ ‡å‡†åº“ï¼Œç¨³å®šå¯é 
   - æ— éœ€ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå‡å°‘ä¾èµ–é£é™©
   - æœªæ¥ Go æ—¥å¿—æ ‡å‡†ï¼Œé•¿æœŸæ”¯æŒ

2. **ç»“æ„åŒ–æ—¥å¿—ï¼ˆæƒé‡ 25%ï¼‰**:
   - åŸç”Ÿæ”¯æŒç»“æ„åŒ–æ—¥å¿—
   - æ”¯æŒé”®å€¼å¯¹å’Œå±æ€§
   - ä¸ OpenTelemetry é›†æˆè‰¯å¥½

3. **æ€§èƒ½ï¼ˆæƒé‡ 20%ï¼‰**:
   - æ€§èƒ½ä¼˜ç§€ï¼Œé›¶åˆ†é…è®¾è®¡
   - æ”¯æŒ Handler å®šåˆ¶
   - é€‚åˆç”Ÿäº§ç¯å¢ƒ

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–æ—¥å¿—åº“ï¼Ÿ**

1. **Logrus**:
   - âœ… åŠŸèƒ½ä¸°å¯Œï¼Œç”Ÿæ€æˆç†Ÿ
   - âŒ éæ ‡å‡†åº“ï¼Œéœ€è¦ç¬¬ä¸‰æ–¹ä¾èµ–
   - âŒ æ€§èƒ½ä¸å¦‚ Slog
   - âŒ ç»´æŠ¤çŠ¶æ€ä¸ç¡®å®š

2. **Zap**:
   - âœ… æ€§èƒ½ä¼˜ç§€ï¼Œç»“æ„åŒ–æ—¥å¿—æ”¯æŒå¥½
   - âŒ éæ ‡å‡†åº“ï¼Œéœ€è¦ç¬¬ä¸‰æ–¹ä¾èµ–
   - âŒ API è¾ƒå¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜
   - âŒ ä¸æ ‡å‡†åº“ä¸å…¼å®¹

3. **Zerolog**:
   - âœ… æ€§èƒ½ä¼˜ç§€ï¼ŒAPI ç®€æ´
   - âŒ éæ ‡å‡†åº“ï¼Œéœ€è¦ç¬¬ä¸‰æ–¹ä¾èµ–
   - âŒ ç”Ÿæ€ä¸å¦‚ Slog ä¸°å¯Œ
   - âŒ ä¸æ ‡å‡†åº“ä¸å…¼å®¹

#### 7.2.3 å®é™…åº”ç”¨

##### 7.2.3.1 åŸºç¡€æ—¥å¿—ä½¿ç”¨

**åŸºç¡€æ—¥å¿—ç¤ºä¾‹**:

```go
// internal/infrastructure/logging/logger.go
package logging

import (
    "log/slog"
    "os"
)

func InitLogger(level string) *slog.Logger {
    var logLevel slog.Level
    switch level {
    case "debug":
        logLevel = slog.LevelDebug
    case "info":
        logLevel = slog.LevelInfo
    case "warn":
        logLevel = slog.LevelWarn
    case "error":
        logLevel = slog.LevelError
    default:
        logLevel = slog.LevelInfo
    }

    opts := &slog.HandlerOptions{
        Level: logLevel,
    }

    handler := slog.NewJSONHandler(os.Stdout, opts)
    logger := slog.New(handler)

    slog.SetDefault(logger)
    return logger
}
```

##### 7.2.3.2 ç»“æ„åŒ–æ—¥å¿—

**ç»“æ„åŒ–æ—¥å¿—ç¤ºä¾‹**:

```go
// ç»“æ„åŒ–æ—¥å¿—
logger.Info("User created",
    "user_id", user.ID,
    "email", user.Email,
    "name", user.Name,
)

logger.Error("Failed to create user",
    "error", err,
    "email", req.Email,
)
```

##### 7.2.3.3 æ—¥å¿—ä¸Šä¸‹æ–‡

**æ—¥å¿—ä¸Šä¸‹æ–‡ç¤ºä¾‹**:

```go
// ä½¿ç”¨ä¸Šä¸‹æ–‡
logger := slog.Default().With(
    "request_id", requestID,
    "user_id", userID,
)

logger.InfoContext(ctx, "Processing request",
    "path", r.URL.Path,
    "method", r.Method,
)
```

##### 7.2.3.4 è‡ªå®šä¹‰ Handler

**è‡ªå®šä¹‰ Handler ç¤ºä¾‹**:

```go
// è‡ªå®šä¹‰ Handler
type CustomHandler struct {
    handler slog.Handler
}

func (h *CustomHandler) Handle(ctx context.Context, r slog.Record) error {
    // æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
    r.AddAttrs(
        slog.String("service", "golang-service"),
        slog.String("version", "1.0.0"),
    )

    return h.handler.Handle(ctx, r)
}

// ä½¿ç”¨è‡ªå®šä¹‰ Handler
handler := &CustomHandler{
    handler: slog.NewJSONHandler(os.Stdout, nil),
}
logger := slog.New(handler)
```

#### 7.2.4 æœ€ä½³å®è·µ

##### 7.2.4.1 æ—¥å¿—çº§åˆ«é€‰æ‹©æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦åˆç†é€‰æ‹©æ—¥å¿—çº§åˆ«ï¼Ÿ**

åˆç†é€‰æ‹©æ—¥å¿—çº§åˆ«å¯ä»¥æé«˜æ—¥å¿—çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

**æ—¥å¿—çº§åˆ«é€‰æ‹©åŸåˆ™**:

1. **DEBUG**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
2. **INFO**: ä¸€èˆ¬ä¿¡æ¯ï¼Œå¦‚è¯·æ±‚å¤„ç†
3. **WARN**: è­¦å‘Šä¿¡æ¯ï¼Œå¦‚é…ç½®é—®é¢˜
4. **ERROR**: é”™è¯¯ä¿¡æ¯ï¼Œå¦‚å¤„ç†å¤±è´¥

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æ—¥å¿—çº§åˆ«é€‰æ‹©æœ€ä½³å®è·µ
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    logger := slog.Default().With(
        "method", r.Method,
        "path", r.URL.Path,
    )

    // DEBUG: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
    logger.DebugContext(r.Context(), "Creating user",
        "email", req.Email,
        "name", req.Name,
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := h.service.CreateUser(r.Context(), req)

    if err != nil {
        // ERROR: é”™è¯¯ä¿¡æ¯
        logger.ErrorContext(r.Context(), "Failed to create user",
            "error", err,
            "email", req.Email,
        )
        Error(w, http.StatusInternalServerError, err)
        return
    }

    // INFO: ä¸€èˆ¬ä¿¡æ¯
    logger.InfoContext(r.Context(), "User created successfully",
        "user_id", user.ID,
    )
    Success(w, http.StatusCreated, user)
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **DEBUG**: ç”¨äºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒé€šå¸¸å…³é—­
2. **INFO**: ç”¨äºä¸€èˆ¬ä¿¡æ¯ï¼Œå¦‚è¯·æ±‚å¤„ç†ã€çŠ¶æ€å˜æ›´
3. **WARN**: ç”¨äºè­¦å‘Šä¿¡æ¯ï¼Œå¦‚é…ç½®é—®é¢˜ã€æ€§èƒ½é—®é¢˜
4. **ERROR**: ç”¨äºé”™è¯¯ä¿¡æ¯ï¼Œå¦‚å¤„ç†å¤±è´¥ã€å¼‚å¸¸æƒ…å†µ

---

### 7.3 Wire

#### 7.3.1 æ ¸å¿ƒç‰¹æ€§

**Wire æ˜¯ä»€ä¹ˆï¼Ÿ**

Wire æ˜¯ Google å¼€æºçš„ Go è¯­è¨€ä¾èµ–æ³¨å…¥å·¥å…·ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **ç¼–è¯‘æ—¶æ³¨å…¥**: ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç 
- âœ… **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶æ£€æŸ¥
- âœ… **é›¶åå°„**: è¿è¡Œæ—¶é›¶åå°„
- âœ… **æ€§èƒ½**: æ€§èƒ½ä¼˜ç§€

#### 7.3.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© Wireï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | Wire | Fx | Dig | æ‰‹åŠ¨æ³¨å…¥ | è¯´æ˜ |
|---------|------|------|-----|-----|---------|------|
| **ç¼–è¯‘æ—¶æ£€æŸ¥** | 35% | 10 | 5 | 3 | 8 | Wire ç¼–è¯‘æ—¶æ£€æŸ¥ |
| **æ€§èƒ½** | 25% | 10 | 7 | 6 | 10 | Wire é›¶åå°„ï¼Œæ€§èƒ½ä¼˜ç§€ |
| **æ˜“ç”¨æ€§** | 20% | 8 | 9 | 7 | 6 | Wire ä½¿ç”¨ç®€å• |
| **ç±»å‹å®‰å…¨** | 15% | 10 | 8 | 6 | 9 | Wire ç±»å‹å®‰å…¨ |
| **ç”Ÿæ€æ”¯æŒ** | 5% | 8 | 7 | 6 | 10 | Wire ç”Ÿæ€è‰¯å¥½ |
| **åŠ æƒæ€»åˆ†** | - | **9.30** | 7.20 | 5.55 | 8.50 | Wire å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **ç¼–è¯‘æ—¶æ£€æŸ¥ï¼ˆæƒé‡ 35%ï¼‰**:
   - ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥ä¾èµ–
   - å‡å°‘è¿è¡Œæ—¶é”™è¯¯ï¼Œæé«˜å¯é æ€§
   - IDE æ”¯æŒå¥½ï¼Œé”™è¯¯æç¤ºæ¸…æ™°

2. **æ€§èƒ½ï¼ˆæƒé‡ 25%ï¼‰**:
   - é›¶åå°„ï¼Œæ€§èƒ½ä¼˜ç§€
   - ç”Ÿæˆçš„ä»£ç é«˜æ•ˆ
   - é€‚åˆé«˜æ€§èƒ½åœºæ™¯

3. **ç±»å‹å®‰å…¨ï¼ˆæƒé‡ 15%ï¼‰**:
   - ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
   - é¿å…è¿è¡Œæ—¶ç±»å‹é”™è¯¯
   - ä¸ Go ç±»å‹ç³»ç»Ÿå®Œç¾é›†æˆ

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–ä¾èµ–æ³¨å…¥æ–¹æ¡ˆï¼Ÿ**

1. **Fx**:
   - âœ… åŠŸèƒ½ä¸°å¯Œï¼Œæ”¯æŒç”Ÿå‘½å‘¨æœŸç®¡ç†
   - âŒ è¿è¡Œæ—¶æ³¨å…¥ï¼Œæ€§èƒ½ä¸å¦‚ Wire
   - âŒ ç¼–è¯‘æ—¶æ£€æŸ¥ä¸å¦‚ Wire
   - âŒ å­¦ä¹ æˆæœ¬è¾ƒé«˜

2. **Dig**:
   - âœ… åŠŸèƒ½å®Œæ•´ï¼Œæ”¯æŒå¤æ‚åœºæ™¯
   - âŒ è¿è¡Œæ—¶æ³¨å…¥ï¼Œæ€§èƒ½ä¸å¦‚ Wire
   - âŒ ç¼–è¯‘æ—¶æ£€æŸ¥ä¸å¦‚ Wire
   - âŒ API è¾ƒå¤æ‚

3. **æ‰‹åŠ¨æ³¨å…¥**:
   - âœ… å®Œå…¨æ§åˆ¶ï¼Œæ€§èƒ½æœ€ä¼˜
   - âŒ ä»£ç é‡å¤§ï¼Œç»´æŠ¤æˆæœ¬é«˜
   - âŒ å®¹æ˜“å‡ºé”™ï¼Œæ— ç¼–è¯‘æ—¶æ£€æŸ¥
   - âŒ ä¸é€‚åˆå¤§å‹é¡¹ç›®

#### 7.3.3 å®é™…åº”ç”¨

##### 7.3.3.1 Provider å‡½æ•°ç¼–å†™

**Provider å‡½æ•°ç¤ºä¾‹**:

```go
// internal/wire/wire.go
//go:build wireinject
// +build wireinject

package wire

import (
    "github.com/google/wire"
    "github.com/yourusername/golang/internal/application/user"
    "github.com/yourusername/golang/internal/infrastructure/database/ent"
    entrepo "github.com/yourusername/golang/internal/infrastructure/database/ent/repository"
)

// ProviderSet å®šä¹‰ Provider é›†åˆ
var ProviderSet = wire.NewSet(
    // æ•°æ®åº“
    ent.NewClient,

    // ä»“å‚¨
    entrepo.NewUserRepository,

    // æœåŠ¡
    user.NewService,
)

// InitializeApp åˆå§‹åŒ–åº”ç”¨
func InitializeApp() (*App, error) {
    wire.Build(
        ProviderSet,
        NewApp,
    )
    return &App{}, nil
}
```

##### 7.3.3.2 ä»£ç ç”Ÿæˆ

**ç”Ÿæˆä»£ç **:

```bash
# ç”Ÿæˆ Wire ä»£ç 
go generate ./internal/wire
```

##### 7.3.3.3 ä½¿ç”¨ç”Ÿæˆçš„ä»£ç 

**ä½¿ç”¨ç¤ºä¾‹**:

```go
// cmd/server/main.go
package main

import (
    "github.com/yourusername/golang/internal/wire"
)

func main() {
    app, err := wire.InitializeApp()
    if err != nil {
        log.Fatal(err)
    }

    app.Run()
}
```

#### 7.3.4 æœ€ä½³å®è·µ

##### 7.3.4.1 Provider è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„ Provider è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„ Provider è®¾è®¡å¯ä»¥æé«˜ä¾èµ–æ³¨å…¥çš„å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

**Provider è®¾è®¡åŸåˆ™**:

1. **å•ä¸€èŒè´£**: æ¯ä¸ª Provider åªè´Ÿè´£ä¸€ä¸ªä¾èµ–
2. **æ¥å£ç»‘å®š**: ä½¿ç”¨æ¥å£ç»‘å®šï¼Œæé«˜çµæ´»æ€§
3. **é”™è¯¯å¤„ç†**: æ­£ç¡®å¤„ç† Provider é”™è¯¯
4. **æµ‹è¯•æ”¯æŒ**: æ”¯æŒæµ‹è¯•åœºæ™¯

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// Provider è®¾è®¡æœ€ä½³å®è·µ
// å®šä¹‰æ¥å£
type UserRepository interface {
    Create(ctx context.Context, user *User) error
    Get(ctx context.Context, id string) (*User, error)
}

// Provider å‡½æ•°
func NewUserRepository(client *ent.Client) UserRepository {
    return entrepo.NewUserRepository(client)
}

// ä½¿ç”¨æ¥å£ç»‘å®š
var ProviderSet = wire.NewSet(
    ent.NewClient,
    wire.Bind(new(UserRepository), new(*entrepo.UserRepository)),
    user.NewService,
)
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **å•ä¸€èŒè´£**: æ¯ä¸ª Provider åªè´Ÿè´£ä¸€ä¸ªä¾èµ–
2. **æ¥å£ç»‘å®š**: ä½¿ç”¨æ¥å£ç»‘å®šï¼Œæé«˜çµæ´»æ€§
3. **é”™è¯¯å¤„ç†**: æ­£ç¡®å¤„ç† Provider é”™è¯¯
4. **æµ‹è¯•æ”¯æŒ**: æ”¯æŒæµ‹è¯•åœºæ™¯ï¼Œä¾¿äºå•å…ƒæµ‹è¯•

---

## 8. ğŸ”Œ API åè®®å±‚

### 8.1 gRPC

#### 8.1.1 æ ¸å¿ƒç‰¹æ€§

**gRPC æ˜¯ä»€ä¹ˆï¼Ÿ**

gRPC æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ RPC æ¡†æ¶ã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **é«˜æ€§èƒ½**: åŸºäº HTTP/2ï¼Œæ€§èƒ½ä¼˜ç§€
- âœ… **ç±»å‹å®‰å…¨**: Protocol Buffersï¼Œç±»å‹å®‰å…¨
- âœ… **æµå¼å¤„ç†**: æ”¯æŒæµå¼å¤„ç†
- âœ… **è·¨è¯­è¨€**: æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€

#### 8.1.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© gRPCï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | gRPC | REST | GraphQL | Thrift | è¯´æ˜ |
|---------|------|------|------|---------|--------|------|
| **æ€§èƒ½** | 30% | 10 | 6 | 7 | 9 | gRPC æ€§èƒ½æœ€ä¼˜ |
| **ç±»å‹å®‰å…¨** | 25% | 10 | 5 | 8 | 10 | gRPC Protocol Buffers ç±»å‹å®‰å…¨ |
| **æµå¼å¤„ç†** | 20% | 10 | 5 | 6 | 8 | gRPC æµå¼å¤„ç†æœ€å®Œå–„ |
| **ç”Ÿæ€æ”¯æŒ** | 15% | 10 | 10 | 9 | 7 | gRPC ç”Ÿæ€æœ€ä¸°å¯Œ |
| **å­¦ä¹ æˆæœ¬** | 10% | 7 | 9 | 6 | 7 | gRPC å­¦ä¹ æˆæœ¬é€‚ä¸­ |
| **åŠ æƒæ€»åˆ†** | - | **9.40** | 6.80 | 7.40 | 8.60 | gRPC å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **æ€§èƒ½ï¼ˆæƒé‡ 30%ï¼‰**:
   - åŸºäº HTTP/2ï¼Œæ€§èƒ½ä¼˜ç§€
   - äºŒè¿›åˆ¶åè®®ï¼Œä¼ è¾“æ•ˆç‡é«˜
   - æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œå‡å°‘è¿æ¥æ•°

2. **ç±»å‹å®‰å…¨ï¼ˆæƒé‡ 25%ï¼‰**:
   - Protocol Buffersï¼Œç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
   - ä»£ç ç”Ÿæˆï¼Œå‡å°‘æ‰‹å†™ä»£ç 
   - ç‰ˆæœ¬å…¼å®¹æ€§å¥½

3. **æµå¼å¤„ç†ï¼ˆæƒé‡ 20%ï¼‰**:
   - æ”¯æŒå•å‘æµå’ŒåŒå‘æµ
   - é€‚åˆå®æ—¶æ•°æ®æµåœºæ™¯
   - æ”¯æŒæµå¼ RPC

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»– RPC æ–¹æ¡ˆï¼Ÿ**

1. **REST**:
   - âœ… ç®€å•æ˜“ç”¨ï¼ŒHTTP æ ‡å‡†
   - âŒ æ€§èƒ½ä¸å¦‚ gRPC
   - âŒ æ— ç±»å‹å®‰å…¨ä¿è¯
   - âŒ ä¸æ”¯æŒæµå¼å¤„ç†

2. **GraphQL**:
   - âœ… çµæ´»çš„æŸ¥è¯¢ï¼Œå®¢æˆ·ç«¯æ§åˆ¶
   - âŒ æ€§èƒ½ä¸å¦‚ gRPC
   - âŒ å­¦ä¹ æˆæœ¬é«˜
   - âŒ ä¸é€‚åˆé«˜æ€§èƒ½åœºæ™¯

3. **Thrift**:
   - âœ… æ€§èƒ½ä¼˜ç§€ï¼Œç±»å‹å®‰å…¨
   - âŒ ç”Ÿæ€ä¸å¦‚ gRPC ä¸°å¯Œ
   - âŒ å­¦ä¹ æˆæœ¬è¾ƒé«˜
   - âŒ ç¤¾åŒºä¸å¦‚ gRPC æ´»è·ƒ

#### 8.1.3 å®é™…åº”ç”¨

##### 8.1.3.1 Protocol Buffers å®šä¹‰

**å®šä¹‰æœåŠ¡**:

```protobuf
// api/proto/user.proto
syntax = "proto3";

package user;

service UserService {
    rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
    rpc GetUser(GetUserRequest) returns (GetUserResponse);
    rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
    rpc StreamUsers(StreamUsersRequest) returns (stream User);
}

message CreateUserRequest {
    string email = 1;
    string name = 2;
}

message CreateUserResponse {
    string id = 1;
    string email = 2;
    string name = 3;
}
```

##### 8.1.3.2 æœåŠ¡å®ç°

**æœåŠ¡å®ç°ç¤ºä¾‹**:

```go
// internal/interfaces/grpc/user_service.go
package grpc

import (
    "context"
    "google.golang.org/grpc"
    pb "github.com/yourusername/golang/api/proto/user"
)

type UserServiceServer struct {
    pb.UnimplementedUserServiceServer
    userService appuser.Service
}

func (s *UserServiceServer) CreateUser(ctx context.Context, req *pb.CreateUserRequest) (*pb.CreateUserResponse, error) {
    user, err := s.userService.CreateUser(ctx, appuser.CreateUserRequest{
        Email: req.Email,
        Name:  req.Name,
    })
    if err != nil {
        return nil, err
    }

    return &pb.CreateUserResponse{
        Id:    user.ID,
        Email: user.Email,
        Name:  user.Name,
    }, nil
}
```

##### 8.1.3.3 æœåŠ¡å™¨å¯åŠ¨

**æœåŠ¡å™¨å¯åŠ¨ç¤ºä¾‹**:

```go
// cmd/grpc-server/main.go
package main

import (
    "google.golang.org/grpc"
    pb "github.com/yourusername/golang/api/proto/user"
)

func main() {
    lis, err := net.Listen("tcp", ":50051")
    if err != nil {
        log.Fatal(err)
    }

    s := grpc.NewServer()
    pb.RegisterUserServiceServer(s, &UserServiceServer{})

    if err := s.Serve(lis); err != nil {
        log.Fatal(err)
    }
}
```

##### 8.1.3.4 å®¢æˆ·ç«¯è°ƒç”¨

**å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹**:

```go
// å®¢æˆ·ç«¯è°ƒç”¨
conn, err := grpc.Dial("localhost:50051", grpc.WithInsecure())
if err != nil {
    log.Fatal(err)
}
defer conn.Close()

client := pb.NewUserServiceClient(conn)
resp, err := client.CreateUser(ctx, &pb.CreateUserRequest{
    Email: "user@example.com",
    Name:  "User Name",
})
```

##### 8.1.3.5 æµå¼ RPC

**æµå¼ RPC ç¤ºä¾‹**:

```go
// æœåŠ¡ç«¯æµå¼ RPC
func (s *UserServiceServer) StreamUsers(req *pb.StreamUsersRequest, stream pb.UserService_StreamUsersServer) error {
    users, err := s.userService.ListUsers(stream.Context(), req.Page, req.PageSize)
    if err != nil {
        return err
    }

    for _, user := range users {
        if err := stream.Send(&pb.User{
            Id:    user.ID,
            Email: user.Email,
            Name:  user.Name,
        }); err != nil {
            return err
        }
    }

    return nil
}
```

#### 8.1.4 æœ€ä½³å®è·µ

##### 8.1.4.1 æœåŠ¡è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„æœåŠ¡è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„æœåŠ¡è®¾è®¡å¯ä»¥æé«˜ gRPC æœåŠ¡çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

**æœåŠ¡è®¾è®¡åŸåˆ™**:

1. **æœåŠ¡ç²’åº¦**: åˆç†åˆ’åˆ†æœåŠ¡ç²’åº¦
2. **æ¶ˆæ¯è®¾è®¡**: è®¾è®¡æ¸…æ™°çš„æ¶ˆæ¯ç»“æ„
3. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ gRPC çŠ¶æ€ç å¤„ç†é”™è¯¯
4. **ç‰ˆæœ¬æ§åˆ¶**: æ”¯æŒæœåŠ¡ç‰ˆæœ¬æ§åˆ¶

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```go
// æœåŠ¡è®¾è®¡æœ€ä½³å®è·µ
func (s *UserServiceServer) CreateUser(ctx context.Context, req *pb.CreateUserRequest) (*pb.CreateUserResponse, error) {
    // å‚æ•°éªŒè¯
    if req.Email == "" {
        return nil, status.Error(codes.InvalidArgument, "email is required")
    }

    // ä¸šåŠ¡é€»è¾‘
    user, err := s.userService.CreateUser(ctx, appuser.CreateUserRequest{
        Email: req.Email,
        Name:  req.Name,
    })
    if err != nil {
        // é”™è¯¯å¤„ç†
        if errors.Is(err, errors.ErrConflict) {
            return nil, status.Error(codes.AlreadyExists, err.Error())
        }
        return nil, status.Error(codes.Internal, err.Error())
    }

    return &pb.CreateUserResponse{
        Id:    user.ID,
        Email: user.Email,
        Name:  user.Name,
    }, nil
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **æœåŠ¡ç²’åº¦**: åˆç†åˆ’åˆ†æœåŠ¡ç²’åº¦ï¼Œé¿å…æœåŠ¡è¿‡å¤§æˆ–è¿‡å°
2. **æ¶ˆæ¯è®¾è®¡**: è®¾è®¡æ¸…æ™°çš„æ¶ˆæ¯ç»“æ„ï¼Œä¾¿äºç»´æŠ¤
3. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ gRPC çŠ¶æ€ç å¤„ç†é”™è¯¯ï¼Œæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
4. **ç‰ˆæœ¬æ§åˆ¶**: æ”¯æŒæœåŠ¡ç‰ˆæœ¬æ§åˆ¶ï¼Œä¾¿äºæœåŠ¡æ¼”è¿›

---

### 8.2 GraphQL

#### 8.2.1 æ ¸å¿ƒç‰¹æ€§

**GraphQL æ˜¯ä»€ä¹ˆï¼Ÿ**

GraphQL æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­è¨€å’Œè¿è¡Œæ—¶ç³»ç»Ÿã€‚

**æ ¸å¿ƒç‰¹æ€§**:

- âœ… **çµæ´»æŸ¥è¯¢**: å®¢æˆ·ç«¯å¯ä»¥çµæ´»æŸ¥è¯¢æ•°æ®
- âœ… **ç±»å‹ç³»ç»Ÿ**: å¼ºç±»å‹ç³»ç»Ÿ
- âœ… **å•ä¸€ç«¯ç‚¹**: å•ä¸€ç«¯ç‚¹ï¼Œç®€åŒ– API
- âœ… **å®æ—¶**: æ”¯æŒè®¢é˜…å’Œå®æ—¶æ›´æ–°

#### 8.2.2 é€‰å‹è®ºè¯

**ä¸ºä»€ä¹ˆé€‰æ‹© GraphQLï¼Ÿ**

**è®ºè¯çŸ©é˜µ**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | GraphQL | REST | gRPC | tRPC | è¯´æ˜ |
|---------|------|---------|------|------|------|------|
| **æŸ¥è¯¢çµæ´»æ€§** | 35% | 10 | 5 | 4 | 6 | GraphQL æŸ¥è¯¢æœ€çµæ´» |
| **ç±»å‹ç³»ç»Ÿ** | 25% | 10 | 5 | 10 | 10 | GraphQL ç±»å‹ç³»ç»Ÿå®Œå–„ |
| **å®¢æˆ·ç«¯æ§åˆ¶** | 20% | 10 | 4 | 5 | 6 | GraphQL å®¢æˆ·ç«¯æ§åˆ¶æœ€å¥½ |
| **ç”Ÿæ€æ”¯æŒ** | 15% | 9 | 10 | 10 | 7 | GraphQL ç”Ÿæ€ä¸°å¯Œ |
| **æ€§èƒ½** | 5% | 7 | 6 | 10 | 9 | GraphQL æ€§èƒ½è¶³å¤Ÿ |
| **åŠ æƒæ€»åˆ†** | - | **9.20** | 5.50 | 7.40 | 7.60 | GraphQL å¾—åˆ†æœ€é«˜ |

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **æŸ¥è¯¢çµæ´»æ€§ï¼ˆæƒé‡ 35%ï¼‰**:
   - å®¢æˆ·ç«¯æ§åˆ¶æŸ¥è¯¢å­—æ®µï¼Œå‡å°‘è¿‡åº¦è·å–
   - æ”¯æŒåµŒå¥—æŸ¥è¯¢ï¼Œä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰æ•°æ®
   - æ”¯æŒæŸ¥è¯¢ç»„åˆï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•°

2. **ç±»å‹ç³»ç»Ÿï¼ˆæƒé‡ 25%ï¼‰**:
   - å¼ºç±»å‹ç³»ç»Ÿï¼Œç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
   - Schema å®šä¹‰æ¸…æ™°ï¼Œæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
   - ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯

3. **å®¢æˆ·ç«¯æ§åˆ¶ï¼ˆæƒé‡ 20%ï¼‰**:
   - å®¢æˆ·ç«¯å†³å®šéœ€è¦å“ªäº›å­—æ®µ
   - å‡å°‘ç½‘ç»œä¼ è¾“ï¼Œæé«˜æ€§èƒ½
   - é€‚åˆç§»åŠ¨ç«¯å’Œ Web ç«¯

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»– API æ–¹æ¡ˆï¼Ÿ**

1. **REST**:
   - âœ… ç®€å•æ˜“ç”¨ï¼ŒHTTP æ ‡å‡†
   - âŒ æŸ¥è¯¢çµæ´»æ€§ä¸å¦‚ GraphQL
   - âŒ å®¹æ˜“è¿‡åº¦è·å–æ•°æ®
   - âŒ ç±»å‹ç³»ç»Ÿä¸å¦‚ GraphQL

2. **gRPC**:
   - âœ… æ€§èƒ½ä¼˜ç§€ï¼Œç±»å‹å®‰å…¨
   - âŒ æŸ¥è¯¢çµæ´»æ€§ä¸å¦‚ GraphQL
   - âŒ å®¢æˆ·ç«¯æ§åˆ¶ä¸å¦‚ GraphQL
   - âŒ ä¸é€‚åˆ Web å‰ç«¯ç›´æ¥è°ƒç”¨

3. **tRPC**:
   - âœ… ç±»å‹å®‰å…¨ï¼Œæ€§èƒ½ä¼˜ç§€
   - âŒ ä¸»è¦é¢å‘ TypeScriptï¼ŒGo æ”¯æŒæœ‰é™
   - âŒ ç”Ÿæ€ä¸å¦‚ GraphQL ä¸°å¯Œ
   - âŒ å­¦ä¹ æˆæœ¬è¾ƒé«˜

#### 8.2.3 å®é™…åº”ç”¨

##### 8.2.3.1 Schema å®šä¹‰

**Schema å®šä¹‰ç¤ºä¾‹**:

```graphql
# api/graphql/schema.graphql
type User {
    id: ID!
    email: String!
    name: String!
    createdAt: String!
    updatedAt: String!
}

type Query {
    user(id: ID!): User
    users(page: Int, pageSize: Int): [User!]!
}

type Mutation {
    createUser(email: String!, name: String!): User!
    updateUser(id: ID!, email: String, name: String): User!
    deleteUser(id: ID!): Boolean!
}
```

##### 8.2.3.2 æŸ¥è¯¢è§£æå™¨

**æŸ¥è¯¢è§£æå™¨ç¤ºä¾‹**:

```go
// internal/interfaces/graphql/resolvers/user.go
package resolvers

import (
    "context"
    "github.com/graph-gophers/graphql-go"
    appuser "github.com/yourusername/golang/internal/application/user"
)

type UserResolver struct {
    user *appuser.User
}

func (r *UserResolver) ID() graphql.ID {
    return graphql.ID(r.user.ID)
}

func (r *UserResolver) Email() string {
    return r.user.Email
}

func (r *UserResolver) Name() string {
    return r.user.Name
}

type QueryResolver struct {
    userService appuser.Service
}

func (r *QueryResolver) User(ctx context.Context, args struct{ ID graphql.ID }) (*UserResolver, error) {
    user, err := r.userService.GetUser(ctx, string(args.ID))
    if err != nil {
        return nil, err
    }

    return &UserResolver{user: user}, nil
}
```

##### 8.2.3.3 å˜æ›´è§£æå™¨

**å˜æ›´è§£æå™¨ç¤ºä¾‹**:

```go
// å˜æ›´è§£æå™¨
type MutationResolver struct {
    userService appuser.Service
}

func (r *MutationResolver) CreateUser(ctx context.Context, args struct {
    Email string
    Name  string
}) (*UserResolver, error) {
    user, err := r.userService.CreateUser(ctx, appuser.CreateUserRequest{
        Email: args.Email,
        Name:  args.Name,
    })
    if err != nil {
        return nil, err
    }

    return &UserResolver{user: user}, nil
}
```

##### 8.2.3.4 æ•°æ®åŠ è½½å™¨

**æ•°æ®åŠ è½½å™¨ç¤ºä¾‹**:

```go
// æ•°æ®åŠ è½½å™¨ï¼ˆè§£å†³ N+1 æŸ¥è¯¢é—®é¢˜ï¼‰
type UserLoader struct {
    userService appuser.Service
    cache       map[string]*appuser.User
}

func (l *UserLoader) Load(ctx context.Context, id string) (*appuser.User, error) {
    if user, ok := l.cache[id]; ok {
        return user, nil
    }

    user, err := l.userService.GetUser(ctx, id)
    if err != nil {
        return nil, err
    }

    l.cache[id] = user
    return user, nil
}
```

#### 8.2.4 æœ€ä½³å®è·µ

##### 8.2.4.1 Schema è®¾è®¡æœ€ä½³å®è·µ

**ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„ Schema è®¾è®¡ï¼Ÿ**

è‰¯å¥½çš„ Schema è®¾è®¡å¯ä»¥æé«˜ GraphQL API çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

**Schema è®¾è®¡åŸåˆ™**:

1. **ç±»å‹è®¾è®¡**: è®¾è®¡æ¸…æ™°çš„ç±»å‹ç»“æ„
2. **æŸ¥è¯¢è®¾è®¡**: è®¾è®¡åˆç†çš„æŸ¥è¯¢æ¥å£
3. **å˜æ›´è®¾è®¡**: è®¾è®¡æ¸…æ™°çš„å˜æ›´æ¥å£
4. **ç‰ˆæœ¬æ§åˆ¶**: æ”¯æŒ Schema ç‰ˆæœ¬æ§åˆ¶

**å®é™…åº”ç”¨ç¤ºä¾‹**:

```graphql
# Schema è®¾è®¡æœ€ä½³å®è·µ
type User {
    id: ID!
    email: String!
    name: String!
    profile: UserProfile
    orders: [Order!]!
}

type UserProfile {
    bio: String
    avatar: String
}

type Query {
    # åˆ†é¡µæŸ¥è¯¢
    users(page: Int = 1, pageSize: Int = 20): UserConnection!
    user(id: ID!): User
}

type UserConnection {
    nodes: [User!]!
    totalCount: Int!
    pageInfo: PageInfo!
}
```

**æœ€ä½³å®è·µè¦ç‚¹**:

1. **ç±»å‹è®¾è®¡**: è®¾è®¡æ¸…æ™°çš„ç±»å‹ç»“æ„ï¼Œä¾¿äºç†è§£
2. **æŸ¥è¯¢è®¾è®¡**: è®¾è®¡åˆç†çš„æŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒåˆ†é¡µå’Œè¿‡æ»¤
3. **å˜æ›´è®¾è®¡**: è®¾è®¡æ¸…æ™°çš„å˜æ›´æ¥å£ï¼Œä¾¿äºä½¿ç”¨
4. **ç‰ˆæœ¬æ§åˆ¶**: æ”¯æŒ Schema ç‰ˆæœ¬æ§åˆ¶ï¼Œä¾¿äºæ¼”è¿›

---

## 9. ğŸ”— æŠ€æœ¯æ ˆé›†æˆ

### 9.1 é›†æˆæ¶æ„

**æŠ€æœ¯æ ˆé›†æˆæ¶æ„å›¾**:

```mermaid
graph TB
    subgraph "æ¥å£å±‚"
        HTTP[Chi Router<br/>HTTP API]
        gRPC[gRPC<br/>RPC API]
        GraphQL[GraphQL<br/>æŸ¥è¯¢ API]
    end

    subgraph "åº”ç”¨å±‚"
        App[Application Services]
        Workflow[Temporal Workflow]
    end

    subgraph "åŸºç¡€è®¾æ–½å±‚"
        DB[(PostgreSQL<br/>Ent ORM)]
        Kafka[Kafka<br/>æ¶ˆæ¯é˜Ÿåˆ—]
        MQTT[MQTT<br/>IoT æ¶ˆæ¯]
    end

    subgraph "å¯è§‚æµ‹æ€§"
        OTLP[OpenTelemetry<br/>OTLP]
        Prom[Prometheus<br/>æŒ‡æ ‡]
        Grafana[Grafana<br/>å¯è§†åŒ–]
        Jaeger[Jaeger<br/>è¿½è¸ª]
    end

    subgraph "é…ç½®å’Œå·¥å…·"
        Viper[Viper<br/>é…ç½®ç®¡ç†]
        Slog[Slog<br/>æ—¥å¿—]
        Wire[Wire<br/>ä¾èµ–æ³¨å…¥]
    end

    HTTP --> App
    gRPC --> App
    GraphQL --> App
    App --> DB
    App --> Workflow
    Workflow --> Kafka
    App --> MQTT

    App --> OTLP
    OTLP --> Prom
    OTLP --> Jaeger
    Prom --> Grafana
    Jaeger --> Grafana

    App --> Viper
    App --> Slog
    App --> Wire

    style HTTP fill:#10b981
    style gRPC fill:#10b981
    style GraphQL fill:#10b981
    style App fill:#3b82f6
    style Workflow fill:#3b82f6
    style DB fill:#8b5cf6
    style Kafka fill:#8b5cf6
    style MQTT fill:#8b5cf6
    style OTLP fill:#f59e0b
    style Prom fill:#f59e0b
    style Grafana fill:#f59e0b
    style Jaeger fill:#f59e0b
```

### 9.2 é›†æˆæœ€ä½³å®è·µ

#### 9.2.1 ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ

**ä½¿ç”¨ Wire è¿›è¡Œä¾èµ–æ³¨å…¥**:

```go
// wire.go
//go:build wireinject
// +build wireinject

package main

import (
    "github.com/google/wire"
    // ... å¯¼å…¥
)

func InitializeApp() (*App, error) {
    wire.Build(
        // é…ç½®
        config.NewConfig,

        // æ•°æ®åº“
        database.NewClient,
        repository.NewUserRepository,

        // æœåŠ¡
        service.NewUserService,

        // å¤„ç†å™¨
        handler.NewUserHandler,

        // åº”ç”¨
        NewApp,
    )
    return &App{}, nil
}
```

#### 9.2.2 é…ç½®ç®¡ç†æœ€ä½³å®è·µ

**ä½¿ç”¨ Viper ç®¡ç†é…ç½®**:

```go
// config/config.go
package config

import (
    "github.com/spf13/viper"
)

func LoadConfig() (*Config, error) {
    viper.SetConfigName("config")
    viper.SetConfigType("yaml")
    viper.AddConfigPath("./configs")
    viper.AddConfigPath(".")

    // ç¯å¢ƒå˜é‡
    viper.AutomaticEnv()

    // é»˜è®¤å€¼
    viper.SetDefault("server.port", 8080)

    if err := viper.ReadInConfig(); err != nil {
        return nil, err
    }

    var cfg Config
    if err := viper.Unmarshal(&cfg); err != nil {
        return nil, err
    }

    return &cfg, nil
}
```

#### 9.2.3 æ—¥å¿—æœ€ä½³å®è·µ

**ä½¿ç”¨ Slog ç»“æ„åŒ–æ—¥å¿—**:

```go
// logger/logger.go
package logger

import (
    "log/slog"
    "os"
)

func NewLogger() *slog.Logger {
    opts := &slog.HandlerOptions{
        Level: slog.LevelInfo,
    }

    handler := slog.NewJSONHandler(os.Stdout, opts)
    return slog.New(handler)
}

// ä½¿ç”¨
logger.Info("user created",
    "user_id", userID,
    "email", email,
)
```

#### 9.2.4 å¯è§‚æµ‹æ€§æœ€ä½³å®è·µ

**é›†æˆ OpenTelemetry**:

```go
// observability/tracing.go
package observability

import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/trace"
)

func InitTracing(endpoint string) (*trace.TracerProvider, error) {
    exporter, err := otlptracegrpc.New(
        context.Background(),
        otlptracegrpc.WithEndpoint(endpoint),
    )
    if err != nil {
        return nil, err
    }

    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
        trace.WithResource(resource.NewWithAttributes(
            semconv.SchemaURL,
            semconv.ServiceNameKey.String("my-service"),
        )),
    )

    otel.SetTracerProvider(tp)
    return tp, nil
}
```

---

## 10. ğŸ¯ æŠ€æœ¯æ ˆé€‰å‹å†³ç­–æ ‘

### 10.1 å¯è§‚æµ‹æ€§æŠ€æœ¯æ ˆé€‰å‹å†³ç­–æ ‘

```mermaid
graph TD
    Start[å¯è§‚æµ‹æ€§é€‰å‹] --> Q1{éœ€è¦ç»Ÿä¸€æ ‡å‡†?}
    Q1 -->|æ˜¯| Q2{éœ€è¦ä¸‰æ”¯æŸ±æ”¯æŒ?}
    Q1 -->|å¦| Q3{åªéœ€è¦æŒ‡æ ‡?}

    Q2 -->|æ˜¯| OTLP[OpenTelemetry<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. è¡Œä¸šæ ‡å‡†<br/>2. ä¸‰æ”¯æŸ±æ”¯æŒ<br/>3. ç”Ÿæ€ä¸°å¯Œ]

    Q3 -->|æ˜¯| Prom[Prometheus<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. ç›‘æ§æ ‡å‡†<br/>2. é«˜æ€§èƒ½<br/>3. ç”Ÿæ€ä¸°å¯Œ]

    Start --> Q4{éœ€è¦å¯è§†åŒ–?}
    Q4 -->|æ˜¯| Grafana[Grafana<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. å¯è§†åŒ–å¼ºå¤§<br/>2. æ•°æ®æºä¸°å¯Œ<br/>3. ç¤¾åŒºæ´»è·ƒ]

    Start --> Q5{éœ€è¦åˆ†å¸ƒå¼è¿½è¸ª?}
    Q5 -->|æ˜¯| Q6{éœ€è¦ OTLP é›†æˆ?}
    Q6 -->|æ˜¯| Jaeger[Jaeger<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. OTLP é›†æˆ<br/>2. å¯è§†åŒ–å®Œå–„<br/>3. å¼€æºå…è´¹]

    style OTLP fill:#10b981
    style Prom fill:#10b981
    style Grafana fill:#10b981
    style Jaeger fill:#10b981
```

### 10.2 æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹å†³ç­–æ ‘

```mermaid
graph TD
    Start[æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹] --> Q1{ä½¿ç”¨åœºæ™¯?}
    Q1 -->|å¤§æ•°æ®æµå¤„ç†| Kafka[Kafka<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. é«˜ååé‡<br/>2. æŒä¹…åŒ–<br/>3. åˆ†åŒºæ”¯æŒ]
    Q1 -->|IoT è®¾å¤‡é€šä¿¡| MQTT[MQTT<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. IoT é€‚é…<br/>2. è½»é‡çº§<br/>3. QoS æ”¯æŒ]
    Q1 -->|ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—| RabbitMQ[RabbitMQ<br/>âŒ æœªé€‰æ‹©<br/>ç†ç”±:<br/>1. æ€§èƒ½ä¸å¦‚ Kafka<br/>2. ä¸é€‚åˆå¤§æ•°æ®æµ]

    style Kafka fill:#10b981
    style MQTT fill:#10b981
    style RabbitMQ fill:#ef4444
```

### 10.3 é…ç½®ç®¡ç†é€‰å‹å†³ç­–æ ‘

```mermaid
graph TD
    Start[é…ç½®ç®¡ç†é€‰å‹] --> Q1{éœ€è¦å¤šæ ¼å¼æ”¯æŒ?}
    Q1 -->|æ˜¯| Q2{éœ€è¦è¿œç¨‹é…ç½®?}
    Q1 -->|å¦| Q3{åªéœ€è¦ç¯å¢ƒå˜é‡?}

    Q2 -->|æ˜¯| Viper[Viper<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. åŠŸèƒ½å®Œæ•´<br/>2. å¤šæ ¼å¼æ”¯æŒ<br/>3. æ˜“ç”¨æ€§]

    Q3 -->|æ˜¯| Envconfig[envconfig<br/>âŒ æœªé€‰æ‹©<br/>ç†ç”±:<br/>1. åŠŸèƒ½æœ‰é™<br/>2. ä¸æ”¯æŒæ–‡ä»¶é…ç½®]

    style Viper fill:#10b981
    style Envconfig fill:#ef4444
```

### 10.4 æ—¥å¿—åº“é€‰å‹å†³ç­–æ ‘

```mermaid
graph TD
    Start[æ—¥å¿—åº“é€‰å‹] --> Q1{éœ€è¦æ ‡å‡†åº“?}
    Q1 -->|æ˜¯| Slog[Slog<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. æ ‡å‡†åº“<br/>2. ç»“æ„åŒ–æ—¥å¿—<br/>3. æ€§èƒ½ä¼˜ç§€]
    Q1 -->|å¦| Q2{éœ€è¦é«˜æ€§èƒ½?}

    Q2 -->|æ˜¯| Zap[Zap<br/>âŒ æœªé€‰æ‹©<br/>ç†ç”±:<br/>1. éæ ‡å‡†åº“<br/>2. API å¤æ‚]

    style Slog fill:#10b981
    style Zap fill:#ef4444
```

### 10.5 API åè®®é€‰å‹å†³ç­–æ ‘

```mermaid
graph TD
    Start[API åè®®é€‰å‹] --> Q1{ä½¿ç”¨åœºæ™¯?}
    Q1 -->|å¾®æœåŠ¡é€šä¿¡| gRPC[gRPC<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. é«˜æ€§èƒ½<br/>2. ç±»å‹å®‰å…¨<br/>3. æµå¼å¤„ç†]
    Q1 -->|Web å‰ç«¯æŸ¥è¯¢| GraphQL[GraphQL<br/>âœ… é€‰æ‹©<br/>ç†ç”±:<br/>1. æŸ¥è¯¢çµæ´»<br/>2. ç±»å‹ç³»ç»Ÿ<br/>3. å®¢æˆ·ç«¯æ§åˆ¶]
    Q1 -->|ç®€å• REST API| REST[REST<br/>âŒ æœªé€‰æ‹©<br/>ç†ç”±:<br/>1. æ€§èƒ½ä¸å¦‚ gRPC<br/>2. æ— ç±»å‹å®‰å…¨]

    style gRPC fill:#10b981
    style GraphQL fill:#10b981
    style REST fill:#ef4444
```

---

## ğŸ“š æ‰©å±•é˜…è¯»

### æ¶æ„ç›¸å…³

- [Clean Architecture](./clean-architecture.md) - æ¶æ„è®¾è®¡è¯¦è§£
- [å·¥ä½œæµæ¶æ„è®¾è®¡](./workflow.md) - Temporal å·¥ä½œæµ
- [é¢†åŸŸæ¨¡å‹è®¾è®¡](./domain-model.md) - é¢†åŸŸæ¨¡å‹è®¾è®¡
- [æ¶æ„çŸ¥è¯†å›¾è°±](./00-çŸ¥è¯†å›¾è°±.md) - æ¶æ„çŸ¥è¯†å›¾è°±
- [æŠ€æœ¯å¯¹æ¯”çŸ©é˜µ](./00-å¯¹æ¯”çŸ©é˜µ.md) - æŠ€æœ¯é€‰å‹å¯¹æ¯”
- [Go 1.25.3 æŠ€æœ¯æ ˆå¯¹é½](./00-Go-1.25.3æŠ€æœ¯æ ˆå¯¹é½.md) - Go 1.25.3 æ–°ç‰¹æ€§åº”ç”¨

### æŠ€æœ¯æ–‡æ¡£

- [Chi Router æ–‡æ¡£](https://github.com/go-chi/chi) - Chi å®˜æ–¹æ–‡æ¡£
- [Ent ORM æ–‡æ¡£](https://entgo.io/) - Ent å®˜æ–¹æ–‡æ¡£
- [Temporal æ–‡æ¡£](https://docs.temporal.io/) - Temporal å®˜æ–¹æ–‡æ¡£
- [OpenTelemetry æ–‡æ¡£](https://opentelemetry.io/docs/) - OpenTelemetry å®˜æ–¹æ–‡æ¡£

---

> ğŸ“š **ç®€ä»‹**
> æœ¬æ–‡æ¡£å…¨é¢æ¢³ç†å’Œè®ºè¯äº†é¡¹ç›®ä¸­ä½¿ç”¨çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹æŠ€æœ¯æ ˆï¼ŒåŒ…æ‹¬æ ¸å¿ƒç‰¹æ€§ã€é€‰å‹ç†ç”±ã€é›†æˆæ–¹å¼å’Œæœ€ä½³å®è·µã€‚é€šè¿‡æœ¬æ–‡æ¡£ï¼Œæ‚¨å¯ä»¥å…¨é¢äº†è§£é¡¹ç›®çš„æŠ€æœ¯é€‰å‹å’Œé›†æˆæ–¹å¼ã€‚
