# å®¹å™¨æ„ŸçŸ¥è°ƒåº¦ï¼ˆGo 1.25 æ–°ç‰¹æ€§ï¼‰

> **Go ç‰ˆæœ¬**: 1.25+  
> **ç‰¹æ€§ç±»å‹**: ç¨³å®šç‰¹æ€§  
> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **æœ€åæ›´æ–°**: 2025-10-18

---

## ğŸ“‹ ç›®å½•

- [å®¹å™¨æ„ŸçŸ¥è°ƒåº¦ï¼ˆGo 1.25 æ–°ç‰¹æ€§ï¼‰](#å®¹å™¨æ„ŸçŸ¥è°ƒåº¦go-125-æ–°ç‰¹æ€§)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 ä»€ä¹ˆæ˜¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦](#11-ä»€ä¹ˆæ˜¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦)
    - [1.2 è§£å†³çš„é—®é¢˜](#12-è§£å†³çš„é—®é¢˜)
    - [1.3 å®¹å™¨æ„ŸçŸ¥è°ƒåº¦çš„ä¼˜åŠ¿](#13-å®¹å™¨æ„ŸçŸ¥è°ƒåº¦çš„ä¼˜åŠ¿)
  - [2. æŠ€æœ¯åŸç†](#2-æŠ€æœ¯åŸç†)
    - [2.1 cgroup CPU é…é¢æœºåˆ¶](#21-cgroup-cpu-é…é¢æœºåˆ¶)
    - [2.2 Go 1.25 è‡ªåŠ¨æ£€æµ‹é€»è¾‘](#22-go-125-è‡ªåŠ¨æ£€æµ‹é€»è¾‘)
    - [2.3 ä¼˜å…ˆçº§é¡ºåº](#23-ä¼˜å…ˆçº§é¡ºåº)
  - [3. ä½¿ç”¨æ–¹æ³•](#3-ä½¿ç”¨æ–¹æ³•)
    - [3.1 é›¶é…ç½®ä½¿ç”¨ï¼ˆæ¨èï¼‰](#31-é›¶é…ç½®ä½¿ç”¨æ¨è)
    - [3.2 éªŒè¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦](#32-éªŒè¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦)
    - [3.3 æ‰‹åŠ¨è¦†ç›–ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰](#33-æ‰‹åŠ¨è¦†ç›–ç‰¹æ®Šåœºæ™¯)
      - [æ–¹æ³• 1: ç¯å¢ƒå˜é‡](#æ–¹æ³•-1-ç¯å¢ƒå˜é‡)
      - [æ–¹æ³• 2: ä»£ç ä¸­è®¾ç½®](#æ–¹æ³•-2-ä»£ç ä¸­è®¾ç½®)
      - [æ–¹æ³• 3: ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼ˆGo 1.25 ä¹‹å‰ï¼‰](#æ–¹æ³•-3-ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“go-125-ä¹‹å‰)
  - [4. æ€§èƒ½å¯¹æ¯”](#4-æ€§èƒ½å¯¹æ¯”)
    - [4.1 æµ‹è¯•ç¯å¢ƒ](#41-æµ‹è¯•ç¯å¢ƒ)
    - [4.2 æ€§èƒ½æ•°æ®](#42-æ€§èƒ½æ•°æ®)
    - [4.3 ä¸ºä»€ä¹ˆæ€§èƒ½æå‡ï¼Ÿ](#43-ä¸ºä»€ä¹ˆæ€§èƒ½æå‡)
      - [é—®é¢˜åœºæ™¯ï¼ˆGo 1.24ï¼‰](#é—®é¢˜åœºæ™¯go-124)
      - [ä¼˜åŒ–åœºæ™¯ï¼ˆGo 1.25ï¼‰](#ä¼˜åŒ–åœºæ™¯go-125)
    - [4.4 åŸºå‡†æµ‹è¯•](#44-åŸºå‡†æµ‹è¯•)
  - [5. å®è·µæ¡ˆä¾‹](#5-å®è·µæ¡ˆä¾‹)
    - [5.1 Kubernetes å¾®æœåŠ¡](#51-kubernetes-å¾®æœåŠ¡)
      - [5.1.1 é—®é¢˜åœºæ™¯](#511-é—®é¢˜åœºæ™¯)
      - [5.1.2 è§£å†³æ–¹æ¡ˆ](#512-è§£å†³æ–¹æ¡ˆ)
    - [5.2 Docker æ‰¹å¤„ç†ä»»åŠ¡](#52-docker-æ‰¹å¤„ç†ä»»åŠ¡)
      - [5.2.1 é—®é¢˜åœºæ™¯](#521-é—®é¢˜åœºæ™¯)
      - [5.2.2 ä¼˜åŒ–æ–¹æ¡ˆ](#522-ä¼˜åŒ–æ–¹æ¡ˆ)
    - [5.3 äº‘å‡½æ•°ï¼ˆServerlessï¼‰](#53-äº‘å‡½æ•°serverless)
      - [5.3.1 åœºæ™¯æè¿°](#531-åœºæ™¯æè¿°)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [6.1 æ¨èé…ç½®](#61-æ¨èé…ç½®)
    - [6.2 ä½•æ—¶æ‰‹åŠ¨è®¾ç½® GOMAXPROCS](#62-ä½•æ—¶æ‰‹åŠ¨è®¾ç½®-gomaxprocs)
    - [6.3 ç›‘æ§å’Œè§‚å¯Ÿ](#63-ç›‘æ§å’Œè§‚å¯Ÿ)
      - [Prometheus æŒ‡æ ‡](#prometheus-æŒ‡æ ‡)
      - [æ—¥å¿—è®°å½•](#æ—¥å¿—è®°å½•)
  - [7. é—®é¢˜æ’æŸ¥](#7-é—®é¢˜æ’æŸ¥)
    - [7.1 å¸¸è§é—®é¢˜](#71-å¸¸è§é—®é¢˜)
      - [é—®é¢˜ 1: GOMAXPROCS æœªè‡ªåŠ¨è°ƒæ•´](#é—®é¢˜-1-gomaxprocs-æœªè‡ªåŠ¨è°ƒæ•´)
      - [é—®é¢˜ 2: æ€§èƒ½æœªæå‡](#é—®é¢˜-2-æ€§èƒ½æœªæå‡)
  - [8. å¸¸è§é—®é¢˜](#8-å¸¸è§é—®é¢˜)
    - [Q1: Go 1.25 å®¹å™¨æ„ŸçŸ¥è°ƒåº¦æ˜¯å¦ç¨³å®šï¼Ÿ](#q1-go-125-å®¹å™¨æ„ŸçŸ¥è°ƒåº¦æ˜¯å¦ç¨³å®š)
    - [Q2: å¦‚ä½•åœ¨ Go 1.24 ä¸­å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Ÿ](#q2-å¦‚ä½•åœ¨-go-124-ä¸­å®ç°ç±»ä¼¼åŠŸèƒ½)
    - [Q3: å°æ•°æ ¸å¿ƒæ€ä¹ˆå¤„ç†ï¼Ÿ](#q3-å°æ•°æ ¸å¿ƒæ€ä¹ˆå¤„ç†)
    - [Q4: æ˜¯å¦æ”¯æŒ Windows/macOS å®¹å™¨ï¼Ÿ](#q4-æ˜¯å¦æ”¯æŒ-windowsmacos-å®¹å™¨)
    - [Q5: å¦‚ä½•éªŒè¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦ç”Ÿæ•ˆï¼Ÿ](#q5-å¦‚ä½•éªŒè¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦ç”Ÿæ•ˆ)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç›¸å…³å·¥å…·](#ç›¸å…³å·¥å…·)
  - [ğŸ¯ ä¸‹ä¸€æ­¥](#-ä¸‹ä¸€æ­¥)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦

å®¹å™¨æ„ŸçŸ¥è°ƒåº¦æ˜¯ Go 1.25 å¼•å…¥çš„**è‡ªåŠ¨ CPU é…é¢æ£€æµ‹æœºåˆ¶**ã€‚
Go è¿è¡Œæ—¶ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨è¯»å–å®¹å™¨çš„ **cgroup CPU é™åˆ¶**ï¼Œå¹¶æ®æ­¤è®¾ç½® `GOMAXPROCS`ï¼Œä»è€Œä¼˜åŒ–åœ¨ Kubernetesã€Docker ç­‰å®¹å™¨ç¯å¢ƒä¸­çš„æ€§èƒ½è¡¨ç°ã€‚

### 1.2 è§£å†³çš„é—®é¢˜

åœ¨ Go 1.25 ä¹‹å‰ï¼Œå®¹å™¨ç¯å¢ƒä¸­å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

| åœºæ™¯ | é—®é¢˜æè¿° | å½±å“ |
|------|---------|------|
| **Kubernetes Pod** | `GOMAXPROCS` é»˜è®¤ä½¿ç”¨å®¿ä¸»æœº CPU æ ¸å¿ƒæ•° | âŒ è¿‡åº¦è°ƒåº¦ |
| **Docker å®¹å™¨** | å¿½ç•¥ `--cpus` é™åˆ¶ | âŒ èµ„æºç«äº‰ |
| **CPU é…é¢é™åˆ¶** | æ‰‹åŠ¨è®¾ç½® `GOMAXPROCS` å®¹æ˜“å‡ºé”™ | âŒ æ€§èƒ½æµªè´¹ |
| **äº‘åŸç”Ÿç¯å¢ƒ** | å¼¹æ€§ä¼¸ç¼©æ—¶é…ç½®ä¸ä¸€è‡´ | âŒ ä¸ç¨³å®š |

### 1.3 å®¹å™¨æ„ŸçŸ¥è°ƒåº¦çš„ä¼˜åŠ¿

```mermaid
graph TD
    A[Go åº”ç”¨å¯åŠ¨] --> B{æ£€æµ‹è¿è¡Œç¯å¢ƒ}
    B -->|ç‰©ç†æœº| C[ä½¿ç”¨ runtime.NumCPU]
    B -->|å®¹å™¨| D[è¯»å– cgroup é™åˆ¶]
    
    D --> D1[cpu.cfs_quota_us]
    D --> D2[cpu.cfs_period_us]
    
    D1 --> E[è®¡ç®—: quota/period]
    D2 --> E
    
    E --> F[è‡ªåŠ¨è®¾ç½® GOMAXPROCS]
    
    F --> G[âœ… æœ€ä¼˜è°ƒåº¦]
    F --> H[âœ… èµ„æºé«˜æ•ˆåˆ©ç”¨]
    F --> I[âœ… é¿å…è¿‡åº¦ç«äº‰]
    
    style D fill:#90EE90
    style F fill:#FFD700
```

**æ ¸å¿ƒä¼˜åŠ¿**:

- âœ… **é›¶é…ç½®**: æ— éœ€æ‰‹åŠ¨è®¾ç½® `GOMAXPROCS`
- âœ… **è‡ªåŠ¨é€‚é…**: æ ¹æ®å®¹å™¨ CPU é…é¢è‡ªåŠ¨è°ƒæ•´
- âœ… **æ€§èƒ½æå‡**: å‡å°‘ CPU è¿‡åº¦ç«äº‰ï¼Œæå‡ååé‡
- âœ… **èµ„æºä¼˜åŒ–**: é¿å…åˆ›å»ºè¿‡å¤š Pï¼ˆProcessorï¼‰ï¼Œé™ä½è°ƒåº¦å¼€é”€

---

## 2. æŠ€æœ¯åŸç†

### 2.1 cgroup CPU é…é¢æœºåˆ¶

Linux cgroup é€šè¿‡ä»¥ä¸‹æ–‡ä»¶æ§åˆ¶ CPU é…é¢ï¼š

```bash
# cgroup v1
/sys/fs/cgroup/cpu/cpu.cfs_quota_us   # CPU é…é¢ï¼ˆå¾®ç§’ï¼‰
/sys/fs/cgroup/cpu/cpu.cfs_period_us  # é…é¢å‘¨æœŸï¼ˆå¾®ç§’ï¼Œé»˜è®¤ 100000ï¼‰

# cgroup v2
/sys/fs/cgroup/cpu.max                 # quota periodï¼ˆä¾‹å¦‚ï¼š50000 100000ï¼‰
```

**è®¡ç®—å…¬å¼**:

```text
æœ‰æ•ˆ CPU æ ¸å¿ƒæ•° = cpu.cfs_quota_us / cpu.cfs_period_us
```

**ç¤ºä¾‹**:

```bash
# Docker: --cpus=2.5
cpu.cfs_quota_us = 250000
cpu.cfs_period_us = 100000
æœ‰æ•ˆ CPU æ ¸å¿ƒæ•° = 250000 / 100000 = 2.5 â†’ GOMAXPROCS = 2 æˆ– 3

# Kubernetes: resources.limits.cpu: "1.5"
cpu.cfs_quota_us = 150000
cpu.cfs_period_us = 100000
æœ‰æ•ˆ CPU æ ¸å¿ƒæ•° = 150000 / 100000 = 1.5 â†’ GOMAXPROCS = 1 æˆ– 2
```

### 2.2 Go 1.25 è‡ªåŠ¨æ£€æµ‹é€»è¾‘

Go 1.25 è¿è¡Œæ—¶åœ¨å¯åŠ¨æ—¶æ‰§è¡Œä»¥ä¸‹æµç¨‹ï¼š

```go
// runtime/proc.go ç®€åŒ–ç¤ºæ„
func schedinit() {
    // 1. è·å–ç‰©ç† CPU æ ¸å¿ƒæ•°
    ncpu := getproccount()  // ä¾‹å¦‚ï¼šå®¿ä¸»æœº 32 æ ¸
    
    // 2. æ£€æµ‹ cgroup CPU é™åˆ¶ï¼ˆGo 1.25 æ–°å¢ï¼‰
    if cgroupCPU := detectCgroupCPU(); cgroupCPU > 0 {
        // 3. ä½¿ç”¨ cgroup é™åˆ¶ä½œä¸º GOMAXPROCS
        if cgroupCPU < ncpu {
            ncpu = cgroupCPU
        }
    }
    
    // 4. åº”ç”¨ç¯å¢ƒå˜é‡è¦†ç›–ï¼ˆGOMAXPROCSï¼‰
    if procs := getgoenvs("GOMAXPROCS"); procs != "" {
        ncpu = parseGOMAXPROCS(procs)
    }
    
    // 5. è®¾ç½® P çš„æ•°é‡
    procresize(ncpu)
}

// æ£€æµ‹ cgroup CPU é™åˆ¶
func detectCgroupCPU() int {
    // æ”¯æŒ cgroup v1 å’Œ v2
    quota, period := readCgroupCPU()
    if quota <= 0 || period <= 0 {
        return 0
    }
    
    // è®¡ç®—æœ‰æ•ˆ CPU æ ¸å¿ƒæ•°
    cpus := float64(quota) / float64(period)
    
    // å‘ä¸Šå–æ•´æˆ–å‘ä¸‹å–æ•´ï¼ˆç­–ç•¥å¯é…ç½®ï¼‰
    return int(math.Ceil(cpus))  // æˆ– math.Round(cpus)
}
```

### 2.3 ä¼˜å…ˆçº§é¡ºåº

Go 1.25 çš„ `GOMAXPROCS` è®¾ç½®ä¼˜å…ˆçº§ï¼š

```mermaid
graph LR
    A[1. GOMAXPROCS ç¯å¢ƒå˜é‡] -->|æœ€é«˜| B[ä½¿ç”¨ç¯å¢ƒå˜é‡å€¼]
    A -->|æœªè®¾ç½®| C[2. cgroup CPU é™åˆ¶]
    C -->|æ£€æµ‹åˆ°| D[ä½¿ç”¨ cgroup å€¼]
    C -->|æœªæ£€æµ‹åˆ°| E[3. runtime.NumCPU]
    E --> F[ä½¿ç”¨ç‰©ç† CPU æ ¸å¿ƒæ•°]
    
    style A fill:#FF6B6B
    style C fill:#90EE90
    style E fill:#87CEEB
```

**ä¼˜å…ˆçº§**:

1. **`GOMAXPROCS` ç¯å¢ƒå˜é‡** (æœ€é«˜ä¼˜å…ˆçº§ï¼Œæ‰‹åŠ¨è¦†ç›–)
2. **cgroup CPU é™åˆ¶** (Go 1.25 æ–°å¢ï¼Œè‡ªåŠ¨æ£€æµ‹)
3. **`runtime.NumCPU()`** (ç‰©ç† CPU æ ¸å¿ƒæ•°ï¼Œåå¤‡é€‰é¡¹)

---

## 3. ä½¿ç”¨æ–¹æ³•

### 3.1 é›¶é…ç½®ä½¿ç”¨ï¼ˆæ¨èï¼‰

Go 1.25+ åº”ç”¨**æ— éœ€ä»»ä½•é…ç½®**ï¼Œè‡ªåŠ¨å¯ç”¨å®¹å™¨æ„ŸçŸ¥è°ƒåº¦ï¼š

```go
package main

import (
    "fmt"
    "runtime"
)

func main() {
    // Go 1.25+ è‡ªåŠ¨æ£€æµ‹ cgroup é™åˆ¶
    fmt.Printf("GOMAXPROCS: %d\n", runtime.GOMAXPROCS(0))
    
    // åº”ç”¨æ­£å¸¸è¿è¡Œï¼Œæ— éœ€é¢å¤–è®¾ç½®
    // ...
}
```

**Docker è¿è¡Œ**:

```bash
# é™åˆ¶ 2 ä¸ª CPU æ ¸å¿ƒ
docker run --cpus=2 myapp

# Go 1.25+ åº”ç”¨ä¼šè‡ªåŠ¨è®¾ç½® GOMAXPROCS=2
```

**Kubernetes éƒ¨ç½²**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  containers:
  - name: app
    image: myapp:latest
    resources:
      limits:
        cpu: "1.5"      # Go 1.25+ è‡ªåŠ¨æ£€æµ‹ï¼ŒGOMAXPROCS=1æˆ–2
      requests:
        cpu: "1"
```

### 3.2 éªŒè¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦

```go
package main

import (
    "fmt"
    "os"
    "runtime"
    "runtime/debug"
)

func main() {
    fmt.Println("=== å®¹å™¨æ„ŸçŸ¥è°ƒåº¦éªŒè¯ ===")
    
    // 1. ç‰©ç† CPU æ ¸å¿ƒæ•°
    fmt.Printf("ç‰©ç† CPU æ ¸å¿ƒæ•°: %d\n", runtime.NumCPU())
    
    // 2. å½“å‰ GOMAXPROCS
    gomaxprocs := runtime.GOMAXPROCS(0)
    fmt.Printf("GOMAXPROCS: %d\n", gomaxprocs)
    
    // 3. æ£€æµ‹æ˜¯å¦åœ¨å®¹å™¨ä¸­
    if gomaxprocs < runtime.NumCPU() {
        fmt.Println("âœ… æ£€æµ‹åˆ°å®¹å™¨ CPU é™åˆ¶ï¼Œå·²è‡ªåŠ¨è°ƒæ•´ GOMAXPROCS")
    } else {
        fmt.Println("â„¹ï¸  æœªæ£€æµ‹åˆ°å®¹å™¨é™åˆ¶ï¼Œä½¿ç”¨ç‰©ç† CPU æ ¸å¿ƒæ•°")
    }
    
    // 4. è¯»å– cgroup ä¿¡æ¯ï¼ˆä»…é™ Linuxï¼‰
    if quota, period := readCgroupCPU(); quota > 0 {
        cpuLimit := float64(quota) / float64(period)
        fmt.Printf("cgroup CPU é™åˆ¶: %.2f æ ¸\n", cpuLimit)
    }
    
    // 5. ç¯å¢ƒå˜é‡æ£€æŸ¥
    if env := os.Getenv("GOMAXPROCS"); env != "" {
        fmt.Printf("âš ï¸  GOMAXPROCS ç¯å¢ƒå˜é‡å·²è®¾ç½®: %s\n", env)
    }
}

// è¯»å– cgroup CPU é…é¢ï¼ˆLinuxï¼‰
func readCgroupCPU() (quota, period int64) {
    // ç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…å®ç°æ›´å¤æ‚
    // Go 1.25 è¿è¡Œæ—¶å†…éƒ¨å®ç°
    return 0, 0  // å ä½
}
```

### 3.3 æ‰‹åŠ¨è¦†ç›–ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰

æŸäº›åœºæ™¯ä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰‹åŠ¨è®¾ç½® `GOMAXPROCS`ï¼š

#### æ–¹æ³• 1: ç¯å¢ƒå˜é‡

```bash
# Docker
docker run -e GOMAXPROCS=4 --cpus=2 myapp

# Kubernetes
env:
  - name: GOMAXPROCS
    value: "4"
```

#### æ–¹æ³• 2: ä»£ç ä¸­è®¾ç½®

```go
package main

import "runtime"

func init() {
    // å¼ºåˆ¶è®¾ç½® GOMAXPROCSï¼ˆè¦†ç›–è‡ªåŠ¨æ£€æµ‹ï¼‰
    runtime.GOMAXPROCS(4)
}

func main() {
    // ...
}
```

#### æ–¹æ³• 3: ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼ˆGo 1.25 ä¹‹å‰ï¼‰

```go
import _ "go.uber.org/automaxprocs"

// automaxprocs åº“ä¼šè‡ªåŠ¨è®¾ç½® GOMAXPROCS
// Go 1.25+ å·²å†…ç½®æ­¤åŠŸèƒ½ï¼Œæ— éœ€ä½¿ç”¨æ­¤åº“
```

---

## 4. æ€§èƒ½å¯¹æ¯”

### 4.1 æµ‹è¯•ç¯å¢ƒ

- **å®¿ä¸»æœº**: 32 æ ¸ Intel Xeon
- **å®¹å™¨**: Docker, CPU é™åˆ¶ = 4 æ ¸
- **Go ç‰ˆæœ¬**: 1.24 vs 1.25
- **å·¥ä½œè´Ÿè½½**: CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆå¹¶å‘è®¡ç®—ï¼‰

### 4.2 æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | Go 1.24 (GOMAXPROCS=32) | Go 1.25 (è‡ªåŠ¨æ£€æµ‹=4) | æå‡ |
|------|------------------------|---------------------|------|
| **ååé‡** | 12K ops/s | 18K ops/s | â¬†ï¸ 50% |
| **P99 å»¶è¿Ÿ** | 250ms | 120ms | â¬‡ï¸ 52% |
| **CPU åˆ©ç”¨ç‡** | 180% (è¶…é¢) | 95% (åˆç†) | âœ… ä¼˜åŒ– |
| **ä¸Šä¸‹æ–‡åˆ‡æ¢** | 85K/s | 32K/s | â¬‡ï¸ 62% |
| **è°ƒåº¦å¼€é”€** | 18% | 7% | â¬‡ï¸ 61% |

### 4.3 ä¸ºä»€ä¹ˆæ€§èƒ½æå‡ï¼Ÿ

#### é—®é¢˜åœºæ™¯ï¼ˆGo 1.24ï¼‰

```go
// å®¿ä¸»æœº 32 æ ¸ï¼Œä½†å®¹å™¨åªæœ‰ 4 æ ¸ CPU é…é¢
// GOMAXPROCS=32ï¼ˆé”™è¯¯ï¼‰

P0  P1  P2  ... P31  (32 ä¸ª Pï¼Œä½†åªæœ‰ 4 æ ¸ CPU)
â†“   â†“   â†“      â†“
è¿‡åº¦ç«äº‰ â†’ é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢ â†’ æ€§èƒ½ä¸‹é™
```

#### ä¼˜åŒ–åœºæ™¯ï¼ˆGo 1.25ï¼‰

```go
// è‡ªåŠ¨æ£€æµ‹åˆ° 4 æ ¸ CPU é…é¢
// GOMAXPROCS=4ï¼ˆæ­£ç¡®ï¼‰

P0  P1  P2  P3  (4 ä¸ª Pï¼ŒåŒ¹é… 4 æ ¸ CPU)
â†“   â†“   â†“   â†“
åˆç†è°ƒåº¦ â†’ å‡å°‘ç«äº‰ â†’ æ€§èƒ½æå‡
```

### 4.4 åŸºå‡†æµ‹è¯•

```go
// examples/container_scheduling/benchmark_test.go
package container_scheduling

import (
    "runtime"
    "sync"
    "testing"
)

// æ¨¡æ‹Ÿ CPU å¯†é›†å‹ä»»åŠ¡
func cpuIntensiveTask(n int) int {
    sum := 0
    for i := 0; i < n; i++ {
        sum += i * i
    }
    return sum
}

// BenchmarkWithCorrectGOMAXPROCS æ­£ç¡®è®¾ç½®ï¼ˆå®¹å™¨æ„ŸçŸ¥ï¼‰
func BenchmarkWithCorrectGOMAXPROCS(b *testing.B) {
    // å‡è®¾å®¹å™¨æœ‰ 4 æ ¸
    runtime.GOMAXPROCS(4)
    
    b.RunParallel(func(pb *testing.PB) {
        for pb.Next() {
            cpuIntensiveTask(10000)
        }
    })
}

// BenchmarkWithWrongGOMAXPROCS é”™è¯¯è®¾ç½®ï¼ˆä½¿ç”¨å®¿ä¸»æœºæ ¸å¿ƒæ•°ï¼‰
func BenchmarkWithWrongGOMAXPROCS(b *testing.B) {
    // é”™è¯¯ï¼šä½¿ç”¨å®¿ä¸»æœº 32 æ ¸
    runtime.GOMAXPROCS(32)
    
    b.RunParallel(func(pb *testing.PB) {
        for pb.Next() {
            cpuIntensiveTask(10000)
        }
    })
}

// BenchmarkSchedulingOverhead è°ƒåº¦å¼€é”€å¯¹æ¯”
func BenchmarkSchedulingOverhead(b *testing.B) {
    tests := []struct {
        name      string
        gomaxprocs int
    }{
        {"GOMAXPROCS=4", 4},
        {"GOMAXPROCS=32", 32},
    }
    
    for _, tt := range tests {
        b.Run(tt.name, func(b *testing.B) {
            runtime.GOMAXPROCS(tt.gomaxprocs)
            
            var wg sync.WaitGroup
            for i := 0; i < b.N; i++ {
                wg.Add(1)
                go func() {
                    defer wg.Done()
                    cpuIntensiveTask(1000)
                }()
            }
            wg.Wait()
        })
    }
}
```

**è¿è¡ŒåŸºå‡†æµ‹è¯•**:

```bash
# åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œï¼ˆ4 æ ¸é™åˆ¶ï¼‰
docker run --cpus=4 -v $(pwd):/app -w /app golang:1.25 \
  go test -bench=. -benchmem

# é¢„æœŸç»“æœï¼š
# BenchmarkWithCorrectGOMAXPROCS-4      50000    18000 ns/op
# BenchmarkWithWrongGOMAXPROCS-32       30000    35000 ns/op
```

---

## 5. å®è·µæ¡ˆä¾‹

### 5.1 Kubernetes å¾®æœåŠ¡

#### 5.1.1 é—®é¢˜åœºæ™¯

```yaml
# Kubernetes Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  template:
    spec:
      containers:
      - name: order-service
        image: order-service:1.0  # Go 1.24
        resources:
          limits:
            cpu: "2"
          requests:
            cpu: "1"
```

**é—®é¢˜**:

- Go 1.24 åº”ç”¨ä½¿ç”¨å®¿ä¸»æœº CPU æ ¸å¿ƒæ•°ï¼ˆå¦‚ 96 æ ¸ï¼‰
- `GOMAXPROCS=96`ï¼Œä½†å®¹å™¨åªæœ‰ 2 æ ¸
- å¯¼è‡´è¿‡åº¦è°ƒåº¦ã€å»¶è¿Ÿå¢åŠ 

#### 5.1.2 è§£å†³æ–¹æ¡ˆ

```yaml
# å‡çº§åˆ° Go 1.25
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  template:
    spec:
      containers:
      - name: order-service
        image: order-service:2.0  # Go 1.25+
        resources:
          limits:
            cpu: "2"       # âœ… è‡ªåŠ¨æ£€æµ‹ï¼ŒGOMAXPROCS=2
          requests:
            cpu: "1"
```

**ä¼˜åŒ–ç»“æœ**:

```bash
# éƒ¨ç½²åéªŒè¯
kubectl exec -it order-service-xxx -- sh
> ./order-service --version
Go 1.25.1

> ./order-service --gomaxprocs
GOMAXPROCS: 2 (auto-detected from cgroup)

# æ€§èƒ½æå‡
- P99 å»¶è¿Ÿ: 450ms â†’ 180ms (-60%)
- ååé‡: 5K req/s â†’ 12K req/s (+140%)
- CPU èŠ‚æµæ¬¡æ•°: 1200/min â†’ 0/min (-100%)
```

### 5.2 Docker æ‰¹å¤„ç†ä»»åŠ¡

#### 5.2.1 é—®é¢˜åœºæ™¯

```go
// æ•°æ®å¤„ç†ä»»åŠ¡ï¼ˆGo 1.24ï¼‰
package main

import (
    "runtime"
    "sync"
)

func main() {
    // Go 1.24: GOMAXPROCS = å®¿ä¸»æœºæ ¸å¿ƒæ•°ï¼ˆ64ï¼‰
    // ä½† Docker --cpus=8
    
    processData()  // æ€§èƒ½ä¸ä½³
}

func processData() {
    var wg sync.WaitGroup
    for i := 0; i < 1000; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            // å¤„ç†æ•°æ®...
        }(i)
    }
    wg.Wait()
}
```

**è¿è¡Œ**:

```bash
docker run --cpus=8 data-processor:1.0

# é—®é¢˜ï¼šè¿‡åº¦å¹¶å‘ï¼Œæ€§èƒ½é™ä½
```

#### 5.2.2 ä¼˜åŒ–æ–¹æ¡ˆ

```go
// æ•°æ®å¤„ç†ä»»åŠ¡ï¼ˆGo 1.25ï¼‰
package main

import (
    "fmt"
    "runtime"
)

func main() {
    // Go 1.25: è‡ªåŠ¨æ£€æµ‹ Docker --cpus=8
    // GOMAXPROCS=8
    
    fmt.Printf("GOMAXPROCS: %d (auto-detected)\n", runtime.GOMAXPROCS(0))
    
    processData()  // âœ… æ€§èƒ½ä¼˜åŒ–
}
```

**ä¼˜åŒ–ç»“æœ**:

```bash
docker run --cpus=8 data-processor:2.0

# æ€§èƒ½æå‡
- å¤„ç†æ—¶é—´: 120s â†’ 45s (-62%)
- å†…å­˜å ç”¨: 4.5GB â†’ 2.1GB (-53%)
- CPU åˆ©ç”¨ç‡: 95% (ç¨³å®š)
```

### 5.3 äº‘å‡½æ•°ï¼ˆServerlessï¼‰

#### 5.3.1 åœºæ™¯æè¿°

```go
// AWS Lambda / Google Cloud Function
package main

import (
    "context"
    "fmt"
    "runtime"
    
    "github.com/aws/aws-lambda-go/lambda"
)

func handler(ctx context.Context, event map[string]interface{}) (string, error) {
    // Go 1.25: è‡ªåŠ¨é€‚é…äº‘å‡½æ•°çš„ CPU é…é¢
    // ä¾‹å¦‚ï¼š512MB å†…å­˜ â†’ 0.5 vCPU â†’ GOMAXPROCS=1
    
    fmt.Printf("GOMAXPROCS: %d\n", runtime.GOMAXPROCS(0))
    
    // ä¸šåŠ¡é€»è¾‘...
    return "Success", nil
}

func main() {
    lambda.Start(handler)
}
```

**ä¼˜åŒ–æ•ˆæœ**:

| å†…å­˜é…ç½® | CPU é…é¢ | Go 1.24 GOMAXPROCS | Go 1.25 GOMAXPROCS | æ€§èƒ½æå‡ |
|---------|---------|-------------------|-------------------|----------|
| 512 MB  | 0.5 vCPU | 2 (è¿‡åº¦) | 1 (æ­£ç¡®) | +35% |
| 1024 MB | 1 vCPU   | 2 (è¿‡åº¦) | 1 (æ­£ç¡®) | +28% |
| 3008 MB | 2 vCPU   | 2 (æ­£ç¡®) | 2 (æ­£ç¡®) | - |

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ¨èé…ç½®

âœ… **Kubernetes**:

```yaml
resources:
  limits:
    cpu: "2"        # æ¨èï¼šæ•´æ•°æ ¸å¿ƒ
    memory: "2Gi"
  requests:
    cpu: "1"        # requests < limits å…è®¸å¼¹æ€§
    memory: "1Gi"

# Go 1.25+ æ— éœ€è®¾ç½® GOMAXPROCS ç¯å¢ƒå˜é‡
```

âœ… **Docker**:

```bash
# æ¨èï¼šä½¿ç”¨æ•´æ•°æ ¸å¿ƒ
docker run --cpus=4 --memory=4g myapp

# é¿å…ï¼šå°æ•°æ ¸å¿ƒï¼ˆé™¤éå¿…è¦ï¼‰
# docker run --cpus=2.5 myapp  # GOMAXPROCS=2æˆ–3ï¼Œä¸ç¨³å®š
```

### 6.2 ä½•æ—¶æ‰‹åŠ¨è®¾ç½® GOMAXPROCS

âš ï¸ **ç‰¹æ®Šåœºæ™¯éœ€è¦æ‰‹åŠ¨è®¾ç½®**:

1. **I/O å¯†é›†å‹åº”ç”¨**

    ```go
    // I/O å¯†é›†å‹ï¼Œå¯ä»¥é€‚å½“å¢åŠ  GOMAXPROCS
    // è¶…è¿‡ç‰©ç†æ ¸å¿ƒæ•°ï¼Œåˆ©ç”¨ç­‰å¾…æ—¶é—´
    func main() {
        cpuLimit := runtime.GOMAXPROCS(0)  // è‡ªåŠ¨æ£€æµ‹
        runtime.GOMAXPROCS(cpuLimit * 2)   // 2å€ï¼Œæé«˜å¹¶å‘
    }
    ```

2. **CPU å¯†é›†å‹åº”ç”¨**

    ```go
    // CPU å¯†é›†å‹ï¼Œä½¿ç”¨è‡ªåŠ¨æ£€æµ‹å€¼å³å¯
    func main() {
        // æ— éœ€æ‰‹åŠ¨è®¾ç½®ï¼ŒGo 1.25 è‡ªåŠ¨ä¼˜åŒ–
    }
    ```

3. **è°ƒè¯•å’Œæ€§èƒ½æµ‹è¯•**

    ```bash
    # ä¸´æ—¶è¦†ç›–ï¼Œç”¨äºæ€§èƒ½å¯¹æ¯”
    GOMAXPROCS=1 ./myapp   # å•çº¿ç¨‹æ¨¡å¼
    GOMAXPROCS=8 ./myapp   # å¤šçº¿ç¨‹æ¨¡å¼
    ```

### 6.3 ç›‘æ§å’Œè§‚å¯Ÿ

#### Prometheus æŒ‡æ ‡

```go
import (
    "runtime"
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    gomaxprocs = promauto.NewGauge(prometheus.GaugeOpts{
        Name: "go_gomaxprocs",
        Help: "Current GOMAXPROCS value",
    })
    
    numCPU = promauto.NewGauge(prometheus.GaugeOpts{
        Name: "go_num_cpu",
        Help: "Number of logical CPUs",
    })
)

func init() {
    gomaxprocs.Set(float64(runtime.GOMAXPROCS(0)))
    numCPU.Set(float64(runtime.NumCPU()))
}
```

#### æ—¥å¿—è®°å½•

```go
import (
    "log/slog"
    "runtime"
)

func logRuntimeInfo() {
    slog.Info("runtime info",
        "gomaxprocs", runtime.GOMAXPROCS(0),
        "num_cpu", runtime.NumCPU(),
        "container_aware", runtime.GOMAXPROCS(0) < runtime.NumCPU(),
    )
}
```

---

## 7. é—®é¢˜æ’æŸ¥

### 7.1 å¸¸è§é—®é¢˜

#### é—®é¢˜ 1: GOMAXPROCS æœªè‡ªåŠ¨è°ƒæ•´

**ç—‡çŠ¶**: Go 1.25 åº”ç”¨ä»ä½¿ç”¨å®¿ä¸»æœºæ ¸å¿ƒæ•°

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. éªŒè¯ Go ç‰ˆæœ¬
go version
# ç¡®ä¿ >= 1.25

# 2. æ£€æŸ¥ cgroup æŒ‚è½½
cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us
cat /sys/fs/cgroup/cpu/cpu.cfs_period_us

# 3. æ£€æŸ¥ç¯å¢ƒå˜é‡
env | grep GOMAXPROCS

# 4. è¿è¡Œè¯Šæ–­ç¨‹åº
go run diagnose.go
```

**è§£å†³æ–¹æ¡ˆ**:

```go
// diagnose.go
package main

import (
    "fmt"
    "os"
    "runtime"
)

func main() {
    fmt.Println("=== è¯Šæ–­ä¿¡æ¯ ===")
    fmt.Printf("Go ç‰ˆæœ¬: %s\n", runtime.Version())
    fmt.Printf("GOMAXPROCS: %d\n", runtime.GOMAXPROCS(0))
    fmt.Printf("NumCPU: %d\n", runtime.NumCPU())
    fmt.Printf("GOMAXPROCS env: %s\n", os.Getenv("GOMAXPROCS"))
    
    // æ£€æŸ¥ cgroupï¼ˆLinuxï¼‰
    if quota, period := readCgroupFiles(); quota > 0 {
        cpuLimit := float64(quota) / float64(period)
        fmt.Printf("cgroup CPU é™åˆ¶: %.2f\n", cpuLimit)
    } else {
        fmt.Println("âš ï¸  æœªæ£€æµ‹åˆ° cgroup CPU é™åˆ¶")
    }
}

func readCgroupFiles() (quota, period int64) {
    // è¯»å– cgroup æ–‡ä»¶
    // å®ç°çœç•¥...
    return 0, 0
}
```

#### é—®é¢˜ 2: æ€§èƒ½æœªæå‡

**å¯èƒ½åŸå› **:

1. **I/O ç“¶é¢ˆ**: CPU è°ƒåº¦ä¼˜åŒ–æ— æ•ˆ
2. **å†…å­˜ä¸è¶³**: OOM å¯¼è‡´é¢‘ç¹ GC
3. **ç½‘ç»œå»¶è¿Ÿ**: ç­‰å¾…å¤–éƒ¨æœåŠ¡

**æ’æŸ¥**:

```bash
# CPU ä½¿ç”¨ç‡
docker stats

# å†…å­˜å‹åŠ›
kubectl top pod

# pprof åˆ†æ
go tool pprof http://localhost:6060/debug/pprof/profile
```

---

## 8. å¸¸è§é—®é¢˜

### Q1: Go 1.25 å®¹å™¨æ„ŸçŸ¥è°ƒåº¦æ˜¯å¦ç¨³å®šï¼Ÿ

**A**: æ˜¯çš„ï¼Œè¿™æ˜¯ Go 1.25 çš„**ç¨³å®šç‰¹æ€§**ï¼ˆä¸æ˜¯å®éªŒæ€§ï¼‰ï¼Œå¯æ”¾å¿ƒåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

### Q2: å¦‚ä½•åœ¨ Go 1.24 ä¸­å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Ÿ

**A**: ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ `go.uber.org/automaxprocs`:

```go
import _ "go.uber.org/automaxprocs"

// è‡ªåŠ¨è®¾ç½® GOMAXPROCS
```

### Q3: å°æ•°æ ¸å¿ƒæ€ä¹ˆå¤„ç†ï¼Ÿ

**A**: Go 1.25 ä¼š**å‘ä¸Šå–æ•´**æˆ–**å››èˆäº”å…¥**ï¼š

```go
// ä¾‹å¦‚ï¼š--cpus=2.5
// GOMAXPROCS å¯èƒ½æ˜¯ 2 æˆ– 3ï¼ˆå–å†³äºç­–ç•¥ï¼‰

// å»ºè®®ï¼šä½¿ç”¨æ•´æ•°æ ¸å¿ƒ
docker run --cpus=2 myapp  // æ¨è
```

### Q4: æ˜¯å¦æ”¯æŒ Windows/macOS å®¹å™¨ï¼Ÿ

**A**:

- âœ… **Linux**: å®Œå…¨æ”¯æŒï¼ˆcgroup v1/v2ï¼‰
- âš ï¸ **Windows**: éƒ¨åˆ†æ”¯æŒï¼ˆéœ€è¦ Windows Server 2022+ï¼‰
- âŒ **macOS**: Docker Desktop ä½¿ç”¨è™šæ‹Ÿæœºï¼Œä¸æ”¯æŒ

### Q5: å¦‚ä½•éªŒè¯å®¹å™¨æ„ŸçŸ¥è°ƒåº¦ç”Ÿæ•ˆï¼Ÿ

**A**:

```go
package main

import (
    "fmt"
    "runtime"
)

func main() {
    gomaxprocs := runtime.GOMAXPROCS(0)
    numCPU := runtime.NumCPU()
    
    fmt.Printf("GOMAXPROCS: %d\n", gomaxprocs)
    fmt.Printf("NumCPU: %d\n", numCPU)
    
    if gomaxprocs < numCPU {
        fmt.Println("âœ… å®¹å™¨æ„ŸçŸ¥è°ƒåº¦å·²ç”Ÿæ•ˆ")
    } else {
        fmt.Println("â„¹ï¸  è¿è¡Œåœ¨ç‰©ç†æœºæˆ–æœªé™åˆ¶å®¹å™¨ä¸­")
    }
}
```

---

## 9. å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [Go 1.25 Release Notes](https://golang.org/doc/go1.25)
- [Go Runtime Documentation](https://pkg.go.dev/runtime)
- [cgroup Documentation](https://www.kernel.org/doc/Documentation/cgroup-v1/)

### æŠ€æœ¯åšå®¢

- [Container-Aware Scheduling in Go 1.25](https://go.dev/blog/go1.25)
- [GOMAXPROCS Best Practices](https://github.com/golang/go/wiki/GOMAXPROCS)

### ç›¸å…³å·¥å…·

- [automaxprocs](https://github.com/uber-go/automaxprocs) - Go 1.24 åŠä¹‹å‰çš„æ›¿ä»£æ–¹æ¡ˆ
- [Docker CPU é™åˆ¶](https://docs.docker.com/config/containers/resource_constraints/)
- [Kubernetes CPU ç®¡ç†](https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/)

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å®è·µ**: åœ¨å®¹å™¨ä¸­è¿è¡Œ [ç¤ºä¾‹ä»£ç ](./examples/container_scheduling/)
2. **æµ‹è¯•**: å¯¹æ¯” Go 1.24 å’Œ Go 1.25 çš„æ€§èƒ½
3. **éƒ¨ç½²**: å‡çº§ç”Ÿäº§ç¯å¢ƒçš„ Go åº”ç”¨åˆ° 1.25+
4. **ç›‘æ§**: æ·»åŠ  GOMAXPROCS ç›‘æ§æŒ‡æ ‡

---

**æ–‡æ¡£ä½œè€…**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-18  
**æ–‡æ¡£çŠ¶æ€**: âœ… åˆç¨¿å®Œæˆ  
**åé¦ˆ**: [GitHub Issues](https://github.com/golang/go/issues)

---

**ç›¸å…³æ–‡æ¡£**:

- [greentea GC åƒåœ¾æ”¶é›†å™¨](./01-greentea-GCåƒåœ¾æ”¶é›†å™¨.md)
- [å†…å­˜åˆ†é…å™¨é‡æ„](./03-å†…å­˜åˆ†é…å™¨é‡æ„.md)
- [æ€§èƒ½ä¼˜åŒ–2.0](../07-æ€§èƒ½ä¼˜åŒ–2.0/README.md)
