# 监控和日志

> 📚 **简介**
>
> 本文详细讲解 Go Web 应用的监控和日志最佳实践，包括日志库选择、结构化日志、性能监控、告警机制等内容。良好的监控和日志体系是保障服务稳定运行的关键。
>
> 通过本文，您将学会如何构建完善的可观测性体系。

<!-- TOC START -->
## 📋 目录

- [日志管理](#日志管理)
- [性能监控](#性能监控)
- [告警机制](#告警机制)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)
<!-- TOC END -->

---

## 📝 日志管理

### 日志库选择

#### 1. slog (标准库)

```go
import "log/slog"

func main() {
    logger := slog.New(slog.NewJSONHandler(os.Stdout, nil))
    logger.Info("server started", "port", 8080)
}
```

#### 2. zap (高性能)

```go
import "go.uber.org/zap"

func main() {
    logger, _ := zap.NewProduction()
    defer logger.Sync()
    logger.Info("server started", zap.Int("port", 8080))
}
```

#### 3. logrus (功能丰富)

```go
import "github.com/sirupsen/logrus"

func main() {
    log := logrus.New()
    log.WithFields(logrus.Fields{
        "port": 8080,
    }).Info("server started")
}
```

### 结构化日志

```go
logger.Info("request processed",
    "method", "GET",
    "path", "/api/users",
    "duration", 45,
    "status", 200)
```

### 日志级别

```go
logger.Debug("detailed debug information")
logger.Info("informational message")
logger.Warn("warning message")
logger.Error("error message")
logger.Fatal("fatal error, will exit")
```

---

## 📊 性能监控

### Prometheus 集成

```go
import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )
)

func init() {
    prometheus.MustRegister(httpRequestsTotal)
}
```

### 指标收集

```go
// 请求计数
httpRequestsTotal.WithLabelValues("GET", "/api/users", "200").Inc()

// 响应时间
httpDuration.WithLabelValues("GET", "/api/users").Observe(0.045)

// 内存使用
var m runtime.MemStats
runtime.ReadMemStats(&m)
memoryUsage.Set(float64(m.Alloc))
```

---

## 🚨 告警机制

### 告警规则

```yaml
# prometheus/alerts.yml
groups:
  - name: api_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        annotations:
          summary: "High error rate detected"
```

### 告警通知

- Email
- Slack
- PagerDuty
- Webhook

---

## 🎯 最佳实践

### 1. 日志规范

- 使用结构化日志
- 包含请求 ID
- 记录关键信息
- 避免敏感数据

### 2. 监控指标

- 请求量和响应时间
- 错误率
- 资源使用率
- 业务指标

### 3. 日志分级

```go
logger.Debug("debug info")    // 开发环境
logger.Info("info message")   // 正常流程
logger.Warn("warning")        // 需要注意
logger.Error("error")         // 需要处理
logger.Fatal("fatal")         // 严重错误
```

---

## ❓ 常见问题

### Q: 如何选择日志库？

| 场景 | 推荐 |
|------|------|
| 简单应用 | slog (标准库) |
| 高性能要求 | zap |
| 功能丰富 | logrus |

### Q: 日志应该记录什么？

✅ 应该记录:
- 请求信息
- 错误详情
- 关键业务事件
- 性能指标

❌ 不应该记录:
- 密码
- Token
- 个人隐私信息
- 敏感数据

---

## 🔗 相关链接

- [可观测性实践](../09-工程实践/04-监控与可观测性.md)
- [性能优化](../07-性能优化/README.md)

---

**文档维护者**: Go Documentation Team  
**最后更新**: 2025年10月20日  
**文档状态**: 完成  
**适用版本**: Go 1.21+
