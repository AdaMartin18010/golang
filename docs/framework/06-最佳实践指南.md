# æ¡†æ¶æœ€ä½³å®è·µæŒ‡å—

> **ç‰ˆæœ¬**: v1.0
> **æ—¥æœŸ**: 2025-01-XX
> **ç›®æ ‡**: æä¾›æ¡†æ¶ä½¿ç”¨çš„æœ€ä½³å®è·µå’Œè®¾è®¡æ¨¡å¼

---

## ğŸ“‹ ç›®å½•

- [æ¡†æ¶æœ€ä½³å®è·µæŒ‡å—](#æ¡†æ¶æœ€ä½³å®è·µæŒ‡å—)
  - [1. æ¶æ„è®¾è®¡åŸåˆ™](#1-æ¶æ„è®¾è®¡åŸåˆ™)
  - [2. é¢†åŸŸå±‚è®¾è®¡](#2-é¢†åŸŸå±‚è®¾è®¡)
  - [3. åº”ç”¨å±‚è®¾è®¡](#3-åº”ç”¨å±‚è®¾è®¡)
  - [4. åŸºç¡€è®¾æ–½å±‚è®¾è®¡](#4-åŸºç¡€è®¾æ–½å±‚è®¾è®¡)
  - [5. æ¥å£å±‚è®¾è®¡](#5-æ¥å£å±‚è®¾è®¡)
  - [6. é”™è¯¯å¤„ç†](#6-é”™è¯¯å¤„ç†)
  - [7. æ—¥å¿—è®°å½•](#7-æ—¥å¿—è®°å½•)
  - [8. æµ‹è¯•ç­–ç•¥](#8-æµ‹è¯•ç­–ç•¥)
  - [9. æ€§èƒ½ä¼˜åŒ–](#9-æ€§èƒ½ä¼˜åŒ–)
  - [10. å®‰å…¨å®è·µ](#10-å®‰å…¨å®è·µ)

---

## 1. æ¶æ„è®¾è®¡åŸåˆ™

### 1.1 ä¾èµ–æ–¹å‘

**åŸåˆ™**: ä¾èµ–åº”è¯¥å‘å†…æŒ‡å‘é¢†åŸŸå±‚

```
Interfaces â†’ Application â†’ Domain â† Infrastructure
```

**æ­£ç¡®ç¤ºä¾‹**:
```go
// âœ… æ­£ç¡®ï¼šæ¥å£å±‚ä¾èµ–åº”ç”¨å±‚
type UserHandler struct {
    userService *application.UserService  // ä¾èµ–åº”ç”¨å±‚
}

// âŒ é”™è¯¯ï¼šæ¥å£å±‚ç›´æ¥ä¾èµ–åŸºç¡€è®¾æ–½å±‚
type UserHandler struct {
    db *sql.DB  // ä¸åº”è¯¥ç›´æ¥ä¾èµ–æ•°æ®åº“
}
```

### 1.2 æ¥å£å®šä¹‰ä½ç½®

**åŸåˆ™**: æ¥å£å®šä¹‰åœ¨é¢†åŸŸå±‚ï¼Œå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚

```go
// âœ… æ­£ç¡®ï¼šæ¥å£åœ¨é¢†åŸŸå±‚
// internal/domain/user/repository.go
type Repository interface {
    FindByID(ctx context.Context, id string) (*User, error)
}

// âœ… æ­£ç¡®ï¼šå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚
// internal/infrastructure/database/user_repository.go
type userRepository struct {
    client *ent.Client
}

func (r *userRepository) FindByID(ctx context.Context, id string) (*User, error) {
    // å®ç°
}
```

---

## 2. é¢†åŸŸå±‚è®¾è®¡

### 2.1 å®ä½“è®¾è®¡

**åŸåˆ™**: å®ä½“åº”è¯¥åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯ç®€å•çš„æ•°æ®å®¹å™¨

```go
// âœ… æ­£ç¡®ï¼šå®ä½“åŒ…å«ä¸šåŠ¡é€»è¾‘
type User struct {
    ID    string
    Email string
    Name  string
}

func (u *User) UpdateEmail(newEmail string) error {
    if !isValidEmail(newEmail) {
        return ErrInvalidEmail
    }
    u.Email = newEmail
    return nil
}

// âŒ é”™è¯¯ï¼šå®ä½“åªæ˜¯æ•°æ®å®¹å™¨
type User struct {
    ID    string
    Email string
    Name  string
}
// ä¸šåŠ¡é€»è¾‘åœ¨å¤–éƒ¨
```

### 2.2 å€¼å¯¹è±¡è®¾è®¡

**åŸåˆ™**: ä½¿ç”¨å€¼å¯¹è±¡è¡¨ç¤ºæ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„æ¦‚å¿µ

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å€¼å¯¹è±¡
type Email struct {
    value string
}

func NewEmail(value string) (Email, error) {
    if !isValidEmail(value) {
        return Email{}, ErrInvalidEmail
    }
    return Email{value: value}, nil
}

func (e Email) String() string {
    return e.value
}
```

### 2.3 é¢†åŸŸæœåŠ¡

**åŸåˆ™**: å½“ä¸šåŠ¡é€»è¾‘ä¸å±äºä»»ä½•å®ä½“æ—¶ï¼Œä½¿ç”¨é¢†åŸŸæœåŠ¡

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢†åŸŸæœåŠ¡å¤„ç†è·¨å®ä½“çš„ä¸šåŠ¡é€»è¾‘
type TransferService struct {
    accountRepo AccountRepository
}

func (s *TransferService) Transfer(from, to AccountID, amount Money) error {
    // è·¨å®ä½“çš„ä¸šåŠ¡é€»è¾‘
}
```

---

## 3. åº”ç”¨å±‚è®¾è®¡

### 3.1 åº”ç”¨æœåŠ¡èŒè´£

**åŸåˆ™**: åº”ç”¨æœåŠ¡è´Ÿè´£ç”¨ä¾‹ç¼–æ’ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

```go
// âœ… æ­£ç¡®ï¼šåº”ç”¨æœåŠ¡ç¼–æ’ç”¨ä¾‹
func (s *UserService) CreateUser(ctx context.Context, req CreateUserRequest) (*UserResponse, error) {
    // 1. éªŒè¯è¾“å…¥
    if err := s.validateRequest(req); err != nil {
        return nil, err
    }

    // 2. è°ƒç”¨é¢†åŸŸå±‚
    user, err := domain.NewUser(req.Email, req.Name)
    if err != nil {
        return nil, err
    }

    // 3. æŒä¹…åŒ–
    if err := s.userRepo.Save(ctx, user); err != nil {
        return nil, err
    }

    // 4. å‘å¸ƒäº‹ä»¶
    s.eventBus.Publish(domain.NewUserCreatedEvent(user))

    // 5. è¿”å› DTO
    return toUserResponse(user), nil
}
```

### 3.2 DTO è®¾è®¡

**åŸåˆ™**: ä½¿ç”¨ DTO åœ¨å±‚ä¹‹é—´ä¼ è¾“æ•°æ®

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ DTO
type CreateUserRequest struct {
    Email string `json:"email" validate:"required,email"`
    Name  string `json:"name" validate:"required,min=2,max=50"`
}

type UserResponse struct {
    ID    string `json:"id"`
    Email string `json:"email"`
    Name  string `json:"name"`
}
```

---

## 4. åŸºç¡€è®¾æ–½å±‚è®¾è®¡

### 4.1 ä»“å‚¨å®ç°

**åŸåˆ™**: ä»“å‚¨å®ç°åº”è¯¥éšè—æŠ€æœ¯ç»†èŠ‚

```go
// âœ… æ­£ç¡®ï¼šéšè—æŠ€æœ¯ç»†èŠ‚
func (r *userRepository) FindByID(ctx context.Context, id string) (*domain.User, error) {
    entUser, err := r.client.User.Get(ctx, id)
    if err != nil {
        if ent.IsNotFound(err) {
            return nil, domain.ErrUserNotFound
        }
        return nil, err
    }
    return toDomainUser(entUser), nil
}
```

### 4.2 é…ç½®ç®¡ç†

**åŸåˆ™**: ä½¿ç”¨é…ç½®ç»“æ„ä½“ï¼Œæ”¯æŒç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨é…ç½®ç»“æ„ä½“
type Config struct {
    Database DatabaseConfig `mapstructure:"database"`
    Server   ServerConfig   `mapstructure:"server"`
}

// æ”¯æŒç¯å¢ƒå˜é‡
// DATABASE_HOST=localhost go run main.go
```

---

## 5. æ¥å£å±‚è®¾è®¡

### 5.1 HTTP Handler

**åŸåˆ™**: Handler åº”è¯¥è–„ï¼Œåªè´Ÿè´£è¯·æ±‚/å“åº”è½¬æ¢

```go
// âœ… æ­£ç¡®ï¼šHandler è–„
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
    var req CreateUserRequest
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        response.Error(w, http.StatusBadRequest, errors.NewInvalidInputError("invalid request"))
        return
    }

    user, err := h.userService.CreateUser(r.Context(), req)
    if err != nil {
        response.Error(w, http.StatusInternalServerError, err)
        return
    }

    response.Success(w, http.StatusCreated, user)
}
```

### 5.2 ä¸­é—´ä»¶ä½¿ç”¨

**åŸåˆ™**: ä½¿ç”¨ä¸­é—´ä»¶å¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¸­é—´ä»¶
r.Use(middleware.TracingMiddleware(...))
r.Use(middleware.LoggingMiddleware(...))
r.Use(middleware.AuthMiddleware(...))
r.Use(middleware.RateLimitMiddleware(...))
```

---

## 6. é”™è¯¯å¤„ç†

### 6.1 é”™è¯¯åˆ†ç±»

**åŸåˆ™**: ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¡†æ¶

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ¡†æ¶é”™è¯¯å¤„ç†
import "github.com/yourusername/golang/pkg/errors"

// é¢†åŸŸé”™è¯¯
return errors.NewNotFoundError("user not found")

// åº”ç”¨é”™è¯¯
return errors.NewInvalidInputError("invalid email format")

// ç³»ç»Ÿé”™è¯¯
return errors.NewInternalError("database connection failed")
```

### 6.2 é”™è¯¯åŒ…è£…

**åŸåˆ™**: ä½¿ç”¨ `fmt.Errorf` å’Œ `%w` åŒ…è£…é”™è¯¯

```go
// âœ… æ­£ç¡®ï¼šåŒ…è£…é”™è¯¯
if err := db.Query(ctx, query); err != nil {
    return fmt.Errorf("failed to query user: %w", err)
}
```

---

## 7. æ—¥å¿—è®°å½•

### 7.1 ç»“æ„åŒ–æ—¥å¿—

**åŸåˆ™**: ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯

```go
// âœ… æ­£ç¡®ï¼šç»“æ„åŒ–æ—¥å¿—
logger.Info("user created",
    "user_id", user.ID,
    "email", user.Email,
    "duration_ms", duration.Milliseconds(),
)

// âŒ é”™è¯¯ï¼šéç»“æ„åŒ–æ—¥å¿—
log.Printf("user created: %s", user.ID)
```

### 7.2 æ—¥å¿—çº§åˆ«

**åŸåˆ™**: åˆç†ä½¿ç”¨æ—¥å¿—çº§åˆ«

- **Debug**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- **Info**: é‡è¦çš„ä¸šåŠ¡äº‹ä»¶
- **Warn**: è­¦å‘Šä¿¡æ¯ï¼Œä¸å½±å“åŠŸèƒ½
- **Error**: é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦å…³æ³¨

---

## 8. æµ‹è¯•ç­–ç•¥

### 8.1 å•å…ƒæµ‹è¯•

**åŸåˆ™**: æµ‹è¯•é¢†åŸŸå±‚å’Œåº”ç”¨å±‚ï¼Œä½¿ç”¨ Mock

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Mock æµ‹è¯•åº”ç”¨æœåŠ¡
func TestUserService_CreateUser(t *testing.T) {
    mockRepo := &MockUserRepository{}
    service := NewUserService(mockRepo)

    // æµ‹è¯•é€»è¾‘
}
```

### 8.2 é›†æˆæµ‹è¯•

**åŸåˆ™**: æµ‹è¯•åŸºç¡€è®¾æ–½å±‚å’Œæ¥å£å±‚

```go
// âœ… æ­£ç¡®ï¼šé›†æˆæµ‹è¯•ä½¿ç”¨çœŸå®æ•°æ®åº“
func TestUserRepository_Integration(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)

    repo := NewUserRepository(db)
    // æµ‹è¯•é€»è¾‘
}
```

---

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 æ•°æ®åº“æŸ¥è¯¢

**åŸåˆ™**: ä½¿ç”¨ç´¢å¼•ï¼Œé¿å… N+1 æŸ¥è¯¢

```go
// âœ… æ­£ç¡®ï¼šæ‰¹é‡æŸ¥è¯¢
users, err := repo.FindByIDs(ctx, ids)

// âŒ é”™è¯¯ï¼šN+1 æŸ¥è¯¢
for _, id := range ids {
    user, _ := repo.FindByID(ctx, id)
}
```

### 9.2 ç¼“å­˜ä½¿ç”¨

**åŸåˆ™**: ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¼“å­˜
user, err := cache.Get(ctx, key)
if err == nil {
    return user, nil
}

user, err := repo.FindByID(ctx, id)
cache.Set(ctx, key, user, 5*time.Minute)
```

---

## 10. å®‰å…¨å®è·µ

### 10.1 è¾“å…¥éªŒè¯

**åŸåˆ™**: å§‹ç»ˆéªŒè¯å’Œæ¸…ç†ç”¨æˆ·è¾“å…¥

```go
// âœ… æ­£ç¡®ï¼šéªŒè¯è¾“å…¥
type CreateUserRequest struct {
    Email string `validate:"required,email"`
    Name  string `validate:"required,min=2,max=50"`
}

if err := validator.Validate(req); err != nil {
    return errors.NewValidationError("invalid input", err)
}
```

### 10.2 è®¤è¯æˆæƒ

**åŸåˆ™**: ä½¿ç”¨ä¸­é—´ä»¶è¿›è¡Œè®¤è¯å’Œæˆæƒ

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨è®¤è¯ä¸­é—´ä»¶
r.Use(middleware.AuthMiddleware(...))
r.Use(middleware.RequireRole("admin"))
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ¶æ„æ¨¡å‹ä¸ä¾èµ–æ³¨å…¥å®Œæ•´è¯´æ˜](../architecture/00-æ¶æ„æ¨¡å‹ä¸ä¾èµ–æ³¨å…¥å®Œæ•´è¯´æ˜.md)
- [æ¡†æ¶ä½¿ç”¨ç¤ºä¾‹è¯´æ˜](02-æ¡†æ¶ä½¿ç”¨ç¤ºä¾‹è¯´æ˜.md)
- [æ¡†æ¶ä»£ç ä¸ä¸šåŠ¡ä»£ç è¯´æ˜](03-æ¡†æ¶ä»£ç ä¸ä¸šåŠ¡ä»£ç è¯´æ˜.md)

---

**æœ€åæ›´æ–°**: 2025-01-XX
