# å†…å­˜åˆ†é…å™¨åŸç†

## ğŸ“‹ ç›®å½•

- [1. å†…å­˜åˆ†é…å™¨æ¦‚è¿°](#1-å†…å­˜åˆ†é…å™¨æ¦‚è¿°)
- [2. å†…å­˜å¸ƒå±€](#2-å†…å­˜å¸ƒå±€)
- [3. åˆ†é…æµç¨‹](#3-åˆ†é…æµç¨‹)
- [4. å¤§å°åˆ†ç±»](#4-å¤§å°åˆ†ç±»)
- [5. mspanè¯¦è§£](#5-mspanè¯¦è§£)
- [6. mcacheä¸mcentral](#6-mcacheä¸mcentral)
- [7. å†…å­˜å›æ”¶](#7-å†…å­˜å›æ”¶)
- [8. ä¼˜åŒ–å®è·µ](#8-ä¼˜åŒ–å®è·µ)

---

## 1. å†…å­˜åˆ†é…å™¨æ¦‚è¿°

### Goå†…å­˜åˆ†é…å™¨ç‰¹ç‚¹

**æ ¸å¿ƒè®¾è®¡ç›®æ ‡**:
- âœ… **é«˜æ€§èƒ½**: å‡å°‘é”ç«äº‰ï¼Œæœ¬åœ°ç¼“å­˜
- âœ… **ä½ç¢ç‰‡**: TCMallocå¯å‘çš„è®¾è®¡
- âœ… **æ”¯æŒGC**: ä¸åƒåœ¾å›æ”¶å™¨åä½œ
- âœ… **å¯æ‰©å±•**: æ”¯æŒå¤šæ ¸å¹¶å‘åˆ†é…

**è®¾è®¡çµæ„Ÿ**:
- åŸºäºTCMalloc (Thread-Caching Malloc)
- åˆ†å±‚ç¼“å­˜æ¶æ„
- å¤§å°åˆ†ç±»ç®¡ç†

---

### ä¸å…¶ä»–åˆ†é…å™¨å¯¹æ¯”

| ç‰¹æ€§ | Go Allocator | TCMalloc | jemalloc | glibc malloc |
|------|--------------|----------|----------|--------------|
| **æ€§èƒ½** | æé«˜ | æé«˜ | é«˜ | ä¸­ |
| **å†…å­˜ç¢ç‰‡** | ä½ | ä½ | ä½ | ä¸­ |
| **å¤šçº¿ç¨‹** | ä¼˜ç§€ | ä¼˜ç§€ | ä¼˜ç§€ | ä¸€èˆ¬ |
| **å†…å­˜å ç”¨** | ä¸­ | ä¸­ | ä¸­ | å° |
| **GCé›†æˆ** | å®Œç¾ | æ—  | æ—  | æ—  |

---

## 2. å†…å­˜å¸ƒå±€

### è™šæ‹Ÿå†…å­˜å¸ƒå±€

```
64ä½ç³»ç»Ÿå†…å­˜å¸ƒå±€:

0xc000000000 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                         â”‚
             â”‚    Heap (åŠ¨æ€åˆ†é…)       â”‚ å¯å¢é•¿
             â”‚                         â”‚
             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
             â”‚  â”‚   Arena     â”‚        â”‚
             â”‚  â”‚   (64MB)    â”‚        â”‚
             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
             â”‚  â”‚   Arena     â”‚        â”‚
             â”‚  â”‚   (64MB)    â”‚        â”‚
             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
             â”‚         ...             â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Stack (goroutineæ ˆ)   â”‚ å‘ä¸‹å¢é•¿
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Data/BSS (å…¨å±€å˜é‡)   â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             
0x0000000000 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Text (ä»£ç æ®µ)         â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Heapå†…å­˜ç»“æ„

```
mheap (å…¨å±€å †)
  â”‚
  â”œâ”€ spans []*mspan         // æ‰€æœ‰spanç´¢å¼•
  â”œâ”€ central [numSpanClasses]*mcentral  // ä¸­å¿ƒç¼“å­˜
  â”œâ”€ arenas [1 << arenaL1Bits]*heapArena  // arenaæ•°ç»„
  â”‚
  â””â”€ heapArena (64MB)
       â”œâ”€ bitmap (æ ‡è®°GCä¿¡æ¯)
       â””â”€ spans [pagesPerArena]*mspan
```

---

### æ ¸å¿ƒæ•°æ®ç»“æ„

```go
// malloc.go
const (
    pageSize    = 8192        // 8KBé¡µ
    pageShift   = 13
    
    heapArenaBytes = 67108864 // 64MB
    pagesPerArena  = heapArenaBytes / pageSize
    
    spanSetBlockEntries = 512  // spané›†åˆå—å¤§å°
)

// mheap
type mheap struct {
    lock      mutex
    pages     pageAlloc  // é¡µåˆ†é…å™¨
    sweepgen  uint32     // sweep generation
    
    // spanç®¡ç†
    allspans []*mspan
    
    // ä¸­å¿ƒç¼“å­˜
    central [numSpanClasses]struct {
        mcentral mcentral
        pad      [cpu.CacheLinePadSize - unsafe.Sizeof(mcentral{})%cpu.CacheLinePadSize]byte
    }
    
    // arena
    arenas [1 << arenaL1Bits]*[1 << arenaL2Bits]*heapArena
}
```

---

## 3. åˆ†é…æµç¨‹

### å°å¯¹è±¡åˆ†é… (< 32KB)

```go
// malloc.go
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
    // 1. è·å–å½“å‰Pçš„mcache
    c := gomcache()
    
    // 2. æå°å¯¹è±¡ (< 16B) - Tinyåˆ†é…
    if size <= maxTinySize {
        off := c.tinyoffset
        if off+size <= maxTinySize && c.tiny != 0 {
            // åœ¨tinyå—ä¸­åˆ†é…
            x := add(c.tiny, off)
            c.tinyoffset = off + size
            return x
        }
        
        // åˆ†é…æ–°çš„tinyå—
        span := c.alloc[tinySpanClass]
        v := nextFreeFast(span)
        if v == 0 {
            v, span, _ = c.nextFree(tinySpanClass)
        }
        c.tiny = v
        c.tinyoffset = size
        return v
    }
    
    // 3. å°å¯¹è±¡ (16B - 32KB) - ä»mcacheåˆ†é…
    var sizeclass uint8
    if size <= smallSizeMax {
        sizeclass = size_to_class8[divRoundUp(size, smallSizeDiv)]
    } else {
        sizeclass = size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)]
    }
    
    span := c.alloc[sizeclass]
    v := nextFreeFast(span)
    if v == 0 {
        // mcacheä¸è¶³ï¼Œä»mcentralè·å–
        v, span, _ = c.nextFree(sizeclass)
    }
    
    return v
}
```

---

### å¤§å¯¹è±¡åˆ†é… (â‰¥ 32KB)

```go
// mcache.go
func largeAlloc(size uintptr, needzero bool) *mspan {
    // è·³è¿‡mcacheå’Œmcentralï¼Œç›´æ¥ä»mheapåˆ†é…
    npages := size >> pageShift
    if size&(pageSize-1) != 0 {
        npages++
    }
    
    // ä»mheapåˆ†é…span
    s := mheap_.allocSpan(npages, spanAllocHeap, false)
    return s
}
```

---

### å®Œæ•´åˆ†é…æµç¨‹å›¾

```
ç¨‹åºè¯·æ±‚åˆ†é…å†…å­˜
        â†“
   å¤§å°åˆ¤æ–­
        â†“
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚         â”‚
 < 16B    16B-32KB    â‰¥ 32KB
   â”‚         â”‚           â”‚
Tinyåˆ†é…  mcache     ç›´æ¥ä»mheap
   â”‚         â”‚           â”‚
   â”‚    â†“ ç¼“å­˜ä¸è¶³        â”‚
   â”‚    mcentral         â”‚
   â”‚         â”‚           â”‚
   â”‚    â†“ ç¼“å­˜ä¸è¶³        â”‚
   â”‚    mheap            â”‚
   â”‚         â”‚           â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    è¿”å›å†…å­˜åœ°å€
```

---

## 4. å¤§å°åˆ†ç±»

### Size Classes

Goå°†å¯¹è±¡æŒ‰å¤§å°åˆ†ä¸º**67ä¸ªsize class**:

```go
// sizeclasses.go (ç®€åŒ–)
var class_to_size = [_NumSizeClasses]uint16{
    0,    // 0
    8,    // 1
    16,   // 2
    24,   // 3
    32,   // 4
    48,   // 5
    64,   // 6
    80,   // 7
    96,   // 8
    112,  // 9
    128,  // 10
    // ... æ›´å¤š
    32768, // 67
}

var class_to_allocnpages = [_NumSizeClasses]uint8{
    0, // 0
    1, // 1:  8B, 1é¡µå¯åˆ†é…1024ä¸ªå¯¹è±¡
    1, // 2: 16B, 1é¡µå¯åˆ†é…512ä¸ªå¯¹è±¡
    1, // 3: 24B, 1é¡µå¯åˆ†é…341ä¸ªå¯¹è±¡
    1, // 4: 32B, 1é¡µå¯åˆ†é…256ä¸ªå¯¹è±¡
    // ...
}
```

---

### å¯¹è±¡å¤§å°æ˜ å°„

**å¿«é€ŸæŸ¥æ‰¾è¡¨**:

```go
// å°å¯¹è±¡ (â‰¤1024B)
var size_to_class8 = [smallSizeMax/smallSizeDiv + 1]uint8{
    0, 1, 2, 3, 3, 4, 4, 5, 5, // 0-72B
    6, 6, 7, 7, 8, 8, // 80-112B
    // ...
}

// ç¤ºä¾‹: åˆ†é…17å­—èŠ‚
// sizeclass = size_to_class8[divRoundUp(17, 8)]
//           = size_to_class8[3] = 3
// å®é™…åˆ†é…: class_to_size[3] = 24å­—èŠ‚
```

**å†…å­˜æµªè´¹è®¡ç®—**:

| è¯·æ±‚å¤§å° | Size Class | å®é™…åˆ†é… | æµªè´¹ | æµªè´¹ç‡ |
|----------|-----------|----------|------|--------|
| 17B | 3 | 24B | 7B | 41% |
| 33B | 5 | 48B | 15B | 45% |
| 65B | 7 | 80B | 15B | 23% |
| 129B | 11 | 144B | 15B | 12% |

**è®¾è®¡æƒè¡¡**: å†…å­˜æµªè´¹ vs ç®¡ç†å¼€é”€

---

## 5. mspanè¯¦è§£

### mspanæ•°æ®ç»“æ„

```go
// mheap.go
type mspan struct {
    // é“¾è¡¨
    next *mspan
    prev *mspan
    
    // åŸºæœ¬ä¿¡æ¯
    startAddr uintptr        // èµ·å§‹åœ°å€
    npages    uintptr        // é¡µæ•°
    
    // åˆ†é…ä¿¡æ¯
    allocCount  uint16       // å·²åˆ†é…å¯¹è±¡æ•°
    freeindex   uintptr      // ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡ç´¢å¼•
    nelems      uintptr      // æ€»å¯¹è±¡æ•°
    
    // ç©ºé—²å¯¹è±¡ç®¡ç†
    allocBits  *gcBits       // åˆ†é…ä½å›¾
    gcmarkBits *gcBits       // GCæ ‡è®°ä½å›¾
    
    // ç±»åˆ«
    spanclass   spanClass    // size class + noscan
    
    // çŠ¶æ€
    state       mSpanStateBox // mSpanInUse/mSpanManualç­‰
    
    // GCç›¸å…³
    sweepgen    uint32       // sweep generation
    divMul      uint32       // é™¤æ³•ä¼˜åŒ–
    
    // ...
}
```

---

### mspançŠ¶æ€è½¬æ¢

```
mSpanDead (åˆå§‹)
    â†“
mSpanInUse (ä½¿ç”¨ä¸­)
    â†“
    â”œâ†’ mSpanManual (æ‰‹åŠ¨ç®¡ç†)
    â””â†’ mSpanFree (ç©ºé—²)
        â†“
    å›æ”¶æˆ–å¤ç”¨
```

---

### mspanåˆ†é…ç¤ºä¾‹

**8KBé¡µåˆ†é…24å­—èŠ‚å¯¹è±¡**:

```
mspan {
    startAddr: 0xc000100000
    npages: 1  (8192å­—èŠ‚)
    spanclass: 3 (24å­—èŠ‚)
    nelems: 341  (8192 / 24 = 341ä¸ªå¯¹è±¡)
}

å†…å­˜å¸ƒå±€:
0xc000100000  [obj0: 24B] [obj1: 24B] ... [obj340: 24B]
               â†‘
          freeindexæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡
```

---

## 6. mcacheä¸mcentral

### mcache - çº¿ç¨‹ç¼“å­˜

```go
// mcache.go
type mcache struct {
    // Tinyåˆ†é…å™¨
    tiny       uintptr  // tinyå—èµ·å§‹åœ°å€
    tinyoffset uintptr  // å½“å‰åç§»
    tinyAllocs uintptr  // tinyåˆ†é…æ¬¡æ•°
    
    // spanç¼“å­˜ (æ¯ä¸ªsize classä¸¤ä¸ª: scan + noscan)
    alloc [numSpanClasses]*mspan
    
    // ç»Ÿè®¡
    local_largefree  uintptr  // å¤§å¯¹è±¡é‡Šæ”¾å­—èŠ‚æ•°
    local_nlargefree uintptr  // å¤§å¯¹è±¡é‡Šæ”¾æ¬¡æ•°
    local_nsmallfree [_NumSizeClasses]uintptr // å°å¯¹è±¡é‡Šæ”¾
    
    // ...
}

const numSpanClasses = _NumSizeClasses * 2  // 67 * 2 = 134
```

**ç‰¹ç‚¹**:
- æ¯ä¸ªPæœ‰ç‹¬ç«‹çš„mcache
- æ— é”è®¿é—®
- scan/noscanåˆ†ç¦»ï¼ˆä¼˜åŒ–GCï¼‰

---

### mcentral - ä¸­å¿ƒç¼“å­˜

```go
// mcentral.go
type mcentral struct {
    spanclass spanClass
    
    // éƒ¨åˆ†ç©ºé—²spanåˆ—è¡¨ (æœ‰ç©ºé—²å¯¹è±¡)
    partial [2]spanSet  // swept/unswept
    
    // å®Œå…¨ç©ºé—²spanåˆ—è¡¨ (æ‰€æœ‰å¯¹è±¡éƒ½ç©ºé—²)
    full    [2]spanSet  // swept/unswept
}

// spanSet - lock-free set
type spanSet struct {
    spineLock mutex
    spine     unsafe.Pointer  // *[N]*spanSetBlock
    spineLen  uintptr
    spineCap  uintptr
    
    // ...
}
```

**mcentralåˆ†é…æµç¨‹**:

```go
// mcentral.go
func (c *mcentral) cacheSpan() *mspan {
    // 1. ä»partialè·å–ï¼ˆæœ‰ç©ºé—²å¯¹è±¡çš„spanï¼‰
    sg := mheap_.sweepgen
    spanBudget := 100
    
    var s *mspan
    for ; spanBudget >= 0; spanBudget-- {
        s = c.partialSwept(sg).pop()
        if s != nil {
            break
        }
        
        // å°è¯•sweepæœªæ¸…ç†çš„span
        s = c.partialUnswept(sg).pop()
        if s != nil {
            s.sweep(true)
            break
        }
    }
    
    // 2. ä»fullè·å–ï¼ˆå…¨ç©ºé—²çš„spanï¼‰
    if s == nil {
        s = c.fullUnswept(sg).pop()
        if s != nil {
            s.sweep(true)
        }
    }
    
    // 3. ä»mheapåˆ†é…æ–°çš„span
    if s == nil {
        s = c.grow()
    }
    
    return s
}
```

---

### mheap - å…¨å±€å †

```go
// mheap.go (ç®€åŒ–)
func (h *mheap) allocSpan(npages uintptr, typ spanAllocType, manual bool) *mspan {
    // åŠ é”
    lock(&h.lock)
    
    // ä»ç©ºé—²é¡µåˆ†é…
    s := h.pages.alloc(npages)
    if s != nil {
        goto HaveSpan
    }
    
    // å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜
    if !h.grow(npage) {
        unlock(&h.lock)
        return nil
    }
    s = h.pages.alloc(npages)
    
HaveSpan:
    // åˆå§‹åŒ–span
    s.init(base, npages)
    
    unlock(&h.lock)
    return s
}
```

---

### ä¸‰çº§ç¼“å­˜æ¶æ„

```
Goroutineè¯·æ±‚å†…å­˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ mcache  â”‚  çº¿ç¨‹ç¼“å­˜ (æ— é”)
   â”‚  (P)    â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚ ç¼“å­˜miss
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚mcentral â”‚  ä¸­å¿ƒç¼“å­˜ (åŠ é”)
   â”‚(å…¨å±€)   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚ ç¼“å­˜miss
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ mheap   â”‚  å…¨å±€å † (åŠ é”)
   â”‚(å…¨å±€)   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚ å†…å­˜ä¸è¶³
        â†“
   æ“ä½œç³»ç»Ÿ (mmap/sbrk)
```

**æ€§èƒ½ä¼˜åŒ–**:
- 95%+ ä»mcacheåˆ†é…ï¼ˆæ— é”ï¼‰
- 4% ä»mcentralåˆ†é…ï¼ˆçŸ­æš‚åŠ é”ï¼‰
- < 1% ä»mheap/OSåˆ†é…ï¼ˆè¾ƒé•¿åŠ é”ï¼‰

---

## 7. å†…å­˜å›æ”¶

### Spanå›æ”¶æµç¨‹

```go
// mcentral.go
func (c *mcentral) uncacheSpan(s *mspan) {
    if s.allocCount == 0 {
        // æ‰€æœ‰å¯¹è±¡éƒ½å·²é‡Šæ”¾ï¼Œæ”¾å›fullåˆ—è¡¨
        c.fullSwept(s.sweepgen).push(s)
    } else {
        // è¿˜æœ‰å¯¹è±¡åœ¨ä½¿ç”¨ï¼Œæ”¾å›partialåˆ—è¡¨
        c.partialSwept(s.sweepgen).push(s)
    }
}
```

---

### å†…å­˜å½’è¿˜OS

```go
// mheap.go
func (h *mheap) scavenge(nbytes int64) int64 {
    // å®šæœŸå°†ç©ºé—²å†…å­˜å½’è¿˜ç»™OS
    released := int64(0)
    
    // éå†ç©ºé—²span
    for released < nbytes {
        s := h.scav.index.find(...)
        if s == nil {
            break
        }
        
        // ä½¿ç”¨madviseå½’è¿˜å†…å­˜
        sysUnused(unsafe.Pointer(s.base()), s.npages<<_PageShift)
        released += int64(s.npages) << _PageShift
    }
    
    return released
}
```

**Scavengerç­–ç•¥** (Go 1.13+):
- åå°goroutineå®šæœŸæ¸…ç†
- æ ¹æ®å†…å­˜å‹åŠ›è°ƒæ•´
- ä½¿ç”¨MADV_DONTNEED/MADV_FREE

---

## 8. ä¼˜åŒ–å®è·µ

### ä¼˜åŒ–1: å‡å°‘åˆ†é…

```go
// âŒ é¢‘ç¹åˆ†é…
func processData(items []Item) []Result {
    var results []Result
    for _, item := range items {
        result := Result{Value: item.Value * 2}  // æ¯æ¬¡åˆ†é…
        results = append(results, result)
    }
    return results
}

// âœ… é¢„åˆ†é…
func processDataOptimized(items []Item) []Result {
    results := make([]Result, 0, len(items))  // é¢„åˆ†é…å®¹é‡
    for _, item := range items {
        result := Result{Value: item.Value * 2}
        results = append(results, result)
    }
    return results
}
```

**æ•ˆæœ**: å‡å°‘70%å†…å­˜åˆ†é…

---

### ä¼˜åŒ–2: å¯¹è±¡æ± 

```go
// âŒ æ¯æ¬¡åˆ†é…
func handleRequest(w http.ResponseWriter, r *http.Request) {
    buf := make([]byte, 4096)  // æ¯æ¬¡4KBåˆ†é…
    // ä½¿ç”¨buf...
}

// âœ… ä½¿ç”¨sync.Pool
var bufPool = sync.Pool{
    New: func() interface{} {
        return make([]byte, 4096)
    },
}

func handleRequestOptimized(w http.ResponseWriter, r *http.Request) {
    buf := bufPool.Get().([]byte)
    defer bufPool.Put(buf)
    // ä½¿ç”¨buf...
}
```

**æ•ˆæœ**: 
- å‡å°‘90%åˆ†é…
- GCå‹åŠ›é™ä½80%

---

### ä¼˜åŒ–3: é€ƒé€¸åˆ†æ

```go
// âŒ é€ƒé€¸åˆ°å †
func createUser() *User {
    user := User{Name: "John"}
    return &user  // é€ƒé€¸
}

// âœ… æ ˆä¸Šåˆ†é…
func createUser() User {
    user := User{Name: "John"}
    return user  // æ ˆä¸Šåˆ†é…
}

// æ£€æŸ¥é€ƒé€¸
// go build -gcflags="-m" main.go
```

**é€ƒé€¸åœºæ™¯**:
- è¿”å›å±€éƒ¨å˜é‡æŒ‡é’ˆ
- å‘é€åˆ°channel
- æ”¾å…¥interface{}
- åˆ‡ç‰‡appendæ‰©å®¹
- é—­åŒ…å¼•ç”¨

---

### ä¼˜åŒ–4: å†…å­˜å¯¹é½

```go
// âŒ æœªå¯¹é½ (24å­—èŠ‚)
type BadStruct struct {
    a bool   // 1 + 7 padding
    b int64  // 8
    c bool   // 1 + 7 padding
}

// âœ… å¯¹é½ (16å­—èŠ‚)
type GoodStruct struct {
    b int64  // 8
    a bool   // 1
    c bool   // 1 + 6 padding
}
```

**æ•ˆæœ**: å‡å°‘33%å†…å­˜å ç”¨

---

### å†…å­˜åˆ†æå·¥å…·

```go
// 1. pprofå†…å­˜åˆ†æ
import _ "net/http/pprof"

// è®¿é—® http://localhost:6060/debug/pprof/heap
// go tool pprof http://localhost:6060/debug/pprof/heap

// 2. MemStats
var m runtime.MemStats
runtime.ReadMemStats(&m)
fmt.Printf("Alloc = %v MB\n", m.Alloc/1024/1024)
fmt.Printf("TotalAlloc = %v MB\n", m.TotalAlloc/1024/1024)
fmt.Printf("Sys = %v MB\n", m.Sys/1024/1024)
fmt.Printf("NumGC = %v\n", m.NumGC)

// 3. trace
// go tool trace trace.out
```

---

### æ€§èƒ½å¯¹æ¯”

| ä¼˜åŒ– | åˆ†é…æ¬¡æ•° | åˆ†é…å­—èŠ‚ | GCæ¬¡æ•° | æ€§èƒ½æå‡ |
|------|----------|----------|--------|----------|
| æ— ä¼˜åŒ– | 1000000 | 400MB | 100 | 1x |
| +é¢„åˆ†é… | 300000 | 120MB | 30 | 3.3x |
| +å¯¹è±¡æ±  | 100000 | 40MB | 10 | 10x |
| +é€ƒé€¸ä¼˜åŒ– | 50000 | 20MB | 5 | 20x |
| +å¯¹é½ | 50000 | 15MB | 5 | 27x |

---

## ğŸ”— ç›¸å…³èµ„æº

- [Go Runtimeæ¶æ„æ€»è§ˆ](./01-Go-Runtimeæ¶æ„æ€»è§ˆ.md)
- [GMPè°ƒåº¦å™¨è¯¦è§£](./02-GMPè°ƒåº¦å™¨è¯¦è§£.md)
- [åƒåœ¾å›æ”¶å™¨è¯¦è§£](./04-åƒåœ¾å›æ”¶å™¨è¯¦è§£.md)
- [å†…å­˜ä¼˜åŒ–](../performance/02-å†…å­˜ä¼˜åŒ–.md)

---

**æœ€åæ›´æ–°**: 2025-10-28  
**Goç‰ˆæœ¬**: 1.25.3  
**æ–‡æ¡£ç±»å‹**: å†…å­˜åˆ†é…å™¨æ·±åº¦è§£æ âœ¨

