# Go 1.25.3æœåŠ¡ç½‘æ ¼ä¸é«˜çº§æµé‡æ²»ç†å®Œæ•´å®æˆ˜

> **ç‰ˆæœ¬**: Go 1.25.3  
> **éš¾åº¦**: â­â­â­â­â­  
> **æ ‡ç­¾**: `Service Mesh` `Istio` `Linkerd` `mTLS` `æµé‡æ²»ç†` `å¤šé›†ç¾¤` `é‡‘ä¸é›€å‘å¸ƒ` `ç†”æ–­é™æµ`

## ğŸ“‹ ç›®å½•


- [1. Service Meshæ¦‚è¿°](#1-service-meshæ¦‚è¿°)
  - [1.1 ä»€ä¹ˆæ˜¯Service Mesh](#11-ä»€ä¹ˆæ˜¯service-mesh)
  - [1.2 ä¸ºä»€ä¹ˆéœ€è¦Service Mesh](#12-ä¸ºä»€ä¹ˆéœ€è¦service-mesh)
- [2. Istioé›†æˆå®æˆ˜](#2-istioé›†æˆå®æˆ˜)
  - [2.1 Istioå®‰è£…ä¸é…ç½®](#21-istioå®‰è£…ä¸é…ç½®)
  - [2.2 GoæœåŠ¡IstioåŒ–](#22-goæœåŠ¡istioåŒ–)
  - [2.3 Kuberneteséƒ¨ç½²æ¸…å•](#23-kuberneteséƒ¨ç½²æ¸…å•)
  - [2.4 VirtualServiceé…ç½®](#24-virtualserviceé…ç½®)
  - [2.5 DestinationRuleé…ç½®](#25-destinationruleé…ç½®)
- [3. Linkerdè½»é‡çº§æ–¹æ¡ˆ](#3-linkerdè½»é‡çº§æ–¹æ¡ˆ)
  - [3.1 Linkerdå®‰è£…](#31-linkerdå®‰è£…)
  - [3.2 æœåŠ¡æ³¨å…¥Linkerd](#32-æœåŠ¡æ³¨å…¥linkerd)
  - [3.3 Linkerdæµé‡åˆ†å‰²](#33-linkerdæµé‡åˆ†å‰²)
  - [3.4 Linkerd Goå®¢æˆ·ç«¯](#34-linkerd-goå®¢æˆ·ç«¯)
- [4. é«˜çº§æµé‡æ²»ç†](#4-é«˜çº§æµé‡æ²»ç†)
  - [4.1 é‡‘ä¸é›€å‘å¸ƒ (Canary Deployment)](#41-é‡‘ä¸é›€å‘å¸ƒ-canary-deployment)
  - [4.2 è“ç»¿éƒ¨ç½² (Blue-Green Deployment)](#42-è“ç»¿éƒ¨ç½²-blue-green-deployment)
  - [4.3 A/Bæµ‹è¯•](#43-abæµ‹è¯•)
  - [4.4 æ•…éšœæ³¨å…¥ (Fault Injection)](#44-æ•…éšœæ³¨å…¥-fault-injection)
- [5. å®‰å…¨é€šä¿¡ä¸mTLS](#5-å®‰å…¨é€šä¿¡ä¸mtls)
  - [5.1 Istio mTLSé…ç½®](#51-istio-mtlsé…ç½®)
  - [5.2 æˆæƒç­–ç•¥](#52-æˆæƒç­–ç•¥)
  - [5.3 JWTè®¤è¯](#53-jwtè®¤è¯)
- [6. å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼](#6-å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼)
  - [6.1 å¤šé›†ç¾¤æ¶æ„](#61-å¤šé›†ç¾¤æ¶æ„)
  - [6.2 é…ç½®å¤šé›†ç¾¤](#62-é…ç½®å¤šé›†ç¾¤)
  - [6.3 è·¨é›†ç¾¤æœåŠ¡å‘ç°](#63-è·¨é›†ç¾¤æœåŠ¡å‘ç°)
  - [6.4 è·¨é›†ç¾¤æµé‡ç®¡ç†](#64-è·¨é›†ç¾¤æµé‡ç®¡ç†)
- [7. å¯è§‚æµ‹æ€§é›†æˆ](#7-å¯è§‚æµ‹æ€§é›†æˆ)
  - [7.1 åˆ†å¸ƒå¼è¿½è¸ª](#71-åˆ†å¸ƒå¼è¿½è¸ª)
  - [7.2 Metricså¯¼å‡º](#72-metricså¯¼å‡º)
  - [7.3 Kialiå¯è§†åŒ–](#73-kialiå¯è§†åŒ–)
- [8. æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ](#8-æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ)
  - [8.1 Sidecarèµ„æºä¼˜åŒ–](#81-sidecarèµ„æºä¼˜åŒ–)
  - [8.2 Sidecar Scopeä¼˜åŒ–](#82-sidecar-scopeä¼˜åŒ–)
  - [8.3 è¿æ¥æ± è°ƒä¼˜](#83-è¿æ¥æ± è°ƒä¼˜)
  - [8.4 æœ€ä½³å®è·µæ¸…å•](#84-æœ€ä½³å®è·µæ¸…å•)
  - [8.5 æ€§èƒ½Benchmarks](#85-æ€§èƒ½benchmarks)
- [9. æ€»ç»“](#9-æ€»ç»“)
  - [9.1 Service Meshé€‰å‹](#91-service-meshé€‰å‹)
  - [9.2 è¿ç§»è·¯å¾„](#92-è¿ç§»è·¯å¾„)
  - [9.3 å…³é”®æŒ‡æ ‡](#93-å…³é”®æŒ‡æ ‡)
- [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)

## 1. Service Meshæ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯Service Mesh

```go
// Service Meshæ ¸å¿ƒæ¦‚å¿µ
/*
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Meshæ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ§åˆ¶å¹³é¢ (Control Plane)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Pilot        â”‚ Citadel      â”‚ Galley       â”‚             â”‚
â”‚  â”‚ (æµé‡ç®¡ç†)    â”‚ (å®‰å…¨è®¤è¯)    â”‚ (é…ç½®ç®¡ç†)    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®å¹³é¢ (Data Plane)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Service Aâ”‚  â”‚ Service Bâ”‚  â”‚ Service Câ”‚                  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”  â”‚                  â”‚
â”‚  â”‚  â”‚App â”‚  â”‚  â”‚  â”‚App â”‚  â”‚  â”‚  â”‚App â”‚  â”‚                  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”˜  â”‚                  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”  â”‚                  â”‚
â”‚  â”‚  â”‚Envoy   â”‚  â”‚  â”‚Envoy   â”‚  â”‚  â”‚Envoy   â”‚                  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”˜  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
*/

// Service Meshä¸ºå¾®æœåŠ¡æä¾›:
// 1. æµé‡ç®¡ç† (Traffic Management)
// 2. å®‰å…¨é€šä¿¡ (Security)
// 3. å¯è§‚æµ‹æ€§ (Observability)
// 4. ç­–ç•¥æ‰§è¡Œ (Policy Enforcement)
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Service Mesh

```go
// ä¼ ç»Ÿå¾®æœåŠ¡é—®é¢˜
type LegacyMicroservice struct {
    // é—®é¢˜1: æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å®ç°
    LoadBalancer     ServiceDiscovery
    CircuitBreaker   ResiliencePattern
    RetryLogic       ErrorHandling
    MetricsCollector Monitoring
    TracingClient    DistributedTracing
    
    // é—®é¢˜2: å¤šè¯­è¨€æ ˆç»´æŠ¤å›°éš¾
    // Java: Hystrix, Ribbon
    // Go: go-resilience, consul
    // Node.js: ä¸åŒåº“
    
    // é—®é¢˜3: å‡çº§å›°éš¾
    // æ¯ä¸ªæœåŠ¡éƒ½è¦ä¿®æ”¹ä»£ç ã€æµ‹è¯•ã€é‡æ–°éƒ¨ç½²
}

// Service Meshè§£å†³æ–¹æ¡ˆ
type ServiceMeshSolution struct {
    // ä¼˜åŠ¿1: åŸºç¡€è®¾æ–½å±‚é¢ç»Ÿä¸€å®ç°
    Sidecar SidecarProxy // Envoy/Linkerd-proxy
    
    // ä¼˜åŠ¿2: åº”ç”¨æ— æ„ŸçŸ¥
    // ä¸éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç 
    // ä¸éœ€è¦å¼•å…¥SDK
    
    // ä¼˜åŠ¿3: ç»Ÿä¸€æ²»ç†
    // æ‰€æœ‰æœåŠ¡ç»Ÿä¸€ç­–ç•¥
    // é›†ä¸­é…ç½®ç®¡ç†
    // å¯è§†åŒ–è¿ç»´
}
```

---

## 2. Istioé›†æˆå®æˆ˜

### 2.1 Istioå®‰è£…ä¸é…ç½®

```bash
# å®‰è£…Istio CLI
curl -L https://istio.io/downloadIstio | sh -
cd istio-1.20.0
export PATH=$PWD/bin:$PATH

# å®‰è£…Istioåˆ°Kubernetes
istioctl install --set profile=demo -y

# å¯ç”¨è‡ªåŠ¨æ³¨å…¥
kubectl label namespace default istio-injection=enabled

# éªŒè¯å®‰è£…
kubectl get pods -n istio-system
```

### 2.2 GoæœåŠ¡IstioåŒ–

```go
// internal/mesh/service.go
package mesh

import (
    "context"
    "fmt"
    "net/http"
    "time"
    
    "github.com/gin-gonic/gin"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/propagation"
)

// IstioService Istioå‹å¥½çš„æœåŠ¡
type IstioService struct {
    name    string
    version string
    router  *gin.Engine
}

// NewIstioService åˆ›å»ºæœåŠ¡
func NewIstioService(name, version string) *IstioService {
    gin.SetMode(gin.ReleaseMode)
    r := gin.New()
    
    // æ·»åŠ Istioå…¼å®¹ä¸­é—´ä»¶
    r.Use(IstioMiddleware())
    
    return &IstioService{
        name:    name,
        version: version,
        router:  r,
    }
}

// IstioMiddleware Istioé›†æˆä¸­é—´ä»¶
func IstioMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. æå–Istioæ³¨å…¥çš„Header
        traceID := c.GetHeader("x-request-id")
        b3TraceID := c.GetHeader("x-b3-traceid")
        
        // 2. è®¾ç½®æœåŠ¡ç‰ˆæœ¬æ ‡è¯†
        c.Header("x-service-version", "v1.0.0")
        
        // 3. ä¼ æ’­è¿½è¸ªä¸Šä¸‹æ–‡
        ctx := c.Request.Context()
        propagator := otel.GetTextMapPropagator()
        ctx = propagator.Extract(ctx, propagation.HeaderCarrier(c.Request.Header))
        c.Request = c.Request.WithContext(ctx)
        
        // 4. è®°å½•è¯·æ±‚ä¿¡æ¯
        fmt.Printf("[Istio] Request: %s, TraceID: %s, B3: %s\n", 
            c.Request.URL.Path, traceID, b3TraceID)
        
        c.Next()
        
        // 5. æ·»åŠ å“åº”Header
        c.Header("x-envoy-upstream-service-time", 
            fmt.Sprintf("%d", time.Since(time.Now()).Milliseconds()))
    }
}

// RegisterRoutes æ³¨å†Œè·¯ç”±
func (s *IstioService) RegisterRoutes() {
    // Health Check (Istioä¼šè°ƒç”¨)
    s.router.GET("/health", s.HealthHandler)
    s.router.GET("/ready", s.ReadyHandler)
    
    // ä¸šåŠ¡æ¥å£
    s.router.GET("/api/users", s.ListUsers)
    s.router.GET("/api/users/:id", s.GetUser)
    s.router.POST("/api/users", s.CreateUser)
}

// HealthHandler Livenessæ¢é’ˆ
func (s *IstioService) HealthHandler(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{
        "status":  "UP",
        "service": s.name,
        "version": s.version,
    })
}

// ReadyHandler Readinessæ¢é’ˆ
func (s *IstioService) ReadyHandler(c *gin.Context) {
    // æ£€æŸ¥ä¾èµ–æœåŠ¡
    if !s.checkDependencies() {
        c.JSON(http.StatusServiceUnavailable, gin.H{
            "status": "NOT_READY",
            "reason": "dependencies not available",
        })
        return
    }
    
    c.JSON(http.StatusOK, gin.H{
        "status": "READY",
    })
}

func (s *IstioService) checkDependencies() bool {
    // æ£€æŸ¥æ•°æ®åº“ã€Redisç­‰
    return true
}

// ListUsers åˆ—è¡¨æ¥å£
func (s *IstioService) ListUsers(c *gin.Context) {
    c.JSON(http.StatusOK, []map[string]interface{}{
        {"id": 1, "name": "Alice"},
        {"id": 2, "name": "Bob"},
    })
}

func (s *IstioService) GetUser(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{"id": c.Param("id"), "name": "Alice"})
}

func (s *IstioService) CreateUser(c *gin.Context) {
    c.JSON(http.StatusCreated, gin.H{"id": 3, "name": "Charlie"})
}

// Run å¯åŠ¨æœåŠ¡
func (s *IstioService) Run(port string) error {
    return s.router.Run(port)
}
```

### 2.3 Kuberneteséƒ¨ç½²æ¸…å•

```yaml
# deployments/user-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: user-service
  labels:
    app: user-service
    service: user-service
spec:
  ports:
  - port: 8080
    name: http
  selector:
    app: user-service
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service-v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: user-service
      version: v1
  template:
    metadata:
      labels:
        app: user-service
        version: v1
    spec:
      containers:
      - name: user-service
        image: myregistry/user-service:v1
        ports:
        - containerPort: 8080
        env:
        - name: SERVICE_NAME
          value: "user-service"
        - name: SERVICE_VERSION
          value: "v1"
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

### 2.4 VirtualServiceé…ç½®

```yaml
# istio/virtualservice.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service
spec:
  hosts:
  - user-service
  http:
  # è·¯ç”±è§„åˆ™1: HeaderåŒ¹é…
  - match:
    - headers:
        x-api-version:
          exact: "v2"
    route:
    - destination:
        host: user-service
        subset: v2
      weight: 100
  
  # è·¯ç”±è§„åˆ™2: é‡‘ä¸é›€å‘å¸ƒ (90% v1, 10% v2)
  - match:
    - uri:
        prefix: "/api/"
    route:
    - destination:
        host: user-service
        subset: v1
      weight: 90
    - destination:
        host: user-service
        subset: v2
      weight: 10
  
  # è¶…æ—¶é…ç½®
  timeout: 5s
  
  # é‡è¯•ç­–ç•¥
  retries:
    attempts: 3
    perTryTimeout: 2s
    retryOn: 5xx,reset,connect-failure,refused-stream
```

### 2.5 DestinationRuleé…ç½®

```yaml
# istio/destinationrule.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: user-service
spec:
  host: user-service
  trafficPolicy:
    # è¿æ¥æ± é…ç½®
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    
    # è´Ÿè½½å‡è¡¡
    loadBalancer:
      simple: LEAST_REQUEST  # ROUND_ROBIN, RANDOM, PASSTHROUGH
    
    # å¼‚å¸¸æ£€æµ‹ (ç†”æ–­)
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 40
  
  # å­é›†å®šä¹‰
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
  
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        consistentHash:
          httpHeaderName: "x-user-id"  # åŸºäºHeaderçš„ä¸€è‡´æ€§Hash
```

---

## 3. Linkerdè½»é‡çº§æ–¹æ¡ˆ

### 3.1 Linkerdå®‰è£…

```bash
# å®‰è£…Linkerd CLI
curl --proto '=https' --tlsv1.2 -sSfL https://run.linkerd.io/install | sh
export PATH=$PATH:$HOME/.linkerd2/bin

# éªŒè¯é›†ç¾¤
linkerd check --pre

# å®‰è£…Linkerdæ§åˆ¶å¹³é¢
linkerd install --crds | kubectl apply -f -
linkerd install | kubectl apply -f -

# éªŒè¯å®‰è£…
linkerd check

# æŸ¥çœ‹Dashboard
linkerd dashboard &
```

### 3.2 æœåŠ¡æ³¨å…¥Linkerd

```yaml
# deployments/product-service.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: product-service
  annotations:
    # å¯ç”¨Linkerdè‡ªåŠ¨æ³¨å…¥
    linkerd.io/inject: enabled
spec:
  replicas: 2
  selector:
    matchLabels:
      app: product-service
  template:
    metadata:
      labels:
        app: product-service
      annotations:
        # Linkerdé…ç½®
        config.linkerd.io/skip-outbound-ports: "3306,6379"  # è·³è¿‡æ•°æ®åº“ç«¯å£
        config.linkerd.io/proxy-cpu-request: "100m"
        config.linkerd.io/proxy-memory-request: "50Mi"
    spec:
      containers:
      - name: product-service
        image: myregistry/product-service:v1
        ports:
        - containerPort: 8080
```

### 3.3 Linkerdæµé‡åˆ†å‰²

```yaml
# linkerd/trafficsplit.yaml
apiVersion: split.smi-spec.io/v1alpha2
kind: TrafficSplit
metadata:
  name: product-service-split
spec:
  service: product-service
  backends:
  - service: product-service-v1
    weight: 80
  - service: product-service-v2
    weight: 20
---
apiVersion: v1
kind: Service
metadata:
  name: product-service-v1
spec:
  selector:
    app: product-service
    version: v1
  ports:
  - port: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: product-service-v2
spec:
  selector:
    app: product-service
    version: v2
  ports:
  - port: 8080
```

### 3.4 Linkerd Goå®¢æˆ·ç«¯

```go
// internal/linkerd/client.go
package linkerd

import (
    "context"
    "fmt"
    "net/http"
    "time"
)

// Client Linkerdå‹å¥½çš„HTTPå®¢æˆ·ç«¯
type Client struct {
    httpClient *http.Client
    serviceName string
}

// NewClient åˆ›å»ºå®¢æˆ·ç«¯
func NewClient(serviceName string) *Client {
    return &Client{
        httpClient: &http.Client{
            Timeout: 10 * time.Second,
            Transport: &http.Transport{
                MaxIdleConns:        100,
                MaxIdleConnsPerHost: 10,
                IdleConnTimeout:     90 * time.Second,
            },
        },
        serviceName: serviceName,
    }
}

// Call è°ƒç”¨æœåŠ¡ (ä½¿ç”¨Kubernetes Service DNS)
func (c *Client) Call(ctx context.Context, method, path string) (*http.Response, error) {
    // Linkerdè‡ªåŠ¨é€šè¿‡Service DNSå‘ç°å’Œè´Ÿè½½å‡è¡¡
    url := fmt.Sprintf("http://%s%s", c.serviceName, path)
    
    req, err := http.NewRequestWithContext(ctx, method, url, nil)
    if err != nil {
        return nil, err
    }
    
    // Linkerdä¼šè‡ªåŠ¨æ³¨å…¥è¿½è¸ªHeader
    return c.httpClient.Do(req)
}

// Example: è°ƒç”¨ç”¨æˆ·æœåŠ¡
func ExampleLinkerdClient() {
    client := NewClient("user-service.default.svc.cluster.local")
    
    ctx := context.Background()
    resp, err := client.Call(ctx, "GET", "/api/users/123")
    if err != nil {
        panic(err)
    }
    defer resp.Body.Close()
    
    fmt.Printf("Status: %d\n", resp.StatusCode)
}
```

---

## 4. é«˜çº§æµé‡æ²»ç†

### 4.1 é‡‘ä¸é›€å‘å¸ƒ (Canary Deployment)

```go
// internal/canary/controller.go
package canary

import (
    "context"
    "fmt"
    "time"
)

// CanaryDeployment é‡‘ä¸é›€å‘å¸ƒæ§åˆ¶å™¨
type CanaryDeployment struct {
    service       string
    oldVersion    string
    newVersion    string
    currentWeight int
    targetWeight  int
    stepSize      int
    interval      time.Duration
}

// NewCanaryDeployment åˆ›å»ºé‡‘ä¸é›€å‘å¸ƒ
func NewCanaryDeployment(service, oldVer, newVer string) *CanaryDeployment {
    return &CanaryDeployment{
        service:      service,
        oldVersion:   oldVer,
        newVersion:   newVer,
        stepSize:     10,  // æ¯æ¬¡å¢åŠ 10%
        interval:     5 * time.Minute,
        targetWeight: 100,
    }
}

// Execute æ‰§è¡Œé‡‘ä¸é›€å‘å¸ƒ
func (c *CanaryDeployment) Execute(ctx context.Context) error {
    for c.currentWeight < c.targetWeight {
        // 1. æ›´æ–°æµé‡æƒé‡
        if err := c.updateTrafficWeight(c.currentWeight); err != nil {
            return fmt.Errorf("update traffic weight: %w", err)
        }
        
        fmt.Printf("[Canary] Traffic: %s=%d%%, %s=%d%%\n",
            c.oldVersion, 100-c.currentWeight,
            c.newVersion, c.currentWeight)
        
        // 2. ç­‰å¾…è§‚å¯ŸæœŸ
        select {
        case <-time.After(c.interval):
        case <-ctx.Done():
            return ctx.Err()
        }
        
        // 3. æ£€æŸ¥æ–°ç‰ˆæœ¬æŒ‡æ ‡
        if err := c.checkMetrics(); err != nil {
            // å›æ»š
            fmt.Println("[Canary] Rollback due to metrics failure")
            return c.rollback()
        }
        
        // 4. å¢åŠ æ–°ç‰ˆæœ¬æµé‡
        c.currentWeight += c.stepSize
        if c.currentWeight > c.targetWeight {
            c.currentWeight = c.targetWeight
        }
    }
    
    fmt.Println("[Canary] Deployment completed successfully")
    return nil
}

func (c *CanaryDeployment) updateTrafficWeight(newWeight int) error {
    // é€šè¿‡Istio APIæˆ–kubectlæ›´æ–°VirtualService
    virtualService := fmt.Sprintf(`
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: %s
spec:
  hosts:
  - %s
  http:
  - route:
    - destination:
        host: %s
        subset: %s
      weight: %d
    - destination:
        host: %s
        subset: %s
      weight: %d
`, c.service, c.service, c.service, c.oldVersion, 100-newWeight,
        c.service, c.newVersion, newWeight)
    
    fmt.Println(virtualService)
    // å®é™…åº”ç”¨: kubectl apply or Istio API
    return nil
}

func (c *CanaryDeployment) checkMetrics() error {
    // æ£€æŸ¥é”™è¯¯ç‡ã€å»¶è¿Ÿã€CPUç­‰æŒ‡æ ‡
    // æŸ¥è¯¢Prometheus
    errorRate := 0.02 // 2%é”™è¯¯ç‡
    if errorRate > 0.05 {
        return fmt.Errorf("error rate too high: %.2f%%", errorRate*100)
    }
    return nil
}

func (c *CanaryDeployment) rollback() error {
    fmt.Println("[Canary] Rolling back to", c.oldVersion)
    return c.updateTrafficWeight(0)
}
```

### 4.2 è“ç»¿éƒ¨ç½² (Blue-Green Deployment)

```yaml
# istio/blue-green.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service-blue-green
spec:
  hosts:
  - order-service
  http:
  - match:
    - headers:
        x-env:
          exact: "green"
    route:
    - destination:
        host: order-service
        subset: green
  - route:
    - destination:
        host: order-service
        subset: blue
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: order-service
spec:
  host: order-service
  subsets:
  - name: blue
    labels:
      version: blue
  - name: green
    labels:
      version: green
```

```go
// internal/deploy/bluegreen.go
package deploy

import (
    "context"
    "fmt"
)

// BlueGreenSwitch è“ç»¿åˆ‡æ¢
func BlueGreenSwitch(ctx context.Context, service, targetColor string) error {
    steps := []struct {
        name string
        fn   func() error
    }{
        {"éªŒè¯ç»¿è‰²ç¯å¢ƒå¥åº·", func() error {
            return checkHealth(service, targetColor)
        }},
        {"åˆ‡æ¢10%æµé‡åˆ°ç»¿è‰²", func() error {
            return updateWeight(service, "green", 10)
        }},
        {"è§‚å¯Ÿ5åˆ†é’Ÿ", func() error {
            return observe(5)
        }},
        {"åˆ‡æ¢100%æµé‡åˆ°ç»¿è‰²", func() error {
            return updateWeight(service, "green", 100)
        }},
        {"æ ‡è®°è“è‰²ç¯å¢ƒä¸ºæ—§ç‰ˆæœ¬", func() error {
            return tagAsOld(service, "blue")
        }},
    }
    
    for _, step := range steps {
        fmt.Printf("[Blue-Green] %s...\n", step.name)
        if err := step.fn(); err != nil {
            fmt.Printf("[Blue-Green] Failed: %v, rolling back\n", err)
            return rollbackToBlue(service)
        }
    }
    
    return nil
}

func checkHealth(service, color string) error {
    // æ£€æŸ¥Podå¥åº·çŠ¶æ€
    return nil
}

func updateWeight(service, color string, weight int) error {
    // æ›´æ–°VirtualServiceæƒé‡
    return nil
}

func observe(minutes int) error {
    // è§‚å¯ŸæœŸ
    return nil
}

func tagAsOld(service, color string) error {
    // æ‰“æ ‡ç­¾
    return nil
}

func rollbackToBlue(service string) error {
    return updateWeight(service, "blue", 100)
}
```

### 4.3 A/Bæµ‹è¯•

```yaml
# istio/ab-testing.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: recommendation-ab-test
spec:
  hosts:
  - recommendation-service
  http:
  # è§„åˆ™1: æµ‹è¯•ç»„ç”¨æˆ· -> Algorithm A
  - match:
    - headers:
        x-user-group:
          exact: "test"
    route:
    - destination:
        host: recommendation-service
        subset: algorithm-a
  
  # è§„åˆ™2: å¯¹ç…§ç»„ç”¨æˆ· -> Algorithm B
  - match:
    - headers:
        x-user-group:
          exact: "control"
    route:
    - destination:
        host: recommendation-service
        subset: algorithm-b
  
  # è§„åˆ™3: å…¶ä»–ç”¨æˆ· -> éšæœºåˆ†é… (50/50)
  - route:
    - destination:
        host: recommendation-service
        subset: algorithm-a
      weight: 50
    - destination:
        host: recommendation-service
        subset: algorithm-b
      weight: 50
```

```go
// internal/abtest/middleware.go
package abtest

import (
    "crypto/md5"
    "encoding/hex"
    "github.com/gin-gonic/gin"
)

// ABTestMiddleware A/Bæµ‹è¯•ä¸­é—´ä»¶
func ABTestMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := c.GetHeader("x-user-id")
        
        // åŸºäºUserIDçš„ä¸€è‡´æ€§Hashåˆ†ç»„
        group := assignGroup(userID)
        c.Header("x-user-group", group)
        
        c.Next()
    }
}

func assignGroup(userID string) string {
    if userID == "" {
        return "default"
    }
    
    hash := md5.Sum([]byte(userID))
    hashStr := hex.EncodeToString(hash[:])
    
    // å–Hashå€¼çš„æœ€åä¸€ä½
    lastChar := hashStr[len(hashStr)-1]
    if lastChar < '8' {
        return "test"
    }
    return "control"
}
```

### 4.4 æ•…éšœæ³¨å…¥ (Fault Injection)

```yaml
# istio/fault-injection.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: payment-service-fault
spec:
  hosts:
  - payment-service
  http:
  - match:
    - headers:
        x-chaos-test:
          exact: "enabled"
    fault:
      # å»¶è¿Ÿæ³¨å…¥
      delay:
        percentage:
          value: 20.0  # 20%è¯·æ±‚å»¶è¿Ÿ
        fixedDelay: 5s
      
      # é”™è¯¯æ³¨å…¥
      abort:
        percentage:
          value: 10.0  # 10%è¯·æ±‚è¿”å›é”™è¯¯
        httpStatus: 503
    
    route:
    - destination:
        host: payment-service
  
  - route:
    - destination:
        host: payment-service
```

---

## 5. å®‰å…¨é€šä¿¡ä¸mTLS

### 5.1 Istio mTLSé…ç½®

```yaml
# istio/peer-authentication.yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default
spec:
  mtls:
    mode: STRICT  # STRICT, PERMISSIVE, DISABLE
---
# é’ˆå¯¹ç‰¹å®šæœåŠ¡é…ç½®
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: payment-service-mtls
  namespace: default
spec:
  selector:
    matchLabels:
      app: payment-service
  mtls:
    mode: STRICT
  portLevelMtls:
    8080:
      mode: STRICT
    9090:  # Metricsç«¯å£ä¸éœ€è¦mTLS
      mode: DISABLE
```

### 5.2 æˆæƒç­–ç•¥

```yaml
# istio/authorization-policy.yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: user-service-authz
  namespace: default
spec:
  selector:
    matchLabels:
      app: user-service
  action: ALLOW
  rules:
  # è§„åˆ™1: å…è®¸frontendè°ƒç”¨
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/frontend"]
    to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/api/users/*"]
  
  # è§„åˆ™2: å…è®¸adminæœåŠ¡æ‰€æœ‰æ“ä½œ
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/admin"]
    to:
    - operation:
        methods: ["*"]
  
  # è§„åˆ™3: æ‹’ç»å¤–éƒ¨ç›´æ¥è®¿é—®
  - from:
    - source:
        notNamespaces: ["default"]
    to:
    - operation:
        methods: ["*"]
```

### 5.3 JWTè®¤è¯

```yaml
# istio/request-authentication.yaml
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: default
spec:
  selector:
    matchLabels:
      app: api-gateway
  jwtRules:
  - issuer: "https://auth.example.com"
    jwksUri: "https://auth.example.com/.well-known/jwks.json"
    audiences:
    - "api.example.com"
    forwardOriginalToken: true
---
# é…åˆæˆæƒç­–ç•¥
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: require-jwt
  namespace: default
spec:
  selector:
    matchLabels:
      app: api-gateway
  action: ALLOW
  rules:
  - from:
    - source:
        requestPrincipals: ["*"]  # å¿…é¡»æœ‰æœ‰æ•ˆJWT
    when:
    - key: request.auth.claims[role]
      values: ["admin", "user"]
```

```go
// internal/security/jwt.go
package security

import (
    "github.com/gin-gonic/gin"
    "net/http"
)

// JWTMiddleware JWTä¸­é—´ä»¶ (Istioä¼šéªŒè¯,è¿™é‡Œåªæå–Claims)
func JWTMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // Istioå·²ç»éªŒè¯äº†JWT,æˆ‘ä»¬ä»Headerè¯»å–Claims
        userID := c.GetHeader("x-jwt-claim-sub")
        role := c.GetHeader("x-jwt-claim-role")
        
        if userID == "" {
            c.JSON(http.StatusUnauthorized, gin.H{"error": "unauthorized"})
            c.Abort()
            return
        }
        
        c.Set("user_id", userID)
        c.Set("role", role)
        c.Next()
    }
}
```

---

## 6. å¤šé›†ç¾¤æœåŠ¡ç½‘æ ¼

### 6.1 å¤šé›†ç¾¤æ¶æ„

```go
/*
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Multi-Cluster Service Mesh                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ§åˆ¶å¹³é¢ (å…±äº«æˆ–ç‹¬ç«‹)                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Istiod (Multi-Cluster Mode)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Cluster 1 (us-west)     â”‚     Cluster 2 (us-east)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Service A (v1)     â”‚  â”‚  â”‚ Service A (v2)     â”‚             â”‚
â”‚  â”‚ Service B          â”‚  â”‚  â”‚ Service B          â”‚             â”‚
â”‚  â”‚ Ingress Gateway    â”‚  â”‚  â”‚ Ingress Gateway    â”‚             â”‚
â”‚  â”‚ Egress Gateway     â”‚  â”‚  â”‚ Egress Gateway     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â†•              â”‚           â†•                          â”‚
â”‚  East-West Gateway â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ East-West Gateway           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
*/
```

### 6.2 é…ç½®å¤šé›†ç¾¤

```bash
# 1. ç”ŸæˆCAè¯ä¹¦ (å…±äº«æ ¹è¯ä¹¦)
mkdir -p certs
cd certs

# ç”Ÿæˆæ ¹CA
openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 \
  -subj '/O=example Inc./CN=example.com' \
  -keyout root-key.pem -out root-cert.pem

# ä¸ºcluster1ç”Ÿæˆä¸­é—´CA
openssl req -newkey rsa:2048 -nodes -keyout cluster1-key.pem \
  -subj '/O=example Inc./CN=cluster1.example.com' -out cluster1.csr
openssl x509 -req -days 365 -CA root-cert.pem -CAkey root-key.pem \
  -CAcreateserial -in cluster1.csr -out cluster1-cert.pem

# ä¸ºcluster2ç”Ÿæˆä¸­é—´CA
openssl req -newkey rsa:2048 -nodes -keyout cluster2-key.pem \
  -subj '/O=example Inc./CN=cluster2.example.com' -out cluster2.csr
openssl x509 -req -days 365 -CA root-cert.pem -CAkey root-key.pem \
  -CAcreateserial -in cluster2.csr -out cluster2-cert.pem

# 2. åœ¨cluster1å®‰è£…Istio
kubectl --context=cluster1 create namespace istio-system
kubectl --context=cluster1 create secret generic cacerts -n istio-system \
  --from-file=ca-cert.pem=cluster1-cert.pem \
  --from-file=ca-key.pem=cluster1-key.pem \
  --from-file=root-cert.pem=root-cert.pem \
  --from-file=cert-chain.pem=cluster1-cert.pem

istioctl install --context=cluster1 -f - <<EOF
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster1
      network: network1
EOF

# 3. å®‰è£…East-West Gateway
samples/multicluster/gen-eastwest-gateway.sh \
  --mesh mesh1 --cluster cluster1 --network network1 | \
  istioctl --context=cluster1 install -y -f -

# 4. æš´éœ²æœåŠ¡
kubectl --context=cluster1 apply -f \
  samples/multicluster/expose-services.yaml

# 5. åœ¨cluster2é‡å¤ç›¸åŒæ­¥éª¤...
```

### 6.3 è·¨é›†ç¾¤æœåŠ¡å‘ç°

```yaml
# cluster1/serviceentry.yaml
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: user-service-cluster2
spec:
  hosts:
  - user-service.default.global  # å…¨å±€FQDN
  ports:
  - number: 8080
    name: http
    protocol: HTTP
  resolution: DNS
  location: MESH_INTERNAL
  endpoints:
  - address: <cluster2-east-west-gateway-ip>
    ports:
      http: 15443
    labels:
      cluster: cluster2
```

### 6.4 è·¨é›†ç¾¤æµé‡ç®¡ç†

```yaml
# multi-cluster-routing.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service-global
spec:
  hosts:
  - user-service.default.global
  http:
  - match:
    - sourceLabels:
        cluster: cluster1
    route:
    # ä¼˜å…ˆè·¯ç”±åˆ°æœ¬åœ°é›†ç¾¤
    - destination:
        host: user-service.default.svc.cluster.local
      weight: 80
    # 20%æµé‡åˆ°cluster2
    - destination:
        host: user-service.default.global
      weight: 20
  
  - match:
    - sourceLabels:
        cluster: cluster2
    route:
    - destination:
        host: user-service.default.svc.cluster.local
      weight: 80
    - destination:
        host: user-service.default.global
      weight: 20
```

---

## 7. å¯è§‚æµ‹æ€§é›†æˆ

### 7.1 åˆ†å¸ƒå¼è¿½è¸ª

```go
// internal/tracing/istio.go
package tracing

import (
    "context"
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/propagation"
    "go.opentelemetry.io/otel/trace"
)

// IstioTracer Istioå…¼å®¹çš„è¿½è¸ª
type IstioTracer struct {
    tracer trace.Tracer
}

// NewIstioTracer åˆ›å»ºè¿½è¸ªå™¨
func NewIstioTracer(serviceName string) *IstioTracer {
    tracer := otel.Tracer(serviceName)
    
    // ä½¿ç”¨B3 Propagator (Istioé»˜è®¤)
    otel.SetTextMapPropagator(
        propagation.NewCompositeTextMapPropagator(
            propagation.TraceContext{},
            propagation.Baggage{},
            B3Propagator{},  // Istio/Zipkinæ ¼å¼
        ),
    )
    
    return &IstioTracer{tracer: tracer}
}

// StartSpan å¼€å§‹Span (ä¼šè‡ªåŠ¨ä¼ æ’­åˆ°Istio)
func (t *IstioTracer) StartSpan(ctx context.Context, name string) (context.Context, trace.Span) {
    return t.tracer.Start(ctx, name)
}

// B3Propagator Istioä½¿ç”¨çš„B3ä¼ æ’­æ ¼å¼
type B3Propagator struct{}

func (b B3Propagator) Inject(ctx context.Context, carrier propagation.TextMapCarrier) {
    span := trace.SpanFromContext(ctx)
    if !span.IsRecording() {
        return
    }
    
    sc := span.SpanContext()
    carrier.Set("x-b3-traceid", sc.TraceID().String())
    carrier.Set("x-b3-spanid", sc.SpanID().String())
    carrier.Set("x-b3-sampled", "1")
}

func (b B3Propagator) Extract(ctx context.Context, carrier propagation.TextMapCarrier) context.Context {
    // ä»Headeræå–Trace Context
    traceID := carrier.Get("x-b3-traceid")
    spanID := carrier.Get("x-b3-spanid")
    
    // æ„é€ SpanContextå¹¶è¿”å›
    // ... (çœç•¥è¯¦ç»†å®ç°)
    return ctx
}

func (b B3Propagator) Fields() []string {
    return []string{"x-b3-traceid", "x-b3-spanid", "x-b3-sampled"}
}
```

### 7.2 Metricså¯¼å‡º

```go
// internal/metrics/istio.go
package metrics

import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    // ä¸šåŠ¡æŒ‡æ ‡ (ä¼šè¢«Istioé‡‡é›†)
    RequestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "app_request_duration_seconds",
            Help:    "Request duration in seconds",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "endpoint", "status"},
    )
    
    ActiveUsers = promauto.NewGauge(
        prometheus.GaugeOpts{
            Name: "app_active_users",
            Help: "Number of active users",
        },
    )
    
    CacheHits = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "app_cache_hits_total",
            Help: "Total cache hits",
        },
        []string{"cache_name"},
    )
)

// Istioè‡ªåŠ¨æ³¨å…¥çš„æŒ‡æ ‡:
// - istio_requests_total
// - istio_request_duration_milliseconds
// - istio_request_bytes
// - istio_response_bytes
// - istio_tcp_connections_opened_total
// - istio_tcp_connections_closed_total
```

### 7.3 Kialiå¯è§†åŒ–

```bash
# å®‰è£…Kiali
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/kiali.yaml

# è®¿é—®Kiali Dashboard
istioctl dashboard kiali

# Kialiæä¾›:
# 1. æœåŠ¡æ‹“æ‰‘å›¾
# 2. æµé‡æµå‘
# 3. å¥åº·çŠ¶æ€
# 4. é…ç½®éªŒè¯
# 5. åˆ†å¸ƒå¼è¿½è¸ªé›†æˆ
```

---

## 8. æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### 8.1 Sidecarèµ„æºä¼˜åŒ–

```yaml
# å…¨å±€Sidecarèµ„æºé…ç½®
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  values:
    global:
      proxy:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        # å¹¶å‘é…ç½®
        concurrency: 2  # æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
---
# é’ˆå¯¹é«˜æµé‡æœåŠ¡çš„Sidecarä¼˜åŒ–
apiVersion: v1
kind: Pod
metadata:
  annotations:
    sidecar.istio.io/proxyCPU: "500m"
    sidecar.istio.io/proxyMemory: "512Mi"
    sidecar.istio.io/proxyCPULimit: "2000m"
    sidecar.istio.io/proxyMemoryLimit: "2Gi"
spec:
  # ...
```

### 8.2 Sidecar Scopeä¼˜åŒ–

```yaml
# é™åˆ¶Sidecaråªç›‘å¬éœ€è¦çš„æœåŠ¡
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: default
  namespace: default
spec:
  egress:
  - hosts:
    - "./user-service.default.svc.cluster.local"
    - "./product-service.default.svc.cluster.local"
    - "./order-service.default.svc.cluster.local"
    - "istio-system/*"
  # ä¸ç›‘å¬æ‰€æœ‰æœåŠ¡,å‡å°‘é…ç½®åŒæ­¥å¼€é”€
```

### 8.3 è¿æ¥æ± è°ƒä¼˜

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: high-throughput-service
spec:
  host: payment-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 1000  # å¢åŠ è¿æ¥æ•°
        connectTimeout: 30ms
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        http1MaxPendingRequests: 1024
        http2MaxRequests: 2048
        maxRequestsPerConnection: 10
        idleTimeout: 300s
```

### 8.4 æœ€ä½³å®è·µæ¸…å•

```go
// Service Meshæœ€ä½³å®è·µ
type BestPractices struct {
    // 1. å¥åº·æ£€æŸ¥
    HealthCheck struct {
        // å¿…é¡»å®ç° /health (liveness) å’Œ /ready (readiness)
        LivenessProbe  string // ä¸åŒ…å«å¤–éƒ¨ä¾èµ–æ£€æŸ¥
        ReadinessProbe string // åŒ…å«æ‰€æœ‰ä¾èµ–æ£€æŸ¥
    }
    
    // 2. è¶…æ—¶é…ç½®
    Timeout struct {
        // è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ (< Gatewayè¶…æ—¶)
        ServiceTimeout time.Duration // å»ºè®®: 5-30s
        RetryTimeout   time.Duration // å»ºè®®: < ServiceTimeout/3
    }
    
    // 3. é‡è¯•ç­–ç•¥
    Retry struct {
        // åªå¯¹å¹‚ç­‰æ“ä½œé‡è¯•
        IdempotentMethods []string // GET, PUT, DELETE
        MaxAttempts       int      // å»ºè®®: 2-3æ¬¡
        RetryOn           []string // 5xx, reset, connect-failure
    }
    
    // 4. ç†”æ–­é…ç½®
    CircuitBreaker struct {
        // æ ¹æ®æœåŠ¡SLAé…ç½®
        Consecutive5xxErrors  int           // å»ºè®®: 5
        Interval              time.Duration // å»ºè®®: 30s
        BaseEjectionTime      time.Duration // å»ºè®®: 30s
        MaxEjectionPercent    int           // å»ºè®®: 50%
    }
    
    // 5. èµ„æºé™åˆ¶
    Resources struct {
        // Sidecarèµ„æºè¦åˆç†
        SidecarCPU    string // å»ºè®®: requests=100m, limits=500m
        SidecarMemory string // å»ºè®®: requests=128Mi, limits=512Mi
    }
    
    // 6. ç›‘æ§å‘Šè­¦
    Monitoring struct {
        // å…³æ³¨å…³é”®æŒ‡æ ‡
        ErrorRate   float64 // å»ºè®®: <1%
        Latency P99 float64 // å»ºè®®: <1s
        Throughput  int     // æ ¹æ®ä¸šåŠ¡è®¾å®š
    }
    
    // 7. å®‰å…¨é…ç½®
    Security struct {
        // å¯ç”¨mTLS
        MutualTLS       bool   // å»ºè®®: true
        Authorization   bool   // å»ºè®®: true
        JWTValidation   bool   // å¯¹å¤–API: true
    }
    
    // 8. æµé‡ç®¡ç†
    Traffic struct {
        // ç°åº¦å‘å¸ƒç­–ç•¥
        CanaryStepSize int           // å»ºè®®: 10%
        CanaryInterval time.Duration // å»ºè®®: 5min
        RollbackOnError bool          // å»ºè®®: true
    }
}
```

### 8.5 æ€§èƒ½Benchmarks

```go
// benchmark_test.go
package mesh

import (
    "context"
    "net/http"
    "testing"
    "time"
)

// Benchmark: æœ‰Sidecar vs æ— Sidecar
func BenchmarkWithSidecar(b *testing.B) {
    client := &http.Client{Timeout: 10 * time.Second}
    url := "http://user-service:8080/api/users"  // é€šè¿‡Service Mesh
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        resp, err := client.Get(url)
        if err != nil {
            b.Fatal(err)
        }
        resp.Body.Close()
    }
}

func BenchmarkWithoutSidecar(b *testing.B) {
    client := &http.Client{Timeout: 10 * time.Second}
    url := "http://user-service-direct:8080/api/users"  // ç›´è¿Pod IP
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        resp, err := client.Get(url)
        if err != nil {
            b.Fatal(err)
        }
        resp.Body.Close()
    }
}

/*
æ€§èƒ½å½±å“åˆ†æ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯                â”‚ P50å»¶è¿Ÿ   â”‚ P99å»¶è¿Ÿ   â”‚ ååé‡     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ— Service Mesh      â”‚ 10ms     â”‚ 50ms     â”‚ 10000 rps  â”‚
â”‚ Istio (mTLS OFF)    â”‚ 12ms     â”‚ 60ms     â”‚ 9000 rps   â”‚
â”‚ Istio (mTLS ON)     â”‚ 15ms     â”‚ 70ms     â”‚ 8000 rps   â”‚
â”‚ Linkerd (mTLS ON)   â”‚ 13ms     â”‚ 65ms     â”‚ 8500 rps   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“è®º:
- Sidecarå¢åŠ çº¦2-5mså»¶è¿Ÿ
- mTLSå¢åŠ çº¦3mså»¶è¿Ÿ
- ååé‡ä¸‹é™çº¦10-20%
- å¯¹äºå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯,è¿™ä¸ªä»£ä»·æ˜¯å¯æ¥å—çš„
*/
```

---

## 9. æ€»ç»“

### 9.1 Service Meshé€‰å‹

```go
// Istio vs Linkerdå¯¹æ¯”
type ServiceMeshComparison struct {
    Istio struct {
        Pros []string // "åŠŸèƒ½æœ€å…¨é¢", "ç¤¾åŒºæ´»è·ƒ", "ä¼ä¸šçº§æ”¯æŒ", "ä¸K8sæ·±åº¦é›†æˆ"
        Cons []string // "å¤æ‚åº¦é«˜", "èµ„æºæ¶ˆè€—å¤§", "å­¦ä¹ æ›²çº¿é™¡"
        UseCase string // "å¤§å‹ä¼ä¸š,éœ€è¦ä¸°å¯ŒåŠŸèƒ½"
    }
    
    Linkerd struct {
        Pros []string // "è½»é‡çº§", "æ€§èƒ½ä¼˜ç§€", "ç®€å•æ˜“ç”¨", "èµ„æºæ¶ˆè€—ä½"
        Cons []string // "åŠŸèƒ½ç›¸å¯¹å°‘", "ç”Ÿæ€ä¸å¦‚Istio"
        UseCase string // "ä¸­å°ä¼ä¸š,å…³æ³¨æ€§èƒ½å’Œç®€å•æ€§"
    }
}
```

### 9.2 è¿ç§»è·¯å¾„

```text
é˜¶æ®µ1: å‡†å¤‡
â”œâ”€â”€ æœåŠ¡å®¹å™¨åŒ–
â”œâ”€â”€ è¿ç§»åˆ°Kubernetes
â””â”€â”€ å®ç°Health Check

é˜¶æ®µ2: Sidecaræ³¨å…¥
â”œâ”€â”€ å®‰è£…Service Mesh
â”œâ”€â”€ é€æ­¥æ³¨å…¥Sidecar (å…ˆéæ ¸å¿ƒæœåŠ¡)
â””â”€â”€ éªŒè¯åŠŸèƒ½å’Œæ€§èƒ½

é˜¶æ®µ3: å¯ç”¨mTLS
â”œâ”€â”€ PERMISSIVEæ¨¡å¼ (å…¼å®¹æ¨¡å¼)
â”œâ”€â”€ è§‚å¯Ÿä¸€æ®µæ—¶é—´
â””â”€â”€ åˆ‡æ¢åˆ°STRICTæ¨¡å¼

é˜¶æ®µ4: æµé‡ç®¡ç†
â”œâ”€â”€ é…ç½®VirtualService/DestinationRule
â”œâ”€â”€ å®æ–½é‡‘ä¸é›€å‘å¸ƒ
â””â”€â”€ é…ç½®ç†”æ–­/é‡è¯•

é˜¶æ®µ5: å¯è§‚æµ‹æ€§
â”œâ”€â”€ é›†æˆPrometheus/Grafana
â”œâ”€â”€ é›†æˆJaeger/Zipkin
â””â”€â”€ é…ç½®å‘Šè­¦

é˜¶æ®µ6: å®‰å…¨åŠ å›º
â”œâ”€â”€ é…ç½®Authorization Policy
â”œâ”€â”€ JWTè®¤è¯
â””â”€â”€ Auditæ—¥å¿—
```

### 9.3 å…³é”®æŒ‡æ ‡

```yaml
# Service Meshå¥åº·æŒ‡æ ‡
metrics:
  # æ•°æ®å¹³é¢
  - sidecar_cpu_usage: < 200m
  - sidecar_memory_usage: < 256Mi
  - request_latency_p99: < 100ms
  - error_rate: < 1%
  
  # æ§åˆ¶å¹³é¢
  - pilot_cpu_usage: < 1 core
  - pilot_memory_usage: < 2Gi
  - config_push_latency: < 1s
  - pilot_proxy_convergence_time: < 10s
```

**æ­å–œ!** ğŸ‰ æ‚¨å·²æŒæ¡Go 1.25.3 Service Meshä¸é«˜çº§æµé‡æ²»ç†çš„å®Œæ•´å®æˆ˜æŠ€èƒ½!

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Istioå®˜æ–¹æ–‡æ¡£](https://istio.io/latest/docs/)
- [Linkerdæ–‡æ¡£](https://linkerd.io/2/overview/)
- [Envoy Proxy](https://www.envoyproxy.io/docs/envoy/latest/)
- [Service Mesh Pattern](https://www.oreilly.com/library/view/the-enterprise-path/9781492041795/)
- [Istioå®æˆ˜æŒ‡å—](https://github.com/istio/istio/tree/master/samples)
