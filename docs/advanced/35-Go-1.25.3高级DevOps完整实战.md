# Go 1.25.3 é«˜çº§DevOpså®Œæ•´å®æˆ˜

## ğŸ“‹ ç›®å½•


- [1. GitOpsæ¦‚è¿°](#1-gitopsæ¦‚è¿°)
  - [1.1 GitOpsæ ¸å¿ƒæ¦‚å¿µ](#11-gitopsæ ¸å¿ƒæ¦‚å¿µ)
  - [1.2 ä»“åº“ç»“æ„](#12-ä»“åº“ç»“æ„)
- [2. ArgoCDå®æˆ˜](#2-argocdå®æˆ˜)
  - [2.1 å®‰è£…ArgoCD](#21-å®‰è£…argocd)
  - [2.2 åˆ›å»ºArgoCD Application](#22-åˆ›å»ºargocd-application)
  - [2.3 ApplicationSet (å¤šç¯å¢ƒéƒ¨ç½²)](#23-applicationset-å¤šç¯å¢ƒéƒ¨ç½²)
- [3. Tekton CI/CD](#3-tekton-cicd)
  - [3.1 å®‰è£…Tekton](#31-å®‰è£…tekton)
  - [3.2 æ„å»ºGoåº”ç”¨çš„Pipeline](#32-æ„å»ºgoåº”ç”¨çš„pipeline)
  - [3.3 Tekton Triggers (Webhookè‡ªåŠ¨è§¦å‘)](#33-tekton-triggers-webhookè‡ªåŠ¨è§¦å‘)
- [4. Flux CD](#4-flux-cd)
  - [4.1 å®‰è£…Flux](#41-å®‰è£…flux)
  - [4.2 é…ç½®GitRepositoryå’ŒKustomization](#42-é…ç½®gitrepositoryå’Œkustomization)
  - [4.3 Helm Releaseç®¡ç†](#43-helm-releaseç®¡ç†)
- [5. å¤šç¯å¢ƒç®¡ç†](#5-å¤šç¯å¢ƒç®¡ç†)
  - [5.1 Kustomizeå¤šç¯å¢ƒ](#51-kustomizeå¤šç¯å¢ƒ)
  - [5.2 Helmå¤šç¯å¢ƒ](#52-helmå¤šç¯å¢ƒ)
- [6. é‡‘ä¸é›€å‘å¸ƒ](#6-é‡‘ä¸é›€å‘å¸ƒ)
  - [6.1 Flagger + Istio](#61-flagger--istio)
  - [6.2 Argo Rollouts](#62-argo-rollouts)
- [7. é…ç½®ç®¡ç†](#7-é…ç½®ç®¡ç†)
  - [7.1 Sealed Secrets (åŠ å¯†æ•æ„Ÿæ•°æ®)](#71-sealed-secrets-åŠ å¯†æ•æ„Ÿæ•°æ®)
  - [7.2 External Secrets Operator](#72-external-secrets-operator)
- [8. ç›‘æ§ä¸å‘Šè­¦](#8-ç›‘æ§ä¸å‘Šè­¦)
  - [8.1 Prometheus + Grafanaé›†æˆ](#81-prometheus--grafanaé›†æˆ)
  - [8.2 è‡ªå®šä¹‰Grafana Dashboard](#82-è‡ªå®šä¹‰grafana-dashboard)
- [9. å®‰å…¨ä¸åˆè§„](#9-å®‰å…¨ä¸åˆè§„)
  - [9.1 Policy as Code (OPA Gatekeeper)](#91-policy-as-code-opa-gatekeeper)
  - [9.2 é•œåƒæ‰«æä¸ç­–ç•¥](#92-é•œåƒæ‰«æä¸ç­–ç•¥)
- [10. å®Œæ•´é¡¹ç›®ç¤ºä¾‹](#10-å®Œæ•´é¡¹ç›®ç¤ºä¾‹)
  - [10.1 å®Œæ•´GitOpså·¥ä½œæµ](#101-å®Œæ•´gitopså·¥ä½œæµ)
  - [10.2 ç›‘æ§Dashboard](#102-ç›‘æ§dashboard)
- [æ€»ç»“](#æ€»ç»“)
  - [GitOpsæœ€ä½³å®è·µ](#gitopsæœ€ä½³å®è·µ)
  - [å·¥å…·é€‰æ‹©å»ºè®®](#å·¥å…·é€‰æ‹©å»ºè®®)

## 1. GitOpsæ¦‚è¿°

### 1.1 GitOpsæ ¸å¿ƒæ¦‚å¿µ

```go
// GitOpsåŸåˆ™
/*
GitOps = Git + Ops

æ ¸å¿ƒåŸåˆ™:
  1. å£°æ˜å¼ (Declarative)
     â€¢ ä½¿ç”¨YAML/JSONæè¿°æœŸæœ›çŠ¶æ€
     â€¢ è€Œéå‘½ä»¤å¼è„šæœ¬

  2. ç‰ˆæœ¬æ§åˆ¶ (Versioned)
     â€¢ æ‰€æœ‰é…ç½®å­˜å‚¨åœ¨Git
     â€¢ å®Œæ•´çš„å˜æ›´å†å²
     â€¢ æ˜“äºå›æ»š

  3. è‡ªåŠ¨æ‹‰å– (Pulled)
     â€¢ GitOps Operatorç›‘å¬Git
     â€¢ è‡ªåŠ¨åŒæ­¥åˆ°é›†ç¾¤
     â€¢ è€Œéæ¨é€éƒ¨ç½²

  4. æŒç»­åè°ƒ (Reconciled)
     â€¢ æŒç»­ç›‘æ§å®é™…çŠ¶æ€
     â€¢ ä¸Gitä¸­æœŸæœ›çŠ¶æ€å¯¹æ¯”
     â€¢ è‡ªåŠ¨ä¿®æ­£åå·®

GitOpså·¥å…·å¯¹æ¯”:
  ArgoCD:
    â€¢ âœ… UIå‹å¥½
    â€¢ âœ… å¤šé›†ç¾¤æ”¯æŒ
    â€¢ âœ… SSOé›†æˆ
    â€¢ âœ… åº”ç”¨æœ€å¹¿æ³›

  Flux CD:
    â€¢ âœ… CNCFé¡¹ç›®
    â€¢ âœ… GitOps Toolkit
    â€¢ âœ… æ›´è½»é‡
    â€¢ âœ… HelmåŸç”Ÿæ”¯æŒ

  Tekton:
    â€¢ âœ… Cloud Native CI/CD
    â€¢ âœ… KubernetesåŸç”Ÿ
    â€¢ âœ… çµæ´»çš„Pipeline
    â€¢ âœ… å¯å¤ç”¨Task
*/

// GitOpså·¥ä½œæµ
type GitOpsWorkflow struct {
 Steps []string
}

var workflow = GitOpsWorkflow{
 Steps: []string{
  "1. å¼€å‘è€…æäº¤ä»£ç åˆ°Gitä»“åº“",
  "2. CI Pipelineæ„å»ºDockeré•œåƒ",
  "3. æ›´æ–°Kubernetes YAMLä¸­çš„é•œåƒç‰ˆæœ¬",
  "4. æäº¤YAMLå˜æ›´åˆ°Gité…ç½®ä»“åº“",
  "5. GitOps Operatoræ£€æµ‹åˆ°Gitå˜æ›´",
  "6. è‡ªåŠ¨åŒæ­¥åˆ°Kubernetesé›†ç¾¤",
  "7. Kubernetesæ‹‰å–æ–°é•œåƒå¹¶éƒ¨ç½²",
  "8. ç›‘æ§éªŒè¯éƒ¨ç½²ç»“æœ",
 },
}
```

### 1.2 ä»“åº“ç»“æ„

```text
gitops-project/
â”œâ”€â”€ apps/                         # åº”ç”¨ä»£ç ä»“åº“
â”‚   â”œâ”€â”€ go-api/
â”‚   â”‚   â”œâ”€â”€ main.go
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ .github/workflows/
â”‚   â”‚       â””â”€â”€ ci.yml           # CI Pipeline
â”‚   â””â”€â”€ go-worker/
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ infrastructure/              # åŸºç¡€è®¾æ–½ä»“åº“
â”‚   â”œâ”€â”€ argocd/
â”‚   â”‚   â”œâ”€â”€ install.yaml
â”‚   â”‚   â””â”€â”€ apps/
â”‚   â”‚       â””â”€â”€ applications.yaml
â”‚   â”œâ”€â”€ base/                    # Kustomize base
â”‚   â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”‚   â”œâ”€â”€ service.yaml
â”‚   â”‚   â””â”€â”€ kustomization.yaml
â”‚   â””â”€â”€ overlays/                # ç¯å¢ƒç‰¹å®šé…ç½®
â”‚       â”œâ”€â”€ dev/
â”‚       â”‚   â”œâ”€â”€ kustomization.yaml
â”‚       â”‚   â””â”€â”€ replicas.yaml
â”‚       â”œâ”€â”€ staging/
â”‚       â”‚   â””â”€â”€ kustomization.yaml
â”‚       â””â”€â”€ production/
â”‚           â”œâ”€â”€ kustomization.yaml
â”‚           â”œâ”€â”€ replicas.yaml
â”‚           â””â”€â”€ resources.yaml
â””â”€â”€ helm-charts/                 # Helm Charts
    â””â”€â”€ go-api/
        â”œâ”€â”€ Chart.yaml
        â”œâ”€â”€ values.yaml
        â”œâ”€â”€ values-dev.yaml
        â”œâ”€â”€ values-prod.yaml
        â””â”€â”€ templates/
            â”œâ”€â”€ deployment.yaml
            â””â”€â”€ service.yaml
```

---

## 2. ArgoCDå®æˆ˜

### 2.1 å®‰è£…ArgoCD

```bash
# åˆ›å»ºnamespace
kubectl create namespace argocd

# å®‰è£…ArgoCD
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# ç­‰å¾…Podå°±ç»ª
kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s

# è·å–åˆå§‹å¯†ç 
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

# Port Forwardè®¿é—®UI
kubectl port-forward svc/argocd-server -n argocd 8080:443

# è®¿é—® https://localhost:8080
# ç”¨æˆ·å: admin
# å¯†ç : (ä¸Šé¢è·å–çš„å¯†ç )

# å®‰è£…ArgoCD CLI
# macOS
brew install argocd

# Linux
curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
chmod +x /usr/local/bin/argocd

# ç™»å½•
argocd login localhost:8080 --insecure
argocd account update-password
```

### 2.2 åˆ›å»ºArgoCD Application

```yaml
# apps/go-api-application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: go-api
  namespace: argocd
spec:
  project: default
  
  # Gitæº
  source:
    repoURL: https://github.com/your-org/gitops-infra
    targetRevision: main
    path: overlays/production
    
    # Kustomizeé…ç½®
    kustomize:
      images:
        - your-registry/go-api:v1.2.3
  
  # ç›®æ ‡é›†ç¾¤
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  
  # åŒæ­¥ç­–ç•¥
  syncPolicy:
    automated:
      prune: true          # åˆ é™¤Gitä¸­ä¸å­˜åœ¨çš„èµ„æº
      selfHeal: true       # è‡ªåŠ¨ä¿®å¤é…ç½®åå·®
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
      - PruneLast=true
    
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  # å¥åº·æ£€æŸ¥
  health:
    check:
      - name: Deployment
        type: SuccessfulDeployment
```

```bash
# åº”ç”¨Application
kubectl apply -f apps/go-api-application.yaml

# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
argocd app list
argocd app get go-api

# æ‰‹åŠ¨åŒæ­¥
argocd app sync go-api

# æŸ¥çœ‹åŒæ­¥å†å²
argocd app history go-api

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
argocd app rollback go-api <revision>
```

### 2.3 ApplicationSet (å¤šç¯å¢ƒéƒ¨ç½²)

```yaml
# apps/go-api-appset.yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: go-api-multienv
  namespace: argocd
spec:
  generators:
    # åˆ—è¡¨ç”Ÿæˆå™¨ (å¤šç¯å¢ƒ)
    - list:
        elements:
          - env: dev
            cluster: https://kubernetes.default.svc
            replicas: 1
          - env: staging
            cluster: https://staging-cluster.example.com
            replicas: 2
          - env: production
            cluster: https://prod-cluster.example.com
            replicas: 3
  
  template:
    metadata:
      name: 'go-api-{{env}}'
    spec:
      project: default
      source:
        repoURL: https://github.com/your-org/gitops-infra
        targetRevision: main
        path: 'overlays/{{env}}'
        kustomize:
          commonLabels:
            environment: '{{env}}'
      destination:
        server: '{{cluster}}'
        namespace: '{{env}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
```

---

## 3. Tekton CI/CD

### 3.1 å®‰è£…Tekton

```bash
# å®‰è£…Tekton Pipelines
kubectl apply -f https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml

# å®‰è£…Tekton Triggers (å¯é€‰)
kubectl apply -f https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml

# å®‰è£…Tekton Dashboard (å¯é€‰)
kubectl apply -f https://storage.googleapis.com/tekton-releases/dashboard/latest/release.yaml

# Port Forward Dashboard
kubectl port-forward -n tekton-pipelines svc/tekton-dashboard 9097:9097
```

### 3.2 æ„å»ºGoåº”ç”¨çš„Pipeline

```yaml
# tekton/task-build-go.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-go-app
spec:
  params:
    - name: repo-url
      type: string
    - name: revision
      type: string
      default: main
    - name: image
      type: string
  
  workspaces:
    - name: source
    - name: dockerconfig
      mountPath: /kaniko/.docker
  
  steps:
    # Step 1: Cloneä»£ç 
    - name: git-clone
      image: alpine/git:latest
      script: |
        #!/bin/sh
        git clone --depth 1 --branch $(params.revision) $(params.repo-url) /workspace/source
    
    # Step 2: Goæµ‹è¯•
    - name: go-test
      image: golang:1.25.3-alpine
      workingDir: /workspace/source
      script: |
        #!/bin/sh
        go test -v ./...
    
    # Step 3: Goæ„å»º
    - name: go-build
      image: golang:1.25.3-alpine
      workingDir: /workspace/source
      script: |
        #!/bin/sh
        CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o /workspace/app
    
    # Step 4: æ„å»ºDockeré•œåƒ
    - name: build-image
      image: gcr.io/kaniko-project/executor:latest
      args:
        - --dockerfile=/workspace/source/Dockerfile
        - --context=/workspace/source
        - --destination=$(params.image)
        - --cache=true
    
    # Step 5: é•œåƒæ‰«æ (Trivy)
    - name: scan-image
      image: aquasec/trivy:latest
      script: |
        #!/bin/sh
        trivy image --severity HIGH,CRITICAL --exit-code 1 $(params.image)
```

```yaml
# tekton/pipeline-go-app.yaml
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: go-app-pipeline
spec:
  params:
    - name: repo-url
      type: string
    - name: image-name
      type: string
    - name: git-revision
      type: string
      default: main
    - name: deploy-env
      type: string
      default: dev
  
  workspaces:
    - name: shared-workspace
    - name: docker-credentials
  
  tasks:
    # Task 1: æ„å»ºå’Œæ¨é€é•œåƒ
    - name: build
      taskRef:
        name: build-go-app
      params:
        - name: repo-url
          value: $(params.repo-url)
        - name: revision
          value: $(params.git-revision)
        - name: image
          value: $(params.image-name):$(params.git-revision)
      workspaces:
        - name: source
          workspace: shared-workspace
        - name: dockerconfig
          workspace: docker-credentials
    
    # Task 2: æ›´æ–°Kubernetesé…ç½®
    - name: update-gitops-repo
      runAfter: [build]
      taskRef:
        name: git-cli
      params:
        - name: GIT_USER_NAME
          value: "Tekton Pipeline"
        - name: GIT_USER_EMAIL
          value: "tekton@example.com"
        - name: GIT_SCRIPT
          value: |
            git clone https://github.com/your-org/gitops-infra.git
            cd gitops-infra/overlays/$(params.deploy-env)
            
            # æ›´æ–°é•œåƒç‰ˆæœ¬
            kustomize edit set image your-registry/go-api=$(params.image-name):$(params.git-revision)
            
            git add .
            git commit -m "Update image to $(params.git-revision)"
            git push origin main
```

```yaml
# tekton/pipelinerun.yaml
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: go-app-pipeline-run-
spec:
  pipelineRef:
    name: go-app-pipeline
  params:
    - name: repo-url
      value: https://github.com/your-org/go-api.git
    - name: image-name
      value: your-registry/go-api
    - name: git-revision
      value: v1.2.3
    - name: deploy-env
      value: production
  workspaces:
    - name: shared-workspace
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
    - name: docker-credentials
      secret:
        secretName: docker-registry-secret
```

```bash
# æ‰§è¡ŒPipeline
kubectl create -f tekton/pipelinerun.yaml

# æŸ¥çœ‹Pipelineè¿è¡Œ
tkn pipeline list
tkn pipelinerun list
tkn pipelinerun logs <pipelinerun-name> -f

# é€šè¿‡CLIè§¦å‘
tkn pipeline start go-app-pipeline \
  --param repo-url=https://github.com/your-org/go-api.git \
  --param image-name=your-registry/go-api \
  --param git-revision=v1.2.3 \
  --workspace name=shared-workspace,volumeClaimTemplateFile=pvc.yaml \
  --showlog
```

### 3.3 Tekton Triggers (Webhookè‡ªåŠ¨è§¦å‘)

```yaml
# tekton/trigger-binding.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: github-push-binding
spec:
  params:
    - name: git-revision
      value: $(body.head_commit.id)
    - name: repo-url
      value: $(body.repository.clone_url)

---
# tekton/trigger-template.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: go-app-template
spec:
  params:
    - name: git-revision
    - name: repo-url
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: go-app-pipeline-run-
      spec:
        pipelineRef:
          name: go-app-pipeline
        params:
          - name: repo-url
            value: $(tt.params.repo-url)
          - name: git-revision
            value: $(tt.params.git-revision)
        workspaces:
          - name: shared-workspace
            volumeClaimTemplate:
              spec:
                accessModes: [ReadWriteOnce]
                resources:
                  requests:
                    storage: 1Gi

---
# tekton/event-listener.yaml
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: github-listener
spec:
  serviceAccountName: tekton-triggers-sa
  triggers:
    - name: github-push-trigger
      bindings:
        - ref: github-push-binding
      template:
        ref: go-app-template
```

```bash
# æš´éœ²EventListener
kubectl port-forward svc/el-github-listener 8080:8080

# é…ç½®GitHub Webhook
# Payload URL: http://your-domain:8080
# Content type: application/json
# Events: Push events
```

---

## 4. Flux CD

### 4.1 å®‰è£…Flux

```bash
# å®‰è£…Flux CLI
curl -s https://fluxcd.io/install.sh | sudo bash

# éªŒè¯å®‰è£…
flux --version

# é¢„æ£€æŸ¥é›†ç¾¤
flux check --pre

# Bootstrap Flux (è¿æ¥GitHub)
export GITHUB_TOKEN=<your-token>
flux bootstrap github \
  --owner=your-org \
  --repository=gitops-infra \
  --branch=main \
  --path=clusters/production \
  --personal

# éªŒè¯å®‰è£…
flux check
```

### 4.2 é…ç½®GitRepositoryå’ŒKustomization

```yaml
# flux/gitrepository.yaml
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: go-api-repo
  namespace: flux-system
spec:
  interval: 1m
  url: https://github.com/your-org/go-api
  ref:
    branch: main
  secretRef:
    name: git-credentials

---
# flux/kustomization.yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: go-api
  namespace: flux-system
spec:
  interval: 5m
  path: ./deploy/overlays/production
  prune: true
  sourceRef:
    kind: GitRepository
    name: go-api-repo
  healthChecks:
    - apiVersion: apps/v1
      kind: Deployment
      name: go-api
      namespace: production
  timeout: 2m
```

### 4.3 Helm Releaseç®¡ç†

```yaml
# flux/helmrepository.yaml
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: my-charts
  namespace: flux-system
spec:
  interval: 10m
  url: https://charts.example.com

---
# flux/helmrelease.yaml
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: go-api
  namespace: production
spec:
  interval: 5m
  chart:
    spec:
      chart: go-api
      version: '>= 1.0.0 < 2.0.0'
      sourceRef:
        kind: HelmRepository
        name: my-charts
        namespace: flux-system
  
  # è‡ªå®šä¹‰Values
  values:
    replicaCount: 3
    image:
      repository: your-registry/go-api
      tag: v1.2.3
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi
  
  # å‡çº§é…ç½®
  upgrade:
    remediation:
      retries: 3
  
  # æµ‹è¯•
  test:
    enable: true
  
  # å›æ»š
  rollback:
    recreate: true
```

---

## 5. å¤šç¯å¢ƒç®¡ç†

### 5.1 Kustomizeå¤šç¯å¢ƒ

```yaml
# base/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - deployment.yaml
  - service.yaml
  - configmap.yaml

commonLabels:
  app: go-api

---
# overlays/dev/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
  - ../../base

namespace: dev

replicas:
  - name: go-api
    count: 1

images:
  - name: your-registry/go-api
    newTag: dev-latest

patches:
  - path: resources.yaml

---
# overlays/dev/resources.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: go-api
spec:
  template:
    spec:
      containers:
        - name: go-api
          resources:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 100m
              memory: 128Mi

---
# overlays/production/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
  - ../../base

namespace: production

replicas:
  - name: go-api
    count: 3

images:
  - name: your-registry/go-api
    newTag: v1.2.3

patches:
  - path: resources.yaml
  - path: hpa.yaml

---
# overlays/production/hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: go-api
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: go-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
```

```bash
# é¢„è§ˆå„ç¯å¢ƒé…ç½®
kustomize build overlays/dev
kustomize build overlays/staging
kustomize build overlays/production

# åº”ç”¨
kubectl apply -k overlays/production
```

### 5.2 Helmå¤šç¯å¢ƒ

```yaml
# helm-charts/go-api/values.yaml (é»˜è®¤å€¼)
replicaCount: 1

image:
  repository: your-registry/go-api
  pullPolicy: IfNotPresent
  tag: ""

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: false

---
# helm-charts/go-api/values-dev.yaml
replicaCount: 1

image:
  tag: dev-latest

resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

---
# helm-charts/go-api/values-prod.yaml
replicaCount: 3

image:
  tag: v1.2.3

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
```

```bash
# éƒ¨ç½²åˆ°ä¸åŒç¯å¢ƒ
helm upgrade --install go-api ./helm-charts/go-api \
  -n dev \
  -f helm-charts/go-api/values-dev.yaml

helm upgrade --install go-api ./helm-charts/go-api \
  -n production \
  -f helm-charts/go-api/values-prod.yaml
```

---

## 6. é‡‘ä¸é›€å‘å¸ƒ

### 6.1 Flagger + Istio

```bash
# å®‰è£…Flagger
kubectl apply -f https://raw.githubusercontent.com/fluxcd/flagger/main/artifacts/flagger/crd.yaml

helm upgrade -i flagger flagger/flagger \
  --namespace=istio-system \
  --set meshProvider=istio \
  --set metricsServer=http://prometheus:9090
```

```yaml
# flagger/canary.yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: go-api
  namespace: production
spec:
  # ç›®æ ‡Deployment
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: go-api
  
  # æœåŠ¡é…ç½®
  service:
    port: 8080
    targetPort: 8080
    gateways:
      - istio-gateway
    hosts:
      - api.example.com
  
  # é‡‘ä¸é›€åˆ†æ
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10
    
    # æŒ‡æ ‡æ£€æŸ¥
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    
    # Webhookæµ‹è¯•
    webhooks:
      - name: acceptance-test
        type: pre-rollout
        url: http://test-runner.default/
        timeout: 30s
        metadata:
          type: bash
          cmd: "curl -sd 'test' http://go-api-canary:8080/test | grep OK"
      
      - name: load-test
        url: http://flagger-loadtester.default/
        timeout: 5s
        metadata:
          cmd: "hey -z 1m -q 10 -c 2 http://go-api-canary.production:8080/"
```

```bash
# è§¦å‘é‡‘ä¸é›€å‘å¸ƒ (æ›´æ–°é•œåƒ)
kubectl set image deployment/go-api \
  go-api=your-registry/go-api:v1.2.4 \
  -n production

# ç›‘æ§é‡‘ä¸é›€è¿›åº¦
watch kubectl get canary -n production

# æŸ¥çœ‹è¯¦ç»†äº‹ä»¶
kubectl describe canary go-api -n production
```

### 6.2 Argo Rollouts

```bash
# å®‰è£…Argo Rollouts
kubectl create namespace argo-rollouts
kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml

# å®‰è£…kubectlæ’ä»¶
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
chmod +x kubectl-argo-rollouts-linux-amd64
sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
```

```yaml
# rollouts/rollout.yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: go-api
  namespace: production
spec:
  replicas: 5
  strategy:
    canary:
      steps:
        - setWeight: 20
        - pause: {duration: 2m}
        - setWeight: 40
        - pause: {duration: 2m}
        - setWeight: 60
        - pause: {duration: 2m}
        - setWeight: 80
        - pause: {duration: 2m}
      
      # è‡ªåŠ¨æå‡
      analysis:
        templates:
          - templateName: success-rate
        startingStep: 2
        args:
          - name: service-name
            value: go-api
      
      # æµé‡è·¯ç”± (Istio)
      trafficRouting:
        istio:
          virtualService:
            name: go-api
            routes:
              - primary
  
  revisionHistoryLimit: 2
  
  selector:
    matchLabels:
      app: go-api
  
  template:
    metadata:
      labels:
        app: go-api
    spec:
      containers:
        - name: go-api
          image: your-registry/go-api:v1.2.3
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: 500m
              memory: 512Mi

---
# rollouts/analysis-template.yaml
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
    - name: service-name
  metrics:
    - name: success-rate
      interval: 1m
      successCondition: result[0] >= 0.95
      failureLimit: 3
      provider:
        prometheus:
          address: http://prometheus.monitoring:9090
          query: |
            sum(rate(http_requests_total{
              service="{{args.service-name}}",
              status!~"5.."
            }[2m]))
            /
            sum(rate(http_requests_total{
              service="{{args.service-name}}"
            }[2m]))
```

```bash
# è§¦å‘Rollout
kubectl argo rollouts set image go-api \
  go-api=your-registry/go-api:v1.2.4 \
  -n production

# æŸ¥çœ‹RolloutçŠ¶æ€
kubectl argo rollouts get rollout go-api -n production --watch

# æ‰‹åŠ¨æå‡
kubectl argo rollouts promote go-api -n production

# æ‰‹åŠ¨å›æ»š
kubectl argo rollouts abort go-api -n production
kubectl argo rollouts undo go-api -n production
```

---

## 7. é…ç½®ç®¡ç†

### 7.1 Sealed Secrets (åŠ å¯†æ•æ„Ÿæ•°æ®)

```bash
# å®‰è£…Sealed Secrets Controller
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml

# å®‰è£…kubeseal CLI
# macOS
brew install kubeseal

# Linux
wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-linux-amd64 -O kubeseal
chmod +x kubeseal
sudo mv kubeseal /usr/local/bin/
```

```bash
# åˆ›å»ºæ™®é€šSecret
kubectl create secret generic db-credentials \
  --from-literal=username=admin \
  --from-literal=password=supersecret \
  --dry-run=client -o yaml > secret.yaml

# åŠ å¯†Secret
kubeseal -f secret.yaml -w sealed-secret.yaml

# æäº¤åˆ°Git
git add sealed-secret.yaml
git commit -m "Add encrypted DB credentials"
git push
```

```yaml
# sealed-secret.yaml (åŠ å¯†åå¯å®‰å…¨å­˜å‚¨åœ¨Git)
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: db-credentials
  namespace: production
spec:
  encryptedData:
    username: AgB1x5+...encrypted...
    password: AgCQ9f...encrypted...
  template:
    metadata:
      name: db-credentials
```

### 7.2 External Secrets Operator

```bash
# å®‰è£…External Secrets Operator
helm repo add external-secrets https://charts.external-secrets.io
helm install external-secrets \
  external-secrets/external-secrets \
  -n external-secrets-system \
  --create-namespace
```

```yaml
# external-secrets/secret-store.yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: production
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
# external-secrets/external-secret.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-credentials
  namespace: production
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: db-credentials
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: production/db
        property: username
    - secretKey: password
      remoteRef:
        key: production/db
        property: password
```

---

## 8. ç›‘æ§ä¸å‘Šè­¦

### 8.1 Prometheus + Grafanaé›†æˆ

```yaml
# monitoring/servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: go-api
  namespace: production
spec:
  selector:
    matchLabels:
      app: go-api
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics

---
# monitoring/prometheusrule.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: go-api-alerts
  namespace: production
spec:
  groups:
    - name: go-api
      interval: 30s
      rules:
        - alert: HighErrorRate
          expr: |
            rate(http_requests_total{job="go-api",status=~"5.."}[5m]) > 0.05
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "High error rate on {{ $labels.instance }}"
            description: "Error rate is {{ $value | humanizePercentage }}"
        
        - alert: HighLatency
          expr: |
            histogram_quantile(0.95, 
              rate(http_request_duration_seconds_bucket{job="go-api"}[5m])
            ) > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High latency on {{ $labels.instance }}"
```

### 8.2 è‡ªå®šä¹‰Grafana Dashboard

```json
// grafana/dashboard-go-api.json
{
  "dashboard": {
    "title": "Go API Metrics",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total{job=\"go-api\"}[5m])"
          }
        ],
        "type": "graph"
      },
      {
        "title": "Error Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total{job=\"go-api\",status=~\"5..\"}[5m])"
          }
        ],
        "type": "graph"
      },
      {
        "title": "Latency (p95)",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=\"go-api\"}[5m]))"
          }
        ],
        "type": "graph"
      }
    ]
  }
}
```

---

## 9. å®‰å…¨ä¸åˆè§„

### 9.1 Policy as Code (OPA Gatekeeper)

```bash
# å®‰è£…Gatekeeper
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml
```

```yaml
# policies/constraint-template.yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        openAPIV3Schema:
          properties:
            labels:
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels
        
        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("Missing required labels: %v", [missing])
        }

---
# policies/constraint.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: must-have-owner
spec:
  match:
    kinds:
      - apiGroups: ["apps"]
        kinds: ["Deployment"]
    namespaces:
      - production
  parameters:
    labels:
      - owner
      - environment
      - cost-center
```

### 9.2 é•œåƒæ‰«æä¸ç­–ç•¥

```yaml
# security/image-policy.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-image-signature
spec:
  validationFailureAction: enforce
  background: false
  webhookTimeoutSeconds: 30
  rules:
    - name: verify-signature
      match:
        any:
          - resources:
              kinds:
                - Pod
      verifyImages:
        - imageReferences:
            - "your-registry/*"
          attestors:
            - count: 1
              entries:
                - keys:
                    publicKeys: |-
                      -----BEGIN PUBLIC KEY-----
                      ...
                      -----END PUBLIC KEY-----

---
# security/vulnerability-scan-policy.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: check-vulnerabilities
spec:
  validationFailureAction: enforce
  background: true
  rules:
    - name: check-severity
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Image has HIGH or CRITICAL vulnerabilities"
        deny:
          conditions:
            any:
              - key: "{{ images.*.jmesPath.vulnerabilities[?severity=='HIGH'] | length(@) }}"
                operator: GreaterThan
                value: 0
```

---

## 10. å®Œæ•´é¡¹ç›®ç¤ºä¾‹

### 10.1 å®Œæ•´GitOpså·¥ä½œæµ

```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.3'
      
      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
  
  build:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
        with:
          repository: your-org/gitops-infra
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Update image tag
        run: |
          cd overlays/production
          kustomize edit set image \
            ghcr.io/${{ github.repository }}=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Update image to ${{ github.sha }}"
          git push
```

### 10.2 ç›‘æ§Dashboard

```go
// cmd/api/main.go
package main

import (
 "net/http"
 
 "github.com/gin-gonic/gin"
 "github.com/prometheus/client_golang/prometheus"
 "github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
 httpRequestsTotal = prometheus.NewCounterVec(
  prometheus.CounterOpts{
   Name: "http_requests_total",
   Help: "Total number of HTTP requests",
  },
  []string{"method", "endpoint", "status"},
 )
 
 httpRequestDuration = prometheus.NewHistogramVec(
  prometheus.HistogramOpts{
   Name:    "http_request_duration_seconds",
   Help:    "HTTP request latencies in seconds",
   Buckets: []float64{.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5},
  },
  []string{"method", "endpoint"},
 )
)

func init() {
 prometheus.MustRegister(httpRequestsTotal)
 prometheus.MustRegister(httpRequestDuration)
}

func main() {
 r := gin.Default()
 
 // Prometheus metrics
 r.GET("/metrics", gin.WrapH(promhttp.Handler()))
 
 // Middleware for metrics
 r.Use(func(c *gin.Context) {
  timer := prometheus.NewTimer(httpRequestDuration.WithLabelValues(c.Request.Method, c.FullPath()))
  defer timer.ObserveDuration()
  
  c.Next()
  
  httpRequestsTotal.WithLabelValues(
   c.Request.Method,
   c.FullPath(),
   fmt.Sprintf("%d", c.Writer.Status()),
  ).Inc()
 })
 
 // Health checks
 r.GET("/health", func(c *gin.Context) {
  c.JSON(http.StatusOK, gin.H{"status": "healthy"})
 })
 
 r.GET("/ready", func(c *gin.Context) {
  // Check dependencies
  c.JSON(http.StatusOK, gin.H{"status": "ready"})
 })
 
 r.Run(":8080")
}
```

---

## æ€»ç»“

### GitOpsæœ€ä½³å®è·µ

```text
1. ä»“åº“ç»“æ„:
   âœ… åº”ç”¨ä»£ç ä¸åŸºç¡€è®¾æ–½åˆ†ç¦»
   âœ… ä½¿ç”¨Kustomizeæˆ–Helmç®¡ç†å¤šç¯å¢ƒ
   âœ… Sealed SecretsåŠ å¯†æ•æ„Ÿæ•°æ®

2. CI/CDæµç¨‹:
   âœ… CIè´Ÿè´£æ„å»ºå’Œæµ‹è¯•
   âœ… CDé€šè¿‡GitOpsè‡ªåŠ¨éƒ¨ç½²
   âœ… æ‰€æœ‰å˜æ›´é€šè¿‡Gitå®¡è®¡

3. å‘å¸ƒç­–ç•¥:
   âœ… é‡‘ä¸é›€å‘å¸ƒ (Flagger/Argo Rollouts)
   âœ… è“ç»¿éƒ¨ç½²
   âœ… è‡ªåŠ¨å›æ»š

4. ç›‘æ§ä¸å‘Šè­¦:
   âœ… PrometheusæŒ‡æ ‡
   âœ… Grafanaå¯è§†åŒ–
   âœ… å‘Šè­¦è§„åˆ™

5. å®‰å…¨ä¸åˆè§„:
   âœ… Policy as Code (OPA)
   âœ… é•œåƒç­¾åéªŒè¯
   âœ… æ¼æ´æ‰«æ
```

### å·¥å…·é€‰æ‹©å»ºè®®

```text
ArgoCD vs Flux:
  ArgoCD: UIå‹å¥½, å¤šé›†ç¾¤æ”¯æŒ, æ˜“ä¸Šæ‰‹
  Flux: è½»é‡, CNCF, GitOps Toolkit

Kustomize vs Helm:
  Kustomize: ç®€å•, åŸç”Ÿæ”¯æŒ, æ— æ¨¡æ¿
  Helm: æˆç†Ÿ, ç¤¾åŒºchartsä¸°å¯Œ, åŠŸèƒ½å¼ºå¤§

Tekton vs GitHub Actions:
  Tekton: KubernetesåŸç”Ÿ, çµæ´»Pipeline
  GitHub Actions: æ˜“ç”¨, ä¸GitHubæ·±åº¦é›†æˆ
```

**ç›¸å…³æ–‡æ¡£:**

- [äº‘åŸç”Ÿéƒ¨ç½²](../06-äº‘åŸç”Ÿä¸å®¹å™¨/10-äº‘åŸç”Ÿå®Œæ•´é¡¹ç›®å®æˆ˜.md)
- [å¾®æœåŠ¡æ¶æ„](09-Go-1.25.3å¾®æœåŠ¡æ¶æ„å®Œæ•´å®æˆ˜.md)
- [Serverlessä¸FaaS](32-Go-1.25.3Serverlessä¸FaaSå®Œæ•´å®æˆ˜.md)
