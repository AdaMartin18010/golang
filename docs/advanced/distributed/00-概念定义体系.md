# 分布式系统 - 概念定义体系

**更新日期**: 2025-10-28

---

## 核心概念

### 1. CAP定理

**定义**: 分布式系统不可能同时满足一致性(C)、可用性(A)和分区容错性(P)

**三要素**:
- **C (Consistency)**: 所有节点同时看到相同数据
- **A (Availability)**: 每个请求都能得到响应
- **P (Partition Tolerance)**: 系统在网络分区时仍能工作

**权衡**:
```
CP系统: etcd, ZooKeeper, HBase
AP系统: Cassandra, DynamoDB, Couchbase
CA系统: 单机数据库
```

---

### 2. BASE理论

**定义**: Basically Available, Soft state, Eventually consistent

**核心思想**:
- **BA**: 基本可用（允许部分可用性损失）
- **S**: 软状态（允许中间状态）
- **E**: 最终一致性（不要求实时一致）

---

### 3. Raft一致性协议

**定义**: 易于理解的分布式一致性算法

**核心机制**:
```go
// Leader选举
type NodeState int
const (
    Follower NodeState = iota
    Candidate
    Leader
)

// 日志复制
type LogEntry struct {
    Term    int
    Command interface{}
}

// 任期投票
func (n *Node) RequestVote(term int, candidateID string) bool {
    if term > n.currentTerm {
        n.currentTerm = term
        n.votedFor = candidateID
        return true
    }
    return false
}
```

---

### 4. 分布式锁

**定义**: 在分布式环境中协调多个进程对共享资源的访问

**Redis实现**:
```go
// SET key value NX PX milliseconds
func AcquireLock(key, value string, ttl time.Duration) bool {
    result := redis.SetNX(key, value, ttl)
    return result == "OK"
}

// Lua脚本保证原子性
func ReleaseLock(key, value string) bool {
    script := `
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("del", KEYS[1])
        else
            return 0
        end
    `
    return redis.Eval(script, key, value) == 1
}
```

---

### 5. 分布式事务 - Saga模式

**定义**: 通过补偿机制实现的长事务模式

**工作流程**:
```
正向操作链: T1 → T2 → T3 → ... → Tn
补偿操作链: C1 ← C2 ← C3 ← ... ← Cn

执行:
成功: T1 → T2 → T3
失败: T1 → T2 → T3✗ → C2 → C1
```

**Go实现**:
```go
type SagaStep struct {
    Action     func() error
    Compensate func() error
}

func ExecuteSaga(steps []SagaStep) error {
    executed := []SagaStep{}
    for _, step := range steps {
        if err := step.Action(); err != nil {
            // 补偿已执行步骤
            for i := len(executed) - 1; i >= 0; i-- {
                executed[i].Compensate()
            }
            return err
        }
        executed = append(executed, step)
    }
    return nil
}
```

---

### 6. 一致性哈希

**定义**: 解决分布式缓存节点动态变化的哈希算法

**特点**:
- 单调性: 节点增加不影响其他节点映射
- 平衡性: 数据均匀分布
- 分散性: 同一数据在不同终端一致

**实现**:
```go
type ConsistentHash struct {
    ring       map[uint32]string  // 哈希环
    sortedKeys []uint32           // 排序的keys
    replicas   int                // 虚拟节点数
}

func (c *ConsistentHash) Get(key string) string {
    hash := c.hashKey(key)
    idx := sort.Search(len(c.sortedKeys), func(i int) bool {
        return c.sortedKeys[i] >= hash
    })
    if idx == len(c.sortedKeys) {
        idx = 0
    }
    return c.ring[c.sortedKeys[idx]]
}
```

---

## 🔗 相关文档

- [知识图谱](./00-知识图谱.md)
- [对比矩阵](./00-对比矩阵.md)

---

**最后更新**: 2025-10-28
