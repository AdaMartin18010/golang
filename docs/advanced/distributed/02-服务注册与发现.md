# æœåŠ¡æ³¨å†Œä¸å‘ç°

**ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2025-10-29
**é€‚ç”¨äº**: Go 1.25.3

---

## ğŸ“‹ ç›®å½•

- [æœåŠ¡æ³¨å†Œä¸å‘ç°](#æœåŠ¡æ³¨å†Œä¸å‘ç°)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. ğŸ“– æ¦‚å¿µä»‹ç»](#1--æ¦‚å¿µä»‹ç»)
  - [2. ğŸ¯ æ ¸å¿ƒç»„ä»¶](#2--æ ¸å¿ƒç»„ä»¶)
    - [1. Consulé›†æˆ](#1-consulé›†æˆ)
    - [2. etcdé›†æˆ](#2-etcdé›†æˆ)
    - [3. å¥åº·æ£€æŸ¥](#3-å¥åº·æ£€æŸ¥)
    - [4. å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡](#4-å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡)
  - [3. ğŸ—ï¸ å®Œæ•´ç¤ºä¾‹](#3-ï¸-å®Œæ•´ç¤ºä¾‹)
  - [4. ğŸ’¡ æœ€ä½³å®è·µ](#4--æœ€ä½³å®è·µ)
  - [5. ğŸ“š ç›¸å…³èµ„æº](#5--ç›¸å…³èµ„æº)

---

## 1. ğŸ“– æ¦‚å¿µä»‹ç»

æœåŠ¡æ³¨å†Œä¸å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…è®¸æœåŠ¡åŠ¨æ€å‘ç°å’Œé€šä¿¡ï¼Œæ— éœ€ç¡¬ç¼–ç åœ°å€ã€‚

---

## 2. ğŸ¯ æ ¸å¿ƒç»„ä»¶

### 1. Consulé›†æˆ

```go
package main

import (
    "fmt"
    "github.com/hashicorp/consul/api"
)

type ServiceRegistry struct {
    client *api.Client
}

func NewServiceRegistry(addr string) (*ServiceRegistry, error) {
    config := api.DefaultConfig()
    config.Address = addr

    client, err := api.NewClient(config)
    if err != nil {
        return nil, err
    }

    return &ServiceRegistry{client: client}, nil
}

// æ³¨å†ŒæœåŠ¡
func (sr *ServiceRegistry) Register(name, id, address string, port int) error {
    registration := &api.AgentServiceRegistration{
        ID:      id,
        Name:    name,
        Address: address,
        Port:    port,
        Check: &api.AgentServiceCheck{
            HTTP:     fmt.Sprintf("http://%s:%d/health", address, port),
            Interval: "10s",
            Timeout:  "3s",
        },
    }

    return sr.client.Agent().ServiceRegister(registration)
}

// æ³¨é”€æœåŠ¡
func (sr *ServiceRegistry) Deregister(id string) error {
    return sr.client.Agent().ServiceDeregister(id)
}

// å‘ç°æœåŠ¡
func (sr *ServiceRegistry) Discover(name string) ([]*api.ServiceEntry, error) {
    services, _, err := sr.client.Health().Service(name, "", true, nil)
    return services, err
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    registry, _ := NewServiceRegistry("localhost:8500")

    // æ³¨å†ŒæœåŠ¡
    registry.Register("my-service", "my-service-1", "localhost", 8080)

    // å‘ç°æœåŠ¡
    services, _ := registry.Discover("my-service")
    for _, service := range services {
        fmt.Printf("Service: %s at %s:%d\n",
            service.Service.Service,
            service.Service.Address,
            service.Service.Port)
    }
}
```

---

### 2. etcdé›†æˆ

```go
package main

import (
    "context"
    "fmt"
    "time"

    clientv3 "go.etcd.io/etcd/client/v3"
)

type EtcdRegistry struct {
    client *clientv3.Client
    lease  clientv3.Lease
}

func NewEtcdRegistry(endpoints []string) (*EtcdRegistry, error) {
    client, err := clientv3.New(clientv3.Config{
        Endpoints:   endpoints,
        DialTimeout: 5 * time.Second,
    })
    if err != nil {
        return nil, err
    }

    return &EtcdRegistry{
        client: client,
        lease:  clientv3.NewLease(client),
    }, nil
}

// æ³¨å†ŒæœåŠ¡ï¼ˆå¸¦TTLï¼‰
func (er *EtcdRegistry) Register(ctx context.Context, key, value string, ttl int64) error {
    // åˆ›å»ºç§Ÿçº¦
    grant, err := er.lease.Grant(ctx, ttl)
    if err != nil {
        return err
    }

    // æ³¨å†ŒæœåŠ¡
    _, err = er.client.Put(ctx, key, value, clientv3.WithLease(grant.ID))
    if err != nil {
        return err
    }

    // ä¿æŒç§Ÿçº¦
    keepAlive, err := er.lease.KeepAlive(ctx, grant.ID)
    if err != nil {
        return err
    }

    go func() {
        for range keepAlive {
            // å¤„ç†keepaliveå“åº”
        }
    }()

    return nil
}

// å‘ç°æœåŠ¡
func (er *EtcdRegistry) Discover(ctx context.Context, prefix string) ([]string, error) {
    resp, err := er.client.Get(ctx, prefix, clientv3.WithPrefix())
    if err != nil {
        return nil, err
    }

    var services []string
    for _, kv := range resp.Kvs {
        services = append(services, string(kv.Value))
    }

    return services, nil
}

// ç›‘å¬æœåŠ¡å˜åŒ–
func (er *EtcdRegistry) Watch(ctx context.Context, prefix string) clientv3.WatchChan {
    return er.client.Watch(ctx, prefix, clientv3.WithPrefix())
}
```

---

### 3. å¥åº·æ£€æŸ¥

```go
type HealthChecker struct {
    services map[string]*ServiceInfo
    interval time.Duration
    mu       sync.RWMutex
}

type ServiceInfo struct {
    Address string
    Healthy bool
    LastCheck time.Time
}

func (hc *HealthChecker) StartHealthCheck(ctx context.Context) {
    ticker := time.NewTicker(hc.interval)
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:
            hc.checkAll()
        case <-ctx.Done():
            return
        }
    }
}

func (hc *HealthChecker) checkAll() {
    hc.mu.Lock()
    defer hc.mu.Unlock()

    for name, info := range hc.services {
        healthy := hc.checkHealth(info.Address)
        info.Healthy = healthy
        info.LastCheck = time.Now()
        hc.services[name] = info
    }
}

func (hc *HealthChecker) checkHealth(address string) bool {
    client := &http.Client{Timeout: 3 * time.Second}
    resp, err := client.Get(fmt.Sprintf("http://%s/health", address))
    if err != nil {
        return false
    }
    defer resp.Body.Close()

    return resp.StatusCode == http.StatusOK
}

func (hc *HealthChecker) GetHealthyServices() []string {
    hc.mu.RLock()
    defer hc.mu.RUnlock()

    var healthy []string
    for name, info := range hc.services {
        if info.Healthy {
            healthy = append(healthy, name)
        }
    }
    return healthy
}
```

---

### 4. å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡

```go
type LoadBalancer struct {
    services []string
    current  uint32
}

// è½®è¯¢
func (lb *LoadBalancer) RoundRobin() string {
    n := atomic.AddUint32(&lb.current, 1)
    return lb.services[int(n-1)%len(lb.services)]
}

// éšæœº
func (lb *LoadBalancer) Random() string {
    return lb.services[rand.Intn(len(lb.services))]
}

// å¸¦æƒé‡
type WeightedService struct {
    Address string
    Weight  int
}

func (lb *LoadBalancer) WeightedRandom(services []WeightedService) string {
    totalWeight := 0
    for _, s := range services {
        totalWeight += s.Weight
    }

    r := rand.Intn(totalWeight)
    for _, s := range services {
        r -= s.Weight
        if r < 0 {
            return s.Address
        }
    }

    return services[0].Address
}
```

---

## 3. ğŸ—ï¸ å®Œæ•´ç¤ºä¾‹

```go
// æœåŠ¡ç«¯
func main() {
    registry, _ := NewServiceRegistry("localhost:8500")

    // æ³¨å†ŒæœåŠ¡
    serviceID := "my-service-1"
    registry.Register("my-service", serviceID, "localhost", 8080)

    // ä¼˜é›…å…³é—­æ—¶æ³¨é”€
    defer registry.Deregister(serviceID)

    // å¯åŠ¨HTTPæœåŠ¡
    http.HandleFunc("/health", func(w http.ResponseWriter, r *http.Request) {
        w.WriteHeader(http.StatusOK)
    })

    http.ListenAndServe(":8080", nil)
}

// å®¢æˆ·ç«¯
func main() {
    registry, _ := NewServiceRegistry("localhost:8500")

    // å‘ç°æœåŠ¡
    services, _ := registry.Discover("my-service")

    // è´Ÿè½½å‡è¡¡
    lb := &LoadBalancer{
        services: extractAddresses(services),
    }

    // è°ƒç”¨æœåŠ¡
    address := lb.RoundRobin()
    resp, _ := http.Get(fmt.Sprintf("http://%s/api", address))
    defer resp.Body.Close()
}
```

---

## 4. ğŸ’¡ æœ€ä½³å®è·µ

1. **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
2. **ä¼˜é›…é€€å‡º**: æœåŠ¡å…³é—­å‰æ³¨é”€
3. **é‡è¯•æœºåˆ¶**: è°ƒç”¨å¤±è´¥æ—¶é‡è¯•å…¶ä»–å®ä¾‹
4. **ç¼“å­˜**: ç¼“å­˜æœåŠ¡åˆ—è¡¨ï¼Œå‡å°‘æ³¨å†Œä¸­å¿ƒå‹åŠ›
5. **ç›‘æ§**: ç›‘æ§æ³¨å†Œ/æ³¨é”€äº‹ä»¶

---

## 5. ğŸ“š ç›¸å…³èµ„æº

- [Consul Documentation](https://www.consul.io/docs)
- [etcd Documentation](https://etcd.io/docs/)

**ä¸‹ä¸€æ­¥**: [03-åˆ†å¸ƒå¼ä¸€è‡´æ€§](./03-åˆ†å¸ƒå¼ä¸€è‡´æ€§.md)

---

**æœ€åæ›´æ–°**: 2025-10-29
