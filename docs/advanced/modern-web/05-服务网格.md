# 服务网格

**版本**: v1.0  
**更新日期**: 2025-10-29  
**适用于**: Go 1.25.3

---

## 📋 目录


- [1. 📖 Istio集成](#1.-istio集成)
- [🔀 流量管理](#流量管理)
- [🔐 mTLS](#mtls)
- [📊 可观测性](#可观测性)
- [📚 相关资源](#相关资源)

## 1. 📖 Istio集成

```yaml
# virtualservice.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myservice
spec:
  hosts:
  - myservice
  http:
  - match:
    - headers:
        version:
          exact: v2
    route:
    - destination:
        host: myservice
        subset: v2
  - route:
    - destination:
        host: myservice
        subset: v1
```

```go
// Go服务集成Istio
func main() {
    // 健康检查端点
    http.HandleFunc("/health", func(w http.ResponseWriter, r *http.Request) {
        w.WriteHeader(http.StatusOK)
    })
    
    // 就绪检查
    http.HandleFunc("/ready", func(w http.ResponseWriter, r *http.Request) {
        if isReady() {
            w.WriteHeader(http.StatusOK)
        } else {
            w.WriteHeader(http.StatusServiceUnavailable)
        }
    })
    
    // 业务逻辑
    http.HandleFunc("/api/users", handleUsers)
    
    log.Fatal(http.ListenAndServe(":8080", nil))
}
```

---

## 🔀 流量管理

```go
// A/B测试配置
type TrafficSplit struct {
    VersionA float64
    VersionB float64
}

func routeTraffic(split TrafficSplit) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        random := rand.Float64()
        
        var version string
        if random < split.VersionA {
            version = "v1"
        } else {
            version = "v2"
        }
        
        r.Header.Set("X-Version", version)
        // 继续处理...
    })
}
```

---

## 🔐 mTLS

```yaml
# peerauthentication.yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
spec:
  mtls:
    mode: STRICT
```

---

## 📊 可观测性

```go
import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    requestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "http_request_duration_seconds",
            Help: "HTTP request duration",
        },
        []string{"method", "path", "status"},
    )
)

func metricsMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        start := time.Now()
        
        recorder := &responseRecorder{ResponseWriter: w}
        next.ServeHTTP(recorder, r)
        
        duration := time.Since(start).Seconds()
        requestDuration.WithLabelValues(
            r.Method,
            r.URL.Path,
            strconv.Itoa(recorder.statusCode),
        ).Observe(duration)
    })
}
```

---

## 📚 相关资源

- [Istio](https://istio.io/)
- [Linkerd](https://linkerd.io/)

**版本**: v1.0  
**更新日期**: 2025-10-29  
**适用于**: Go 1.25.3

---

**最后更新**: 2025-10-29

