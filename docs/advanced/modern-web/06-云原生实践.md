# 云原生实践

**版本**: v1.0
**更新日期**: 2025-10-29
**适用于**: Go 1.25.3

---

## 📋 目录

- [云原生实践](#云原生实践)
  - [📋 目录](#-目录)
  - [1. 📖 12-Factor App](#1--12-factor-app)
  - [🐳 容器化](#-容器化)
  - [☸️ Kubernetes部署](#️-kubernetes部署)
  - [🔧 配置管理](#-配置管理)
  - [📊 可观测性三支柱](#-可观测性三支柱)
  - [🚀 GitOps](#-gitops)
  - [📚 相关资源](#-相关资源)

## 1. 📖 12-Factor App

```go
// 1. 配置从环境变量读取
type Config struct {
    Port       string
    DBHost     string
    DBPassword string
}

func LoadConfig() *Config {
    return &Config{
        Port:       getEnv("PORT", "8080"),
        DBHost:     os.Getenv("DB_HOST"),
        DBPassword: os.Getenv("DB_PASSWORD"),
    }
}

// 2. 无状态服务
type StatelessService struct {
    cache *redis.Client // 外部状态存储
}

// 3. 健康检查
func (s *Service) Health(w http.ResponseWriter, r *http.Request) {
    if err := s.db.Ping(); err != nil {
        w.WriteHeader(http.StatusServiceUnavailable)
        return
    }
    w.WriteHeader(http.StatusOK)
}

// 4. 优雅关闭
func gracefulShutdown(server *http.Server) {
    quit := make(chan os.Signal, 1)
    signal.Notify(quit, syscall.SIGTERM, syscall.SIGINT)
    <-quit

    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()

    server.Shutdown(ctx)
}
```

---

## 🐳 容器化

```dockerfile
# 多阶段构建
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go mod download
RUN CGO_ENABLED=0 GOOS=linux go build -o main .

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/main .
EXPOSE 8080
CMD ["./main"]
```

---

## ☸️ Kubernetes部署

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:latest
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: host
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          limits:
            memory: "512Mi"
            cpu: "500m"
          requests:
            memory: "256Mi"
            cpu: "250m"
```

---

## 🔧 配置管理

```go
import "github.com/spf13/viper"

func initConfig() {
    viper.SetConfigName("config")
    viper.SetConfigType("yaml")
    viper.AddConfigPath("/etc/myapp/")
    viper.AddConfigPath(".")

    viper.AutomaticEnv() // 环境变量优先

    if err := viper.ReadInConfig(); err != nil {
        log.Fatal(err)
    }
}

// 使用
dbHost := viper.GetString("database.host")
port := viper.GetInt("server.port")
```

---

## 📊 可观测性三支柱

```go
// 1. 日志
import "go.uber.org/zap"

logger, _ := zap.NewProduction()
defer logger.Sync()

logger.Info("user login",
    zap.String("user_id", "123"),
    zap.String("ip", "192.168.1.1"),
)

// 2. 指标 (Metrics)
import "github.com/prometheus/client_golang/prometheus"

httpRequestsTotal := prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Name: "http_requests_total",
    },
    []string{"method", "endpoint", "status"},
)

// 3. 追踪 (Tracing)
import "go.opentelemetry.io/otel"

tracer := otel.Tracer("my-service")
ctx, span := tracer.Start(r.Context(), "handle-request")
defer span.End()
```

---

## 🚀 GitOps

```yaml
# argocd-app.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: myapp
spec:
  project: default
  source:
    repoURL: https://github.com/myorg/myapp
    targetRevision: HEAD
    path: k8s
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

---

## 📚 相关资源

- [12 Factor App](https://12factor.net/)
- [Cloud Native Computing Foundation](https://www.cncf.io/)
- [Kubernetes Best Practices](https://kubernetes.io/docs/concepts/)

---
