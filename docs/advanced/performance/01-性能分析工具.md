# Goæ€§èƒ½åˆ†æå·¥å…·

> **ç®€ä»‹**: Goæ€§èƒ½åˆ†æå·¥å…·å®Œæ•´æŒ‡å—ï¼ŒåŒ…æ‹¬pprofã€traceã€benchmarkå’Œæ€§èƒ½åˆ†ææœ€ä½³å®è·µ

> **ç‰ˆæœ¬**: Go 1.25.3  
> **éš¾åº¦**: â­â­â­â­  
> **æ ‡ç­¾**: #æ€§èƒ½åˆ†æ #pprof #trace #benchmark

---

## ğŸ“‹ ç›®å½•

- [1. pprofæ€§èƒ½åˆ†æ](#1-pprofæ€§èƒ½åˆ†æ)
  - [CPUæ€§èƒ½åˆ†æ](#cpuæ€§èƒ½åˆ†æ)
  - [å†…å­˜æ€§èƒ½åˆ†æ](#å†…å­˜æ€§èƒ½åˆ†æ)
  - [HTTPæœåŠ¡æ€§èƒ½åˆ†æ](#httpæœåŠ¡æ€§èƒ½åˆ†æ)
- [2. Execution Trace](#2-execution-trace)
  - [æ”¶é›†traceæ•°æ®](#æ”¶é›†traceæ•°æ®)
  - [åˆ†ætrace](#åˆ†ætrace)
- [3. BenchmarkåŸºå‡†æµ‹è¯•](#3-benchmarkåŸºå‡†æµ‹è¯•)
  - [åŸºæœ¬benchmark](#åŸºæœ¬benchmark)
  - [å¹¶è¡Œbenchmark](#å¹¶è¡Œbenchmark)
  - [å­benchmark](#å­benchmark)
- [4. å®æˆ˜æ¡ˆä¾‹](#4-å®æˆ˜æ¡ˆä¾‹)
  - [æ¡ˆä¾‹1: æ‰¾å‡ºCPUçƒ­ç‚¹](#æ¡ˆä¾‹1-æ‰¾å‡ºcpuçƒ­ç‚¹)
  - [æ¡ˆä¾‹2: å†…å­˜æ³„æ¼æ£€æµ‹](#æ¡ˆä¾‹2-å†…å­˜æ³„æ¼æ£€æµ‹)
  - [æ¡ˆä¾‹3: GCå‹åŠ›åˆ†æ](#æ¡ˆä¾‹3-gcå‹åŠ›åˆ†æ)
- [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
  - [æ€§èƒ½åˆ†ææµç¨‹](#æ€§èƒ½åˆ†ææµç¨‹)
  - [pprofæŠ€å·§](#pprofæŠ€å·§)
  - [benchmarkæŠ€å·§](#benchmarkæŠ€å·§)
  - [ç”Ÿäº§ç¯å¢ƒç›‘æ§](#ç”Ÿäº§ç¯å¢ƒç›‘æ§)
- [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

## 1. pprofæ€§èƒ½åˆ†æ

### CPUæ€§èƒ½åˆ†æ

```go
import (
    "os"
    "runtime/pprof"
)

func main() {
    // åˆ›å»ºCPU profileæ–‡ä»¶
    f, _ := os.Create("cpu.pprof")
    defer f.Close()
    
    // å¼€å§‹CPU profiling
    pprof.StartCPUProfile(f)
    defer pprof.StopCPUProfile()
    
    // è¿è¡Œä½ çš„ä»£ç 
    doWork()
}
```

**åˆ†æ**:
```bash
go tool pprof cpu.pprof
(pprof) top
(pprof) list functionName
(pprof) web  # ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨
```

---

### å†…å­˜æ€§èƒ½åˆ†æ

```go
import (
    "os"
    "runtime"
    "runtime/pprof"
)

func main() {
    doWork()
    
    // åˆ›å»ºå†…å­˜profileæ–‡ä»¶
    f, _ := os.Create("mem.pprof")
    defer f.Close()
    
    runtime.GC()  // è§¦å‘GC
    pprof.WriteHeapProfile(f)
}
```

**åˆ†æ**:
```bash
go tool pprof mem.pprof
(pprof) top
(pprof) list functionName
```

---

### HTTPæœåŠ¡æ€§èƒ½åˆ†æ

```go
import (
    _ "net/http/pprof"
    "net/http"
)

func main() {
    // pprofä¼šè‡ªåŠ¨æ³¨å†ŒHTTPç«¯ç‚¹
    go http.ListenAndServe("localhost:6060", nil)
    
    // ä½ çš„æœåŠ¡ä»£ç 
    startServer()
}
```

**è®¿é—®ç«¯ç‚¹**:
- http://localhost:6060/debug/pprof/
- http://localhost:6060/debug/pprof/heap
- http://localhost:6060/debug/pprof/goroutine
- http://localhost:6060/debug/pprof/profile?seconds=30

**å®æ—¶åˆ†æ**:
```bash
# CPU profile
go tool pprof http://localhost:6060/debug/pprof/profile?seconds=30

# å†…å­˜ profile
go tool pprof http://localhost:6060/debug/pprof/heap

# Goroutine profile
go tool pprof http://localhost:6060/debug/pprof/goroutine

# å¯è§†åŒ–
go tool pprof -http=:8080 profile.pprof
```

---

## 2. Execution Trace

### æ”¶é›†traceæ•°æ®

```go
import (
    "os"
    "runtime/trace"
)

func main() {
    f, _ := os.Create("trace.out")
    defer f.Close()
    
    trace.Start(f)
    defer trace.Stop()
    
    // è¿è¡Œä½ çš„ä»£ç 
    doWork()
}
```

### åˆ†ætrace

```bash
go tool trace trace.out
```

**traceå¯ä»¥çœ‹åˆ°**:
- Goroutineè°ƒåº¦
- ç³»ç»Ÿè°ƒç”¨
- GCäº‹ä»¶
- Network I/O
- ç”¨æˆ·è‡ªå®šä¹‰äº‹ä»¶

---

## 3. BenchmarkåŸºå‡†æµ‹è¯•

### åŸºæœ¬benchmark

```go
func BenchmarkFibonacci(b *testing.B) {
    for i := 0; i < b.N; i++ {
        Fibonacci(20)
    }
}
```

**è¿è¡Œ**:
```bash
go test -bench=. -benchmem
```

**è¾“å‡º**:
```
BenchmarkFibonacci-8   30000   50000 ns/op   0 B/op   0 allocs/op
```

---

### å¹¶è¡Œbenchmark

```go
func BenchmarkParallel(b *testing.B) {
    b.RunParallel(func(pb *testing.PB) {
        for pb.Next() {
            doWork()
        }
    })
}
```

---

### å­benchmark

```go
func BenchmarkCompare(b *testing.B) {
    for _, size := range []int{100, 1000, 10000} {
        b.Run(fmt.Sprintf("Size_%d", size), func(b *testing.B) {
            for i := 0; i < b.N; i++ {
                processData(size)
            }
        })
    }
}
```

---

## 4. å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: æ‰¾å‡ºCPUçƒ­ç‚¹

```go
// ä¼˜åŒ–å‰
func processData(data []int) int {
    sum := 0
    for _, v := range data {
        sum += expensiveOperation(v)  // çƒ­ç‚¹å‡½æ•°
    }
    return sum
}

// ä½¿ç”¨pprofå‘ç°expensiveOperationæ˜¯çƒ­ç‚¹
// ä¼˜åŒ–åï¼šç¼“å­˜ç»“æœ
var cache = make(map[int]int)

func processDataOptimized(data []int) int {
    sum := 0
    for _, v := range data {
        if result, ok := cache[v]; ok {
            sum += result
        } else {
            result := expensiveOperation(v)
            cache[v] = result
            sum += result
        }
    }
    return sum
}
```

---

### æ¡ˆä¾‹2: å†…å­˜æ³„æ¼æ£€æµ‹

```go
// é—®é¢˜ä»£ç ï¼šGoroutineæ³„æ¼
func leakyFunction() {
    ch := make(chan int)
    go func() {
        val := <-ch  // æ°¸è¿œé˜»å¡ï¼Œgoroutineæ³„æ¼
        fmt.Println(val)
    }()
    // chæ²¡æœ‰è¢«å†™å…¥ï¼Œgoroutineæ°¸è¿œç­‰å¾…
}

// ä½¿ç”¨goroutine profileæ£€æµ‹
// http://localhost:6060/debug/pprof/goroutine

// ä¿®å¤ï¼šä½¿ç”¨contextå–æ¶ˆ
func fixedFunction(ctx context.Context) {
    ch := make(chan int)
    go func() {
        select {
        case val := <-ch:
            fmt.Println(val)
        case <-ctx.Done():
            return  // æ­£å¸¸é€€å‡º
        }
    }()
}
```

---

### æ¡ˆä¾‹3: GCå‹åŠ›åˆ†æ

```bash
# æŸ¥çœ‹GCç»Ÿè®¡
GODEBUG=gctrace=1 ./myapp

# åˆ†æå †å†…å­˜
go tool pprof -alloc_space http://localhost:6060/debug/pprof/heap
```

---

## 5. æœ€ä½³å®è·µ

### æ€§èƒ½åˆ†ææµç¨‹

```
1. å»ºç«‹åŸºå‡†
   â†“
2. è¿è¡Œpprof/trace
   â†“
3. è¯†åˆ«ç“¶é¢ˆ
   â†“
4. ä¼˜åŒ–ä»£ç 
   â†“
5. å¯¹æ¯”åŸºå‡†
   â†“
6. é‡å¤2-5ç›´åˆ°æ»¡æ„
```

---

### pprofæŠ€å·§

**1. å¯¹æ¯”profile**:
```bash
go tool pprof -base=old.pprof new.pprof
```

**2. ç«ç„°å›¾**:
```bash
go tool pprof -http=:8080 cpu.pprof
```

**3. æŸ¥çœ‹è°ƒç”¨å›¾**:
```bash
(pprof) web
```

---

### benchmarkæŠ€å·§

**1. é¿å…ç¼–è¯‘å™¨ä¼˜åŒ–**:
```go
var result int

func BenchmarkFunction(b *testing.B) {
    var r int
    for i := 0; i < b.N; i++ {
        r = function()  // å°†ç»“æœèµ‹å€¼ç»™å±€éƒ¨å˜é‡
    }
    result = r  // é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ‰æ•´ä¸ªå¾ªç¯
}
```

**2. é‡ç½®å®šæ—¶å™¨**:
```go
func BenchmarkWithSetup(b *testing.B) {
    heavySetup()  // è€—æ—¶çš„å‡†å¤‡å·¥ä½œ
    
    b.ResetTimer()  // é‡ç½®è®¡æ—¶å™¨
    
    for i := 0; i < b.N; i++ {
        function()
    }
}
```

---

### ç”Ÿäº§ç¯å¢ƒç›‘æ§

```go
import (
    "expvar"
    "net/http"
)

func init() {
    // æš´éœ²è¿è¡Œæ—¶ç»Ÿè®¡
    expvar.Publish("goroutines", expvar.Func(func() any {
        return runtime.NumGoroutine()
    }))
}

func main() {
    // expvar + pprof
    go http.ListenAndServe(":6060", nil)
    
    // ä½ çš„æœåŠ¡
    startServer()
}
```

---

## ğŸ”— ç›¸å…³èµ„æº

- [pprofå®˜æ–¹æ–‡æ¡£](https://pkg.go.dev/runtime/pprof)
- [traceå·¥å…·](https://pkg.go.dev/runtime/trace)
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](../02-å†…å­˜ä¼˜åŒ–.md)

---

**æœ€åæ›´æ–°**: 2025-10-28  
**Goç‰ˆæœ¬**: 1.25.3

