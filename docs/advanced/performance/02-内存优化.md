# Goå†…å­˜ä¼˜åŒ–

**ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2025-10-29
**é€‚ç”¨äº**: Go 1.25.3

---

> **éš¾åº¦**: â­â­â­â­
> **æ ‡ç­¾**: #æ€§èƒ½ä¼˜åŒ– #å†…å­˜ #GC #é€ƒé€¸åˆ†æ

## ğŸ“‹ ç›®å½•

- [Goå†…å­˜ä¼˜åŒ–](#goå†…å­˜ä¼˜åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. å†…å­˜åˆ†é…åŸºç¡€](#1-å†…å­˜åˆ†é…åŸºç¡€)
    - [æ ˆvså †](#æ ˆvså †)
    - [æŸ¥çœ‹å†…å­˜åˆ†é…](#æŸ¥çœ‹å†…å­˜åˆ†é…)
  - [2. å†…å­˜é€ƒé€¸åˆ†æ](#2-å†…å­˜é€ƒé€¸åˆ†æ)
    - [é€ƒé€¸åœºæ™¯1: è¿”å›æŒ‡é’ˆ](#é€ƒé€¸åœºæ™¯1-è¿”å›æŒ‡é’ˆ)
    - [é€ƒé€¸åœºæ™¯2: æ¥å£èµ‹å€¼](#é€ƒé€¸åœºæ™¯2-æ¥å£èµ‹å€¼)
    - [é€ƒé€¸åœºæ™¯3: é—­åŒ…æ•è·](#é€ƒé€¸åœºæ™¯3-é—­åŒ…æ•è·)
    - [é€ƒé€¸åœºæ™¯4: å¤§å¯¹è±¡](#é€ƒé€¸åœºæ™¯4-å¤§å¯¹è±¡)
  - [3. sync.Pool](#3-syncpool)
    - [åŸºæœ¬ä½¿ç”¨](#åŸºæœ¬ä½¿ç”¨)
    - [HTTP Handlerä¸­ä½¿ç”¨](#http-handlerä¸­ä½¿ç”¨)
    - [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
  - [4. å‡å°‘å†…å­˜åˆ†é…](#4-å‡å°‘å†…å­˜åˆ†é…)
    - [é¢„åˆ†é…åˆ‡ç‰‡](#é¢„åˆ†é…åˆ‡ç‰‡)
    - [å­—ç¬¦ä¸²æ‹¼æ¥](#å­—ç¬¦ä¸²æ‹¼æ¥)
    - [å¤ç”¨buffer](#å¤ç”¨buffer)
    - [Mapé¢„åˆ†é…](#mapé¢„åˆ†é…)
  - [5. GCä¼˜åŒ–](#5-gcä¼˜åŒ–)
    - [å‡å°‘æŒ‡é’ˆæ•°é‡](#å‡å°‘æŒ‡é’ˆæ•°é‡)
    - [æ§åˆ¶GCé¢‘ç‡](#æ§åˆ¶gcé¢‘ç‡)
    - [æ‰¹é‡åˆ†é…](#æ‰¹é‡åˆ†é…)
  - [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
    - [1. ä½¿ç”¨åŸºå‡†æµ‹è¯•](#1-ä½¿ç”¨åŸºå‡†æµ‹è¯•)
    - [2. åˆ†æå†…å­˜ä½¿ç”¨](#2-åˆ†æå†…å­˜ä½¿ç”¨)
    - [3. é¿å…ä¸å¿…è¦çš„æ‹·è´](#3-é¿å…ä¸å¿…è¦çš„æ‹·è´)
    - [4. ä½¿ç”¨\[\]byteè€Œä¸æ˜¯string](#4-ä½¿ç”¨byteè€Œä¸æ˜¯string)
    - [5. åŠæ—¶é‡Šæ”¾èµ„æº](#5-åŠæ—¶é‡Šæ”¾èµ„æº)
  - [ğŸ¯ æ€§èƒ½å¯¹æ¯”](#-æ€§èƒ½å¯¹æ¯”)
    - [å­—ç¬¦ä¸²æ‹¼æ¥](#å­—ç¬¦ä¸²æ‹¼æ¥-1)
    - [sync.Pool](#syncpool)
  - [ğŸ’¼ å®æˆ˜æ¡ˆä¾‹](#-å®æˆ˜æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1: HTTPæœåŠ¡å†…å­˜ä¼˜åŒ–](#æ¡ˆä¾‹1-httpæœåŠ¡å†…å­˜ä¼˜åŒ–)
    - [æ¡ˆä¾‹2: æ•°æ®æ‰¹å¤„ç†ä¼˜åŒ–](#æ¡ˆä¾‹2-æ•°æ®æ‰¹å¤„ç†ä¼˜åŒ–)
    - [æ¡ˆä¾‹3: å¯¹è±¡æ± åœ¨gRPCä¸­çš„åº”ç”¨](#æ¡ˆä¾‹3-å¯¹è±¡æ± åœ¨grpcä¸­çš„åº”ç”¨)
    - [æ¡ˆä¾‹4: JSONç¼–ç ä¼˜åŒ–](#æ¡ˆä¾‹4-jsonç¼–ç ä¼˜åŒ–)
    - [æ¡ˆä¾‹5: å­—ç¬¦ä¸²æ‹¼æ¥ä¼˜åŒ–](#æ¡ˆä¾‹5-å­—ç¬¦ä¸²æ‹¼æ¥ä¼˜åŒ–)
  - [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

## 1. å†…å­˜åˆ†é…åŸºç¡€

### æ ˆvså †

```go
// æ ˆåˆ†é…ï¼ˆå¿«é€Ÿï¼‰
func stackAlloc() int {
    x := 42  // åˆ†é…åœ¨æ ˆä¸Š
    return x
}

// å †åˆ†é…ï¼ˆè¾ƒæ…¢ï¼‰
func heapAlloc() *int {
    x := 42
    return &x  // é€ƒé€¸åˆ°å †
}
```

---

### æŸ¥çœ‹å†…å­˜åˆ†é…

```bash
# æŸ¥çœ‹å†…å­˜åˆ†é…
go build -gcflags="-m" main.go

# è¾“å‡ºç¤ºä¾‹ï¼š
# ./main.go:5:2: moved to heap: x
```

---

## 2. å†…å­˜é€ƒé€¸åˆ†æ

### é€ƒé€¸åœºæ™¯1: è¿”å›æŒ‡é’ˆ

```go
// âŒ é€ƒé€¸åˆ°å †
func newUser() *User {
    u := User{Name: "Alice"}
    return &u  // ué€ƒé€¸åˆ°å †
}

// âœ… åœ¨æ ˆä¸Šåˆ†é…
func newUser() User {
    return User{Name: "Alice"}  // è¿”å›å€¼ï¼Œä¸é€ƒé€¸
}
```

---

### é€ƒé€¸åœºæ™¯2: æ¥å£èµ‹å€¼

```go
// âŒ é€ƒé€¸åˆ°å †
func printValue(v interface{}) {
    fmt.Println(v)
}

func main() {
    x := 42
    printValue(x)  // xé€ƒé€¸åˆ°å †
}

// âœ… é¿å…æ¥å£ï¼ˆå¦‚æœå¯èƒ½ï¼‰
func printInt(v int) {
    fmt.Println(v)  // ä¸é€ƒé€¸
}
```

---

### é€ƒé€¸åœºæ™¯3: é—­åŒ…æ•è·

```go
// âŒ é€ƒé€¸åˆ°å †
func makeIncrementer() func() int {
    i := 0
    return func() int {
        i++  // ié€ƒé€¸åˆ°å †
        return i
    }
}

// âœ… ä½¿ç”¨å‚æ•°ä¼ é€’
type Counter struct {
    count int
}

func (c *Counter) Increment() int {
    c.count++
    return c.count
}
```

---

### é€ƒé€¸åœºæ™¯4: å¤§å¯¹è±¡

```go
// âŒ å¤§å¯¹è±¡é€ƒé€¸åˆ°å †
func largeArray() {
    var arr [1000000]int  // å¤ªå¤§ï¼Œé€ƒé€¸åˆ°å †
    _ = arr
}

// âœ… ä½¿ç”¨åˆ‡ç‰‡ï¼ˆæŒ‰éœ€åˆ†é…ï¼‰
func largeSlice() {
    arr := make([]int, 0, 1000000)
    _ = arr
}
```

---

## 3. sync.Pool

### åŸºæœ¬ä½¿ç”¨

```go
var bufferPool = sync.Pool{
    New: func() interface{} {
        return new(bytes.Buffer)
    },
}

func processData(data []byte) []byte {
    // ä»æ± ä¸­è·å–
    buf := bufferPool.Get().(*bytes.Buffer)
    defer func() {
        buf.Reset()
        bufferPool.Put(buf)  // æ”¾å›æ± ä¸­
    }()

    buf.Write(data)
    buf.WriteString(" processed")

    return buf.Bytes()
}
```

---

### HTTP Handlerä¸­ä½¿ç”¨

```go
var responsePool = sync.Pool{
    New: func() interface{} {
        return &Response{
            Data: make(map[string]interface{}),
        }
    },
}

func handler(w http.ResponseWriter, r *http.Request) {
    resp := responsePool.Get().(*Response)
    defer responsePool.Put(resp)

    resp.Reset()
    resp.Data["message"] = "Hello"

    json.NewEncoder(w).Encode(resp)
}
```

---

### æ³¨æ„äº‹é¡¹

```go
// âŒ é”™è¯¯ï¼šPoolä¸­çš„å¯¹è±¡ä¼šè¢«GCå›æ”¶
var badPool = sync.Pool{
    New: func() interface{} {
        return &BigObject{}
    },
}

func wrong() {
    obj := badPool.Get().(*BigObject)
    // å¦‚æœGCè¿è¡Œï¼Œå¯¹è±¡å¯èƒ½è¢«å›æ”¶
    // ä¸è¦ä¾èµ–å¯¹è±¡ä¸€ç›´å­˜åœ¨
}

// âœ… æ­£ç¡®ï¼šæ€»æ˜¯Resetåå†Put
func correct() {
    obj := badPool.Get().(*BigObject)
    defer func() {
        obj.Reset()  // æ¸…ç†çŠ¶æ€
        badPool.Put(obj)
    }()

    // ä½¿ç”¨obj
}
```

---

## 4. å‡å°‘å†…å­˜åˆ†é…

### é¢„åˆ†é…åˆ‡ç‰‡

```go
// âŒ ä¸æ¨èï¼šå¤šæ¬¡åˆ†é…
func buildSlice() []int {
    var result []int
    for i := 0; i < 1000; i++ {
        result = append(result, i)  // å¯èƒ½å¤šæ¬¡é‡æ–°åˆ†é…
    }
    return result
}

// âœ… æ¨èï¼šé¢„åˆ†é…å®¹é‡
func buildSlice() []int {
    result := make([]int, 0, 1000)  // é¢„åˆ†é…å®¹é‡
    for i := 0; i < 1000; i++ {
        result = append(result, i)  // ä¸éœ€è¦é‡æ–°åˆ†é…
    }
    return result
}
```

---

### å­—ç¬¦ä¸²æ‹¼æ¥

```go
// âŒ ä¸æ¨èï¼šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆæ¯æ¬¡åˆ†é…æ–°å­—ç¬¦ä¸²ï¼‰
func concat(strs []string) string {
    result := ""
    for _, s := range strs {
        result += s  // æ¯æ¬¡åˆ†é…æ–°å­—ç¬¦ä¸²
    }
    return result
}

// âœ… æ¨èï¼šä½¿ç”¨strings.Builder
func concat(strs []string) string {
    var builder strings.Builder
    for _, s := range strs {
        builder.WriteString(s)
    }
    return builder.String()
}

// âœ… æ›´å¥½ï¼šé¢„åˆ†é…å®¹é‡
func concat(strs []string) string {
    totalLen := 0
    for _, s := range strs {
        totalLen += len(s)
    }

    var builder strings.Builder
    builder.Grow(totalLen)  // é¢„åˆ†é…
    for _, s := range strs {
        builder.WriteString(s)
    }
    return builder.String()
}
```

---

### å¤ç”¨buffer

```go
// âŒ ä¸æ¨èï¼šæ¯æ¬¡åˆ†é…æ–°buffer
func process(items []Item) [][]byte {
    var results [][]byte
    for _, item := range items {
        buf := new(bytes.Buffer)
        buf.WriteString(item.Name)
        results = append(results, buf.Bytes())
    }
    return results
}

// âœ… æ¨èï¼šå¤ç”¨buffer
func process(items []Item) [][]byte {
    var results [][]byte
    buf := new(bytes.Buffer)
    for _, item := range items {
        buf.Reset()  // å¤ç”¨buffer
        buf.WriteString(item.Name)
        // å¤åˆ¶æ•°æ®ï¼ˆå› ä¸ºbufä¼šè¢«Resetï¼‰
        data := make([]byte, buf.Len())
        copy(data, buf.Bytes())
        results = append(results, data)
    }
    return results
}
```

---

### Mapé¢„åˆ†é…

```go
// âŒ ä¸æ¨è
func buildMap() map[string]int {
    m := make(map[string]int)
    for i := 0; i < 1000; i++ {
        m[fmt.Sprintf("key%d", i)] = i
    }
    return m
}

// âœ… æ¨èï¼šé¢„åˆ†é…å®¹é‡
func buildMap() map[string]int {
    m := make(map[string]int, 1000)  // é¢„åˆ†é…
    for i := 0; i < 1000; i++ {
        m[fmt.Sprintf("key%d", i)] = i
    }
    return m
}
```

---

## 5. GCä¼˜åŒ–

### å‡å°‘æŒ‡é’ˆæ•°é‡

```go
// âŒ ä¸æ¨èï¼šå¤§é‡æŒ‡é’ˆ
type SlowStruct struct {
    A *int
    B *string
    C *float64
    // GCéœ€è¦æ‰«ææ‰€æœ‰æŒ‡é’ˆ
}

// âœ… æ¨èï¼šå‡å°‘æŒ‡é’ˆ
type FastStruct struct {
    A int
    B string
    C float64
    // æ²¡æœ‰æŒ‡é’ˆï¼ŒGCæ‰«ææ›´å¿«
}
```

---

### æ§åˆ¶GCé¢‘ç‡

```go
// è®¾ç½®GCè§¦å‘ç™¾åˆ†æ¯”
// GOGC=100 (é»˜è®¤): å †å¤§å°å¢é•¿100%æ—¶è§¦å‘GC
// GOGC=200: å †å¤§å°å¢é•¿200%æ—¶è§¦å‘GCï¼ˆå‡å°‘GCé¢‘ç‡ï¼‰
// GOGC=50: å †å¤§å°å¢é•¿50%æ—¶è§¦å‘GCï¼ˆå¢åŠ GCé¢‘ç‡ï¼‰

// Go 1.19+: è®¾ç½®å†…å­˜é™åˆ¶
// GOMEMLIMIT=4GiB

// ä»£ç ä¸­è®¾ç½®
debug.SetGCPercent(200)  // å‡å°‘GCé¢‘ç‡
```

---

### æ‰¹é‡åˆ†é…

```go
// âŒ ä¸æ¨èï¼šé€ä¸ªåˆ†é…
func allocateMany() []*Object {
    var objects []*Object
    for i := 0; i < 1000; i++ {
        objects = append(objects, &Object{ID: i})
    }
    return objects
}

// âœ… æ¨èï¼šæ‰¹é‡åˆ†é…
func allocateMany() []*Object {
    // åˆ†é…è¿ç»­å†…å­˜
    objects := make([]Object, 1000)
    ptrs := make([]*Object, 1000)

    for i := range objects {
        objects[i].ID = i
        ptrs[i] = &objects[i]
    }

    return ptrs
}
```

---

## 6. æœ€ä½³å®è·µ

### 1. ä½¿ç”¨åŸºå‡†æµ‹è¯•

```go
func BenchmarkConcat(b *testing.B) {
    strs := []string{"hello", "world", "foo", "bar"}

    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _ = concat(strs)
    }
}

// è¿è¡Œ
// go test -bench=. -benchmem
```

---

### 2. åˆ†æå†…å­˜ä½¿ç”¨

```bash
# CPUå’Œå†…å­˜profile
go test -cpuprofile=cpu.prof -memprofile=mem.prof -bench=.

# æŸ¥çœ‹å†…å­˜åˆ†é…
go tool pprof -alloc_space mem.prof
go tool pprof -alloc_objects mem.prof

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
go tool pprof -inuse_space mem.prof
go tool pprof -inuse_objects mem.prof
```

---

### 3. é¿å…ä¸å¿…è¦çš„æ‹·è´

```go
// âŒ ä¸æ¨èï¼šæ‹·è´å¤§ç»“æ„ä½“
func process(data LargeStruct) {
    // dataæ˜¯æ‹·è´
}

// âœ… æ¨èï¼šä½¿ç”¨æŒ‡é’ˆ
func process(data *LargeStruct) {
    // åªä¼ é€’æŒ‡é’ˆ
}
```

---

### 4. ä½¿ç”¨[]byteè€Œä¸æ˜¯string

```go
// âŒ ä¸æ¨èï¼šstringæ‹¼æ¥
func buildJSON(data map[string]string) string {
    result := "{"
    for k, v := range data {
        result += fmt.Sprintf(`"%s":"%s",`, k, v)
    }
    result += "}"
    return result
}

// âœ… æ¨èï¼šä½¿ç”¨[]byteæˆ–bytes.Buffer
func buildJSON(data map[string]string) []byte {
    var buf bytes.Buffer
    buf.WriteString("{")
    for k, v := range data {
        fmt.Fprintf(&buf, `"%s":"%s",`, k, v)
    }
    buf.WriteString("}")
    return buf.Bytes()
}
```

---

### 5. åŠæ—¶é‡Šæ”¾èµ„æº

```go
// âœ… æ¨èï¼šåŠæ—¶ç½®nil
func process() {
    largeData := make([]byte, 10*1024*1024)

    // ä½¿ç”¨largeData
    doSomething(largeData)

    // åŠæ—¶é‡Šæ”¾
    largeData = nil

    // ç»§ç»­å…¶ä»–æ“ä½œ
    doOtherThings()
}
```

---

## ğŸ¯ æ€§èƒ½å¯¹æ¯”

### å­—ç¬¦ä¸²æ‹¼æ¥

```go
// åŸºå‡†æµ‹è¯•ç»“æœ
BenchmarkStringConcat-8         1000000    1200 ns/op    512 B/op    10 allocs/op
BenchmarkStringBuilder-8       10000000     120 ns/op     64 B/op     1 allocs/op
BenchmarkStringBuilderGrow-8   20000000      60 ns/op     64 B/op     1 allocs/op
```

### sync.Pool

```go
// åŸºå‡†æµ‹è¯•ç»“æœ
BenchmarkWithoutPool-8    1000000    1500 ns/op    1024 B/op    1 allocs/op
BenchmarkWithPool-8      10000000     150 ns/op       0 B/op    0 allocs/op
```

---

---

## ğŸ’¼ å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: HTTPæœåŠ¡å†…å­˜ä¼˜åŒ–

**é—®é¢˜**: HTTPæœåŠ¡å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆOOM

```go
// âŒ é—®é¢˜ä»£ç 
type Server struct {
    cache map[string][]byte  // æ— é™å¢é•¿
}

func (s *Server) HandleRequest(w http.ResponseWriter, r *http.Request) {
    data, err := io.ReadAll(r.Body)  // ä¸é™åˆ¶å¤§å°
    if err != nil {
        http.Error(w, err.Error(), 500)
        return
    }

    // ç¼“å­˜æ‰€æœ‰æ•°æ®
    s.cache[r.URL.Path] = data

    // æ‹¼æ¥å­—ç¬¦ä¸²
    var response string
    for i := 0; i < 1000; i++ {
        response += fmt.Sprintf("Line %d\n", i)  // æ¯æ¬¡åˆ†é…æ–°å­—ç¬¦ä¸²
    }

    w.Write([]byte(response))
}
```

**ä¼˜åŒ–å**:

```go
// âœ… ä¼˜åŒ–ä»£ç 
type Server struct {
    cache    *lru.Cache  // ä½¿ç”¨LRUç¼“å­˜é™åˆ¶å¤§å°
    bufPool  *sync.Pool  // å¤ç”¨buffer
}

func NewServer() *Server {
    cache, _ := lru.New(1000)  // é™åˆ¶1000ä¸ªæ¡ç›®

    return &Server{
        cache: cache,
        bufPool: &sync.Pool{
            New: func() interface{} {
                return new(bytes.Buffer)
            },
        },
    }
}

func (s *Server) HandleRequest(w http.ResponseWriter, r *http.Request) {
    // é™åˆ¶è¯·æ±‚ä½“å¤§å°
    r.Body = http.MaxBytesReader(w, r.Body, 1<<20)  // 1MB

    data, err := io.ReadAll(r.Body)
    if err != nil {
        http.Error(w, err.Error(), 500)
        return
    }

    // ä½¿ç”¨LRUç¼“å­˜
    s.cache.Add(r.URL.Path, data)

    // ä»Poolè·å–buffer
    buf := s.bufPool.Get().(*bytes.Buffer)
    buf.Reset()
    defer s.bufPool.Put(buf)

    // é¢„åˆ†é…å®¹é‡
    buf.Grow(1000 * 10)

    // ä½¿ç”¨WriteSt ringé¿å…é¢å¤–åˆ†é…
    for i := 0; i < 1000; i++ {
        fmt.Fprintf(buf, "Line %d\n", i)
    }

    w.Write(buf.Bytes())
}
```

**ä¼˜åŒ–æ•ˆæœ**:

- å†…å­˜ä½¿ç”¨: ä»2GB â†’ 200MB (10xå‡å°‘)
- å†…å­˜åˆ†é…: ä»5000æ¬¡/è¯·æ±‚ â†’ 50æ¬¡/è¯·æ±‚
- GCæš‚åœ: ä»100ms â†’ 10ms

---

### æ¡ˆä¾‹2: æ•°æ®æ‰¹å¤„ç†ä¼˜åŒ–

**é—®é¢˜**: å¤„ç†å¤§æ–‡ä»¶æ—¶å†…å­˜å ç”¨è¿‡é«˜

```go
// âŒ é—®é¢˜ä»£ç ï¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®
func ProcessLargeFile(filename string) error {
    data, err := os.ReadFile(filename)  // å¯èƒ½å‡ GB
    if err != nil {
        return err
    }

    lines := strings.Split(string(data), "\n")  // åˆä¸€æ¬¡å¤åˆ¶

    results := make([]Result, 0)
    for _, line := range lines {
        result := processLine(line)
        results = append(results, result)  // é¢‘ç¹æ‰©å®¹
    }

    return saveResults(results)
}
```

**ä¼˜åŒ–å**:

```go
// âœ… ä¼˜åŒ–ä»£ç ï¼šæµå¼å¤„ç†
func ProcessLargeFile(filename string) error {
    file, err := os.Open(filename)
    if err != nil {
        return err
    }
    defer file.Close()

    // ä½¿ç”¨bufioå‡å°‘ç³»ç»Ÿè°ƒç”¨
    scanner := bufio.NewScanner(file)

    // è®¾ç½®æ›´å¤§çš„bufferï¼ˆé»˜è®¤4KBå¯èƒ½å¤ªå°ï¼‰
    buf := make([]byte, 1024*1024)  // 1MB
    scanner.Buffer(buf, 10*1024*1024)  // æœ€å¤§10MB

    // é¢„åˆ†é…ç»“æœåˆ‡ç‰‡
    results := make([]Result, 0, 10000)

    // æ‰¹é‡å¤„ç†
    batchSize := 1000
    batch := make([]string, 0, batchSize)

    for scanner.Scan() {
        batch = append(batch, scanner.Text())

        if len(batch) >= batchSize {
            // å¤„ç†æ‰¹æ¬¡
            for _, line := range batch {
                results = append(results, processLine(line))
            }

            // é‡ç½®batchï¼ˆå¤ç”¨åº•å±‚æ•°ç»„ï¼‰
            batch = batch[:0]

            // å®šæœŸä¿å­˜ç»“æœå¹¶æ¸…ç©º
            if len(results) >= 10000 {
                if err := saveResults(results); err != nil {
                    return err
                }
                results = results[:0]
            }
        }
    }

    // å¤„ç†å‰©ä½™æ•°æ®
    for _, line := range batch {
        results = append(results, processLine(line))
    }

    return saveResults(results)
}
```

**ä¼˜åŒ–æ•ˆæœ**:

- å†…å­˜ä½¿ç”¨: ä»4GB â†’ 100MB (40xå‡å°‘)
- å¤„ç†é€Ÿåº¦: æå‡30%
- å¯å¤„ç†æ–‡ä»¶å¤§å°: ä»1GB â†’ æ— é™åˆ¶

---

### æ¡ˆä¾‹3: å¯¹è±¡æ± åœ¨gRPCä¸­çš„åº”ç”¨

**é—®é¢˜**: gRPCæœåŠ¡é«˜å¹¶å‘ä¸‹é¢‘ç¹GC

```go
// âŒ é—®é¢˜ä»£ç 
func (s *UserService) GetUser(ctx context.Context, req *pb.GetUserRequest) (*pb.User, error) {
    // æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºæ–°å¯¹è±¡
    user := &pb.User{
        Id:       req.Id,
        Name:     "",
        Email:    "",
        Profile:  &pb.Profile{},  // åµŒå¥—å¯¹è±¡
        Settings: &pb.Settings{},
    }

    // ä»æ•°æ®åº“æŸ¥è¯¢
    dbUser, err := s.db.FindUser(req.Id)
    if err != nil {
        return nil, err
    }

    // å¤åˆ¶æ•°æ®
    user.Name = dbUser.Name
    user.Email = dbUser.Email
    // ...

    return user, nil
}
```

**ä¼˜åŒ–å**:

```go
// âœ… ä¼˜åŒ–ä»£ç ï¼šä½¿ç”¨å¯¹è±¡æ± 
var userPool = sync.Pool{
    New: func() interface{} {
        return &pb.User{
            Profile:  &pb.Profile{},
            Settings: &pb.Settings{},
        }
    },
}

func (s *UserService) GetUser(ctx context.Context, req *pb.GetUserRequest) (*pb.User, error) {
    // ä»æ± ä¸­è·å–å¯¹è±¡
    user := userPool.Get().(*pb.User)

    // é‡ç½®å¯¹è±¡çŠ¶æ€
    user.Reset()
    user.Id = req.Id

    // ä»æ•°æ®åº“æŸ¥è¯¢
    dbUser, err := s.db.FindUser(req.Id)
    if err != nil {
        userPool.Put(user)  // å½’è¿˜åˆ°æ± 
        return nil, err
    }

    // å¡«å……æ•°æ®
    user.Name = dbUser.Name
    user.Email = dbUser.Email
    // ...

    // æ³¨æ„ï¼šè¿”å›åä¸èƒ½Putå›æ± ï¼Œç”±è°ƒç”¨è€…è´Ÿè´£
    return user, nil
}

// åœ¨æ‹¦æˆªå™¨ä¸­å½’è¿˜å¯¹è±¡
func PoolInterceptor() grpc.UnaryServerInterceptor {
    return func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {
        resp, err := handler(ctx, req)

        // å“åº”å‘é€åå½’è¿˜å¯¹è±¡
        if user, ok := resp.(*pb.User); ok {
            defer userPool.Put(user)
        }

        return resp, err
    }
}
```

**ä¼˜åŒ–æ•ˆæœ**:

- GCé¢‘ç‡: ä»æ¯ç§’10æ¬¡ â†’ æ¯ç§’1æ¬¡
- P99å»¶è¿Ÿ: ä»50ms â†’ 20ms (60%å‡å°‘)
- å†…å­˜åˆ†é…: å‡å°‘70%

---

### æ¡ˆä¾‹4: JSONç¼–ç ä¼˜åŒ–

**é—®é¢˜**: APIå“åº”ç”Ÿæˆå ç”¨å¤§é‡å†…å­˜

```go
// âŒ é—®é¢˜ä»£ç 
func (h *Handler) ListUsers(w http.ResponseWriter, r *http.Request) {
    users, _ := h.db.GetAllUsers()

    // æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„encoder
    data, err := json.Marshal(users)
    if err != nil {
        http.Error(w, err.Error(), 500)
        return
    }

    w.Write(data)
}
```

**ä¼˜åŒ–å**:

```go
// âœ… ä¼˜åŒ–ä»£ç 
type Handler struct {
    db          *DB
    encoderPool *sync.Pool
}

func NewHandler(db *DB) *Handler {
    return &Handler{
        db: db,
        encoderPool: &sync.Pool{
            New: func() interface{} {
                return json.NewEncoder(nil)
            },
        },
    }
}

func (h *Handler) ListUsers(w http.ResponseWriter, r *http.Request) {
    users, _ := h.db.GetAllUsers()

    // ä»æ± ä¸­è·å–encoder
    encoder := h.encoderPool.Get().(*json.Encoder)
    defer h.encoderPool.Put(encoder)

    // é‡ç½®encoderçš„writer
    encoder.Reset(w)

    // ç›´æ¥ç¼–ç åˆ°ResponseWriterï¼Œé¿å…ä¸­é—´buffer
    w.Header().Set("Content-Type", "application/json")
    if err := encoder.Encode(users); err != nil {
        http.Error(w, err.Error(), 500)
        return
    }
}
```

**ä¼˜åŒ–æ•ˆæœ**:

- å†…å­˜åˆ†é…: å‡å°‘50%
- å“åº”æ—¶é—´: æå‡20%
- GCå‹åŠ›: æ˜¾è‘—é™ä½

---

### æ¡ˆä¾‹5: å­—ç¬¦ä¸²æ‹¼æ¥ä¼˜åŒ–

**é—®é¢˜**: æ—¥å¿—èšåˆæœåŠ¡å†…å­˜æš´æ¶¨

```go
// âŒ é—®é¢˜ä»£ç 
func AggregateLog(logs []LogEntry) string {
    var result string
    for _, log := range logs {
        result += fmt.Sprintf("[%s] %s: %s\n",
            log.Time, log.Level, log.Message)  // æ¯æ¬¡åˆ†é…æ–°å­—ç¬¦ä¸²
    }
    return result
}
```

**ä¼˜åŒ–å**:

```go
// âœ… ä¼˜åŒ–ä»£ç 
func AggregateLog(logs []LogEntry) string {
    // é¢„ä¼°æ€»é•¿åº¦
    totalLen := 0
    for _, log := range logs {
        totalLen += len(log.Time) + len(log.Level) + len(log.Message) + 10
    }

    // é¢„åˆ†é…è¶³å¤Ÿå®¹é‡
    var builder strings.Builder
    builder.Grow(totalLen)

    for _, log := range logs {
        builder.WriteByte('[')
        builder.WriteString(log.Time)
        builder.WriteString("] ")
        builder.WriteString(log.Level)
        builder.WriteString(": ")
        builder.WriteString(log.Message)
        builder.WriteByte('\n')
    }

    return builder.String()
}

// åŸºå‡†æµ‹è¯•å¯¹æ¯”
// BenchmarkBadAggregateLog-8      1000    1500000 ns/op    2000000 B/op    10000 allocs/op
// BenchmarkGoodAggregateLog-8     5000     300000 ns/op     500000 B/op        1 allocs/op
```

**ä¼˜åŒ–æ•ˆæœ**:

- é€Ÿåº¦: æå‡5x
- å†…å­˜åˆ†é…: å‡å°‘4x
- åˆ†é…æ¬¡æ•°: ä»10000æ¬¡ â†’ 1æ¬¡

---

## ğŸ”— ç›¸å…³èµ„æº

- [æ€§èƒ½åˆ†æå·¥å…·](./01-æ€§èƒ½åˆ†æå·¥å…·.md)
- [GCè°ƒä¼˜](./05-GCè°ƒä¼˜.md)
- [å¹¶å‘ä¼˜åŒ–](./03-å¹¶å‘ä¼˜åŒ–.md)

---

**æœ€åæ›´æ–°**: 2025-10-29
**Goç‰ˆæœ¬**: 1.25.3
**æ–°å¢**: 5ä¸ªç”Ÿäº§çº§å®æˆ˜æ¡ˆä¾‹ âœ¨
