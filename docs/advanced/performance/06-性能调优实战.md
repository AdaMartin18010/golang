# æ€§èƒ½è°ƒä¼˜å®æˆ˜

## ğŸ“‹ ç›®å½•

- [æ€§èƒ½è°ƒä¼˜å®æˆ˜](#æ€§èƒ½è°ƒä¼˜å®æˆ˜)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. è°ƒä¼˜æ–¹æ³•è®º](#1-è°ƒä¼˜æ–¹æ³•è®º)
    - [æ€§èƒ½è°ƒä¼˜æµç¨‹](#æ€§èƒ½è°ƒä¼˜æµç¨‹)
    - [å»ºç«‹æ€§èƒ½åŸºå‡†](#å»ºç«‹æ€§èƒ½åŸºå‡†)
  - [2. è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ](#2-è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ)
    - [ä½¿ç”¨pprofåˆ†æ](#ä½¿ç”¨pprofåˆ†æ)
  - [3. CPUä¼˜åŒ–å®æˆ˜](#3-cpuä¼˜åŒ–å®æˆ˜)
    - [æ¡ˆä¾‹1: çƒ­ç‚¹å‡½æ•°ä¼˜åŒ–](#æ¡ˆä¾‹1-çƒ­ç‚¹å‡½æ•°ä¼˜åŒ–)
    - [æ¡ˆä¾‹2: é¿å…ä¸å¿…è¦çš„è®¡ç®—](#æ¡ˆä¾‹2-é¿å…ä¸å¿…è¦çš„è®¡ç®—)
  - [4. å†…å­˜ä¼˜åŒ–å®æˆ˜](#4-å†…å­˜ä¼˜åŒ–å®æˆ˜)
    - [æ¡ˆä¾‹1: å†…å­˜æ³„æ¼æ’æŸ¥](#æ¡ˆä¾‹1-å†…å­˜æ³„æ¼æ’æŸ¥)
    - [æ¡ˆä¾‹2: Goroutineæ³„æ¼](#æ¡ˆä¾‹2-goroutineæ³„æ¼)
  - [5. I/Oä¼˜åŒ–å®æˆ˜](#5-ioä¼˜åŒ–å®æˆ˜)
    - [æ¡ˆä¾‹1: æ–‡ä»¶I/Oä¼˜åŒ–](#æ¡ˆä¾‹1-æ–‡ä»¶ioä¼˜åŒ–)
    - [æ¡ˆä¾‹2: ç½‘ç»œI/Oä¼˜åŒ–](#æ¡ˆä¾‹2-ç½‘ç»œioä¼˜åŒ–)
  - [6. å¹¶å‘ä¼˜åŒ–å®æˆ˜](#6-å¹¶å‘ä¼˜åŒ–å®æˆ˜)
    - [æ¡ˆä¾‹: å›¾ç‰‡æ‰¹å¤„ç†æœåŠ¡](#æ¡ˆä¾‹-å›¾ç‰‡æ‰¹å¤„ç†æœåŠ¡)
  - [7. æ•°æ®åº“ä¼˜åŒ–å®æˆ˜](#7-æ•°æ®åº“ä¼˜åŒ–å®æˆ˜)
    - [æ¡ˆä¾‹: è®¢å•æŸ¥è¯¢ä¼˜åŒ–](#æ¡ˆä¾‹-è®¢å•æŸ¥è¯¢ä¼˜åŒ–)
  - [8. ç½‘ç»œä¼˜åŒ–å®æˆ˜](#8-ç½‘ç»œä¼˜åŒ–å®æˆ˜)
    - [HTTPæœåŠ¡å™¨ä¼˜åŒ–](#httpæœåŠ¡å™¨ä¼˜åŒ–)
  - [9. å®Œæ•´ä¼˜åŒ–æ¡ˆä¾‹](#9-å®Œæ•´ä¼˜åŒ–æ¡ˆä¾‹)
    - [APIæœåŠ¡ç«¯åˆ°ç«¯ä¼˜åŒ–](#apiæœåŠ¡ç«¯åˆ°ç«¯ä¼˜åŒ–)
      - [ç¬¬1è½®: CPUä¼˜åŒ–](#ç¬¬1è½®-cpuä¼˜åŒ–)
      - [ç¬¬2è½®: å†…å­˜ä¼˜åŒ–](#ç¬¬2è½®-å†…å­˜ä¼˜åŒ–)
      - [ç¬¬3è½®: æ•°æ®åº“ä¼˜åŒ–](#ç¬¬3è½®-æ•°æ®åº“ä¼˜åŒ–)
      - [ç¬¬4è½®: å¹¶å‘ä¼˜åŒ–](#ç¬¬4è½®-å¹¶å‘ä¼˜åŒ–)
  - [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

## 1. è°ƒä¼˜æ–¹æ³•è®º

### æ€§èƒ½è°ƒä¼˜æµç¨‹

```
1. å»ºç«‹åŸºå‡† (Baseline)
   â†“
2. æ€§èƒ½åˆ†æ (Profile)
   â†“
3. è¯†åˆ«ç“¶é¢ˆ (Identify Bottleneck)
   â†“
4. ä¼˜åŒ–å®æ–½ (Optimize)
   â†“
5. éªŒè¯æ•ˆæœ (Validate)
   â†“
6. é‡å¤ 2-5 (Iterate)
```

**æ ¸å¿ƒåŸåˆ™**:

- âœ… å…ˆæµ‹é‡ï¼Œå†ä¼˜åŒ–
- âœ… å…³æ³¨ä¸»è¦ç“¶é¢ˆï¼ˆ80/20æ³•åˆ™ï¼‰
- âœ… ä¸€æ¬¡ä¼˜åŒ–ä¸€ä¸ªç‚¹
- âœ… æ¯æ¬¡ä¼˜åŒ–åéªŒè¯

---

### å»ºç«‹æ€§èƒ½åŸºå‡†

```go
// benchmark_test.go
package main

import (
    "testing"
)

func BenchmarkOriginal(b *testing.B) {
    for i := 0; i < b.N; i++ {
        processRequest()
    }
}

// è¿è¡ŒåŸºå‡†æµ‹è¯•
// go test -bench=. -benchmem -cpuprofile=cpu.prof -memprofile=mem.prof
```

**å…³é”®æŒ‡æ ‡**:

- **å“åº”æ—¶é—´**: P50, P95, P99å»¶è¿Ÿ
- **ååé‡**: QPS/TPS
- **èµ„æºä½¿ç”¨**: CPU%, Memory, I/O
- **é”™è¯¯ç‡**: Error rate

---

## 2. è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

### ä½¿ç”¨pprofåˆ†æ

```go
import (
    _ "net/http/pprof"
    "net/http"
)

func main() {
    // å¯åŠ¨pprofæœåŠ¡å™¨
    go func() {
        http.ListenAndServe("localhost:6060", nil)
    }()

    // åº”ç”¨ä¸»é€»è¾‘
    runApp()
}
```

**åˆ†æCPUçƒ­ç‚¹**:

```bash
# é‡‡é›†30ç§’CPU profile
curl http://localhost:6060/debug/pprof/profile?seconds=30 > cpu.prof

# æŸ¥çœ‹ç«ç„°å›¾
go tool pprof -http=:8080 cpu.prof

# æŸ¥çœ‹topå‡½æ•°
go tool pprof cpu.prof
> top 20
```

**åˆ†æå†…å­˜åˆ†é…**:

```bash
# é‡‡é›†å †å¿«ç…§
curl http://localhost:6060/debug/pprof/heap > heap.prof

# åˆ†æå†…å­˜åˆ†é…
go tool pprof heap.prof
> top 20 -alloc_space
```

---

## 3. CPUä¼˜åŒ–å®æˆ˜

### æ¡ˆä¾‹1: çƒ­ç‚¹å‡½æ•°ä¼˜åŒ–

**é—®é¢˜**: CPUå ç”¨é«˜ï¼Œä¸»è¦åœ¨å­—ç¬¦ä¸²å¤„ç†

```go
// âŒ ä¼˜åŒ–å‰ - CPU: 80%
func processLogs(logs []string) []string {
    var results []string
    for _, log := range logs {
        // å¤šæ¬¡å­—ç¬¦ä¸²æ‹¼æ¥
        result := "[" + time.Now().Format("2006-01-02") + "] " +
                  strings.ToUpper(log) + " - processed"
        results = append(results, result)
    }
    return results
}

// åŸºå‡†æµ‹è¯•ç»“æœ:
// BenchmarkProcessLogs-8    10000    120000 ns/op    50000 B/op    1500 allocs/op
```

**ä¼˜åŒ–æ­¥éª¤**:

1. **ä½¿ç”¨pprofæ‰¾åˆ°çƒ­ç‚¹**:

```bash
go tool pprof cpu.prof
> top 10
# è¾“å‡ºæ˜¾ç¤º: strings.ToUpper å ç”¨ 35%
#           time.Now().Format å ç”¨ 25%
#           string concatenation å ç”¨ 20%
```

2. **å®æ–½ä¼˜åŒ–**:

```go
// âœ… ä¼˜åŒ–å - CPU: 25%
func processLogsOptimized(logs []string) []string {
    // é¢„åˆ†é…åˆ‡ç‰‡
    results := make([]string, 0, len(logs))

    // é¢„æ ¼å¼åŒ–æ—¥æœŸï¼ˆé¿å…é‡å¤è°ƒç”¨ï¼‰
    dateStr := time.Now().Format("2006-01-02")

    // ä½¿ç”¨strings.Builderå‡å°‘åˆ†é…
    var builder strings.Builder

    for _, log := range logs {
        builder.Reset()
        builder.Grow(len(log) + len(dateStr) + 20)

        builder.WriteByte('[')
        builder.WriteString(dateStr)
        builder.WriteString("] ")
        builder.WriteString(strings.ToUpper(log))
        builder.WriteString(" - processed")

        results = append(results, builder.String())
    }

    return results
}

// ä¼˜åŒ–ååŸºå‡†æµ‹è¯•:
// BenchmarkProcessLogsOptimized-8    50000    25000 ns/op    10000 B/op    100 allocs/op
```

**ä¼˜åŒ–æ•ˆæœ**:

- CPUä½¿ç”¨: 80% â†’ 25% (3.2xæ”¹å–„)
- æ‰§è¡Œæ—¶é—´: 120Î¼s â†’ 25Î¼s (4.8xæå‡)
- å†…å­˜åˆ†é…: 50KB â†’ 10KB (5xå‡å°‘)
- åˆ†é…æ¬¡æ•°: 1500 â†’ 100 (15xå‡å°‘)

---

### æ¡ˆä¾‹2: é¿å…ä¸å¿…è¦çš„è®¡ç®—

```go
// âŒ ä¼˜åŒ–å‰
func calculateDiscount(orders []Order) float64 {
    var total float64
    for _, order := range orders {
        // æ¯æ¬¡å¾ªç¯éƒ½é‡æ–°è®¡ç®—
        if time.Now().Month() == 12 {
            total += order.Amount * 0.9
        } else {
            total += order.Amount
        }
    }
    return total
}

// âœ… ä¼˜åŒ–å
func calculateDiscountOptimized(orders []Order) float64 {
    // æå‰è®¡ç®—æ¡ä»¶
    isDecember := time.Now().Month() == 12
    var total float64

    if isDecember {
        for _, order := range orders {
            total += order.Amount * 0.9
        }
    } else {
        for _, order := range orders {
            total += order.Amount
        }
    }

    return total
}
```

---

## 4. å†…å­˜ä¼˜åŒ–å®æˆ˜

### æ¡ˆä¾‹1: å†…å­˜æ³„æ¼æ’æŸ¥

**é—®é¢˜**: æœåŠ¡è¿è¡Œä¸€æ®µæ—¶é—´åå†…å­˜æŒç»­å¢é•¿

```go
// âŒ é—®é¢˜ä»£ç  - å†…å­˜æ³„æ¼
type Cache struct {
    data map[string][]byte
    mu   sync.RWMutex
}

func (c *Cache) Set(key string, value []byte) {
    c.mu.Lock()
    defer c.mu.Unlock()
    c.data[key] = value  // æ— é™å¢é•¿
}
```

**æ’æŸ¥æ­¥éª¤**:

1. **å¯¹æ¯”ä¸¤ä¸ªæ—¶é—´ç‚¹çš„å †å¿«ç…§**:

```bash
# é‡‡é›†ç¬¬ä¸€ä¸ªå¿«ç…§
curl http://localhost:6060/debug/pprof/heap > heap1.prof

# ç­‰å¾…10åˆ†é’Ÿ
sleep 600

# é‡‡é›†ç¬¬äºŒä¸ªå¿«ç…§
curl http://localhost:6060/debug/pprof/heap > heap2.prof

# å¯¹æ¯”å·®å¼‚
go tool pprof -base=heap1.prof heap2.prof
> top 20
```

2. **å‘ç°é—®é¢˜**: `Cache.data` mapæŒç»­å¢é•¿

3. **ä¿®å¤**:

```go
// âœ… ä¿®å¤å - ä½¿ç”¨LRUç¼“å­˜
import "github.com/hashicorp/golang-lru"

type Cache struct {
    data *lru.Cache
    mu   sync.RWMutex
}

func NewCache(size int) *Cache {
    cache, _ := lru.New(size)
    return &Cache{
        data: cache,
    }
}

func (c *Cache) Set(key string, value []byte) {
    c.mu.Lock()
    defer c.mu.Unlock()
    c.data.Add(key, value)  // è‡ªåŠ¨æ·˜æ±°æ—§æ•°æ®
}
```

**ä¿®å¤æ•ˆæœ**:

- å†…å­˜ä½¿ç”¨: æŒç»­å¢é•¿ â†’ ç¨³å®šåœ¨500MB
- OOMå´©æºƒ: æ¯å¤©1æ¬¡ â†’ 0æ¬¡

---

### æ¡ˆä¾‹2: Goroutineæ³„æ¼

**é—®é¢˜**: Goroutineæ•°é‡æŒç»­å¢é•¿

```go
// âŒ é—®é¢˜ä»£ç 
func handleRequest(req Request) {
    go func() {
        // æ²¡æœ‰é€€å‡ºæœºåˆ¶
        for {
            data := fetchData()
            process(data)
            time.Sleep(time.Second)
        }
    }()
}
```

**æ’æŸ¥**:

```bash
curl http://localhost:6060/debug/pprof/goroutine?debug=1 > goroutines.txt
# æŸ¥çœ‹goroutineæ•°é‡å’Œå †æ ˆ
```

**ä¿®å¤**:

```go
// âœ… ä¿®å¤å
func handleRequest(ctx context.Context, req Request) {
    go func() {
        ticker := time.NewTicker(time.Second)
        defer ticker.Stop()

        for {
            select {
            case <-ctx.Done():
                return  // æ­£å¸¸é€€å‡º
            case <-ticker.C:
                data := fetchData()
                process(data)
            }
        }
    }()
}
```

---

## 5. I/Oä¼˜åŒ–å®æˆ˜

### æ¡ˆä¾‹1: æ–‡ä»¶I/Oä¼˜åŒ–

```go
// âŒ ä¼˜åŒ–å‰ - é€è¡Œå†™å…¥
func writeLogsUnoptimized(logs []string) error {
    file, _ := os.OpenFile("logs.txt", os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0644)
    defer file.Close()

    for _, log := range logs {
        file.WriteString(log + "\n")  // æ¯æ¬¡éƒ½è§¦å‘ç³»ç»Ÿè°ƒç”¨
    }

    return nil
}

// BenchmarkWriteLogsUnoptimized-8    100    12000000 ns/op

// âœ… ä¼˜åŒ–å - ä½¿ç”¨ç¼“å†²
func writeLogsOptimized(logs []string) error {
    file, _ := os.OpenFile("logs.txt", os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0644)
    defer file.Close()

    // ä½¿ç”¨å¸¦ç¼“å†²çš„writer
    writer := bufio.NewWriterSize(file, 64*1024)  // 64KB buffer
    defer writer.Flush()

    for _, log := range logs {
        writer.WriteString(log)
        writer.WriteByte('\n')
    }

    return nil
}

// BenchmarkWriteLogsOptimized-8    5000    250000 ns/op
```

**ä¼˜åŒ–æ•ˆæœ**: 48xæ€§èƒ½æå‡

---

### æ¡ˆä¾‹2: ç½‘ç»œI/Oä¼˜åŒ–

```go
// âŒ ä¼˜åŒ–å‰ - ä¸²è¡ŒHTTPè¯·æ±‚
func fetchDataUnoptimized(urls []string) ([][]byte, error) {
    var results [][]byte

    for _, url := range urls {
        resp, err := http.Get(url)
        if err != nil {
            return nil, err
        }
        defer resp.Body.Close()

        data, _ := io.ReadAll(resp.Body)
        results = append(results, data)
    }

    return results, nil
}

// è€—æ—¶: 10ä¸ªURL = 5ç§’

// âœ… ä¼˜åŒ–å - å¹¶å‘è¯·æ±‚
func fetchDataOptimized(urls []string) ([][]byte, error) {
    results := make([][]byte, len(urls))
    var wg sync.WaitGroup
    var mu sync.Mutex

    // ä½¿ç”¨worker poolé™åˆ¶å¹¶å‘
    semaphore := make(chan struct{}, 10)

    for i, url := range urls {
        wg.Add(1)
        go func(index int, u string) {
            defer wg.Done()

            semaphore <- struct{}{}
            defer func() { <-semaphore }()

            resp, err := http.Get(u)
            if err != nil {
                return
            }
            defer resp.Body.Close()

            data, _ := io.ReadAll(resp.Body)

            mu.Lock()
            results[index] = data
            mu.Unlock()
        }(i, url)
    }

    wg.Wait()
    return results, nil
}

// è€—æ—¶: 10ä¸ªURL = 0.5ç§’
```

**ä¼˜åŒ–æ•ˆæœ**: 10xæ€§èƒ½æå‡

---

## 6. å¹¶å‘ä¼˜åŒ–å®æˆ˜

### æ¡ˆä¾‹: å›¾ç‰‡æ‰¹å¤„ç†æœåŠ¡

**åˆå§‹ç‰ˆæœ¬** - ä¸²è¡Œå¤„ç†:

```go
// âŒ V1: ä¸²è¡Œå¤„ç†
func processImages(images []Image) []ProcessedImage {
    results := make([]ProcessedImage, len(images))

    for i, img := range images {
        results[i] = processImage(img)
    }

    return results
}

// æ€§èƒ½: 100å¼ å›¾ç‰‡ = 100ç§’
// CPUä½¿ç”¨: 12% (å•æ ¸)
```

**ä¼˜åŒ–V2** - åŸºæœ¬å¹¶å‘:

```go
// âš ï¸ V2: æ— é™å¹¶å‘
func processImagesV2(images []Image) []ProcessedImage {
    results := make([]ProcessedImage, len(images))
    var wg sync.WaitGroup

    for i, img := range images {
        wg.Add(1)
        go func(index int, image Image) {
            defer wg.Done()
            results[index] = processImage(image)
        }(i, img)
    }

    wg.Wait()
    return results
}

// æ€§èƒ½: 100å¼ å›¾ç‰‡ = 15ç§’
// CPUä½¿ç”¨: 95%
// é—®é¢˜: åˆ›å»º100ä¸ªgoroutineï¼Œå†…å­˜å ç”¨é«˜
```

**ä¼˜åŒ–V3** - Worker Pool:

```go
// âœ… V3: Worker Pool
func processImagesV3(images []Image) []ProcessedImage {
    numWorkers := runtime.NumCPU()
    jobs := make(chan Job, len(images))
    results := make([]ProcessedImage, len(images))
    var wg sync.WaitGroup

    // å¯åŠ¨workers
    for w := 0; w < numWorkers; w++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            for job := range jobs {
                results[job.Index] = processImage(job.Image)
            }
        }()
    }

    // å‘é€ä»»åŠ¡
    for i, img := range images {
        jobs <- Job{Index: i, Image: img}
    }
    close(jobs)

    wg.Wait()
    return results
}

// æ€§èƒ½: 100å¼ å›¾ç‰‡ = 13ç§’
// CPUä½¿ç”¨: 95%
// Goroutine: 8ä¸ª (ç¨³å®š)
```

**æœ€ç»ˆä¼˜åŒ–V4** - æ‰¹å¤„ç† + å¯¹è±¡æ± :

```go
// âœ… V4: æ‰¹å¤„ç† + å¯¹è±¡æ± 
var processorPool = sync.Pool{
    New: func() interface{} {
        return &ImageProcessor{}
    },
}

func processImagesV4(images []Image) []ProcessedImage {
    numWorkers := runtime.NumCPU()
    batchSize := 10
    results := make([]ProcessedImage, len(images))
    var wg sync.WaitGroup

    jobs := make(chan []Job, (len(images)+batchSize-1)/batchSize)

    // Workers
    for w := 0; w < numWorkers; w++ {
        wg.Add(1)
        go func() {
            defer wg.Done()

            // ä»æ± ä¸­è·å–processor
            processor := processorPool.Get().(*ImageProcessor)
            defer processorPool.Put(processor)

            for batch := range jobs {
                for _, job := range batch {
                    results[job.Index] = processor.Process(job.Image)
                }
            }
        }()
    }

    // æ‰¹é‡å‘é€ä»»åŠ¡
    for i := 0; i < len(images); i += batchSize {
        end := i + batchSize
        if end > len(images) {
            end = len(images)
        }

        batch := make([]Job, end-i)
        for j := i; j < end; j++ {
            batch[j-i] = Job{Index: j, Image: images[j]}
        }
        jobs <- batch
    }
    close(jobs)

    wg.Wait()
    return results
}

// æ€§èƒ½: 100å¼ å›¾ç‰‡ = 10ç§’
// CPUä½¿ç”¨: 95%
// å†…å­˜: å‡å°‘30%
```

**ä¼˜åŒ–æ€»ç»“**:

| ç‰ˆæœ¬ | è€—æ—¶ | CPU | å†…å­˜ | Goroutine |
|------|------|-----|------|-----------|
| V1 (ä¸²è¡Œ) | 100s | 12% | 100MB | 1 |
| V2 (æ— é™å¹¶å‘) | 15s | 95% | 500MB | 100 |
| V3 (Worker Pool) | 13s | 95% | 200MB | 8 |
| V4 (æ‰¹å¤„ç†+æ± ) | 10s | 95% | 140MB | 8 |

---

## 7. æ•°æ®åº“ä¼˜åŒ–å®æˆ˜

### æ¡ˆä¾‹: è®¢å•æŸ¥è¯¢ä¼˜åŒ–

**é—®é¢˜**: è®¢å•åˆ—è¡¨æŸ¥è¯¢æ…¢ï¼ˆP99 > 2ç§’ï¼‰

```go
// âŒ ä¼˜åŒ–å‰
func GetOrders(userID string) ([]Order, error) {
    var orders []Order

    // N+1æŸ¥è¯¢é—®é¢˜
    rows, _ := db.Query("SELECT * FROM orders WHERE user_id = ?", userID)
    defer rows.Close()

    for rows.Next() {
        var order Order
        rows.Scan(&order.ID, &order.UserID, &order.TotalAmount)

        // ä¸ºæ¯ä¸ªè®¢å•æŸ¥è¯¢å•†å“
        items, _ := db.Query("SELECT * FROM order_items WHERE order_id = ?", order.ID)
        // ... æ‰«æitems
        order.Items = items

        orders = append(orders, order)
    }

    return orders, nil
}

// æ€§èƒ½: 100ä¸ªè®¢å• = 2.5ç§’ (101æ¬¡æ•°æ®åº“æŸ¥è¯¢)
```

**ä¼˜åŒ–æ­¥éª¤**:

1. **ä½¿ç”¨JOINé¿å…N+1æŸ¥è¯¢**:

```go
// âœ… ä¼˜åŒ–V1: JOINæŸ¥è¯¢
func GetOrdersV1(userID string) ([]Order, error) {
    query := `
        SELECT o.id, o.user_id, o.total_amount,
               oi.product_id, oi.quantity, oi.price
        FROM orders o
        LEFT JOIN order_items oi ON o.id = oi.order_id
        WHERE o.user_id = ?
    `

    rows, _ := db.Query(query, userID)
    defer rows.Close()

    // ç»„è£…æ•°æ®
    ordersMap := make(map[string]*Order)
    for rows.Next() {
        var orderID, userID, productID string
        var totalAmount, price float64
        var quantity int

        rows.Scan(&orderID, &userID, &totalAmount, &productID, &quantity, &price)

        if order, exists := ordersMap[orderID]; !exists {
            ordersMap[orderID] = &Order{
                ID:          orderID,
                UserID:      userID,
                TotalAmount: totalAmount,
                Items:       []OrderItem{},
            }
        }

        ordersMap[orderID].Items = append(ordersMap[orderID].Items, OrderItem{
            ProductID: productID,
            Quantity:  quantity,
            Price:     price,
        })
    }

    orders := make([]Order, 0, len(ordersMap))
    for _, order := range ordersMap {
        orders = append(orders, *order)
    }

    return orders, nil
}

// æ€§èƒ½: 100ä¸ªè®¢å• = 0.5ç§’ (1æ¬¡æ•°æ®åº“æŸ¥è¯¢)
```

2. **æ·»åŠ ç¼“å­˜**:

```go
// âœ… ä¼˜åŒ–V2: æ·»åŠ ç¼“å­˜
func GetOrdersV2(userID string) ([]Order, error) {
    // å°è¯•ä»ç¼“å­˜è·å–
    cacheKey := "orders:" + userID
    if cached, err := redis.Get(cacheKey).Result(); err == nil {
        var orders []Order
        json.Unmarshal([]byte(cached), &orders)
        return orders, nil
    }

    // ä»æ•°æ®åº“æŸ¥è¯¢
    orders, err := GetOrdersV1(userID)
    if err != nil {
        return nil, err
    }

    // å†™å…¥ç¼“å­˜
    if data, err := json.Marshal(orders); err == nil {
        redis.Set(cacheKey, data, 5*time.Minute)
    }

    return orders, nil
}

// æ€§èƒ½: ç¼“å­˜å‘½ä¸­ = 5msï¼Œæœªå‘½ä¸­ = 0.5ç§’
```

**ä¼˜åŒ–æ•ˆæœ**:

| ç‰ˆæœ¬ | æŸ¥è¯¢æ—¶é—´ | DBæŸ¥è¯¢æ¬¡æ•° | ç¼“å­˜å‘½ä¸­ç‡ |
|------|----------|------------|------------|
| V0 (åŸå§‹) | 2.5s | 101 | 0% |
| V1 (JOIN) | 0.5s | 1 | 0% |
| V2 (ç¼“å­˜) | 5ms | 0 (å‘½ä¸­) | 95% |

---

## 8. ç½‘ç»œä¼˜åŒ–å®æˆ˜

### HTTPæœåŠ¡å™¨ä¼˜åŒ–

```go
// âŒ ä¼˜åŒ–å‰ - é»˜è®¤é…ç½®
func main() {
    http.HandleFunc("/", handler)
    http.ListenAndServe(":8080", nil)
}

// âœ… ä¼˜åŒ–å - è‡ªå®šä¹‰é…ç½®
func main() {
    server := &http.Server{
        Addr:         ":8080",
        Handler:      handler,
        ReadTimeout:  10 * time.Second,
        WriteTimeout: 10 * time.Second,
        IdleTimeout:  120 * time.Second,
        MaxHeaderBytes: 1 << 20,  // 1MB
    }

    // è°ƒæ•´æ“ä½œç³»ç»Ÿå‚æ•°
    // Linux: ulimit -n 65535

    server.ListenAndServe()
}

// æ€§èƒ½æå‡:
// - å¹¶å‘è¿æ¥: 1000 â†’ 10000
// - QPS: 5000 â†’ 15000
```

---

## 9. å®Œæ•´ä¼˜åŒ–æ¡ˆä¾‹

### APIæœåŠ¡ç«¯åˆ°ç«¯ä¼˜åŒ–

**åˆå§‹çŠ¶æ€**:

- QPS: 500
- P99å»¶è¿Ÿ: 800ms
- CPU: 70%
- å†…å­˜: 2GB
- é”™è¯¯ç‡: 1%

**ä¼˜åŒ–æµç¨‹**:

#### ç¬¬1è½®: CPUä¼˜åŒ–

**å‘ç°**: pprofæ˜¾ç¤ºJSONåºåˆ—åŒ–å ç”¨40% CPU

```go
// ä¼˜åŒ–: ä½¿ç”¨jsoniteræ›¿ä»£æ ‡å‡†åº“
import jsoniter "github.com/json-iterator/go"

var json = jsoniter.ConfigCompatibleWithStandardLibrary

// æ•ˆæœ: CPU 70% â†’ 50%
```

#### ç¬¬2è½®: å†…å­˜ä¼˜åŒ–

**å‘ç°**: å¤§é‡ä¸´æ—¶å¯¹è±¡åˆ†é…

```go
// ä¼˜åŒ–: ä½¿ç”¨å¯¹è±¡æ± 
var responsePool = sync.Pool{
    New: func() interface{} {
        return &Response{}
    },
}

// æ•ˆæœ: å†…å­˜ 2GB â†’ 1.2GB, GCæš‚åœ 50ms â†’ 10ms
```

#### ç¬¬3è½®: æ•°æ®åº“ä¼˜åŒ–

**å‘ç°**: æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¾ç¤ºå¤šä¸ªæŸ¥è¯¢ > 100ms

```go
// ä¼˜åŒ–:
// 1. æ·»åŠ ç´¢å¼•
// 2. ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
// 3. å¼•å…¥Redisç¼“å­˜

// æ•ˆæœ: P99å»¶è¿Ÿ 800ms â†’ 200ms
```

#### ç¬¬4è½®: å¹¶å‘ä¼˜åŒ–

**å‘ç°**: å•çº¿ç¨‹å¤„ç†é™åˆ¶äº†ååé‡

```go
// ä¼˜åŒ–: ä½¿ç”¨worker poolå¤„ç†è¯·æ±‚

// æ•ˆæœ: QPS 500 â†’ 2000
```

**æœ€ç»ˆç»“æœ**:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| QPS | 500 | 2000 | 4x |
| P99å»¶è¿Ÿ | 800ms | 50ms | 16x |
| CPU | 70% | 40% | 1.75x |
| å†…å­˜ | 2GB | 800MB | 2.5x |
| é”™è¯¯ç‡ | 1% | 0.01% | 100x |

---

## ğŸ”— ç›¸å…³èµ„æº

- [æ€§èƒ½åˆ†æå·¥å…·](./01-æ€§èƒ½åˆ†æå·¥å…·.md)
- [å†…å­˜ä¼˜åŒ–](./02-å†…å­˜ä¼˜åŒ–.md)
- [å¹¶å‘ä¼˜åŒ–](./03-å¹¶å‘ä¼˜åŒ–.md)
- [GCè°ƒä¼˜](./05-GCè°ƒä¼˜.md)

---

**æœ€åæ›´æ–°**: 2025-10-29
**Goç‰ˆæœ¬**: 1.25.3
**æ–‡æ¡£ç±»å‹**: å®æˆ˜æŒ‡å— âœ¨
