# Goæ€§èƒ½åŸºå‡†æµ‹è¯•

> **ç®€ä»‹**: æŒæ¡Goæ€§èƒ½åŸºå‡†æµ‹è¯•æŠ€æœ¯ï¼Œä½¿ç”¨testing.Bè¿›è¡Œå¾®åŸºå‡†æµ‹è¯•å’Œæ€§èƒ½å›å½’åˆ†æ
> **ç‰ˆæœ¬**: Go 1.23+  
> **éš¾åº¦**: â­â­â­  
> **æ ‡ç­¾**: #æ€§èƒ½æµ‹è¯• #benchmark #testing #æ€§èƒ½åˆ†æ

<!-- TOC START -->
- [Goæ€§èƒ½åŸºå‡†æµ‹è¯•](#goæ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [1. ç†è®ºåŸºç¡€](#1-ç†è®ºåŸºç¡€)
  - [2. go test -benchç”¨æ³•](#2-go-test--benchç”¨æ³•)
  - [3. æ€§èƒ½å¯¹æ¯”ä¸å›å½’](#3-æ€§èƒ½å¯¹æ¯”ä¸å›å½’)
  - [4. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ](#4-å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ)
  - [5. å‚è€ƒæ–‡çŒ®](#5-å‚è€ƒæ–‡çŒ®)
<!-- TOC END -->


## ğŸ“‹ ç›®å½•


- [1. ç†è®ºåŸºç¡€](#1-ç†è®ºåŸºç¡€)
  - [ä»€ä¹ˆæ˜¯æ€§èƒ½åŸºå‡†æµ‹è¯•](#ä»€ä¹ˆæ˜¯æ€§èƒ½åŸºå‡†æµ‹è¯•)
  - [Goçš„testing.Bæ¡†æ¶](#goçš„testingbæ¡†æ¶)
  - [å…³é”®æŒ‡æ ‡](#å…³é”®æŒ‡æ ‡)
- [2. go test -benchç”¨æ³•](#2-go-test--benchç”¨æ³•)
  - [åŸºæœ¬ç”¨æ³•](#åŸºæœ¬ç”¨æ³•)
  - [ç»“æœè§£è¯»](#ç»“æœè§£è¯»)
  - [é«˜çº§æŠ€å·§](#é«˜çº§æŠ€å·§)
- [3. æ€§èƒ½å¯¹æ¯”ä¸å›å½’](#3-æ€§èƒ½å¯¹æ¯”ä¸å›å½’)
  - [ä½¿ç”¨benchstatå¯¹æ¯”](#ä½¿ç”¨benchstatå¯¹æ¯”)
  - [CIé›†æˆç›‘æ§å›å½’](#cié›†æˆç›‘æ§å›å½’)
  - [æ€§èƒ½åŸºçº¿ç®¡ç†](#æ€§èƒ½åŸºçº¿ç®¡ç†)
- [4. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ](#4-å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ)
  - [å¸¸è§é™·é˜±](#å¸¸è§é™·é˜±)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [5. å‚è€ƒæ–‡çŒ®](#5-å‚è€ƒæ–‡çŒ®)

## 1. ç†è®ºåŸºç¡€

### ä»€ä¹ˆæ˜¯æ€§èƒ½åŸºå‡†æµ‹è¯•

æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆBenchmarkï¼‰ç”¨äºï¼š
- **åº¦é‡æ€§èƒ½**ï¼šæµ‹é‡ä»£ç çš„æ‰§è¡Œé€Ÿåº¦å’Œèµ„æºæ¶ˆè€—
- **æ€§èƒ½å¯¹æ¯”**ï¼šæ¯”è¾ƒä¸åŒå®ç°çš„æ€§èƒ½å·®å¼‚
- **å›å½’æ£€æµ‹**ï¼šæŒç»­ç›‘æ§æ€§èƒ½å˜åŒ–

### Goçš„testing.Bæ¡†æ¶

Goå†…ç½®`testing`åŒ…æä¾›Benchmarkæ”¯æŒï¼š
- è‡ªåŠ¨è¿è¡Œå¤šæ¬¡å–å¹³å‡å€¼
- è‡ªåŠ¨è°ƒæ•´è¿è¡Œæ¬¡æ•°ï¼ˆb.Nï¼‰
- å†…ç½®å†…å­˜åˆ†é…ç»Ÿè®¡
- æ”¯æŒå¹¶è¡Œæµ‹è¯•

### å…³é”®æŒ‡æ ‡

- **ns/op**ï¼šæ¯æ¬¡æ“ä½œè€—æ—¶ï¼ˆçº³ç§’ï¼‰
- **B/op**ï¼šæ¯æ¬¡æ“ä½œåˆ†é…çš„å­—èŠ‚æ•°
- **allocs/op**ï¼šæ¯æ¬¡æ“ä½œçš„å†…å­˜åˆ†é…æ¬¡æ•°

## 2. go test -benchç”¨æ³•

### åŸºæœ¬ç”¨æ³•

**ç¼–å†™Benchmarkå‡½æ•°ï¼š**

```go
package mypackage

import "testing"

// å‡½æ•°åå¿…é¡»ä»¥Benchmarkå¼€å¤´
func BenchmarkAdd(b *testing.B) {
    for i := 0; i < b.N; i++ {
        _ = 1 + 2  // è¢«æµ‹è¯•çš„ä»£ç 
    }
}

// æµ‹è¯•å­—ç¬¦ä¸²æ‹¼æ¥
func BenchmarkStringConcat(b *testing.B) {
    for i := 0; i < b.N; i++ {
        _ = "hello" + "world"
    }
}

func BenchmarkStringsBuilder(b *testing.B) {
    for i := 0; i < b.N; i++ {
        var sb strings.Builder
        sb.WriteString("hello")
        sb.WriteString("world")
        _ = sb.String()
    }
}
```

**è¿è¡ŒBenchmarkï¼š**

```bash
# è¿è¡Œæ‰€æœ‰benchmark
go test -bench=.

# è¿è¡Œç‰¹å®šbenchmark
go test -bench=BenchmarkAdd

# æ˜¾ç¤ºå†…å­˜åˆ†é…ç»Ÿè®¡
go test -bench=. -benchmem

# è¿è¡Œ10ç§’
go test -bench=. -benchtime=10s

# æŒ‡å®šè¿è¡Œæ¬¡æ•°
go test -bench=. -benchtime=100x

# å¹¶è¡Œæµ‹è¯•
go test -bench=. -cpu=1,2,4,8
```

### ç»“æœè§£è¯»

```
BenchmarkAdd-8              1000000000    0.2534 ns/op    0 B/op    0 allocs/op
BenchmarkStringConcat-8     100000000     10.5 ns/op      16 B/op   1 allocs/op
BenchmarkStringsBuilder-8   50000000      28.3 ns/op      64 B/op   2 allocs/op
```

è§£é‡Šï¼š
- `-8`: GOMAXPROCS=8
- `1000000000`: è¿è¡Œäº†10äº¿æ¬¡
- `0.2534 ns/op`: æ¯æ¬¡æ“ä½œ0.25çº³ç§’
- `0 B/op`: æ¯æ¬¡æ“ä½œ0å­—èŠ‚åˆ†é…
- `0 allocs/op`: æ¯æ¬¡æ“ä½œ0æ¬¡å†…å­˜åˆ†é…

### é«˜çº§æŠ€å·§

**1. é‡ç½®è®¡æ—¶å™¨ï¼ˆæ’é™¤åˆå§‹åŒ–æ—¶é—´ï¼‰**

```go
func BenchmarkExpensiveSetup(b *testing.B) {
    // è€—æ—¶çš„åˆå§‹åŒ–
    data := prepareTestData(10000)
    cache := buildCache(data)
    
    b.ResetTimer()  // é‡ç½®è®¡æ—¶å™¨ï¼Œæ’é™¤ä¸Šè¿°åˆå§‹åŒ–æ—¶é—´
    
    for i := 0; i < b.N; i++ {
        cache.Get(data[i%len(data)])
    }
}
```

**2. æš‚åœ/æ¢å¤è®¡æ—¶å™¨**

```go
func BenchmarkProcessWithSetup(b *testing.B) {
    for i := 0; i < b.N; i++ {
        b.StopTimer()  // æš‚åœè®¡æ—¶
        input := generateInput()
        b.StartTimer()  // æ¢å¤è®¡æ—¶
        
        process(input)
    }
}
```

**3. å¹¶è¡ŒBenchmark**

```go
func BenchmarkParallel(b *testing.B) {
    b.RunParallel(func(pb *testing.PB) {
        for pb.Next() {
            // å¹¶å‘æ‰§è¡Œçš„ä»£ç 
            doWork()
        }
    })
}
```

**4. å­Benchmark**

```go
func BenchmarkFib(b *testing.B) {
    for _, n := range []int{1, 10, 20, 30} {
        b.Run(fmt.Sprintf("n=%d", n), func(b *testing.B) {
            for i := 0; i < b.N; i++ {
                fib(n)
            }
        })
    }
}

// è¾“å‡ºï¼š
// BenchmarkFib/n=1-8    100000000    10.2 ns/op
// BenchmarkFib/n=10-8   10000000     120 ns/op
// BenchmarkFib/n=20-8   100000       15000 ns/op
```

**5. æŠ¥å‘Šè‡ªå®šä¹‰æŒ‡æ ‡**

```go
func BenchmarkCustomMetric(b *testing.B) {
    totalBytes := 0
    
    for i := 0; i < b.N; i++ {
        n := processData()
        totalBytes += n
    }
    
    // æŠ¥å‘Šååé‡ï¼ˆMB/sï¼‰
    b.SetBytes(int64(totalBytes / b.N))
}
```

## 3. æ€§èƒ½å¯¹æ¯”ä¸å›å½’

### ä½¿ç”¨benchstatå¯¹æ¯”

**å®‰è£…benchstatï¼š**

```bash
go install golang.org/x/perf/cmd/benchstat@latest
```

**å¯¹æ¯”æµç¨‹ï¼š**

```bash
# ä¼˜åŒ–å‰
go test -bench=. -count=10 -benchmem > old.txt

# ä¿®æ”¹ä»£ç ä¼˜åŒ–

# ä¼˜åŒ–å
go test -bench=. -count=10 -benchmem > new.txt

# å¯¹æ¯”ç»“æœ
benchstat old.txt new.txt
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
name           old time/op    new time/op    delta
StringConcat   10.5ns Â± 2%    2.8ns Â± 1%     -73.33%  (p=0.000 n=10+10)

name           old alloc/op   new alloc/op   delta
StringConcat   16.0B Â± 0%     0.0B           -100.00%  (p=0.000 n=10+10)

name           old allocs/op  new allocs/op  delta
StringConcat   1.00 Â± 0%      0.00           -100.00%  (p=0.000 n=10+10)
```

### CIé›†æˆç›‘æ§å›å½’

**GitHub Actionsç¤ºä¾‹ï¼š**

```yaml
name: Performance Regression

on: [push, pull_request]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      
      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -count=5 > new.txt
          
      - name: Compare with baseline
        run: |
          git fetch origin main
          git checkout origin/main
          go test -bench=. -benchmem -count=5 > old.txt
          git checkout -
          
          benchstat old.txt new.txt || true
          
      - name: Check regression
        run: |
          # å¦‚æœæ€§èƒ½ä¸‹é™è¶…è¿‡10%ï¼Œå¤±è´¥
          python check_regression.py old.txt new.txt --threshold=10
```

### æ€§èƒ½åŸºçº¿ç®¡ç†

```go
// benchmark_baseline_test.go
package mypackage

var baselineResults = map[string]BenchmarkBaseline{
    "Add": {
        NsPerOp:    1.0,
        AllocsPerOp: 0,
        BytesPerOp:  0,
    },
    "StringConcat": {
        NsPerOp:    10.0,
        AllocsPerOp: 1,
        BytesPerOp:  16,
    },
}

type BenchmarkBaseline struct {
    NsPerOp     float64
    AllocsPerOp float64
    BytesPerOp  float64
}
```

## 4. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ

### å¸¸è§é™·é˜±

**1. ç¼–è¯‘å™¨ä¼˜åŒ–æ¶ˆé™¤ä»£ç **

```go
// âŒ ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–æ‰
func BenchmarkBad(b *testing.B) {
    for i := 0; i < b.N; i++ {
        fibonacci(10)  // ç»“æœæœªä½¿ç”¨ï¼Œå¯èƒ½è¢«ä¼˜åŒ–
    }
}

// âœ… ä½¿ç”¨ç»“æœï¼Œé˜²æ­¢ä¼˜åŒ–
func BenchmarkGood(b *testing.B) {
    var result int
    for i := 0; i < b.N; i++ {
        result = fibonacci(10)
    }
    _ = result  // æˆ–èµ‹å€¼ç»™å…¨å±€å˜é‡
}
```

**2. åŒ…å«I/Oæ“ä½œ**

```go
// âŒ åŒ…å«ç½‘ç»œI/Oï¼Œç»“æœä¸ç¨³å®š
func BenchmarkHTTP(b *testing.B) {
    for i := 0; i < b.N; i++ {
        resp, _ := http.Get("http://example.com")
        resp.Body.Close()
    }
}

// âœ… ä½¿ç”¨mockæˆ–æœ¬åœ°æœåŠ¡å™¨
func BenchmarkHTTPMock(b *testing.B) {
    server := httptest.NewServer(handler)
    defer server.Close()
    
    for i := 0; i < b.N; i++ {
        resp, _ := http.Get(server.URL)
        resp.Body.Close()
    }
}
```

**3. å¿½ç•¥é¢„çƒ­**

```go
// âœ… é¢„çƒ­åå†æµ‹è¯•
func BenchmarkWithWarmup(b *testing.B) {
    // é¢„çƒ­
    for i := 0; i < 100; i++ {
        doWork()
    }
    
    b.ResetTimer()
    
    for i := 0; i < b.N; i++ {
        doWork()
    }
}
```

### æœ€ä½³å®è·µ

âœ… **æµ‹è¯•è®¾è®¡**
- æµ‹è¯•çº¯CPUæ“ä½œï¼Œé¿å…I/O
- ä½¿ç”¨`b.ResetTimer()`æ’é™¤åˆå§‹åŒ–
- é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ¶ˆé™¤ä»£ç 

âœ… **ç»“æœåˆ†æ**
- ä½¿ç”¨`benchstat`è¿›è¡Œç»Ÿè®¡åˆ†æ
- å¤šæ¬¡è¿è¡Œå–å¹³å‡ï¼ˆ`-count=10`ï¼‰
- å…³æ³¨allocs/opï¼Œå†…å­˜åˆ†é…å½±å“æ€§èƒ½

âœ… **æŒç»­ç›‘æ§**
- CIé›†æˆBenchmarkæµ‹è¯•
- å»ºç«‹æ€§èƒ½åŸºçº¿
- å›å½’æ£€æµ‹è‡ªåŠ¨åŒ–

âœ… **å·¥å…·ç»“åˆ**
- é…åˆpprofæ·±å…¥åˆ†æ
- ä½¿ç”¨traceæŸ¥çœ‹å¹¶å‘æ€§èƒ½
- ç»“åˆç›‘æ§ç³»ç»ŸæŸ¥çœ‹ç”Ÿäº§æ•°æ®

## 5. å‚è€ƒæ–‡çŒ®

- Goå®˜æ–¹testingæ–‡æ¡£ï¼š<https://golang.org/pkg/testing/>
- benchstatå·¥å…·ï¼š<https://pkg.go.dev/golang.org/x/perf/cmd/benchstat>
- Dave Cheneyæ€§èƒ½æµ‹è¯•å®è·µï¼š<https://dave.cheney.net/high-performance-go-workshop>
- Goå¤œè¯»æ€§èƒ½ä¼˜åŒ–ä¸“æ ï¼š<https://github.com/developer-learning/night-reading-go>

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Go Documentation Team  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ27æ—¥  
**æ–‡æ¡£çŠ¶æ€**: å·²ä¼˜åŒ–  
**é€‚ç”¨ç‰ˆæœ¬**: Go 1.25.3+
