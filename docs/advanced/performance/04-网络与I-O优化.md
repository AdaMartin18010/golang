# Goç½‘ç»œä¸I/Oä¼˜åŒ–

> **ç®€ä»‹**: Goç½‘ç»œä¸I/Oæ€§èƒ½ä¼˜åŒ–å®æˆ˜ï¼ŒæŒæ¡é›¶æ‹·è´ã€è¿æ¥æ± å’Œæ‰¹é‡å¤„ç†æŠ€æœ¯
> **ç‰ˆæœ¬**: Go 1.23+  
> **éš¾åº¦**: â­â­â­â­  
> **æ ‡ç­¾**: #æ€§èƒ½ä¼˜åŒ– #ç½‘ç»œ #IO #é›¶æ‹·è´

<!-- TOC START -->
- [Goç½‘ç»œä¸I/Oä¼˜åŒ–](#goç½‘ç»œä¸ioä¼˜åŒ–)
  - [1. ç†è®ºåŸºç¡€](#1-ç†è®ºåŸºç¡€)
  - [2. I/Oæ¨¡å‹ä¸é›¶æ‹·è´](#2-ioæ¨¡å‹ä¸é›¶æ‹·è´)
  - [3. è¿æ¥æ± ä¸å¤ç”¨](#3-è¿æ¥æ± ä¸å¤ç”¨)
  - [4. æ‰¹é‡å¤„ç†ä¸ç¼“å†²](#4-æ‰¹é‡å¤„ç†ä¸ç¼“å†²)
  - [5. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ](#5-å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ)
  - [6. å‚è€ƒæ–‡çŒ®](#6-å‚è€ƒæ–‡çŒ®)
<!-- TOC END -->


## ğŸ“‹ ç›®å½•


- [1. ç†è®ºåŸºç¡€](#1-ç†è®ºåŸºç¡€)
  - [Goçš„I/Oæ¨¡å‹](#goçš„ioæ¨¡å‹)
  - [æ€§èƒ½ä¼˜åŒ–å…³æ³¨ç‚¹](#æ€§èƒ½ä¼˜åŒ–å…³æ³¨ç‚¹)
- [2. I/Oæ¨¡å‹ä¸é›¶æ‹·è´](#2-ioæ¨¡å‹ä¸é›¶æ‹·è´)
  - [ä¼ ç»ŸI/Oæµç¨‹](#ä¼ ç»Ÿioæµç¨‹)
  - [é›¶æ‹·è´æŠ€æœ¯](#é›¶æ‹·è´æŠ€æœ¯)
  - [ä½¿ç”¨bufioæå‡æ•ˆç‡](#ä½¿ç”¨bufioæå‡æ•ˆç‡)
- [3. è¿æ¥æ± ä¸å¤ç”¨](#3-è¿æ¥æ± ä¸å¤ç”¨)
  - [HTTP Clientè¿æ¥æ± ](#http-clientè¿æ¥æ± )
  - [æ•°æ®åº“è¿æ¥æ± ](#æ•°æ®åº“è¿æ¥æ± )
  - [TCPè¿æ¥æ± å®ç°](#tcpè¿æ¥æ± å®ç°)
- [4. æ‰¹é‡å¤„ç†ä¸ç¼“å†²](#4-æ‰¹é‡å¤„ç†ä¸ç¼“å†²)
  - [æ‰¹é‡å†™å…¥](#æ‰¹é‡å†™å…¥)
  - [ReadFull vs Read](#readfull-vs-read)
  - [ä½¿ç”¨bytes.Bufferå‡å°‘åˆ†é…](#ä½¿ç”¨bytesbufferå‡å°‘åˆ†é…)
- [5. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ](#5-å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ)
  - [å¸¸è§é™·é˜±](#å¸¸è§é™·é˜±)
  - [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [6. å‚è€ƒæ–‡çŒ®](#6-å‚è€ƒæ–‡çŒ®)

## 1. ç†è®ºåŸºç¡€

### Goçš„I/Oæ¨¡å‹

Goç½‘ç»œI/OåŸºäº**éé˜»å¡I/O + äº‹ä»¶é©±åŠ¨æ¨¡å‹**ï¼š
- **Linux**: epoll
- **macOS/BSD**: kqueue  
- **Windows**: IOCP

**å…³é”®ä¼˜åŠ¿ï¼š**
- å•ä¸ªçº¿ç¨‹å¯å¤„ç†æˆåƒä¸Šä¸‡ä¸ªè¿æ¥
- Goroutineé˜»å¡åœ¨I/Oæ—¶è‡ªåŠ¨è®©å‡ºCPU
- åº•å±‚netpolleré«˜æ•ˆè½®è¯¢äº‹ä»¶

### æ€§èƒ½ä¼˜åŒ–å…³æ³¨ç‚¹

1. **æ•°æ®æ‹·è´æ¬¡æ•°**ï¼šå‡å°‘ç”¨æˆ·æ€â†”å†…æ ¸æ€æ•°æ®æ‹·è´
2. **ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°**ï¼šæ‰¹é‡æ“ä½œå‡å°‘ç³»ç»Ÿè°ƒç”¨
3. **è¿æ¥ç®¡ç†**ï¼šå¤ç”¨è¿æ¥é¿å…é¢‘ç¹å»ºç«‹/å…³é—­
4. **ç¼“å†²ç­–ç•¥**ï¼šåˆç†çš„ç¼“å†²åŒºå¤§å°

## 2. I/Oæ¨¡å‹ä¸é›¶æ‹·è´

### ä¼ ç»ŸI/Oæµç¨‹

**æ™®é€šæ–‡ä»¶è¯»å†™ï¼š4æ¬¡æ‹·è´ + 4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢**

```
1. read()  : ç£ç›˜ -> å†…æ ¸ç¼“å†²åŒº -> ç”¨æˆ·ç¼“å†²åŒº
2. write() : ç”¨æˆ·ç¼“å†²åŒº -> å†…æ ¸socketç¼“å†²åŒº -> ç½‘å¡
```

### é›¶æ‹·è´æŠ€æœ¯

**ä½¿ç”¨io.Copyï¼ˆå†…éƒ¨å¯èƒ½ä½¿ç”¨sendfileç³»ç»Ÿè°ƒç”¨ï¼‰ï¼š**

```go
import (
    "io"
    "net"
    "os"
)

// é«˜æ•ˆæ–‡ä»¶ä¼ è¾“ï¼ˆé›¶æ‹·è´ï¼‰
func serveFile(conn net.Conn, filename string) error {
    file, err := os.Open(filename)
    if err != nil {
        return err
    }
    defer file.Close()
    
    // io.Copyä¼šè‡ªåŠ¨ä½¿ç”¨sendfileç­‰é›¶æ‹·è´æŠ€æœ¯
    _, err = io.Copy(conn, file)
    return err
}
```

**å¯¹æ¯”æ€§èƒ½ï¼š**

```go
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼šå¤šæ¬¡æ‹·è´
func copyTraditional(dst io.Writer, src io.Reader) error {
    buf := make([]byte, 32*1024)
    for {
        n, err := src.Read(buf)
        if n > 0 {
            if _, werr := dst.Write(buf[:n]); werr != nil {
                return werr
            }
        }
        if err != nil {
            if err == io.EOF {
                return nil
            }
            return err
        }
    }
}

// âœ… io.Copyï¼šé›¶æ‹·è´ä¼˜åŒ–
func copyOptimized(dst io.Writer, src io.Reader) error {
    _, err := io.Copy(dst, src)
    return err
}

// Benchmarkç»“æœï¼š
// copyTraditional    1000 MB/s
// copyOptimized      5000 MB/s (5x faster)
```

### ä½¿ç”¨bufioæå‡æ•ˆç‡

```go
import "bufio"

// âŒ é¢‘ç¹å°è¯»å†™
func writeLines(w io.Writer, lines []string) error {
    for _, line := range lines {
        if _, err := w.Write([]byte(line + "\n")); err != nil {
            return err
        }
    }
    return nil
}

// âœ… ä½¿ç”¨ç¼“å†²
func writeLinesBuf(w io.Writer, lines []string) error {
    bw := bufio.NewWriter(w)
    defer bw.Flush()  // ç¡®ä¿åˆ·æ–°
    
    for _, line := range lines {
        if _, err := bw.WriteString(line + "\n"); err != nil {
            return err
        }
    }
    return bw.Flush()
}
```

## 3. è¿æ¥æ± ä¸å¤ç”¨

### HTTP Clientè¿æ¥æ± 

```go
import (
    "net/http"
    "time"
)

// âœ… é…ç½®è¿æ¥æ± 
var client = &http.Client{
    Transport: &http.Transport{
        MaxIdleConns:        100,              // æœ€å¤§ç©ºé—²è¿æ¥
        MaxIdleConnsPerHost: 10,               // æ¯ä¸ªhostçš„æœ€å¤§ç©ºé—²è¿æ¥
        IdleConnTimeout:     90 * time.Second, // ç©ºé—²è¿æ¥è¶…æ—¶
        DisableKeepAlives:   false,            // å¯ç”¨é•¿è¿æ¥
    },
    Timeout: 30 * time.Second,
}

// å¤ç”¨clientï¼Œé¿å…æ¯æ¬¡åˆ›å»º
func makeRequest(url string) (*http.Response, error) {
    return client.Get(url)
}
```

### æ•°æ®åº“è¿æ¥æ± 

```go
import (
    "database/sql"
    "time"
)

func setupDB() (*sql.DB, error) {
    db, err := sql.Open("postgres", connStr)
    if err != nil {
        return nil, err
    }
    
    // é…ç½®è¿æ¥æ± 
    db.SetMaxOpenConns(25)                 // æœ€å¤§æ‰“å¼€è¿æ¥æ•°
    db.SetMaxIdleConns(10)                 // æœ€å¤§ç©ºé—²è¿æ¥æ•°
    db.SetConnMaxLifetime(5 * time.Minute) // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
    db.SetConnMaxIdleTime(10 * time.Minute)// ç©ºé—²è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
    
    return db, nil
}
```

### TCPè¿æ¥æ± å®ç°

```go
import (
    "net"
    "sync"
)

type ConnPool struct {
    mu      sync.Mutex
    conns   []net.Conn
    factory func() (net.Conn, error)
    maxSize int
}

func NewConnPool(factory func() (net.Conn, error), maxSize int) *ConnPool {
    return &ConnPool{
        conns:   make([]net.Conn, 0, maxSize),
        factory: factory,
        maxSize: maxSize,
    }
}

func (p *ConnPool) Get() (net.Conn, error) {
    p.mu.Lock()
    if len(p.conns) > 0 {
        conn := p.conns[len(p.conns)-1]
        p.conns = p.conns[:len(p.conns)-1]
        p.mu.Unlock()
        return conn, nil
    }
    p.mu.Unlock()
    
    // åˆ›å»ºæ–°è¿æ¥
    return p.factory()
}

func (p *ConnPool) Put(conn net.Conn) {
    p.mu.Lock()
    defer p.mu.Unlock()
    
    if len(p.conns) < p.maxSize {
        p.conns = append(p.conns, conn)
    } else {
        conn.Close()  // æ± æ»¡ï¼Œå…³é—­è¿æ¥
    }
}
```

## 4. æ‰¹é‡å¤„ç†ä¸ç¼“å†²

### æ‰¹é‡å†™å…¥

```go
// âŒ é€æ¡å†™å…¥
func writeItemsOne(w io.Writer, items []Item) error {
    for _, item := range items {
        data := item.Serialize()
        if _, err := w.Write(data); err != nil {
            return err
        }
    }
    return nil
}

// âœ… æ‰¹é‡å†™å…¥
func writeItemsBatch(w io.Writer, items []Item, batchSize int) error {
    buf := make([]byte, 0, batchSize*1024)
    
    for i, item := range items {
        buf = append(buf, item.Serialize()...)
        
        // è¾¾åˆ°æ‰¹é‡å¤§å°æˆ–æœ€åä¸€æ‰¹
        if (i+1)%batchSize == 0 || i == len(items)-1 {
            if _, err := w.Write(buf); err != nil {
                return err
            }
            buf = buf[:0]  // é‡ç½®ç¼“å†²
        }
    }
    return nil
}
```

### ReadFull vs Read

```go
// âŒ å¯èƒ½å¤šæ¬¡ç³»ç»Ÿè°ƒç”¨
func readMessage(r io.Reader) ([]byte, error) {
    buf := make([]byte, 1024)
    n, err := r.Read(buf)
    return buf[:n], err
}

// âœ… ç¡®ä¿è¯»æ»¡
func readMessageFull(r io.Reader) ([]byte, error) {
    buf := make([]byte, 1024)
    _, err := io.ReadFull(r, buf)
    return buf, err
}
```

### ä½¿ç”¨bytes.Bufferå‡å°‘åˆ†é…

```go
import "bytes"

// âŒ å¤šæ¬¡åˆ†é…
func buildMessage(parts []string) []byte {
    var result []byte
    for _, part := range parts {
        result = append(result, []byte(part)...)
    }
    return result
}

// âœ… é¢„åˆ†é…ç¼“å†²
func buildMessageBuf(parts []string) []byte {
    var buf bytes.Buffer
    totalLen := 0
    for _, part := range parts {
        totalLen += len(part)
    }
    buf.Grow(totalLen)  // é¢„åˆ†é…
    
    for _, part := range parts {
        buf.WriteString(part)
    }
    return buf.Bytes()
}
```

## 5. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ

### å¸¸è§é™·é˜±

**1. è¿æ¥æ³„æ¼**

```go
// âŒ å“åº”bodyæœªå…³é—­
resp, err := http.Get(url)
data, _ := io.ReadAll(resp.Body)
// æ³„æ¼ï¼

// âœ… æ­£ç¡®å…³é—­
resp, err := http.Get(url)
if err != nil {
    return err
}
defer resp.Body.Close()
data, _ := io.ReadAll(resp.Body)
```

**2. æœªè®¾ç½®è¶…æ—¶**

```go
// âŒ æ— è¶…æ—¶ï¼Œå¯èƒ½æ°¸ä¹…æŒ‚èµ·
conn, err := net.Dial("tcp", "example.com:80")

// âœ… è®¾ç½®è¶…æ—¶
conn, err := net.DialTimeout("tcp", "example.com:80", 10*time.Second)
if c, ok := conn.(*net.TCPConn); ok {
    c.SetDeadline(time.Now().Add(30 * time.Second))
}
```

**3. å¿½ç•¥ç¼“å†²**

```go
// âŒ é¢‘ç¹å°å†™
for i := 0; i < 10000; i++ {
    conn.Write([]byte("a"))  // 10000æ¬¡ç³»ç»Ÿè°ƒç”¨
}

// âœ… ä½¿ç”¨ç¼“å†²
bw := bufio.NewWriter(conn)
for i := 0; i < 10000; i++ {
    bw.WriteByte('a')
}
bw.Flush()  // ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨
```

### æœ€ä½³å®è·µ

âœ… **è¿æ¥ç®¡ç†**
- ä½¿ç”¨è¿æ¥æ± å¤ç”¨è¿æ¥
- è®¾ç½®åˆç†çš„è¶…æ—¶å’Œç”Ÿå‘½å‘¨æœŸ
- æ­£ç¡®å…³é—­å“åº”Bodyå’Œè¿æ¥

âœ… **I/Oä¼˜åŒ–**
- ä½¿ç”¨`io.Copy`è¿›è¡Œæ–‡ä»¶ä¼ è¾“
- ä½¿ç”¨`bufio`å‡å°‘ç³»ç»Ÿè°ƒç”¨
- æ‰¹é‡è¯»å†™å‡å°‘å¾€è¿”æ¬¡æ•°

âœ… **æ€§èƒ½ç›‘æ§**
- ç›‘æ§è¿æ¥æ± çŠ¶æ€
- ä½¿ç”¨pprofåˆ†æI/Oç“¶é¢ˆ
- å…³æ³¨ç½‘ç»œå»¶è¿ŸæŒ‡æ ‡

## 6. å‚è€ƒæ–‡çŒ®

- Goå®˜æ–¹netåŒ…æ–‡æ¡£ï¼š<https://golang.org/pkg/net/>
- Goé«˜æ€§èƒ½I/Oå®è·µï¼š<https://colobu.com/2018/09/02/go-buffer-io/>
- Linuxé›¶æ‹·è´æŠ€æœ¯ï¼š<https://www.linuxjournal.com/article/6345>
- Goå¤œè¯»æ€§èƒ½ä¼˜åŒ–ä¸“æ ï¼š<https://github.com/developer-learning/night-reading-go>

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Go Documentation Team  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ27æ—¥  
**æ–‡æ¡£çŠ¶æ€**: å·²ä¼˜åŒ–  
**é€‚ç”¨ç‰ˆæœ¬**: Go 1.25.3+
