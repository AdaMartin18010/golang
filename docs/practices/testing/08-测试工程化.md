# Goæµ‹è¯•å·¥ç¨‹åŒ–

> **ç®€ä»‹**: Goæµ‹è¯•å·¥ç¨‹åŒ–å®Œæ•´æŒ‡å—ï¼ŒåŒ…æ‹¬æµ‹è¯•ç»„ç»‡ã€CI/CDé›†æˆå’Œè´¨é‡ä¿è¯

> **ç‰ˆæœ¬**: Go 1.25.3  
> **éš¾åº¦**: â­â­â­â­  
> **æ ‡ç­¾**: #æµ‹è¯• #å·¥ç¨‹åŒ– #CI/CD #è´¨é‡ä¿è¯

---

## ğŸ“š ç›®å½•

1. [æµ‹è¯•ç»„ç»‡ç»“æ„](#æµ‹è¯•ç»„ç»‡ç»“æ„)
2. [CI/CDé›†æˆ](#cicdé›†æˆ)
3. [æµ‹è¯•æŠ¥å‘Š](#æµ‹è¯•æŠ¥å‘Š)
4. [è´¨é‡é—¨ç¦](#è´¨é‡é—¨ç¦)
5. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## 1. æµ‹è¯•ç»„ç»‡ç»“æ„

### æ ‡å‡†é¡¹ç›®ç»“æ„

```
myproject/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ myapp/
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”œâ”€â”€ user.go
â”‚   â”‚   â””â”€â”€ user_test.go
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ auth.go
â”‚       â””â”€â”€ auth_test.go
â”œâ”€â”€ pkg/
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ string.go
â”‚       â””â”€â”€ string_test.go
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â””â”€â”€ api_test.go
â”‚   â”œâ”€â”€ e2e/
â”‚   â”‚   â””â”€â”€ user_flow_test.go
â”‚   â””â”€â”€ testdata/
â”‚       â””â”€â”€ fixtures/
â”œâ”€â”€ go.mod
â””â”€â”€ Makefile
```

---

### æµ‹è¯•æ–‡ä»¶å‘½å

```go
// å•å…ƒæµ‹è¯•
user.go â†’ user_test.go

// é›†æˆæµ‹è¯•
user_integration_test.go

// E2Eæµ‹è¯•
user_e2e_test.go

// æ€§èƒ½æµ‹è¯•
user_bench_test.go
```

---

### ä½¿ç”¨build tagsåˆ†ç¦»æµ‹è¯•

```go
//go:build integration
// +build integration

package integration

import "testing"

func TestUserAPI(t *testing.T) {
    // é›†æˆæµ‹è¯•ä»£ç 
}
```

**è¿è¡Œ**:
```bash
# åªè¿è¡Œé›†æˆæµ‹è¯•
go test -tags=integration ./...

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test -tags=integration,e2e ./...
```

---

## 2. CI/CDé›†æˆ

### GitHub Actions

```yaml
# .github/workflows/test.yml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.3'
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Download dependencies
      run: go mod download
    
    - name: Run tests
      run: go test -v -race -coverprofile=coverage.out ./...
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.out
```

---

### GitLab CI

```yaml
# .gitlab-ci.yml
stages:
  - test
  - integration

test:
  stage: test
  image: golang:1.25.3
  script:
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -html=coverage.out -o coverage.html
  artifacts:
    paths:
      - coverage.html
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

integration:
  stage: integration
  image: golang:1.25.3
  services:
    - postgres:15
    - redis:7
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
  script:
    - go test -tags=integration -v ./test/integration/...
```

---

### Makefile

```makefile
.PHONY: test test-unit test-integration test-e2e test-coverage

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	go test -v -race ./...

# å•å…ƒæµ‹è¯•
test-unit:
	go test -v -short ./...

# é›†æˆæµ‹è¯•
test-integration:
	go test -v -tags=integration ./test/integration/...

# E2Eæµ‹è¯•
test-e2e:
	go test -v -tags=e2e ./test/e2e/...

# è¦†ç›–ç‡
test-coverage:
	go test -v -race -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	go tool cover -func=coverage.out

# æ€§èƒ½æµ‹è¯•
test-bench:
	go test -bench=. -benchmem ./...

# æ‰€æœ‰è´¨é‡æ£€æŸ¥
qa: lint test test-coverage
	@echo "Quality assurance completed"

# Lint
lint:
	golangci-lint run ./...
```

---

## 3. æµ‹è¯•æŠ¥å‘Š

### ç”ŸæˆHTMLæŠ¥å‘Š

```bash
# è¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# ä½¿ç”¨gotestsumç”Ÿæˆæ›´å¥½çš„æŠ¥å‘Š
go install gotest.tools/gotestsum@latest
gotestsum --format testname --junitfile report.xml
```

---

### é›†æˆCodecov

```yaml
# .github/workflows/test.yml
- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v3
  with:
    files: ./coverage.out
    flags: unittests
    name: codecov-umbrella
```

---

### SonarQubeé›†æˆ

```bash
# å®‰è£…sonar-scanner
# è¿è¡Œåˆ†æ
sonar-scanner \
  -Dsonar.projectKey=myproject \
  -Dsonar.sources=. \
  -Dsonar.go.coverage.reportPaths=coverage.out
```

---

## 4. è´¨é‡é—¨ç¦

### è¦†ç›–ç‡é—¨ç¦

```bash
# è„šæœ¬ï¼šcheck-coverage.sh
#!/bin/bash

COVERAGE=$(go test -coverprofile=coverage.out ./... | \
           grep "coverage:" | \
           awk '{print $NF}' | \
           sed 's/%//')

THRESHOLD=80

if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
    echo "Coverage $COVERAGE% is below threshold $THRESHOLD%"
    exit 1
fi

echo "Coverage $COVERAGE% meets threshold"
```

---

### ä»£ç è´¨é‡æ£€æŸ¥

```yaml
# .github/workflows/qa.yml
name: Quality Assurance

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: golangci/golangci-lint-action@v3
      with:
        version: latest
        args: --timeout=5m

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Run tests
      run: |
        go test -v -race -coverprofile=coverage.out ./...
        bash check-coverage.sh
```

---

### æ€§èƒ½å›å½’æ£€æµ‹

```go
// benchstatæ¯”è¾ƒ
// è¿è¡ŒåŸºå‡†æµ‹è¯•ä¸¤æ¬¡
go test -bench=. -count=5 > old.txt
# ä¿®æ”¹ä»£ç 
go test -bench=. -count=5 > new.txt

// ä½¿ç”¨benchstatæ¯”è¾ƒ
go install golang.org/x/perf/cmd/benchstat@latest
benchstat old.txt new.txt
```

---

## 5. æœ€ä½³å®è·µ

### 1. æµ‹è¯•é‡‘å­—å¡”

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  E2E   â”‚  10%
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Integr â”‚  20%
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  Unit  â”‚  70%
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å»ºè®®æ¯”ä¾‹**:
- å•å…ƒæµ‹è¯•: 70%
- é›†æˆæµ‹è¯•: 20%
- E2Eæµ‹è¯•: 10%

---

### 2. å¿«é€Ÿåé¦ˆå¾ªç¯

```bash
# æœ¬åœ°å¼€å‘ï¼šåªè¿è¡Œå•å…ƒæµ‹è¯•
make test-unit  # < 10ç§’

# PRæ£€æŸ¥ï¼šå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
make test-integration  # < 1åˆ†é’Ÿ

# å‘å¸ƒå‰ï¼šæ‰€æœ‰æµ‹è¯•
make test  # < 5åˆ†é’Ÿ
```

---

### 3. å¹¶è¡Œæµ‹è¯•

```go
func TestParallel(t *testing.T) {
    tests := []struct {
        name string
        // ...
    }{
        // test cases
    }
    
    for _, tt := range tests {
        tt := tt  // æ•è·å˜é‡
        t.Run(tt.name, func(t *testing.T) {
            t.Parallel()  // å¹¶è¡Œè¿è¡Œ
            // æµ‹è¯•ä»£ç 
        })
    }
}
```

---

### 4. æµ‹è¯•æ•°æ®ç®¡ç†

```
test/
â””â”€â”€ testdata/
    â”œâ”€â”€ fixtures/
    â”‚   â”œâ”€â”€ users.json
    â”‚   â””â”€â”€ products.json
    â”œâ”€â”€ golden/
    â”‚   â””â”€â”€ output.golden
    â””â”€â”€ mocks/
        â””â”€â”€ api_responses.json
```

```go
func loadTestData(t *testing.T, filename string) []byte {
    data, err := os.ReadFile(filepath.Join("testdata", filename))
    if err != nil {
        t.Fatal(err)
    }
    return data
}
```

---

### 5. æµ‹è¯•ç¯å¢ƒéš”ç¦»

```go
func TestWithDocker(t *testing.T) {
    // ä½¿ç”¨testcontainerså¯åŠ¨ä¾èµ–
    ctx := context.Background()
    
    req := testcontainers.ContainerRequest{
        Image:        "postgres:15",
        ExposedPorts: []string{"5432/tcp"},
        Env: map[string]string{
            "POSTGRES_PASSWORD": "test",
        },
    }
    
    postgres, _ := testcontainers.GenericContainer(ctx, 
        testcontainers.GenericContainerRequest{
            ContainerRequest: req,
            Started:          true,
        })
    defer postgres.Terminate(ctx)
    
    // è¿è¡Œæµ‹è¯•
}
```

---

## ğŸ”— ç›¸å…³èµ„æº

- [å•å…ƒæµ‹è¯•](./01-å•å…ƒæµ‹è¯•.md)
- [é›†æˆæµ‹è¯•](./03-é›†æˆæµ‹è¯•.md)
- [æµ‹è¯•è¦†ç›–ç‡](./05-æµ‹è¯•è¦†ç›–ç‡.md)
- [CI/CDæµç¨‹](../../deployment/04-CI-CDæµç¨‹.md)

---

**æœ€åæ›´æ–°**: 2025-10-28  
**Goç‰ˆæœ¬**: 1.25.3

