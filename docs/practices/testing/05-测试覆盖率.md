# æµ‹è¯•è¦†ç›–ç‡

**éš¾åº¦**: ä¸­çº§ | **é¢„è®¡é˜…è¯»**: 15åˆ†é’Ÿ | **å‰ç½®çŸ¥è¯†**: å•å…ƒæµ‹è¯•

---

## ğŸ“‹ ç›®å½•


- [1. ğŸ“– æ¦‚å¿µä»‹ç»](#1--æ¦‚å¿µä»‹ç»)
- [2. ğŸ¯ æ ¸å¿ƒçŸ¥è¯†ç‚¹](#2--æ ¸å¿ƒçŸ¥è¯†ç‚¹)
  - [2.1 ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š](#21-ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š)
  - [2.2 è¦†ç›–ç‡æ¨¡å¼](#22-è¦†ç›–ç‡æ¨¡å¼)
  - [2.3 æŒ‡å®šè¦†ç›–åŒ…](#23-æŒ‡å®šè¦†ç›–åŒ…)
  - [2.4 è¦†ç›–ç‡åˆ†æ](#24-è¦†ç›–ç‡åˆ†æ)
  - [2.5 æé«˜è¦†ç›–ç‡](#25-æé«˜è¦†ç›–ç‡)
  - [2.6 CIé›†æˆ](#26-cié›†æˆ)
    - [GitHub Actionsç¤ºä¾‹](#github-actionsç¤ºä¾‹)
  - [2.7 è¦†ç›–ç‡å¾½ç« ](#27-è¦†ç›–ç‡å¾½ç« )
- [3. ğŸ’¡ æœ€ä½³å®è·µ](#3--æœ€ä½³å®è·µ)
  - [3.1 è®¾å®šåˆç†ç›®æ ‡](#31-è®¾å®šåˆç†ç›®æ ‡)
  - [3.2 å…³æ³¨æœªè¦†ç›–çš„å…³é”®è·¯å¾„](#32-å…³æ³¨æœªè¦†ç›–çš„å…³é”®è·¯å¾„)
  - [3.3 å¿½ç•¥ä¸éœ€è¦æµ‹è¯•çš„ä»£ç ](#33-å¿½ç•¥ä¸éœ€è¦æµ‹è¯•çš„ä»£ç )
  - [3.4 åˆ†åŒ…æµ‹è¯•](#34-åˆ†åŒ…æµ‹è¯•)
  - [3.5 è¦†ç›–ç‡è¶‹åŠ¿ç›‘æ§](#35-è¦†ç›–ç‡è¶‹åŠ¿ç›‘æ§)
- [4. âš ï¸ å¸¸è§é—®é¢˜](#4--å¸¸è§é—®é¢˜)
- [5. ğŸ“š ç›¸å…³èµ„æº](#5--ç›¸å…³èµ„æº)

## 1. ğŸ“– æ¦‚å¿µä»‹ç»

æµ‹è¯•è¦†ç›–ç‡è¡¡é‡æµ‹è¯•æ‰§è¡Œäº†å¤šå°‘ä»£ç ï¼Œå¸®åŠ©è¯†åˆ«æœªæµ‹è¯•çš„ä»£ç è·¯å¾„ã€‚Goæä¾›å†…ç½®çš„è¦†ç›–ç‡å·¥å…·ï¼Œå¯ä»¥ç”Ÿæˆè¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Šã€‚

---

## 2. ğŸ¯ æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 2.1 ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
go test -cover

# è¾“å‡ºç¤ºä¾‹
PASS
coverage: 85.7% of statements
ok      mypackage    0.123s

# ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
go test -coverprofile=coverage.out

# æŸ¥çœ‹HTMLæŠ¥å‘Š
go tool cover -html=coverage.out

# åœ¨ç»ˆç«¯æŸ¥çœ‹
go tool cover -func=coverage.out
```

---

### 2.2 è¦†ç›–ç‡æ¨¡å¼

```bash
# é»˜è®¤æ¨¡å¼ï¼šsetï¼ˆè¯­å¥æ˜¯å¦æ‰§è¡Œï¼‰
go test -covermode=set -coverprofile=coverage.out

# countæ¨¡å¼ï¼šè¯­å¥æ‰§è¡Œæ¬¡æ•°
go test -covermode=count -coverprofile=coverage.out

# atomicæ¨¡å¼ï¼šå¹¶å‘å®‰å…¨çš„count
go test -covermode=atomic -coverprofile=coverage.out
```

---

### 2.3 æŒ‡å®šè¦†ç›–åŒ…

```bash
# åªè¦†ç›–å½“å‰åŒ…
go test -cover

# è¦†ç›–æŒ‡å®šåŒ…
go test -coverpkg=./... -coverprofile=coverage.out

# è¦†ç›–å¤šä¸ªåŒ…
go test -coverpkg=./pkg/...,./internal/... -coverprofile=coverage.out
```

---

### 2.4 è¦†ç›–ç‡åˆ†æ

```go
// math.go
package math

func Add(a, b int) int {
    return a + b
}

func Divide(a, b int) (int, error) {
    if b == 0 {  // åˆ†æ”¯1
        return 0, errors.New("division by zero")
    }
    return a / b, nil  // åˆ†æ”¯2
}

func Multiply(a, b int) int {
    return a * b
}
```

```go
// math_test.go
package math

import "testing"

func TestAdd(t *testing.T) {
    if Add(2, 3) != 5 {
        t.Error("Add failed")
    }
}

func TestDivide(t *testing.T) {
    // åªæµ‹è¯•æ­£å¸¸æƒ…å†µï¼Œæœªæµ‹è¯•é™¤ä»¥é›¶
    result, err := Divide(10, 2)
    if err != nil || result != 5 {
        t.Error("Divide failed")
    }
}

// Multiplyå‡½æ•°æœªæµ‹è¯•
```

è¿è¡Œè¦†ç›–ç‡ï¼š
```bash
$ go test -cover
coverage: 66.7% of statements
```

æŸ¥çœ‹è¯¦æƒ…ï¼š
```bash
$ go tool cover -func=coverage.out
math.go:3:      Add        100.0%
math.go:7:      Divide      50.0%  # åªè¦†ç›–äº†ä¸€ä¸ªåˆ†æ”¯
math.go:14:     Multiply     0.0%  # æœªè¦†ç›–
```

---

### 2.5 æé«˜è¦†ç›–ç‡

```go
// è¡¥å……æµ‹è¯•
func TestDivideByZero(t *testing.T) {
    _, err := Divide(10, 0)
    if err == nil {
        t.Error("Expected error for division by zero")
    }
}

func TestMultiply(t *testing.T) {
    if Multiply(3, 4) != 12 {
        t.Error("Multiply failed")
    }
}
```

ç°åœ¨è¦†ç›–ç‡ï¼š
```bash
$ go test -cover
coverage: 100.0% of statements
```

---

### 2.6 CIé›†æˆ

#### GitHub Actionsç¤ºä¾‹

```yaml
name: Test Coverage

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run tests with coverage
        run: go test -v -coverprofile=coverage.out -covermode=atomic ./...
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          fail_ci_if_error: true
      
      - name: Check coverage threshold
        run: |
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "Coverage $coverage% is below 80%"
            exit 1
          fi
```

---

### 2.7 è¦†ç›–ç‡å¾½ç« 

```markdown
# README.md
[![codecov](https://codecov.io/gh/username/repo/branch/main/graph/badge.svg)](https://codecov.io/gh/username/repo)
```

---

## 3. ğŸ’¡ æœ€ä½³å®è·µ

### 3.1 è®¾å®šåˆç†ç›®æ ‡

| ä»£ç ç±»å‹ | æ¨èè¦†ç›–ç‡ |
|---------|-----------|
| æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ | 80-90% |
| å·¥å…·å‡½æ•° | 70-80% |
| UI/å±•ç¤ºå±‚ | 50-60% |
| æ•´ä½“é¡¹ç›® | 70-80% |

### 3.2 å…³æ³¨æœªè¦†ç›–çš„å…³é”®è·¯å¾„

```bash
# æŸ¥çœ‹æœªè¦†ç›–çš„ä»£ç 
go tool cover -html=coverage.out

# çº¢è‰²ï¼šæœªè¦†ç›–
# ç»¿è‰²ï¼šå·²è¦†ç›–
```

### 3.3 å¿½ç•¥ä¸éœ€è¦æµ‹è¯•çš„ä»£ç 

```go
//go:build !test
// +build !test

package main

// è¿™ä¸ªæ–‡ä»¶åœ¨æµ‹è¯•æ—¶ä¼šè¢«å¿½ç•¥
```

### 3.4 åˆ†åŒ…æµ‹è¯•

```bash
# æ¯ä¸ªåŒ…å•ç‹¬æµ‹è¯•
for pkg in $(go list ./...); do
    go test -cover $pkg
done
```

### 3.5 è¦†ç›–ç‡è¶‹åŠ¿ç›‘æ§

```bash
# ä¿å­˜å†å²è¦†ç›–ç‡
go test -coverprofile=coverage.out
echo "$(date): $(go tool cover -func=coverage.out | grep total | awk '{print $3}')" >> coverage-history.txt
```

---

## 4. âš ï¸ å¸¸è§é—®é¢˜

**Q1: 100%è¦†ç›–ç‡æ˜¯å¿…é¡»çš„å—ï¼Ÿ**
- ä¸æ˜¯ï¼Œè¿½æ±‚100%å¯èƒ½æµªè´¹æ—¶é—´
- å…³æ³¨æ ¸å¿ƒé€»è¾‘çš„é«˜è¦†ç›–
- æŸäº›ä»£ç ï¼ˆå¦‚é”™è¯¯å¤„ç†ï¼‰å¯èƒ½éš¾ä»¥æµ‹è¯•

**Q2: ä¸ºä»€ä¹ˆè¦†ç›–ç‡é«˜ä½†è¿˜æœ‰bugï¼Ÿ**
- è¦†ç›–ç‡åªæ˜¯ä»£ç æ‰§è¡Œï¼Œä¸æ˜¯æ­£ç¡®æ€§
- éœ€è¦ç»“åˆæ–­è¨€éªŒè¯
- è¾¹ç•Œæ¡ä»¶å¯èƒ½æœªæµ‹è¯•

**Q3: å¦‚ä½•æµ‹è¯•éš¾ä»¥è¦†ç›–çš„ä»£ç ï¼Ÿ**
```go
// ä½¿ç”¨æ¥å£éš”ç¦»éš¾æµ‹è¯•çš„ä»£ç 
type TimeProvider interface {
    Now() time.Time
}

// æµ‹è¯•æ—¶ä½¿ç”¨mock
type MockTime struct {
    current time.Time
}

func (m *MockTime) Now() time.Time {
    return m.current
}
```

**Q4: è¦†ç›–ç‡ä¸‹é™æ€ä¹ˆåŠï¼Ÿ**
- è®¾ç½®CIæ£€æŸ¥é˜ˆå€¼
- Reviewæ—¶æ£€æŸ¥æ–°ä»£ç è¦†ç›–ç‡
- å®šæœŸå®¡æŸ¥ä½è¦†ç›–ç‡ä»£ç 

---

## 5. ğŸ“š ç›¸å…³èµ„æº

- [Go Coverage Tool](https://go.dev/blog/cover)
- [Codecov](https://codecov.io/)
- [Coveralls](https://coveralls.io/)

**ä¸‹ä¸€æ­¥**: [06-Mockä¸Stub](./06-Mockä¸Stub.md)

---

**æœ€åæ›´æ–°**: 2025-10-28
