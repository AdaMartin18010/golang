# 测试覆盖率

**版本**: v1.0
**更新日期**: 2025-10-29
**适用于**: Go 1.25.3

---

## 📋 目录

- [测试覆盖率](#测试覆盖率)
  - [📋 目录](#-目录)
  - [1. 📖 概念介绍](#1--概念介绍)
  - [2. 🎯 核心知识点](#2--核心知识点)
    - [2.1 生成覆盖率报告](#21-生成覆盖率报告)
    - [2.2 覆盖率模式](#22-覆盖率模式)
    - [2.3 指定覆盖包](#23-指定覆盖包)
    - [2.4 覆盖率分析](#24-覆盖率分析)
    - [2.5 提高覆盖率](#25-提高覆盖率)
    - [2.6 CI集成](#26-ci集成)
      - [GitHub Actions示例](#github-actions示例)
    - [2.7 覆盖率徽章](#27-覆盖率徽章)
  - [3. 💡 最佳实践](#3--最佳实践)
    - [3.1 设定合理目标](#31-设定合理目标)
    - [3.2 关注未覆盖的关键路径](#32-关注未覆盖的关键路径)
    - [3.3 忽略不需要测试的代码](#33-忽略不需要测试的代码)
    - [3.4 分包测试](#34-分包测试)
    - [3.5 覆盖率趋势监控](#35-覆盖率趋势监控)
  - [4. ⚠️ 常见问题](#4-️-常见问题)

## 1. 📖 概念介绍

测试覆盖率衡量测试执行了多少代码，帮助识别未测试的代码路径。Go提供内置的覆盖率工具，可以生成详细的覆盖率报告。

---

## 2. 🎯 核心知识点

### 2.1 生成覆盖率报告

```bash
# 运行测试并生成覆盖率
go test -cover

# 输出示例
PASS
coverage: 85.7% of statements
ok      mypackage    0.123s

# 生成详细报告
go test -coverprofile=coverage.out

# 查看HTML报告
go tool cover -html=coverage.out

# 在终端查看
go tool cover -func=coverage.out
```

---

### 2.2 覆盖率模式

```bash
# 默认模式：set（语句是否执行）
go test -covermode=set -coverprofile=coverage.out

# count模式：语句执行次数
go test -covermode=count -coverprofile=coverage.out

# atomic模式：并发安全的count
go test -covermode=atomic -coverprofile=coverage.out
```

---

### 2.3 指定覆盖包

```bash
# 只覆盖当前包
go test -cover

# 覆盖指定包
go test -coverpkg=./... -coverprofile=coverage.out

# 覆盖多个包
go test -coverpkg=./pkg/...,./internal/... -coverprofile=coverage.out
```

---

### 2.4 覆盖率分析

```go
// math.go
package math

func Add(a, b int) int {
    return a + b
}

func Divide(a, b int) (int, error) {
    if b == 0 {  // 分支1
        return 0, errors.New("division by zero")
    }
    return a / b, nil  // 分支2
}

func Multiply(a, b int) int {
    return a * b
}
```

```go
// math_test.go
package math

import "testing"

func TestAdd(t *testing.T) {
    if Add(2, 3) != 5 {
        t.Error("Add failed")
    }
}

func TestDivide(t *testing.T) {
    // 只测试正常情况，未测试除以零
    result, err := Divide(10, 2)
    if err != nil || result != 5 {
        t.Error("Divide failed")
    }
}

// Multiply函数未测试
```

运行覆盖率：

```bash
$ go test -cover
coverage: 66.7% of statements
```

查看详情：

```bash
$ go tool cover -func=coverage.out
math.go:3:      Add        100.0%
math.go:7:      Divide      50.0%  # 只覆盖了一个分支
math.go:14:     Multiply     0.0%  # 未覆盖
```

---

### 2.5 提高覆盖率

```go
// 补充测试
func TestDivideByZero(t *testing.T) {
    _, err := Divide(10, 0)
    if err == nil {
        t.Error("Expected error for division by zero")
    }
}

func TestMultiply(t *testing.T) {
    if Multiply(3, 4) != 12 {
        t.Error("Multiply failed")
    }
}
```

现在覆盖率：

```bash
$ go test -cover
coverage: 100.0% of statements
```

---

### 2.6 CI集成

#### GitHub Actions示例

```yaml
name: Test Coverage

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run tests with coverage
        run: go test -v -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          fail_ci_if_error: true

      - name: Check coverage threshold
        run: |
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "Coverage $coverage% is below 80%"
            exit 1
          fi
```

---

### 2.7 覆盖率徽章

```markdown
# README.md
[![codecov](https://codecov.io/gh/username/repo/branch/main/graph/badge.svg)](https://codecov.io/gh/username/repo)
```

---

## 3. 💡 最佳实践

### 3.1 设定合理目标

| 代码类型 | 推荐覆盖率 |
|---------|-----------|
| 核心业务逻辑 | 80-90% |
| 工具函数 | 70-80% |
| UI/展示层 | 50-60% |
| 整体项目 | 70-80% |

### 3.2 关注未覆盖的关键路径

```bash
# 查看未覆盖的代码
go tool cover -html=coverage.out

# 红色：未覆盖
# 绿色：已覆盖
```

### 3.3 忽略不需要测试的代码

```go
//go:build !test
// +build !test

package main

// 这个文件在测试时会被忽略
```

### 3.4 分包测试

```bash
# 每个包单独测试
for pkg in $(go list ./...); do
    go test -cover $pkg
done
```

### 3.5 覆盖率趋势监控

```bash
# 保存历史覆盖率
go test -coverprofile=coverage.out
echo "$(date): $(go tool cover -func=coverage.out | grep total | awk '{print $3}')" >> coverage-history.txt
```

---

## 4. ⚠️ 常见问题

**最后更新**: 2025-10-29
