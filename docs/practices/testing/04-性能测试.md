# æ€§èƒ½æµ‹è¯•

**éš¾åº¦**: ä¸­çº§ | **é¢„è®¡é˜…è¯»**: 20åˆ†é’Ÿ | **å‰ç½®çŸ¥è¯†**: åŸºå‡†æµ‹è¯•ã€pprof

---

## ğŸ“‹ ç›®å½•

- [1. ğŸ“– æ¦‚å¿µä»‹ç»](#1--æ¦‚å¿µä»‹ç»)
- [2. ğŸ¯ æ ¸å¿ƒçŸ¥è¯†ç‚¹](#2--æ ¸å¿ƒçŸ¥è¯†ç‚¹)
  - [2.1 åŸºå‡†æµ‹è¯•åŸºç¡€](#21-åŸºå‡†æµ‹è¯•åŸºç¡€)
  - [2.2 è¡¨æ ¼é©±åŠ¨åŸºå‡†æµ‹è¯•](#22-è¡¨æ ¼é©±åŠ¨åŸºå‡†æµ‹è¯•)
  - [2.3 é‡ç½®è®¡æ—¶å™¨](#23-é‡ç½®è®¡æ—¶å™¨)
  - [2.4 å¹¶è¡ŒåŸºå‡†æµ‹è¯•](#24-å¹¶è¡ŒåŸºå‡†æµ‹è¯•)
  - [2.5 å†…å­˜åˆ†é…åˆ†æ](#25-å†…å­˜åˆ†é…åˆ†æ)
  - [2.6 CPU Profiling](#26-cpu-profiling)
  - [2.7 å†…å­˜Profiling](#27-å†…å­˜profiling)
  - [2.8 æ€§èƒ½å¯¹æ¯”](#28-æ€§èƒ½å¯¹æ¯”)
- [3. ğŸ—ï¸ å®æˆ˜æ¡ˆä¾‹](#3-ï¸-å®æˆ˜æ¡ˆä¾‹)
- [4. ğŸ’¡ æœ€ä½³å®è·µ](#4--æœ€ä½³å®è·µ)
- [5. âš ï¸ å¸¸è§é—®é¢˜](#5-ï¸-å¸¸è§é—®é¢˜)
- [6. ğŸ“š ç›¸å…³èµ„æº](#6--ç›¸å…³èµ„æº)

---

## 1. ğŸ“– æ¦‚å¿µä»‹ç»

æ€§èƒ½æµ‹è¯•ç”¨äºè¡¡é‡ä»£ç çš„æ‰§è¡Œæ•ˆç‡ï¼ŒåŒ…æ‹¬åŸºå‡†æµ‹è¯•ï¼ˆBenchmarkï¼‰ã€æ€§èƒ½åˆ†æï¼ˆProfilingï¼‰å’Œå†…å­˜åˆ†æã€‚Goæä¾›äº†å¼ºå¤§çš„å†…ç½®å·¥å…·æ”¯æŒæ€§èƒ½æµ‹è¯•ã€‚

---

## 2. ğŸ¯ æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 2.1 åŸºå‡†æµ‹è¯•åŸºç¡€

```go
package benchmark

import "testing"

func Fibonacci(n int) int {
    if n < 2 {
        return n
    }
    return Fibonacci(n-1) + Fibonacci(n-2)
}

// åŸºå‡†æµ‹è¯•å‡½æ•°ä»¥Benchmarkå¼€å¤´
func BenchmarkFibonacci(b *testing.B) {
    for i := 0; i < b.N; i++ {
        Fibonacci(10)
    }
}

// è¿è¡Œï¼šgo test -bench=. -benchmem
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
BenchmarkFibonacci-8    2000000    855 ns/op    0 B/op    0 allocs/op
```

---

### 2.2 è¡¨æ ¼é©±åŠ¨åŸºå‡†æµ‹è¯•

```go
func BenchmarkFibonacci(b *testing.B) {
    benchmarks := []struct {
        name string
        n    int
    }{
        {"Fib10", 10},
        {"Fib20", 20},
        {"Fib30", 30},
    }
    
    for _, bm := range benchmarks {
        b.Run(bm.name, func(b *testing.B) {
            for i := 0; i < b.N; i++ {
                Fibonacci(bm.n)
            }
        })
    }
}

// è¿è¡Œï¼šgo test -bench=Fibonacci -benchmem
```

---

### 2.3 é‡ç½®è®¡æ—¶å™¨

```go
func BenchmarkWithSetup(b *testing.B) {
    // Setupï¼ˆä¸è®¡å…¥æ€§èƒ½æµ‹è¯•ï¼‰
    data := generateLargeDataset()
    
    b.ResetTimer() // é‡ç½®è®¡æ—¶å™¨
    
    for i := 0; i < b.N; i++ {
        processData(data)
    }
}
```

---

### 2.4 å¹¶è¡ŒåŸºå‡†æµ‹è¯•

```go
func BenchmarkParallel(b *testing.B) {
    b.RunParallel(func(pb *testing.PB) {
        for pb.Next() {
            // æµ‹è¯•ä»£ç 
            result := expensiveOperation()
            _ = result
        }
    })
}
```

---

### 2.5 å†…å­˜åˆ†é…åˆ†æ

```go
func BenchmarkStringConcat(b *testing.B) {
    b.ReportAllocs() // æŠ¥å‘Šå†…å­˜åˆ†é…
    
    for i := 0; i < b.N; i++ {
        var s string
        for j := 0; j < 100; j++ {
            s += "a"
        }
        _ = s
    }
}

func BenchmarkStringBuilder(b *testing.B) {
    b.ReportAllocs()
    
    for i := 0; i < b.N; i++ {
        var sb strings.Builder
        for j := 0; j < 100; j++ {
            sb.WriteString("a")
        }
        _ = sb.String()
    }
}

// å¯¹æ¯”ï¼š
// BenchmarkStringConcat-8      20000    82549 ns/op   503992 B/op    99 allocs/op
// BenchmarkStringBuilder-8    500000     2847 ns/op      512 B/op     3 allocs/op
```

---

### 2.6 CPU Profiling

```bash
# ç”ŸæˆCPU profile
go test -bench=. -cpuprofile=cpu.prof

# åˆ†æprofile
go tool pprof cpu.prof

# å¸¸ç”¨å‘½ä»¤
(pprof) top10          # æ˜¾ç¤ºå‰10ä¸ªå‡½æ•°
(pprof) list FuncName  # æ˜¾ç¤ºå‡½æ•°è¯¦æƒ…
(pprof) web            # ç”Ÿæˆè°ƒç”¨å›¾ï¼ˆéœ€è¦graphvizï¼‰
```

---

### 2.7 å†…å­˜Profiling

```bash
# ç”Ÿæˆå†…å­˜profile
go test -bench=. -memprofile=mem.prof

# åˆ†æ
go tool pprof mem.prof

(pprof) top            # æŒ‰å†…å­˜åˆ†é…æ’åº
(pprof) list FuncName  # æŸ¥çœ‹è¯¦æƒ…
```

---

### 2.8 æ€§èƒ½å¯¹æ¯”

```go
// ä¿å­˜åŸºå‡†ç»“æœ
go test -bench=. > old.txt

// ä¿®æ”¹ä»£ç å
go test -bench=. > new.txt

// å¯¹æ¯”
go install golang.org/x/perf/cmd/benchstat@latest
benchstat old.txt new.txt
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
name        old time/op    new time/op    delta
Fibonacci   855ns Â± 2%     721ns Â± 1%   -15.67%  (p=0.000 n=10+10)

name        old alloc/op   new alloc/op   delta
Fibonacci   0.00B          0.00B           ~     (all equal)
```

---

## 3. ğŸ—ï¸ å®æˆ˜æ¡ˆä¾‹

### 3.1 æ¡ˆä¾‹ï¼šä¼˜åŒ–JSONåºåˆ—åŒ–

```go
package benchmark

import (
    "encoding/json"
    "testing"
)

type User struct {
    ID    int    `json:"id"`
    Name  string `json:"name"`
    Email string `json:"email"`
}

// åŸå§‹æ–¹æ³•
func BenchmarkJSONMarshal(b *testing.B) {
    user := User{ID: 1, Name: "Alice", Email: "alice@example.com"}
    
    b.ReportAllocs()
    for i := 0; i < b.N; i++ {
        _, err := json.Marshal(user)
        if err != nil {
            b.Fatal(err)
        }
    }
}

// ä¼˜åŒ–ï¼šå¤ç”¨encoder
func BenchmarkJSONEncoder(b *testing.B) {
    user := User{ID: 1, Name: "Alice", Email: "alice@example.com"}
    
    b.ReportAllocs()
    for i := 0; i < b.N; i++ {
        buf := new(bytes.Buffer)
        enc := json.NewEncoder(buf)
        err := enc.Encode(user)
        if err != nil {
            b.Fatal(err)
        }
    }
}

// è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šé¢„åˆ†é…buffer
func BenchmarkJSONEncoderPrealloc(b *testing.B) {
    user := User{ID: 1, Name: "Alice", Email: "alice@example.com"}
    buf := new(bytes.Buffer)
    
    b.ReportAllocs()
    for i := 0; i < b.N; i++ {
        buf.Reset()
        enc := json.NewEncoder(buf)
        err := enc.Encode(user)
        if err != nil {
            b.Fatal(err)
        }
    }
}
```

---

## 4. ğŸ’¡ æœ€ä½³å®è·µ

### 4.1 åŸºå‡†æµ‹è¯•å‘½å
```go
// âœ… å¥½ï¼šæ¸…æ™°æè¿°æµ‹è¯•å†…å®¹
func BenchmarkFibonacci_Iterative(b *testing.B)
func BenchmarkFibonacci_Recursive(b *testing.B)

// âŒ å·®
func BenchmarkTest1(b *testing.B)
```

### 4.2 é¿å…ç¼–è¯‘å™¨ä¼˜åŒ–
```go
var result int

func BenchmarkSomething(b *testing.B) {
    var r int
    for i := 0; i < b.N; i++ {
        r = expensiveOperation()
    }
    result = r // é˜²æ­¢è¢«ä¼˜åŒ–æ‰
}
```

### 4.3 ä½¿ç”¨b.StopTimer/StartTimer
```go
func BenchmarkWithCleanup(b *testing.B) {
    for i := 0; i < b.N; i++ {
        b.StopTimer()
        setup()
        b.StartTimer()
        
        operation()
        
        b.StopTimer()
        cleanup()
        b.StartTimer()
    }
}
```

### 4.4 å¤šæ¬¡è¿è¡Œå–å¹³å‡
```bash
go test -bench=. -count=10
```

### 4.5 å›ºå®šCPUæ ¸å¿ƒæ•°
```bash
go test -bench=. -cpu=1,2,4,8
```

---

## 5. âš ï¸ å¸¸è§é—®é¢˜

**Q1: b.Næ˜¯ä»€ä¹ˆï¼Ÿ**
- testingæ¡†æ¶è‡ªåŠ¨è°ƒæ•´çš„è¿­ä»£æ¬¡æ•°
- ç¡®ä¿æµ‹è¯•è¿è¡Œè‡³å°‘1ç§’
- ä¸è¦åœ¨æµ‹è¯•ä¸­ä¿®æ”¹b.N

**Q2: å¦‚ä½•é€‰æ‹©åˆé€‚çš„åŸºå‡†æµ‹è¯•æ—¶é—´ï¼Ÿ**
```bash
# é»˜è®¤1ç§’
go test -bench=.

# è¿è¡Œ10ç§’ï¼ˆæ›´å‡†ç¡®ï¼‰
go test -bench=. -benchtime=10s

# è¿è¡Œå›ºå®šæ¬¡æ•°
go test -bench=. -benchtime=1000000x
```

**Q3: ä¸ºä»€ä¹ˆç»“æœä¸ç¨³å®šï¼Ÿ**
- CPUé¢‘ç‡è°ƒèŠ‚
- å…¶ä»–è¿›ç¨‹å¹²æ‰°
- GCå½±å“
- è§£å†³ï¼šå¤šæ¬¡è¿è¡Œã€ç¦ç”¨Turbo Boostã€å…³é—­å…¶ä»–ç¨‹åº

**Q4: å¦‚ä½•benchmark HTTP handlerï¼Ÿ**
```go
func BenchmarkHandler(b *testing.B) {
    handler := setupHandler()
    req := httptest.NewRequest("GET", "/", nil)
    
    b.ReportAllocs()
    for i := 0; i < b.N; i++ {
        rec := httptest.NewRecorder()
        handler.ServeHTTP(rec, req)
    }
}
```

---

## 6. ğŸ“š ç›¸å…³èµ„æº

- [Go Benchmark Guide](https://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go)
- [pprof Documentation](https://github.com/google/pprof)
- [benchstat Tool](https://pkg.go.dev/golang.org/x/perf/cmd/benchstat)

**ä¸‹ä¸€æ­¥**: [05-æµ‹è¯•è¦†ç›–ç‡](./05-æµ‹è¯•è¦†ç›–ç‡.md)

---

**æœ€åæ›´æ–°**: 2025-10-28
