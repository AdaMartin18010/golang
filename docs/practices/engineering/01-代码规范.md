# Go代码规范

**版本**: v1.0  
**更新日期**: 2025-10-29  
**适用于**: Go 1.25.3

---

> **难度**: ⭐⭐⭐
> **标签**: #代码规范 #风格指南 #最佳实践

## 📋 目录

- [1. 命名规范](#1-命名规范)
  - [包名](#包名)
  - [变量名](#变量名)
  - [常量名](#常量名)
  - [函数名](#函数名)
  - [接口名](#接口名)
  - [结构体名](#结构体名)
- [2. 代码风格](#2-代码风格)
  - [代码格式化](#代码格式化)
  - [import分组](#import分组)
  - [行宽](#行宽)
  - [函数长度](#函数长度)
  - [空行使用](#空行使用)
- [3. 注释规范](#3-注释规范)
  - [包注释](#包注释)
  - [函数注释](#函数注释)
  - [结构体注释](#结构体注释)
  - [代码内注释](#代码内注释)
- [4. 包组织](#4-包组织)
  - [项目结构](#项目结构)
  - [包导入](#包导入)
- [5. 错误处理](#5-错误处理)
  - [错误返回](#错误返回)
  - [错误包装](#错误包装)
  - [错误检查](#错误检查)
- [6. 并发编程](#6-并发编程)
  - [Goroutine启动](#goroutine启动)
  - [Channel使用](#channel使用)
  - [Context使用](#context使用)
- [🎯 代码审查清单](#代码审查清单)
  - [命名](#命名)
  - [格式](#格式)
  - [注释](#注释)
  - [错误处理](#错误处理)
  - [并发](#并发)
- [🔗 相关资源](#相关资源)

## 1. 命名规范

### 包名

```go
// ✅ 推荐：小写、简短、有意义
package http
package json
package user
package order

// ❌ 不推荐：驼峰、下划线、过长
package httpServer
package json_parser
package userManagementService
```

---

### 变量名

```go
// ✅ 推荐：驼峰命名、有意义
var userName string
var userCount int
var isActive bool

// 缩写要么全大写要么全小写
var userID string    // ✅
var userHTTPClient   // ✅
var userId string    // ❌
var userHttpClient   // ❌

// 局部变量可以简短
for i := 0; i < 10; i++ {    // ✅
    // ...
}

// 但要避免过于简短导致难以理解
var u string  // ❌ 不清楚u是什么
var user string  // ✅ 清晰明了
```

---

### 常量名

```go
// ✅ 推荐：驼峰命名
const MaxConnections = 100
const defaultTimeout = 30 * time.Second

// 包级常量使用大写开头（导出）
const (
    StatusPending  = "pending"
    StatusActive   = "active"
    StatusInactive = "inactive"
)

// 私有常量使用小写开头
const (
    minPoolSize = 1
    maxPoolSize = 100
)

// ❌ 不推荐：全大写蛇形命名（C风格）
const MAX_CONNECTIONS = 100
const DEFAULT_TIMEOUT = 30
```

---

### 函数名

```go
// ✅ 推荐：驼峰命名、动词开头
func GetUser(id string) (*User, error)
func CreateOrder(req *CreateOrderRequest) (*Order, error)
func UpdateUserEmail(userID, email string) error
func DeletePost(id string) error

// 布尔函数使用is/has/can前缀
func IsValid() bool
func HasPermission() bool
func CanAccess() bool

// ❌ 不推荐
func get_user(id string) (*User, error)  // 下划线
func userGet(id string) (*User, error)   // 名词开头
```

---

### 接口名

```go
// ✅ 推荐：单方法接口使用-er后缀
type Reader interface {
    Read(p []byte) (n int, err error)
}

type Writer interface {
    Write(p []byte) (n int, err error)
}

type Closer interface {
    Close() error
}

// 多方法接口使用有意义的名称
type UserRepository interface {
    Create(user *User) error
    FindByID(id string) (*User, error)
    Update(user *User) error
    Delete(id string) error
}

// ❌ 不推荐：IUser (C#风格), UserInterface
```

---

### 结构体名

```go
// ✅ 推荐：驼峰命名、名词
type User struct {
    ID       string
    Username string
    Email    string
}

type OrderItem struct {
    ProductID string
    Quantity  int
    Price     float64
}

// ❌ 不推荐
type user struct {  // 小写开头（除非是私有的）
    // ...
}

type UserStruct struct {  // 多余的Struct后缀
    // ...
}
```

---

## 2. 代码风格

### 代码格式化

```bash
# 使用gofmt格式化代码
gofmt -w .

# 使用goimports（自动管理import）
goimports -w .
```

---

### import分组

```go
// ✅ 推荐：分组并按字母排序
import (
    // 标准库
    "context"
    "encoding/json"
    "fmt"
    "net/http"
    "time"
    
    // 第三方库
    "github.com/gin-gonic/gin"
    "github.com/go-redis/redis/v8"
    "gorm.io/gorm"
    
    // 项目内部包
    "myapp/internal/model"
    "myapp/internal/service"
    "myapp/pkg/logger"
)

// ❌ 不推荐：混乱的import
import (
    "myapp/internal/model"
    "fmt"
    "github.com/gin-gonic/gin"
    "time"
    "myapp/pkg/logger"
)
```

---

### 行宽

```go
// ✅ 推荐：每行不超过120字符
func CreateUser(username, email, password string, age int, address string) (*User, error) {
    // ...
}

// 长函数调用换行
result, err := service.ProcessOrder(
    orderID,
    userID,
    paymentMethod,
    shippingAddress,
    billingAddress,
)

// ❌ 不推荐：过长的行
result, err := service.ProcessOrder(orderID, userID, paymentMethod, shippingAddress, billingAddress, discountCode, couponCode)
```

---

### 函数长度

```go
// ✅ 推荐：函数保持简短（<50行）
func ProcessOrder(order *Order) error {
    if err := validateOrder(order); err != nil {
        return err
    }
    
    if err := calculateTotal(order); err != nil {
        return err
    }
    
    if err := saveOrder(order); err != nil {
        return err
    }
    
    return nil
}

// ❌ 不推荐：超长函数（>100行）
func ProcessOrder(order *Order) error {
    // 100+ lines of code...
}
```

---

### 空行使用

```go
// ✅ 推荐：合理使用空行分隔逻辑块
func ProcessOrder(order *Order) error {
    // 验证
    if err := validateOrder(order); err != nil {
        return err
    }
    
    // 计算
    total := calculateTotal(order)
    discount := calculateDiscount(order)
    finalAmount := total - discount
    
    // 保存
    if err := saveOrder(order); err != nil {
        return err
    }
    
    return nil
}
```

---

## 3. 注释规范

### 包注释

```go
// ✅ 推荐：包注释在package语句之前
// Package user provides user management functionality.
// It includes user creation, authentication, and authorization.
package user

// ❌ 不推荐：缺少包注释
package user
```

---

### 函数注释

```go
// ✅ 推荐：以函数名开头，说明功能
// GetUser retrieves a user by their unique ID.
// It returns an error if the user is not found.
func GetUser(id string) (*User, error) {
    // ...
}

// CreateOrder creates a new order for the specified user.
// It validates the order items and calculates the total amount.
// Returns the created order or an error if validation fails.
func CreateOrder(userID string, items []OrderItem) (*Order, error) {
    // ...
}

// ❌ 不推荐：无注释或注释不清晰
func GetUser(id string) (*User, error) {
    // get user
}
```

---

### 结构体注释

```go
// ✅ 推荐：注释结构体和关键字段
// User represents a user in the system.
type User struct {
    // ID is the unique identifier for the user.
    ID string
    
    // Username is the user's login name.
    Username string
    
    // Email is the user's email address.
    Email string
    
    // CreatedAt is the timestamp when the user was created.
    CreatedAt time.Time
}
```

---

### 代码内注释

```go
// ✅ 推荐：解释为什么，而不是做什么
func CalculatePrice(basePrice float64, quantity int) float64 {
    // Apply bulk discount for orders over 100 items
    // to encourage large purchases
    if quantity > 100 {
        return basePrice * float64(quantity) * 0.9
    }
    
    return basePrice * float64(quantity)
}

// ❌ 不推荐：注释描述代码在做什么
func CalculatePrice(basePrice float64, quantity int) float64 {
    // Check if quantity is greater than 100
    if quantity > 100 {
        // Multiply base price by quantity and 0.9
        return basePrice * float64(quantity) * 0.9
    }
    
    // Multiply base price by quantity
    return basePrice * float64(quantity)
}
```

---

## 4. 包组织

### 项目结构

```text
myapp/
├── cmd/                    # 主程序入口
│   └── myapp/
│       └── main.go
├── internal/               # 私有代码
│   ├── handler/           # HTTP handlers
│   ├── service/           # 业务逻辑
│   ├── repository/        # 数据访问
│   └── model/             # 数据模型
├── pkg/                   # 公共库
│   ├── logger/
│   └── validator/
├── api/                   # API定义
├── configs/               # 配置文件
└── go.mod
```

---

### 包导入

```go
// ✅ 推荐：避免循环依赖
package handler

import "myapp/internal/service"  // handler → service

package service

import "myapp/internal/repository"  // service → repository

// ❌ 不推荐：循环依赖
package handler

import "myapp/internal/service"

package service

import "myapp/internal/handler"  // 循环依赖！
```

---

## 5. 错误处理

### 错误返回

```go
// ✅ 推荐：错误作为最后一个返回值
func GetUser(id string) (*User, error) {
    // ...
}

func ProcessOrder(order *Order) error {
    // ...
}

// ✅ 推荐：立即检查错误
user, err := GetUser(id)
if err != nil {
    return nil, fmt.Errorf("failed to get user: %w", err)
}

// ❌ 不推荐：忽略错误
user, _ := GetUser(id)
```

---

### 错误包装

```go
// ✅ 推荐：使用%w包装错误
func ProcessOrder(orderID string) error {
    order, err := getOrder(orderID)
    if err != nil {
        return fmt.Errorf("failed to get order %s: %w", orderID, err)
    }
    
    // ...
    return nil
}

// ❌ 不推荐：丢失原始错误
func ProcessOrder(orderID string) error {
    order, err := getOrder(orderID)
    if err != nil {
        return fmt.Errorf("failed to get order")  // 丢失了原始错误
    }
    
    // ...
    return nil
}
```

---

### 错误检查

```go
// ✅ 推荐：使用errors.Is和errors.As
if errors.Is(err, ErrNotFound) {
    // 处理未找到错误
}

var validationErr *ValidationError
if errors.As(err, &validationErr) {
    // 处理验证错误
}

// ❌ 不推荐：直接比较错误
if err == ErrNotFound {  // 无法处理包装的错误
    // ...
}
```

---

## 6. 并发编程

### Goroutine启动

```go
// ✅ 推荐：确保goroutine能够退出
func ProcessItems(ctx context.Context, items []Item) {
    for _, item := range items {
        item := item  // 捕获循环变量
        
        go func() {
            select {
            case <-ctx.Done():
                return
            default:
                process(item)
            }
        }()
    }
}

// ❌ 不推荐：goroutine可能泄漏
func ProcessItems(items []Item) {
    for _, item := range items {
        go func() {
            process(item)  // 可能一直运行
        }()
    }
}
```

---

### Channel使用

```go
// ✅ 推荐：关闭channel
func Producer(ch chan<- int) {
    defer close(ch)  // 确保关闭
    
    for i := 0; i < 10; i++ {
        ch <- i
    }
}

// ✅ 推荐：使用带缓冲的channel避免阻塞
ch := make(chan int, 10)

// ❌ 不推荐：不关闭channel
func Producer(ch chan<- int) {
    for i := 0; i < 10; i++ {
        ch <- i
    }
    // 忘记关闭，消费者会一直等待
}
```

---

### Context使用

```go
// ✅ 推荐：传递context
func ProcessRequest(ctx context.Context, req *Request) error {
    // 传递context到下层
    user, err := userService.GetUser(ctx, req.UserID)
    if err != nil {
        return err
    }
    
    // 使用context的超时
    ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
    defer cancel()
    
    return externalService.Call(ctx, user)
}

// ❌ 不推荐：不使用context
func ProcessRequest(req *Request) error {
    user, err := userService.GetUser(req.UserID)
    if err != nil {
        return err
    }
    
    return externalService.Call(user)
}
```

---

## 🎯 代码审查清单

### 命名

- [ ] 包名小写、简短
- [ ] 变量名驼峰、有意义
- [ ] 接口名使用-er后缀
- [ ] 常量使用驼峰命名

### 格式

- [ ] 代码已格式化（gofmt）
- [ ] import已分组排序
- [ ] 行宽<120字符
- [ ] 函数长度<50行

### 注释

- [ ] 包有注释
- [ ] 导出函数有注释
- [ ] 复杂逻辑有解释

### 错误处理

- [ ] 错误不被忽略
- [ ] 错误被正确包装
- [ ] 使用errors.Is/As

### 并发

- [ ] Goroutine能够退出
- [ ] Channel被正确关闭
- [ ] Context被正确传递

---

## 🔗 相关资源

- [测试规范](../testing/README.md)
- [文档规范](./02-文档规范.md)
- [Go官方代码规范](https://go.dev/doc/effective_go)

---

**最后更新**: 2025-10-29  
**Go版本**: 1.25.3
