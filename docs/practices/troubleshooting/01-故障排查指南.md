# æ•…éšœæ’æŸ¥æŒ‡å—

## ğŸ“‹ ç›®å½•


- [1. æ’æŸ¥æ–¹æ³•è®º](#1-æ’æŸ¥æ–¹æ³•è®º)
  - [ç³»ç»ŸåŒ–æ’æŸ¥æµç¨‹](#ç³»ç»ŸåŒ–æ’æŸ¥æµç¨‹)
  - [æ’æŸ¥å·¥å…·ç®±](#æ’æŸ¥å·¥å…·ç®±)
- [2. å¸¸è§æ•…éšœåˆ†ç±»](#2-å¸¸è§æ•…éšœåˆ†ç±»)
  - [æ•…éšœç—‡çŠ¶ä¸åŸå› å¯¹ç…§è¡¨](#æ•…éšœç—‡çŠ¶ä¸åŸå› å¯¹ç…§è¡¨)
- [3. æ€§èƒ½é—®é¢˜æ’æŸ¥](#3-æ€§èƒ½é—®é¢˜æ’æŸ¥)
  - [æ¡ˆä¾‹1: CPUå ç”¨100%](#æ¡ˆä¾‹1-cpuå ç”¨100)
  - [æ¡ˆä¾‹2: å“åº”æ—¶é—´P99çªç„¶å‡é«˜](#æ¡ˆä¾‹2-å“åº”æ—¶é—´p99çªç„¶å‡é«˜)
- [4. å†…å­˜é—®é¢˜æ’æŸ¥](#4-å†…å­˜é—®é¢˜æ’æŸ¥)
  - [æ¡ˆä¾‹1: å†…å­˜æŒç»­å¢é•¿å¯¼è‡´OOM](#æ¡ˆä¾‹1-å†…å­˜æŒç»­å¢é•¿å¯¼è‡´oom)
  - [æ¡ˆä¾‹2: Goroutineæ³„æ¼](#æ¡ˆä¾‹2-goroutineæ³„æ¼)
- [5. å¹¶å‘é—®é¢˜æ’æŸ¥](#5-å¹¶å‘é—®é¢˜æ’æŸ¥)
  - [æ¡ˆä¾‹1: Data Race](#æ¡ˆä¾‹1-data-race)
  - [æ¡ˆä¾‹2: æ­»é”](#æ¡ˆä¾‹2-æ­»é”)
- [6. ç½‘ç»œé—®é¢˜æ’æŸ¥](#6-ç½‘ç»œé—®é¢˜æ’æŸ¥)
  - [æ¡ˆä¾‹: TIME_WAITè¿‡å¤šå¯¼è‡´è¿æ¥å¤±è´¥](#æ¡ˆä¾‹-time_waitè¿‡å¤šå¯¼è‡´è¿æ¥å¤±è´¥)
- [7. æ•°æ®åº“é—®é¢˜æ’æŸ¥](#7-æ•°æ®åº“é—®é¢˜æ’æŸ¥)
  - [æ¡ˆä¾‹: æ•°æ®åº“è¿æ¥æ± è€—å°½](#æ¡ˆä¾‹-æ•°æ®åº“è¿æ¥æ± è€—å°½)
- [8. å®æˆ˜æ¡ˆä¾‹](#8-å®æˆ˜æ¡ˆä¾‹)
  - [ç»¼åˆæ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒå®Œæ•´æ’æŸ¥](#ç»¼åˆæ¡ˆä¾‹-ç”Ÿäº§ç¯å¢ƒå®Œæ•´æ’æŸ¥)
    - [ç¬¬1æ­¥: å¿«é€Ÿå®šä½ (5åˆ†é’Ÿ)](#ç¬¬1æ­¥-å¿«é€Ÿå®šä½-5åˆ†é’Ÿ)
    - [ç¬¬2æ­¥: ç¡®è®¤ä¾èµ– (3åˆ†é’Ÿ)](#ç¬¬2æ­¥-ç¡®è®¤ä¾èµ–-3åˆ†é’Ÿ)
    - [ç¬¬3æ­¥: æ·±å…¥åˆ†æ (10åˆ†é’Ÿ)](#ç¬¬3æ­¥-æ·±å…¥åˆ†æ-10åˆ†é’Ÿ)
    - [ç¬¬4æ­¥: æ‰¾åˆ°æ ¹å›  (5åˆ†é’Ÿ)](#ç¬¬4æ­¥-æ‰¾åˆ°æ ¹å› -5åˆ†é’Ÿ)
    - [ç¬¬5æ­¥: åº”æ€¥ä¿®å¤ (2åˆ†é’Ÿ)](#ç¬¬5æ­¥-åº”æ€¥ä¿®å¤-2åˆ†é’Ÿ)
    - [ç¬¬6æ­¥: éªŒè¯æ•ˆæœ (5åˆ†é’Ÿ)](#ç¬¬6æ­¥-éªŒè¯æ•ˆæœ-5åˆ†é’Ÿ)
    - [ç¬¬7æ­¥: å¤ç›˜ä¸é¢„é˜²](#ç¬¬7æ­¥-å¤ç›˜ä¸é¢„é˜²)
- [9. åº”æ€¥å“åº”](#9-åº”æ€¥å“åº”)
  - [åº”æ€¥å“åº”æµç¨‹](#åº”æ€¥å“åº”æµç¨‹)
  - [å¸¸ç”¨åº”æ€¥å‘½ä»¤](#å¸¸ç”¨åº”æ€¥å‘½ä»¤)
  - [åº”æ€¥å·¥å…·åŒ…](#åº”æ€¥å·¥å…·åŒ…)
- [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)

## 1. æ’æŸ¥æ–¹æ³•è®º

### ç³»ç»ŸåŒ–æ’æŸ¥æµç¨‹

```
1. é—®é¢˜å®šä¹‰
   â”œâ”€ æ”¶é›†ç—‡çŠ¶
   â”œâ”€ ç¡®å®šå½±å“èŒƒå›´
   â””â”€ è¯„ä¼°ä¸¥é‡ç¨‹åº¦
   
2. ä¿¡æ¯æ”¶é›†
   â”œâ”€ æ—¥å¿—åˆ†æ
   â”œâ”€ ç›‘æ§æŒ‡æ ‡
   â””â”€ ç¯å¢ƒä¿¡æ¯
   
3. å‡è®¾éªŒè¯
   â”œâ”€ æå‡ºå‡è®¾
   â”œâ”€ è®¾è®¡éªŒè¯
   â””â”€ æ‰§è¡Œæµ‹è¯•
   
4. æ ¹å› åˆ†æ
   â”œâ”€ æ‰¾åˆ°æ ¹æœ¬åŸå› 
   â”œâ”€ ç¡®è®¤å› æœå…³ç³»
   â””â”€ è®°å½•è¿‡ç¨‹
   
5. è§£å†³æ–¹æ¡ˆ
   â”œâ”€ å®æ–½ä¿®å¤
   â”œâ”€ éªŒè¯æ•ˆæœ
   â””â”€ å¤ç›˜æ€»ç»“
```

---

### æ’æŸ¥å·¥å…·ç®±

| å·¥å…· | ç”¨é€” | å‘½ä»¤ç¤ºä¾‹ |
|------|------|----------|
| **pprof** | CPU/å†…å­˜åˆ†æ | `go tool pprof cpu.prof` |
| **trace** | æ‰§è¡Œè¿½è¸ª | `go tool trace trace.out` |
| **delve** | è°ƒè¯•å™¨ | `dlv debug` |
| **strace** | ç³»ç»Ÿè°ƒç”¨è¿½è¸ª | `strace -p PID` |
| **netstat** | ç½‘ç»œè¿æ¥ | `netstat -antp` |
| **lsof** | æ–‡ä»¶å¥æŸ„ | `lsof -p PID` |
| **top/htop** | ç³»ç»Ÿèµ„æº | `top -p PID` |
| **dmesg** | ç³»ç»Ÿæ—¥å¿— | `dmesg | tail` |

---

## 2. å¸¸è§æ•…éšœåˆ†ç±»

### æ•…éšœç—‡çŠ¶ä¸åŸå› å¯¹ç…§è¡¨

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | æ’æŸ¥æ–¹å‘ |
|------|----------|----------|
| **CPUé«˜** | æ­»å¾ªç¯ã€çƒ­ç‚¹å‡½æ•°ã€GCé¢‘ç¹ | pprof CPUåˆ†æ |
| **å†…å­˜æŒç»­å¢é•¿** | å†…å­˜æ³„æ¼ã€ç¼“å­˜æ— ç•Œ | pprof heapåˆ†æ |
| **å“åº”æ…¢** | æ•°æ®åº“æ…¢æŸ¥è¯¢ã€é”ç«äº‰ã€ç½‘ç»œå»¶è¿Ÿ | traceåˆ†æ |
| **è¿æ¥æ•°å¢é•¿** | è¿æ¥æ³„æ¼ã€è¶…æ—¶é…ç½®ä¸å½“ | netstatæ£€æŸ¥ |
| **é¢‘ç¹panic** | ç©ºæŒ‡é’ˆã€æ•°ç»„è¶Šç•Œã€ç±»å‹æ–­è¨€ | æ—¥å¿—+è°ƒè¯• |
| **goroutineæ³„æ¼** | æœªå…³é—­channelã€æ— é€€å‡ºæœºåˆ¶ | goroutineåˆ†æ |
| **æ­»é”** | é”å¾ªç¯ä¾èµ–ã€channelé˜»å¡ | -raceæ£€æµ‹ |

---

## 3. æ€§èƒ½é—®é¢˜æ’æŸ¥

### æ¡ˆä¾‹1: CPUå ç”¨100%

**é—®é¢˜æè¿°**: æœåŠ¡CPUçªç„¶é£™å‡è‡³100%ï¼Œå“åº”å˜æ…¢

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. ç¡®è®¤æ˜¯å“ªä¸ªè¿›ç¨‹
top
# å‘ç°è¿›ç¨‹PID 12345å ç”¨CPU 95%

# 2. é‡‡é›†CPU profile
curl http://localhost:6060/debug/pprof/profile?seconds=30 > cpu.prof

# 3. åˆ†æçƒ­ç‚¹
go tool pprof cpu.prof
> top 10
> list functionName

# 4. æŸ¥çœ‹ç«ç„°å›¾
go tool pprof -http=:8080 cpu.prof
```

**æ¡ˆä¾‹åˆ†æ**:

```go
// é—®é¢˜ä»£ç 
func processData(data []byte) {
    var result string
    for i := 0; i < len(data); i++ {
        result += string(data[i])  // æ¯æ¬¡éƒ½é‡æ–°åˆ†é…ï¼
    }
    return result
}

// pprofè¾“å‡ºæ˜¾ç¤º:
// Total: 30s
// 28s (93.3%) runtime.concatstrings
//  1s ( 3.3%) processData
//  1s ( 3.3%) other
```

**ä¿®å¤æ–¹æ¡ˆ**:

```go
// ä¿®å¤å
func processData(data []byte) string {
    var builder strings.Builder
    builder.Grow(len(data))
    for i := 0; i < len(data); i++ {
        builder.WriteByte(data[i])
    }
    return builder.String()
}

// æ•ˆæœ: CPU 100% â†’ 15%
```

---

### æ¡ˆä¾‹2: å“åº”æ—¶é—´P99çªç„¶å‡é«˜

**é—®é¢˜æè¿°**: APIçš„P99å»¶è¿Ÿä»50msçªå‡åˆ°2ç§’

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æŸ¥çœ‹ç›‘æ§å›¾è¡¨
# å‘ç°åœ¨15:30å¼€å§‹å»¶è¿Ÿå¢åŠ 

# 2. æ£€æŸ¥æ—¥å¿—
tail -f /var/log/app.log | grep ERROR
# å‘ç°å¤§é‡"database connection timeout"

# 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥
curl http://localhost:6060/debug/pprof/goroutine?debug=1 | grep -A 10 "database"

# 4. æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
curl http://localhost:6060/debug/vars
```

**å‘ç°é—®é¢˜**:

```go
// æ•°æ®åº“è¿æ¥æ± é…ç½®
db.SetMaxOpenConns(10)     // å¤ªå°ï¼
db.SetMaxIdleConns(5)
db.SetConnMaxLifetime(time.Hour)

// ç›‘æ§æ˜¾ç¤º:
// - å¹¶å‘è¯·æ±‚: 100 QPS
// - æ¯ä¸ªè¯·æ±‚éœ€è¦è¿æ¥: 0.1ç§’
// - éœ€è¦è¿æ¥: 100 * 0.1 = 10ä¸ª
// - é…ç½®è¿æ¥: 10ä¸ª â† ä¸å¤Ÿç”¨ï¼
```

**ä¿®å¤æ–¹æ¡ˆ**:

```go
// å¢åŠ è¿æ¥æ± å¤§å°
db.SetMaxOpenConns(50)     // æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´
db.SetMaxIdleConns(25)
db.SetConnMaxLifetime(30 * time.Minute)
db.SetConnMaxIdleTime(10 * time.Minute)

// æ•ˆæœ: P99å»¶è¿Ÿ 2s â†’ 50ms
```

---

## 4. å†…å­˜é—®é¢˜æ’æŸ¥

### æ¡ˆä¾‹1: å†…å­˜æŒç»­å¢é•¿å¯¼è‡´OOM

**é—®é¢˜æè¿°**: æœåŠ¡è¿è¡Œ12å°æ—¶åå› OOMè¢«Kill

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. é‡‡é›†å¤šä¸ªæ—¶é—´ç‚¹çš„heapå¿«ç…§
curl http://localhost:6060/debug/pprof/heap > heap1.prof
sleep 3600  # ç­‰å¾…1å°æ—¶
curl http://localhost:6060/debug/pprof/heap > heap2.prof
sleep 3600
curl http://localhost:6060/debug/pprof/heap > heap3.prof

# 2. å¯¹æ¯”å¿«ç…§æ‰¾å‡ºå¢é•¿ç‚¹
go tool pprof -base=heap1.prof heap2.prof
> top 20 -cum

# 3. æŸ¥çœ‹å…·ä½“åˆ†é…
go tool pprof heap3.prof
> list suspiciousFunction
```

**å‘ç°é—®é¢˜**:

```go
// é—®é¢˜ä»£ç  - æ— ç•Œç¼“å­˜
type Cache struct {
    data map[string]*Entry  // æ°¸ä¸åˆ é™¤ï¼
    mu   sync.RWMutex
}

var globalCache = &Cache{
    data: make(map[string]*Entry),
}

func handleRequest(key string, value []byte) {
    globalCache.mu.Lock()
    globalCache.data[key] = &Entry{
        Value:     value,
        Timestamp: time.Now(),
    }
    globalCache.mu.Unlock()
}

// é—®é¢˜åˆ†æ:
// - æ¯å°æ—¶è¯·æ±‚: 10000
// - æ¯ä¸ªEntry: ~1KB
// - 12å°æ—¶ç´¯ç§¯: 10000 * 12 * 1KB = 120MB
// - å®é™…æµ‹é‡: 2GB (å­˜åœ¨å¤§å¯¹è±¡)
```

**ä¿®å¤æ–¹æ¡ˆ**:

```go
// æ–¹æ¡ˆ1: ä½¿ç”¨LRUç¼“å­˜
import "github.com/hashicorp/golang-lru"

type Cache struct {
    data *lru.Cache
    mu   sync.RWMutex
}

func NewCache() *Cache {
    cache, _ := lru.NewWithEvict(10000, func(key, value interface{}) {
        // æ¸…ç†å›è°ƒ
    })
    return &Cache{data: cache}
}

// æ–¹æ¡ˆ2: å®šæœŸæ¸…ç†
func (c *Cache) cleanup() {
    ticker := time.NewTicker(10 * time.Minute)
    defer ticker.Stop()
    
    for range ticker.C {
        c.mu.Lock()
        now := time.Now()
        for key, entry := range c.data {
            if now.Sub(entry.Timestamp) > time.Hour {
                delete(c.data, key)
            }
        }
        c.mu.Unlock()
    }
}

// æ•ˆæœ: å†…å­˜ç¨³å®šåœ¨200MB
```

---

### æ¡ˆä¾‹2: Goroutineæ³„æ¼

**é—®é¢˜æè¿°**: goroutineæ•°é‡æŒç»­å¢é•¿è‡³100K+

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æŸ¥çœ‹goroutineæ•°é‡
curl http://localhost:6060/debug/pprof/goroutine?debug=1 > goroutines.txt

# 2. åˆ†æå †æ ˆ
grep -C 5 "stuck" goroutines.txt

# 3. æ‰¾å‡ºé‡å¤çš„å †æ ˆ
sort goroutines.txt | uniq -c | sort -rn | head -20
```

**å‘ç°é—®é¢˜**:

```go
// é—®é¢˜ä»£ç 
func handleWebSocket(conn *websocket.Conn) {
    go func() {
        for {
            msg, err := conn.ReadMessage()
            if err != nil {
                log.Println(err)
                continue  // é”™è¯¯ï¼åº”è¯¥return
            }
            process(msg)
        }
    }()  // goroutineæ°¸ä¸é€€å‡º
}

// goroutineåˆ†ææ˜¾ç¤º:
// 99000 goroutines in: websocket.(*Conn).ReadMessage
//     é˜»å¡åœ¨å·²å…³é—­çš„è¿æ¥ä¸Š
```

**ä¿®å¤æ–¹æ¡ˆ**:

```go
// ä¿®å¤å
func handleWebSocket(ctx context.Context, conn *websocket.Conn) {
    go func() {
        defer conn.Close()
        
        for {
            select {
            case <-ctx.Done():
                return  // æ­£å¸¸é€€å‡º
            default:
                msg, err := conn.ReadMessage()
                if err != nil {
                    return  // è¿æ¥å…³é—­æ—¶é€€å‡º
                }
                process(msg)
            }
        }
    }()
}

// ä½¿ç”¨æ–¹å¼
ctx, cancel := context.WithCancel(context.Background())
defer cancel()
handleWebSocket(ctx, conn)

// æ•ˆæœ: goroutineæ•°é‡ç¨³å®šåœ¨100ä»¥ä¸‹
```

---

## 5. å¹¶å‘é—®é¢˜æ’æŸ¥

### æ¡ˆä¾‹1: Data Race

**é—®é¢˜æè¿°**: å¶ç°panicæˆ–æ•°æ®ä¸ä¸€è‡´

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. ä½¿ç”¨race detectorç¼–è¯‘è¿è¡Œ
go build -race
./myapp

# æˆ–åœ¨æµ‹è¯•ä¸­
go test -race ./...

# 2. æŸ¥çœ‹raceæŠ¥å‘Š
==================
WARNING: DATA RACE
Write at 0x00c000124010 by goroutine 7:
  main.updateCounter()
      /app/main.go:25 +0x50

Previous read at 0x00c000124010 by goroutine 6:
  main.getCounter()
      /app/main.go:30 +0x40
==================
```

**é—®é¢˜ä»£ç **:

```go
// âŒ é—®é¢˜ä»£ç 
type Stats struct {
    counter int64
}

func (s *Stats) Increment() {
    s.counter++  // éåŸå­æ“ä½œï¼
}

func (s *Stats) Get() int64 {
    return s.counter  // æ•°æ®ç«äº‰ï¼
}
```

**ä¿®å¤æ–¹æ¡ˆ**:

```go
// âœ… æ–¹æ¡ˆ1: ä½¿ç”¨atomic
type Stats struct {
    counter int64
}

func (s *Stats) Increment() {
    atomic.AddInt64(&s.counter, 1)
}

func (s *Stats) Get() int64 {
    return atomic.LoadInt64(&s.counter)
}

// âœ… æ–¹æ¡ˆ2: ä½¿ç”¨äº’æ–¥é”
type Stats struct {
    counter int64
    mu      sync.RWMutex
}

func (s *Stats) Increment() {
    s.mu.Lock()
    s.counter++
    s.mu.Unlock()
}

func (s *Stats) Get() int64 {
    s.mu.RLock()
    defer s.mu.RUnlock()
    return s.counter
}
```

---

### æ¡ˆä¾‹2: æ­»é”

**é—®é¢˜æè¿°**: æœåŠ¡å®Œå…¨hangä½ï¼Œæ— å“åº”

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. è·å–æ‰€æœ‰goroutineå †æ ˆ
curl http://localhost:6060/debug/pprof/goroutine?debug=2 > stacks.txt

# 2. æŸ¥æ‰¾æŒæœ‰é”çš„goroutine
grep -B 5 -A 10 "sync.(*Mutex).Lock" stacks.txt
```

**é—®é¢˜ä»£ç **:

```go
// âŒ æ­»é”åœºæ™¯
type Account struct {
    balance int
    mu      sync.Mutex
}

func transfer(from, to *Account, amount int) {
    from.mu.Lock()
    defer from.mu.Unlock()
    
    to.mu.Lock()      // å¯èƒ½æ­»é”ï¼
    defer to.mu.Unlock()
    
    from.balance -= amount
    to.balance += amount
}

// æ­»é”å‘ç”Ÿ:
// Goroutine 1: transfer(A, B, 100)  - æŒæœ‰Aé”ï¼Œç­‰å¾…Bé”
// Goroutine 2: transfer(B, A, 50)   - æŒæœ‰Bé”ï¼Œç­‰å¾…Aé”
// â†’ å¾ªç¯ç­‰å¾… â†’ æ­»é”ï¼
```

**ä¿®å¤æ–¹æ¡ˆ**:

```go
// âœ… ä¿®å¤: æŒ‰å›ºå®šé¡ºåºåŠ é”
func transfer(from, to *Account, amount int) {
    // ä¿è¯æ€»æ˜¯æŒ‰IDé¡ºåºåŠ é”
    if from.id < to.id {
        from.mu.Lock()
        defer from.mu.Unlock()
        to.mu.Lock()
        defer to.mu.Unlock()
    } else {
        to.mu.Lock()
        defer to.mu.Unlock()
        from.mu.Lock()
        defer from.mu.Unlock()
    }
    
    from.balance -= amount
    to.balance += amount
}
```

---

## 6. ç½‘ç»œé—®é¢˜æ’æŸ¥

### æ¡ˆä¾‹: TIME_WAITè¿‡å¤šå¯¼è‡´è¿æ¥å¤±è´¥

**é—®é¢˜æè¿°**: é«˜å¹¶å‘ä¸‹å‡ºç°"cannot assign requested address"

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æŸ¥çœ‹è¿æ¥çŠ¶æ€
netstat -an | grep TIME_WAIT | wc -l
# è¾“å‡º: 28000 (è¿‡å¤šï¼)

# 2. æŸ¥çœ‹ç³»ç»Ÿé™åˆ¶
cat /proc/sys/net/ipv4/ip_local_port_range
# è¾“å‡º: 32768  60999 (å¯ç”¨ç«¯å£: 28231)

# 3. æŸ¥çœ‹å“ªäº›è¿æ¥
netstat -antp | grep TIME_WAIT | head -20
```

**é—®é¢˜åˆ†æ**:

```go
// é—®é¢˜ä»£ç  - æ¯æ¬¡åˆ›å»ºæ–°è¿æ¥
func callAPI(url string) ([]byte, error) {
    resp, err := http.Get(url)  // é»˜è®¤transportä¸å¤ç”¨
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    
    return io.ReadAll(resp.Body)
}

// é—®é¢˜:
// - æ¯æ¬¡è¯·æ±‚æ–°å»ºè¿æ¥
// - è¿æ¥å…³é—­åè¿›å…¥TIME_WAIT (60ç§’)
// - é«˜å¹¶å‘å¯¼è‡´ç«¯å£è€—å°½
```

**ä¿®å¤æ–¹æ¡ˆ**:

```go
// âœ… ä¿®å¤: å¤ç”¨HTTPè¿æ¥
var httpClient = &http.Client{
    Transport: &http.Transport{
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
    },
    Timeout: 10 * time.Second,
}

func callAPI(url string) ([]byte, error) {
    resp, err := httpClient.Get(url)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    
    return io.ReadAll(resp.Body)
}

// ç³»ç»Ÿè°ƒä¼˜
// echo "1" > /proc/sys/net/ipv4/tcp_tw_reuse
// echo "10" > /proc/sys/net/ipv4/tcp_fin_timeout

// æ•ˆæœ: TIME_WAIT 28000 â†’ 200
```

---

## 7. æ•°æ®åº“é—®é¢˜æ’æŸ¥

### æ¡ˆä¾‹: æ•°æ®åº“è¿æ¥æ± è€—å°½

**é—®é¢˜æè¿°**: å¤§é‡è¯·æ±‚è¶…æ—¶ï¼Œæ—¥å¿—æ˜¾ç¤º"too many connections"

**æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æŸ¥çœ‹å½“å‰è¿æ¥æ•°
mysql> SHOW PROCESSLIST;
# æ˜¾ç¤º: 150ä¸ªè¿æ¥ï¼Œå¤§éƒ¨åˆ†SleepçŠ¶æ€

# 2. æŸ¥çœ‹åº”ç”¨è¿æ¥æ± çŠ¶æ€
curl http://localhost:6060/debug/vars | jq '.db_stats'

# 3. åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
tail -f /var/log/mysql/slow.log
```

**é—®é¢˜åˆ†æ**:

```go
// é—®é¢˜ä»£ç  - äº‹åŠ¡æœªæäº¤
func getUserOrders(userID string) ([]Order, error) {
    tx, _ := db.Begin()  // å¼€å¯äº‹åŠ¡
    
    rows, err := tx.Query("SELECT * FROM orders WHERE user_id = ?", userID)
    if err != nil {
        return nil, err  // å¿˜è®°å›æ»šï¼
    }
    defer rows.Close()
    
    var orders []Order
    for rows.Next() {
        var order Order
        rows.Scan(&order.ID, &order.Amount)
        orders = append(orders, order)
    }
    
    // å¿˜è®°æäº¤æˆ–å›æ»šï¼
    return orders, nil
}

// é—®é¢˜:
// - æ¯æ¬¡è°ƒç”¨éƒ½å¼€å¯äº‹åŠ¡ä½†ä¸å…³é—­
// - è¿æ¥ä¸€ç›´è¢«å ç”¨
// - æœ€ç»ˆè€—å°½è¿æ¥æ± 
```

**ä¿®å¤æ–¹æ¡ˆ**:

```go
// âœ… ä¿®å¤1: æ­£ç¡®ä½¿ç”¨äº‹åŠ¡
func getUserOrders(userID string) ([]Order, error) {
    tx, err := db.Begin()
    if err != nil {
        return nil, err
    }
    defer tx.Rollback()  // ç¡®ä¿å›æ»š
    
    rows, err := tx.Query("SELECT * FROM orders WHERE user_id = ?", userID)
    if err != nil {
        return nil, err
    }
    defer rows.Close()
    
    var orders []Order
    for rows.Next() {
        var order Order
        rows.Scan(&order.ID, &order.Amount)
        orders = append(orders, order)
    }
    
    tx.Commit()  // æ˜¾å¼æäº¤
    return orders, nil
}

// âœ… ä¿®å¤2: è¿™ä¸ªåœºæ™¯ä¸éœ€è¦äº‹åŠ¡
func getUserOrders(userID string) ([]Order, error) {
    rows, err := db.Query("SELECT * FROM orders WHERE user_id = ?", userID)
    if err != nil {
        return nil, err
    }
    defer rows.Close()
    
    var orders []Order
    for rows.Next() {
        var order Order
        rows.Scan(&order.ID, &order.Amount)
        orders = append(orders, order)
    }
    
    return orders, nil
}

// é…ç½®è¿æ¥æ± 
db.SetMaxOpenConns(50)
db.SetMaxIdleConns(25)
db.SetConnMaxLifetime(5 * time.Minute)

// æ•ˆæœ: è¿æ¥æ³„æ¼é—®é¢˜è§£å†³
```

---

## 8. å®æˆ˜æ¡ˆä¾‹

### ç»¼åˆæ¡ˆä¾‹: ç”Ÿäº§ç¯å¢ƒå®Œæ•´æ’æŸ¥

**èƒŒæ™¯**: 
- ç”µå•†APIæœåŠ¡
- çªç„¶æ”¶åˆ°å‘Šè­¦: P99å»¶è¿Ÿ > 5ç§’
- é”™è¯¯ç‡ä»0.1% â†’ 5%
- æ—¶é—´: å‡Œæ™¨3:00

**æ’æŸ¥è¿‡ç¨‹**:

#### ç¬¬1æ­¥: å¿«é€Ÿå®šä½ (5åˆ†é’Ÿ)

```bash
# 1. æŸ¥çœ‹ç›‘æ§å¤§ç›˜
# å‘ç°: CPUæ­£å¸¸30%, å†…å­˜æ­£å¸¸, ä½†QPSä¸‹é™50%

# 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -n 1000 /var/log/app/error.log | grep -i error
# å‘ç°å¤§é‡: "context deadline exceeded"

# 3. åˆæ­¥åˆ¤æ–­: ä¸‹æ¸¸æœåŠ¡è¶…æ—¶
```

#### ç¬¬2æ­¥: ç¡®è®¤ä¾èµ– (3åˆ†é’Ÿ)

```bash
# æ£€æŸ¥æ‰€æœ‰ä¸‹æ¸¸æœåŠ¡
for service in user product inventory; do
    echo "Checking $service..."
    curl -w "time: %{time_total}s\n" http://$service/health
done

# è¾“å‡º:
# user: time: 0.05s âœ“
# product: time: 0.08s âœ“
# inventory: time: 8.52s âœ—  â† é—®é¢˜åœ¨è¿™é‡Œï¼
```

#### ç¬¬3æ­¥: æ·±å…¥åˆ†æ (10åˆ†é’Ÿ)

```bash
# ç™»å½•inventoryæœåŠ¡å™¨
ssh inventory-01

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
top
# å‘ç°: CPU 100%, ä¸€ä¸ªè¿›ç¨‹å ç”¨

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep inventory
# PID: 12345

# é‡‡é›†CPU profile
curl http://localhost:6060/debug/pprof/profile?seconds=30 > cpu.prof

# åˆ†æ
go tool pprof cpu.prof
> top 10
# è¾“å‡º: checkStock å‡½æ•°å ç”¨95%
```

#### ç¬¬4æ­¥: æ‰¾åˆ°æ ¹å›  (5åˆ†é’Ÿ)

```go
// æŸ¥çœ‹ä»£ç 
func checkStock(productID string) (int, error) {
    // é—®é¢˜ä»£ç : æ¯æ¬¡éƒ½æ‰«æå…¨è¡¨ï¼
    rows, _ := db.Query("SELECT * FROM inventory")  // æ²¡æœ‰WHEREæ¡ä»¶
    defer rows.Close()
    
    for rows.Next() {
        var id string
        var stock int
        rows.Scan(&id, &stock)
        
        if id == productID {
            return stock, nil
        }
    }
    
    return 0, errors.New("not found")
}

// å‘ç°é—®é¢˜:
// - åº“å­˜è¡¨æœ‰100ä¸‡æ¡è®°å½•
// - æ¯æ¬¡æŸ¥è¯¢æ‰«æå…¨è¡¨
// - å‡Œæ™¨3ç‚¹æœ‰å®šæ—¶ä»»åŠ¡æ‰¹é‡æŸ¥è¯¢1000ä¸ªå•†å“
// - 1000 * å…¨è¡¨æ‰«æ = æ•°æ®åº“å´©æºƒ
```

#### ç¬¬5æ­¥: åº”æ€¥ä¿®å¤ (2åˆ†é’Ÿ)

```sql
-- ç«‹å³æ·»åŠ ç´¢å¼•
ALTER TABLE inventory ADD INDEX idx_product_id (product_id);
```

```bash
# é‡å¯æœåŠ¡
systemctl restart inventory-service

# éªŒè¯
curl http://inventory-01/health
# time: 0.05s âœ“ æ¢å¤æ­£å¸¸
```

#### ç¬¬6æ­¥: éªŒè¯æ•ˆæœ (5åˆ†é’Ÿ)

```bash
# ç›‘æ§å¤§ç›˜æ˜¾ç¤º:
# - P99å»¶è¿Ÿ: 5s â†’ 50ms âœ“
# - é”™è¯¯ç‡: 5% â†’ 0.1% âœ“
# - QPS: æ¢å¤åˆ°æ­£å¸¸å€¼ âœ“
```

#### ç¬¬7æ­¥: å¤ç›˜ä¸é¢„é˜²

**æ ¹æœ¬åŸå› **: 
- ä»£ç bug: ç¼ºå°‘WHEREæ¡ä»¶
- æœªæ·»åŠ æ•°æ®åº“ç´¢å¼•
- ç¼ºå°‘SQLå®¡æŸ¥æœºåˆ¶

**é¢„é˜²æªæ–½**:
1. ä»£ç å®¡æŸ¥: å¼ºåˆ¶reviewæ•°æ®åº“æŸ¥è¯¢
2. æ€§èƒ½æµ‹è¯•: æ·»åŠ å¤§æ•°æ®é‡æµ‹è¯•
3. ç›‘æ§å‘Šè­¦: æ…¢æŸ¥è¯¢ç›‘æ§
4. ç†”æ–­é™çº§: æ·»åŠ è¶…æ—¶å’Œç†”æ–­

---

## 9. åº”æ€¥å“åº”

### åº”æ€¥å“åº”æµç¨‹

```
1. å‘Šè­¦è§¦å‘ (Alert)
   â†“
2. å¿«é€Ÿè¯„ä¼° (Assess)
   - å½±å“èŒƒå›´
   - ä¸¥é‡ç¨‹åº¦
   â†“
3. æ­¢è¡€æªæ–½ (Mitigate)
   - å›æ»š
   - é™æµ
   - é™çº§
   â†“
4. æ ¹å› åˆ†æ (Analyze)
   â†“
5. æ°¸ä¹…ä¿®å¤ (Fix)
   â†“
6. å¤ç›˜æ€»ç»“ (Postmortem)
```

---

### å¸¸ç”¨åº”æ€¥å‘½ä»¤

```bash
# å¿«é€Ÿé‡å¯æœåŠ¡
systemctl restart myapp

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/myapp

# æ‰‹åŠ¨æ‰©å®¹
kubectl scale deployment myapp --replicas=10

# ä¸´æ—¶é™æµ
# åœ¨nginxä¸­
location /api/ {
    limit_req zone=mylimit burst=10;
}

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
kubectl logs -f deployment/myapp --tail=100

# è¿›å…¥å®¹å™¨æ’æŸ¥
kubectl exec -it myapp-pod-xxx -- /bin/sh
```

---

### åº”æ€¥å·¥å…·åŒ…

```go
// åº”æ€¥å¼€å…³ - åŠŸèƒ½é™çº§
var (
    enableCache   = true
    enableLogging = true
    enableAnalytics = false  // ç´§æ€¥æƒ…å†µä¸‹å…³é—­éå…³é”®åŠŸèƒ½
)

func handleRequest(w http.ResponseWriter, r *http.Request) {
    // æ£€æŸ¥é™çº§å¼€å…³
    if !enableLogging {
        // è·³è¿‡æ—¥å¿—è®°å½•
    }
    
    if !enableAnalytics {
        // è·³è¿‡åˆ†æç»Ÿè®¡
    }
    
    // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    processCore(w, r)
}

// åŠ¨æ€é…ç½® - æ— éœ€é‡å¯
func updateConfig() {
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()
    
    for range ticker.C {
        config := fetchConfigFromEtcd()
        enableCache = config.EnableCache
        enableLogging = config.EnableLogging
        enableAnalytics = config.EnableAnalytics
    }
}
```

---

## ğŸ”— ç›¸å…³èµ„æº

- [æ€§èƒ½åˆ†æå·¥å…·](../../advanced/performance/01-æ€§èƒ½åˆ†æå·¥å…·.md)
- [æ€§èƒ½è°ƒä¼˜å®æˆ˜](../../advanced/performance/06-æ€§èƒ½è°ƒä¼˜å®æˆ˜.md)
- [ç›‘æ§ç³»ç»Ÿ](../observability/01-ç›‘æ§ç³»ç»Ÿ.md)
- [æ—¥å¿—ç®¡ç†](../observability/02-æ—¥å¿—ç®¡ç†.md)

---

**æœ€åæ›´æ–°**: 2025-10-28  
**Goç‰ˆæœ¬**: 1.25.3  
**æ–‡æ¡£ç±»å‹**: å®æˆ˜æŒ‡å— âœ¨

