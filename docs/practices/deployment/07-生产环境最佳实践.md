# 生产环境最佳实践

**难度**: 高级 | **预计阅读**: 20分钟 | **前置知识**: 部署基础

---

## 📋 目录

- [1. 📖 概念介绍](#1--概念介绍)
- [2. 🔐 安全加固](#2--安全加固)
- [3. ⚡ 性能优化](#3--性能优化)
- [4. 📊 监控告警](#4--监控告警)
- [5. 🔄 故障恢复](#5--故障恢复)
- [6. 📝 日志管理](#6--日志管理)
- [7. 🎯 部署检查清单](#7--部署检查清单)
- [8. ⚠️ 常见陷阱](#8-️-常见陷阱)
- [9. 📚 相关资源](#9--相关资源)

---

## 1. 📖 概念介绍

生产环境部署需要考虑安全性、可靠性、可维护性等多个方面。本文总结Go应用生产部署的最佳实践。

---

## 2. 🔐 安全加固

### 2.1 最小权限原则

```dockerfile
# 使用非root用户
FROM alpine:latest

RUN addgroup -S appgroup && adduser -S appuser -G appgroup

USER appuser

COPY --chown=appuser:appgroup myapp /myapp

CMD ["/myapp"]
```

### 2.2 Secret管理

```go
// 不要硬编码Secret
// ❌ 错误
const dbPassword = "mypassword123"

// ✅ 正确：从环境变量读取
dbPassword := os.Getenv("DB_PASSWORD")
if dbPassword == "" {
    log.Fatal("DB_PASSWORD not set")
}
```

### 2.3 TLS配置

```go
tlsConfig := &tls.Config{
    MinVersion:               tls.VersionTLS12,
    PreferServerCipherSuites: true,
    CipherSuites: []uint16{
        tls.TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,
        tls.TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,
    },
}

server := &http.Server{
    TLSConfig: tlsConfig,
    // ...
}
```

---

## 3. ⚡ 性能优化

### 3.1 资源限制

```yaml
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"
```

### 3.2 连接池

```go
// 数据库连接池
db.SetMaxOpenConns(25)
db.SetMaxIdleConns(5)
db.SetConnMaxLifetime(5 * time.Minute)

// HTTP客户端复用
var httpClient = &http.Client{
    Timeout: 10 * time.Second,
    Transport: &http.Transport{
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
    },
}
```

### 3.3 优雅关闭

```go
func gracefulShutdown(srv *http.Server) {
    quit := make(chan os.Signal, 1)
    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
    <-quit
    
    log.Println("Shutting down server...")
    
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    
    if err := srv.Shutdown(ctx); err != nil {
        log.Fatal("Server forced to shutdown:", err)
    }
}
```

---

## 4. 📊 监控告警

### 4.1 关键指标

```go
var (
    // 请求指标
    httpRequestsTotal = promauto.NewCounterVec(...)
    httpRequestDuration = promauto.NewHistogramVec(...)
    
    // 业务指标
    ordersTotal = promauto.NewCounter(...)
    activeUsers = promauto.NewGauge(...)
)
```

### 4.2 告警规则

```yaml
# prometheus-alerts.yml
groups:
- name: app
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
    for: 5m
    annotations:
      summary: "High error rate detected"
  
  - alert: HighLatency
    expr: histogram_quantile(0.99, http_request_duration_seconds) > 1
    for: 5m
```

---

## 5. 🔄 故障恢复

### 5.1 健康检查

```go
func healthHandler(w http.ResponseWriter, r *http.Request) {
    // 检查数据库
    if err := db.Ping(); err != nil {
        w.WriteHeader(http.StatusServiceUnavailable)
        json.NewEncoder(w).Encode(map[string]string{
            "status": "unhealthy",
            "error":  err.Error(),
        })
        return
    }
    
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(map[string]string{
        "status": "healthy",
    })
}
```

### 5.2 自动重启

```yaml
# Kubernetes
spec:
  containers:
  - name: myapp
    livenessProbe:
      httpGet:
        path: /health
        port: 8080
      failureThreshold: 3
      periodSeconds: 10
```

### 5.3 备份策略

```bash
# 数据库备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump myapp > /backups/myapp_$DATE.sql
aws s3 cp /backups/myapp_$DATE.sql s3://backups/
```

---

## 6. 📝 日志管理

### 6.1 结构化日志

```go
logger.Info("User logged in",
    zap.String("user_id", userID),
    zap.String("ip", clientIP),
    zap.String("user_agent", userAgent),
)
```

### 6.2 日志级别

```
生产环境: INFO及以上
测试环境: DEBUG及以上
开发环境: ALL
```

### 6.3 敏感信息过滤

```go
// ❌ 不要记录密码
logger.Info("Login attempt", zap.String("password", password))

// ✅ 只记录必要信息
logger.Info("Login attempt", zap.String("username", username))
```

---

## 7. 🎯 部署检查清单

### 部署前
- [ ] 代码Review通过
- [ ] 测试覆盖率达标
- [ ] 安全扫描通过
- [ ] 性能测试通过
- [ ] 文档已更新

### 部署中
- [ ] 备份当前版本
- [ ] 通知相关人员
- [ ] 监控关键指标
- [ ] 准备回滚方案

### 部署后
- [ ] 验证功能正常
- [ ] 检查错误日志
- [ ] 监控性能指标
- [ ] 更新运维文档

---

## 8. ⚠️ 常见陷阱

1. **未配置资源限制** → Pod被OOM Kill
2. **缺少健康检查** → 失败的Pod仍接收流量
3. **未实现优雅关闭** → 请求中断
4. **日志过多** → 磁盘满
5. **未监控关键指标** → 问题发现太晚

---

## 9. 📚 相关资源

- [12-Factor App](https://12factor.net/)
- [Production Best Practices](https://kubernetes.io/docs/concepts/configuration/overview/)

---

**最后更新**: 2025-10-28
