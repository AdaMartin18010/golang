# 滚动更新

**版本**: v1.0
**更新日期**: 2025-10-29
**适用于**: Go 1.25.3

---
## 📋 目录

- [滚动更新](#滚动更新)
  - [1. 📖 概念介绍](#1-概念介绍)
  - [2. 🎯 更新策略](#2-更新策略)
- [deployment.yaml](#deploymentyaml)
- [蓝色环境（当前）](#蓝色环境当前)
- [绿色环境（新版本）](#绿色环境新版本)
- [Service切换](#service切换)
- [主版本 - 90%流量](#主版本-90流量)
- [金丝雀版本 - 10%流量](#金丝雀版本-10流量)
  - [3. 🔄 更新操作](#3-更新操作)
- [方式1：kubectl set image](#方式1kubectl-set-image)
- [方式2：kubectl apply](#方式2kubectl-apply)
- [查看更新状态](#查看更新状态)
- [查看更新历史](#查看更新历史)
- [暂停更新（用于金丝雀）](#暂停更新用于金丝雀)
- [观察指标](#观察指标)
- [...](#)
- [恢复更新](#恢复更新)
- [回滚到上一版本](#回滚到上一版本)
- [回滚到特定版本](#回滚到特定版本)
- [查看回滚状态](#查看回滚状态)
  - [4. 💡 最佳实践](#4-最佳实践)
  - [5. 📊 监控更新](#5-监控更新)
- [实时监控](#实时监控)
- [查看事件](#查看事件)
- [查看日志](#查看日志)
  - [6. ⚠️ 常见问题](#6-️-常见问题)

---

## 1. 📖 概念介绍

滚动更新是零停机部署的关键技术，通过逐步替换旧版本实例来更新应用，确保服务持续可用。

---

## 2. 🎯 更新策略

### 2.1 K8s滚动更新

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 4
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # 最多额外1个Pod
      maxUnavailable: 1  # 最多1个不可用
  template:
    spec:
      containers:
      - name: myapp
        image: myapp:v2
```

```text
初始: [v1] [v1] [v1] [v1]
步骤1: [v2] [v1] [v1] [v1]  # 创建v2
步骤2: [v2] [v2] [v1] [v1]  # v1变ready后创建v2
步骤3: [v2] [v2] [v2] [v1]
完成:  [v2] [v2] [v2] [v2]
```

---

### 2.2 蓝绿部署

```yaml
# 蓝色环境（当前）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-blue
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: myapp
        version: blue
---
# 绿色环境（新版本）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-green
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: myapp
        version: green
---
# Service切换
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp
    version: blue  # 切换到green即完成部署
```

---

### 2.3 金丝雀发布

```yaml
# 主版本 - 90%流量
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-stable
spec:
  replicas: 9  # 90%
---
# 金丝雀版本 - 10%流量
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-canary
spec:
  replicas: 1  # 10%
```

---

## 3. 🔄 更新操作

### 3.1 更新镜像

```bash
# 方式1：kubectl set image
kubectl set image deployment/myapp myapp=myapp:v2

# 方式2：kubectl apply
kubectl apply -f deployment.yaml

# 查看更新状态
kubectl rollout status deployment/myapp

# 查看更新历史
kubectl rollout history deployment/myapp
```

---

### 3.2 暂停和恢复

```bash
# 暂停更新（用于金丝雀）
kubectl rollout pause deployment/myapp

# 观察指标
# ...

# 恢复更新
kubectl rollout resume deployment/myapp
```

---

### 3.3 回滚

```bash
# 回滚到上一版本
kubectl rollout undo deployment/myapp

# 回滚到特定版本
kubectl rollout undo deployment/myapp --to-revision=2

# 查看回滚状态
kubectl rollout status deployment/myapp
```

---

## 4. 💡 最佳实践

### 4.1 健康检查

```yaml
readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5

livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 15
  periodSeconds: 20
```

### 4.2 优雅关闭

```go
func main() {
    srv := &http.Server{Addr: ":8080"}

    go func() {
        srv.ListenAndServe()
    }()

    // 等待中断信号
    quit := make(Channel os.Signal, 1)
    signal.Notify(quit, syscall.SIGTERM, syscall.SIGINT)
    <-quit

    // 30秒优雅关闭
    ctx, cancel := Context.WithTimeout(Context.Background(), 30*time.Second)
    defer cancel()

    if err := srv.Shutdown(ctx); err != nil {
        log.Fatal(err)
    }
}
```

### 4.3 更新策略

```yaml
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%      # 允许超出期望副本数25%
      maxUnavailable: 0  # 零停机
  minReadySeconds: 10    # 新Pod就绪后等待10秒
```

---

## 5. 📊 监控更新

```bash
# 实时监控
watch kubectl get pods

# 查看事件
kubectl get events --sort-by='.lastTimestamp'

# 查看日志
kubectl logs -f deployment/myapp
```

---

## 6. ⚠️ 常见问题
