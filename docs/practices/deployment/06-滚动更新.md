# æ»šåŠ¨æ›´æ–°

**éš¾åº¦**: ä¸­çº§ | **é¢„è®¡é˜…è¯»**: 15åˆ†é’Ÿ | **å‰ç½®çŸ¥è¯†**: KubernetesåŸºç¡€

---

## ğŸ“– æ¦‚å¿µä»‹ç»

æ»šåŠ¨æ›´æ–°æ˜¯é›¶åœæœºéƒ¨ç½²çš„å…³é”®æŠ€æœ¯ï¼Œé€šè¿‡é€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬å®ä¾‹æ¥æ›´æ–°åº”ç”¨ï¼Œç¡®ä¿æœåŠ¡æŒç»­å¯ç”¨ã€‚

---

## ğŸ¯ æ›´æ–°ç­–ç•¥

### 1. K8sæ»šåŠ¨æ›´æ–°

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 4
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # æœ€å¤šé¢å¤–1ä¸ªPod
      maxUnavailable: 1  # æœ€å¤š1ä¸ªä¸å¯ç”¨
  template:
    spec:
      containers:
      - name: myapp
        image: myapp:v2
```

**æ›´æ–°è¿‡ç¨‹**:
```
åˆå§‹: [v1] [v1] [v1] [v1]
æ­¥éª¤1: [v2] [v1] [v1] [v1]  # åˆ›å»ºv2
æ­¥éª¤2: [v2] [v2] [v1] [v1]  # v1å˜readyååˆ›å»ºv2
æ­¥éª¤3: [v2] [v2] [v2] [v1]
å®Œæˆ:  [v2] [v2] [v2] [v2]
```

---

### 2. è“ç»¿éƒ¨ç½²

```yaml
# è“è‰²ç¯å¢ƒï¼ˆå½“å‰ï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-blue
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: myapp
        version: blue
---
# ç»¿è‰²ç¯å¢ƒï¼ˆæ–°ç‰ˆæœ¬ï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-green
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: myapp
        version: green
---
# Serviceåˆ‡æ¢
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp
    version: blue  # åˆ‡æ¢åˆ°greenå³å®Œæˆéƒ¨ç½²
```

---

### 3. é‡‘ä¸é›€å‘å¸ƒ

```yaml
# ä¸»ç‰ˆæœ¬ - 90%æµé‡
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-stable
spec:
  replicas: 9  # 90%
---
# é‡‘ä¸é›€ç‰ˆæœ¬ - 10%æµé‡
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-canary
spec:
  replicas: 1  # 10%
```

---

## ğŸ”„ æ›´æ–°æ“ä½œ

### æ›´æ–°é•œåƒ

```bash
# æ–¹å¼1ï¼škubectl set image
kubectl set image deployment/myapp myapp=myapp:v2

# æ–¹å¼2ï¼škubectl apply
kubectl apply -f deployment.yaml

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status deployment/myapp

# æŸ¥çœ‹æ›´æ–°å†å²
kubectl rollout history deployment/myapp
```

---

### æš‚åœå’Œæ¢å¤

```bash
# æš‚åœæ›´æ–°ï¼ˆç”¨äºé‡‘ä¸é›€ï¼‰
kubectl rollout pause deployment/myapp

# è§‚å¯ŸæŒ‡æ ‡
# ...

# æ¢å¤æ›´æ–°
kubectl rollout resume deployment/myapp
```

---

### å›æ»š

```bash
# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/myapp

# å›æ»šåˆ°ç‰¹å®šç‰ˆæœ¬
kubectl rollout undo deployment/myapp --to-revision=2

# æŸ¥çœ‹å›æ»šçŠ¶æ€
kubectl rollout status deployment/myapp
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å¥åº·æ£€æŸ¥

```yaml
readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
  
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 15
  periodSeconds: 20
```

### 2. ä¼˜é›…å…³é—­

```go
func main() {
    srv := &http.Server{Addr: ":8080"}
    
    go func() {
        srv.ListenAndServe()
    }()
    
    // ç­‰å¾…ä¸­æ–­ä¿¡å·
    quit := make(chan os.Signal, 1)
    signal.Notify(quit, syscall.SIGTERM, syscall.SIGINT)
    <-quit
    
    // 30ç§’ä¼˜é›…å…³é—­
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    
    if err := srv.Shutdown(ctx); err != nil {
        log.Fatal(err)
    }
}
```

### 3. æ›´æ–°ç­–ç•¥

```yaml
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%      # å…è®¸è¶…å‡ºæœŸæœ›å‰¯æœ¬æ•°25%
      maxUnavailable: 0  # é›¶åœæœº
  minReadySeconds: 10    # æ–°Podå°±ç»ªåç­‰å¾…10ç§’
```

---

## ğŸ“Š ç›‘æ§æ›´æ–°

```bash
# å®æ—¶ç›‘æ§
watch kubectl get pods

# æŸ¥çœ‹äº‹ä»¶
kubectl get events --sort-by='.lastTimestamp'

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/myapp
```

---

## âš ï¸ å¸¸è§é—®é¢˜

**Q: å¦‚ä½•å®ç°é›¶åœæœºï¼Ÿ**
- è®¾ç½® `maxUnavailable: 0`
- é…ç½®æ­£ç¡®çš„å¥åº·æ£€æŸ¥
- å®ç°ä¼˜é›…å…³é—­

**Q: æ›´æ–°å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**
- è‡ªåŠ¨å›æ»šï¼ˆè®¾ç½® `progressDeadlineSeconds`ï¼‰
- æ‰‹åŠ¨å›æ»š `kubectl rollout undo`

**Q: å¦‚ä½•æµ‹è¯•æ–°ç‰ˆæœ¬ï¼Ÿ**
- é‡‘ä¸é›€å‘å¸ƒ
- è“ç»¿éƒ¨ç½²
- A/Bæµ‹è¯•

---

## ğŸ“š ç›¸å…³èµ„æº

- [K8s Rolling Update](https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro/)
- [Zero Downtime Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/)

**ä¸‹ä¸€æ­¥**: [07-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](./07-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ.md)

---

**æœ€åæ›´æ–°**: 2025-10-28

