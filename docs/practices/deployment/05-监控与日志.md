# 监控与日志

**难度**: 中级 | **预计阅读**: 20分钟 | **前置知识**: Prometheus、ELK基础

---

## 📋 目录

- [1. 📖 概念介绍](#1--概念介绍)
- [2. 🎯 监控系统](#2--监控系统)
  - [2.1 Prometheus监控](#21-prometheus监控)
  - [2.2 Grafana仪表板](#22-grafana仪表板)
- [3. 📝 日志系统](#3--日志系统)
  - [3.1 结构化日志](#31-结构化日志)
  - [3.2 日志级别](#32-日志级别)
  - [3.3 日志轮转](#33-日志轮转)
- [4. 📊 ELK Stack](#4--elk-stack)
- [5. 💡 最佳实践](#5--最佳实践)
- [6. 📚 相关资源](#6--相关资源)

---

## 1. 📖 概念介绍

监控和日志是生产环境运维的核心，帮助快速发现和定位问题。

---

## 2. 🎯 监控系统

### 2.1 Prometheus监控

```go
// metrics/metrics.go
package metrics

import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    // 请求计数器
    httpRequestsTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )
    
    // 请求延迟
    httpRequestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request latencies in seconds",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "endpoint"},
    )
)

// 中间件
func PrometheusMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        start := time.Now()
        
        // 执行请求
        next.ServeHTTP(w, r)
        
        // 记录指标
        duration := time.Since(start).Seconds()
        httpRequestDuration.WithLabelValues(r.Method, r.URL.Path).Observe(duration)
        httpRequestsTotal.WithLabelValues(r.Method, r.URL.Path, "200").Inc()
    })
}
```

暴露指标：
```go
import "github.com/prometheus/client_golang/prometheus/promhttp"

http.Handle("/metrics", promhttp.Handler())
```

---

### 2.2 Grafana仪表板

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'myapp'
    static_configs:
      - targets: ['localhost:8080']
    scrape_interval: 15s
```

---

## 3. 📝 日志系统

### 3.1 结构化日志

```go
// logger/logger.go
package logger

import (
    "go.uber.org/zap"
    "go.uber.org/zap/zapcore"
)

var Log *zap.Logger

func Init(env string) error {
    var config zap.Config
    
    if env == "production" {
        config = zap.NewProductionConfig()
    } else {
        config = zap.NewDevelopmentConfig()
    }
    
    config.EncoderConfig.TimeKey = "timestamp"
    config.EncoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder
    
    var err error
    Log, err = config.Build()
    return err
}

// 使用
logger.Log.Info("Server started",
    zap.String("port", "8080"),
    zap.String("env", "production"),
)
```

---

### 3.2 日志级别

```go
// 不同级别的日志
Log.Debug("Debug message", zap.Any("data", data))
Log.Info("Info message")
Log.Warn("Warning message")
Log.Error("Error message", zap.Error(err))
Log.Fatal("Fatal message") // 会退出程序
```

---

### 3.3 日志轮转

```yaml
# docker-compose.yml
services:
  app:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

---

## 4. 📊 ELK Stack

### 4.1 Filebeat配置

```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/myapp/*.log
  json.keys_under_root: true
  json.add_error_key: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]

setup.kibana:
  host: "kibana:5601"
```

---

### 4.2 完整监控栈

```yaml
# docker-compose.monitoring.yml
version: '3'

services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
  
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
  
  elasticsearch:
    image: elasticsearch:8.10.0
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"
  
  kibana:
    image: kibana:8.10.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
```

---

## 5. 💡 最佳实践

1. **关键指标**
   - 请求率 (RPS)
   - 错误率
   - 响应时间 (P50, P95, P99)
   - 资源使用 (CPU, Memory)

2. **告警规则**
   - 错误率 > 1%
   - P99延迟 > 1s
   - CPU > 80%
   - 内存 > 90%

3. **日志规范**
   - 使用结构化日志
   - 包含请求ID
   - 记录关键事件
   - 避免敏感信息

---

## 6. 📚 相关资源

- [Prometheus](https://prometheus.io/)
- [Grafana](https://grafana.com/)
- [Zap Logger](https://github.com/uber-go/zap)

**下一步**: [06-滚动更新](./06-滚动更新.md)

---

**最后更新**: 2025-10-28
