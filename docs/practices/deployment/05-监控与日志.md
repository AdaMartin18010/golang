# ç›‘æ§ä¸æ—¥å¿—

**éš¾åº¦**: ä¸­çº§ | **é¢„è®¡é˜…è¯»**: 20åˆ†é’Ÿ | **å‰ç½®çŸ¥è¯†**: Prometheusã€ELKåŸºç¡€

---

## ğŸ“‹ ç›®å½•

- [1. ğŸ“– æ¦‚å¿µä»‹ç»](#1--æ¦‚å¿µä»‹ç»)
- [2. ğŸ¯ ç›‘æ§ç³»ç»Ÿ](#2--ç›‘æ§ç³»ç»Ÿ)
  - [2.1 Prometheusç›‘æ§](#21-prometheusç›‘æ§)
  - [2.2 Grafanaä»ªè¡¨æ¿](#22-grafanaä»ªè¡¨æ¿)
- [3. ğŸ“ æ—¥å¿—ç³»ç»Ÿ](#3--æ—¥å¿—ç³»ç»Ÿ)
  - [3.1 ç»“æ„åŒ–æ—¥å¿—](#31-ç»“æ„åŒ–æ—¥å¿—)
  - [3.2 æ—¥å¿—çº§åˆ«](#32-æ—¥å¿—çº§åˆ«)
  - [3.3 æ—¥å¿—è½®è½¬](#33-æ—¥å¿—è½®è½¬)
- [4. ğŸ“Š ELK Stack](#4--elk-stack)
- [5. ğŸ’¡ æœ€ä½³å®è·µ](#5--æœ€ä½³å®è·µ)
- [6. ğŸ“š ç›¸å…³èµ„æº](#6--ç›¸å…³èµ„æº)

---

## 1. ğŸ“– æ¦‚å¿µä»‹ç»

ç›‘æ§å’Œæ—¥å¿—æ˜¯ç”Ÿäº§ç¯å¢ƒè¿ç»´çš„æ ¸å¿ƒï¼Œå¸®åŠ©å¿«é€Ÿå‘ç°å’Œå®šä½é—®é¢˜ã€‚

---

## 2. ğŸ¯ ç›‘æ§ç³»ç»Ÿ

### 2.1 Prometheusç›‘æ§

```go
// metrics/metrics.go
package metrics

import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    // è¯·æ±‚è®¡æ•°å™¨
    httpRequestsTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )
    
    // è¯·æ±‚å»¶è¿Ÿ
    httpRequestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request latencies in seconds",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "endpoint"},
    )
)

// ä¸­é—´ä»¶
func PrometheusMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        start := time.Now()
        
        // æ‰§è¡Œè¯·æ±‚
        next.ServeHTTP(w, r)
        
        // è®°å½•æŒ‡æ ‡
        duration := time.Since(start).Seconds()
        httpRequestDuration.WithLabelValues(r.Method, r.URL.Path).Observe(duration)
        httpRequestsTotal.WithLabelValues(r.Method, r.URL.Path, "200").Inc()
    })
}
```

æš´éœ²æŒ‡æ ‡ï¼š
```go
import "github.com/prometheus/client_golang/prometheus/promhttp"

http.Handle("/metrics", promhttp.Handler())
```

---

### 2.2 Grafanaä»ªè¡¨æ¿

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'myapp'
    static_configs:
      - targets: ['localhost:8080']
    scrape_interval: 15s
```

---

## 3. ğŸ“ æ—¥å¿—ç³»ç»Ÿ

### 3.1 ç»“æ„åŒ–æ—¥å¿—

```go
// logger/logger.go
package logger

import (
    "go.uber.org/zap"
    "go.uber.org/zap/zapcore"
)

var Log *zap.Logger

func Init(env string) error {
    var config zap.Config
    
    if env == "production" {
        config = zap.NewProductionConfig()
    } else {
        config = zap.NewDevelopmentConfig()
    }
    
    config.EncoderConfig.TimeKey = "timestamp"
    config.EncoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder
    
    var err error
    Log, err = config.Build()
    return err
}

// ä½¿ç”¨
logger.Log.Info("Server started",
    zap.String("port", "8080"),
    zap.String("env", "production"),
)
```

---

### 3.2 æ—¥å¿—çº§åˆ«

```go
// ä¸åŒçº§åˆ«çš„æ—¥å¿—
Log.Debug("Debug message", zap.Any("data", data))
Log.Info("Info message")
Log.Warn("Warning message")
Log.Error("Error message", zap.Error(err))
Log.Fatal("Fatal message") // ä¼šé€€å‡ºç¨‹åº
```

---

### 3.3 æ—¥å¿—è½®è½¬

```yaml
# docker-compose.yml
services:
  app:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

---

## 4. ğŸ“Š ELK Stack

### 4.1 Filebeaté…ç½®

```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/myapp/*.log
  json.keys_under_root: true
  json.add_error_key: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]

setup.kibana:
  host: "kibana:5601"
```

---

### 4.2 å®Œæ•´ç›‘æ§æ ˆ

```yaml
# docker-compose.monitoring.yml
version: '3'

services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
  
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
  
  elasticsearch:
    image: elasticsearch:8.10.0
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"
  
  kibana:
    image: kibana:8.10.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
```

---

## 5. ğŸ’¡ æœ€ä½³å®è·µ

1. **å…³é”®æŒ‡æ ‡**
   - è¯·æ±‚ç‡ (RPS)
   - é”™è¯¯ç‡
   - å“åº”æ—¶é—´ (P50, P95, P99)
   - èµ„æºä½¿ç”¨ (CPU, Memory)

2. **å‘Šè­¦è§„åˆ™**
   - é”™è¯¯ç‡ > 1%
   - P99å»¶è¿Ÿ > 1s
   - CPU > 80%
   - å†…å­˜ > 90%

3. **æ—¥å¿—è§„èŒƒ**
   - ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
   - åŒ…å«è¯·æ±‚ID
   - è®°å½•å…³é”®äº‹ä»¶
   - é¿å…æ•æ„Ÿä¿¡æ¯

---

## 6. ğŸ“š ç›¸å…³èµ„æº

- [Prometheus](https://prometheus.io/)
- [Grafana](https://grafana.com/)
- [Zap Logger](https://github.com/uber-go/zap)

**ä¸‹ä¸€æ­¥**: [06-æ»šåŠ¨æ›´æ–°](./06-æ»šåŠ¨æ›´æ–°.md)

---

**æœ€åæ›´æ–°**: 2025-10-28
