# 语义化版本 (Semantic Versioning)

> 📚 **简介**
>
> 本文详细讲解语义化版本控制规范（Semantic Versioning，简称 SemVer），这是 Go Modules 依赖管理的核心基础。理解语义化版本对于正确管理依赖、发布模块至关重要。
>
> 通过本文，您将掌握版本号的含义、升级规则和最佳实践。

<!-- TOC START -->
## 📋 目录

- [版本号格式](#版本号格式)
- [版本升级规则](#版本升级规则)
- [Go 中的版本](#go-中的版本)
- [版本选择](#版本选择)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)
<!-- TOC END -->

---

## 📚 版本号格式

### 基本格式

```text
v主版本号.次版本号.修订号

示例: v1.2.3
```

### 各部分含义

```text
v MAJOR . MINOR . PATCH
  │       │       └─ 修订号: 向后兼容的问题修正
  │       └───────── 次版本号: 向后兼容的功能新增
  └───────────────── 主版本号: 不兼容的 API 修改
```

| 版本部分 | 何时升级 | 示例 |
|---------|---------|------|
| **MAJOR** | API 不兼容变更 | v1.0.0 → v2.0.0 |
| **MINOR** | 新增功能，向后兼容 | v1.1.0 → v1.2.0 |
| **PATCH** | Bug 修复，向后兼容 | v1.1.1 → v1.1.2 |

### 预发布版本

```text
v1.0.0-alpha       # Alpha 版本
v1.0.0-beta.1      # Beta 版本 1
v1.0.0-rc.2        # Release Candidate 2
```

**格式**: `vMAJOR.MINOR.PATCH-prerelease+buildmetadata`

### 构建元数据

```text
v1.0.0+20131313     # 带构建元数据
v1.0.0-beta+exp.sha.5114f85  # 预发布版本带元数据
```

---

## 🔄 版本升级规则

### MAJOR 版本升级

**何时升级**: 不兼容的 API 变更

```go
// v1.0.0 - 原 API
func Connect(host string, port int) error

// v2.0.0 - 不兼容的变更
func Connect(config *Config) error  // 参数类型改变
```

**示例**:
- 移除公共 API
- 修改函数签名
- 改变现有行为

### MINOR 版本升级

**何时升级**: 新增功能，保持向后兼容

```go
// v1.0.0 - 原 API
func Connect(host string) error

// v1.1.0 - 新增功能
func Connect(host string) error       // 保留
func ConnectWithTimeout(host string, timeout time.Duration) error  // 新增
```

**示例**:
- 添加新函数
- 添加新类型
- 废弃（deprecate）旧 API，但保留

### PATCH 版本升级

**何时升级**: Bug 修复，完全兼容

```go
// v1.0.0 - 有 bug
func Calculate(a, b int) int {
    return a + b * 2  // bug: 应该是 (a + b) * 2
}

// v1.0.1 - 修复 bug
func Calculate(a, b int) int {
    return (a + b) * 2  // 修复
}
```

**示例**:
- 修复 bug
- 性能优化
- 文档更新

---

## 🐹 Go 中的版本

### v0 版本

```text
v0.1.0  # 初始开发阶段
v0.2.0  # API 可能随时变化
v0.9.0  # 接近稳定
```

**特点**:
- 表示不稳定的开发阶段
- API 可能随时发生重大变更
- 不保证兼容性

### v1+ 稳定版本

```text
v1.0.0  # 第一个稳定版本
v1.1.0  # 新增功能
v1.2.0  # 更多功能
v1.2.1  # Bug 修复
```

**承诺**:
- API 保持向后兼容
- 遵循语义化版本规则
- 慎重对待破坏性变更

### v2+ 主版本

```go
// 模块路径需要包含版本号
module github.com/user/project/v2

// 导入时也需要带版本
import "github.com/user/project/v2/pkg"
```

**规则**:
- v2+ 需要在模块路径中包含版本后缀
- 可以与 v0/v1 同时存在
- 被视为不同的模块

---

## 🎯 版本选择

### 最小版本选择 (MVS)

Go 使用 MVS 算法选择依赖版本：

```text
依赖关系:
A → B v1.2.0
A → C v1.0.0
C → B v1.1.0

结果: 选择 B v1.2.0 (所有要求的最小版本中的最大版本)
```

### 版本约束

```go
require github.com/package v1.2.3

// Go 会选择 >= v1.2.3 的版本
// 但倾向于 v1.2.3（除非有更高的间接要求）
```

### 版本范围

Go Modules 不支持版本范围，只指定最小版本：

```go
// ✅ Go 方式
require github.com/package v1.2.0

// ❌ 不支持
require github.com/package ^1.2.0   // npm 风格
require github.com/package ~1.2.0   // npm 风格
```

---

## 💻 实践示例

### 发布新版本

#### 1. 修复 Bug (PATCH)

```bash
# 1. 修复代码
# 2. 更新版本
git tag v1.0.1
git push origin v1.0.1
```

#### 2. 添加新功能 (MINOR)

```bash
# 1. 添加新功能
# 2. 确保向后兼容
# 3. 更新版本
git tag v1.1.0
git push origin v1.1.0
```

#### 3. 破坏性变更 (MAJOR)

```bash
# 1. 更新 go.mod
module github.com/user/project/v2

# 2. 提交变更
git tag v2.0.0
git push origin v2.0.0
```

### 使用特定版本

```bash
# 安装特定版本
go get github.com/package@v1.2.3

# 安装最新版本
go get github.com/package@latest

# 安装指定主版本的最新版本
go get github.com/package@v2
```

---

## 🎯 最佳实践

### 1. 版本号起点

```text
v0.1.0    # ✅ 开发阶段起点
v1.0.0    # ✅ 第一个稳定版本
v0.0.1    # ⚠️  不推荐，语义不清晰
```

### 2. 兼容性承诺

#### v0.x.x 阶段

```go
// ✅ 可以自由修改 API
v0.1.0 → v0.2.0  // API 重大变更
```

#### v1.x.x 阶段

```go
// ✅ 必须保持兼容性
v1.0.0 → v1.1.0  // 只能新增
v1.1.0 → v1.1.1  // 只能修复

// ❌ 不能破坏兼容性
v1.0.0 → v1.1.0  // 不能改变现有 API
```

### 3. 版本发布流程

```bash
# 1. 开发新功能
git checkout -b feature/new-feature

# 2. 合并到主分支
git checkout main
git merge feature/new-feature

# 3. 运行测试
go test ./...

# 4. 打标签
git tag -a v1.1.0 -m "Add new feature"

# 5. 推送
git push origin main --tags
```

### 4. 废弃功能

```go
// 不要立即删除，先标记为废弃
// v1.5.0
// Deprecated: Use NewFunction instead.
func OldFunction() {
    NewFunction()
}

// v2.0.0 时才可以删除
```

### 5. v2+ 迁移

```bash
# 1. 创建新的主版本
cp -r . ../project-v2
cd ../project-v2

# 2. 更新 go.mod
module github.com/user/project/v2

# 3. 更新导入路径
find . -name "*.go" -exec sed -i 's|github.com/user/project|github.com/user/project/v2|g' {} +

# 4. 测试并发布
go test ./...
git tag v2.0.0
```

---

## ❓ 常见问题

### Q1: v0 版本何时升级到 v1？

**条件**:
- API 基本稳定
- 功能相对完善
- 准备好维护兼容性

```bash
# 标记为 v1.0.0
git tag v1.0.0
```

### Q2: 如何处理破坏性变更？

**选项 1**: 升级主版本
```bash
git tag v2.0.0
```

**选项 2**: 提供兼容层
```go
// 保留旧 API
func OldAPI() { /* ... */ }

// 添加新 API
func NewAPI() { /* ... */ }
```

### Q3: 预发布版本如何使用？

```bash
# 发布 alpha 版本
git tag v1.1.0-alpha

# 安装预发布版本
go get github.com/package@v1.1.0-alpha

# 升级到稳定版本
go get github.com/package@v1.1.0
```

### Q4: +incompatible 是什么？

```go
require github.com/package v2.0.0+incompatible
```

**含义**: v2+ 模块未使用正确的模块路径

**解决**: 使用正确的导入路径
```go
module github.com/package/v2
```

### Q5: 如何查看版本历史？

```bash
# 列出所有版本
go list -m -versions github.com/package

# 输出示例
github.com/package v1.0.0 v1.1.0 v1.2.0 v2.0.0
```

---

## 🔗 相关链接

- [Go Modules 简介](./01-Go-Modules简介.md)
- [go.mod 文件详解](./02-go-mod文件详解.md)
- [依赖管理](./06-依赖管理.md)
- [版本选择](./07-版本选择.md)

---

## 📚 参考资料

- [Semantic Versioning 2.0.0](https://semver.org/)
- [Go Modules: v2 and Beyond](https://go.dev/blog/v2-go-modules)
- [Minimal Version Selection](https://research.swtch.com/vgo-mvs)

---

**文档维护者**: Go Documentation Team  
**最后更新**: 2025年10月20日  
**文档状态**: 完成  
**适用版本**: Go 1.21+
