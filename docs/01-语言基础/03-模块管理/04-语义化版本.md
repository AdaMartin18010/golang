# 语义化版本

> 📚 **简介**
>
> 本文详细介绍语义化版本规范（Semantic Versioning）在Go模块中的应用。内容涵盖版本号格式、版本选择规则、主版本管理等核心概念。
>
> 通过本文，您将掌握如何正确使用和管理Go模块版本，避免依赖冲突。

<!-- TOC START -->
- [语义化版本](#语义化版本)
  - [1. 📚 语义化版本概述](#1--语义化版本概述)
    - [1.1 什么是语义化版本](#11-什么是语义化版本)
    - [1.2 在Go中的应用](#12-在go中的应用)
  - [2. 📝 版本号格式](#2--版本号格式)
    - [2.1 标准格式](#21-标准格式)
    - [2.2 版本号组成](#22-版本号组成)
    - [2.3 Go模块特殊规则](#23-go模块特殊规则)
  - [3. 💻 版本升级规则](#3--版本升级规则)
    - [3.1 何时升级主版本](#31-何时升级主版本)
    - [3.2 何时升级次版本](#32-何时升级次版本)
    - [3.3 何时升级修订版本](#33-何时升级修订版本)
  - [4. 🔧 主版本管理](#4--主版本管理)
    - [4.1 v0版本](#41-v0版本)
    - [4.2 v1版本](#42-v1版本)
    - [4.3 v2+版本](#43-v2版本)
  - [5. 📊 版本选择](#5--版本选择)
    - [5.1 最小版本选择（MVS）](#51-最小版本选择mvs)
    - [5.2 版本约束](#52-版本约束)
  - [6. 🎯 最佳实践](#6--最佳实践)
    - [✅ 模块发布者](#-模块发布者)
    - [✅ 模块使用者](#-模块使用者)
  - [7. ⚠️ 常见问题](#7-️-常见问题)
    - [Q1: 何时发布v1.0.0？](#q1-何时发布v100)
    - [Q2: v2导入路径为什么要加/v2？](#q2-v2导入路径为什么要加v2)
    - [Q3: 如何废弃功能而不破坏兼容性？](#q3-如何废弃功能而不破坏兼容性)
    - [Q4: +incompatible是什么？](#q4-incompatible是什么)
  - [8. 📚 扩展阅读](#8--扩展阅读)
    - [官方文档](#官方文档)
    - [相关文档](#相关文档)
<!-- TOC END -->

---

## 1. 📚 语义化版本概述

### 1.1 什么是语义化版本

**语义化版本**（Semantic Versioning, SemVer）是一套版本命名规范，通过版本号传达兼容性信息。

**核心原则**:

- 📈 版本号有明确含义
- 🔄 兼容性变化可预测
- 🛡️ 保护用户免受破坏性变更

### 1.2 在Go中的应用

Go模块严格遵循语义化版本：

- ✅ 所有版本必须符合SemVer格式
- ✅ v2+版本必须修改模块路径
- ✅ 使用最小版本选择算法

---

## 2. 📝 版本号格式

### 2.1 标准格式

```text
vMAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]
```

**示例**:

```text
v1.2.3           # 标准版本
v1.2.3-alpha.1   # 预发布版本
v1.2.3+20230101  # 带构建元数据
v1.2.3-rc.1+build.123  # 完整格式
```

### 2.2 版本号组成

| 部分 | 说明 | 示例 | 何时变更 |
|------|------|------|---------|
| **MAJOR** | 主版本号 | v**1**.0.0 | 不兼容的API变更 |
| **MINOR** | 次版本号 | v1.**2**.0 | 向后兼容的功能新增 |
| **PATCH** | 修订号 | v1.2.**3** | 向后兼容的问题修正 |
| **PRERELEASE** | 预发布标识 | v1.0.0-**alpha.1** | 测试版本 |
| **BUILD** | 构建元数据 | v1.0.0+**20230101** | 构建信息 |

### 2.3 Go模块特殊规则

**1. 版本必须以v开头**

```go
// ✅ 正确
v1.2.3

// ❌ 错误
1.2.3
```

**2. v0和v1不需要路径后缀**

```go
// v0和v1
module github.com/user/project

// v2+需要后缀
module github.com/user/project/v2
```

**3. 伪版本（Pseudo-version）**

未打标签的提交使用伪版本：

```text
v0.0.0-20230101120000-abcdef123456
  ↑     ↑              ↑
  |     |              └─ 提交hash前12位
  |     └─ 时间戳（UTC）
  └─ 基础版本
```

---

## 3. 💻 版本升级规则

### 3.1 何时升级主版本

**MAJOR版本**：不兼容的API变更

**示例场景**:

```go
// v1.x.x
func GetUser(id int) User

// v2.0.0 - 修改了返回类型（破坏性变更）
func GetUser(id int) (User, error)
```

**其他场景**:

- 删除公开的函数、类型或方法
- 修改函数签名
- 改变公开API的行为
- 移除已废弃的功能

### 3.2 何时升级次版本

**MINOR版本**：向后兼容的功能新增

**示例场景**:

```go
// v1.1.0 - 新增函数
func GetUserByEmail(email string) User

// v1.2.0 - 新增类型
type Admin struct {
    User
    Permissions []string
}
```

**其他场景**:

- 新增公开函数或方法
- 新增可选参数（通过选项模式）
- 改进性能（不改变API）
- 标记功能为废弃（deprecate）

### 3.3 何时升级修订版本

**PATCH版本**：向后兼容的问题修正

**示例场景**:

```go
// v1.2.2 - 修复bug
func ValidateEmail(email string) bool {
    // 修正正则表达式中的错误
    return emailRegex.MatchString(email)
}
```

**其他场景**:

- 修复bug
- 安全补丁
- 文档更新
- 内部重构（不影响API）

---

## 4. 🔧 主版本管理

### 4.1 v0版本

**特点**:

- 🚧 开发阶段
- ⚠️ API可能随时变更
- 🔓 无稳定性保证

**使用**:

```go
module github.com/user/project

go 1.25.3

// v0.x.x的依赖
require github.com/someone/lib v0.5.2
```

### 4.2 v1版本

**特点**:

- ✅ 首个稳定版本
- 🔒 承诺API稳定性
- 📖 模块路径不含版本后缀

**使用**:

```go
module github.com/user/project

// v1.x.x的依赖
require github.com/someone/lib v1.3.0
```

### 4.3 v2+版本

**特点**:

- 🔄 包含破坏性变更
- 📍 模块路径必须包含版本后缀
- 🔀 可与v1并存

**使用**:

```go
// 模块声明
module github.com/user/project/v2

go 1.25.3

// 导入
import "github.com/someone/lib/v3"
```

**多版本共存**:

```go
require (
    github.com/lib/pkg v1.5.0      // v1版本
    github.com/lib/pkg/v2 v2.3.0   // v2版本
    github.com/lib/pkg/v3 v3.1.0   // v3版本
)
```

---

## 5. 📊 版本选择

### 5.1 最小版本选择（MVS）

Go使用**最小版本选择算法**：

**原则**: 选择满足所有需求的**最旧版本**

**示例**:

```text
项目A依赖: lib >= v1.2.0
项目B依赖: lib >= v1.3.0
项目C依赖: lib >= v1.1.0

→ 选择 v1.3.0（满足所有需求的最小版本）
```

**优势**:

- ✅ 构建可重现
- ✅ 减少意外破坏
- ✅ 鼓励渐进升级

### 5.2 版本约束

**在go.mod中的表示**:

```go
require (
    github.com/pkg/errors v0.9.1  // 精确版本
    golang.org/x/sync v0.3.0      // 最小版本
)
```

**使用go get指定版本**:

```bash
# 最新版本
go get github.com/gin-gonic/gin@latest

# 特定版本
go get github.com/gin-gonic/gin@v1.9.1

# 特定提交
go get github.com/gin-gonic/gin@commit_hash

# 特定分支
go get github.com/gin-gonic/gin@branch_name
```

---

## 6. 🎯 最佳实践

### ✅ 模块发布者

1. **严格遵循SemVer**
   - 破坏性变更 → 升级主版本
   - 新功能 → 升级次版本
   - Bug修复 → 升级修订版本

2. **v0谨慎发布**

   ```go
   // 尽快达到v1.0.0
   v0.1.0 → v0.2.0 → v1.0.0
   ```

3. **v2+使用路径后缀**

   ```go
   // go.mod
   module github.com/user/project/v2
   ```

4. **使用预发布版本测试**

   ```bash
   git tag v2.0.0-beta.1
   ```

5. **编写CHANGELOG**

   ```markdown
   ## [2.0.0] - 2023-10-20
   ### 破坏性变更
   - 修改了GetUser函数签名
   
   ### 新增
   - 新增GetUserByEmail函数
   ```

### ✅ 模块使用者

1. **定期更新依赖**

   ```bash
   # 检查更新
   go list -u -m all
   
   # 更新到最新次版本
   go get -u=patch ./...
   ```

2. **谨慎升级主版本**

   ```bash
   # 先测试
   go get github.com/lib/pkg/v2@latest
   go test ./...
   ```

3. **锁定关键依赖**

   ```go
   // 对于关键依赖，使用精确版本
   require github.com/critical/lib v1.5.3
   ```

4. **使用go mod tidy清理**

   ```bash
   go mod tidy
   ```

---

## 7. ⚠️ 常见问题

### Q1: 何时发布v1.0.0？

**A**: 当API稳定，准备承诺向后兼容时：

**检查清单**:

- ✅ API已经过充分测试
- ✅ 文档完整
- ✅ 准备维护向后兼容性
- ✅ 有明确的版本策略

### Q2: v2导入路径为什么要加/v2？

**A**: 允许v1和v2在同一项目中共存：

```go
import (
    oldpkg "github.com/user/pkg"     // v1
    newpkg "github.com/user/pkg/v2"  // v2
)
```

### Q3: 如何废弃功能而不破坏兼容性？

**A**: 使用deprecation注释：

```go
// Deprecated: Use NewFunction instead.
func OldFunction() {
    // 实现
}
```

在文档中说明，下一个主版本将移除。

### Q4: +incompatible是什么？

**A**: 表示v2+版本但未使用Go模块：

```go
require github.com/old/pkg v2.0.0+incompatible
```

这些包被当作v1处理。

---

## 8. 📚 扩展阅读

### 官方文档

- [Semantic Versioning 2.0.0](https://semver.org/)
- [Go Modules: v2 and Beyond](https://go.dev/blog/v2-go-modules)
- [Module version numbering](https://go.dev/doc/modules/version-numbers)

### 相关文档

- [01-Go-Modules简介.md](./01-Go-Modules简介.md)
- [02-go-mod文件详解.md](./02-go-mod文件详解.md)
- [06-依赖管理.md](./06-依赖管理.md)

---

**文档维护者**: Go Documentation Team  
**最后更新**: 2025年10月20日  
**文档状态**: 完成  
**适用版本**: Go 1.25.3+
