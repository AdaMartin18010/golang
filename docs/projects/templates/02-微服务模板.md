# 微服务模板

**难度**: 中级 | **预计阅读**: 15分钟

---

## 📋 目录


- [1. 📖 微服务架构](#1--微服务架构)
- [🎯 服务入口](#-服务入口)
- [🐳 Docker配置](#-docker配置)
- [☸️ K8s部署](#-k8s部署)
- [📚 相关资源](#-相关资源)

## 1. 📖 微服务架构

```
microservice/
├── cmd/
│   └── service/
│       └── main.go
├── internal/
│   ├── config/
│   ├── handler/
│   ├── service/
│   ├── repository/
│   └── middleware/
├── api/
│   └── proto/
│       └── service.proto
├── deployments/
│   ├── docker-compose.yml
│   └── k8s/
├── go.mod
└── Dockerfile
```

---

## 🎯 服务入口

```go
package main

import (
    "context"
    "log"
    "net/http"
    "os"
    "os/signal"
    "syscall"
    "time"
)

func main() {
    // 加载配置
    cfg := config.Load()
    
    // 初始化依赖
    db := initDB(cfg.DatabaseURL)
    defer db.Close()
    
    cache := initRedis(cfg.RedisURL)
    defer cache.Close()
    
    // 创建服务
    svc := service.New(db, cache)
    
    // HTTP服务器
    srv := &http.Server{
        Addr:    ":8080",
        Handler: routes(svc),
    }
    
    // 启动服务器
    go func() {
        log.Println("Server starting...")
        if err := srv.ListenAndServe(); err != http.ErrServerClosed {
            log.Fatal(err)
        }
    }()
    
    // 优雅关闭
    quit := make(chan os.Signal, 1)
    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
    <-quit
    
    log.Println("Shutting down...")
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    
    if err := srv.Shutdown(ctx); err != nil {
        log.Fatal(err)
    }
    
    log.Println("Server stopped")
}
```

---

## 🐳 Docker配置

```dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY go.* ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 go build -o server cmd/service/main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/server .
EXPOSE 8080
CMD ["./server"]
```

---

## ☸️ K8s部署

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myservice
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myservice
  template:
    metadata:
      labels:
        app: myservice
    spec:
      containers:
      - name: myservice
        image: myservice:latest
        ports:
        - containerPort: 8080
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
---
apiVersion: v1
kind: Service
metadata:
  name: myservice
spec:
  selector:
    app: myservice
  ports:
  - port: 80
    targetPort: 8080
  type: LoadBalancer
```

---

## 📚 相关资源

- [Microservices Pattern](https://microservices.io/)

**下一步**: [03-Web应用模板](./03-Web应用模板.md)

---

**最后更新**: 2025-10-28

