# Goå¹¶å‘ç¼–ç¨‹ - æ¦‚å¿µå®šä¹‰ä½“ç³»

**ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-28  
**é€‚ç”¨äº**: Go 1.25.3  
**æ–‡ä»¶å¤¹**: fundamentals/language/02-å¹¶å‘ç¼–ç¨‹  
**ç±»å‹**: å½¢å¼åŒ–æ¦‚å¿µå®šä¹‰

---

## ğŸ“‹ ç›®å½•


- [1. æ ¸å¿ƒæ¦‚å¿µæ¸…å•](#1-æ ¸å¿ƒæ¦‚å¿µæ¸…å•)
  - [1.1 æ¦‚å¿µåˆ†ç±»ç»Ÿè®¡](#11-æ¦‚å¿µåˆ†ç±»ç»Ÿè®¡)
  - [1.2 æ¦‚å¿µæ¸…å•](#12-æ¦‚å¿µæ¸…å•)
- [2. æ¦‚å¿µå½¢å¼åŒ–å®šä¹‰](#2-æ¦‚å¿µå½¢å¼åŒ–å®šä¹‰)
  - [2.1 å¹¶å‘å•å…ƒ](#21-å¹¶å‘å•å…ƒ)
    - [æ¦‚å¿µC01: Goroutine](#æ¦‚å¿µc01-goroutine)
  - [2.2 é€šä¿¡æœºåˆ¶](#22-é€šä¿¡æœºåˆ¶)
    - [æ¦‚å¿µC03: Channel](#æ¦‚å¿µc03-channel)
    - [æ¦‚å¿µC04: Select](#æ¦‚å¿µc04-select)
  - [2.3 åŒæ­¥åŸè¯­](#23-åŒæ­¥åŸè¯­)
    - [æ¦‚å¿µC06: Mutex](#æ¦‚å¿µc06-mutex)
    - [æ¦‚å¿µC08: WaitGroup](#æ¦‚å¿µc08-waitgroup)
  - [2.4 æ§åˆ¶æœºåˆ¶](#24-æ§åˆ¶æœºåˆ¶)
    - [æ¦‚å¿µC05: Context](#æ¦‚å¿µc05-context)
  - [2.5 è°ƒåº¦æ¨¡å‹](#25-è°ƒåº¦æ¨¡å‹)
    - [æ¦‚å¿µC15: GMPæ¨¡å‹](#æ¦‚å¿µc15-gmpæ¨¡å‹)
- [3. æ¦‚å¿µå…³ç³»å›¾è°±](#3-æ¦‚å¿µå…³ç³»å›¾è°±)
  - [3.1 æ¦‚å¿µä¾èµ–å›¾](#31-æ¦‚å¿µä¾èµ–å›¾)
  - [3.2 æ¦‚å¿µåˆ†ç±»å›¾](#32-æ¦‚å¿µåˆ†ç±»å›¾)
- [4. æ¦‚å¿µå±‚æ¬¡ç»“æ„](#4-æ¦‚å¿µå±‚æ¬¡ç»“æ„)
  - [4.1 æŠ½è±¡å±‚æ¬¡](#41-æŠ½è±¡å±‚æ¬¡)
  - [4.2 å­¦ä¹ å±‚æ¬¡å»ºè®®](#42-å­¦ä¹ å±‚æ¬¡å»ºè®®)
- [ğŸ“Š ä½¿ç”¨æŒ‡å—](#-ä½¿ç”¨æŒ‡å—)
  - [å¦‚ä½•ä½¿ç”¨æœ¬æ–‡æ¡£](#å¦‚ä½•ä½¿ç”¨æœ¬æ–‡æ¡£)
- [ğŸ”— ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)

## 1. æ ¸å¿ƒæ¦‚å¿µæ¸…å•

### 1.1 æ¦‚å¿µåˆ†ç±»ç»Ÿè®¡

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Goå¹¶å‘ç¼–ç¨‹æ ¸å¿ƒæ¦‚å¿µä½“ç³»
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¬¬ä¸€å±‚ï¼šå¹¶å‘å•å…ƒ     2ä¸ªæ¦‚å¿µ
ç¬¬äºŒå±‚ï¼šé€šä¿¡æœºåˆ¶     3ä¸ªæ¦‚å¿µ
ç¬¬ä¸‰å±‚ï¼šåŒæ­¥åŸè¯­     6ä¸ªæ¦‚å¿µ
ç¬¬å››å±‚ï¼šæ§åˆ¶æœºåˆ¶     3ä¸ªæ¦‚å¿µ
ç¬¬äº”å±‚ï¼šè°ƒåº¦æ¨¡å‹     2ä¸ªæ¦‚å¿µ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»è®¡: 16ä¸ªæ ¸å¿ƒæ¦‚å¿µ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 1.2 æ¦‚å¿µæ¸…å•

| ID | æ¦‚å¿µåç§° | è‹±æ–‡ | ç±»åˆ« | é‡è¦åº¦ |
|----|---------|------|------|--------|
| C01 | Goroutine | Goroutine | å¹¶å‘å•å…ƒ | â­â­â­â­â­ |
| C02 | çº¿ç¨‹ | Thread | å¹¶å‘å•å…ƒ | â­â­â­â­ |
| C03 | Channel | Channel | é€šä¿¡æœºåˆ¶ | â­â­â­â­â­ |
| C04 | Select | Select | é€šä¿¡æœºåˆ¶ | â­â­â­â­â­ |
| C05 | Context | Context | é€šä¿¡æœºåˆ¶ | â­â­â­â­â­ |
| C06 | Mutex | Mutex | åŒæ­¥åŸè¯­ | â­â­â­â­â­ |
| C07 | RWMutex | Read-Write Mutex | åŒæ­¥åŸè¯­ | â­â­â­â­ |
| C08 | WaitGroup | WaitGroup | åŒæ­¥åŸè¯­ | â­â­â­â­â­ |
| C09 | Once | Once | åŒæ­¥åŸè¯­ | â­â­â­ |
| C10 | Cond | Condition Variable | åŒæ­¥åŸè¯­ | â­â­â­ |
| C11 | atomic | Atomic Operations | åŒæ­¥åŸè¯­ | â­â­â­â­ |
| C12 | CSPæ¨¡å‹ | CSP Model | æ§åˆ¶æœºåˆ¶ | â­â­â­â­â­ |
| C13 | å¹¶å‘æ¨¡å¼ | Concurrency Patterns | æ§åˆ¶æœºåˆ¶ | â­â­â­â­ |
| C14 | å†…å­˜æ¨¡å‹ | Memory Model | æ§åˆ¶æœºåˆ¶ | â­â­â­â­â­ |
| C15 | GMPæ¨¡å‹ | GMP Scheduler | è°ƒåº¦æ¨¡å‹ | â­â­â­â­â­ |
| C16 | æŠ¢å è°ƒåº¦ | Preemption | è°ƒåº¦æ¨¡å‹ | â­â­â­â­ |

---

## 2. æ¦‚å¿µå½¢å¼åŒ–å®šä¹‰

### 2.1 å¹¶å‘å•å…ƒ

#### æ¦‚å¿µC01: Goroutine

**å½¢å¼åŒ–å®šä¹‰**:

```text
Goroutine ::= LightweightThread {
    Stack:      DynamicStack(2KB â†’ 1GB),
    Scheduler:  GoScheduler,
    Cost:       O(2KB),
    Number:     O(10^6)
}

åˆ›å»ºè¯­æ³•:
  go Expression

æ€§è´¨:
  â€¢ Lightweight: Stack << Thread.Stack
  â€¢ Cooperative: Yield at function calls
  â€¢ Managed: By Go runtime, not OS
```

**å†…æ¶µï¼ˆæœ¬è´¨å±æ€§ï¼‰**:
- Goè¿è¡Œæ—¶ç®¡ç†çš„è½»é‡çº§æ‰§è¡Œå•å…ƒ
- åä½œå¼è°ƒåº¦ï¼Œåœ¨ç‰¹å®šç‚¹è®©å‡ºCPU
- åŠ¨æ€æ ˆï¼ŒæŒ‰éœ€å¢é•¿ï¼ˆ2KBèµ·å§‹ï¼‰
- ç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨å’Œæ ˆ

**å¤–å»¶ï¼ˆèŒƒå›´è¾¹ç•Œï¼‰**:
- åŒ…å«ï¼šå‡½æ•°æ‰§è¡Œã€æ ˆç©ºé—´ã€ç¨‹åºè®¡æ•°å™¨
- ä¸åŒ…å«ï¼šOSçº¿ç¨‹ã€ç‹¬ç«‹åœ°å€ç©ºé—´

**å…³ç³»ï¼ˆä¸å…¶ä»–æ¦‚å¿µï¼‰**:
- **å¯¹æ¯”å…³ç³»**: Goroutine vs Threadï¼ˆè½»é‡çº§ vs é‡é‡çº§ï¼‰
- **ä¾èµ–å…³ç³»**: Goroutine â†’ GMPè°ƒåº¦å™¨
- **é€šä¿¡å…³ç³»**: Goroutine â†Channelâ†’ Goroutine

**å±æ€§ï¼ˆç‰¹å¾æè¿°ï¼‰**:
- **åˆ›å»ºæˆæœ¬**: `CreationCost = O(2KB)`
- **åˆ‡æ¢æˆæœ¬**: `SwitchCost = O(100ns)` (ç”¨æˆ·æ€)
- **æ•°é‡ä¸Šé™**: `MaxCount = O(10^6)`
- **è°ƒåº¦æ–¹å¼**: `Scheduling = Cooperative`
- **æ ˆå¤§å°**: `Stack = Dynamic(2KB â†’ 1GB)`

**å½¢å¼åŒ–æ€§è´¨**:
```text
1. è½»é‡çº§ç‰¹æ€§:
   âˆ€g:Goroutine, Memory(g) << Memory(Thread)
   å…¸å‹ï¼š2KB vs 1-2MB

2. å¹¶å‘æ•°é‡:
   å¯åŒæ—¶å­˜åœ¨çš„goroutineæ•° >> å¯åŒæ—¶å­˜åœ¨çš„threadæ•°
   å®è·µä¸­ï¼šgoroutines ~ 10^6, threads ~ 10^3

3. åˆ›å»ºè¯­ä¹‰:
   go f(args) â‡’ 
     1. åˆ›å»ºæ–°goroutine g
     2. è°ƒåº¦gæ‰§è¡Œf(args)
     3. å½“å‰goroutineç»§ç»­æ‰§è¡Œ

4. ç”Ÿå‘½å‘¨æœŸ:
   Created â†’ Running â†’ Blocked/Waiting â†’ Running â†’ Dead
```

**ç¤ºä¾‹**:
```go
// åˆ›å»ºgoroutine
go func() {
    fmt.Println("Running in goroutine")
}()

// å¤§é‡goroutine
for i := 0; i < 1000000; i++ {
    go process(i)  // å¯åˆ›å»ºç™¾ä¸‡çº§
}
```

---

### 2.2 é€šä¿¡æœºåˆ¶

#### æ¦‚å¿µC03: Channel

**å½¢å¼åŒ–å®šä¹‰**:

```text
Channel ::= TypedQueue {
    Type:       T,
    Direction:  BiDir | SendOnly | RecvOnly,
    Buffer:     size âˆˆ [0, +âˆ),
    State:      Open | Closed
}

è¯­æ³•:
  Declaration:  chan T | chan<- T | <-chan T
  Creation:     make(chan T [, bufferSize])
  Send:         ch <- value
  Receive:      value := <-ch | <-ch
  Close:        close(ch)

CSPè¯­ä¹‰:
  Channel = Rendezvous(sender, receiver)
  Buffered = Mailbox(capacity)
```

**å†…æ¶µï¼ˆæœ¬è´¨å±æ€§ï¼‰**:
- ç±»å‹åŒ–çš„é€šä¿¡ç®¡é“
- å®ç°goroutineé—´çš„åŒæ­¥é€šä¿¡
- ç¬¦åˆCSPæ¨¡å‹çš„é€šä¿¡åŸè¯­
- å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—è¯­ä¹‰

**å¤–å»¶ï¼ˆèŒƒå›´è¾¹ç•Œï¼‰**:
- åŒ…å«ï¼šæ•°æ®é˜Ÿåˆ—ã€é˜»å¡/å”¤é†’æœºåˆ¶ã€ç±»å‹ä¿¡æ¯
- ä¸åŒ…å«ï¼šæ•°æ®è½¬æ¢ã€æŒä¹…åŒ–å­˜å‚¨

**å…³ç³»ï¼ˆä¸å…¶ä»–æ¦‚å¿µï¼‰**:
- **å¯¹æ¯”å…³ç³»**: Channelï¼ˆé€šä¿¡ï¼‰vs Mutexï¼ˆå…±äº«ï¼‰
- **ä¾èµ–å…³ç³»**: Channel â†’ Goroutineï¼ˆé€šä¿¡åŒæ–¹ï¼‰
- **ç»„åˆå…³ç³»**: Select â†’ Channelï¼ˆå¤šè·¯å¤ç”¨ï¼‰

**å±æ€§ï¼ˆç‰¹å¾æè¿°ï¼‰**:
- **ç±»å‹**: `Type = T` (å¼ºç±»å‹)
- **æ–¹å‘**: `Direction = {BiDir, SendOnly, RecvOnly}`
- **ç¼“å†²**: `BufferSize âˆˆ [0, âˆ)`
- **çŠ¶æ€**: `State = {Open, Closed}`
- **è¯­ä¹‰**: `Semantics = FIFO Queue`

**å½¢å¼åŒ–æ€§è´¨**:
```text
1. ç±»å‹å®‰å…¨:
   âˆ€ch:chan T, âˆ€v, send(ch, v) â‡’ v:T
   receive(ch) : T

2. ç¼“å†²è¯­ä¹‰:
   - æ— ç¼“å†² (size=0): 
     send(ch, v) blocks until receive(ch)
     receive(ch) blocks until send(ch, v)
   
   - ç¼“å†² (size>0):
     send(ch, v) blocks if len(ch) = cap(ch)
     receive(ch) blocks if len(ch) = 0

3. å…³é—­è¯­ä¹‰:
   close(ch) â‡’ 
     1. ç¦æ­¢å†send (panic)
     2. receiveè¿”å›é›¶å€¼å’Œfalse
     3. rangeéå†ç»ˆæ­¢

4. Happens-Before:
   send(ch, v) happens-before receive(ch) returns v
```

**ç¤ºä¾‹**:
```go
// æ— ç¼“å†²channel - åŒæ­¥
ch := make(chan int)
go func() {
    ch <- 42  // é˜»å¡ç›´åˆ°è¢«æ¥æ”¶
}()
v := <-ch     // æ¥æ”¶

// ç¼“å†²channel - å¼‚æ­¥
ch := make(chan int, 10)
ch <- 1       // ä¸é˜»å¡ï¼ˆç¼“å†²åŒºæœªæ»¡ï¼‰

// å•å‘channel
func send(ch chan<- int) {
    ch <- 42
}

func receive(ch <-chan int) {
    v := <-ch
}
```

---

#### æ¦‚å¿µC04: Select

**å½¢å¼åŒ–å®šä¹‰**:

```text
Select ::= MultiWayChoice {
    Cases:   []CaseClause,
    Default: Optional(DefaultClause)
}

CaseClause ::= case Communication : Statement

è¯­æ³•:
  select {
  case x := <-ch1:
      // handle ch1
  case ch2 <- y:
      // send to ch2
  default:
      // non-blocking
  }

è¯­ä¹‰:
  â€¢ ç­‰å¾…å¤šä¸ªchannelæ“ä½œ
  â€¢ éšæœºé€‰æ‹©å°±ç»ªçš„case
  â€¢ defaultå®ç°éé˜»å¡
```

**å†…æ¶µï¼ˆæœ¬è´¨å±æ€§ï¼‰**:
- Channelæ“ä½œçš„å¤šè·¯å¤ç”¨å™¨
- åŒæ—¶ç­‰å¾…å¤šä¸ªchannelæ“ä½œ
- éšæœºå…¬å¹³é€‰æ‹©å°±ç»ªæ“ä½œ
- æ”¯æŒéé˜»å¡æ“ä½œï¼ˆdefaultï¼‰

**å¤–å»¶ï¼ˆèŒƒå›´è¾¹ç•Œï¼‰**:
- åŒ…å«ï¼šå¤šä¸ªcaseã€channelæ“ä½œã€defaultåˆ†æ”¯
- ä¸åŒ…å«ï¼šå€¼åˆ¤æ–­ï¼ˆé‚£æ˜¯switchï¼‰ã€å¾ªç¯

**å…³ç³»ï¼ˆä¸å…¶ä»–æ¦‚å¿µï¼‰**:
- **å¯¹æ¯”å…³ç³»**: Selectï¼ˆchannelï¼‰vs Switchï¼ˆå€¼ï¼‰
- **ä¾èµ–å…³ç³»**: Select â†’ Channel
- **ç»„åˆå…³ç³»**: Select + Contextï¼ˆå–æ¶ˆæ§åˆ¶ï¼‰

**å±æ€§ï¼ˆç‰¹å¾æè¿°ï¼‰**:
- **æ“ä½œå¯¹è±¡**: `Operands = Channels`
- **é€‰æ‹©ç­–ç•¥**: `Strategy = Random (Fair)`
- **é˜»å¡è¡Œä¸º**: `Blocking = Until any case ready | has default`
- **æ‰§è¡Œä¿è¯**: `Execution = Exactly one case`

**å½¢å¼åŒ–æ€§è´¨**:
```text
1. å¤šè·¯é€‰æ‹©:
   select {cases} â‡’ 
     Wait until âˆƒ case ready
     Execute one ready case (random if multiple)

2. éšæœºæ€§ï¼ˆå…¬å¹³ï¼‰:
   å¦‚æœå¤šä¸ªcaseåŒæ—¶å°±ç»ªï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
   é¿å…é¥¥é¥¿

3. éé˜»å¡:
   select {cases + default} â‡’
     if no case ready: execute default immediately
     else: execute one ready case

4. ä¸channeläº¤äº’:
   selectå¯ç­‰å¾…ï¼š
     - receive: case v := <-ch
     - send: case ch <- v
     - nil channel: æ°¸è¿œé˜»å¡
```

**ç¤ºä¾‹**:
```go
// åŸºæœ¬select
select {
case msg := <-ch1:
    fmt.Println("ch1:", msg)
case msg := <-ch2:
    fmt.Println("ch2:", msg)
}

// å¸¦è¶…æ—¶
select {
case result := <-ch:
    return result
case <-time.After(time.Second):
    return errors.New("timeout")
}

// éé˜»å¡
select {
case msg := <-ch:
    fmt.Println(msg)
default:
    fmt.Println("no message")
}
```

---

### 2.3 åŒæ­¥åŸè¯­

#### æ¦‚å¿µC06: Mutex

**å½¢å¼åŒ–å®šä¹‰**:

```text
Mutex ::= BinaryLock {
    State:   Unlocked | Locked,
    Waiter:  Queue<Goroutine>,
    Owner:   Optional<Goroutine>
}

æ“ä½œ:
  Lock():   Acquire exclusive access
  Unlock(): Release exclusive access

æ€§è´¨:
  â€¢ Mutual Exclusion: âˆ€t, âˆƒâ‰¤1 goroutine in critical section
  â€¢ No Deadlock: Guaranteed progress (with proper usage)
```

**å†…æ¶µï¼ˆæœ¬è´¨å±æ€§ï¼‰**:
- äº’æ–¥é”ï¼Œä¿è¯ä¸´ç•ŒåŒºäº’æ–¥è®¿é—®
- äºŒå…ƒçŠ¶æ€ï¼šé”å®š/æœªé”å®š
- é˜»å¡ç­‰å¾…ï¼šé”å®šæ—¶å…¶ä»–goroutineç­‰å¾…

**å¤–å»¶ï¼ˆèŒƒå›´è¾¹ç•Œï¼‰**:
- åŒ…å«ï¼šé”çŠ¶æ€ã€ç­‰å¾…é˜Ÿåˆ—ã€æ‰€æœ‰æƒä¿¡æ¯
- ä¸åŒ…å«ï¼šé‡å…¥æ”¯æŒï¼ˆGo mutexä¸å¯é‡å…¥ï¼‰

**å…³ç³»ï¼ˆä¸å…¶ä»–æ¦‚å¿µï¼‰**:
- **å¯¹æ¯”å…³ç³»**: Mutex vs RWMutexï¼ˆä¸åŒºåˆ†è¯»å†™ vs åŒºåˆ†ï¼‰
- **å¯¹æ¯”å…³ç³»**: Mutex vs Channelï¼ˆå…±äº«å†…å­˜ vs é€šä¿¡ï¼‰
- **ä¾èµ–å…³ç³»**: Mutex â†’ Goroutineï¼ˆé”çš„æŒæœ‰è€…ï¼‰

**å±æ€§ï¼ˆç‰¹å¾æè¿°ï¼‰**:
- **çŠ¶æ€**: `State = {Unlocked, Locked}`
- **é‡å…¥æ€§**: `Reentrant = false`
- **å…¬å¹³æ€§**: `Fairness = Unfair â†’ Fair (Go 1.9+)`
- **é˜»å¡**: `Blocking = true`

**å½¢å¼åŒ–æ€§è´¨**:
```text
1. äº’æ–¥æ€§:
   âˆ€t, |{g : g holds mutex}| â‰¤ 1

2. é”è¯­ä¹‰:
   Lock() â‡’
     if State = Unlocked: State := Locked, Owner := current
     else: Block until Unlocked

   Unlock() â‡’
     if Owner â‰  current: panic
     else: State := Unlocked, Wakeup one waiter

3. ä¸´ç•ŒåŒºä¿æŠ¤:
   mu.Lock()
   // Critical Section: Exclusive access guaranteed
   mu.Unlock()

4. Happens-Before:
   Unlock(mu) happens-before Lock(mu) returns
   (åœ¨åŒä¸€ä¸ªmutexçš„ä¸åŒgoroutineé—´)
```

**ç¤ºä¾‹**:
```go
var (
    counter int
    mu      sync.Mutex
)

func increment() {
    mu.Lock()
    defer mu.Unlock()
    counter++  // ä¸´ç•ŒåŒº
}

// âŒ é”™è¯¯ï¼šé‡å…¥æ­»é”
func bad() {
    mu.Lock()
    defer mu.Unlock()
    increment()  // æ­»é”ï¼
}
```

---

#### æ¦‚å¿µC08: WaitGroup

**å½¢å¼åŒ–å®šä¹‰**:

```text
WaitGroup ::= Counter {
    counter:  int,
    waiters:  []Goroutine,
    state:    Running | Waiting
}

æ“ä½œ:
  Add(delta):  counter += delta
  Done():      counter -= 1  (Add(-1))
  Wait():      block until counter = 0

çº¦æŸ:
  counter â‰¥ 0 (å¦åˆ™panic)
```

**å†…æ¶µï¼ˆæœ¬è´¨å±æ€§ï¼‰**:
- ç­‰å¾…ä¸€ç»„goroutineå®Œæˆçš„åŒæ­¥åŸè¯­
- è®¡æ•°å™¨è¯­ä¹‰ï¼Œå®Œæˆæ—¶é€’å‡
- Waité˜»å¡ç›´åˆ°è®¡æ•°å™¨å½’é›¶

**å¤–å»¶ï¼ˆèŒƒå›´è¾¹ç•Œï¼‰**:
- åŒ…å«ï¼šè®¡æ•°å™¨ã€ç­‰å¾…é˜Ÿåˆ—
- ä¸åŒ…å«ï¼šå–æ¶ˆæœºåˆ¶ï¼ˆç”¨Contextï¼‰

**å…³ç³»ï¼ˆä¸å…¶ä»–æ¦‚å¿µï¼‰**:
- **å¯¹æ¯”å…³ç³»**: WaitGroup vs Contextï¼ˆç­‰å¾…å®Œæˆ vs ä¸»åŠ¨å–æ¶ˆï¼‰
- **ç»„åˆå…³ç³»**: WaitGroup + Contextï¼ˆå®Œæˆç­‰å¾… + å–æ¶ˆæ§åˆ¶ï¼‰

**å±æ€§ï¼ˆç‰¹å¾æè¿°ï¼‰**:
- **è®¡æ•°å™¨**: `Counter â‰¥ 0`
- **æ“ä½œ**: `{Add, Done, Wait}`
- **é˜»å¡**: `Wait() blocks until Counter = 0`
- **è¯­ä¹‰**: `Barrier for goroutine completion`

**å½¢å¼åŒ–æ€§è´¨**:
```text
1. è®¡æ•°å™¨ä¸å˜å¼:
   counter â‰¥ 0 (å¦åˆ™panic)

2. Addè¯­ä¹‰:
   Add(delta) â‡’ counter := counter + delta
   è¦æ±‚ï¼šAdd must happen-before goroutine starts

3. Doneè¯­ä¹‰:
   Done() â‰¡ Add(-1)

4. Waitè¯­ä¹‰:
   Wait() â‡’ block until counter = 0

5. ä½¿ç”¨æ¨¡å¼:
   wg.Add(n)           // before starting goroutines
   for i := 0; i < n; i++ {
       go func() {
           defer wg.Done()
           // work
       }()
   }
   wg.Wait()           // wait for all to complete
```

**ç¤ºä¾‹**:
```go
var wg sync.WaitGroup

// å¯åŠ¨å¤šä¸ªgoroutine
for i := 0; i < 10; i++ {
    wg.Add(1)
    go func(id int) {
        defer wg.Done()
        process(id)
    }(i)
}

// ç­‰å¾…æ‰€æœ‰å®Œæˆ
wg.Wait()
fmt.Println("All done")
```

---

### 2.4 æ§åˆ¶æœºåˆ¶

#### æ¦‚å¿µC05: Context

**å½¢å¼åŒ–å®šä¹‰**:

```text
Context ::= ControlFlow {
    Done:       <-chan struct{},
    Err:        error | nil,
    Deadline:   time.Time | nil,
    Value:      key -> value
}

ç±»å‹:
  WithCancel:   (ctx, cancel) - æ‰‹åŠ¨å–æ¶ˆ
  WithTimeout:  (ctx, cancel) - è¶…æ—¶å–æ¶ˆ
  WithDeadline: (ctx, cancel) - æˆªæ­¢æ—¶é—´å–æ¶ˆ
  WithValue:    ctx - ä¼ é€’å€¼

ä¼ æ’­:
  Parent â†’ Child (æ ‘å½¢ç»“æ„)
  å–æ¶ˆä¿¡å·å‘ä¸‹ä¼ æ’­
```

**å†…æ¶µï¼ˆæœ¬è´¨å±æ€§ï¼‰**:
- goroutineç”Ÿå‘½å‘¨æœŸæ§åˆ¶æœºåˆ¶
- æ ‘å½¢ä¼ æ’­çš„å–æ¶ˆä¿¡å·
- æºå¸¦æˆªæ­¢æ—¶é—´å’Œè¯·æ±‚èŒƒå›´å€¼
- è·¨APIè¾¹ç•Œä¼ é€’

**å¤–å»¶ï¼ˆèŒƒå›´è¾¹ç•Œï¼‰**:
- åŒ…å«ï¼šå–æ¶ˆä¿¡å·ã€æˆªæ­¢æ—¶é—´ã€é”®å€¼å¯¹
- ä¸åŒ…å«ï¼šæ•°æ®ä¼ è¾“ï¼ˆç”¨Channelï¼‰ã€çŠ¶æ€å…±äº«ï¼ˆç”¨syncï¼‰

**å…³ç³»ï¼ˆä¸å…¶ä»–æ¦‚å¿µï¼‰**:
- **ç»„åˆå…³ç³»**: Context + Goroutineï¼ˆç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰
- **ç»„åˆå…³ç³»**: Context + Selectï¼ˆå–æ¶ˆç›‘å¬ï¼‰
- **å¯¹æ¯”å…³ç³»**: Context vs WaitGroupï¼ˆä¸»åŠ¨å–æ¶ˆ vs è¢«åŠ¨ç­‰å¾…ï¼‰

**å±æ€§ï¼ˆç‰¹å¾æè¿°ï¼‰**:
- **ç»“æ„**: `Structure = Tree`
- **ä¼ æ’­**: `Propagation = Top-Down`
- **ä¸å¯å˜**: `Immutable = true`
- **çº¿ç¨‹å®‰å…¨**: `ThreadSafe = true`

**å½¢å¼åŒ–æ€§è´¨**:
```text
1. æ ‘å½¢ç»“æ„:
   Contextå½¢æˆçˆ¶å­æ ‘
   Parent cancel â‡’ All children canceled

2. å–æ¶ˆä¼ æ’­:
   cancel(parent) â‡’ âˆ€child, child.Done() is closed

3. ä¸å¯å˜æ€§:
   Contextå€¼ä¸å¯ä¿®æ”¹
   WithValueåˆ›å»ºæ–°context

4. ä½¿ç”¨æ¨¡å¼:
   func operation(ctx context.Context) error {
       select {
       case <-ctx.Done():
           return ctx.Err()  // Canceled or DeadlineExceeded
       case result := <-work():
           return nil
       }
   }

5. Happens-Before:
   cancel() happens-before <-ctx.Done() returns
```

**ç¤ºä¾‹**:
```go
// WithCancel - æ‰‹åŠ¨å–æ¶ˆ
ctx, cancel := context.WithCancel(context.Background())
defer cancel()

go func() {
    <-ctx.Done()
    fmt.Println("Canceled:", ctx.Err())
}()

cancel()  // è§¦å‘å–æ¶ˆ

// WithTimeout - è¶…æ—¶å–æ¶ˆ
ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
defer cancel()

select {
case <-time.After(3 * time.Second):
    fmt.Println("Work done")
case <-ctx.Done():
    fmt.Println("Timeout:", ctx.Err())
}

// WithValue - ä¼ é€’å€¼
ctx := context.WithValue(context.Background(), "userID", 42)
userID := ctx.Value("userID").(int)
```

---

### 2.5 è°ƒåº¦æ¨¡å‹

#### æ¦‚å¿µC15: GMPæ¨¡å‹

**å½¢å¼åŒ–å®šä¹‰**:

```text
GMP ::= SchedulerModel {
    G: Goroutine,
    M: Machine (OS Thread),
    P: Processor (Scheduling Context)
}

å…³ç³»:
  G: Logical Thread (millions)
  M: Physical Thread (~ GOMAXPROCS)
  P: Scheduling Context (= GOMAXPROCS)

è°ƒåº¦:
  M â† P â† G
  Mæ‰§è¡ŒGï¼ŒPæä¾›è°ƒåº¦ä¸Šä¸‹æ–‡
  Work Stealing: Pä»å…¶ä»–Pçªƒå–G

ç»“æ„:
  å…¨å±€é˜Ÿåˆ—: Global Queue<G>
  æœ¬åœ°é˜Ÿåˆ—: æ¯ä¸ªPæœ‰ Local Queue<G>
  Mé˜Ÿåˆ—:   ç­‰å¾…Gçš„Mé˜Ÿåˆ—
```

**å†…æ¶µï¼ˆæœ¬è´¨å±æ€§ï¼‰**:
- Goè¿è¡Œæ—¶çš„ä¸‰å±‚è°ƒåº¦æ¨¡å‹
- Gï¼ˆgoroutineï¼‰è¢«Pï¼ˆprocessorï¼‰è°ƒåº¦åˆ°Mï¼ˆmachine threadï¼‰ä¸Šæ‰§è¡Œ
- å·¥ä½œçªƒå–ï¼ˆwork stealingï¼‰å®ç°è´Ÿè½½å‡è¡¡
- ä¸¤çº§é˜Ÿåˆ—ï¼šå…¨å±€é˜Ÿåˆ—+æœ¬åœ°é˜Ÿåˆ—

**å¤–å»¶ï¼ˆèŒƒå›´è¾¹ç•Œï¼‰**:
- åŒ…å«ï¼šG/M/Pä¸‰å±‚ã€é˜Ÿåˆ—ã€è°ƒåº¦ç®—æ³•
- ä¸åŒ…å«ï¼šOSçº§åˆ«è°ƒåº¦

**å…³ç³»ï¼ˆä¸å…¶ä»–æ¦‚å¿µï¼‰**:
- **ä¾èµ–å…³ç³»**: Goroutine â†’ GMPï¼ˆè°ƒåº¦åŸºç¡€ï¼‰
- **å…³ç³»**: G:M:P = N:M:M (N>>M)

**å±æ€§ï¼ˆç‰¹å¾æè¿°ï¼‰**:
- **Gæ•°é‡**: `NumG ~ 10^6`
- **Mæ•°é‡**: `NumM ~ GOMAXPROCS + blocking calls`
- **Pæ•°é‡**: `NumP = GOMAXPROCS`
- **è°ƒåº¦ç­–ç•¥**: `Strategy = {WorkStealing, Preemption}`

**å½¢å¼åŒ–æ€§è´¨**:
```text
1. ä¸‰å±‚æ¨¡å‹:
   G: Goroutine (lightweight thread)
   M: Machine (OS thread)
   P: Processor (scheduling context)

2. ç»‘å®šå…³ç³»:
   Må¿…é¡»ç»‘å®šPæ‰èƒ½æ‰§è¡ŒG
   M â† P â† G

3. é˜Ÿåˆ—ç»“æ„:
   GlobalQueue<G>: å…¨å±€é˜Ÿåˆ—
   LocalQueue<G>[P]: æ¯ä¸ªPçš„æœ¬åœ°é˜Ÿåˆ—
   ä¼˜å…ˆæœ¬åœ°é˜Ÿåˆ—ï¼Œæœ¬åœ°ç©ºæ—¶ä»å…¨å±€æˆ–çªƒå–

4. Work Stealing:
   if LocalQueue(P) is empty:
       1. Check GlobalQueue
       2. Steal from other P's LocalQueue
       3. Block (no work)

5. è°ƒåº¦æ—¶æœº:
   - å‡½æ•°è°ƒç”¨ï¼ˆåä½œå¼ï¼‰
   - ç³»ç»Ÿè°ƒç”¨
   - Channelæ“ä½œ
   - æŠ¢å ï¼ˆGo 1.14+ async preemptionï¼‰

6. GOMAXPROCS:
   è®¾ç½®Pçš„æ•°é‡ï¼Œæ§åˆ¶å¹¶è¡Œåº¦
   é»˜è®¤ = CPUæ ¸å¿ƒæ•°
```

**ç¤ºä¾‹**:
```go
// è®¾ç½®GOMAXPROCS
import "runtime"

// è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°
runtime.GOMAXPROCS(runtime.NumCPU())

// è·å–å½“å‰è®¾ç½®
fmt.Println("GOMAXPROCS:", runtime.GOMAXPROCS(0))

// æŸ¥çœ‹goroutineæ•°é‡
fmt.Println("NumGoroutine:", runtime.NumGoroutine())
```

---

## 3. æ¦‚å¿µå…³ç³»å›¾è°±

### 3.1 æ¦‚å¿µä¾èµ–å›¾

```text
                 CSPæ¨¡å‹ (ç†è®ºåŸºç¡€)
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚          â”‚          â”‚
     Goroutine   Channel    è°ƒåº¦å™¨(GMP)
          â”‚          â”‚          â”‚
          â”‚          â”‚          â”‚
      å¹¶å‘æ‰§è¡Œ     é€šä¿¡æœºåˆ¶    è°ƒåº¦æ‰§è¡Œ
          â”‚          â”‚          â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
               â”‚          â”‚
            Select    Context
               â”‚          â”‚
          å¤šè·¯å¤ç”¨   ç”Ÿå‘½å‘¨æœŸæ§åˆ¶
               â”‚          â”‚
               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                    â”‚
              å¹¶å‘æ¨¡å¼ï¼ˆå®æˆ˜ï¼‰
```

### 3.2 æ¦‚å¿µåˆ†ç±»å›¾

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            Goå¹¶å‘ç¼–ç¨‹æ¦‚å¿µä½“ç³»
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç†è®ºå±‚ (Theory)
â”œâ”€â”€ CSPæ¨¡å‹          [C12]
â”œâ”€â”€ å†…å­˜æ¨¡å‹        [C14]
â””â”€â”€ GMPè°ƒåº¦         [C15]

åŸºç¡€å±‚ (Primitives)
â”œâ”€â”€ Goroutine       [C01]
â”œâ”€â”€ Channel         [C03]
â””â”€â”€ Select          [C04]

åŒæ­¥å±‚ (Synchronization)
â”œâ”€â”€ Mutex           [C06]
â”œâ”€â”€ RWMutex         [C07]
â”œâ”€â”€ WaitGroup       [C08]
â”œâ”€â”€ Once            [C09]
â”œâ”€â”€ Cond            [C10]
â””â”€â”€ atomic          [C11]

æ§åˆ¶å±‚ (Control)
â”œâ”€â”€ Context         [C05]
â””â”€â”€ æŠ¢å è°ƒåº¦        [C16]

åº”ç”¨å±‚ (Patterns)
â””â”€â”€ å¹¶å‘æ¨¡å¼        [C13]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## 4. æ¦‚å¿µå±‚æ¬¡ç»“æ„

### 4.1 æŠ½è±¡å±‚æ¬¡

```text
å±‚æ¬¡ 5: å¹¶å‘æ¨¡å¼        (Concurrency Patterns)
  â†‘
å±‚æ¬¡ 4: æ§åˆ¶æœºåˆ¶        Contextã€Selectã€å¹¶å‘æ§åˆ¶
  â†‘
å±‚æ¬¡ 3: åŒæ­¥åŸè¯­        Mutexã€WaitGroupã€atomic
  â†‘
å±‚æ¬¡ 2: é€šä¿¡æœºåˆ¶        Channelã€Select
  â†‘
å±‚æ¬¡ 1: å¹¶å‘å•å…ƒ        Goroutine
  â†‘
å±‚æ¬¡ 0: ç†è®ºåŸºç¡€        CSPã€GMPã€å†…å­˜æ¨¡å‹
```

### 4.2 å­¦ä¹ å±‚æ¬¡å»ºè®®

**ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€ç†è®ºï¼ˆå±‚æ¬¡0-1ï¼‰**
```text
æŒæ¡: CSPæ¨¡å‹ã€Goroutineåˆ›å»ºã€åŸºæœ¬æ¦‚å¿µ
ç›®æ ‡: ç†è§£å¹¶å‘åŸºç¡€
æ—¶é—´: 1-2å¤©
```

**ç¬¬äºŒé˜¶æ®µ: é€šä¿¡æœºåˆ¶ï¼ˆå±‚æ¬¡2ï¼‰**
```text
æŒæ¡: Channelã€Selectã€é€šä¿¡æ¨¡å¼
ç›®æ ‡: æŒæ¡goroutineé€šä¿¡
æ—¶é—´: 3-5å¤©
```

**ç¬¬ä¸‰é˜¶æ®µ: åŒæ­¥æ§åˆ¶ï¼ˆå±‚æ¬¡3ï¼‰**
```text
æŒæ¡: Mutexã€WaitGroupã€syncåŒ…
ç›®æ ‡: æŒæ¡åŒæ­¥åŸè¯­
æ—¶é—´: 3-5å¤©
```

**ç¬¬å››é˜¶æ®µ: é«˜çº§æ§åˆ¶ï¼ˆå±‚æ¬¡4ï¼‰**
```text
æŒæ¡: Contextã€è°ƒåº¦å™¨ã€å†…å­˜æ¨¡å‹
ç›®æ ‡: æ·±å…¥ç†è§£å¹¶å‘æœºåˆ¶
æ—¶é—´: 1å‘¨
```

**ç¬¬äº”é˜¶æ®µ: å®æˆ˜æ¨¡å¼ï¼ˆå±‚æ¬¡5ï¼‰**
```text
æŒæ¡: å¹¶å‘æ¨¡å¼ã€æ€§èƒ½ä¼˜åŒ–
ç›®æ ‡: ç¼–å†™é«˜è´¨é‡å¹¶å‘ä»£ç 
æ—¶é—´: 2å‘¨+
```

---

## ğŸ“Š ä½¿ç”¨æŒ‡å—

### å¦‚ä½•ä½¿ç”¨æœ¬æ–‡æ¡£

**1. ç†è§£æ¦‚å¿µ**:
- é˜…è¯»å½¢å¼åŒ–å®šä¹‰
- ç†è§£å†…æ¶µï¼ˆæœ¬è´¨æ˜¯ä»€ä¹ˆï¼‰
- ç†è§£å¤–å»¶ï¼ˆèŒƒå›´è¾¹ç•Œï¼‰

**2. å»ºç«‹è”ç³»**:
- æŸ¥çœ‹æ¦‚å¿µå…³ç³»å›¾è°±
- ç†è§£æ¦‚å¿µé—´çš„ä¾èµ–å’Œå…³è”
- æ„å»ºå®Œæ•´çš„çŸ¥è¯†ç½‘ç»œ

**3. å®è·µåº”ç”¨**:
- ç»“åˆä»£ç ç¤ºä¾‹
- ç†è§£å½¢å¼åŒ–æ€§è´¨çš„å®é™…å«ä¹‰
- åœ¨å®è·µä¸­éªŒè¯æ¦‚å¿µ

**4. ç³»ç»Ÿå­¦ä¹ **:
- æŒ‰ç…§å±‚æ¬¡ç»“æ„å­¦ä¹ 
- å…ˆæŒæ¡åŸºç¡€å±‚ï¼Œå†è¿›é˜¶
- å¾ªåºæ¸è¿›ï¼Œç¨³æ‰ç¨³æ‰“

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [00-çŸ¥è¯†å›¾è°±.md](./00-çŸ¥è¯†å›¾è°±.md) - çŸ¥è¯†ç»“æ„
- [00-å¯¹æ¯”çŸ©é˜µ.md](./00-å¯¹æ¯”çŸ©é˜µ.md) - æ¦‚å¿µå¯¹æ¯”
- [README.md](./README.md) - ç›®å½•æ€»è§ˆ

---

**æœ€åæ›´æ–°**: 2025-10-28  
**ç»´æŠ¤è€…**: Goå½¢å¼åŒ–ç†è®ºä½“ç³»é¡¹ç›®ç»„

---

> **å½¢å¼åŒ–å®šä¹‰å¹¶å‘æ¦‚å¿µï¼Œç²¾ç¡®ç†è§£Goå¹¶å‘** ğŸ“  
> **ä»CSPåˆ°GMPï¼Œç³»ç»ŸåŒ–æŒæ¡å¹¶å‘æœºåˆ¶** ğŸ’¡

