# 项目定位与任务梳理

**版本**: v1.0
**更新日期**: 2025-11-11
**适用于**: Go 1.25.3

---

## 📋 目录

- [项目定位与任务梳理](#项目定位与任务梳理)
  - [📋 目录](#-目录)
  - [1. 项目定位](#1-项目定位)
    - [1.1 项目性质](#11-项目性质)
    - [1.2 设计理念](#12-设计理念)
    - [1.3 使用方式](#13-使用方式)
  - [2. 核心原则](#2-核心原则)
    - [2.1 框架设计原则](#21-框架设计原则)
    - [2.2 Clean Architecture 在框架中的应用](#22-clean-architecture-在框架中的应用)
  - [3. 当前框架状态](#3-当前框架状态)
    - [3.1 ✅ 已完成的核心框架](#31--已完成的核心框架)
      - [3.1.1 核心工具包 (`pkg/`)](#311-核心工具包-pkg)
      - [3.1.2 中间件系统 (`internal/interfaces/http/chi/middleware/`)](#312-中间件系统-internalinterfaceshttpchimiddleware)
      - [3.1.3 基础设施层 (`internal/infrastructure/`)](#313-基础设施层-internalinfrastructure)
      - [3.1.4 接口层 (`internal/interfaces/`)](#314-接口层-internalinterfaces)
      - [3.1.5 部署配置 (`deployments/`)](#315-部署配置-deployments)
    - [3.2 ⚠️ 需要清理的内容](#32-️-需要清理的内容)
    - [3.3 🔄 需要完善的技术栈](#33--需要完善的技术栈)
      - [3.3.1 数据库支持](#331-数据库支持)
      - [3.3.2 消息队列](#332-消息队列)
      - [3.3.3 可观测性](#333-可观测性)
      - [3.3.4 缓存](#334-缓存)
      - [3.3.5 配置管理](#335-配置管理)
  - [4. 技术栈完善计划](#4-技术栈完善计划)
    - [4.1 数据库层完善](#41-数据库层完善)
      - [4.1.1 SQLite3 支持](#411-sqlite3-支持)
      - [4.1.2 Ent Schema 示例](#412-ent-schema-示例)
      - [4.1.3 数据库迁移工具](#413-数据库迁移工具)
    - [4.2 消息队列完善](#42-消息队列完善)
      - [4.2.1 Kafka 完善](#421-kafka-完善)
      - [4.2.2 MQTT 完善](#422-mqtt-完善)
    - [4.3 可观测性完善](#43-可观测性完善)
      - [4.3.1 OTLP 完善](#431-otlp-完善)
      - [4.3.2 日志聚合](#432-日志聚合)
    - [4.4 缓存完善](#44-缓存完善)
      - [4.4.1 Redis 客户端封装](#441-redis-客户端封装)
      - [4.4.2 缓存策略](#442-缓存策略)
    - [4.5 配置管理完善](#45-配置管理完善)
      - [4.5.1 Viper 集成](#451-viper-集成)
  - [5. 后续任务清单](#5-后续任务清单)
    - [5.1 立即任务（清理错误内容）](#51-立即任务清理错误内容)
    - [5.2 短期任务（1-2周）](#52-短期任务1-2周)
    - [5.3 中期任务（2-4周）](#53-中期任务2-4周)
    - [5.4 长期任务（持续）](#54-长期任务持续)
  - [6. 总结](#6-总结)
    - [6.1 项目定位](#61-项目定位)
    - [6.2 当前状态](#62-当前状态)
    - [6.3 后续重点](#63-后续重点)

---

## 1. 项目定位

### 1.1 项目性质

本项目是一个**通用 Go 语言企业级开发框架**，而非具体的业务应用。

**核心定位**：

- ✅ **框架层**：提供基础设施、工具库、中间件系统
- ✅ **技术栈集成**：集成 Go 生态最优秀的技术栈
- ✅ **架构模式**：基于 Clean Architecture 的框架抽象
- ❌ **不包含具体业务**：不依赖任何领域业务模型
- ❌ **不包含业务逻辑**：不包含具体的业务用例实现

### 1.2 设计理念

1. **框架抽象**：提供通用的框架抽象和接口
2. **技术实现**：提供完整的技术栈实现（数据库、消息队列、可观测性等）
3. **开箱即用**：提供生产就绪的中间件和工具
4. **可扩展性**：用户可以通过 schema 定义自己的业务领域模型

### 1.3 使用方式

用户使用本框架时：

1. 通过 **Ent Schema** 定义自己的业务领域模型
2. 通过 **框架提供的接口** 实现自己的业务逻辑
3. 使用 **框架提供的基础设施**（数据库、消息队列、缓存等）
4. 使用 **框架提供的中间件**（认证、限流、追踪等）

---

## 2. 核心原则

### 2.1 框架设计原则

1. **不依赖业务模型**：框架层不包含任何具体的业务领域模型
2. **接口抽象**：提供通用的接口抽象，而非具体实现
3. **技术栈集成**：专注于技术栈的集成和封装
4. **生产就绪**：提供生产环境所需的各种基础设施

### 2.2 Clean Architecture 在框架中的应用

```text
internal/
├── domain/          # 框架层面的抽象接口（不包含具体业务）
│   └── interfaces/  # 通用接口定义（Repository、Service 等）
├── application/     # 框架层面的应用服务抽象（不包含具体业务用例）
│   └── patterns/    # 通用应用模式（Command、Query、Event 等）
├── infrastructure/  # 技术栈实现
│   ├── database/    # 数据库实现（PostgreSQL、SQLite3、Ent）
│   ├── messaging/   # 消息队列（Kafka、MQTT）
│   ├── cache/       # 缓存（Redis）
│   └── observability/ # 可观测性（OTLP、日志、追踪）
└── interfaces/      # 外部接口适配
    ├── http/        # HTTP 接口（Chi、中间件）
    ├── grpc/        # gRPC 接口
    └── graphql/     # GraphQL 接口
```

---

## 3. 当前框架状态

### 3.1 ✅ 已完成的核心框架

#### 3.1.1 核心工具包 (`pkg/`)

- ✅ **错误处理** (`pkg/errors`) - 统一错误处理框架
- ✅ **HTTP 响应** (`pkg/http/response`) - 统一响应格式
- ✅ **日志** (`pkg/logger`) - 结构化日志（基于 slog，集成 OpenTelemetry）
- ✅ **验证器** (`pkg/validator`) - 请求验证框架
- ✅ **JWT 认证** (`pkg/auth/jwt`) - JWT Token 认证
- ✅ **事件总线** (`pkg/eventbus`) - 事件发布订阅
- ✅ **事务管理** (`pkg/transaction`) - 事务管理框架
- ✅ **RBAC** (`pkg/rbac`) - 角色权限控制
- ✅ **服务注册** (`pkg/registry`) - 服务注册与发现
- ✅ **负载均衡** (`pkg/loadbalancer`) - 负载均衡器
- ✅ **健康检查** (`pkg/health`) - 健康检查框架
- ✅ **HTTP/3** (`pkg/http3`) - HTTP/3 支持
- ✅ **可观测性** (`pkg/observability`) - OpenTelemetry 集成
- ✅ **并发工具** (`pkg/concurrency`) - 并发模式
- ✅ **内存管理** (`pkg/memory`) - 内存池、弱指针等
- ✅ **AI Agent** (`pkg/agent`) - AI 代理系统
- ✅ **工具库** (`pkg/utils/`) - 46+ 个工具模块

#### 3.1.2 中间件系统 (`internal/interfaces/http/chi/middleware/`)

- ✅ **认证授权中间件** - JWT Token 验证、角色权限控制
- ✅ **限流中间件** - 令牌桶、滑动窗口、漏桶算法，支持 Redis 分布式限流
- ✅ **熔断器中间件** - 三种状态（关闭、开启、半开）
- ✅ **请求追踪中间件** - OpenTelemetry 集成
- ✅ **性能监控中间件** - 请求计数、耗时统计
- ✅ **恢复中间件** - Panic 恢复
- ✅ **CORS 中间件** - 跨域资源共享

#### 3.1.3 基础设施层 (`internal/infrastructure/`)

- ✅ **数据库连接** (`database/postgres/connection.go`) - PostgreSQL 连接管理
- ✅ **Ent ORM** (`database/ent/`) - Ent 代码生成和客户端
- ⚠️ **消息队列** (`messaging/`)
  - ✅ Kafka 生产者/消费者
  - ✅ MQTT 客户端
- ⚠️ **可观测性** (`observability/`)
  - ✅ OpenTelemetry 集成（Logger、Metrics、Tracer）
  - ✅ eBPF 收集器
- ⚠️ **工作流** (`workflow/temporal/`) - Temporal 客户端和工作器

#### 3.1.4 接口层 (`internal/interfaces/`)

- ✅ **HTTP 接口** (`http/chi/`) - Chi 路由、中间件、处理器
- ✅ **gRPC 接口** (`grpc/`) - gRPC 服务器和处理器
- ✅ **GraphQL 接口** (`graphql/`) - GraphQL 解析器
- ✅ **AsyncAPI** (`asyncapi/`) - AsyncAPI 定义

#### 3.1.5 部署配置 (`deployments/`)

- ✅ **Docker Compose** - 完整的服务编排
  - PostgreSQL（主备复制）
  - Redis
  - Temporal
  - OpenTelemetry Collector
  - Prometheus
  - Grafana
  - Jaeger
- ✅ **PostgreSQL 管理脚本** - 备份、恢复、维护、性能监控
- ✅ **Kubernetes** - K8s 部署配置

### 3.2 ⚠️ 需要清理的内容

以下内容是我错误添加的具体业务模型，需要清理：

- ❌ `internal/domain/user/` - 用户领域模型（应删除）
- ❌ `internal/domain/order/` - 订单领域模型（应删除）
- ❌ `internal/domain/product/` - 产品领域模型（应删除）
- ❌ `internal/application/user/` - 用户应用服务（应删除）
- ❌ `internal/application/order/` - 订单应用服务（应删除）
- ❌ `internal/application/product/` - 产品应用服务（应删除）
- ❌ `internal/infrastructure/database/postgres/user_repository.go` - 用户仓储实现（应删除）
- ❌ `internal/infrastructure/database/postgres/order_repository.go` - 订单仓储实现（应删除）
- ❌ `internal/infrastructure/database/postgres/product_repository.go` - 产品仓储实现（应删除）
- ❌ `internal/interfaces/http/chi/handlers/user_handler.go` - 用户处理器（应删除或改为示例）
- ❌ `internal/interfaces/http/chi/handlers/order_handler.go` - 订单处理器（应删除或改为示例）
- ❌ `internal/interfaces/http/chi/handlers/product_handler.go` - 产品处理器（应删除或改为示例）
- ⚠️ `internal/infrastructure/database/ent/schema/user.go` - Ent Schema（应改为示例或删除）

### 3.3 🔄 需要完善的技术栈

#### 3.3.1 数据库支持

- ⏳ **SQLite3 支持** - 添加 SQLite3 数据库连接和实现
- ⏳ **Ent Schema 示例** - 提供 Ent Schema 定义示例（不包含具体业务）
- ⏳ **数据库迁移工具** - 完善数据库迁移脚本和工具
- ⏳ **连接池管理** - 完善数据库连接池配置和管理
- ⏳ **读写分离支持** - 支持 PostgreSQL 主备读写分离

#### 3.3.2 消息队列

- ⏳ **Kafka 完善** - 完善 Kafka 生产者/消费者配置和错误处理
- ⏳ **MQTT 完善** - 完善 MQTT 客户端功能和重连机制
- ⏳ **消息序列化** - 支持多种消息序列化格式（JSON、Protobuf、Avro）
- ⏳ **消息路由** - 消息路由和过滤机制

#### 3.3.3 可观测性

- ⏳ **OTLP 完善** - 完善 OpenTelemetry 配置和导出
- ⏳ **日志聚合** - 日志收集和聚合配置
- ⏳ **指标收集** - Prometheus 指标收集和暴露
- ⏳ **分布式追踪** - Jaeger 追踪配置和采样策略
- ⏳ **性能分析** - 性能分析和 profiling 工具

#### 3.3.4 缓存

- ⏳ **Redis 客户端封装** - 完善 Redis 客户端封装
- ⏳ **缓存策略** - 缓存策略和模式（Cache-Aside、Write-Through、Write-Back）
- ⏳ **缓存一致性** - 缓存一致性保证机制
- ⏳ **分布式锁** - 基于 Redis 的分布式锁

#### 3.3.5 配置管理

- ⏳ **Viper 集成** - 完善 Viper 配置管理
- ⏳ **环境变量** - 环境变量配置和验证
- ⏳ **配置热重载** - 配置热重载机制
- ⏳ **配置中心集成** - 配置中心（Consul、etcd）集成

---

## 4. 技术栈完善计划

### 4.1 数据库层完善

#### 4.1.1 SQLite3 支持

**目标**：添加 SQLite3 数据库支持

**任务**：

- [ ] 创建 `internal/infrastructure/database/sqlite3/` 目录
- [ ] 实现 SQLite3 连接管理
- [ ] 实现 SQLite3 连接池
- [ ] 提供 Ent SQLite3 驱动配置示例
- [ ] 添加 SQLite3 测试

#### 4.1.2 Ent Schema 示例

**目标**：提供 Ent Schema 定义示例（通用模式，不包含具体业务）

**任务**：

- [ ] 创建 `examples/ent-schema/` 目录
- [ ] 提供基础 Entity Schema 示例
- [ ] 提供关系定义示例
- [ ] 提供索引定义示例
- [ ] 提供迁移示例

#### 4.1.3 数据库迁移工具

**目标**：完善数据库迁移工具

**任务**：

- [ ] 完善 Ent 迁移脚本
- [ ] 提供 PostgreSQL 迁移脚本模板
- [ ] 提供 SQLite3 迁移脚本模板
- [ ] 添加迁移回滚支持
- [ ] 添加迁移验证工具

### 4.2 消息队列完善

#### 4.2.1 Kafka 完善

**目标**：完善 Kafka 生产者/消费者

**任务**：

- [ ] 完善错误处理和重试机制
- [ ] 添加消息压缩支持
- [ ] 添加消息分区策略
- [ ] 添加消费者组管理
- [ ] 添加消息序列化器（JSON、Protobuf、Avro）

#### 4.2.2 MQTT 完善

**目标**：完善 MQTT 客户端

**任务**：

- [ ] 完善重连机制
- [ ] 添加 QoS 级别支持
- [ ] 添加消息持久化
- [ ] 添加主题过滤
- [ ] 添加遗嘱消息支持

### 4.3 可观测性完善

#### 4.3.1 OTLP 完善

**目标**：完善 OpenTelemetry 集成

**任务**：

- [ ] 完善 OTLP 导出配置
- [ ] 添加采样策略配置
- [ ] 添加资源属性配置
- [ ] 添加指标导出
- [ ] 添加日志导出

#### 4.3.2 日志聚合

**目标**：完善日志收集和聚合

**任务**：

- [ ] 配置日志输出格式（JSON、Text）
- [ ] 添加日志级别动态调整
- [ ] 添加日志采样配置
- [ ] 添加日志轮转配置
- [ ] 集成日志收集器（Loki、Elasticsearch）

### 4.4 缓存完善

#### 4.4.1 Redis 客户端封装

**目标**：完善 Redis 客户端封装

**任务**：

- [ ] 创建 `internal/infrastructure/cache/redis/` 目录
- [ ] 实现 Redis 客户端封装
- [ ] 实现连接池管理
- [ ] 实现重连机制
- [ ] 添加 Redis Cluster 支持

#### 4.4.2 缓存策略

**目标**：实现常用缓存策略

**任务**：

- [ ] 实现 Cache-Aside 模式
- [ ] 实现 Write-Through 模式
- [ ] 实现 Write-Back 模式
- [ ] 实现缓存预热
- [ ] 实现缓存穿透/击穿/雪崩防护

### 4.5 配置管理完善

#### 4.5.1 Viper 集成

**目标**：完善 Viper 配置管理

**任务**：

- [ ] 创建 `internal/config/` 配置管理
- [ ] 实现配置结构体定义
- [ ] 实现配置加载和验证
- [ ] 实现环境变量覆盖
- [ ] 实现配置热重载

---

## 5. 后续任务清单

### 5.1 立即任务（清理错误内容）

- [ ] **删除具体业务模型**
  - [ ] 删除 `internal/domain/user/`
  - [ ] 删除 `internal/domain/order/`
  - [ ] 删除 `internal/domain/product/`
  - [ ] 删除 `internal/application/user/`
  - [ ] 删除 `internal/application/order/`
  - [ ] 删除 `internal/application/product/`
  - [ ] 删除 `internal/infrastructure/database/postgres/*_repository.go`（业务相关）
  - [ ] 删除或改为示例 `internal/interfaces/http/chi/handlers/*_handler.go`（业务相关）

- [ ] **更新文档**
  - [ ] 更新 `internal/domain/README.md` - 说明框架抽象接口
  - [ ] 更新 `internal/application/README.md` - 说明框架应用模式
  - [ ] 更新 `internal/infrastructure/README.md` - 说明技术栈实现

### 5.2 短期任务（1-2周）

- [ ] **SQLite3 支持**
  - [ ] 实现 SQLite3 连接管理
  - [ ] 提供 Ent SQLite3 配置示例
  - [ ] 添加测试

- [ ] **Redis 缓存完善**
  - [ ] 实现 Redis 客户端封装
  - [ ] 实现缓存策略
  - [ ] 实现分布式锁

- [ ] **配置管理完善**
  - [ ] 完善 Viper 集成
  - [ ] 实现配置热重载
  - [ ] 添加配置验证

### 5.3 中期任务（2-4周）

- [ ] **消息队列完善**
  - [ ] 完善 Kafka 错误处理
  - [ ] 完善 MQTT 重连机制
  - [ ] 添加消息序列化支持

- [ ] **可观测性完善**
  - [ ] 完善 OTLP 配置
  - [ ] 添加采样策略
  - [ ] 集成日志收集器

- [ ] **数据库迁移工具**
  - [ ] 完善 Ent 迁移
  - [ ] 添加迁移回滚
  - [ ] 添加迁移验证

### 5.4 长期任务（持续）

- [ ] **性能优化**
  - [ ] 数据库连接池优化
  - [ ] 缓存性能优化
  - [ ] 消息队列性能优化

- [ ] **文档完善**
  - [ ] 框架使用指南
  - [ ] 技术栈集成指南
  - [ ] 最佳实践文档

- [ ] **示例代码**
  - [ ] Ent Schema 定义示例
  - [ ] 业务领域建模示例
  - [ ] 完整应用示例

---

## 6. 总结

### 6.1 项目定位

本项目是一个**通用 Go 语言企业级开发框架**，专注于：

- ✅ 提供基础设施和工具库
- ✅ 集成优秀的技术栈
- ✅ 提供生产就绪的中间件
- ❌ 不包含具体业务模型

### 6.2 当前状态

- ✅ **核心框架**：已完成（错误处理、日志、认证、中间件等）
- ✅ **基础设施**：部分完成（PostgreSQL、Kafka、MQTT、OTLP）
- ⚠️ **需要清理**：删除错误添加的具体业务模型
- ⏳ **需要完善**：SQLite3、Redis、配置管理、消息队列完善

### 6.3 后续重点

1. **清理错误内容**：删除具体业务模型
2. **完善技术栈**：SQLite3、Redis、配置管理
3. **完善基础设施**：消息队列、可观测性
4. **提供示例**：Ent Schema 示例、使用示例

---

**更新日期**: 2025-11-11
