# Go 1.25.3 轻量级技术栈框架 - 重新定位与改进计划

> **版本**: v2.0
> **日期**: 2025-01-XX
> **新定位**: Go 1.25.3 + 最新技术堆栈 + Clean Architecture（轻量级，不包含复杂 DDD 抽象）

---

## 📋 目录

- [1. 项目重新定位](#1-项目重新定位)
- [2. 架构设计调整](#2-架构设计调整)
- [3. 技术栈现状](#3-技术栈现状)
- [4. 改进计划（简化版）](#4-改进计划简化版)
- [5. 实施优先级（调整后）](#5-实施优先级调整后)

---

## 1. 项目重新定位

### 1.1 核心定位（更新）

**项目性质**: Go 语言轻量级技术栈框架
**技术目标**: 集成最新、最成熟的技术堆栈
**架构原则**: Clean Architecture（简化版，不包含复杂 DDD 抽象）
**业务范围**: **仅实现基础技术堆栈，不实现业务模型代码**

### 1.2 设计理念调整

#### ❌ 移除的复杂设计
- ❌ 复杂的 DDD 抽象（聚合根、值对象、领域事件框架）
- ❌ 过度的领域模型抽象
- ❌ 复杂的事件总线
- ❌ 过度的设计模式应用

#### ✅ 保留的核心设计
- ✅ Clean Architecture 分层（简化版）
- ✅ 接口定义和实现分离
- ✅ 依赖注入（Wire）
- ✅ 多协议支持（HTTP, gRPC, GraphQL）
- ✅ 多存储支持（PostgreSQL, SQLite3）

### 1.3 架构简化原则

**原则 1: 实用优先**
- 只实现实际需要的功能
- 避免过度设计
- 保持代码简洁易懂

**原则 2: 技术栈为主**
- 专注于技术栈集成
- 提供清晰的接口和示例
- 不强制特定的业务模型

**原则 3: 渐进式增强**
- 基础功能先实现
- 复杂功能按需添加
- 保持框架轻量级

---

## 2. 架构设计调整

### 2.1 Clean Architecture 简化版

#### 2.1.1 四层架构（保持）

```text
┌─────────────────────────────────────────┐
│      Interfaces Layer (接口层)           │
│   HTTP, gRPC, GraphQL 协议适配          │
└──────────────────┬──────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────┐
│    Application Layer (应用层)            │
│    用例编排、业务协调（简化）             │
└──────────────────┬──────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────┐
│      Domain Layer (领域层)               │
│    接口定义、简单实体（简化）             │
└──────────────────┬──────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────┐
│  Infrastructure Layer (基础设施层)        │
│  技术实现：数据库、消息队列、可观测性      │
└─────────────────────────────────────────┘
```

#### 2.1.2 Domain Layer 简化

**简化前（复杂 DDD）**:
- ❌ 聚合根抽象
- ❌ 值对象抽象
- ❌ 领域事件框架
- ❌ 复杂的事件总线

**简化后（轻量级）**:
- ✅ 简单的实体结构体
- ✅ Repository 接口定义
- ✅ Service 接口定义
- ✅ 简单的错误定义

**示例**:
```go
// 简化版 Domain Layer
package domain

// User 简单的实体（不是复杂的聚合根）
type User struct {
    ID        string
    Name      string
    Email     string
    CreatedAt time.Time
}

// UserRepository 仓储接口（简单接口，不强制 DDD 模式）
type UserRepository interface {
    FindByID(ctx context.Context, id string) (*User, error)
    Save(ctx context.Context, user *User) error
    Delete(ctx context.Context, id string) error
}
```

### 2.2 Application Layer 简化

**简化前（复杂 CQRS）**:
- ❌ Command/Query 分离
- ❌ 复杂的事件处理
- ❌ 复杂的用例编排

**简化后（轻量级）**:
- ✅ 简单的 Service 实现
- ✅ 直接调用 Repository
- ✅ 简单的业务逻辑

**示例**:
```go
// 简化版 Application Layer
package application

type UserService struct {
    repo domain.UserRepository
}

func (s *UserService) GetUser(ctx context.Context, id string) (*domain.User, error) {
    return s.repo.FindByID(ctx, id)
}

func (s *UserService) CreateUser(ctx context.Context, name, email string) (*domain.User, error) {
    user := &domain.User{
        ID:        uuid.New().String(),
        Name:      name,
        Email:     email,
        CreatedAt: time.Now(),
    }
    return user, s.repo.Save(ctx, user)
}
```

---

## 3. 技术栈现状

### 3.1 已实现技术栈 ✅

| 技术栈 | 状态 | 成熟度 | 优先级 |
|--------|------|--------|--------|
| OpenTelemetry (OTLP) | ✅ 完整 | ⭐⭐⭐⭐ | 保持 |
| PostgreSQL | ✅ 完整 | ⭐⭐⭐⭐ | 保持 |
| SQLite3 | ✅ 完整 | ⭐⭐⭐⭐ | 保持 |
| MQTT | ✅ 完整 | ⭐⭐⭐⭐ | 保持 |
| Kafka | ✅ 完整 | ⭐⭐⭐⭐ | 保持 |
| OpenAPI | ✅ 规范完整 | ⭐⭐⭐ | 完善工具链 |
| AsyncAPI | ✅ 规范完整 | ⭐⭐⭐ | 完善工具链 |
| GraphQL | ✅ Schema 完整 | ⭐⭐⭐ | 完善实现 |

### 3.2 需要完善的技术栈 ⚠️

| 技术栈 | 状态 | 问题 | 优先级 |
|--------|------|------|--------|
| gRPC | ⚠️ 部分实现 | Proto 缺失、Handler 缺失 | 🔴 高 |
| NATS | ❌ 缺失 | 完全未实现 | 🔴 高 |

### 3.3 移除的复杂功能 ❌

| 功能 | 原因 | 替代方案 |
|------|------|----------|
| DDD 聚合根抽象 | 过于复杂，不符合轻量级定位 | 使用简单结构体 |
| 值对象抽象 | 过度设计 | 使用普通结构体 |
| 领域事件框架 | 复杂，使用场景有限 | 按需实现简单事件 |
| 复杂事件总线 | 过度设计 | 使用消息队列直接通信 |

---

## 4. 改进计划（简化版）

### 4.1 Phase 1: 补齐核心功能 (2 周)

#### Week 1: NATS 实现
- [ ] 创建 NATS 客户端实现
  - [ ] `internal/infrastructure/messaging/nats/client.go`
  - [ ] 发布/订阅功能
  - [ ] Request/Reply 模式
- [ ] 添加依赖和测试
- [ ] 更新文档

#### Week 2: gRPC 完善
- [ ] 创建 Proto 文件定义
  - [ ] `internal/interfaces/grpc/proto/user.proto` (示例)
  - [ ] `internal/interfaces/grpc/proto/health.proto`
- [ ] 创建代码生成脚本
- [ ] 实现 Handler（简化版）
- [ ] 实现基础拦截器（日志、追踪）

### 4.2 Phase 2: 完善工具链 (2 周)

#### Week 3: 代码生成工具链
- [ ] OpenAPI 代码生成
- [ ] AsyncAPI 代码生成（可选）
- [ ] GraphQL 代码生成（可选）

#### Week 4: 统一接口抽象（可选）
- [ ] 消息队列统一接口（简化版）
- [ ] 数据库统一接口完善

### 4.3 Phase 3: 优化和文档 (持续)

- [ ] 性能优化
- [ ] 文档完善
- [ ] 使用示例完善

---

## 5. 实施优先级（调整后）

### 5.1 优先级矩阵（更新）

| 功能 | 优先级 | 影响 | 工作量 | 推荐顺序 |
|------|--------|------|--------|----------|
| NATS 实现 | 🔴 高 | 高 | 中 | 1 |
| gRPC 完善 | 🔴 高 | 高 | 中 | 2 |
| 代码生成工具链 | 🟡 中 | 中 | 中 | 3 |
| 统一接口抽象 | 🟢 低 | 低 | 中 | 4（可选） |

### 5.2 移除的优先级项

| 功能 | 移除原因 |
|------|----------|
| DDD 框架抽象 | 不符合轻量级定位 |
| 复杂事件总线 | 过度设计 |
| 聚合根抽象 | 过于复杂 |

### 5.3 推荐实施路径（简化版）

**路径: 轻量级快速补齐**
1. NATS 实现 (Week 1)
2. gRPC 完善 (Week 2)
3. 代码生成工具链 (Week 3)
4. 文档和示例完善 (Week 4)

**总时间**: 4 周（比原计划减少 2 周）

---

## 6. 架构设计原则（更新）

### 6.1 核心原则

1. **轻量级优先**
   - 避免过度设计
   - 保持代码简洁
   - 只实现必要功能

2. **技术栈为主**
   - 专注于技术栈集成
   - 提供清晰的接口
   - 不强制业务模型

3. **渐进式增强**
   - 基础功能先实现
   - 复杂功能按需添加
   - 保持框架可扩展

### 6.2 Clean Architecture 简化原则

1. **Domain Layer 简化**
   - 只定义接口和简单实体
   - 不强制 DDD 模式
   - 保持灵活性

2. **Application Layer 简化**
   - 简单的 Service 实现
   - 直接调用 Repository
   - 避免复杂的编排

3. **Infrastructure Layer 保持**
   - 技术实现完整
   - 接口实现清晰
   - 保持可替换性

---

## 7. 技术栈版本建议（保持）

### 7.1 核心依赖版本

```go
require (
    // 核心框架
    github.com/go-chi/chi/v5 v5.0.12
    entgo.io/ent v0.13.0

    // 消息队列
    github.com/IBM/sarama v1.43.0
    github.com/eclipse/paho.mqtt.golang v1.5.0
    github.com/nats-io/nats.go v1.35.0  // 新增

    // gRPC
    google.golang.org/grpc v1.76.0
    google.golang.org/protobuf v1.36.0

    // OpenTelemetry
    go.opentelemetry.io/otel v1.38.0

    // 其他
    github.com/spf13/viper v1.18.0
    go.temporal.io/sdk v1.38.0
)
```

---

## 8. 总结

### 8.1 定位调整总结

**调整前**:
- ❌ DDD 框架（复杂）
- ❌ 聚合根、值对象抽象
- ❌ 复杂事件总线
- ⚠️ 6 周改进计划

**调整后**:
- ✅ 轻量级技术栈框架
- ✅ Clean Architecture（简化版）
- ✅ 简单实体和接口
- ✅ 4 周改进计划

### 8.2 下一步行动

1. **立即实施** (Week 1-2)
   - 实现 NATS 客户端
   - 完善 gRPC 实现

2. **短期改进** (Week 3-4)
   - 代码生成工具链
   - 文档和示例完善

3. **持续优化** (长期)
   - 性能优化
   - 文档完善

---

## 📚 相关文档

- [技术栈对标分析](00-技术栈对标分析与改进计划.md) - 详细技术栈分析
- [技术栈实施细节](00-技术栈实施细节与代码建议.md) - 代码实现建议
- [架构文档](architecture/README.md) - 架构设计文档

---

**最后更新**: 2025-01-XX
**定位**: 轻量级技术栈框架
