# 13.2 æœåŠ¡æ³¨å†Œä¸å‘ç°

<!-- TOC START -->
- [13.2 æœåŠ¡æ³¨å†Œä¸å‘ç°](#132-æœåŠ¡æ³¨å†Œä¸å‘ç°)
  - [13.2.1 ğŸ“š ç†è®ºåˆ†æ](#1321--ç†è®ºåˆ†æ)
    - [13.2.1.1 æœåŠ¡æ³¨å†Œä¸å‘ç°åŸç†](#13211-æœåŠ¡æ³¨å†Œä¸å‘ç°åŸç†)
    - [13.2.1.2 å¸¸è§æ³¨å†Œä¸­å¿ƒå¯¹æ¯”](#13212-å¸¸è§æ³¨å†Œä¸­å¿ƒå¯¹æ¯”)
    - [13.2.1.3 Goè¯­è¨€å®ç°æ–¹æ¡ˆ](#13213-goè¯­è¨€å®ç°æ–¹æ¡ˆ)
  - [13.2.2 ğŸ’» ä»£ç ç¤ºä¾‹](#1322--ä»£ç ç¤ºä¾‹)
    - [13.2.2.1 ConsulæœåŠ¡æ³¨å†Œ](#13221-consulæœåŠ¡æ³¨å†Œ)
    - [13.2.2.2 etcdæœåŠ¡å‘ç°](#13222-etcdæœåŠ¡å‘ç°)
    - [13.2.2.3 å¥åº·æ£€æŸ¥å®ç°](#13223-å¥åº·æ£€æŸ¥å®ç°)
  - [13.2.3 ğŸ¯ æœ€ä½³å®è·µ](#1323--æœ€ä½³å®è·µ)
  - [13.2.4 ğŸ” å¸¸è§é—®é¢˜](#1324--å¸¸è§é—®é¢˜)
  - [13.2.5 ğŸ“š æ‰©å±•é˜…è¯»](#1325--æ‰©å±•é˜…è¯»)
  - [13.2.6 âœ… è½åœ°æ£€æŸ¥æ¸…å•](#1326--è½åœ°æ£€æŸ¥æ¸…å•)
  - [13.2.7 ğŸ§ª æœ¬åœ°å¿«é€ŸéªŒè¯](#1327--æœ¬åœ°å¿«é€ŸéªŒè¯)
<!-- TOC END -->

## 13.2.1 ğŸ“š ç†è®ºåˆ†æ

### 13.2.1.1 æœåŠ¡æ³¨å†Œä¸å‘ç°åŸç†

æœåŠ¡æ³¨å†Œä¸å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ï¼š

- **æœåŠ¡æ³¨å†Œ**: æœåŠ¡å¯åŠ¨æ—¶å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±çš„ä¿¡æ¯
- **æœåŠ¡å‘ç°**: å®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œä¸­å¿ƒæŸ¥æ‰¾å¯ç”¨çš„æœåŠ¡å®ä¾‹
- **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥æœåŠ¡å®ä¾‹çš„å¥åº·çŠ¶æ€
- **è´Ÿè½½å‡è¡¡**: åœ¨å¤šä¸ªæœåŠ¡å®ä¾‹é—´è¿›è¡Œè´Ÿè½½åˆ†å‘

### 13.2.1.2 å¸¸è§æ³¨å†Œä¸­å¿ƒå¯¹æ¯”

| æ³¨å†Œä¸­å¿ƒ | è¯­è¨€ | ä¸€è‡´æ€§ | æ€§èƒ½ | æ˜“ç”¨æ€§ | ç¤¾åŒºæ´»è·ƒåº¦ |
|----------|------|--------|------|--------|------------|
| Consul | Go | å¼ºä¸€è‡´æ€§ | é«˜ | é«˜ | æ´»è·ƒ |
| etcd | Go | å¼ºä¸€è‡´æ€§ | é«˜ | ä¸­ | æ´»è·ƒ |
| Eureka | Java | æœ€ç»ˆä¸€è‡´æ€§ | ä¸­ | é«˜ | æ´»è·ƒ |
| Nacos | Java | å¼ºä¸€è‡´æ€§ | é«˜ | é«˜ | æ´»è·ƒ |

### 13.2.1.3 Goè¯­è¨€å®ç°æ–¹æ¡ˆ

- **Consul**: å®˜æ–¹Goå®¢æˆ·ç«¯ï¼ŒåŠŸèƒ½å®Œæ•´
- **etcd**: å®˜æ–¹Goå®¢æˆ·ç«¯ï¼Œæ€§èƒ½ä¼˜ç§€
- **go-micro**: å¾®æœåŠ¡æ¡†æ¶ï¼Œå†…ç½®æœåŠ¡å‘ç°
- **kratos**: å­—èŠ‚è·³åŠ¨å¼€æºæ¡†æ¶

## 13.2.2 ğŸ’» ä»£ç ç¤ºä¾‹

### 13.2.2.1 ConsulæœåŠ¡æ³¨å†Œ

```go
package main

import (
    "fmt"
    "log"
    "net/http"
    "time"

    "github.com/hashicorp/consul/api"
)

type ServiceRegistry struct {
    client *api.Client
}

func NewServiceRegistry() (*ServiceRegistry, error) {
    config := api.DefaultConfig()
    config.Address = "localhost:8500"
    
    client, err := api.NewClient(config)
    if err != nil {
        return nil, err
    }
    
    return &ServiceRegistry{client: client}, nil
}

func (sr *ServiceRegistry) Register(serviceName, serviceID, address string, port int) error {
    registration := &api.AgentServiceRegistration{
        ID:      serviceID,
        Name:    serviceName,
        Address: address,
        Port:    port,
        Check: &api.AgentServiceCheck{
            HTTP:                           fmt.Sprintf("http://%s:%d/health", address, port),
            Timeout:                        "3s",
            Interval:                       "10s",
            DeregisterCriticalServiceAfter: "30s",
        },
    }
    
    return sr.client.Agent().ServiceRegister(registration)
}

func (sr *ServiceRegistry) Deregister(serviceID string) error {
    return sr.client.Agent().ServiceDeregister(serviceID)
}

func (sr *ServiceRegistry) Discover(serviceName string) ([]*api.ServiceEntry, error) {
    services, _, err := sr.client.Health().Service(serviceName, "", true, nil)
    return services, err
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    registry, err := NewServiceRegistry()
    if err != nil {
        log.Fatal(err)
    }
    
    // æ³¨å†ŒæœåŠ¡
    err = registry.Register("user-service", "user-service-1", "localhost", 8080)
    if err != nil {
        log.Fatal(err)
    }
    
    // å¥åº·æ£€æŸ¥ç«¯ç‚¹
    http.HandleFunc("/health", func(w http.ResponseWriter, r *http.Request) {
        w.WriteHeader(http.StatusOK)
        w.Write([]byte("OK"))
    })
    
    // å¯åŠ¨æœåŠ¡
    go func() {
        log.Println("æœåŠ¡å¯åŠ¨åœ¨ :8080")
        log.Fatal(http.ListenAndServe(":8080", nil))
    }()
    
    // æœåŠ¡å‘ç°ç¤ºä¾‹
    time.Sleep(5 * time.Second)
    services, err := registry.Discover("user-service")
    if err != nil {
        log.Fatal(err)
    }
    
    for _, service := range services {
        fmt.Printf("å‘ç°æœåŠ¡: %s:%d\n", 
            service.Service.Address, service.Service.Port)
    }
    
    // ä¿æŒè¿è¡Œ
    select {}
}
```

### 13.2.2.2 etcdæœåŠ¡å‘ç°

```go
package main

import (
    "context"
    "fmt"
    "log"
    "time"

    "go.etcd.io/etcd/clientv3"
)

type EtcdRegistry struct {
    client *clientv3.Client
}

func NewEtcdRegistry(endpoints []string) (*EtcdRegistry, error) {
    client, err := clientv3.New(clientv3.Config{
        Endpoints:   endpoints,
        DialTimeout: 5 * time.Second,
    })
    if err != nil {
        return nil, err
    }
    
    return &EtcdRegistry{client: client}, nil
}

func (er *EtcdRegistry) Register(serviceName, serviceID, address string, port int, ttl int64) error {
    key := fmt.Sprintf("/services/%s/%s", serviceName, serviceID)
    value := fmt.Sprintf("%s:%d", address, port)
    
    // åˆ›å»ºç§Ÿçº¦
    lease, err := er.client.Grant(context.Background(), ttl)
    if err != nil {
        return err
    }
    
    // æ³¨å†ŒæœåŠ¡
    _, err = er.client.Put(context.Background(), key, value, clientv3.WithLease(lease.ID))
    if err != nil {
        return err
    }
    
    // ç»­ç§Ÿ
    ch, kaerr := er.client.KeepAlive(context.Background(), lease.ID)
    if kaerr != nil {
        return kaerr
    }
    
    // å¤„ç†ç»­ç§Ÿå“åº”
    go func() {
        for ka := range ch {
            _ = ka
        }
    }()
    
    return nil
}

func (er *EtcdRegistry) Discover(serviceName string) ([]string, error) {
    key := fmt.Sprintf("/services/%s/", serviceName)
    
    resp, err := er.client.Get(context.Background(), key, clientv3.WithPrefix())
    if err != nil {
        return nil, err
    }
    
    var services []string
    for _, kv := range resp.Kvs {
        services = append(services, string(kv.Value))
    }
    
    return services, nil
}

func (er *EtcdRegistry) Watch(serviceName string) <-chan []string {
    ch := make(chan []string, 1)
    
    go func() {
        key := fmt.Sprintf("/services/%s/", serviceName)
        watchCh := er.client.Watch(context.Background(), key, clientv3.WithPrefix())
        
        for wresp := range watchCh {
            services, _ := er.Discover(serviceName)
            ch <- services
        }
    }()
    
    return ch
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    registry, err := NewEtcdRegistry([]string{"localhost:2379"})
    if err != nil {
        log.Fatal(err)
    }
    defer registry.client.Close()
    
    // æ³¨å†ŒæœåŠ¡
    err = registry.Register("user-service", "user-service-1", "localhost", 8080, 10)
    if err != nil {
        log.Fatal(err)
    }
    
    // æœåŠ¡å‘ç°
    services, err := registry.Discover("user-service")
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("å‘ç°æœåŠ¡: %v\n", services)
    
    // ç›‘å¬æœåŠ¡å˜åŒ–
    watchCh := registry.Watch("user-service")
    for services := range watchCh {
        fmt.Printf("æœåŠ¡åˆ—è¡¨æ›´æ–°: %v\n", services)
    }
}
```

### 13.2.2.3 å¥åº·æ£€æŸ¥å®ç°

```go
package main

import (
    "context"
    "fmt"
    "net/http"
    "time"
)

type HealthChecker struct {
    checks map[string]func() error
}

func NewHealthChecker() *HealthChecker {
    return &HealthChecker{
        checks: make(map[string]func() error),
    }
}

func (hc *HealthChecker) AddCheck(name string, check func() error) {
    hc.checks[name] = check
}

func (hc *HealthChecker) CheckHealth() map[string]error {
    results := make(map[string]error)
    
    for name, check := range hc.checks {
        results[name] = check()
    }
    
    return results
}

func (hc *HealthChecker) IsHealthy() bool {
    results := hc.CheckHealth()
    for _, err := range results {
        if err != nil {
            return false
        }
    }
    return true
}

// æ•°æ®åº“å¥åº·æ£€æŸ¥
func (hc *HealthChecker) AddDatabaseCheck(db interface{}) {
    hc.AddCheck("database", func() error {
        // å®ç°æ•°æ®åº“è¿æ¥æ£€æŸ¥
        // è¿™é‡Œç®€åŒ–å¤„ç†
        return nil
    })
}

// Rediså¥åº·æ£€æŸ¥
func (hc *HealthChecker) AddRedisCheck(redis interface{}) {
    hc.AddCheck("redis", func() error {
        // å®ç°Redisè¿æ¥æ£€æŸ¥
        return nil
    })
}

// HTTPå¥åº·æ£€æŸ¥ç«¯ç‚¹
func (hc *HealthChecker) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    if hc.IsHealthy() {
        w.WriteHeader(http.StatusOK)
        w.Write([]byte("OK"))
    } else {
        w.WriteHeader(http.StatusServiceUnavailable)
        w.Write([]byte("Service Unavailable"))
    }
}

// ä½¿ç”¨ç¤ºä¾‹
func main() {
    checker := NewHealthChecker()
    
    // æ·»åŠ å¥åº·æ£€æŸ¥
    checker.AddCheck("memory", func() error {
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
        return nil
    })
    
    checker.AddCheck("disk", func() error {
        // æ£€æŸ¥ç£ç›˜ç©ºé—´
        return nil
    })
    
    // å¯åŠ¨å¥åº·æ£€æŸ¥æœåŠ¡
    http.HandleFunc("/health", checker.ServeHTTP)
    
    go func() {
        log.Println("å¥åº·æ£€æŸ¥æœåŠ¡å¯åŠ¨åœ¨ :8081")
        log.Fatal(http.ListenAndServe(":8081", nil))
    }()
    
    // å®šæœŸå¥åº·æ£€æŸ¥
    ticker := time.NewTicker(30 * time.Second)
    defer ticker.Stop()
    
    for range ticker.C {
        if !checker.IsHealthy() {
            log.Println("å¥åº·æ£€æŸ¥å¤±è´¥")
        }
    }
}
```

## 13.2.3 ğŸ¯ æœ€ä½³å®è·µ

1. **æœåŠ¡æ³¨å†Œæ—¶æœº**: æœåŠ¡å¯åŠ¨å®Œæˆåå†æ³¨å†Œï¼Œé¿å…æ³¨å†Œäº†ä½†æœåŠ¡æœªå°±ç»ª
2. **å¥åº·æ£€æŸ¥**: å®ç°æœ‰æ„ä¹‰çš„å¥åº·æ£€æŸ¥ï¼Œé¿å…è¯¯åˆ¤
3. **ä¼˜é›…ä¸‹çº¿**: æœåŠ¡åœæ­¢å‰å…ˆæ³¨é”€æ³¨å†Œï¼Œé¿å…æµé‡æ‰“åˆ°å·²åœæ­¢çš„æœåŠ¡
4. **è´Ÿè½½å‡è¡¡**: ç»“åˆè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œåˆç†åˆ†å‘è¯·æ±‚
5. **ç›‘æ§å‘Šè­¦**: ç›‘æ§æ³¨å†Œä¸­å¿ƒçŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

## 13.2.4 ğŸ” å¸¸è§é—®é¢˜

1. **è„‘è£‚é—®é¢˜**: ç½‘ç»œåˆ†åŒºæ—¶å¯èƒ½å‡ºç°å¤šä¸ªä¸»èŠ‚ç‚¹
2. **æœåŠ¡é›ªå´©**: å¤§é‡æœåŠ¡åŒæ—¶ä¸‹çº¿å¯¼è‡´è¿é”ååº”
3. **é…ç½®ç®¡ç†**: æœåŠ¡é…ç½®å˜æ›´æ—¶çš„é€šçŸ¥æœºåˆ¶
4. **ç‰ˆæœ¬å…¼å®¹**: æœåŠ¡ç‰ˆæœ¬å‡çº§æ—¶çš„å…¼å®¹æ€§å¤„ç†

## 13.2.5 ğŸ“š æ‰©å±•é˜…è¯»

- [Consulå®˜æ–¹æ–‡æ¡£](https://www.consul.io/docs)
- [etcdå®˜æ–¹æ–‡æ¡£](https://etcd.io/docs/)
- [go-microæ¡†æ¶](https://github.com/asim/go-micro)
- [kratosæ¡†æ¶](https://github.com/go-kratos/kratos)

## 13.2.6 âœ… è½åœ°æ£€æŸ¥æ¸…å•

- æ³¨å†Œæ–¹å¼ï¼šä¸»åŠ¨æ³¨å†Œ/è¢«åŠ¨æ³¨å†Œï¼ˆSidecaré‡‡é›†ï¼‰æ˜¯å¦æ˜ç¡®ï¼›å»æ³¨å†Œæµç¨‹æ˜¯å¦å¯æ§
- å¥åº·æ£€æŸ¥ï¼šliveness/readiness åŒºåˆ†ï¼›æ£€æŸ¥é¡¹è¦†ç›–æ•°æ®åº“/ç¼“å­˜/ä¸‹æ¸¸ä¾èµ–
- å‘ç°æ–¹å¼ï¼šç›´è¿æ³¨å†Œä¸­å¿ƒ vs. ç½‘å…³/Sidecar ä»£ç†ï¼Œæ˜¯å¦æœ‰ç¼“å­˜ä¸é€€è·¯
- è´Ÿè½½ç­–ç•¥ï¼šè½®è¯¢/åŠ æƒ/æœ€å°è¿æ¥ï¼›å®ä¾‹æƒé‡ã€ç†”æ–­ã€ä¼˜é›…ä¸‹çº¿æ˜¯å¦ç”Ÿæ•ˆ
- å¤šç¯å¢ƒï¼šå‘½åç©ºé—´/æ•°æ®ä¸­å¿ƒéš”ç¦»ï¼›è·¨AZ/æœºæˆ¿å®¹ç¾åˆ‡æµæ–¹æ¡ˆ
- å®‰å…¨ï¼šæ³¨å†Œä¸­å¿ƒé‰´æƒã€ACL/ACL Tokenã€mTLS ä¿¡ä»»é“¾
- å¯è§‚æµ‹ï¼šæ³¨å†Œ/å‘ç°è€—æ—¶ä¸å¤±è´¥ç‡ï¼›å®ä¾‹ä¸Šä¸‹çº¿å®¡è®¡ä¸å‘Šè­¦

## 13.2.7 ğŸ§ª æœ¬åœ°å¿«é€ŸéªŒè¯

1. å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼š
   - Consul: `consul agent -dev -client=0.0.0.0`
   - etcd: `etcd --listen-client-urls=http://0.0.0.0:2379 --advertise-client-urls=http://127.0.0.1:2379`
2. è¿è¡Œç¤ºä¾‹ï¼šåˆ†åˆ«è¿è¡Œâ€œConsulæœåŠ¡æ³¨å†Œâ€å’Œâ€œetcdæœåŠ¡å‘ç°â€çš„ `main` ç¨‹åºã€‚
3. éªŒè¯å¥åº·ï¼šè®¿é—® `http://localhost:8500/ui`ï¼ˆConsul Web UIï¼‰æˆ–ç”¨ `etcdctl get --prefix /services/` æŸ¥çœ‹å®ä¾‹ã€‚
4. æ–­è¨€è¡Œä¸ºï¼š
   - åœæ­¢æœåŠ¡è¿›ç¨‹ï¼Œç¡®è®¤å®ä¾‹åœ¨è¶…æ—¶åè‡ªåŠ¨æ‘˜é™¤ï¼ˆDeregister/TTL ç»­ç§Ÿå¤±æ•ˆï¼‰ã€‚
   - ä¿®æ”¹æƒé‡/å®ä¾‹åˆ—è¡¨ï¼Œè§‚å¯Ÿå‘ç°ç«¯çš„æµé‡åˆ‡æ¢ä¸åˆ—è¡¨å˜æ›´ã€‚
