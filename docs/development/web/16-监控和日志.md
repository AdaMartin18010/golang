# ç›‘æ§å’Œæ—¥å¿—

> ğŸ“š **ç®€ä»‹**
>
> æœ¬æ–‡å…¨é¢ä»‹ç»Go Webåº”ç”¨çš„ç›‘æ§å’Œæ—¥å¿—å®è·µï¼Œæ¶µç›–ç»“æ„åŒ–æ—¥å¿—ã€æŒ‡æ ‡æ”¶é›†ã€é“¾è·¯è¿½è¸ªã€å¥åº·æ£€æŸ¥ç­‰æ ¸å¿ƒå†…å®¹ã€‚å¸®åŠ©å¼€å‘è€…æ„å»ºå¯è§‚æµ‹çš„ç”Ÿäº§ç³»ç»Ÿã€‚
>
> é€šè¿‡æœ¬æ–‡ï¼Œæ‚¨å°†æŒæ¡å¦‚ä½•æ„å»ºå®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—ä½“ç³»ï¼Œæå‡ç³»ç»Ÿå¯ç»´æŠ¤æ€§ã€‚

---

## ğŸ“‹ ç›®å½•

- [1. ğŸ“š å¯è§‚æµ‹æ€§æ¦‚è¿°](#1-å¯è§‚æµ‹æ€§æ¦‚è¿°)
  - [1.1 å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±](#1-1-å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±)
  - [1.2 ç›‘æ§å’Œæ—¥å¿—çš„é‡è¦æ€§](#1-2-ç›‘æ§å’Œæ—¥å¿—çš„é‡è¦æ€§)
- [2. ğŸ“ ç»“æ„åŒ–æ—¥å¿—](#2-ç»“æ„åŒ–æ—¥å¿—)
  - [2.1 ä½¿ç”¨slog](#2-1-ä½¿ç”¨slog)
  - [2.2 æ—¥å¿—çº§åˆ«](#2-2-æ—¥å¿—çº§åˆ«)
  - [2.3 ä¸Šä¸‹æ–‡æ—¥å¿—](#2-3-ä¸Šä¸‹æ–‡æ—¥å¿—)
- [3. ğŸ“Š æŒ‡æ ‡ç›‘æ§](#3-æŒ‡æ ‡ç›‘æ§)
  - [3.1 Prometheusé›†æˆ](#3-1-prometheusé›†æˆ)
  - [3.2 å¸¸ç”¨æŒ‡æ ‡](#3-2-å¸¸ç”¨æŒ‡æ ‡)
  - [3.3 è‡ªå®šä¹‰æŒ‡æ ‡](#3-3-è‡ªå®šä¹‰æŒ‡æ ‡)
- [4. ğŸ” é“¾è·¯è¿½è¸ª](#4-é“¾è·¯è¿½è¸ª)
  - [4.1 OpenTelemetry](#4-1-opentelemetry)
  - [4.2 è¿½è¸ªä¸­é—´ä»¶](#4-2-è¿½è¸ªä¸­é—´ä»¶)
- [5. ğŸ¥ å¥åº·æ£€æŸ¥](#5-å¥åº·æ£€æŸ¥)
- [6. ğŸ”§ å®è·µç¤ºä¾‹](#6-å®è·µç¤ºä¾‹)
- [7. ğŸ¯ æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
  - [âœ… æ—¥å¿—ç®¡ç†](#æ—¥å¿—ç®¡ç†)
  - [âœ… æŒ‡æ ‡ç›‘æ§](#æŒ‡æ ‡ç›‘æ§)
  - [âœ… é“¾è·¯è¿½è¸ª](#é“¾è·¯è¿½è¸ª)
- [8. âš ï¸ å¸¸è§é—®é¢˜](#8-å¸¸è§é—®é¢˜)
  - [Q1: æ—¥å¿—å¤ªå¤šå½±å“æ€§èƒ½æ€ä¹ˆåŠï¼Ÿ](#q1-æ—¥å¿—å¤ªå¤šå½±å“æ€§èƒ½æ€ä¹ˆåŠ)
  - [Q2: PrometheusæŒ‡æ ‡çˆ†ç‚¸æ€ä¹ˆåŠï¼Ÿ](#q2-prometheusæŒ‡æ ‡çˆ†ç‚¸æ€ä¹ˆåŠ)
  - [Q3: å¦‚ä½•é€‰æ‹©æ—¥å¿—åº“ï¼Ÿ](#q3-å¦‚ä½•é€‰æ‹©æ—¥å¿—åº“)
- [9. ğŸ“š æ‰©å±•é˜…è¯»](#9-æ‰©å±•é˜…è¯»)
  - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
  - [ç›¸å…³å·¥å…·](#ç›¸å…³å·¥å…·)

## 1. ğŸ“š å¯è§‚æµ‹æ€§æ¦‚è¿°

### 1.1 å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±

```mermaid
    A[å¯è§‚æµ‹æ€§Observability] --> B[æ—¥å¿—Logs]
    A --> C[æŒ‡æ ‡Metrics]
    A --> D[è¿½è¸ªTraces]

    B --> E[é”™è¯¯æ’æŸ¥]
    C --> F[æ€§èƒ½ç›‘æ§]
    D --> G[é“¾è·¯åˆ†æ]
```

**ä¸‰å¤§æ”¯æŸ±**ï¼š

| æ”¯æŸ± | ç”¨é€” | å·¥å…·ç¤ºä¾‹ |
|------|------|---------|
| **æ—¥å¿—** | è®°å½•ç¦»æ•£äº‹ä»¶ | slog, zap, logrus |
| **æŒ‡æ ‡** | æµ‹é‡æ•°å€¼æ•°æ® | Prometheus, StatsD |
| **è¿½è¸ª** | è®°å½•è¯·æ±‚æµç¨‹ | Jaeger, Zipkin, OpenTelemetry |

### 1.2 ç›‘æ§å’Œæ—¥å¿—çš„é‡è¦æ€§

**é—®é¢˜å®šä½**ï¼š

- ğŸ› å¿«é€Ÿå‘ç°bug
- ğŸ” è¿½è¸ªé”™è¯¯æ ¹å› 
- ğŸ“Š åˆ†ææ€§èƒ½ç“¶é¢ˆ

**ç”Ÿäº§ä¿éšœ**ï¼š

- ğŸš¨ åŠæ—¶å‘Šè­¦
- ğŸ“ˆ å®¹é‡è§„åˆ’
- ğŸ”„ ä¼˜åŒ–è¿­ä»£

---

## 2. ğŸ“ ç»“æ„åŒ–æ—¥å¿—

### 2.1 ä½¿ç”¨slog

**Go 1.21+æ ‡å‡†åº“**ï¼š

```go
package main

import (
    "log/slog"
    "os"
)

func main() {
    // åˆ›å»ºJSONæ ¼å¼æ—¥å¿—å™¨
    logger := slog.New(slog.NewJSONHandler(os.Stdout, nil))

    // è®°å½•æ—¥å¿—
    logger.Info("server started",
        "port", 8080,
        "env", "production",
    )

    // è¾“å‡ºï¼š
    // {"time":"2023-10-20T10:00:00Z","level":"INFO","msg":"server started","port":8080,"env":"production"}
}
```

**é…ç½®æ—¥å¿—çº§åˆ«**ï¼š

```go
// è®¾ç½®æ—¥å¿—çº§åˆ«
opts := &slog.HandlerOptions{
    Level: slog.LevelDebug, // DEBUG, INFO, WARN, ERROR
}
logger := slog.New(slog.NewJSONHandler(os.Stdout, opts))
```

### 2.2 æ—¥å¿—çº§åˆ«

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|---------|------|
| **DEBUG** | è°ƒè¯•ä¿¡æ¯ | å˜é‡å€¼ã€å‡½æ•°è°ƒç”¨ |
| **INFO** | æ­£å¸¸æµç¨‹ | æœåŠ¡å¯åŠ¨ã€è¯·æ±‚å¤„ç† |
| **WARN** | è­¦å‘Šä¿¡æ¯ | é…ç½®é—®é¢˜ã€é™çº§å¤„ç† |
| **ERROR** | é”™è¯¯ä¿¡æ¯ | è¯·æ±‚å¤±è´¥ã€å¼‚å¸¸æ•è· |

**ç¤ºä¾‹**ï¼š

```go
logger.Debug("query executed", "sql", query, "duration", duration)
logger.Info("request processed", "method", "GET", "path", "/api/users")
logger.Warn("cache miss", "key", cacheKey)
logger.Error("database error", "error", err, "query", query)
```

### 2.3 ä¸Šä¸‹æ–‡æ—¥å¿—

**åœ¨Ginä¸­ä½¿ç”¨**ï¼š

```go
import (
    "context"
    "log/slog"
    "github.com/gin-gonic/gin"
)

// æ—¥å¿—ä¸­é—´ä»¶
func LoggerMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // åˆ›å»ºå¸¦è¯·æ±‚IDçš„logger
        logger := slog.With(
            "request_id", c.GetString("RequestID"),
            "method", c.Request.Method,
            "path", c.Request.URL.Path,
        )

        // å­˜å‚¨åˆ°context
        c.Set("logger", logger)

        c.Next()

        // è®°å½•è¯·æ±‚å®Œæˆ
        logger.Info("request completed",
            "status", c.Writer.Status(),
            "duration", time.Since(start),
        )
    }
}

// åœ¨handlerä¸­ä½¿ç”¨
func GetUser(c *gin.Context) {
    logger := c.MustGet("logger").(*slog.Logger)

    logger.Info("fetching user", "user_id", userID)
    // ...
}
```

---

## 3. ğŸ“Š æŒ‡æ ‡ç›‘æ§

### 3.1 Prometheusé›†æˆ

**å®‰è£…ä¾èµ–**ï¼š

```bash
go get github.com/prometheus/client_golang/prometheus
go get github.com/prometheus/client_golang/prometheus/promhttp
```

**åŸºç¡€è®¾ç½®**ï¼š

```go
package main

import (
    "github.com/gin-gonic/gin"
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

func main() {
    r := gin.Default()

    // æš´éœ²metricsç«¯ç‚¹
    r.GET("/metrics", gin.WrapH(promhttp.Handler()))

    r.Run(":8080")
}
```

### 3.2 å¸¸ç”¨æŒ‡æ ‡

**HTTPè¯·æ±‚æŒ‡æ ‡**ï¼š

```go
var (
    // è¯·æ±‚è®¡æ•°
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "path", "status"},
    )

    // è¯·æ±‚å»¶è¿Ÿ
    httpRequestDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "http_request_duration_seconds",
            Help: "HTTP request latency",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "path"},
    )

    // æ´»è·ƒè¯·æ±‚æ•°
    httpRequestsInFlight = prometheus.NewGauge(
        prometheus.GaugeOpts{
            Name: "http_requests_in_flight",
            Help: "Current number of HTTP requests being processed",
        },
    )
)

func init() {
    // æ³¨å†ŒæŒ‡æ ‡
    prometheus.MustRegister(httpRequestsTotal)
    prometheus.MustRegister(httpRequestDuration)
    prometheus.MustRegister(httpRequestsInFlight)
}
```

**ç›‘æ§ä¸­é—´ä»¶**ï¼š

```go
func PrometheusMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()

        // å¢åŠ æ´»è·ƒè¯·æ±‚æ•°
        httpRequestsInFlight.Inc()
        defer httpRequestsInFlight.Dec()

        c.Next()

        // è®°å½•æŒ‡æ ‡
        duration := time.Since(start).Seconds()
        status := c.Writer.Status()

        httpRequestsTotal.WithLabelValues(
            c.Request.Method,
            c.FullPath(),
            strconv.Itoa(status),
        ).Inc()

        httpRequestDuration.WithLabelValues(
            c.Request.Method,
            c.FullPath(),
        ).Observe(duration)
    }
}
```

### 3.3 è‡ªå®šä¹‰æŒ‡æ ‡

**ä¸šåŠ¡æŒ‡æ ‡**ï¼š

```go
var (
    // ç”¨æˆ·æ³¨å†Œæ•°
    userRegistrations = prometheus.NewCounter(
        prometheus.CounterOpts{
            Name: "user_registrations_total",
            Help: "Total number of user registrations",
        },
    )

    // è®¢å•é‡‘é¢
    orderAmount = prometheus.NewHistogram(
        prometheus.HistogramOpts{
            Name: "order_amount",
            Help: "Order amount in dollars",
            Buckets: []float64{10, 50, 100, 500, 1000, 5000},
        },
    )
)

func RegisterUser(c *gin.Context) {
    // å¤„ç†æ³¨å†Œé€»è¾‘
    // ...

    // è®°å½•æŒ‡æ ‡
    userRegistrations.Inc()
}

func CreateOrder(c *gin.Context) {
    amount := order.Amount

    // è®°å½•è®¢å•é‡‘é¢
    orderAmount.Observe(amount)
}
```

---

## 4. ğŸ” é“¾è·¯è¿½è¸ª

### 4.1 OpenTelemetry

**å®‰è£…**ï¼š

```bash
go get go.opentelemetry.io/otel
go get go.opentelemetry.io/otel/exporters/jaeger
go get go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin
```

**åˆå§‹åŒ–**ï¼š

```go
import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/jaeger"
    "go.opentelemetry.io/otel/sdk/trace"
)

func InitTracer() (*trace.TracerProvider, error) {
    // åˆ›å»ºJaegerå¯¼å‡ºå™¨
    exporter, err := jaeger.New(
        jaeger.WithCollectorEndpoint(jaeger.WithEndpoint("http://localhost:14268/api/traces")),
    )
    if err != nil {
        return nil, err
    }

    // åˆ›å»ºTracerProvider
    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
        trace.WithResource(resource.NewWithAttributes(
            semconv.SchemaURL,
            semconv.ServiceNameKey.String("my-service"),
        )),
    )

    otel.SetTracerProvider(tp)
    return tp, nil
}
```

### 4.2 è¿½è¸ªä¸­é—´ä»¶

```go
import "go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin"

func main() {
    r := gin.Default()

    // æ·»åŠ è¿½è¸ªä¸­é—´ä»¶
    r.Use(otelgin.Middleware("my-service"))

    r.GET("/users/:id", GetUser)
    r.Run()
}

func GetUser(c *gin.Context) {
    ctx := c.Request.Context()

    // åˆ›å»ºå­span
    tracer := otel.Tracer("user-service")
    ctx, span := tracer.Start(ctx, "GetUser")
    defer span.End()

    // æ·»åŠ å±æ€§
    span.SetAttributes(
        attribute.String("user_id", c.Param("id")),
    )

    // ä¸šåŠ¡é€»è¾‘
    user, err := fetchUser(ctx, c.Param("id"))
    if err != nil {
        span.RecordError(err)
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }

    c.JSON(200, user)
}
```

---

## 5. ğŸ¥ å¥åº·æ£€æŸ¥

**å¥åº·æ£€æŸ¥ç«¯ç‚¹**ï¼š

```go
type HealthStatus struct {
    Status     string            `json:"status"`
    Version    string            `json:"version"`
    Checks     map[string]string `json:"checks"`
    Timestamp  time.Time         `json:"timestamp"`
}

func HealthCheck(c *gin.Context) {
    status := HealthStatus{
        Status:    "healthy",
        Version:   "1.0.0",
        Checks:    make(map[string]string),
        Timestamp: time.Now(),
    }

    // æ£€æŸ¥æ•°æ®åº“
    if err := db.Ping(); err != nil {
        status.Status = "unhealthy"
        status.Checks["database"] = "failed: " + err.Error()
    } else {
        status.Checks["database"] = "ok"
    }

    // æ£€æŸ¥Redis
    if err := redis.Ping(c).Err(); err != nil {
        status.Status = "degraded"
        status.Checks["redis"] = "failed: " + err.Error()
    } else {
        status.Checks["redis"] = "ok"
    }

    code := 200
    if status.Status == "unhealthy" {
        code = 503
    }

    c.JSON(code, status)
}

// è·¯ç”±æ³¨å†Œ
r.GET("/health", HealthCheck)
r.GET("/readiness", ReadinessCheck)
r.GET("/liveness", LivenessCheck)
```

---

## 6. ğŸ”§ å®è·µç¤ºä¾‹

**å®Œæ•´ç¤ºä¾‹**ï¼š

```go
package main

import (
    "log/slog"
    "time"

    "github.com/gin-gonic/gin"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

func main() {
    // åˆå§‹åŒ–æ—¥å¿—
    logger := slog.New(slog.NewJSONHandler(os.Stdout, nil))
    slog.SetDefault(logger)

    // åˆå§‹åŒ–è¿½è¸ª
    tp, _ := InitTracer()
    defer tp.Shutdown(context.Background())

    // åˆ›å»ºè·¯ç”±
    r := gin.New()

    // ä¸­é—´ä»¶
    r.Use(RequestIDMiddleware())
    r.Use(LoggerMiddleware())
    r.Use(PrometheusMiddleware())
    r.Use(otelgin.Middleware("my-service"))

    // ç›‘æ§ç«¯ç‚¹
    r.GET("/metrics", gin.WrapH(promhttp.Handler()))
    r.GET("/health", HealthCheck)

    // ä¸šåŠ¡ç«¯ç‚¹
    r.GET("/users/:id", GetUser)

    logger.Info("server starting", "port", 8080)
    r.Run(":8080")
}
```

---

## 7. ğŸ¯ æœ€ä½³å®è·µ

### âœ… æ—¥å¿—ç®¡ç†

1. **ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—**

   ```go
   // âœ… å¥½
   logger.Info("user login", "user_id", userID, "ip", ip)

   // âŒ å·®
   fmt.Printf("User %s logged in from %s\n", userID, ip)
   ```

2. **æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯**
   - è¯·æ±‚ID
   - ç”¨æˆ·ID
   - ä¼šè¯ID

3. **è®¾ç½®æ—¥å¿—è½®è½¬**

   ```go
   // ä½¿ç”¨lumberjack
   logger := &lumberjack.Logger{
       Filename:   "/var/log/app.log",
       MaxSize:    100, // MB
       MaxBackups: 3,
       MaxAge:     28, // days
       Compress:   true,
   }
   ```

### âœ… æŒ‡æ ‡ç›‘æ§

1. **é€‰æ‹©åˆé€‚çš„æŒ‡æ ‡ç±»å‹**
   - Counter: ç´¯è®¡å€¼ï¼ˆè¯·æ±‚æ•°ã€é”™è¯¯æ•°ï¼‰
   - Gauge: å½“å‰å€¼ï¼ˆå†…å­˜ä½¿ç”¨ã€è¿æ¥æ•°ï¼‰
   - Histogram: åˆ†å¸ƒç»Ÿè®¡ï¼ˆå»¶è¿Ÿã€å¤§å°ï¼‰
   - Summary: ç™¾åˆ†ä½æ•°

2. **åˆç†ä½¿ç”¨æ ‡ç­¾**

   ```go
   // âœ… å¥½ï¼ˆä½åŸºæ•°ï¼‰
   httpRequests.WithLabelValues("GET", "/api/users", "200")

   // âŒ å·®ï¼ˆé«˜åŸºæ•°ï¼‰
   httpRequests.WithLabelValues("GET", "/api/users/123456", "200")
   ```

3. **è®¾ç½®å‘Šè­¦è§„åˆ™**

   ```yaml
   # prometheus.yml
   groups:
     - name: api
       rules:
         - alert: HighErrorRate
           expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
   ```

### âœ… é“¾è·¯è¿½è¸ª

1. **è¿½è¸ªå…³é”®è·¯å¾„**
   - HTTPè¯·æ±‚
   - æ•°æ®åº“æŸ¥è¯¢
   - å¤–éƒ¨APIè°ƒç”¨
   - ç¼“å­˜æ“ä½œ

2. **é‡‡æ ·ç­–ç•¥**

   ```go
   // ç”Ÿäº§ç¯å¢ƒé‡‡æ ·10%
   trace.WithSampler(trace.TraceIDRatioBased(0.1))
   ```

3. **æ•æ„Ÿä¿¡æ¯è„±æ•**

   ```go
   // ä¸è¦è®°å½•å¯†ç ã€tokenç­‰
   span.SetAttributes(
       attribute.String("user_email", email),
       // attribute.String("password", password), // âŒ
   )
   ```

---

## 8. âš ï¸ å¸¸è§é—®é¢˜

### Q1: æ—¥å¿—å¤ªå¤šå½±å“æ€§èƒ½æ€ä¹ˆåŠï¼Ÿ

**A**:

- ä½¿ç”¨å¼‚æ­¥æ—¥å¿—
- è°ƒæ•´æ—¥å¿—çº§åˆ«
- ä½¿ç”¨é‡‡æ ·

```go
// é‡‡æ ·ï¼šæ¯10ä¸ªDEBUGæ—¥å¿—è®°å½•1ä¸ª
if rand.Intn(10) == 0 {
    logger.Debug("detail", "data", data)
}
```

### Q2: PrometheusæŒ‡æ ‡çˆ†ç‚¸æ€ä¹ˆåŠï¼Ÿ

**A**: æ§åˆ¶æ ‡ç­¾åŸºæ•°

```go
// âŒ ä¸è¦ä½¿ç”¨é«˜åŸºæ•°æ ‡ç­¾
.WithLabelValues(userID) // å¯èƒ½æœ‰ç™¾ä¸‡çº§ç”¨æˆ·

// âœ… ä½¿ç”¨ä½åŸºæ•°æ ‡ç­¾
.WithLabelValues(userType) // åªæœ‰å‡ ç§ç±»å‹
```

### Q3: å¦‚ä½•é€‰æ‹©æ—¥å¿—åº“ï¼Ÿ

**æ¨è**ï¼š

- Go 1.21+: slogï¼ˆæ ‡å‡†åº“ï¼‰
- é«˜æ€§èƒ½: zap
- åŠŸèƒ½ä¸°å¯Œ: logrus

---

## 9. ğŸ“š æ‰©å±•é˜…è¯»

### å®˜æ–¹æ–‡æ¡£

- [log/slog](https://pkg.go.dev/log/slog)
- [Prometheus Go client](https://github.com/prometheus/client_golang)
- [OpenTelemetry Go](https://opentelemetry.io/docs/instrumentation/go/)

### ç›¸å…³å·¥å…·

- [Grafana](https://grafana.com/) - å¯è§†åŒ–å¹³å°
- [Jaeger](https://www.jaegertracing.io/) - åˆ†å¸ƒå¼è¿½è¸ª
- [ELK Stack](https://www.elastic.co/elk-stack) - æ—¥å¿—å¹³å°

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Go Documentation Team
**æœ€åæ›´æ–°**: 2025-10-29
**æ–‡æ¡£çŠ¶æ€**: å®Œæˆ
**é€‚ç”¨ç‰ˆæœ¬**: Go 1.25.3+
