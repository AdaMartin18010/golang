# 多环境部署

**版本**: v1.0  
**更新日期**: 2025-10-29  
**适用于**: Go 1.23+ / Kubernetes 1.28+

---

---

## 📋 目录

- [9.1 📚 多环境架构](#9-1-多环境架构)
- [9.2 🎯 配置管理](#9-2-配置管理)
  - [Kustomize多环境](#kustomize多环境)
  - [Helm Values多环境](#helm-values多环境)
  - [ConfigMap与Secret分离](#configmap与secret分离)
- [9.3 🚀 部署策略](#9-3-部署策略)
  - [环境晋升Pipeline](#环境晋升pipeline)
  - [ArgoCD多环境](#argocd多环境)
- [9.4 🔐 环境隔离](#9-4-环境隔离)
  - [命名空间隔离](#命名空间隔离)
  - [NetworkPolicy隔离](#networkpolicy隔离)
- [9.5 📊 监控与观测](#9-5-监控与观测)
  - [环境标签](#环境标签)
  - [Grafana多环境Dashboard](#grafana多环境dashboard)
- [9.6 🔄 环境晋升](#9-6-环境晋升)
  - [自动晋升](#自动晋升)
  - [金丝雀晋升](#金丝雀晋升)
- [9.7 💰 成本优化](#9-7-成本优化)
  - [环境资源差异化](#环境资源差异化)
  - [自动缩容策略](#自动缩容策略)
- [9.8 🎯 最佳实践](#9-8-最佳实践)
- [9.9 ⚠️ 常见问题](#9-9-常见问题)
  - [Q1: 如何快速创建测试环境？](#q1-如何快速创建测试环境)
  - [Q2: 生产环境配置如何保密？](#q2-生产环境配置如何保密)
  - [Q3: 如何处理数据库Schema变更？](#q3-如何处理数据库schema变更)
- [9.10 📚 扩展阅读](#9-10-扩展阅读)
  - [官方文档](#官方文档)
  - [相关文档](#相关文档)

## 9.1 📚 多环境架构

**典型环境**:

- **开发环境(Dev)**: 开发人员日常开发测试
- **测试环境(Test/QA)**: QA团队功能测试
- **预发布环境(Staging)**: 生产前最后验证
- **生产环境(Production)**: 真实用户访问

```text
┌─────────────────────────────────────────┐
│           CI/CD Pipeline                │
└──────┬──────────┬──────────┬───────────┘
       ↓          ↓          ↓          ↓
   ┌──────┐  ┌──────┐  ┌─────────┐  ┌──────┐
   │ Dev  │→ │ Test │→ │ Staging │→ │ Prod │
   └──────┘  └──────┘  └─────────┘  └──────┘
     自动      自动       手动审批     手动审批
```

## 9.2 🎯 配置管理

### Kustomize多环境

**目录结构**:

```text
kustomize/
├── base/
│   ├── deployment.yaml
│   ├── service.yaml
│   ├── configmap.yaml
│   └── kustomization.yaml
└── overlays/
    ├── dev/
    │   ├── kustomization.yaml
    │   ├── replica-patch.yaml
    │   └── resource-patch.yaml
    ├── test/
    │   ├── kustomization.yaml
    │   └── patches.yaml
    ├── staging/
    │   ├── kustomization.yaml
    │   └── patches.yaml
    └── production/
        ├── kustomization.yaml
        ├── replica-patch.yaml
        └── hpa.yaml
```

**base/kustomization.yaml**:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- deployment.yaml
- service.yaml
- configmap.yaml

commonLabels:
  app: user-service
  managed-by: kustomize
```

**overlays/production/kustomization.yaml**:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
- ../../base

namespace: production

replicas:
- name: user-service
  count: 5

images:
- name: user-service
  newTag: v1.2.3

patchesStrategicMerge:
- replica-patch.yaml

resources:
- hpa.yaml

configMapGenerator:
- name: app-config
  behavior: merge
  literals:
  - LOG_LEVEL=info
  - ENV=production
```

### Helm Values多环境

**values-dev.yaml**:

```yaml
replicaCount: 1
image:
  tag: latest
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 256Mi
ingress:
  enabled: true
  host: dev.example.com
autoscaling:
  enabled: false
```

**values-production.yaml**:

```yaml
replicaCount: 5
image:
  tag: v1.2.3
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi
ingress:
  enabled: true
  host: api.example.com
  tls:
    enabled: true
autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
```

### ConfigMap与Secret分离

```yaml
# dev-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: dev
type: Opaque
stringData:
  DB_PASSWORD: "dev_password"
  API_KEY: "dev_api_key"

---
# production-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: production
type: Opaque
stringData:
  DB_PASSWORD: "${PROD_DB_PASSWORD}"  # 从外部注入
  API_KEY: "${PROD_API_KEY}"
```

## 9.3 🚀 部署策略

### 环境晋升Pipeline

```yaml
# GitHub Actions
name: Multi-Environment Deployment

on:
  push:
    branches: [main]

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Dev
      run: |
        kubectl apply -k kustomize/overlays/dev
  
  deploy-test:
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: test
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Test
      run: |
        kubectl apply -k kustomize/overlays/test
  
  deploy-staging:
    runs-on: ubuntu-latest
    needs: deploy-test
    environment: staging
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Staging
      run: |
        kubectl apply -k kustomize/overlays/staging
  
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://api.example.com
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Production
      run: |
        kubectl apply -k kustomize/overlays/production
```

### ArgoCD多环境

```yaml
# ApplicationSet
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: user-service
spec:
  generators:
  - list:
      elements:
      - env: dev
        namespace: dev
        cluster: dev-cluster
        revision: develop
      - env: test
        namespace: test
        cluster: test-cluster
        revision: develop
      - env: staging
        namespace: staging
        cluster: staging-cluster
        revision: main
      - env: production
        namespace: production
        cluster: production-cluster
        revision: release
  template:
    metadata:
      name: 'user-service-{{env}}'
    spec:
      project: default
      source:
        repoURL: https://github.com/myorg/k8s-manifests.git
        targetRevision: '{{revision}}'
        path: 'kustomize/overlays/{{env}}'
      destination:
        server: '{{cluster}}'
        namespace: '{{namespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
```

## 9.4 🔐 环境隔离

### 命名空间隔离

```yaml
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    environment: production
    team: backend

---
# ResourceQuota
apiVersion: v1
kind: ResourceQuota
metadata:
  name: production-quota
  namespace: production
spec:
  hard:
    requests.cpu: "100"
    requests.memory: 200Gi
    limits.cpu: "200"
    limits.memory: 400Gi
    pods: "100"

---
# LimitRange
apiVersion: v1
kind: LimitRange
metadata:
  name: production-limits
  namespace: production
spec:
  limits:
  - max:
      cpu: "4"
      memory: 8Gi
    min:
      cpu: 100m
      memory: 128Mi
    default:
      cpu: 500m
      memory: 512Mi
    defaultRequest:
      cpu: 200m
      memory: 256Mi
    type: Container
```

### NetworkPolicy隔离

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: env-isolation
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          environment: production
  - to:  # 允许访问DNS
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
```

## 9.5 📊 监控与观测

### 环境标签

```go
import "github.com/prometheus/client_golang/prometheus"

var (
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total HTTP requests",
        },
        []string{"environment", "method", "endpoint", "status"},
    )
)

func init() {
    prometheus.MustRegister(httpRequestsTotal)
}

func MetricsMiddleware(env string) gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Next()
        httpRequestsTotal.WithLabelValues(
            env,
            c.Request.Method,
            c.FullPath(),
            strconv.Itoa(c.Writer.Status()),
        ).Inc()
    }
}
```

### Grafana多环境Dashboard

```json
{
  "dashboard": {
    "title": "Multi-Environment Overview",
    "panels": [
      {
        "title": "Requests by Environment",
        "targets": [
          {
            "expr": "sum(rate(http_requests_total[5m])) by (environment)"
          }
        ]
      }
    ],
    "templating": {
      "list": [
        {
          "name": "environment",
          "type": "query",
          "query": "label_values(http_requests_total, environment)"
        }
      ]
    }
  }
}
```

## 9.6 🔄 环境晋升

### 自动晋升

```yaml
# 自动晋升到test
deploy:test:
  stage: deploy
  environment: test
  script:
    - kubectl apply -k overlays/test
  only:
    - develop

# 手动晋升到production
deploy:production:
  stage: deploy
  environment: production
  script:
    - kubectl apply -k overlays/production
  when: manual
  only:
    - main
```

### 金丝雀晋升

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: user-service
spec:
  strategy:
    canary:
      steps:
      - setWeight: 10
      - pause: {duration: 5m}
      - setWeight: 25
      - pause: {duration: 10m}
      - setWeight: 50
      - pause: {duration: 15m}
      - setWeight: 75
      - pause: {duration: 20m}
```

## 9.7 💰 成本优化

### 环境资源差异化

| 环境 | 节点类型 | 副本数 | 资源配额 | 成本占比 |
|------|----------|--------|----------|---------|
| Dev | t3.small | 1 | 最小 | 5% |
| Test | t3.medium | 2 | 小 | 10% |
| Staging | t3.large | 3 | 中等 | 20% |
| Production | c5.2xlarge | 5-20 | 大 | 65% |

### 自动缩容策略

```yaml
# Dev环境夜间自动缩容
apiVersion: batch/v1
kind: CronJob
metadata:
  name: scale-down-dev
spec:
  schedule: "0 22 * * *"  # 每晚10点
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: kubectl
            image: bitnami/kubectl:latest
            command:
            - kubectl
            - scale
            - deployment/user-service
            - --replicas=0
            - -n
            - dev
          restartPolicy: OnFailure
```

## 9.8 🎯 最佳实践

1. **配置外部化**: 使用ConfigMap/Secret管理配置
2. **环境一致性**: 保持环境配置尽量一致
3. **渐进式部署**: Dev→Test→Staging→Production
4. **自动化测试**: 每个环境都有对应测试
5. **环境隔离**: 使用Namespace和NetworkPolicy
6. **监控差异化**: 根据环境重要性配置监控
7. **成本优化**: 非生产环境使用较小资源
8. **文档化**: 维护环境配置文档
9. **定期清理**: 清理不再使用的测试环境
10. **演练回滚**: 定期进行回滚演练

## 9.9 ⚠️ 常见问题

### Q1: 如何快速创建测试环境？

**A**: 使用Namespace Template:

```bash
kubectl create namespace test-feature-123
kubectl apply -k overlays/dev -n test-feature-123
```

### Q2: 生产环境配置如何保密？

**A**:

- 使用Sealed Secrets
- 外部Secret管理（Vault）
- GitLab CI/CD变量
- 不要提交明文到Git

### Q3: 如何处理数据库Schema变更？

**A**:

- 使用数据库迁移工具（Flyway、Liquibase）
- 先在低环境验证
- 制定回滚计划
- 考虑向后兼容

## 9.10 📚 扩展阅读

### 官方文档

- [Kustomize文档](https://kustomize.io/)
- [Helm Values文档](https://helm.sh/docs/chart_template_guide/values_files/)
- [ArgoCD ApplicationSets](https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/)

### 相关文档

- [06-GitOps部署.md](./06-GitOps部署.md)
- [07-GitHub-Actions.md](./07-GitHub-Actions.md)
- [08-GitLab-CI.md](./08-GitLab-CI.md)

---

**文档维护者**: Go Documentation Team  
**最后更新**: 2025-10-29  
**文档状态**: 完成  
**适用版本**: Kubernetes 1.27+, Kustomize 5+, Helm 3+
