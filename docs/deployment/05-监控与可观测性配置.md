# ç›‘æ§ä¸å¯è§‚æµ‹æ€§é…ç½®

> **ç‰ˆæœ¬**: v1.0
> **æ—¥æœŸ**: 2025-01-XX

---

## ğŸ“‹ ç›®å½•

- [1. ç›‘æ§æ¶æ„](#1-ç›‘æ§æ¶æ„)
- [2. Prometheus é…ç½®](#2-prometheus-é…ç½®)
- [3. Grafana é…ç½®](#3-grafana-é…ç½®)
- [4. OpenTelemetry é…ç½®](#4-opentelemetry-é…ç½®)
- [5. å‘Šè­¦é…ç½®](#5-å‘Šè­¦é…ç½®)
- [6. æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)

---

## 1. ç›‘æ§æ¶æ„

### 1.1 ç›‘æ§æ¶æ„å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç›‘æ§ä¸å¯è§‚æµ‹æ€§æ¶æ„                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åº”ç”¨æœåŠ¡
    â”‚
    â”œâ”€â†’ æŒ‡æ ‡ (Metrics) â”€â”€â†’ Prometheus â”€â”€â†’ Grafana
    â”‚
    â”œâ”€â†’ è¿½è¸ª (Traces) â”€â”€â†’ OpenTelemetry Collector â”€â”€â†’ Jaeger/Tempo
    â”‚
    â””â”€â†’ æ—¥å¿— (Logs) â”€â”€â†’ OpenTelemetry Collector â”€â”€â†’ Loki/ELK
```

### 1.2 ç›‘æ§å±‚æ¬¡

| å±‚æ¬¡ | ç»„ä»¶ | è¯´æ˜ |
|------|------|------|
| **æŒ‡æ ‡å±‚** | Prometheus | æŒ‡æ ‡æ”¶é›†å’Œå­˜å‚¨ |
| **å¯è§†åŒ–å±‚** | Grafana | æŒ‡æ ‡å¯è§†åŒ–å’Œä»ªè¡¨æ¿ |
| **è¿½è¸ªå±‚** | Jaeger/Tempo | åˆ†å¸ƒå¼è¿½è¸ª |
| **æ—¥å¿—å±‚** | Loki/ELK | æ—¥å¿—èšåˆå’Œåˆ†æ |
| **å‘Šè­¦å±‚** | Alertmanager | å‘Šè­¦ç®¡ç† |

---

## 2. Prometheus é…ç½®

### 2.1 Prometheus é…ç½®æ–‡ä»¶

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'production'
    environment: 'prod'

scrape_configs:
  # åº”ç”¨æœåŠ¡æŒ‡æ ‡
  - job_name: 'app'
    static_configs:
      - targets: ['app:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s

  # Kubernetes Pod æŒ‡æ ‡
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__

  # Kubernetes èŠ‚ç‚¹æŒ‡æ ‡
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)

  # PostgreSQL æŒ‡æ ‡
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  # Redis æŒ‡æ ‡
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

rule_files:
  - '/etc/prometheus/rules/*.yml'
```

### 2.2 å‘Šè­¦è§„åˆ™

```yaml
# rules/app.yml
groups:
  - name: app_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "é«˜é”™è¯¯ç‡"
          description: "é”™è¯¯ç‡è¶…è¿‡ 5%"

      - alert: HighLatency
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "é«˜å»¶è¿Ÿ"
          description: "P99 å»¶è¿Ÿè¶…è¿‡ 1 ç§’"

      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Pod å´©æºƒå¾ªç¯"
          description: "Pod {{ $labels.pod }} åœ¨å´©æºƒå¾ªç¯ä¸­"
```

---

## 3. Grafana é…ç½®

### 3.1 Grafana æ•°æ®æºé…ç½®

```yaml
# grafana-datasources.yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true

  - name: Jaeger
    type: jaeger
    access: proxy
    url: http://jaeger:16686
    editable: true

  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    editable: true
```

### 3.2 Grafana ä»ªè¡¨æ¿é…ç½®

```json
{
  "dashboard": {
    "title": "åº”ç”¨ç›‘æ§ä»ªè¡¨æ¿",
    "panels": [
      {
        "title": "è¯·æ±‚é€Ÿç‡",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{status}}"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m])",
            "legendFormat": "é”™è¯¯ç‡"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´",
        "targets": [
          {
            "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P99"
          }
        ]
      }
    ]
  }
}
```

---

## 4. OpenTelemetry é…ç½®

### 4.1 OpenTelemetry Collector é…ç½®

```yaml
# otel-collector-config.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024
  memory_limiter:
    limit_mib: 512
  resource:
    attributes:
      - key: service.name
        value: app
        action: upsert

exporters:
  # Prometheus æŒ‡æ ‡å¯¼å‡º
  prometheus:
    endpoint: "0.0.0.0:8888"
    namespace: app

  # Jaeger è¿½è¸ªå¯¼å‡º
  jaeger:
    endpoint: jaeger:14250
    tls:
      insecure: true

  # OTLP å¯¼å‡ºï¼ˆç”¨äºå…¶ä»–åç«¯ï¼‰
  otlp:
    endpoint: otlp-endpoint:4317
    tls:
      insecure: true

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch, resource]
      exporters: [jaeger, otlp]
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, batch, resource]
      exporters: [prometheus, otlp]
    logs:
      receivers: [otlp]
      processors: [memory_limiter, batch, resource]
      exporters: [otlp]
```

### 4.2 åº”ç”¨é›†æˆé…ç½®

```go
// åœ¨åº”ç”¨ä¸­ä½¿ç”¨ OpenTelemetry
import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/trace"
)

func initTracing() {
    exporter, err := otlptracegrpc.New(
        context.Background(),
        otlptracegrpc.WithEndpoint("otel-collector:4317"),
        otlptracegrpc.WithInsecure(),
    )
    if err != nil {
        log.Fatal(err)
    }

    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
        trace.WithResource(resource.NewWithAttributes(
            semconv.SchemaURL,
            semconv.ServiceNameKey.String("app"),
        )),
    )

    otel.SetTracerProvider(tp)
}
```

---

## 5. å‘Šè­¦é…ç½®

### 5.1 Alertmanager é…ç½®

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m
  slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
    - match:
        severity: warning
      receiver: 'warning-alerts'

receivers:
  - name: 'default'
    slack_configs:
      - channel: '#alerts'
        title: '{{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  - name: 'critical-alerts'
    slack_configs:
      - channel: '#critical-alerts'
        title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    email_configs:
      - to: 'ops@example.com'
        subject: 'CRITICAL Alert: {{ .GroupLabels.alertname }}'

  - name: 'warning-alerts'
    slack_configs:
      - channel: '#alerts'
        title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 æŒ‡æ ‡æ”¶é›†æœ€ä½³å®è·µ

1. **ä½¿ç”¨æ ‡å‡†æŒ‡æ ‡**ï¼šéµå¾ª Prometheus æŒ‡æ ‡å‘½åè§„èŒƒ
2. **åˆç†é‡‡æ ·**ï¼šé¿å…è¿‡åº¦é‡‡æ ·å¯¼è‡´æ€§èƒ½é—®é¢˜
3. **æ ‡ç­¾è®¾è®¡**ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„æ ‡ç­¾ï¼Œé¿å…é«˜åŸºæ•°
4. **æŒ‡æ ‡èšåˆ**ï¼šåœ¨åº”ç”¨å±‚è¿›è¡Œé€‚å½“çš„èšåˆ

### 6.2 è¿½è¸ªæœ€ä½³å®è·µ

1. **é‡‡æ ·ç­–ç•¥**ï¼šæ ¹æ®è´Ÿè½½è°ƒæ•´é‡‡æ ·ç‡
2. **ä¸Šä¸‹æ–‡ä¼ æ’­**ï¼šç¡®ä¿è¿½è¸ªä¸Šä¸‹æ–‡æ­£ç¡®ä¼ æ’­
3. **Span è®¾è®¡**ï¼šåˆç†è®¾è®¡ Span ç²’åº¦
4. **é”™è¯¯è®°å½•**ï¼šè®°å½•æ‰€æœ‰é”™è¯¯å’Œå¼‚å¸¸

### 6.3 æ—¥å¿—æœ€ä½³å®è·µ

1. **ç»“æ„åŒ–æ—¥å¿—**ï¼šä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆJSONï¼‰
2. **æ—¥å¿—çº§åˆ«**ï¼šåˆç†ä½¿ç”¨æ—¥å¿—çº§åˆ«
3. **æ•æ„Ÿä¿¡æ¯**ï¼šé¿å…è®°å½•æ•æ„Ÿä¿¡æ¯
4. **æ—¥å¿—èšåˆ**ï¼šé›†ä¸­æ”¶é›†å’Œåˆ†ææ—¥å¿—

---

**æœ€åæ›´æ–°**: 2025-01-XX
