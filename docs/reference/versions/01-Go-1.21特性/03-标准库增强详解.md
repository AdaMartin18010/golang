# Go 1.21 æ ‡å‡†åº“å¢å¼ºè¯¦è§£

> **éš¾åº¦**: â­â­â­
> **æ ‡ç­¾**: #log/slog #slices #maps #cmp

**ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2025-10-29
**é€‚ç”¨äº**: Go 1.25.3

---

## ğŸ“‹ ç›®å½•

- [Go 1.21 æ ‡å‡†åº“å¢å¼ºè¯¦è§£](#go-121-æ ‡å‡†åº“å¢å¼ºè¯¦è§£)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ log/slog - ç»“æ„åŒ–æ—¥å¿—](#-logslog---ç»“æ„åŒ–æ—¥å¿—)
    - [ä¸ºä»€ä¹ˆéœ€è¦ slogï¼Ÿ](#ä¸ºä»€ä¹ˆéœ€è¦-slog)
    - [åŸºæœ¬ç”¨æ³•](#åŸºæœ¬ç”¨æ³•)
      - [1. é»˜è®¤ Logger](#1-é»˜è®¤-logger)
      - [2. JSON Handler](#2-json-handler)
      - [3. è‡ªå®šä¹‰ Handler é…ç½®](#3-è‡ªå®šä¹‰-handler-é…ç½®)
    - [é«˜çº§ç‰¹æ€§](#é«˜çº§ç‰¹æ€§)
      - [1. With() - æ·»åŠ ä¸Šä¸‹æ–‡å­—æ®µ](#1-with---æ·»åŠ ä¸Šä¸‹æ–‡å­—æ®µ)
      - [2. WithGroup() - å­—æ®µåˆ†ç»„](#2-withgroup---å­—æ®µåˆ†ç»„)
      - [3. LogValuer - è‡ªå®šä¹‰ç±»å‹æ—¥å¿—](#3-logvaluer---è‡ªå®šä¹‰ç±»å‹æ—¥å¿—)
    - [å®æˆ˜æ¡ˆä¾‹ï¼šWeb åº”ç”¨æ—¥å¿—](#å®æˆ˜æ¡ˆä¾‹web-åº”ç”¨æ—¥å¿—)
  - [ğŸ¯ slices åŒ… - æ³›å‹åˆ‡ç‰‡æ“ä½œ](#-slices-åŒ…---æ³›å‹åˆ‡ç‰‡æ“ä½œ)
    - [å¸¸ç”¨å‡½æ•°](#å¸¸ç”¨å‡½æ•°)
      - [1. æ’åºç›¸å…³](#1-æ’åºç›¸å…³)
      - [2. æŸ¥æ‰¾ç›¸å…³](#2-æŸ¥æ‰¾ç›¸å…³)
      - [3. æ“ä½œç›¸å…³](#3-æ“ä½œç›¸å…³)
      - [4. é«˜çº§æ“ä½œ](#4-é«˜çº§æ“ä½œ)
  - [ğŸ¯ maps åŒ… - æ³›å‹æ˜ å°„æ“ä½œ](#-maps-åŒ…---æ³›å‹æ˜ å°„æ“ä½œ)
    - [å¸¸ç”¨å‡½æ•°1](#å¸¸ç”¨å‡½æ•°1)
  - [ğŸ¯ cmp åŒ… - æ¯”è¾ƒå·¥å…·](#-cmp-åŒ…---æ¯”è¾ƒå·¥å…·)
    - [åŸºæœ¬ç”¨æ³•1](#åŸºæœ¬ç”¨æ³•1)
  - [ğŸ’¡ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
    - [1. slog ä½¿ç”¨å»ºè®®](#1-slog-ä½¿ç”¨å»ºè®®)
    - [2. slices æ€§èƒ½ä¼˜åŒ–](#2-slices-æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“š æ‰©å±•é˜…è¯»](#-æ‰©å±•é˜…è¯»)

## ğŸ“‹ æ¦‚è¿°

Go 1.21 åœ¨æ ‡å‡†åº“æ–¹é¢è¿›è¡Œäº†é‡å¤§æ›´æ–°ï¼Œå¼•å…¥äº†ä¸‰ä¸ªæ–°åŒ…å’Œä¸€ä¸ªé©å‘½æ€§çš„æ—¥å¿—åŒ…ï¼š

- **`log/slog`** - ç»“æ„åŒ–æ—¥å¿—æ ‡å‡†åº“
- **`slices`** - æ³›å‹åˆ‡ç‰‡æ“ä½œ
- **`maps`** - æ³›å‹æ˜ å°„æ“ä½œ
- **`cmp`** - æ¯”è¾ƒå·¥å…·åŒ…

---

## ğŸ¯ log/slog - ç»“æ„åŒ–æ—¥å¿—

### ä¸ºä»€ä¹ˆéœ€è¦ slogï¼Ÿ

ä¼ ç»Ÿ `log` åŒ…çš„å±€é™ï¼š

```go
// ä¼ ç»Ÿ logï¼šéš¾ä»¥è§£æå’ŒæŸ¥è¯¢
log.Printf("User %s logged in from %s with status %d", username, ip, status)
// è¾“å‡º: 2025/10/24 10:00:00 User alice logged in from 192.168.1.1 with status 200
```

`slog` çš„ä¼˜åŠ¿ï¼š

```go
// slogï¼šç»“æ„åŒ–ï¼Œæ˜“äºè§£æ
slog.Info("user logged in",
    "username", username,
    "ip", ip,
    "status", status,
)
// è¾“å‡ºï¼ˆJSONï¼‰: {"time":"2025-10-24T10:00:00Z","level":"INFO","msg":"user logged in","username":"alice","ip":"192.168.1.1","status":200}
```

### åŸºæœ¬ç”¨æ³•

#### 1. é»˜è®¤ Logger

```go
package main

import (
    "log/slog"
)

func main() {
    // ä½¿ç”¨é»˜è®¤ logger
    slog.Info("application started", "version", "1.0.0", "port", 8080)
    slog.Warn("high memory usage", "usage", "85%")
    slog.Error("database connection failed", "error", "connection refused")

    // Debug çº§åˆ«ï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼‰
    slog.Debug("processing request", "user_id", 123)
}
```

è¾“å‡ºï¼ˆé»˜è®¤æ–‡æœ¬æ ¼å¼ï¼‰ï¼š

```text
2025/10/24 10:00:00 INFO application started version=1.0.0 port=8080
2025/10/24 10:00:01 WARN high memory usage usage=85%
2025/10/24 10:00:02 ERROR database connection failed error="connection refused"
```

#### 2. JSON Handler

```go
package main

import (
    "log/slog"
    "os"
)

func main() {
    // åˆ›å»º JSON handler
    logger := slog.New(slog.NewJSONHandler(os.Stdout, nil))

    logger.Info("user action",
        slog.String("user", "alice"),
        slog.Int("user_id", 123),
        slog.Float64("amount", 99.99),
    )
}
```

è¾“å‡ºï¼š

```json
{"time":"2025-10-24T10:00:00Z","level":"INFO","msg":"user action","user":"alice","user_id":123,"amount":99.99}
```

#### 3. è‡ªå®šä¹‰ Handler é…ç½®

```go
package main

import (
    "log/slog"
    "os"
)

func main() {
    opts := &slog.HandlerOptions{
        Level: slog.LevelDebug,  // è®¾ç½®æœ€ä½æ—¥å¿—çº§åˆ«
        AddSource: true,          // æ·»åŠ æºæ–‡ä»¶ä¿¡æ¯
        ReplaceAttr: func(groups []string, a slog.Attr) slog.Attr {
            // è‡ªå®šä¹‰å±æ€§
            if a.Key == slog.TimeKey {
                // è‡ªå®šä¹‰æ—¶é—´æ ¼å¼
                return slog.String("timestamp", a.Value.Time().Format("2006-01-02 15:04:05"))
            }
            return a
        },
    }

    logger := slog.New(slog.NewJSONHandler(os.Stdout, opts))
    logger.Debug("debug message", "detail", "some info")
}
```

### é«˜çº§ç‰¹æ€§

#### 1. With() - æ·»åŠ ä¸Šä¸‹æ–‡å­—æ®µ

```go
package main

import (
    "log/slog"
)

func main() {
    // åŸºç¡€ logger
    baseLogger := slog.Default()

    // ä¸ºç‰¹å®šæ¨¡å—æ·»åŠ ä¸Šä¸‹æ–‡
    dbLogger := baseLogger.With("module", "database", "connection", "primary")
    dbLogger.Info("query executed", "duration", "150ms")
    // è¾“å‡º: ... module=database connection=primary duration=150ms

    apiLogger := baseLogger.With("module", "api", "version", "v1")
    apiLogger.Info("request processed", "status", 200)
    // è¾“å‡º: ... module=api version=v1 status=200
}
```

#### 2. WithGroup() - å­—æ®µåˆ†ç»„

```go
package main

import (
    "log/slog"
    "os"
)

func main() {
    logger := slog.New(slog.NewJSONHandler(os.Stdout, nil))

    logger.Info("request received",
        slog.Group("http",
            slog.String("method", "GET"),
            slog.String("path", "/api/users"),
            slog.Int("status", 200),
        ),
        slog.Group("client",
            slog.String("ip", "192.168.1.1"),
            slog.String("user_agent", "Mozilla/5.0"),
        ),
    )
}
```

è¾“å‡ºï¼š

```json
{
  "time": "2025-10-24T10:00:00Z",
  "level": "INFO",
  "msg": "request received",
  "http": {
    "method": "GET",
    "path": "/api/users",
    "status": 200
  },
  "client": {
    "ip": "192.168.1.1",
    "user_agent": "Mozilla/5.0"
  }
}
```

#### 3. LogValuer - è‡ªå®šä¹‰ç±»å‹æ—¥å¿—

```go
package main

import (
    "fmt"
    "log/slog"
)

type User struct {
    ID       int
    Username string
    Email    string
    Password string  // æ•æ„Ÿä¿¡æ¯
}

// å®ç° LogValuer æ¥å£
func (u User) LogValue() slog.Value {
    return slog.GroupValue(
        slog.Int("id", u.ID),
        slog.String("username", u.Username),
        // ä¸è®°å½• Email å’Œ Password
    )
}

func main() {
    user := User{
        ID:       123,
        Username: "alice",
        Email:    "alice@example.com",
        Password: "secret123",
    }

    slog.Info("user login", "user", user)
    // è¾“å‡º: ... user.id=123 user.username=alice
    // Email å’Œ Password ä¸ä¼šè¢«è®°å½•
}
```

### å®æˆ˜æ¡ˆä¾‹ï¼šWeb åº”ç”¨æ—¥å¿—

```go
package main

import (
    "context"
    "log/slog"
    "net/http"
    "os"
    "time"
)

// Logger ä¸­é—´ä»¶
func LoggerMiddleware(logger *slog.Logger) func(http.Handler) http.Handler {
    return func(next http.Handler) http.Handler {
        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
            start := time.Now()

            // åˆ›å»ºå¸¦è¯·æ±‚ ID çš„ logger
            requestID := generateRequestID()
            reqLogger := logger.With(
                "request_id", requestID,
                "method", r.Method,
                "path", r.URL.Path,
            )

            // å°† logger æ”¾å…¥ context
            ctx := context.WithValue(r.Context(), "logger", reqLogger)

            // è®°å½•è¯·æ±‚å¼€å§‹
            reqLogger.Info("request started", "remote_addr", r.RemoteAddr)

            // å¤„ç†è¯·æ±‚
            next.ServeHTTP(w, r.WithContext(ctx))

            // è®°å½•è¯·æ±‚å®Œæˆ
            duration := time.Since(start)
            reqLogger.Info("request completed",
                "duration_ms", duration.Milliseconds(),
            )
        })
    }
}

func generateRequestID() string {
    return fmt.Sprintf("%d", time.Now().UnixNano())
}

// ä» context è·å– logger
func GetLogger(ctx context.Context) *slog.Logger {
    if logger, ok := ctx.Value("logger").(*slog.Logger); ok {
        return logger
    }
    return slog.Default()
}

func main() {
    // åˆ›å»º logger
    logger := slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
        Level: slog.LevelInfo,
    }))

    mux := http.NewServeMux()

    mux.HandleFunc("/api/users", func(w http.ResponseWriter, r *http.Request) {
        logger := GetLogger(r.Context())

        // ä¸šåŠ¡é€»è¾‘
        logger.Info("fetching users")

        w.Header().Set("Content-Type", "application/json")
        w.Write([]byte(`{"users": []}`))
    })

    // åº”ç”¨ä¸­é—´ä»¶
    handler := LoggerMiddleware(logger)(mux)

    logger.Info("server starting", "port", 8080)
    http.ListenAndServe(":8080", handler)
}
```

---

## ğŸ¯ slices åŒ… - æ³›å‹åˆ‡ç‰‡æ“ä½œ

### å¸¸ç”¨å‡½æ•°

#### 1. æ’åºç›¸å…³

```go
package main

import (
    "fmt"
    "slices"
)

func main() {
    s := []int{5, 2, 8, 1, 9}

    // æ’åº
    slices.Sort(s)
    fmt.Println(s)  // [1 2 5 8 9]

    // æ£€æŸ¥æ˜¯å¦å·²æ’åº
    fmt.Println(slices.IsSorted(s))  // true

    // è‡ªå®šä¹‰æ’åº
    people := []string{"Alice", "bob", "Charlie"}
    slices.SortFunc(people, func(a, b string) int {
        return strings.Compare(strings.ToLower(a), strings.ToLower(b))
    })
    fmt.Println(people)  // [Alice bob Charlie]
}
```

#### 2. æŸ¥æ‰¾ç›¸å…³

```go
package main

import (
    "fmt"
    "slices"
)

func main() {
    s := []int{1, 2, 3, 4, 5}

    // åŒ…å«æ£€æŸ¥
    fmt.Println(slices.Contains(s, 3))  // true

    // æŸ¥æ‰¾ç´¢å¼•
    fmt.Println(slices.Index(s, 3))     // 2
    fmt.Println(slices.Index(s, 10))    // -1

    // äºŒåˆ†æŸ¥æ‰¾ï¼ˆéœ€è¦å·²æ’åºï¼‰
    idx, found := slices.BinarySearch(s, 3)
    fmt.Println(idx, found)  // 2 true

    // æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„å…ƒç´ 
    idx = slices.IndexFunc(s, func(n int) bool {
        return n > 3
    })
    fmt.Println(idx)  // 3 (ç¬¬ä¸€ä¸ª > 3 çš„å…ƒç´ ç´¢å¼•)
}
```

#### 3. æ“ä½œç›¸å…³

```go
package main

import (
    "fmt"
    "slices"
)

func main() {
    s := []int{1, 2, 2, 3, 3, 3, 4}

    // å»é‡ï¼ˆéœ€è¦å·²æ’åºï¼‰
    unique := slices.Compact(s)
    fmt.Println(unique)  // [1 2 3 4]

    // å…‹éš†
    s2 := slices.Clone(s)
    fmt.Println(s2)

    // æ¯”è¾ƒ
    s3 := []int{1, 2, 2, 3, 3, 3, 4}
    fmt.Println(slices.Equal(s, s3))  // true

    // åè½¬
    slices.Reverse(s)
    fmt.Println(s)  // [4 3 3 3 2 2 1]
}
```

#### 4. é«˜çº§æ“ä½œ

```go
package main

import (
    "fmt"
    "slices"
)

func main() {
    // åˆ é™¤å…ƒç´ 
    s := []int{1, 2, 3, 4, 5}
    s = slices.Delete(s, 2, 4)  // åˆ é™¤ç´¢å¼• 2-3 çš„å…ƒç´ 
    fmt.Println(s)  // [1 2 5]

    // æ’å…¥å…ƒç´ 
    s = []int{1, 2, 5}
    s = slices.Insert(s, 2, 3, 4)  // åœ¨ç´¢å¼• 2 æ’å…¥ 3, 4
    fmt.Println(s)  // [1 2 3 4 5]

    // æ›¿æ¢
    s = []int{1, 2, 3, 4, 5}
    s = slices.Replace(s, 1, 3, 10, 20)  // æ›¿æ¢ç´¢å¼• 1-2 ä¸º 10, 20
    fmt.Println(s)  // [1 10 20 4 5]

    // å¢é•¿å®¹é‡
    s = make([]int, 0, 5)
    s = slices.Grow(s, 10)  // ç¡®ä¿è‡³å°‘è¿˜èƒ½å®¹çº³ 10 ä¸ªå…ƒç´ 
    fmt.Println(cap(s))     // >= 10

    // è£å‰ªå¤šä½™å®¹é‡
    s = make([]int, 5, 20)
    s = slices.Clip(s)
    fmt.Println(len(s), cap(s))  // 5 5
}
```

---

## ğŸ¯ maps åŒ… - æ³›å‹æ˜ å°„æ“ä½œ

### å¸¸ç”¨å‡½æ•°1

```go
package main

import (
    "fmt"
    "maps"
)

func main() {
    m1 := map[string]int{"a": 1, "b": 2}
    m2 := map[string]int{"b": 3, "c": 4}

    // å…‹éš†
    m3 := maps.Clone(m1)
    fmt.Println(m3)  // map[a:1 b:2]

    // å¤åˆ¶ï¼ˆåˆå¹¶ï¼‰
    maps.Copy(m3, m2)
    fmt.Println(m3)  // map[a:1 b:3 c:4]

    // æ¯”è¾ƒ
    fmt.Println(maps.Equal(m1, m2))  // false

    // åˆ é™¤æ»¡è¶³æ¡ä»¶çš„é”®å€¼å¯¹
    maps.DeleteFunc(m3, func(k string, v int) bool {
        return v < 3
    })
    fmt.Println(m3)  // map[b:3 c:4]
}
```

---

## ğŸ¯ cmp åŒ… - æ¯”è¾ƒå·¥å…·

### åŸºæœ¬ç”¨æ³•1

```go
package main

import (
    "cmp"
    "fmt"
    "slices"
)

func main() {
    // cmp.Compare: ä¸‰å‘æ¯”è¾ƒ
    fmt.Println(cmp.Compare(1, 2))   // -1 (1 < 2)
    fmt.Println(cmp.Compare(2, 2))   // 0  (2 == 2)
    fmt.Println(cmp.Compare(3, 2))   // 1  (3 > 2)

    // cmp.Less: ç®€åŒ–ç‰ˆ
    fmt.Println(cmp.Less(1, 2))      // true

    // ä¸ slices ç»“åˆ
    type Person struct {
        Name string
        Age  int
    }

    people := []Person{
        {"Alice", 30},
        {"Bob", 25},
        {"Charlie", 35},
    }

    // æŒ‰å¹´é¾„æ’åº
    slices.SortFunc(people, func(a, b Person) int {
        return cmp.Compare(a.Age, b.Age)
    })
    fmt.Println(people)
    // [{Bob 25} {Alice 30} {Charlie 35}]

    // ä½¿ç”¨ cmp.Or å®ç°å¤šå­—æ®µæ’åº
    slices.SortFunc(people, func(a, b Person) int {
        return cmp.Or(
            cmp.Compare(a.Age, b.Age),          // é¦–å…ˆæŒ‰å¹´é¾„
            cmp.Compare(a.Name, b.Name),        // å¹´é¾„ç›¸åŒæŒ‰åå­—
        )
    })
}
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. slog ä½¿ç”¨å»ºè®®

âœ… **æ¨è**ï¼š

```go
// ä½¿ç”¨ç»“æ„åŒ–å­—æ®µ
slog.Info("user login", "user_id", 123, "ip", "192.168.1.1")

// ä½¿ç”¨ With() æ·»åŠ ä¸Šä¸‹æ–‡
logger := slog.Default().With("service", "api", "version", "v1")
```

âŒ **ä¸æ¨è**ï¼š

```go
// ä¸è¦åœ¨æ¶ˆæ¯ä¸­æ’å…¥å˜é‡
slog.Info(fmt.Sprintf("user %d login from %s", userID, ip))
```

### 2. slices æ€§èƒ½ä¼˜åŒ–

```go
// âœ… ä½¿ç”¨ slices.Grow é¢„åˆ†é…
s := make([]int, 0)
s = slices.Grow(s, 1000)  // é¢„åˆ†é…å®¹é‡

// âŒ é¢‘ç¹ append å¯¼è‡´å¤šæ¬¡æ‰©å®¹
s := make([]int, 0)
for i := 0; i < 1000; i++ {
    s = append(s, i)
}
```

---

## ğŸ“š æ‰©å±•é˜…è¯»

- [log/slog åŒ…æ–‡æ¡£](https://pkg.go.dev/log/slog)
- [slices åŒ…æ–‡æ¡£](https://pkg.go.dev/slices)
- [maps åŒ…æ–‡æ¡£](https://pkg.go.dev/maps)
- [cmp åŒ…æ–‡æ¡£](https://pkg.go.dev/cmp)
- [ç»“æ„åŒ–æ—¥å¿—æœ€ä½³å®è·µ](https://go.dev/blog/slog)

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Go Documentation Team
**æœ€åæ›´æ–°**: 2025-10-29
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ
**é€‚ç”¨ç‰ˆæœ¬**: Go 1.21+
