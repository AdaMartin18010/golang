# Go 1.22ç‰¹æ€§ - æ¦‚å¿µå®šä¹‰ä½“ç³»

**ç‰ˆæœ¬**: v1.0  
**å‘å¸ƒæ—¥æœŸ**: 2024å¹´2æœˆ  
**æ›´æ–°æ—¥æœŸ**: 2025-10-28

---

## 1. æ ¸å¿ƒæ¦‚å¿µ

### 1.1 forå¾ªç¯å˜é‡ä½œç”¨åŸŸ

**å½¢å¼åŒ–å®šä¹‰**:
```go
// Go 1.21 (æ—§è¡Œä¸º)
for i := 0; i < n; i++ {
    // içš„ä½œç”¨åŸŸ: æ•´ä¸ªå¾ªç¯
    // æ‰€æœ‰è¿­ä»£å…±äº«åŒä¸€ä¸ªiå˜é‡
}

// Go 1.22 (æ–°è¡Œä¸º)
for i := 0; i < n; i++ {
    // içš„ä½œç”¨åŸŸ: å•æ¬¡è¿­ä»£
    // æ¯æ¬¡è¿­ä»£éƒ½æ˜¯æ–°çš„iå˜é‡
}
```

**é—®é¢˜ç¤ºä¾‹**:
```go
// Go 1.21 - Bug
var funcs []func()
for i := 0; i < 3; i++ {
    funcs = append(funcs, func() {
        fmt.Println(i)  // éƒ½æ‰“å°3ï¼
    })
}
for _, f := range funcs {
    f()  // è¾“å‡º: 3 3 3
}

// Go 1.22 - ä¿®å¤
var funcs []func()
for i := 0; i < 3; i++ {
    funcs = append(funcs, func() {
        fmt.Println(i)  // æ­£ç¡®æ•è·
    })
}
for _, f := range funcs {
    f()  // è¾“å‡º: 0 1 2
}
```

**å‘åå…¼å®¹**:
```bash
# ä½¿ç”¨æ—§è¡Œä¸º
GODEBUG=loopvar=1 go run main.go
```

---

### 1.2 HTTPè·¯ç”±å¢å¼º

**å½¢å¼åŒ–å®šä¹‰**:
```go
type Route struct {
    Method      string      // GET/POST/PUT/DELETE/...
    Pattern     string      // /users/{id}
    Wildcards   []string    // {id}, {name}
    Handler     HandlerFunc
    Priority    int         // åŒ¹é…ä¼˜å…ˆçº§
}
```

**æ–¹æ³•åŒ¹é…**:
```go
// è¯­æ³•
http.HandleFunc("METHOD /path", handler)

// ç¤ºä¾‹
http.HandleFunc("GET /users", listUsers)
http.HandleFunc("POST /users", createUser)
http.HandleFunc("PUT /users/{id}", updateUser)
http.HandleFunc("DELETE /users/{id}", deleteUser)
```

**è·¯å¾„å‚æ•°**:
```go
// å®šä¹‰
http.HandleFunc("GET /users/{id}/posts/{postID}", handler)

// ä½¿ç”¨
func handler(w http.ResponseWriter, r *http.Request) {
    userID := r.PathValue("id")
    postID := r.PathValue("postID")
    // ...
}
```

**é€šé…ç¬¦**:
```go
// {path...} åŒ¹é…å‰©ä½™æ‰€æœ‰è·¯å¾„
http.HandleFunc("GET /files/{path...}", func(w http.ResponseWriter, r *http.Request) {
    path := r.PathValue("path")
    // pathå¯ä»¥æ˜¯: "a/b/c"
})
```

**ä¼˜å…ˆçº§è§„åˆ™**:
```go
// 1. å­—é¢é‡ > å‚æ•° > é€šé…ç¬¦
http.HandleFunc("/users/admin", h1)    // æœ€é«˜ä¼˜å…ˆçº§
http.HandleFunc("/users/{id}", h2)     // ä¸­ä¼˜å…ˆçº§
http.HandleFunc("/users/{path...}", h3) // æœ€ä½ä¼˜å…ˆçº§

// 2. æ›´é•¿è·¯å¾„ > æ›´çŸ­è·¯å¾„
http.HandleFunc("/api/v1/users", h1)   // ä¼˜å…ˆ
http.HandleFunc("/api/v1", h2)         // æ¬¡ä¹‹
```

---

### 1.3 range over integer

**å½¢å¼åŒ–å®šä¹‰**:
```go
// Go 1.22æ–°å¢
for i := range n {
    // i: 0, 1, 2, ..., n-1
}

// ç­‰ä»·äº
for i := 0; i < n; i++ {
    // ...
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```go
// Before (Go 1.21)
for i := 0; i < 10; i++ {
    fmt.Println(i)
}

// After (Go 1.22)
for i := range 10 {
    fmt.Println(i)  // æ›´ç®€æ´ï¼
}
```

---

### 1.4 math/rand/v2

**å½¢å¼åŒ–å®šä¹‰**:
```go
package rand  // v2

type Rand struct {
    src Source
}

type Source interface {
    Uint64() uint64
}
```

**ä¸»è¦æ”¹è¿›**:
1. **æ›´å¥½çš„APIè®¾è®¡**
2. **æ›´å¼ºçš„ç±»å‹å®‰å…¨**
3. **æ›´å¥½çš„æ€§èƒ½**
4. **æ›´å¥½çš„å¹¶å‘æ”¯æŒ**

**ä½¿ç”¨ç¤ºä¾‹**:
```go
// v1 (æ—§)
import "math/rand"

rand.Seed(time.Now().UnixNano())
n := rand.Intn(100)

// v2 (æ–°)
import "math/rand/v2"

// è‡ªåŠ¨ç§å­
n := rand.IntN(100)  // æ³¨æ„: IntNè€ŒéIntn

// è‡ªå®šä¹‰Rand
r := rand.New(rand.NewPCG(seed1, seed2))
n := r.IntN(100)
```

**APIå¯¹æ¯”**:
```go
// v1                  v2
rand.Intn(n)    â†’    rand.IntN(n)
rand.Int63n(n)  â†’    rand.Int64N(n)
rand.Float64()  â†’    rand.Float64()  // ç›¸åŒ
```

---

## 2. æ¦‚å¿µå…³ç³»

### forå¾ªç¯ â†’ é—­åŒ…

```go
// é—®é¢˜æ ¹æº
for i := 0; i < 3; i++ {
    // Go 1.21: iæ˜¯å¾ªç¯å˜é‡ï¼Œåœ°å€å›ºå®š
    // Go 1.22: iæ˜¯è¿­ä»£å˜é‡ï¼Œæ¯æ¬¡æ–°åœ°å€
    
    go func() {
        // é—­åŒ…æ•è·içš„åœ°å€
        fmt.Println(i)
    }()
}
```

### HTTPè·¯ç”± â†’ RESTful API

```go
// Go 1.22ç®€åŒ–RESTful APIå®ç°
http.HandleFunc("GET /api/users", listUsers)
http.HandleFunc("GET /api/users/{id}", getUser)
http.HandleFunc("POST /api/users", createUser)
http.HandleFunc("PUT /api/users/{id}", updateUser)
http.HandleFunc("DELETE /api/users/{id}", deleteUser)

// ä¸å†éœ€è¦ç¬¬ä¸‰æ–¹è·¯ç”±æ¡†æ¶ï¼
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [çŸ¥è¯†å›¾è°±](./00-çŸ¥è¯†å›¾è°±.md)
- [å¯¹æ¯”çŸ©é˜µ](./00-å¯¹æ¯”çŸ©é˜µ.md)
- [README.md](./README.md)

---

**æœ€åæ›´æ–°**: 2025-10-28
