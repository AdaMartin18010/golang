# Go 1.22特性 - 概念定义体系

**版本**: v1.0  
**发布日期**: 2024年2月  
**更新日期**: 2025-10-28

---

## 1. 核心概念

### 1.1 for循环变量作用域

**形式化定义**:
```go
// Go 1.21 (旧行为)
for i := 0; i < n; i++ {
    // i的作用域: 整个循环
    // 所有迭代共享同一个i变量
}

// Go 1.22 (新行为)
for i := 0; i < n; i++ {
    // i的作用域: 单次迭代
    // 每次迭代都是新的i变量
}
```

**问题示例**:
```go
// Go 1.21 - Bug
var funcs []func()
for i := 0; i < 3; i++ {
    funcs = append(funcs, func() {
        fmt.Println(i)  // 都打印3！
    })
}
for _, f := range funcs {
    f()  // 输出: 3 3 3
}

// Go 1.22 - 修复
var funcs []func()
for i := 0; i < 3; i++ {
    funcs = append(funcs, func() {
        fmt.Println(i)  // 正确捕获
    })
}
for _, f := range funcs {
    f()  // 输出: 0 1 2
}
```

**向后兼容**:
```bash
# 使用旧行为
GODEBUG=loopvar=1 go run main.go
```

---

### 1.2 HTTP路由增强

**形式化定义**:
```go
type Route struct {
    Method      string      // GET/POST/PUT/DELETE/...
    Pattern     string      // /users/{id}
    Wildcards   []string    // {id}, {name}
    Handler     HandlerFunc
    Priority    int         // 匹配优先级
}
```

**方法匹配**:
```go
// 语法
http.HandleFunc("METHOD /path", handler)

// 示例
http.HandleFunc("GET /users", listUsers)
http.HandleFunc("POST /users", createUser)
http.HandleFunc("PUT /users/{id}", updateUser)
http.HandleFunc("DELETE /users/{id}", deleteUser)
```

**路径参数**:
```go
// 定义
http.HandleFunc("GET /users/{id}/posts/{postID}", handler)

// 使用
func handler(w http.ResponseWriter, r *http.Request) {
    userID := r.PathValue("id")
    postID := r.PathValue("postID")
    // ...
}
```

**通配符**:
```go
// {path...} 匹配剩余所有路径
http.HandleFunc("GET /files/{path...}", func(w http.ResponseWriter, r *http.Request) {
    path := r.PathValue("path")
    // path可以是: "a/b/c"
})
```

**优先级规则**:
```go
// 1. 字面量 > 参数 > 通配符
http.HandleFunc("/users/admin", h1)    // 最高优先级
http.HandleFunc("/users/{id}", h2)     // 中优先级
http.HandleFunc("/users/{path...}", h3) // 最低优先级

// 2. 更长路径 > 更短路径
http.HandleFunc("/api/v1/users", h1)   // 优先
http.HandleFunc("/api/v1", h2)         // 次之
```

---

### 1.3 range over integer

**形式化定义**:
```go
// Go 1.22新增
for i := range n {
    // i: 0, 1, 2, ..., n-1
}

// 等价于
for i := 0; i < n; i++ {
    // ...
}
```

**使用示例**:
```go
// Before (Go 1.21)
for i := 0; i < 10; i++ {
    fmt.Println(i)
}

// After (Go 1.22)
for i := range 10 {
    fmt.Println(i)  // 更简洁！
}
```

---

### 1.4 math/rand/v2

**形式化定义**:
```go
package rand  // v2

type Rand struct {
    src Source
}

type Source interface {
    Uint64() uint64
}
```

**主要改进**:
1. **更好的API设计**
2. **更强的类型安全**
3. **更好的性能**
4. **更好的并发支持**

**使用示例**:
```go
// v1 (旧)
import "math/rand"

rand.Seed(time.Now().UnixNano())
n := rand.Intn(100)

// v2 (新)
import "math/rand/v2"

// 自动种子
n := rand.IntN(100)  // 注意: IntN而非Intn

// 自定义Rand
r := rand.New(rand.NewPCG(seed1, seed2))
n := r.IntN(100)
```

**API对比**:
```go
// v1                  v2
rand.Intn(n)    →    rand.IntN(n)
rand.Int63n(n)  →    rand.Int64N(n)
rand.Float64()  →    rand.Float64()  // 相同
```

---

## 2. 概念关系

### for循环 → 闭包

```go
// 问题根源
for i := 0; i < 3; i++ {
    // Go 1.21: i是循环变量，地址固定
    // Go 1.22: i是迭代变量，每次新地址
    
    go func() {
        // 闭包捕获i的地址
        fmt.Println(i)
    }()
}
```

### HTTP路由 → RESTful API

```go
// Go 1.22简化RESTful API实现
http.HandleFunc("GET /api/users", listUsers)
http.HandleFunc("GET /api/users/{id}", getUser)
http.HandleFunc("POST /api/users", createUser)
http.HandleFunc("PUT /api/users/{id}", updateUser)
http.HandleFunc("DELETE /api/users/{id}", deleteUser)

// 不再需要第三方路由框架！
```

---

## 🔗 相关文档

- [知识图谱](./00-知识图谱.md)
- [对比矩阵](./00-对比矩阵.md)
- [README.md](./README.md)

---

**最后更新**: 2025-10-28
