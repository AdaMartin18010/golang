# å·¨å‹ç»ˆæè¶…çº§ä¿®æ­£PowerShellè„šæœ¬
# å¤„ç†æ‰€æœ‰å‰©ä½™çš„TOCå’Œåºå·æ ¼å¼é—®é¢˜

Write-Host "ğŸš€ å¼€å§‹å·¨å‹ç»ˆæè¶…çº§ä¿®æ­£..." -ForegroundColor Green

# å®šä¹‰æ‰€æœ‰éœ€è¦ä¿®æ­£çš„æ¨¡å¼
$megaUltimateSuperPatterns = @{
    # ä¿®æ­£æ‰€æœ‰å¸¸è§çš„åºå·é”™è¯¯
    "- \[1 1 1 1 1 1 1 ([^\]]+)\]" = "- [1. $1]"
    "- \[9 9 9 9 9 9 9 ([^\]]+)\]" = "- [2. $1]"
    "- \[13 13 13 13 13 13 13 ([^\]]+)\]" = "- [3. $1]"
    "- \[14 14 14 14 14 14 14 ([^\]]+)\]" = "- [4. $1]"
    "- \[15 15 15 15 15 15 15 ([^\]]+)\]" = "- [5. $1]"
    
    # ä¿®æ­£æ ‡é¢˜ä¸­çš„åºå·é”™è¯¯
    "^# 1 1 1 1 1 1 1 " = "# 1. "
    "^## 9 9 9 9 9 9 9 " = "## 2. "
    "^## 13 13 13 13 13 13 13 " = "## 3. "
    "^## 14 14 14 14 14 14 14 " = "## 4. "
    "^## 15 15 15 15 15 15 15 " = "## 5. "
    
    # ä¿®æ­£TOCé“¾æ¥æ ¼å¼é”™è¯¯
    "- \[1\.2\.1 ([^\]]+)\]" = "- [2.1 $1]"
    "- \[1\.2\.2 ([^\]]+)\]" = "- [2.2 $1]"
    "- \[1\.2\.3 ([^\]]+)\]" = "- [2.3 $1]"
    "- \[1\.2\.4 ([^\]]+)\]" = "- [2.4 $1]"
    "- \[1\.2\.5 ([^\]]+)\]" = "- [2.5 $1]"
    "- \[1\.2\.6 ([^\]]+)\]" = "- [2.6 $1]"
    "- \[1\.2\.7 ([^\]]+)\]" = "- [2.7 $1]"
    "- \[1\.2\.8 ([^\]]+)\]" = "- [2.8 $1]"
    "- \[1\.2\.9 ([^\]]+)\]" = "- [2.9 $1]"
    "- \[1\.2\.10 ([^\]]+)\]" = "- [2.10 $1]"
    "- \[1\.2\.11 ([^\]]+)\]" = "- [2.11 $1]"
    "- \[1\.2\.12 ([^\]]+)\]" = "- [2.12 $1]"
    "- \[1\.2\.13 ([^\]]+)\]" = "- [2.13 $1]"
    "- \[1\.2\.14 ([^\]]+)\]" = "- [2.14 $1]"
    "- \[1\.2\.15 ([^\]]+)\]" = "- [2.15 $1]"
    
    # ä¿®æ­£13.x.xæ ¼å¼é”™è¯¯
    "- \[13\.1 ([^\]]+)\]" = "- [3.1 $1]"
    "- \[13\.2 ([^\]]+)\]" = "- [3.2 $1]"
    "- \[13\.3 ([^\]]+)\]" = "- [3.3 $1]"
    "- \[13\.4 ([^\]]+)\]" = "- [3.4 $1]"
    "- \[13\.5 ([^\]]+)\]" = "- [3.5 $1]"
    "- \[13\.6 ([^\]]+)\]" = "- [3.6 $1]"
    "- \[13\.7 ([^\]]+)\]" = "- [3.7 $1]"
    "- \[13\.8 ([^\]]+)\]" = "- [3.8 $1]"
    "- \[13\.9 ([^\]]+)\]" = "- [3.9 $1]"
    "- \[13\.10 ([^\]]+)\]" = "- [3.10 $1]"
    
    # ä¿®æ­£13.x.x.xæ ¼å¼é”™è¯¯
    "- \[13\.1\.1 ([^\]]+)\]" = "- [3.1.1 $1]"
    "- \[13\.1\.2 ([^\]]+)\]" = "- [3.1.2 $1]"
    "- \[13\.2\.1 ([^\]]+)\]" = "- [3.2.1 $1]"
    "- \[13\.2\.2 ([^\]]+)\]" = "- [3.2.2 $1]"
    "- \[13\.3\.1 ([^\]]+)\]" = "- [3.3.1 $1]"
    "- \[13\.3\.2 ([^\]]+)\]" = "- [3.3.2 $1]"
    "- \[13\.4\.1 ([^\]]+)\]" = "- [3.4.1 $1]"
    "- \[13\.4\.2 ([^\]]+)\]" = "- [3.4.2 $1]"
    "- \[13\.5\.1 ([^\]]+)\]" = "- [3.5.1 $1]"
    "- \[13\.5\.2 ([^\]]+)\]" = "- [3.5.2 $1]"
    "- \[13\.6\.1 ([^\]]+)\]" = "- [3.6.1 $1]"
    "- \[13\.6\.2 ([^\]]+)\]" = "- [3.6.2 $1]"
    "- \[13\.7\.1 ([^\]]+)\]" = "- [3.7.1 $1]"
    "- \[13\.7\.2 ([^\]]+)\]" = "- [3.7.2 $1]"
    "- \[13\.8\.1 ([^\]]+)\]" = "- [3.8.1 $1]"
    "- \[13\.8\.2 ([^\]]+)\]" = "- [3.8.2 $1]"
    "- \[13\.9\.1 ([^\]]+)\]" = "- [3.9.1 $1]"
    "- \[13\.9\.2 ([^\]]+)\]" = "- [3.9.2 $1]"
    "- \[13\.10\.1 ([^\]]+)\]" = "- [3.10.1 $1]"
    "- \[13\.10\.2 ([^\]]+)\]" = "- [3.10.2 $1]"
    
    # ä¿®æ­£14.x.xæ ¼å¼é”™è¯¯
    "- \[14\.1 ([^\]]+)\]" = "- [4.1 $1]"
    "- \[14\.2 ([^\]]+)\]" = "- [4.2 $1]"
    "- \[14\.3 ([^\]]+)\]" = "- [4.3 $1]"
    "- \[14\.4 ([^\]]+)\]" = "- [4.4 $1]"
    "- \[14\.5 ([^\]]+)\]" = "- [4.5 $1]"
    "- \[14\.6 ([^\]]+)\]" = "- [4.6 $1]"
    "- \[14\.7 ([^\]]+)\]" = "- [4.7 $1]"
    "- \[14\.8 ([^\]]+)\]" = "- [4.8 $1]"
    "- \[14\.9 ([^\]]+)\]" = "- [4.9 $1]"
    "- \[14\.10 ([^\]]+)\]" = "- [4.10 $1]"
    
    # ä¿®æ­£14.x.x.xæ ¼å¼é”™è¯¯
    "- \[14\.1\.1 ([^\]]+)\]" = "- [4.1.1 $1]"
    "- \[14\.1\.2 ([^\]]+)\]" = "- [4.1.2 $1]"
    "- \[14\.2\.1 ([^\]]+)\]" = "- [4.2.1 $1]"
    "- \[14\.2\.2 ([^\]]+)\]" = "- [4.2.2 $1]"
    "- \[14\.3\.1 ([^\]]+)\]" = "- [4.3.1 $1]"
    "- \[14\.3\.2 ([^\]]+)\]" = "- [4.3.2 $1]"
    "- \[14\.4\.1 ([^\]]+)\]" = "- [4.4.1 $1]"
    "- \[14\.4\.2 ([^\]]+)\]" = "- [4.4.2 $1]"
    "- \[14\.5\.1 ([^\]]+)\]" = "- [4.5.1 $1]"
    "- \[14\.5\.2 ([^\]]+)\]" = "- [4.5.2 $1]"
    "- \[14\.6\.1 ([^\]]+)\]" = "- [4.6.1 $1]"
    "- \[14\.6\.2 ([^\]]+)\]" = "- [4.6.2 $1]"
    "- \[14\.7\.1 ([^\]]+)\]" = "- [4.7.1 $1]"
    "- \[14\.7\.2 ([^\]]+)\]" = "- [4.7.2 $1]"
    "- \[14\.8\.1 ([^\]]+)\]" = "- [4.8.1 $1]"
    "- \[14\.8\.2 ([^\]]+)\]" = "- [4.8.2 $1]"
    "- \[14\.9\.1 ([^\]]+)\]" = "- [4.9.1 $1]"
    "- \[14\.9\.2 ([^\]]+)\]" = "- [4.9.2 $1]"
    "- \[14\.10\.1 ([^\]]+)\]" = "- [4.10.1 $1]"
    "- \[14\.10\.2 ([^\]]+)\]" = "- [4.10.2 $1]"
    
    # ä¿®æ­£å…¶ä»–å¸¸è§çš„æ ¼å¼é”™è¯¯
    "- \[1\.3 ([^\]]+)\]" = "- [3. $1]"
    "- \[1\.4 ([^\]]+)\]" = "- [4. $1]"
    "- \[1\.5 ([^\]]+)\]" = "- [5. $1]"
    "- \[1\.6 ([^\]]+)\]" = "- [6. $1]"
    "- \[1\.7 ([^\]]+)\]" = "- [7. $1]"
    "- \[1\.8 ([^\]]+)\]" = "- [8. $1]"
    "- \[1\.9 ([^\]]+)\]" = "- [9. $1]"
    "- \[1\.10 ([^\]]+)\]" = "- [10. $1]"
    
    # ä¿®æ­£1.3.xæ ¼å¼é”™è¯¯
    "- \[1\.3\.1 ([^\]]+)\]" = "- [3.1 $1]"
    "- \[1\.3\.2 ([^\]]+)\]" = "- [3.2 $1]"
    "- \[1\.3\.3 ([^\]]+)\]" = "- [3.3 $1]"
    "- \[1\.3\.4 ([^\]]+)\]" = "- [3.4 $1]"
    "- \[1\.3\.5 ([^\]]+)\]" = "- [3.5 $1]"
    
    # ä¿®æ­£1.4.xæ ¼å¼é”™è¯¯
    "- \[1\.4\.1 ([^\]]+)\]" = "- [4.1 $1]"
    "- \[1\.4\.2 ([^\]]+)\]" = "- [4.2 $1]"
    "- \[1\.4\.3 ([^\]]+)\]" = "- [4.3 $1]"
    "- \[1\.4\.4 ([^\]]+)\]" = "- [4.4 $1]"
    "- \[1\.4\.5 ([^\]]+)\]" = "- [4.5 $1]"
    
    # ä¿®æ­£1.5.xæ ¼å¼é”™è¯¯
    "- \[1\.5\.1 ([^\]]+)\]" = "- [5.1 $1]"
    "- \[1\.5\.2 ([^\]]+)\]" = "- [5.2 $1]"
    "- \[1\.5\.3 ([^\]]+)\]" = "- [5.3 $1]"
    "- \[1\.5\.4 ([^\]]+)\]" = "- [5.4 $1]"
    "- \[1\.5\.5 ([^\]]+)\]" = "- [5.5 $1]"
    
    # ä¿®æ­£1.6.xæ ¼å¼é”™è¯¯
    "- \[1\.6\.1 ([^\]]+)\]" = "- [6.1 $1]"
    "- \[1\.6\.2 ([^\]]+)\]" = "- [6.2 $1]"
    "- \[1\.6\.3 ([^\]]+)\]" = "- [6.3 $1]"
    "- \[1\.6\.4 ([^\]]+)\]" = "- [6.4 $1]"
    "- \[1\.6\.5 ([^\]]+)\]" = "- [6.5 $1]"
    
    # ä¿®æ­£1.7.xæ ¼å¼é”™è¯¯
    "- \[1\.7\.1 ([^\]]+)\]" = "- [7.1 $1]"
    "- \[1\.7\.2 ([^\]]+)\]" = "- [7.2 $1]"
    "- \[1\.7\.3 ([^\]]+)\]" = "- [7.3 $1]"
    "- \[1\.7\.4 ([^\]]+)\]" = "- [7.4 $1]"
    "- \[1\.7\.5 ([^\]]+)\]" = "- [7.5 $1]"
    
    # ä¿®æ­£1.8.xæ ¼å¼é”™è¯¯
    "- \[1\.8\.1 ([^\]]+)\]" = "- [8.1 $1]"
    "- \[1\.8\.2 ([^\]]+)\]" = "- [8.2 $1]"
    "- \[1\.8\.3 ([^\]]+)\]" = "- [8.3 $1]"
    "- \[1\.8\.4 ([^\]]+)\]" = "- [8.4 $1]"
    "- \[1\.8\.5 ([^\]]+)\]" = "- [8.5 $1]"
    
    # ä¿®æ­£1.9.xæ ¼å¼é”™è¯¯
    "- \[1\.9\.1 ([^\]]+)\]" = "- [9.1 $1]"
    "- \[1\.9\.2 ([^\]]+)\]" = "- [9.2 $1]"
    "- \[1\.9\.3 ([^\]]+)\]" = "- [9.3 $1]"
    "- \[1\.9\.4 ([^\]]+)\]" = "- [9.4 $1]"
    "- \[1\.9\.5 ([^\]]+)\]" = "- [9.5 $1]"
    
    # ä¿®æ­£1.10.xæ ¼å¼é”™è¯¯
    "- \[1\.10\.1 ([^\]]+)\]" = "- [10.1 $1]"
    "- \[1\.10\.2 ([^\]]+)\]" = "- [10.2 $1]"
    "- \[1\.10\.3 ([^\]]+)\]" = "- [10.3 $1]"
    "- \[1\.10\.4 ([^\]]+)\]" = "- [10.4 $1]"
    "- \[1\.10\.5 ([^\]]+)\]" = "- [10.5 $1]"
    
    # ä¿®æ­£å…¶ä»–ç‰¹æ®Šæ ¼å¼é”™è¯¯
    "- \[1\.1\.1 ([^\]]+)\]" = "- [1.1 $1]"
    "- \[1\.1\.2 ([^\]]+)\]" = "- [1.2 $1]"
    "- \[1\.1\.3 ([^\]]+)\]" = "- [1.3 $1]"
    "- \[1\.1\.4 ([^\]]+)\]" = "- [1.4 $1]"
    "- \[1\.1\.5 ([^\]]+)\]" = "- [1.5 $1]"
    
    # ä¿®æ­£2.x.xæ ¼å¼é”™è¯¯
    "- \[2\.1\.1 ([^\]]+)\]" = "- [2.1 $1]"
    "- \[2\.1\.2 ([^\]]+)\]" = "- [2.2 $1]"
    "- \[2\.1\.3 ([^\]]+)\]" = "- [2.3 $1]"
    "- \[2\.1\.4 ([^\]]+)\]" = "- [2.4 $1]"
    "- \[2\.1\.5 ([^\]]+)\]" = "- [2.5 $1]"
    
    # ä¿®æ­£3.x.xæ ¼å¼é”™è¯¯
    "- \[3\.1\.1 ([^\]]+)\]" = "- [3.1 $1]"
    "- \[3\.1\.2 ([^\]]+)\]" = "- [3.2 $1]"
    "- \[3\.1\.3 ([^\]]+)\]" = "- [3.3 $1]"
    "- \[3\.1\.4 ([^\]]+)\]" = "- [3.4 $1]"
    "- \[3\.1\.5 ([^\]]+)\]" = "- [3.5 $1]"
    
    # ä¿®æ­£4.x.xæ ¼å¼é”™è¯¯
    "- \[4\.1\.1 ([^\]]+)\]" = "- [4.1 $1]"
    "- \[4\.1\.2 ([^\]]+)\]" = "- [4.2 $1]"
    "- \[4\.1\.3 ([^\]]+)\]" = "- [4.3 $1]"
    "- \[4\.1\.4 ([^\]]+)\]" = "- [4.4 $1]"
    "- \[4\.1\.5 ([^\]]+)\]" = "- [4.5 $1]"
    
    # ä¿®æ­£5.x.xæ ¼å¼é”™è¯¯
    "- \[5\.1\.1 ([^\]]+)\]" = "- [5.1 $1]"
    "- \[5\.1\.2 ([^\]]+)\]" = "- [5.2 $1]"
    "- \[5\.1\.3 ([^\]]+)\]" = "- [5.3 $1]"
    "- \[5\.1\.4 ([^\]]+)\]" = "- [5.4 $1]"
    "- \[5\.1\.5 ([^\]]+)\]" = "- [5.5 $1]"
}

# è·å–æ‰€æœ‰markdownæ–‡ä»¶
$markdownFiles = Get-ChildItem -Path "." -Recurse -Filter "*.md" -File

$totalFiles = 0
$fixedFiles = 0
$skippedFiles = 0
$errorFiles = 0

foreach ($file in $markdownFiles) {
    $totalFiles++
    Write-Host "ğŸ“ å¤„ç†æ–‡ä»¶: $($file.FullName)" -ForegroundColor Yellow
    
    try {
        # è¯»å–æ–‡ä»¶å†…å®¹
        $content = Get-Content -Path $file.FullName -Raw -Encoding UTF8
        $originalContent = $content
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«TOC
        if ($content -match "<!-- TOC START -->" -and $content -match "<!-- TOC END -->") {
            Write-Host "  ğŸ” å‘ç°TOCï¼Œå¼€å§‹æ£€æŸ¥é“¾æ¥..." -ForegroundColor Cyan
            
            # åº”ç”¨å·¨å‹ç»ˆæè¶…çº§ä¿®æ­£æ¨¡å¼
            $hasChanges = $false
            foreach ($pattern in $megaUltimateSuperPatterns.Keys) {
                $replacement = $megaUltimateSuperPatterns[$pattern]
                $newContent = $content -replace $pattern, $replacement
                if ($newContent -ne $content) {
                    $content = $newContent
                    $hasChanges = $true
                    Write-Host "    ğŸ”§ ä¿®æ­£æ¨¡å¼: $pattern" -ForegroundColor Magenta
                }
            }
            
            if ($hasChanges) {
                # å†™å›ä¿®æ­£åçš„å†…å®¹
                Set-Content -Path $file.FullName -Value $content -Encoding UTF8
                Write-Host "  âœ… TOCé“¾æ¥ä¿®æ­£å®Œæˆ" -ForegroundColor Green
                $fixedFiles++
            } else {
                Write-Host "  âœ… TOCé“¾æ¥æ ¼å¼æ­£ç¡®" -ForegroundColor Blue
                $skippedFiles++
            }
        } else {
            Write-Host "  âšª æ— TOCï¼Œè·³è¿‡" -ForegroundColor Gray
            $skippedFiles++
        }
    } catch {
        Write-Host "  âŒ å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: $($_.Exception.Message)" -ForegroundColor Red
        $errorFiles++
    }
    
    Write-Host ""
}

Write-Host "ğŸ“Š å·¨å‹ç»ˆæè¶…çº§ä¿®æ­£å®Œæˆç»Ÿè®¡:" -ForegroundColor Cyan
Write-Host "  æ€»æ–‡ä»¶æ•°: $totalFiles" -ForegroundColor White
Write-Host "  ä¿®æ­£æ–‡ä»¶æ•°: $fixedFiles" -ForegroundColor Green
Write-Host "  è·³è¿‡æ–‡ä»¶æ•°: $skippedFiles" -ForegroundColor Blue
Write-Host "  é”™è¯¯æ–‡ä»¶æ•°: $errorFiles" -ForegroundColor Red
Write-Host ""

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰TOCé“¾æ¥é”™è¯¯
Write-Host "ğŸ” æ£€æŸ¥å‰©ä½™TOCé“¾æ¥é”™è¯¯..." -ForegroundColor Cyan
$remainingErrorFiles = Get-ChildItem -Path "." -Recurse -Filter "*.md" -File | Where-Object {
    try {
        $content = Get-Content -Path $_.FullName -Raw -Encoding UTF8
        $content -match "<!-- TOC START -->" -and $content -match "<!-- TOC END -->" -and 
        ($content -match "1\.2\.\d+|13\.\d+|14\.\d+|1 1 1 1 1 1 1|9 9 9 9 9 9 9|13 13 13 13 13 13 13|14 14 14 14 14 14 14|15 15 15 15 15 15 15")
    } catch {
        $false
    }
}

if ($remainingErrorFiles.Count -gt 0) {
    Write-Host "âš ï¸  ä»æœ‰ $($remainingErrorFiles.Count) ä¸ªæ–‡ä»¶çš„TOCå­˜åœ¨é“¾æ¥é”™è¯¯:" -ForegroundColor Yellow
    $remainingErrorFiles | ForEach-Object { Write-Host "  $($_.FullName)" -ForegroundColor Red }
} else {
    Write-Host "ğŸ‰ æ‰€æœ‰TOCé“¾æ¥ä¿®æ­£å®Œæˆï¼" -ForegroundColor Green
}

Write-Host ""
Write-Host "âœ¨ å·¨å‹ç»ˆæè¶…çº§ä¿®æ­£è„šæœ¬æ‰§è¡Œå®Œæˆ" -ForegroundColor Green
