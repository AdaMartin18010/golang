//go:build wasip1

package main

/*
   ======================================================================
   Go WASM/WASI å‡½æ•°å¯¼å‡ºåŸºç¡€ç¤ºä¾‹
   ======================================================================

   ğŸ¯ ç›®çš„:
   æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ `//go:wasmexport` (Go 1.24+) ç¼–è¯‘æŒ‡ä»¤å°†ä¸€ä¸ª Go å‡½æ•°
   å¯¼å‡ºï¼Œä½¿å…¶å¯ä»¥è¢« WASM å®¿ä¸»ç¯å¢ƒï¼ˆHostï¼‰è°ƒç”¨ã€‚

   âš™ï¸ å¦‚ä½•ç¼–è¯‘:
   ä½¿ç”¨ Go 1.24 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œåœ¨å½“å‰ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
   $ go build -o main.wasm .

   è¿™æ¡å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ª `main.wasm` æ–‡ä»¶ã€‚`-o` å‚æ•°æŒ‡å®šè¾“å‡ºæ–‡ä»¶åã€‚

   ğŸš€ å¦‚ä½•è¿è¡Œ (éœ€è¦ WASM è¿è¡Œæ—¶, ä¾‹å¦‚ Wasmtime):
   1. é¦–å…ˆï¼Œå®‰è£… Wasmtime: https://wasmtime.dev/
   2. ä½¿ç”¨ Wasmtime è¿è¡Œç¼–è¯‘å¥½çš„æ¨¡å—ï¼Œå¹¶è°ƒç”¨å¯¼å‡ºçš„ `add` å‡½æ•°:
      $ wasmtime run --invoke add main.wasm 40 2

   ğŸ” é¢„æœŸè¾“å‡º:
   Wasmtime ä¼šåŠ è½½ `main.wasm` æ¨¡å—ï¼Œè°ƒç”¨å¯¼å‡ºçš„ `add` å‡½æ•°å¹¶ä¼ å…¥å‚æ•° 40 å’Œ 2ï¼Œ
   ç„¶åæ‰“å°å‡ºå‡½æ•°çš„è¿”å›å€¼ã€‚
   > 42

   ä½ ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™æ ·çš„æç¤ºä¿¡æ¯ï¼š
   > warning: using experimental feature: `wasi:cli/run`
*/

//go:wasmexport add
// `//go:wasmexport` æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œå®ƒå‘Šè¯‰ Go ç¼–è¯‘å™¨ï¼š
// 1. å°†ç´§éšå…¶åçš„ `add` å‡½æ•°æ ‡è®°ä¸ºå¯å¯¼å‡ºçš„ã€‚
// 2. åœ¨ç”Ÿæˆçš„ `.wasm` æ¨¡å—çš„å¯¼å‡ºèŠ‚ï¼ˆExport Sectionï¼‰ä¸­ï¼Œ
//    åˆ›å»ºä¸€ä¸ªåä¸º "add" çš„æ¡ç›®æŒ‡å‘è¿™ä¸ªå‡½æ•°ã€‚
func add(a, b int) int {
	return a + b
}

// main å‡½æ•°æ˜¯å¿…éœ€çš„ï¼Œå³ä½¿å®ƒä»€ä¹ˆä¹Ÿä¸åšã€‚
// åœ¨ `wasip1` ç›®æ ‡ä¸‹ï¼Œ`main` å‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£ç‚¹ï¼Œ
// å¦‚æœ WASM æ¨¡å—è¢«ä½œä¸ºç‹¬ç«‹çš„åº”ç”¨ç¨‹åºè¿è¡Œï¼Œ`main` å°†è¢«æ‰§è¡Œã€‚
// å½“æˆ‘ä»¬åªæ˜¯æƒ³è°ƒç”¨å¯¼å‡ºçš„å‡½æ•°æ—¶ï¼Œ`main` å¯ä»¥ä¸ºç©ºã€‚
func main() {
	println("Go WASM module loaded. Ready to be invoked.")
}
