# Go 1.24 æµ‹è¯•å¢žå¼ºï¼š`testing.B.Loop` æœ€ä½³å®žè·µ

## ðŸŽ¯ **æ ¸å¿ƒæ¦‚å¿µ**

`testing.B.Loop` æ˜¯åœ¨ Go 1.24 ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°çš„åŸºå‡†æµ‹è¯•è¾…åŠ©å‡½æ•°ï¼Œæ—¨åœ¨è§£å†³ä¼ ç»Ÿ `for i := 0; i < b.N; i++` å¾ªçŽ¯åœ¨ç¼–å†™å¤æ‚åŸºå‡†æµ‹è¯•æ—¶çš„ä¸€äº›ç—›ç‚¹ã€‚å®ƒæä¾›äº†ä¸€ç§æ›´æ¸…æ™°ã€æ›´å¥å£®çš„æ–¹å¼æ¥ç»„ç»‡åŸºå‡†æµ‹è¯•ä»£ç ï¼Œå¹¶å†…ç½®äº†å¯¹å¹¶è¡Œæµ‹è¯•çš„ç®€åŒ–æ”¯æŒã€‚

`B.Loop` çš„æ ¸å¿ƒæ˜¯å°†è¢«æµ‹è¯•çš„é€»è¾‘å°è£…åœ¨ä¸€ä¸ªå‡½æ•°ä½“å†…ï¼Œç”± `Loop` æ–¹æ³•è´Ÿè´£æ‰§è¡Œ `b.N` æ¬¡ã€‚

**åŸºæœ¬è¯­æ³•**:

```go
func BenchmarkMyFunction(b *testing.B) {
    // 1. åœ¨å¾ªçŽ¯å¤–æ‰§è¡Œæ‰€æœ‰æ˜‚è´µçš„è®¾ç½®
    setupData := prepareExpensiveData()
    b.ResetTimer()

    // 2. ä½¿ç”¨ b.Loop æ‰§è¡ŒåŸºå‡†æµ‹è¯•
    b.Loop(func(i int) {
        // 3. å°†è¦è¢«æµ‹è¯•çš„æ ¸å¿ƒé€»è¾‘æ”¾åœ¨è¿™é‡Œ
        myFunction(setupData)
    })
}
```

## âœ¨ **ç›¸æ¯”ä¼ ç»Ÿ `for b.N` å¾ªçŽ¯çš„ä¸»è¦ä¼˜åŠ¿**

1. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**:
    - `B.Loop` å¼ºåˆ¶å°†**"å•æ¬¡è®¾ç½®" (per-run setup)** ä¸Ž **"æ¯æ¬¡è¿­ä»£çš„é€»è¾‘" (per-iteration logic)** åˆ†ç¦»å¼€æ¥ã€‚æ‰€æœ‰æ˜‚è´µçš„ã€åªéœ€æ‰§è¡Œä¸€æ¬¡çš„è®¾ç½®ä»£ç éƒ½è‡ªç„¶åœ°æ”¾åœ¨ `b.Loop` è°ƒç”¨ä¹‹å‰ï¼Œè€Œå¾ªçŽ¯ä½“å†…éƒ¨åªåŒ…å«éœ€è¦è¢«ç²¾ç¡®è®¡æ—¶çš„æ ¸å¿ƒæ“ä½œã€‚è¿™é¿å…äº†å°†è®¾ç½®ä»£ç æ„å¤–åœ°åŒ…å«åœ¨è®¡æ—¶å™¨å†…çš„å¸¸è§é”™è¯¯ã€‚

2. **ç®€åŒ–çš„å¹¶è¡Œæµ‹è¯• (`b.RunParallel`)**:
    - `B.Loop` ä¸Ž `b.RunParallel` ç»“åˆä½¿ç”¨æ—¶ï¼Œå¯ä»¥æžå¤§åœ°ç®€åŒ–å¹¶è¡ŒåŸºå‡†æµ‹è¯•çš„ç¼–å†™ã€‚å¼€å‘è€…ä¸å†éœ€è¦æ‰‹åŠ¨ç®¡ç† `pb.Next()` å¾ªçŽ¯ã€‚
    - **ä¹‹å‰ (ä¼ ç»Ÿæ–¹å¼)**:

      ```go
      b.RunParallel(func(pb *testing.PB) {
          for pb.Next() {
              myFunction()
          }
      })
      ```

    - **ä¹‹åŽ (ä½¿ç”¨ B.Loop)**:

      ```go
      b.RunParallel(func(pb *testing.PB) {
          // b.Loop å†…éƒ¨å¤„ç†äº† pb.Next() çš„é€»è¾‘
          b.Loop(func(i int) {
              myFunction()
          })
      })
      ```

      è™½ç„¶çœ‹èµ·æ¥å˜åŒ–ä¸å¤§ï¼Œä½†å®ƒç»Ÿä¸€äº†ä¸²è¡Œå’Œå¹¶è¡Œæµ‹è¯•çš„ç¼–ç é£Žæ ¼ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒå…è®¸åœ¨å¹¶è¡Œæµ‹è¯•ä¸­ä¹Ÿä½¿ç”¨ **"æ¯æ¬¡è¿­ä»£çš„è®¾ç½®"**:

3. **æ”¯æŒ"æ¯æ¬¡è¿­ä»£çš„è®¾ç½®" (Per-iteration Setup)**:
    - è¿™æ˜¯ `B.Loop` æœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæ¯æ¬¡æµ‹è¯•è¿­ä»£éƒ½éœ€è¦ä¸€ä¸ªå…¨æ–°çš„ã€å¹²å‡€çš„çŽ¯å¢ƒï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ–°çš„ç¼“å†²åŒºã€ä¸€ä¸ªæœªè¢«æ±¡æŸ“çš„å¯¹è±¡ï¼‰ã€‚ä¼ ç»Ÿ `for b.N` å¾ªçŽ¯å¾ˆéš¾åœ¨ä¸å½±å“è®¡æ—¶å™¨çš„æƒ…å†µä¸‹å®žçŽ°è¿™ä¸€ç‚¹ã€‚
    - `B.Loop` é€šè¿‡å…¶ `Setup` å­—æ®µä¼˜é›…åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š

      ```go
      b.Loop(testing.Loop{
          // åœ¨æ¯æ¬¡è¿­ä»£å¼€å§‹å‰æ‰§è¡Œï¼Œä¸”ä¸è®¡å…¥æµ‹è¯•æ—¶é—´
          Setup: func() {
              // ä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒº
              buffer = new(bytes.Buffer)
          },
          // æ¯æ¬¡è¿­ä»£çš„æ ¸å¿ƒé€»è¾‘
          Body: func(i int) {
              myFunction(buffer)
          },
      })
      ```

4. **æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§**:
    - é€šè¿‡ç»“æž„åŒ–çš„æ–¹å¼ï¼ˆå¦‚ `testing.Loop` ç»“æž„ä½“ï¼‰ï¼Œ`B.Loop` ä½¿å¾—æµ‹è¯•çš„æ„å›¾æ›´åŠ æ˜Žç¡®ï¼Œé™ä½Žäº†æ–°æˆå‘˜ç†è§£å’Œç»´æŠ¤åŸºå‡†æµ‹è¯•çš„éš¾åº¦ã€‚

## ðŸ’¡ **æœ€ä½³å®žè·µå’Œä½¿ç”¨åœºæ™¯**

1. **ç®€å•åœºæ™¯**:
    - å¯¹äºŽæ²¡æœ‰å¤æ‚è®¾ç½®çš„åŸºå‡†æµ‹è¯•ï¼Œç›´æŽ¥ä½¿ç”¨ `b.Loop(func(i int) { ... })` æ˜¯æœ€ç®€æ´çš„æ–¹å¼ã€‚

2. **æœ‰æ˜‚è´µè®¾ç½®çš„åœºæ™¯**:
    - å°†æ‰€æœ‰æ˜‚è´µçš„ã€ä¸Žå¾ªçŽ¯æ— å…³çš„è®¾ç½®ä»£ç æ”¾åœ¨ `b.Loop` è°ƒç”¨ä¹‹å‰ï¼Œå¹¶åœ¨è®¾ç½®å®ŒæˆåŽè°ƒç”¨ `b.ResetTimer()`ã€‚

3. **æ¯æ¬¡è¿­ä»£éƒ½éœ€è¦æ–°çŽ¯å¢ƒçš„åœºæ™¯**:
    - ä½¿ç”¨ `b.Loop(testing.Loop{ Setup: ..., Body: ... })` ç»“æž„ï¼Œå°†æ˜“å˜çš„è®¾ç½®æ”¾åœ¨ `Setup` å‡½æ•°ä¸­ã€‚è¿™æ˜¯æµ‹è¯•éžå¹‚ç­‰æ“ä½œæˆ–éœ€è¦éš”ç¦»çŠ¶æ€çš„æ“ä½œçš„ç†æƒ³é€‰æ‹©ã€‚

4. **å¹¶è¡Œæµ‹è¯•åœºæ™¯**:
    - åœ¨ `b.RunParallel` å†…éƒ¨ä½¿ç”¨ `b.Loop`ã€‚å¦‚æžœå¹¶è¡Œæµ‹è¯•çš„æ¯ä¸ª goroutine éƒ½éœ€è¦ç‹¬ç«‹çš„èµ„æºï¼Œå¯ä»¥å°†èµ„æºåˆå§‹åŒ–æ”¾åœ¨ `b.RunParallel` çš„å‡½æ•°ä½“å†…ã€`b.Loop` è°ƒç”¨ä¹‹å‰ã€‚

## ðŸš€ **æ€»ç»“**

`testing.B.Loop` æ˜¯ Go æµ‹è¯•å·¥å…·é“¾çš„ä¸€æ¬¡é‡è¦æ¼”è¿›ã€‚å®ƒé€šè¿‡æä¾›ä¸€ä¸ªæ›´ç»“æž„åŒ–ã€åŠŸèƒ½æ›´ä¸°å¯Œçš„ APIï¼Œé¼“åŠ±å¼€å‘è€…ç¼–å†™å‡ºæ›´å‡†ç¡®ã€æ›´å¥å£®ã€æ›´æ˜“äºŽç»´æŠ¤çš„åŸºå‡†æµ‹è¯•ä»£ç ã€‚å¯¹äºŽæ–°çš„åŸºå‡†æµ‹è¯•ï¼ŒæŽ¨èä¼˜å…ˆä½¿ç”¨ `B.Loop`ï¼Œç‰¹åˆ«æ˜¯å½“æµ‹è¯•æ¶‰åŠä»»ä½•å½¢å¼çš„è®¾ç½®æˆ–å¹¶è¡ŒåŒ–æ—¶ã€‚
