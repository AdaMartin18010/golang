name: æ–‡æ¡£è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**/*.md'
      - 'README*.md'
      - '.github/workflows/docs-check.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**/*.md'
      - 'README*.md'
  workflow_dispatch:

jobs:
  link-validation:
    name: é“¾æŽ¥æœ‰æ•ˆæ€§éªŒè¯
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: å®‰è£…markdown-link-check
        run: npm install -g markdown-link-check
      
      - name: éªŒè¯Markdowné“¾æŽ¥
        run: |
          echo "ðŸ”— å¼€å§‹éªŒè¯æ–‡æ¡£é“¾æŽ¥..."
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶
          cat > .markdown-link-check.json << 'EOF'
          {
            "ignorePatterns": [
              {
                "pattern": "^http://localhost"
              },
              {
                "pattern": "^https://github.com/.*/issues/new"
              },
              {
                "pattern": "^#"
              }
            ],
            "replacementPatterns": [
              {
                "pattern": "^/",
                "replacement": "{{BASEURL}}/"
              }
            ],
            "httpHeaders": [
              {
                "urls": ["https://github.com"],
                "headers": {
                  "Accept": "text/html"
                }
              }
            ],
            "timeout": "10s",
            "retryOn429": true,
            "retryCount": 3,
            "fallbackRetryDelay": "30s",
            "aliveStatusCodes": [200, 206, 301, 302, 307, 308, 400, 401, 403, 405, 999]
          }
          EOF
          
          # éªŒè¯æ‰€æœ‰Markdownæ–‡ä»¶
          find docs -name "*.md" -not -path "*/archive/*" -not -path "*/00-å¤‡ä»½/*" | \
            while read file; do
              echo "æ£€æŸ¥: $file"
              markdown-link-check "$file" --config .markdown-link-check.json || true
            done
          
          echo "âœ… é“¾æŽ¥éªŒè¯å®Œæˆ"
      
      - name: æ£€æŸ¥å¤±æ•ˆé“¾æŽ¥ç»Ÿè®¡
        run: |
          echo "ðŸ“Š ç”Ÿæˆé“¾æŽ¥éªŒè¯æŠ¥å‘Š..."
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„ç»Ÿè®¡é€»è¾‘
          # ç›®å‰ä»…ä½œä¸ºç¤ºä¾‹
          
          total_files=$(find docs -name "*.md" -not -path "*/archive/*" | wc -l)
          echo "ðŸ“ éªŒè¯æ–‡ä»¶æ•°: $total_files"

  format-check:
    name: æ ¼å¼è§„èŒƒæ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: æ£€æŸ¥æ–‡æ¡£æ ¼å¼
        run: |
          echo "ðŸ“‹ æ£€æŸ¥æ–‡æ¡£æ ¼å¼è§„èŒƒ..."
          
          error_count=0
          
          # æ£€æŸ¥1: H1æ ‡é¢˜ä¸åº”æœ‰ç¼–å·
          echo "æ£€æŸ¥H1æ ‡é¢˜æ ¼å¼..."
          if grep -rn "^# [0-9]" docs/*.md docs/**/*.md 2>/dev/null | grep -v archive | grep -v 00-å¤‡ä»½; then
            echo "âŒ å‘çŽ°H1æ ‡é¢˜åŒ…å«ç¼–å·"
            error_count=$((error_count + 1))
          else
            echo "âœ… H1æ ‡é¢˜æ ¼å¼æ­£ç¡®"
          fi
          
          # æ£€æŸ¥2: æ˜¯å¦æœ‰ç®€ä»‹éƒ¨åˆ†
          echo "æ£€æŸ¥ç®€ä»‹å®Œæ•´æ€§..."
          missing_intro=0
          for file in $(find docs -name "*.md" -not -path "*/archive/*" -not -path "*/00-å¤‡ä»½/*"); do
            if ! grep -q "ðŸ“š \*\*ç®€ä»‹\*\*" "$file"; then
              echo "âš ï¸  ç¼ºå°‘ç®€ä»‹: $file"
              missing_intro=$((missing_intro + 1))
            fi
          done
          
          if [ $missing_intro -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æ–‡æ¡£åŒ…å«ç®€ä»‹"
          else
            echo "âš ï¸  $missing_intro ä¸ªæ–‡æ¡£ç¼ºå°‘ç®€ä»‹"
          fi
          
          # æ£€æŸ¥3: æ˜¯å¦æœ‰å…ƒæ•°æ®
          echo "æ£€æŸ¥å…ƒæ•°æ®å®Œæ•´æ€§..."
          missing_meta=0
          for file in $(find docs -name "*.md" -not -path "*/archive/*" -not -path "*/00-å¤‡ä»½/*"); then
            if ! grep -q "æ–‡æ¡£ç»´æŠ¤è€…" "$file"; then
              echo "âš ï¸  ç¼ºå°‘å…ƒæ•°æ®: $file"
              missing_meta=$((missing_meta + 1))
            fi
          done
          
          if [ $missing_meta -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æ–‡æ¡£åŒ…å«å…ƒæ•°æ®"
          else
            echo "âš ï¸  $missing_meta ä¸ªæ–‡æ¡£ç¼ºå°‘å…ƒæ•°æ®"
          fi
          
          # æ€»ç»“
          echo ""
          echo "=" 60
          echo "ðŸ“Š æ ¼å¼æ£€æŸ¥æ€»ç»“"
          echo "=" * 60
          
          if [ $error_count -gt 0 ]; then
            echo "âŒ å‘çŽ° $error_count ä¸ªæ ¼å¼é”™è¯¯"
            exit 1
          else
            echo "âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡"
          fi

  spell-check:
    name: æ‹¼å†™æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£…typos
        uses: taiki-e/install-action@v2
        with:
          tool: typos-cli
      
      - name: åˆ›å»ºtyposé…ç½®
        run: |
          cat > .typos.toml << 'EOF'
          [default]
          extend-ignore-re = [
            "[0-9a-f]{7,40}",  # Gitå“ˆå¸Œ
            "v[0-9]+\\.[0-9]+\\.[0-9]+",  # ç‰ˆæœ¬å·
          ]
          
          [files]
          extend-exclude = [
            "*.sum",
            "*.mod",
            "go.sum",
            "go.mod",
            "*.json",
          ]
          
          [default.extend-words]
          # æ·»åŠ è‡ªå®šä¹‰è¯å…¸
          Kubernetes = "Kubernetes"
          Redis = "Redis"
          MySQL = "MySQL"
          PostgreSQL = "PostgreSQL"
          EOF
      
      - name: è¿è¡Œæ‹¼å†™æ£€æŸ¥
        run: |
          echo "ðŸ“ è¿è¡Œæ‹¼å†™æ£€æŸ¥..."
          typos --format brief || true
          echo "âœ… æ‹¼å†™æ£€æŸ¥å®Œæˆ"

  summary:
    name: ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [link-validation, format-check, spell-check]
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç”Ÿæˆæ‘˜è¦
        run: |
          echo "# ðŸ“Š æ–‡æ¡£è´¨é‡æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ£€æŸ¥æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # é“¾æŽ¥éªŒè¯ç»“æžœ
          if [ "${{ needs.link-validation.result }}" == "success" ]; then
            echo "- âœ… é“¾æŽ¥éªŒè¯: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ é“¾æŽ¥éªŒè¯: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ ¼å¼æ£€æŸ¥ç»“æžœ
          if [ "${{ needs.format-check.result }}" == "success" ]; then
            echo "- âœ… æ ¼å¼æ£€æŸ¥: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ æ ¼å¼æ£€æŸ¥: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ‹¼å†™æ£€æŸ¥ç»“æžœ
          if [ "${{ needs.spell-check.result }}" == "success" ]; then
            echo "- âœ… æ‹¼å†™æ£€æŸ¥: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸  æ‹¼å†™æ£€æŸ¥: æœ‰å»ºè®®" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **æç¤º**: æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£æ›´å¤šä¿¡æ¯" >> $GITHUB_STEP_SUMMARY

